<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê²€ í‚¤ìš°ê¸°</title>

<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
}

/* ğŸ¯ ê°•í™” ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ ì¤„ ì •ë¦¬ */
#upgradeItems {
  display: flex;
  flex-wrap: wrap;           /* í™”ë©´ ì¢ìœ¼ë©´ ë¼ë²¨ ë‹¨ìœ„ë¡œ ë‹¤ìŒ ì¤„ë¡œ ë‚´ë ¤ê°€ê²Œ */
  justify-content: center;
  gap: 4px 12px;             /* ë¼ë²¨ ì‚¬ì´ ê°„ê²© */
}

#upgradeItems label {
  white-space: nowrap;       /* ğŸ”¥ ë¼ë²¨ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ ê¸ˆì§€ (í•­ìƒ í•œ ì¤„) */
}
  
/* ğŸ”¨ ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤ ë²„íŠ¼ ë¬¶ìŒ */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 8px;
  flex-wrap: nowrap;
  margin-top: 6px;
}

.action-buttons button {
  flex: 0 0 auto;        /* ë²„íŠ¼ í­ì„ ê¸€ì ê¸¸ì´ì— ë§ê²Œ */
  padding: 10px 18px;    /* ê°€ë¡œ íŒ¨ë”© ì¤„ì—¬ì„œ í­ í™•ë³´ */
  font-size: 16px;       /* ê¸€ì ì¡°ê¸ˆë§Œ ì¤„ì´ê¸° */
  margin: 0;             /* ê³µìš© button ë§ˆì§„ ì œê±° */
  white-space: nowrap;   /* ğŸ”¥ ë²„íŠ¼ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
}

/* ğŸ“· í”„ë¡œí•„ ì €ì¥ ìº¡ì³ ëª¨ë“œ */
.capture-mode * {
  visibility: hidden !important;
}

/* ğŸ”— ë­í‚¹ì—ì„œ ë‹‰ë„¤ì„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.rank-user {
  cursor: pointer;
  text-decoration: none;   /* â† ë°‘ì¤„ ì œê±° */
}

.rank-user:hover {
  color: #ffd700;          /* ìƒ‰ìƒë§Œ ê°•ì¡° */
}

/* ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ëœ¨ëŠ” ì‘ì€ ë©”ë‰´ */
#rankProfileMenu {
  position: absolute;
  display: none;
  background: rgba(0,0,0,0.95);
  border: 1px solid #555;
  border-radius: 6px;
  padding: 4px 6px;
  z-index: 1500;
}
#rankProfileMenu button {
  font-size: 13px;
  padding: 4px 8px;
}

/* ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ì˜¤ë²„ë ˆì´ */
#otherProfileOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2100;
}

.other-profile-card {
  background: #222;
  border: 1px solid #555;
  border-radius: 12px;
  padding: 14px 12px 16px 12px;
  max-width: 340px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px rgba(0,0,0,0.9);
}

.other-profile-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.other-profile-close-btn {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 18px;
  padding: 0 6px;
  cursor: pointer;
}

.other-profile-close-btn:hover {
  color: #ff6666;
}
  
/* â¬œ fieldBg ì˜ì—­ë§Œ ë³´ì´ê²Œ */
.capture-mode #fieldBg,
.capture-mode #fieldBg * {
  visibility: visible !important;
}


/* ===========================
   ğŸ“· ìº¡ì³ ì‹œ ìˆ¨ê¸¸ ìš”ì†Œ
   =========================== */

/* ğŸ”» ì¶”ì²œë ˆë²¨ / ì„±ê³µí™•ë¥  ì¤„ ìˆ¨ê¸°ê¸° */
.capture-mode .current-field-info-sub {
  display: none !important;
}

/* ğŸ”» ê°•í™” ì •ë³´ / ë²„íŠ¼ */
.capture-mode #upgradeInfo,
.capture-mode .action-buttons,
.capture-mode #huntInfo,
.capture-mode #upgradeItems {
  display: none !important;
}

/* ğŸ”» ì¶œì„ / ë¡œê·¸ / ë§µ ë²„íŠ¼ / ì¸ë²¤í† ë¦¬ ë“± UI ë²„íŠ¼ */
.capture-mode .side-menu-btn,
.capture-mode #attendanceBtn,
.capture-mode #logoutBtn,
.capture-mode #logToggle {
  display: none !important;
}

/* ğŸ”» ì €ì¥ë²„íŠ¼ / ì €ì¥ì¤‘ í‘œì‹œ */
.capture-mode .no-capture,
.capture-mode .profile-share-btn,
.capture-mode .profile-save-status {
  display: none !important;
}

/* â›” (ì•ˆì „ì¥ì¹˜) no-captureëŠ” í•­ìƒ ìº¡ì³ ì¤‘ ìˆ¨ê¹€ */
.capture-mode .no-capture {
  display:none !important;
}
  
  /* ğŸ« ì¶œì„ ë²„íŠ¼ */
#attendanceBtn {
  position:fixed;
  top:40px;          /* â¬…ï¸ 10 â†’ 40 ìœ¼ë¡œ ë³€ê²½ */
  left:10px;
  z-index:1100;
  display:none;
  font-size:14px;
  padding:8px 16px;
}


/* ë²„íŠ¼ */
button {
  padding:15px 30px;
  font-size:18px;
  margin:10px;
}

/* ğŸŒˆ 30ê°• ë¬´ì§€ê°œ */
.rainbow {
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 2s linear infinite;
  display:inline-block;
}
@keyframes rainbow {
  from {background-position:0%}
  to {background-position:100%}
}
  /* âœ¨ ì‹¤ë²„ / ê³¨ë“œ ë°˜ì§ì„ */
.sparkle-silver {
  color: #C0C0C0;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(192,192,192,0.8);
  animation: sparkle 1.5s infinite alternate;
}

.sparkle-gold {
  color: #FFD700;
  font-weight: bold;
  text-shadow: 0 0 8px rgba(255,215,0,0.9);
  animation: sparkle 1.2s infinite alternate;
}

/* âœ¨ ê³µí†µ ë°˜ì§ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes sparkle {
  from {
    opacity: 0.85;
    filter: brightness(1);
  }
  to {
    opacity: 1;
    filter: brightness(1.4);
  }
}

/* ğŸ”¤ ê²€ ì´ë¦„ í•œ ì¤„ í‘œì‹œ (ì¤„ë°”ê¿ˆ ê¸ˆì§€ + ë§ì¤„ì„) */
.profile-weapon-title {
  font-size: 16px;
  font-weight: bold;
  margin: 4px 0 2px 0;
  white-space: nowrap;       /* í•œ ì¤„ ìœ ì§€ */
  overflow: hidden;
  text-overflow: ellipsis;   /* ë„ˆë¬´ ê¸¸ë©´ â€¦ ì²˜ë¦¬ */
}

/* ğŸ“ ê²€ ì„¤ëª… */
.profile-weapon-desc {
  font-size: 13px;
  color: #cccccc;
  line-height: 1.4;
  white-space: pre-line;     /* ìš°ë¦¬ê°€ ì“´ ë¬¸ì¥ êµ¬ì¡° ìœ ì§€ìš© */
  margin-bottom: 2px;
}

/* í”„ë¡œí•„ ì¹´ë“œ ë‚´ë¶€ êµ¬ë¶„ì„  */
.profile-inner-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 6px 0 8px 0;
}
  
/* ğŸ”” í† ìŠ¤íŠ¸ */
#toastLog {
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:600px;
  background:rgba(0,0,0,0.75);
  border:1px solid #444;
  padding:8px;
  font-size:14px;
  z-index:1000;
}
.toast-item {
  padding:4px 0;
  border-bottom:1px solid #333;
}
.toast-destroy {
  color:red;
  font-weight:bold;
}

/* ë¡œê·¸ */
#logToggle {
  position:fixed;
  bottom:80px;
  right:10px;
  z-index:1001;
}
#logPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:90%;
  max-width:400px;
  height:60%;
  background:rgba(0,0,0,0.9);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1002;
  display:none;
}
  
/* ================= ìœ ì € í”„ë¡œí•„ ì¹´ë“œ ================ */

#userProfileArea {
  max-width: 320px;
  margin: 10px auto 20px auto;

  /* ğŸ” ë¶ˆíˆ¬ëª… â†’ ë°˜íˆ¬ëª… + ë¸”ëŸ¬ */
  background: rgba(24, 24, 24, 0.55);
  backdrop-filter: blur(5px);

  border-radius: 16px;
  box-shadow: 0 0 18px rgba(0,0,0,0.7);
  padding: 16px 12px 14px 12px;
  position: relative;  /* ê³µìœ  ë²„íŠ¼ ê¸°ì¤€ */
}

  /* í”„ë¡œí•„ ì¹´ë“œ ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ */
.profile-save-status {
  position: absolute;
  top: 30px;
  right: 10px;
  font-size: 11px;
  color: #cccccc;
  opacity: 0;
  transition: opacity 0.2s;
}
 
/* ğŸ“¥ í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ â€” ë¯¸ë‹ˆë©€ ì•„ì´ì½˜í˜• */
.profile-share-btn {
  position: absolute;
  top: 6px;
  right: 6px;

  background: transparent; /* ğŸ”¹ ë°°ê²½ ì œê±° */
  border: none;            /* ğŸ”¹ í…Œë‘ë¦¬ ì œê±° */
  padding: 2px 4px;

  font-size: 18px;         /* ğŸ”¹ ì•„ì´ì½˜ í¬ê¸° */
  cursor: pointer;

  color: #ffffff;          /* ê¸°ë³¸ í°ìƒ‰ */
  opacity: 0.8;            /* ì€ì€í•˜ê²Œ */
  transition: opacity 0.15s, transform 0.1s;
}

/* hover ì‹œë§Œ ê°•ì¡° */
.profile-share-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* ëª¨ë°”ì¼ì—ì„œë„ ëˆŒë¦¬ê¸° ì¢‹ê²Œ */
.profile-share-btn:active {
  transform: scale(0.95);
}
  
.profile-card-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ì„¼í„° ë¬´ê¸° ì´ë¯¸ì§€ */
.profile-weapon-box {
  width: 320px;
  height: 320px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

/* ë‚˜ì¤‘ì— íˆ¬ëª… PNGë¡œ êµì²´í•˜ë©´ ë¨ */
#weaponImage {
  max-width: 100%;
  max-height: 100%;
}

/* í•˜ë‹¨ ì •ë³´ ì˜ì—­ */
.profile-info-box {
  width: 100%;
  text-align: center;
  font-size: 14px;
}

.profile-nickname {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}

.profile-row {
  margin: 2px 0;
}

.profile-label {
  color: #bbbbbb;
  margin-right: 4px;
}

.profile-value {
  font-weight: bold;
}

#profileGold,
#profileSword,
#profilePower,
#profileHuntCount {
  color: #fff;
}

/* ğŸ”˜ ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (MAP / ê²°íˆ¬ / ì¸ë²¤í† ë¦¬) */
.side-menu-btn {
  position: fixed;
  right: 10px;
  z-index: 1100;
  font-size: 14px;
  padding: 8px 16px;
  margin: 0;
  display: none;   /* ë¡œê·¸ì¸ í›„ JSì—ì„œ blockìœ¼ë¡œ ë°”ê¿ˆ */
}

/* ê° ë²„íŠ¼ì˜ ì„¸ë¡œ ìœ„ì¹˜ë§Œ ë‹¤ë¥´ê²Œ */
#mapBtn {
  top: 10px;
}

#duelBtn {
  top: 50px;
}

#inventoryBtn {
  top: 90px;
}
  
/* ğŸ—º MAP íŒ¨ë„ */
#mapPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:260px;
  max-height:70%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1101;
  display:none;
  text-align:left;
  font-size:14px;
}
#mapPanel h3 {
  margin-top:0;
}
.map-field {
  padding:6px 4px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.map-field:hover {
  background:#222;
}

/* ì‚¬ëƒ¥ ì •ë³´ í…ìŠ¤íŠ¸ */
#huntInfo {
  font-size:14px;
  color:#ccc;
  margin-top:4px;
}

 /* ğŸ—º í”„ë¡œí•„ ì¹´ë“œ â€œë°–â€ ìƒë‹¨ í˜„ì¬ ì‚¬ëƒ¥í„° ì •ë³´ */
.current-field-info {
  font-size: 14px;
  color: #ffffff;        /* ê¸°ë³¸ í°ìƒ‰ */
  text-align: center;
  margin-bottom: 8px;    /* ì•„ë˜ ì¹´ë“œë‘ ê°„ê²© */
  line-height: 1.4;
}

.current-field-info-sub {
  font-size: 14px;
  color: #cccccc;        /* ì¶”ì²œë ˆë²¨/ì„±ê³µí™•ë¥  íšŒìƒ‰ */
}
  
/* ğŸ§” NPC íŒì—… */
#npcPopup {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;              /* ê¸°ë³¸ ìˆ¨ê¹€ */
  align-items:center;
  justify-content:center;
  z-index:2000;
}

.npc-popup-inner {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.npc-popup-img {
  width:140px;
  height:auto;
  display:block;
  margin:0 auto 8px auto;
}

.npc-popup-text {
  font-size:16px;
  margin:8px 0 12px 0;
}

.npc-popup-btn {
  padding:8px 20px;
  font-size:14px;
  cursor:pointer;
}

/* ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ */
#tutorialOverlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:flex-start;   /* â¬…ï¸ ìœ„ìª½ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ */
  justify-content:center;   /* ê°€ë¡œëŠ” ì¤‘ì•™ ìœ ì§€ */
  z-index:1900;
  padding-top:60px;         /* â¬…ï¸ ìœ„ì—ì„œ ì•½ê°„ ë„ì›Œì£¼ê¸° */
}

.tutorial-box {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  color:#fff;
  text-align:left;
  font-size:14px;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.tutorial-box h3 {
  margin-top:0;
  margin-bottom:8px;
  text-align:center;
}

.tutorial-box ul {
  padding-left:18px;
  margin:8px 0 12px 0;
}

.tutorial-close-btn {
  display:block;
  width:100%;
  padding:8px 0;
  margin-top:4px;
  text-align:center;
  cursor:pointer;
  border:none;
  border-radius:6px;
  background:#f0f0f0;
  color:#222;
  font-weight:bold;
}

/* ì„¹ì…˜ êµ¬ë¶„ì„  */
.section-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 10px auto 16px auto;
  max-width: 360px;  /* í”„ë¡œí•„ ì¹´ë“œ í­ì´ë‘ ë¹„ìŠ·í•˜ê²Œ */
}

/* ğŸ¨ ì‚¬ëƒ¥í„° ë°°ê²½ ë ˆì´ì–´ */
#gameScreen {
  position: relative;
   padding-bottom: 300px;   /* ğŸ”¹ í† ìŠ¤íŠ¸ ë¡œê·¸ ë†’ì´ë§Œí¼ ì•„ë˜ ì—¬ë°± ì¶”ê°€ */
}

/* fieldBg ì•ˆì˜ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ, ë°°ê²½ë§Œ ::beforeë¡œ ê¹”ê¸° */
.field-bg {
  max-width: 430px;
  margin: 0 auto 20px auto;
  position: relative;
  z-index: 0;                     /* ìŠ¤íƒ ê¸°ì¤€ */
}

/* ì§„ì§œ ë°°ê²½ì€ ê°€ìƒ ìš”ì†Œë¡œ: ê°€ë¡œëŠ” í™”ë©´ ì „ì²´, ì„¸ë¡œëŠ” fieldBg ë†’ì´ê¹Œì§€ë§Œ */
.field-bg::before {
  content: "";
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  height: 100%;
  background-image: var(--field-bg-image, none);
  background-size: cover;
  background-position: center top;
  background-repeat: no-repeat;
  filter: brightness(0.6);
  z-index: -1;                    /* ğŸ‘ˆ ë‚´ìš© ë’¤ë¡œ í™•ì‹¤í•˜ê²Œ ë³´ë‚´ê¸° */
}
  
</style>
</head>

<body>

<!-- ğŸ” ë¡œê·¸ì¸ -->
<div id="loginScreen">
<h2>
  ğŸ” ë¡œê·¸ì¸
  <span style="font-size:0.7em; color:#888; margin-left:4px;">
    (v3.597)
  </span>
</h2>
  <input id="loginId" placeholder="ì•„ì´ë””"><br><br>
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><br><br>
  <button onclick="login()">ì ‘ì†</button>
</div>
  
<!-- ğŸ® ê²Œì„ -->
<div id="gameScreen" style="display:none;">
  <h1>âš”ï¸ ê²€ í‚¤ìš°ê¸°</h1>

  <!-- ğŸ”¥ ì‚¬ëƒ¥í„° ë°°ê²½ ë°•ìŠ¤ (í”„ë¡œí•„~ë­í‚¹ ì „ì²´ë¥¼ ê°ìŒˆ) -->
  <div id="fieldBg" class="field-bg">

  <!-- ğŸ—º í˜„ì¬ ì‚¬ëƒ¥í„° ì •ë³´ (í”„ë¡œí•„ ì¹´ë“œ ë°”ê¹¥ ìƒë‹¨) -->
  <div id="currentFieldInfo" class="current-field-info"></div>

<!-- ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì¹´ë“œ -->
<div id="userProfileArea">
  <!-- ğŸ“· í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ -->
  <button class="profile-share-btn no-capture"
          onclick="saveProfileCard()"
          title="í”„ë¡œí•„ ì €ì¥">
    â¬‡ï¸
  </button>

  <!-- ğŸ”” ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ -->
  <div id="profileSaveStatus"
       class="profile-save-status no-capture"></div>

  <div class="profile-card-inner">
    <!-- ğŸ” ë‹‰ë„¤ì„ (ì¹´ë“œ ìµœìƒë‹¨) -->
    <div class="profile-nickname" id="profileNickname">-</div>

    <!-- âš”ï¸ ê²€ ì´ë¯¸ì§€ -->
    <div class="profile-weapon-box">
      <img id="weaponImage"
           src="images/weapons/sword_real_temp.png"
           alt="ë‚´ ë¬´ê¸°">
    </div>

    <!-- âš”ï¸ ê²€ ì´ë¦„ / ì„¤ëª… / ìŠ¤íƒ¯ -->
    <div class="profile-info-box">

      <!-- âœ… ê²€ ì´ë¦„ (+í˜„ì¬ ê°•í™”) -->
      <div class="profile-weapon-title" id="profileWeaponTitle">
        - (+0ê°•)
      </div>

      <hr class="profile-inner-divider">

      <!-- âœ… ê²€ ì„¤ëª… -->
      <div class="profile-weapon-desc" id="profileWeaponDesc">
        -
      </div>

      <hr class="profile-inner-divider">

      <!-- âœ… ìµœëŒ€ ê°•í™” + íŒŒê´´ íšŒìˆ˜ -->
      <div class="profile-row">
        <span class="profile-label">ìµœëŒ€ ê°•í™”</span>
        <span class="profile-value" id="profileMaxInfo">
          +0ê°• <span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ 0íšŒ)</span>
        </span>
      </div>

      <!-- ê¸°ì¡´ ìŠ¤íƒ¯ë“¤ ìœ ì§€ -->
      <div class="profile-row">
        <span class="profile-label">ì „íˆ¬ë ¥</span>
        <span class="profile-value" id="profilePower">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ê³¨ë“œ</span>
        <span class="profile-value" id="profileGold">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ë¬´ê¸°ê°€ì¹˜</span>
        <span class="profile-value" id="profileWeaponValue">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ì „ì </span>
        <span class="profile-value" id="profileRecord">ìŠ¹ 0 / íŒ¨ 0</span>
      </div>
    </div>
  </div>
</div>


  <hr class="section-divider">

   <!-- ğŸ”½ ë§µ ì†Œê°œ ë¬¸êµ¬ í‘œì‹œ ì˜ì—­ -->
<p id="fieldDescription"
   style="font-size:13px; color:#ccc; margin:10px 0 6px 0;"></p>

<hr class="section-divider">

    
  <!-- ê¸°ì¡´ ìƒíƒœ í‘œì‹œ -->
  <p id="status"></p>
<p id="upgradeInfo"
   style="font-size:14px; margin-top:4px; margin-bottom:8px; color:#ccc;">
</p>

<div class="action-buttons">
  <button onclick="upgrade()">ğŸ”¨ ê°•í™”</button>
  <button id="huntBtn" onclick="hunt()">âš”ï¸ ì‚¬ëƒ¥</button>
  <button onclick="sell()">ğŸ’° íŒë§¤</button>
</div>

<p id="huntInfo" style="margin-top:4px; color:#ccc; font-size:13px;"></p>
    
<!-- ğŸ¯ ê°•í™” ì•„ì´í…œ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
<div id="upgradeItems" style="margin-top:8px; font-size:13px;">
  <label style="margin-right:8px;">
    <input type="checkbox" id="useScroll15">
    15ê°• ê°•í™” ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useProtect">
    íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useDownProtect">
    ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
  <label>
    <input type="checkbox" id="useSuper">
    ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
</div>

  <hr>
    
  </div> <!-- ğŸ”š fieldBg : ë°°ê²½ì€ ì—¬ê¸°ê¹Œì§€ë§Œ -->
  
  <h2>ğŸ† ë­í‚¹ TOP 10</h2>
  <div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="myRank" style="margin-top:8px; font-size:14px; color:#ccc;"></div>

  <!-- ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ëœ¨ëŠ” ì‘ì€ ë©”ë‰´ -->
<div id="rankProfileMenu">
  <button id="rankProfileViewBtn">ğŸ‘ í”„ë¡œí•„ ë³´ê¸°</button>
</div>

</div> <!-- ğŸ”š gameScreen -->

<button id="attendanceBtn" onclick="checkAttendance()">ì¶œì„</button>

  <button id="logoutBtn" onclick="logout()" style="
  position:fixed;
  top:10px;
  left:10px;
  z-index:1101;
  display:none;
  font-size:14px;
  padding:6px 14px;
">
  ë¡œê·¸ì•„ì›ƒ
</button>
  
<!-- ğŸ”” ë¡œê·¸ -->
<div id="toastLog"><div id="toastList"></div></div>

<button id="mapBtn"
        class="side-menu-btn"
        onclick="toggleMap()">
  ğŸ—º MAP
</button>
  
<!-- âš”ï¸ ê²°íˆ¬ ë²„íŠ¼ (MAPê³¼ ì¸ë²¤í† ë¦¬ ì‚¬ì´) -->
<button id="duelBtn"
        class="side-menu-btn"
        onclick="toggleDuelPanel()">
  âš”ï¸ ê²°íˆ¬
</button>
  
  <!-- ğŸ’ ì¸ë²¤í† ë¦¬ ë²„íŠ¼ (ë¡œê·¸ ë²„íŠ¼ ìœ„) -->
<button id="inventoryBtn"
        class="side-menu-btn"
        onclick="toggleInventory()">
  ğŸ’ ì¸ë²¤í† ë¦¬
</button>

<button id="logToggle" onclick="toggleLog()" style="
  position:fixed;
  bottom:80px;
  right:10px;
  z-index:1001;
  display:none;
">
  ğŸ“œ ë¡œê·¸
</button>

<!-- ğŸ—º MAP íŒ¨ë„ -->
<div id="mapPanel">
  <h3>ğŸ—º ì‚¬ëƒ¥í„° ì„ íƒ</h3>
  <div id="mapList"></div>
</div>
  
<!-- ğŸ’ ì¸ë²¤í† ë¦¬ íŒ¨ë„ -->
<div id="inventoryPanel" style="
  position:fixed;
  right:10px;
  top:60px;
  width:260px;
  max-height:60%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1002;
  display:none;
  text-align:left;
  font-size:14px;
">
  <h3>ğŸ’ ì¸ë²¤í† ë¦¬</h3>
  <div id="inventoryList"></div>
</div>

  <!-- âš”ï¸ ê²°íˆ¬ íŒ¨ë„ -->
<div id="duelPanel" style="
  position:fixed;
  right:10px;
  top:60px;
  width:280px;
  max-height:70%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1102;
  display:none;
  text-align:left;
  font-size:14px;
">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
    <div style="font-weight:bold; font-size:15px;">âš”ï¸ ê²°íˆ¬</div>
    <!-- â¬… ì°½ ì¢Œìƒë‹¨(ì— ê°€ê¹Œìš´ ìª½)ì— Xë²„íŠ¼ -->
    <button onclick="toggleDuelPanel()" style="font-size:11px; padding:2px 6px;">X</button>
  </div>

  <div style="margin-bottom:6px;">
    <input id="duelSearchInput"
           type="text"
           placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰"
           oninput="onDuelSearchChange(this.value)"
           style="width:100%; box-sizing:border-box; padding:4px 6px; font-size:13px;">
  </div>

  <div id="duelHelpText" style="font-size:12px; color:#aaa; margin-bottom:4px;">
    ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ìƒìœ„ ë­í‚¹ ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
  </div>

  <div id="duelList"></div>

  <button id="randomMatchBtn"
          onclick="handleRandomMatch()"
          style="margin-top:8px; width:100%; padding:6px 0; font-size:14px;">
    ğŸ² ëœë¤ë§¤ì¹­
  </button>
</div>
  
<div id="logPanel">
  <h3>ğŸ“¢ ê°•í™” ë¡œê·¸</h3>
  <div id="logPanelList"></div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- í”„ë¡œí•„ ì¹´ë“œ ìº¡ì³ìš© html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  authDomain:"sword-game-1d1a1.firebaseapp.com",
  databaseURL:"https://sword-game-1d1a1-default-rtdb.firebaseio.com",
  projectId:"sword-game-1d1a1"
});
const db = firebase.database();
const logRef = db.ref("logs");

function getTutorialKeyForUser(id) {
  return `swordGameTutorialSeen_${id}`;
}

// ğŸ”° ê°•í™” ë‹¨ê³„ë³„ ê²€ ì´ë¦„ / ì„¤ëª… / ì´ë¯¸ì§€ ê²½ë¡œ
const WEAPON_INFO = {
  0: {
    name: "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´",
    desc: "ì•„ì§ ì•„ë¬´ê²ƒë„ ë˜ì§€ ëª»í–ˆì§€ë§Œ, ì„¸ìƒ ì–´ë””ì—ë„ ì—†ëŠ” ê°€ëŠ¥ì„±ì„ ì¡°ìš©íˆ í’ˆê³  ìˆë‹¤.",
    img: "images/weapons/sword_00.png"
  },
  1: {
    name: "ë¶€ëŸ¬ì§„ ê²€",
    desc: "ì˜ê´‘ì˜ ê¸°ì–µë§Œ ë‚¨ì€ ì±„, ë”ëŠ” ëˆ„êµ¬ë„ ì°¾ì§€ ì•ŠëŠ” ìŠ¬í”ˆ ì”í•´ë‹¤.",
    img: "images/weapons/sword_01.png"
  },
  2: {
    name: "ê¸ˆì´ ê°„ ê²€",
    desc: "ì¡°ê¸ˆë§Œ í˜ì„ ì£¼ì–´ë„ ì‚°ì‚°íˆ í©ì–´ì§ˆ ê²ƒì²˜ëŸ¼, ìœ„íƒœë¡­ê²Œ ìˆ¨ì„ ë¶™ë“¤ê³  ìˆë‹¤.",
    img: "images/weapons/sword_02.png"
  },
  3: {
    name: "ë…¹ìŠ¨ ê²€",
    desc: "ì„¸ì›”ì˜ ë°”ëŒì„ ê²¬ë””ì§€ ëª»í•´, í•œë•Œì˜ ê´‘ì±„ë¥¼ ì„œì„œíˆ ìƒì–´ë²„ë ¸ë‹¤.",
    img: "images/weapons/sword_03.png"
  },
  4: {
    name: "ë‚¡ì€ ê²€",
    desc: "ìˆ˜ë§ì€ ì‹¸ì›€ì˜ í”ì ë§Œì´ ë‚¨ì•„, ì¡°ìš©íˆ ì‰¼ì„ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.",
    img: "images/weapons/sword_04.png"
  },
  5: {
    name: "í™ë¨¼ì§€ì— ë®ì¸ ê²€",
    desc: "ê¸´ ì  ì†ì—ì„œë„, ì–¸ì  ê°€ ë‹¤ì‹œ ë¶ˆë¦´ ì´ë¦„ì„ ê¿ˆê¾¸ê³  ìˆë‹¤.",
    img: "images/weapons/sword_05.png"
  },
  6: {
    name: "ì˜ ë²¼ë ¤ì§„ ê²€",
    desc: "ì¥ì¸ì˜ ìˆ¨ê²°ì„ ë¨¸ê¸ˆê³ , ì´ì œì•¼ ë¹„ë¡œì†Œ í•œ ìë£¨ì˜ ê²€ì´ ëœë‹¤.",
    img: "images/weapons/sword_06.png"
  },
  7: {
    name: "ë‹¨ë‹¨íˆ ì—°ë§ˆëœ ì „íˆ¬ê²€",
    desc: "ì „ì¥ì„ í–¥í•œ ë‘ë ¤ì›€ê³¼ ê°ì˜¤ê°€, ë‚  ìœ„ì— ê³ ìš”íˆ ë‚´ë ¤ì•‰ëŠ”ë‹¤.",
    img: "images/weapons/sword_07.png"
  },
  8: {
    name: "ê²°ì˜ì˜ ì¥ê²€",
    desc: "í•œ ë²ˆ ë½‘ì•„ ë“¤ì—ˆë‹¤ë©´, ê²°ì½” ë¬¼ëŸ¬ì„œì§€ ì•Šê² ë‹¤ëŠ” ì˜ì§€ê°€ ê¹ƒë“ ë‹¤.",
    img: "images/weapons/sword_08.png"
  },
  9: {
    name: "ê³ ê·€í•œ ê¸°ì‚¬ì˜ ê²€",
    desc: "ëª…ì˜ˆì™€ ì±…ì„ì„ í•¨ê»˜ ì§Šì–´ì§„, í’ˆìœ„ ìˆëŠ” ì „ì¥ì˜ ë™ë°˜ìë‹¤.",
    img: "images/weapons/sword_09.png"  // ğŸ‘‰ ì§€ê¸ˆ ë„¤ê°€ í™•ì •í•œ 9ê°• ì´ë¯¸ì§€
  },
  10: {
    name: "ì„œì•½ì„ ì§€ë‹Œ ì„±ì „ì˜ ê²€",
    desc: "ì§€ì¼œì•¼ í•  ì´ë¦„ì´ ìƒê¸´ ìˆœê°„, ì´ ê²€ì€ ê¸°ë„ì²˜ëŸ¼ íœ˜ë‘˜ëŸ¬ì§„ë‹¤.",
    img: "images/weapons/sword_10.png"
  },
  11: {
    name: "ìš©ë§¹ì˜ ì„œê´‘ê²€",
    desc: "ëˆ„êµ¬ë³´ë‹¤ ë¨¼ì € ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ëŠ” ì´ì˜, ëœ¨ê±°ìš´ ìš©ê¸°ë¥¼ ë¹„ì¶˜ë‹¤.",
    img: "images/weapons/sword_11.png"
  },
  12: {
    name: "ì€ë¹› ì‹¬íŒì˜ ê²€",
    desc: "ì°¨ê°€ìš´ ì¹¼ë‚  ìœ„ì—ì„œ, ì˜³ê³  ê·¸ë¦„ì´ ì¡°ìš©íˆ ê°ˆë¼ì§„ë‹¤.",
    img: "images/weapons/sword_12.png"
  },
  13: {
    name: "ì„±ë²½ì„ ìˆ˜í˜¸í•˜ëŠ” ê²€",
    desc: "ì¹¨ë¬µ ì†ì—ì„œ í”ë“¤ë¦¼ ì—†ì´, ë§ˆì§€ë§‰ ë°©ì–´ì„ ì— ì„œ ìˆë‹¤.",
    img: "images/weapons/sword_13.png"
  },
  14: {
    name: "ì™•ê°€ì˜ ì˜ì§€ê²€",
    desc: "í•œ ë‚˜ë¼ì˜ ì‹œê°„ê³¼ ë¬´ê²Œê°€, ë¬µì§í•˜ê²Œ ì†ëìœ¼ë¡œ ì „í•´ì§„ë‹¤.",
    img: "images/weapons/sword_14.png"
  },
  15: {
    name: "ì„±ì—­ì„ ì§€í‚¤ëŠ” ì„±ê²€",
    desc: "ê·¸ ì–´ë–¤ ìœ„í˜‘ ì•ì—ì„œë„ ë¬¼ëŸ¬ì„œì§€ ì•ŠëŠ”, ì¹¨ë¬µì˜ ìˆ˜í˜¸ìë‹¤.",
    img: "images/weapons/sword_15.png"
  },
  16: {
    name: "ì‹¬ì—°ì„ ê¿°ëš«ëŠ” ì„±ê²€",
    desc: "ì–´ë‘ ì˜ ê°€ì¥ ê¹Šì€ ìë¦¬ê¹Œì§€, í•œ ì¤„ê¸° ë¹›ì´ ë‚´ë ¤ ê½‚íŒë‹¤.",
    img: "images/weapons/sword_16.png"
  },
  17: {
    name: "ë¶ˆê¸¸ì˜ ì‹¬íŒê²€",
    desc: "íƒ€ëŠ” ë“¯í•œ ë¶„ë…¸ê°€ ì¹¼ë‚ ì„ ê°ì‹¸ë©°, ì•…ì„ ì¬ë¡œ ë‚¨ê¸´ë‹¤.",
    img: "images/weapons/sword_17.png"
  },
  18: {
    name: "ì•…ë§ˆ ì‚´ìœ¡ì",
    desc: "ì§€ì˜¥ì—ì„œ ê¸°ì–´ì˜¤ë¥¸ ê²ƒë“¤ì¡°ì°¨, ì´ ì´ë¦„ ì•ì—ì„œëŠ” ì¹¨ë¬µí•œë‹¤.",
    img: "images/weapons/sword_18.png"
  },
  19: {
    name: "ì§€ì˜¥ë¬¸ ë´‰ì‡„ê²€",
    desc: "ì´ë¯¸ ì—´ë¦° ì¬ì•™ì˜ ë¬¸ì„, ë§ˆì§€ë§‰ í˜ìœ¼ë¡œ ë‹¤ì‹œ ë‹«ì•„ë²„ë¦°ë‹¤.",
    img: "images/weapons/sword_19.png"
  },
  20: {
    name: "ë‚™ì¸ì˜ ì„±í™”ê²€",
    desc: "ê±°ìŠ¤ë¥¼ ìˆ˜ ì—†ëŠ” ê°ì˜¤ê°€, ë¶ˆë©¸ì˜ ë‚™ì¸ì²˜ëŸ¼ ìƒˆê²¨ì§„ë‹¤.",
    img: "images/weapons/sword_20.png"
  },
  21: {
    name: "ì—­ì²œì˜ íšƒë¶ˆê²€",
    desc: "ì •í•´ì§„ ê¸¸ì„ ë”°ë¥´ì§€ ì•Šê³ , ìê¸°ë§Œì˜ í•˜ëŠ˜ì„ ë°íŒë‹¤.",
    img: "images/weapons/sword_21.png"
  },
  22: {
    name: "ì²œìƒì„ ê±°ìŠ¤ë¥´ëŠ” ì„±ê·¹ê²€",
    desc: "ì‹ ì„±ì˜ ì§ˆì„œë¥¼ ë’¤í”ë“¤ê² ë‹¤ëŠ” ìœ„í—˜í•œ ì„ íƒì´ ê¹ƒë“¤ì–´ ìˆë‹¤.",
    img: "images/weapons/sword_22.png"
  },
  23: {
    name: "ì‹ ì¢Œë¥¼ í”ë“œëŠ” ì„œìŠ¬ê²€",
    desc: "ë†’ì€ í•˜ëŠ˜ ìœ„ì˜ ì™•ì¢Œë§ˆì €, ì´ ì¹¼ë ì•ì—ì„œëŠ” í”ë“¤ë¦°ë‹¤.",
    img: "images/weapons/sword_23.png"
  },
  24: {
    name: "ì‹ ì‚´ì˜ ì™•ê²€",
    desc: "ì‹ ì¡°ì°¨ í”¼í•˜ì§€ ëª»í•œ ê²°ë§ì„, ì¹¨ë¬µ ì†ì— ê·¸ì–´ë‚¸ë‹¤.",
    img: "images/weapons/sword_24.png"
  },
  25: {
    name: "ë³„ì„ ê°€ë¥´ëŠ” ì„±ê´‘ê²€",
    desc: "ë°¤í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë³¸ ì´ë¼ë©´, ëˆ„êµ¬ë‚˜ ê·¸ ìì·¨ë¥¼ ëª©ê²©í•˜ê²Œ ëœë‹¤.",
    img: "images/weapons/sword_25.png"
  },
  26: {
    name: "ì°½ê³µì„ ì´ˆì›”í•œ ì´ˆì›”ê²€",
    desc: "ì´ì œ í•˜ëŠ˜ê³¼ ë•…ì˜ ê²½ê³„ëŠ”, ë” ì´ìƒ ì˜ë¯¸ë¥¼ ê°–ì§€ ëª»í•œë‹¤.",
    img: "images/weapons/sword_26.png"
  },
  27: {
    name: "ì°¨ì›ì„ ë² ì–´ë‚´ëŠ” ì ˆì—°ê²€",
    desc: "ì„¸ê³„ì™€ ì„¸ê³„ë¥¼ ë‚˜ëˆ„ëŠ” ë§ˆì§€ë§‰ ì„ ì´, ë‚  ìœ„ì— ê·¸ì–´ì§„ë‹¤.",
    img: "images/weapons/sword_27.png"
  },
  28: {
    name: "ì¢…ì–¸ì˜ ì„œì•½ê²€",
    desc: "í•œ ë²ˆì˜ ê²°ë‹¨ìœ¼ë¡œ, ì„¸ê³„ì˜ ëë§ˆì € ì•½ì†ëœ ê²°ë§ì²˜ëŸ¼ ë‹¤ê°€ì˜¨ë‹¤.",
    img: "images/weapons/sword_28.png"
  },
  29: {
    name: "ìš´ëª…ì˜ ì‹¬íŒê²€",
    desc: "ë³„ê³¼ ì‹œê°„, ì¸ê³¼ì˜ íë¦„ì´ ëª¨ë‘ ì´ ì¹¼ëìœ¼ë¡œ ëª¨ì—¬ë“ ë‹¤.",
    img: "images/weapons/sword_29.png"
  },
  30: {
    name: "ìš´ëª…ì„ ì§‘í–‰í•˜ëŠ” ã€Œë§¹ì„¸ì˜ ê³„ìœ¨ã€",
    desc: "ë” ì´ìƒ ê²€ì´ ì•„ë‹ˆë‹¤ â€” ë§¹ì„¸ê°€ ë°˜ë“œì‹œ ì‹¤í˜„ë˜ëŠ”, ìš°ì£¼ì˜ ì§ˆì„œê°€ ë˜ì—ˆë‹¤.",
    img: "images/weapons/sword_30.png"
  }
};

// í˜„ì¬ ê°•í™” ìˆ˜ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getWeaponInfo(level) {
  const lv = Math.max(0, Math.min(30, level | 0));
  return WEAPON_INFO[lv] || WEAPON_INFO[0];
}

// ì´ë¯¸ì§€ êµì²´ í•¨ìˆ˜
function updateWeaponImage() {
  const info = getWeaponInfo(sword);
  const imgEl = document.getElementById("weaponImage");
  if (!imgEl) return;

  if (info && info.img) {
    imgEl.src = info.img;
  }
}
  
/* ìƒíƒœ */
let sword = 0, power = 10, gold = 100;
let userId="", userPassword="", userRef=null;
let attendanceCount = 0;
let lastAttendanceDate = "";
let attendanceStreak = 0;     // ì—°ì† ì¶œì„ ìˆ˜
let lastAttendanceDay = "";   // ë§ˆì§€ë§‰ ì¶œì„ ë‚ ì§œ (streak ì „ìš©)
let maxSwordLevel = 0;   // ê³„ì • ì „ì²´ ìµœê³  ê°•í™” ê¸°ë¡
let destroyCount  = 0;   // ê³„ì • ì „ì²´ ëˆ„ì  íŒŒê´´ íšŸìˆ˜

// ğŸ†• ê°•í™” ì§„í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
let isUpgrading = false;

// ğŸ§­ ì‚¬ëƒ¥í„° ì´ë™ ì¤‘ì¸ì§€ ì—¬ë¶€
let isMoving = false;

// âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ìƒíƒœ
let duelWin = 0;                  // ìŠ¹ ìˆ˜
let duelLose = 0;                 // íŒ¨ ìˆ˜
let duelCountToday = 0;           // ì˜¤ëŠ˜ ê²°íˆ¬í•œ ì´ íšŸìˆ˜ (ëª¨ë“  ìƒëŒ€ í•©ì‚°)
let lastDuelDate = "";            // ë§ˆì§€ë§‰ ê²°íˆ¬ ë‚ ì§œ (YYYY-MM-DD)
// ì˜¤ëŠ˜ ê°™ì€ ìƒëŒ€ì—ê²Œ ëª‡ ë²ˆ ë„ì „í–ˆëŠ”ì§€: { ìƒëŒ€ì•„ì´ë””: íšŸìˆ˜ }
let duelTargetsToday = {};
  
// ì „ì²´ ìœ ì € ëª©ë¡ ìºì‹œ (ê²°íˆ¬ ê²€ìƒ‰/ëœë¤ë§¤ì¹­ìš©)
let allUsersCache = [];

  // ğŸ—º ì‚¬ëƒ¥ ê´€ë ¨ ìƒíƒœ
let currentField = 1;          // 1~10 ì‚¬ëƒ¥í„°
let huntCountToday = 0;        // ì˜¤ëŠ˜ ì‚¬ëƒ¥ íšŸìˆ˜
let lastHuntDate = "";         // ë§ˆì§€ë§‰ ì‚¬ëƒ¥ ë‚ ì§œ (YYYY-MM-DD)

// ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜
let huntStamina = 20;          // í˜„ì¬ ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ (0~20)
let lastStaminaUpdate = 0;     // ë§ˆì§€ë§‰ ìŠ¤íƒœë¯¸ë‚˜ ê°±ì‹  ì‹œê° (ms timestamp)

// ğŸ†• 25ê°• ì´ìƒ ê°•í™” ê²½ê³  ì•ˆë‚´ í‘œì‹œ ì—¬ë¶€ (ì„¸ì…˜ ê¸°ì¤€ 1íšŒ)
let hasSeen25Warning = false;
let ignoreNextUpgradeWarning = false;
  
// ğŸ§® ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ ê³„ì‚° (ë¦¬ì…‹ + íšŒë³µ ì²˜ë¦¬)
function recalcHuntStamina() {
  const now = Date.now();
  const today = getTodayDateString();

  // ìµœì´ˆ í˜¸ì¶œ ì‹œ ì´ˆê¸°í™”
  if (!lastStaminaUpdate) {
    lastStaminaUpdate = now;
  }

  // ğŸ” ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ 00ì‹œì— í’€ íšŒë³µ (20ê°œ)
  if (lastHuntDate !== today) {
    lastHuntDate     = today;
    huntStamina      = 20;
    lastStaminaUpdate = now;
    huntCountToday   = 0;
    return;
  }

  // ì´ë¯¸ ê°€ë“ ì°¨ ìˆìœ¼ë©´ ë” íšŒë³µ X
  if (huntStamina >= 20) return;

  const intervalMs = 20 * 60 * 1000; // 20ë¶„
  const elapsed    = now - lastStaminaUpdate;
  if (elapsed <= 0) return;

  // ì§€ë‚œ ì‹œê°„ ë™ì•ˆ íšŒë³µ ê°€ëŠ¥í•œ ê°œìˆ˜
  const gained = Math.floor(elapsed / intervalMs);
  if (gained <= 0) return;

  huntStamina = Math.min(20, huntStamina + gained);
  // ë§ˆì§€ë§‰ íšŒë³µ ê¸°ì¤€ ì‹œê° ì•ìœ¼ë¡œ ë‹¹ê²¨ì£¼ê¸°
  lastStaminaUpdate += gained * intervalMs;

  // ì°¸ê³ ìš©: ì˜¤ëŠ˜ ì‚¬ìš©í•œ íšŸìˆ˜ = 20 - ë‚¨ì€ ìŠ¤íƒœë¯¸ë‚˜
  huntCountToday = Math.max(0, 20 - huntStamina);
}

// ğŸ§­ ì‚¬ëƒ¥ UIë§Œ ê°±ì‹  (ë²„íŠ¼ í…ìŠ¤íŠ¸ + ë‚¨ì€ ì‹œê°„ í‘œì‹œ)
function updateHuntUI() {
  const huntBtnEl  = document.getElementById("huntBtn");
  const huntInfoEl = document.getElementById("huntInfo");
  if (!huntBtnEl || !huntInfoEl) return;

  // ë§¤ë²ˆ ë¶€ë¥¼ ë•Œë§ˆë‹¤ ìŠ¤íƒœë¯¸ë‚˜ ì¬ê³„ì‚°
  recalcHuntStamina();

  const remaining = huntStamina;
  huntBtnEl.textContent = `âš”ï¸ ì‚¬ëƒ¥ (${remaining}/20)`;

  // íšŒë³µê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
  let infoText = "";
  const intervalMs = 20 * 60 * 1000;

 if (remaining >= 20) {
  infoText = `[ 00:00 ]`;
} else {
  const now = Date.now();
  const elapsed = now - lastStaminaUpdate;

  const passed = Math.max(0, elapsed);
  const remainMs = intervalMs - (passed % intervalMs);
  const totalSec = Math.floor(remainMs / 1000);

  const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
  const ss = String(totalSec % 60).padStart(2, "0");

  infoText = `[ ${mm}:${ss} ]`;
}

  huntInfoEl.style.fontSize   = "13px";
  huntInfoEl.style.color      = "#ccc";
  huntInfoEl.style.whiteSpace = "pre-line"; // \n ì¤„ë°”ê¿ˆ
  huntInfoEl.textContent      = infoText;
}

// âš”ï¸ ê²°íˆ¬ ë²„íŠ¼ UI ê°±ì‹ 
function updateDuelUI() {
  const btn = document.getElementById("duelBtn");
  if (!btn) return;

  ensureDuelDate(); // ë‚ ì§œ ë°”ë€Œë©´ 0ìœ¼ë¡œ ë¦¬ì…‹

  const remain = Math.max(0, 10 - duelCountToday);

  btn.textContent = `âš”ï¸ ê²°íˆ¬ (${remain}/10)`;
}

// ğŸ ì•„ì´í…œ ë³´ìœ  ìˆ˜ëŸ‰
let itemScroll15 = 0;   // 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
let itemProtect  = 0;   // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
let itemSuper    = 0;   // ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
let itemDownProtect = 0;  // ğŸ†• ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ
  
// ì‚¬ëƒ¥í„° ì •ë³´ (ì¶”ì²œ ë ˆë²¨ / ì´ë¦„)
const HUNT_FIELDS = [
  null, // ì¸ë±ìŠ¤ 0 ë¹„ì›€ (1ë¶€í„° ì‹œì‘)
  { id:1, name:"í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„",   recLevel:0  },
  { id:2, name:"ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½", recLevel:3  },
  { id:3, name:"ë¬´ë²•ìë“¤ì˜ í™©ì•¼",     recLevel:6  },
  { id:4, name:"ëŠªì—˜í”„ì˜ ìˆ²",         recLevel:9  },
  { id:5, name:"ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´",     recLevel:12 },
  { id:6, name:"ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„",   recLevel:15 },
  { id:7, name:"ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´", recLevel:18 },
  { id:8, name:"ëŒ€ì²œì‚¬ì˜ ìš”ëŒ",       recLevel:21 },
  { id:9, name:"ì‹ ì˜ ì²˜ì†Œ",           recLevel:24 },
  { id:10,name:"ì°¨ì›ì˜ í‹ˆìƒˆ",         recLevel:27 }
];
  // ê° ì‚¬ëƒ¥í„°ë³„ ë°°ê²½ ì´ë¯¸ì§€ (íŒŒì¼ëª…ì€ ì˜ˆì‹œ)
const FIELD_BACKGROUNDS = {
  1: "images/fields/field1_mushroom_heinesis.png",    // í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„
  2: "images/fields/field2_sewer_zaun.png",           // ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½
  3: "images/fields/field3_outlaw_west.png",          // ë¬´ë²•ìë“¤ì˜ í™©ì•¼
  4: "images/fields/field4_swamp_elf.png",            // ëŠªì—˜í”„ì˜ ìˆ²
  5: "images/fields/field5_frost_queen_cave.png",     // ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´
  6: "images/fields/field6_lich_deathrealm.png",      // ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„
  7: "images/fields/field7_behemoth_hellpit.png",     // ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´
  8: "images/fields/field8_archangel_cradle.png",     // ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
  9: "images/fields/field9_gods_throne.png",          // ì‹ ì˜ ì²˜ì†Œ
  10:"images/fields/field10_dimensional_rift.png"     // ì°¨ì›ì˜ í‹ˆìƒˆ
};


function logout() {

    // ğŸ”Œ ë­í‚¹/ìœ ì € ì‹¤ì‹œê°„ êµ¬ë… í•´ì œ (ì„ íƒ)
  db.ref("users").off();
  
  // ì €ì¥ëœ ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
  try {
    localStorage.removeItem("swordGameLastUser");
  } catch (e) {
    console.warn("localStorage remove ì‹¤íŒ¨", e);
  }

  // ìƒíƒœ ì´ˆê¸°í™”
  userId = "";
  userPassword = "";
  userRef = null;

  sword = 0;
  power = 10;
  gold  = 100;

  attendanceCount    = 0;
  lastAttendanceDate = "";
  currentField       = 1;
  huntCountToday     = 0;
  lastHuntDate       = "";
  itemScroll15       = 0;
  itemProtect        = 0;
  itemSuper          = 0;
  itemDownProtect    = 0;
  duelWin = 0;
  duelLose = 0;
  duelCountToday = 0;
  lastDuelDate = "";
  duelTargetsToday = {};


  // í™”ë©´ ì „í™˜
  document.getElementById("gameScreen").style.display   = "none";
  document.getElementById("loginScreen").style.display  = "block";
  document.getElementById("attendanceBtn").style.display = "none";
  document.getElementById("inventoryBtn").style.display = "none";
  document.getElementById("logToggle").style.display    = "none";
  document.getElementById("logoutBtn").style.display    = "none";
  document.getElementById("duelBtn").style.display      = "none";
  document.getElementById("mapBtn").style.display       = "none";

  // í”„ë¡œí•„ ì˜ì—­ë„ ì´ˆê¸° ìƒíƒœë¡œ ê°±ì‹ 
  update();
}

// ğŸ–¼ ì‚¬ëƒ¥í„° ë°°ê²½ ì´ë¯¸ì§€ ì ìš©
function applyFieldBackground() {
  const bgEl = document.getElementById("fieldBg");
  if (!bgEl) return;

  // ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸í•œ FIELD_BACKGROUNDS ì‚¬ìš©
  const url = FIELD_BACKGROUNDS[currentField] || FIELD_BACKGROUNDS[1];

  // CSS ::beforeê°€ ì“¸ ì»¤ìŠ¤í…€ ì†ì„±ì— ì£¼ì…
  bgEl.style.setProperty("--field-bg-image", `url('${url}')`);
}

function setNpcName(name) {
  const nameEl = document.getElementById("npcPopupName");
  if (nameEl) nameEl.textContent = name;
}

  
/* UI */

function update() {

  /* ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì˜ì—­ ê°±ì‹  */
  const nickEl   = document.getElementById("profileNickname");
  const weaponTitleEl = document.getElementById("profileWeaponTitle");
  const weaponDescEl  = document.getElementById("profileWeaponDesc");
  const maxInfoEl     = document.getElementById("profileMaxInfo");

  const powerEl  = document.getElementById("profilePower");
  const goldEl   = document.getElementById("profileGold");
  const huntEl   = document.getElementById("profileHuntCount");
  const weaponValueEl = document.getElementById("profileWeaponValue");
  const recordEl = document.getElementById("profileRecord");
  if (recordEl) {
    recordEl.textContent = `ìŠ¹ ${duelWin} / íŒ¨ ${duelLose}`;
  }

  if (nickEl) {
    nickEl.textContent  = userId || "-";
  }

  // ğŸ”° í˜„ì¬ ê°•í™” ë‹¨ê³„ì— ë”°ë¥¸ ê²€ ì •ë³´
  const wInfo = getWeaponInfo(sword);

  // ê²€ ì´ë¦„ (+í˜„ì¬ê°•)
  if (weaponTitleEl && wInfo) {
    weaponTitleEl.textContent = `${wInfo.name} (+${sword}ê°•)`;
  }

  // ê²€ ì„¤ëª…
  if (weaponDescEl && wInfo) {
    weaponDescEl.textContent = wInfo.desc;
  }

  // ìµœëŒ€ ê°•í™” + íŒŒê´´ níšŒ
  if (maxInfoEl) {
    maxInfoEl.innerHTML =
      `+${maxSwordLevel}ê°• ` +
      `<span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ ${destroyCount}íšŒ)</span>`;
  }

  // âš”ï¸ ê°•í™” ë‹¨ê³„ì— ë§ëŠ” ì´ë¯¸ì§€ë¡œ êµì²´
  updateWeaponImage();

  if (powerEl) {
    powerEl.textContent = formatGold(power);
  }
  if (goldEl) {
    goldEl.textContent  = formatGold(gold);
  }
  if (weaponValueEl) {
    const avgValue = getSellRewardAverage(sword); // í‰ê·  íŒë§¤ê°€
    weaponValueEl.textContent = formatGold(avgValue);
  }
  if (huntEl) {
    const today = getTodayDateString();
    if (lastHuntDate !== today) {
      huntEl.textContent = `0 / 20`;
    } else {
      huntEl.textContent = `${huntCountToday} / 20`;
    }
  }
    
  const statusEl = document.getElementById("status");
  if (statusEl) statusEl.innerHTML = "";

const descEl = document.getElementById("fieldDescription");

const FIELD_DESCRIPTIONS = {
  1: `í•œë•Œ ëª¨í—˜ê°€ë“¤ì˜ ì‰¼í„°ì˜€ë˜ ë§ˆì„.
ì „íˆ¬ë³´ë‹¤ëŠ” ê°ì„ ë˜ì°¾ê³  ëª¸ì„ í’€ê¸°ì— ì í•©í•˜ë‹¤.`,

  2: `ë…ê³¼ ë¶€íŒ¨ê°€ ë’¤ì„ì¸ ë„ì‹œì˜ ë°‘ë°”ë‹¥.
í•œ ë²ˆì˜ ì‹¤ìˆ˜ëŠ” ê³§ ê°ì—¼ì„ ì˜ë¯¸í•œë‹¤.`,

  3: `í˜ê³¼ ë°°ì‹ ë§Œì´ ì§€ë°°í•˜ëŠ” ë•….
ë°©ì‹¬í•œ ìë¶€í„° ì´ê³³ì— ë¬»íŒë‹¤.`,

  4: `ì •ë©´ëŒ€ê²°ë³´ë‹¤ ê¸°ìŠµì„ íƒí•˜ëŠ” ê·¸ë“¤ì˜ ì˜ì—­.
ì ì„ ë³¸ ìˆœê°„ì€ ì´ë¯¸ ëŠ¦ì—ˆì„ì§€ ëª¨ë¥¸ë‹¤.`,

  5: `ì‚´ì„ ë² ì–´ë‚´ëŠ” ëƒ‰ê¸°ì™€ ê³ ë…ì˜ ì „ì¥.
ì˜¤ë˜ ë¨¸ë¬´ëŠ” ìë¶€í„° ë¬´ë„ˆì§„ë‹¤.`,

  6: `ì£½ì€ ì˜í˜¼ì´ ëª¨ì—¬ë“  ëì—†ëŠ” ì†Œëª¨ì „.
ìŠ¹ë¦¬í•´ë„ ëŒì•„ì˜¨ë‹¤ëŠ” ë³´ì¥ì€ ì—†ë‹¤.`,

  7: `ë¶„ë…¸ê°€ íƒ€ì˜¤ë¥´ëŠ” ì§€ì˜¥ì˜ ìš”ìƒˆ.
í•œ ë²ˆ ë°€ë¦¬ë©´, ë‹¤ì‹œëŠ” ë°˜ê²©í•  ìˆ˜ ì—†ë‹¤.`,

  8: `ì‹ ì˜ ì‚¬ìë“¤ì´ ì§‘ê²°í•œ ì‹¬íŒì˜ ì„±ì—­.
ì—¬ê¸°ì„œì˜ íŒ¨ë°°ëŠ” ì£„ë¡œ ê¸°ë¡ëœë‹¤.`,

  9: `ì ˆëŒ€ìì˜ ì¡´ì¬ê°ì´ ì˜ì§€ë¥¼ ì§“ëˆŒëŸ¬ ë²„ë¦°ë‹¤.
ê²½ì™¸ì™€ ì˜¤ë§Œì´ ê³µì¡´í•˜ëŠ” ì¥ì†Œ.`,

  10: `ì„¸ê³„ì˜ ê·œì¹™ì´ ë” ì´ìƒ í†µí•˜ì§€ ì•ŠëŠ” ê³µê°„.
ì—¬ê¸°ì„œ ì‚´ì•„ë‚¨ëŠ”ë‹¤ë©´, ì¸ê°„ì´ë¼ ë¶€ë¥¼ ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤.`
};

if (descEl) {
  descEl.innerText = FIELD_DESCRIPTIONS[currentField] || "";
}

  
  // ğŸ”¹ ê°•í™” ì„±ê³µ/ì‹¤íŒ¨ ì •ë³´
  const success = getUpgradeChance(sword);
  let failInfo = "";
  let failRemain = 100 - success; // ì‹¤íŒ¨ ì´ ë¹„ìœ¨

  const midDestroyRatio = {
    16: 0.10,
    17: 0.12,
    18: 0.13,
    19: 0.14
  };

  if (sword <= 10) {
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b> (ìœ ì§€)
    `;
  } else if (sword >= 16 && sword <= 19) {
    const destroy = Math.round(failRemain * midDestroyRatio[sword]);
    const down    = failRemain - destroy;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  } else if (sword <= 20) {
    const keep = Math.round(failRemain * 0.5);
    const down = failRemain - keep;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ìœ ì§€ <b>${keep}%</b> / ê°•ë“± <b>${down}%</b>
    `;
  } else {
    const down = Math.round(failRemain * 0.4);
    const destroy = failRemain - down;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  }

  const cost = getUpgradeCost(sword);

  let safeNote = "";
  // âœ… 5, 10, 15, 20ê¹Œì§€ë§Œ ì„¸ì´í”„ / 25ëŠ” ì œì™¸
  if (sword % 5 === 0 && sword !== 0 && sword <= 20) {
    safeNote = `<br><span style="color:#6cf;">
      â€» ì„¸ì´í”„ êµ¬ê°„: ì‹¤íŒ¨í•´ë„ ê°•ë“±/íŒŒê´´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </span>`;
  }

  const upgradeInfoEl = document.getElementById("upgradeInfo");
  if (upgradeInfoEl) {
    upgradeInfoEl.innerHTML = `
      ì„±ê³µ <b>${success}%</b> / ${failInfo}
      <br>í•„ìš” ê³¨ë“œ <b>${formatGold(cost)}</b>
      ${safeNote}
    `;
  }

  // ğŸ¯ ì‚¬ëƒ¥ ì •ë³´ UI ì—…ë°ì´íŠ¸
  const field = HUNT_FIELDS[currentField];
  const huntSuccess = getHuntSuccessChance(sword, currentField);

  const fieldInfoEl = document.getElementById("currentFieldInfo"); // ì¹´ë“œ ìœ„ í…ìŠ¤íŠ¸
  const huntBtnEl   = document.getElementById("huntBtn");

  // ğŸ—º ì¹´ë“œ ìœ„ì— í˜„ì¬ ì‚¬ëƒ¥í„° + ë ˆë²¨ + ì„±ê³µí™•ë¥  í‘œì‹œ
  if (field && fieldInfoEl) {
    const huntSuccess = getHuntSuccessChance(sword, currentField);

    fieldInfoEl.innerHTML = `
      <div style="font-size: 21px; font-weight: bold;">
        ${field.name}
      </div>
      <div class="current-field-info-sub">
        ì¶”ì²œ ë ˆë²¨: +${field.recLevel}ê°•
        &nbsp;/&nbsp;
        ë‚´ ë ˆë²¨: +${sword}ê°•
        &nbsp;/&nbsp;
        ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥ : ${huntSuccess}%
      </div>
    `;
  }

  // ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ UI ê°±ì‹ 
  updateHuntUI();
  
// ğŸ†• ê²°íˆ¬ ë‚¨ì€ íšŸìˆ˜ UI ê°±ì‹ 
updateDuelUI();
  
  // ğŸ”¥ í˜„ì¬ ì‚¬ëƒ¥í„° ë°°ê²½ ì ìš© (CSS ::beforeìš© ë³€ìˆ˜ ì„¸íŒ…)
  applyFieldBackground();
}

// âš”ï¸ ê²°íˆ¬ ì¼ì/ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
function ensureDuelDate() {
  const today = getTodayDateString();
  if (lastDuelDate !== today) {
    lastDuelDate = today;
    duelCountToday = 0;
    duelTargetsToday = {};
  }
}
  
// âš”ï¸ ì‹¤ì œ ê²°íˆ¬ ì²˜ë¦¬
// targetUserId : ë„ì „ ëŒ€ìƒ ìœ ì € ì•„ì´ë””
// isRandomMatch: ëœë¤ë§¤ì¹­ ì—¬ë¶€ (trueë©´ ê°™ì€ ìƒëŒ€ 3íšŒ ì œí•œ ë¯¸ì ìš©)
function performDuel(targetUserId, isRandomMatch) {
  if (!userId || !userRef) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  // ë‚ ì§œ ë°”ë€Œì—ˆìœ¼ë©´ ì˜¤ëŠ˜ ì¹´ìš´íŠ¸ ë¦¬ì…‹
  ensureDuelDate();

  // âœ… í•˜ë£¨ ì´ 10íšŒ ì œí•œ
 if (duelCountToday >= 10) {
  showNpcMessage(
    `
    <div style="font-size:16px; font-weight:bold;">
      ì´ë´, ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ë‹¤!
    </div>
    <div style="margin-top:4px; font-size:13px;">
      ìŠ¹ë¶€ëŠ” ì‰¬ì–´ì•¼ ë” ëœ¨ê²ì§€.<br>
      <span style="color:#ccc;">(í•˜ë£¨ 10íšŒ ê²°íˆ¬ ì œí•œ)</span>
    </div>
    `,
    "images/npc/duel_carnia.png",
    true,
    "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
  );
  return;
}

  // âœ… ê°™ì€ ìƒëŒ€ì—ê²Œ í•˜ë£¨ 3íšŒê¹Œì§€ (ì§ì ‘ ë„ì „ë§Œ)
if (!isRandomMatch) {
  const cnt = duelTargetsToday[targetUserId] || 0;
  if (cnt >= 3) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ê·¸ë§Œí•´, ê·¸ ìƒëŒ€ëŠ” ì´ë¯¸ ì¶©ë¶„íˆ ë‘ë“¤ê²¨ íŒ¼ì–ì•„?
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ë‹¤ë¥¸ ì „ì¥ë„ í•œë²ˆ ëŒì•„ë³´ë¼ê³ .<br>
        <span style="color:#ccc;">(ê°™ì€ ìƒëŒ€ í•˜ë£¨ 3íšŒ ì œí•œ)</span>
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }
}

  // ğŸ” ìƒëŒ€ ìœ ì € ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const targetRef = db.ref("users/" + targetUserId);
  targetRef.once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    const t = snap.val();

    const targetSword = Number(t.sword ?? 0);
    let targetPower = Number(t.power ?? 0);
    const attackerLvHtml = coloredLevel(sword);        // ë‚´ +00ê°• (ì»¬ëŸ¬ í¬í•¨)
const defenderLvHtml = coloredLevel(targetSword);  // ìƒëŒ€ +00ê°• (ì»¬ëŸ¬ í¬í•¨)

    // ìƒëŒ€ ì „íˆ¬ë ¥ì´ 0ì´ê±°ë‚˜ êµ¬ë²„ì „ì´ë©´ ëŒ€ëµì ì¸ ê³µê²©ë ¥ìœ¼ë¡œ ëŒ€ì‹  ì‚¬ìš©
    if (!targetPower || targetPower <= 0) {
      targetPower = getBaseAttack(targetSword);
    }

    // ë‚´ ì „íˆ¬ë ¥ë„ ì•ˆì „í•˜ê²Œ ë³´ì •
    if (!power || power <= 0) {
      rollPowerForCurrentSword();
    }

    const A = Math.max(1, Number(power));
    const B = Math.max(1, Number(targetPower));
    const sum = A + B;

    const winProb = sum > 0 ? (A / sum) : 0.5;
    const isWin = Math.random() < winProb;

    // ë³´ìƒ ê³¨ë“œ: ìƒëŒ€ ë¬´ê¸° ê°•í™”ë¹„ìš©ì˜ 2.5ë°° ~ 2.8ë°°
    const baseLevel = Math.min(targetSword, 29);
    const baseCost = getUpgradeCost(baseLevel);
    const reward = isWin
      ? Math.floor(baseCost * randRange(2.5, 2.8))
      : 0;

    // ğŸ”¢ ì¹´ìš´íŠ¸/ì „ì  ê°±ì‹ 
    duelCountToday++;

    if (!isRandomMatch) {
      const prev = duelTargetsToday[targetUserId] || 0;
      duelTargetsToday[targetUserId] = prev + 1;
    }

if (isWin) {
  duelWin++;
  gold += reward;

  showNpcMessage(
    `
    <div style="font-size:18px; font-weight:bold; color:#FFD700;">
      ë©‹ì§„ ìŠ¹ë¦¬ì˜€ì–´!
    </div>
    <div style="margin-top:6px; font-size:14px;">
      ë„¤ ê²€ì´ ê²½ê¸°ì¥ì„ ë“¤ì©ì´ê²Œ ë§Œë“¤ì—ˆêµ°!<br>
      ğŸ’° ${formatGold(reward)} ê³¨ë“œë¥¼ ì±™ê²¨ ê°€ë¼!
    </div>
    `,
    "images/npc/duel_carnia.png",
    true,
    "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
  );

  const logMsg = isRandomMatch
    ? `${userId}ë‹˜(${attackerLvHtml})ì´ ëœë¤ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ${targetUserId}ë‹˜(${defenderLvHtml})ê³¼ì˜ ê²°íˆ¬ì—ì„œ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤!`
    : `${userId}ë‹˜(${attackerLvHtml})ì´ ${targetUserId}ë‹˜(${defenderLvHtml})ê»˜ ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤!`;

  writeLog(logMsg);


} else {
  duelLose++;

  showNpcMessage(
    `
    <div style="font-size:18px; font-weight:bold; color:#FF6666;">
      ì“°ëŸ¬ì¡Œì§€ë§Œ, ê½¤ ê·¼ì‚¬í–ˆëŠ”ê±¸?
    </div>
    <div style="margin-top:6px; font-size:14px;">
      ì´ë²ˆ íŒì€ ì €ìª½ ì†ì„ ë“¤ì–´ì¤˜ì•¼ê² ë„¤.<br>
      ë³´ìƒì€ ì—†ì§€ë§Œ, ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ë…¸ë ¤ë´!
    </div>
    `,
    "images/npc/duel_carnia.png",
    true,
    "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
  );

  const logMsg = isRandomMatch
    ? `${userId}ë‹˜(${attackerLvHtml})ì´ ëœë¤ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ${targetUserId}ë‹˜(${defenderLvHtml})ê³¼ì˜ ê²°íˆ¬ì—ì„œ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤...`
    : `${userId}ë‹˜(${attackerLvHtml})ì´ ${targetUserId}ë‹˜(${defenderLvHtml})ê»˜ ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤...`;

  writeLog(logMsg);
}

    update();
    save();
  });
}
  
// âš”ï¸ ê²°íˆ¬ ì‹ ì²­ í™•ì¸ íŒì—… (ì§ì ‘ ê²°íˆ¬ ì‹ ì²­ ì „ìš©)
function showDuelConfirmPopup(targetUserId) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ§â€â™€ï¸ ì¹´ë¥´ë‹ˆì•„ ì„¸íŒ…
  setNpcName("ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸");
  imgEl.src = "images/npc/duel_carnia.png";

  // ğŸ—¨ ì¹´ë¥´ë‹ˆì•„ ë§íˆ¬ë¡œ ëŒ€ì‚¬ êµì²´
  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ì¢‹ì•„, ìŠ¹ë¶€ë¥¼ ê³ í•˜ëŠ”êµ°!
    </div>
    <div style="font-size:14px; line-height:1.5;">
      ì •ë§ë¡œ <b>${targetUserId}</b>ì™€(ê³¼) ì •ì •ë‹¹ë‹¹íˆ ë§ì„œê² ë‚˜?
    </div>
  `;

  // ë²„íŠ¼ ë…¸ì¶œ + í…ìŠ¤íŠ¸ ë³€ê²½
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "ê²°íˆ¬í•œë‹¤!";
  cancelBtn.textContent = "ì ê¹ë§Œâ€¦";

  okBtn.onclick = function () {
    popup.style.display = "none";
    // ì§ì ‘ ì‹ ì²­ì€ isRandomMatch = false
    performDuel(targetUserId, false);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
  };

  popup.style.display = "flex";
}
  
function showNpcMessage(
  text,
  imgPath = "images/npc/blacksmith_idle.png",
  showButton = true,
  npcName = "ëŒ€ì¥ì¥ì´ â€“ í¼ê·¸ë€íŠ¸"
) {
  setNpcName(npcName);   // ê¸°ë³¸ì€ í¼ê·¸ë€íŠ¸(ë§¤ê°œë³€ìˆ˜ ê¸°ë³¸ê°’)

  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) {
    alert(text);
    return;
  }

  msgEl.innerHTML = text;
  imgEl.src = imgPath;

  if (showButton) {
    okBtn.style.display = "inline-block";
    okBtn.textContent = "í™•ì¸";
    okBtn.onclick = closeNpcPopup;
  } else {
    okBtn.style.display = "none";
  }

  cancelBtn.style.display = "none";
  cancelBtn.onclick = closeNpcPopup;

  popup.style.display = "flex";
}

// âŒ¨ï¸ ì—”í„° í‚¤ë¡œ NPC íŒì—… "í™•ì¸" ëˆ„ë¥´ê¸° (í•œ ë²„íŠ¼ íŒì—… ì „ìš©)
window.addEventListener("keydown", function (e) {
  if (e.key !== "Enter") return;

  const popup = document.getElementById("npcPopup");
  if (!popup) return;

  // íŒì—…ì´ ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ
  if (popup.style.display === "none" || popup.style.display === "") return;

  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!okBtn || !cancelBtn) return;

  // âœ… "í™•ì¸"ë§Œ ìˆëŠ” íŒì—…ì¼ ë•Œë§Œ ì—”í„°ë¡œ ì‘ë™í•˜ê²Œ (íŒë§¤í™•ì¸ ê°™ì€ ê±´ ë³´í˜¸)
  const okVisible     = okBtn.style.display !== "none";
  const cancelVisible = cancelBtn.style.display !== "none";

  if (okVisible && !cancelVisible) {
    e.preventDefault();   // í¼ ì œì¶œ ê°™ì€ ê¸°ë³¸ í–‰ë™ ë§‰ê¸°
    okBtn.click();        // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
  }
});

  
// í”„ë¡œí•„ ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ í‘œì‹œ
let profileSaveTimer = null;

function setProfileSaveStatus(message, durationMs) {
  const el = document.getElementById("profileSaveStatus");
  if (!el) return;

  el.textContent = message;
  el.style.opacity = "1";

  if (profileSaveTimer) {
    clearTimeout(profileSaveTimer);
    profileSaveTimer = null;
  }

  if (durationMs && durationMs > 0) {
    profileSaveTimer = setTimeout(() => {
      el.style.opacity = "0";
    }, durationMs);
  }
}
  // ğŸ“· í”„ë¡œí•„ ì¹´ë“œ ìº¡ì³ í›„ ì´ë¯¸ì§€ ì €ì¥
function saveProfileCard() {

  const card = document.getElementById("fieldBg");

  setProfileSaveStatus("ì €ì¥ì¤‘ ...", 0);

  // âœ… ìº¡ì³ ì „ìš© ëª¨ë“œ í™œì„±í™”
  document.body.classList.add("capture-mode");

  html2canvas(card, {
    scale: 2,
    useCORS: true
  }).then(canvas => {

    // â¬… ì €ì¥ í›„ ì›ë˜ í™”ë©´ ë³µêµ¬
    document.body.classList.remove("capture-mode");

    canvas.toBlob(function (blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${userId}_profile_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);

      setProfileSaveStatus("ì €ì¥ì™„ë£Œ !", 1500);
    });

  }).catch(err => {

    // â›” ì˜¤ë¥˜ ë°œìƒí•´ë„ í™”ë©´ ë³µêµ¬
    document.body.classList.remove("capture-mode");
    setProfileSaveStatus("ì €ì¥ ì‹¤íŒ¨...", 2000);
  });
}


  // âš ï¸ 25ê°• ì´ìƒ ì„¸ì´í”„ì¡´ ì‚­ì œ ì•ˆë‚´ íŒì—…
function showUpgradeWarning25() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // NPC ì´ë¦„ / ì´ë¯¸ì§€ ì„¸íŒ… (ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸)
  setNpcName("ëŒ€ì¥ì¥ì´ â€“ í¼ê·¸ë€íŠ¸");
  imgEl.src = "images/npc/blacksmith_idle.png";

  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px; color:#FFCC00;">
      âš ï¸ 25ê°• ì´ìƒ êµ¬ê°„ ì•ˆë‚´
    </div>
    <div style="font-size:14px; line-height:1.6;">
      25ê°•ë¶€í„°ëŠ” ë” ì´ìƒ <b>ì„¸ì´í”„ì¡´ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë„¤.</b><br>
      ì‹¤íŒ¨í•˜ë©´ <b>ê°•ë“±</b>ì´ë‚˜ <span style="color:#FF5555;">íŒŒê´´</span>ê°€<br>
      ì–¸ì œë“  ì¼ì–´ë‚  ìˆ˜ ìˆì§€.
      <br><br>
      ê·¸ë˜ë„â€¦ ê³„ì† ë„ì „í•˜ê² ë‚˜?
    </div>
  `;

  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";

  okBtn.textContent = "ê·¸ë˜ë„ ë„ì „í•œë‹¤";
  cancelBtn.textContent = "ìƒê°í•´ë³¸ë‹¤";

  okBtn.onclick = function () {
    popup.style.display = "none";
    hasSeen25Warning = true;          // ì´í›„ë¡  ê²½ê³  ë‹¤ì‹œ ì•ˆ ëœ¸
    ignoreNextUpgradeWarning = true;  // ì´ë²ˆì— í•œ ë²ˆì€ ê²½ê³  ìŠ¤í‚µí•˜ê³  upgrade ì¬í˜¸ì¶œ
    upgrade();                        // ì‹¤ì œ ê°•í™” ë¡œì§ ë‹¤ì‹œ ì§„ì…
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
  };

  popup.style.display = "flex";
}

function showTutorialIfFirstTime() {

  if (!userId) return;   // ë¡œê·¸ì¸ ì•ˆ ëìœ¼ë©´ ìˆ˜í–‰ ì•ˆ í•¨

  const key = getTutorialKeyForUser(userId);

  try {
    if (localStorage.getItem(key) === "1") return;
  } catch (e) {}

  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}


function closeTutorial() {
  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) overlay.style.display = "none";

  if (!userId) return;

  const key = getTutorialKeyForUser(userId);

  try {
    localStorage.setItem(key, "1");
  } catch (e) {}
}
  
function closeNpcPopup() {
  const popup = document.getElementById("npcPopup");
  if (popup) popup.style.display = "none";
}

// ğŸ§­ ì‚¬ëƒ¥í„° ì´ë™ ì „ìš© íŒì—… (NPC ì´ë¯¸ì§€/ë²„íŠ¼ ìˆ¨ê¹€)
function showMovePopup() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName"); 

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ”¹ NPC ì´ë¦„ ì§€ìš°ê¸°
  if (nameEl) nameEl.textContent = "";
  
  // ì´ë¯¸ì§€ / ë²„íŠ¼ ì „ë¶€ ìˆ¨ê¸°ê³ , í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
  imgEl.style.display = "none";
  okBtn.style.display = "none";
  cancelBtn.style.display = "none";

  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
      ì‚¬ëƒ¥í„° ì´ë™ ì¤‘...
    </div>
  `;

  popup.style.display = "flex";
}


// âš”ï¸ ì‚¬ëƒ¥ ê²°ê³¼ íŒì—… (NPC ì´ë¯¸ì§€/ë²„íŠ¼ X)
function showHuntPopup(text, color = "#FFFFFF") {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ”¹ ì´ë¦„ ì œê±°
  if (nameEl) nameEl.textContent = "";
  
  // ì´ë¯¸ì§€ / ë²„íŠ¼ ìˆ¨ê¹€
  imgEl.style.display = "none";
  okBtn.style.display = "none";
  cancelBtn.style.display = "none";

  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; color:${color};">
      ${text}
    </div>
  `;

  popup.style.display = "flex";

  // 1.2ì´ˆ í›„ ìë™ ë‹«í˜ + ê¸°ë³¸ ìƒíƒœ ë³µì›
  setTimeout(() => {
    popup.style.display = "none";
    imgEl.style.display = "block";
    okBtn.style.display = "inline-block";
    cancelBtn.style.display = "none";
  }, 1200);
}


  
function closeMovePopup() {
  const popup     = document.getElementById("npcPopup");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !imgEl || !okBtn || !cancelBtn) return;

  // ë‹¤ìŒì— NPC ëŒ€ì‚¬ ì“¸ ìˆ˜ ìˆë„ë¡ ëŒ€ëµ ê¸°ë³¸ í˜•íƒœë¡œ ë³µì›
  imgEl.style.display = "block";
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "none";

  popup.style.display = "none";
}

  
// ìˆ«ì ê³¨ë“œë¥¼ "12ì–µ 8,765ë§Œ 4,252" í˜•íƒœë¡œ ë³€í™˜
function formatGold(value) {
  const n = Number(value) || 0;

  // 100ë§Œ ë¯¸ë§Œì€ ê·¸ëƒ¥ ìˆ«ì+ì½¤ë§ˆë¡œ
  if (n < 1_000_000) {
    return n.toLocaleString();
  }

  const EOK = 100_000_000; // ì–µ
  const MAN = 10_000;      // ë§Œ

  const eok = Math.floor(n / EOK);
  let rest = n % EOK;
  const man = Math.floor(rest / MAN);
  const won = rest % MAN;

  const parts = [];
  if (eok > 0) parts.push(`${eok.toLocaleString()}ì–µ`);
  if (man > 0) parts.push(`${man.toLocaleString()}ë§Œ`);
  if (won > 0) parts.push(won.toLocaleString());

  if (parts.length === 0) return "0";
  return parts.join(" ");
}
  
function randRange(min, max) {
  return min + Math.random() * (max - min);
}

  function getCurrentUpgradeCost() {
  return getUpgradeCost(Math.min(sword, 29));
}

function getUpgradeCost(level) {

  const costTable = {
    0: 0,
    1: 20,
    2: 50,
    3: 100,
    4: 500,
    5: 1000,
    6: 3000,
    7: 5000,
    8: 10000,
    9: 30000,
    10: 50000,
    11: 100000,
    12: 300000,
    13: 500000,
    14: 1000000,
    15: 3000000,
    16: 5000000,
    17: 10000000,
    18: 30000000,
    19: 50000000,
    20: 100000000,
    21: 300000000,
    22: 500000000,
    23: 1000000000,
    24: 3000000000,
    25: 5000000000,
    26: 10000000000,
    27: 30000000000,
    28: 50000000000,
    29: 100000000000
  };

  return costTable[level] ?? 0;
}

// íŒë§¤ ì‹œ, ê·¸ ë ˆë²¨ì—ì„œ ë‹¤ìŒ ê°•í™”ë¥¼ ëª‡ ë²ˆ ì •ë„ ë„ì „ ê°€ëŠ¥í•˜ê²Œ í•´ì¤„ì§€ ê²°ì •
function getSellAttemptFactor(level) {
  // 30ê°•ì€ 29ê°• ê¸°ì¤€ìœ¼ë¡œ ë³¸ë‹¤ (ë¹„ìš©/í™•ë¥  í…Œì´ë¸”ì´ 29ê¹Œì§€ë¼ì„œ)
  const forChance = Math.min(level, 29);

  const chance = getUpgradeChance(forChance); // 0~100
  if (chance <= 0) return 2; // ì•ˆì „ ì¥ì¹˜

  const expectedTries = 100 / chance; // ì„±ê³µê¹Œì§€ í‰ê·  ì‹œë„ íšŸìˆ˜

  if (expectedTries <= 2.0) {
    return 2;   // ì„±ê³µë¥  ë†’ìŒ â†’ 2ë²ˆ ì •ë„ ë„ì „ê¶Œ
  } else if (expectedTries <= 3.5) {
    return 3;
  } else if (expectedTries <= 4.5) {
    return 4;
  } else if (expectedTries <= 7.0) {
    return 5;   // ì˜ˆ: 20%~25%ëŒ€ í™•ë¥ 
  } else {
    return 6;   // ì•„ì£¼ ë‚®ì€ í™•ë¥  â†’ 5~6ë²ˆ ë„ì „ê¶Œ
  }
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ ê³„ì‚°
// A = 0â†’Lê¹Œì§€ ì„±ê³µ ê°€ì • ì´ë¹„ìš©
// B = Lê°• ê°•í™”ë¹„ìš© Ã— (ê¸°ëŒ“ê°’ ê¸°ë°˜ ë„ì „ íšŸìˆ˜)
// ë³´ìƒ = (A + B) Ã— 1.15~1.20
function getSellReward(level) {
  if (level <= 0) return 0; // 0ê°•ì€ íŒ” ê²Œ ì—†ìŒ

  const totalCost = getTotalCostToLevel(level);   // A
  const costNow   = getUpgradeCost(Math.min(level, 29)); // Lê°• ì‹œë„ ë¹„ìš© (30ê°• ë³´í˜¸)

  const attemptFactor = getSellAttemptFactor(level); // ë„ì „ íšŸìˆ˜ ë³´ì •
  const B = costNow * attemptFactor;

  const base = totalCost + B;
  const mul  = randRange(1.15, 1.20); // 115% ~ 120%

  const reward = Math.floor(base * mul);
  return reward;
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ "í‰ê· " ê°’ (ë¬´ê¸°ê°€ì¹˜ í‘œì‹œìš©)
function getSellRewardAverage(level) {
  if (level <= 0) return 0;

  const totalCost = getTotalCostToLevel(level);
  const costNow   = getUpgradeCost(Math.min(level, 29));
  const attemptFactor = getSellAttemptFactor(level);
  const B = costNow * attemptFactor;

  const base = totalCost + B;

  // getSellReward ì—ì„œ 1.15 ~ 1.20 ëœë¤ì´ë‹ˆê¹Œ, ì¤‘ê°„ê°’ 1.175ë¥¼ í‰ê· ìœ¼ë¡œ ì‚¬ìš©
  const avgMultiplier = (1.15 + 1.20) / 2; // 1.175
  return Math.floor(base * avgMultiplier);
}

  
// 0ê°• â†’ levelê°• ê¹Œì§€, ëª¨ë‘ 1íŠ¸ ì„±ê³µí•œë‹¤ê³  ê°€ì •í•œ ì´ ê°•í™”ë¹„ìš©
function getTotalCostToLevel(level) {
  let sum = 0;
  for (let i = 0; i < level; i++) {
    sum += getUpgradeCost(i);
  }
  return sum;
}

// âš”ï¸ ê°•í™”ë¹„ìš© ê¸°ë°˜ ê³µê²©ë ¥ ê³„ì‚°
function getBaseAttack(level) {
  // 0ê°•ë„ ìµœì†Œ 10 ì´ìƒì€ ë‚˜ì˜¤ê²Œ
  const total = getTotalCostToLevel(level); // 0â†’levelê¹Œì§€ ì´ ê°•í™”ë¹„ìš©
  const atk = Math.floor(total / 1000) + 10;
  return atk;
}

// âš”ï¸ í˜„ì¬ ê°•í™” ë‹¨ê³„ ê¸°ì¤€ ì „íˆ¬ë ¥ ì‚°ì • (ìµœì´ˆ 1íšŒ ê²°ì •, ê³ ì •)
function rollPowerForCurrentSword() {

  // 1ï¸âƒ£ ì§€ê¸ˆê¹Œì§€ ê°•í™”ì— ë“¤ì–´ê°„ ì´ ë¹„ìš© = ê¸°ë³¸ ì „íˆ¬ë ¥ ì§€í‘œ
  const totalCost = getTotalCostToLevel(sword);

  // 2ï¸âƒ£ ì „íˆ¬ë ¥ ê¸°ë³¸ê°’ (ìŠ¤ì¼€ì¼ ì¡°ì ˆìš© ê³„ìˆ˜)
  const basePower = totalCost * 0.6;

  // 3ï¸âƒ£ Â±5% í¸ì°¨ ì ìš© (1íšŒë§Œ êµ´ë¦¼)
  const variance = basePower * (Math.random() * 0.1 - 0.05);
  const finalPower = basePower + variance;

  // 4ï¸âƒ£ ìµœì†Œê°’ ë³´ì • + ì •ìˆ˜í™”
  power = Math.max(1, Math.floor(finalPower));
}
  
/* í™•ë¥  */
function getUpgradeChance(level) {
  // 0 -> 1 ì€ 100% ê³ ì •
  if (level === 0) return 100;

  let chance;

  if (level < 20) {
    // 1 ~ 19ê°• êµ¬ê°„ : ë ˆë²¨ 1 ì˜¤ë¥¼ ë•Œë§ˆë‹¤ -4%
    chance = 100 - (level * 4);
  } else {
    // 20ê°• ì´í›„ : -2%ì”© ê°ì†Œ
    const base20 = 100 - (20 * 4); // 20%
    const extra = level - 20;
    chance = base20 - (extra * 2);
  }

  // ğŸ’« ì „ì²´ êµ¬ê°„ ì†Œí­ ìƒí–¥ (+5%)
  chance += 5;

  // ìƒí•œ/í•˜í•œ ì •ë¦¬
  chance = Math.min(100, chance); // 100% ë„˜ì§€ ì•Šê²Œ
  chance = Math.max(5, chance);   // ì•ˆì „ í•˜í•œ (ì‹¤ì œë¡œëŠ” ê±°ì˜ 10% ì´ìƒì¼ ê²ƒ)

  return chance;
}

// ğŸ ì¶œì„ ì—°ì† ë³´ìƒ (5íšŒë§ˆë‹¤ ë°˜ë³µ)
const attendanceBonusTable = {
  5:  { type: "downProtect",   name: "ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ" },
  10: { type: "scroll15",      name: "15ê°• ê°•í™” ì£¼ë¬¸ì„œ" },
  15: { type: "destroyProtect",name: "íŒŒê´´ë°©ì–´ ì£¼ë¬¸ì„œ" },
  20: { type: "superScroll",   name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ" },
  25: { type: "downProtect",   name: "ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ" }
};
  
function checkAttendance() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const today = getTodayDateString();

  // ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•¨
  if (lastAttendanceDate === today) {
    alert("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤!");
    return;
  }

  // ë‚ ì§œ ë¹„êµ (ì—°ì† ì¶œì„ ì²˜ë¦¬)
const yesterday = getYesterdayDateString();

// ì–´ì œë„ ì°ì—ˆìœ¼ë©´ ì—°ì† ì¶œì„ +1, ì•„ë‹ˆë©´ 1ë¶€í„°
if (lastAttendanceDay === yesterday) {
  attendanceStreak++;
} else {
  attendanceStreak = 1;
}

lastAttendanceDay = today;
lastAttendanceDate = today;
attendanceCount++;

  // ==========================
  // ğŸ ê³¨ë“œ ì§€ê¸‰ ë°©ì‹ ë³€ê²½
  // ==========================

  let rewardGold = 0;

  if (sword < 15) {
    // 15ê°• ì´ì „ â†’ ê¸°ì¡´ ì§€ê¸‰ ìœ ì§€
    rewardGold = 60000;
  } else {
    // 15ê°• ì´í›„ â†’ ê°•í™” 1ë²ˆ ê°€ëŠ¥í•œ ê¸ˆì•¡ ì§€ê¸‰
    rewardGold = getCurrentUpgradeCost();
  }

  gold += rewardGold;

writeLog(
  `${userId}ë‹˜ì´ ì¶œì„ìœ¼ë¡œ ${formatGold(rewardGold)} ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤. `
  + `(ì—°ì† ${attendanceStreak}íšŒ)`
);

  // ==========================
  // ğŸ¯ 5íšŒ / 10íšŒ / 15íšŒ / 20íšŒ / 25íšŒ ë³´ìƒ
  // ==========================

  const key = (attendanceStreak % 25) || 25;

  if (attendanceBonusTable[key]) {

    const bonus = attendanceBonusTable[key];

    // ì•„ì´í…œ ì§€ê¸‰
    if (bonus.type === "scroll15") itemScroll15++;
    if (bonus.type === "superScroll") itemSuper++;
    if (bonus.type === "downProtect") itemDownProtect++;
    if (bonus.type === "destroyProtect") itemProtect++;

writeLog(
  `${userId}ë‹˜ì´ ì—°ì† ${attendanceStreak}íšŒ ì¶œì„ ë‹¬ì„±! `
  + `ì¶œì„ ë³´ìƒìœ¼ë¡œ ${bonus.name}ì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.`
);


    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ğŸ ì—°ì† ${attendanceStreak}íšŒ ì¶œì„ ë³´ìƒ
      </div>
      <div style="margin-top:4px;">
        <b>${bonus.name}</b>ì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.
      </div>
      `,
      null,
      true
    );
  }

  update();
  save();
}
  
/* ê°•í™” */
function upgrade() {
  if (sword >= 30) {
    alert("ìµœëŒ€ ê°•í™”");
    return;
  }

  // ğŸ›‘ 25ê°• ì´ìƒ ì²« ë„ì „ ê²½ê³  ì•ˆë‚´ (ì„¸ì…˜ 1íšŒ)
  if (sword >= 25 && !hasSeen25Warning && !ignoreNextUpgradeWarning) {
    showUpgradeWarning25();
    return;
  }
  // ê²½ê³ ë¥¼ ë³´ê³  ë‹¤ì‹œ ë“¤ì–´ì˜¨ í˜¸ì¶œì€ ì´ í”Œë˜ê·¸ë¡œ í•œ ë²ˆ ìŠ¤í‚µ
  ignoreNextUpgradeWarning = false;
  
  // ì´ë¯¸ ê°•í™” ì¤‘ì´ë©´ ì¤‘ë³µ í´ë¦­ ë°©ì§€
  if (isUpgrading) return;

  // ğŸ”˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì½ê¸°
  const scroll15El = document.getElementById("useScroll15");
  const protectEl  = document.getElementById("useProtect");
  const downProtEl = document.getElementById("useDownProtect");
  const superEl    = document.getElementById("useSuper");

  const wantScroll15 = !!(scroll15El && scroll15El.checked);
  const wantProtect  = !!(protectEl  && protectEl.checked);
  const wantDownProt = !!(downProtEl && downProtEl.checked);
  const wantSuper    = !!(superEl    && superEl.checked);

  // âš ï¸ ì•„ì´í…œ ì—†ëŠ” ìƒíƒœì—ì„œ ì²´í¬í•œ ê²½ìš° â†’ ê°•í™” ì§„í–‰ ê¸ˆì§€
  if (wantScroll15 && itemScroll15 <= 0) {
    showNpcMessage("15ê°• ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantProtect && itemProtect <= 0) {
    showNpcMessage("íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantDownProt && itemDownProtect <= 0) {
    showNpcMessage("ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantSuper && itemSuper <= 0) {
    showNpcMessage("ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }


  // ğŸ¯ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ ì „ìš© ì²˜ë¦¬ (ì¦‰ì‹œ ì²˜ë¦¬, ë”œë ˆì´ X)
  if (wantScroll15) {

    if (sword >= 15) {
      alert("15ê°• ì´ìƒì˜ ë¬´ê¸°ì—ëŠ” 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    itemScroll15 -= 1;
    sword = 15;
    rollPowerForCurrentSword();

    if (scroll15El) scroll15El.checked = false; // í•œ ë²ˆ ì“°ê³  ì²´í¬ í•´ì œ

  writeLog(
  `${userId}ë‹˜ì´ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ê¸°ê°€ ${coloredLevel(15)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
);

// í¼ê·¸ë€íŠ¸ ëŒ€ì‚¬ + ì„±ê³µ ì´ë¯¸ì§€
showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#C0C0C0;">
    15ê°• ê°•í™”!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì§€! 15ê°•, ë‹¨ìˆ¨ì— ì˜¬ë ¤ì£¼ì§€.
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

    update();
    save();
    return;
  }

   // ğŸª™ ì¼ë°˜ ê°•í™” (íŒŒê´´ë°©ì§€ / ìŠˆí¼ê°•í™”ë§Œ ì˜í–¥)
  const cost = getUpgradeCost(sword);

  if (gold < cost) {
    showNpcMessage(
      "ìë„¤, ê³¨ë“œëŠ” ì¶©ë¶„í•œê²Œ ë§ë‚˜?",
      "images/npc/blacksmith_idle.png"
    );
    return;
  }

  // ğŸ‘‰ ì—¬ê¸°ì„œë¶€í„° ì§„ì§œ ê°•í™” ì‹œì‘ì´ë‹ˆê¹Œ,
  //    ì´ì œ ì ê¸ˆ ì²˜ë¦¬
  isUpgrading = true;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = true);

  // ê³¨ë“œ ì°¨ê° ë° ì•„ì´í…œ ì†Œë¹„ëŠ” ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì²˜ë¦¬
  gold -= cost;

  const chance = getUpgradeChance(sword);
  const before = sword;

const useProtect  = wantProtect  && itemProtect > 0;
const useSuper    = wantSuper    && itemSuper   > 0;
const useDownProt = wantDownProt && itemDownProtect > 0;

// âœ… ëª¨ë“  ì£¼ë¬¸ì„œëŠ” ê°•í™” ë²„íŠ¼ ëˆ„ë¥¸ ì‹œì ì— ì¦‰ì‹œ ì†Œëª¨
if (useProtect)  itemProtect     -= 1;
if (useSuper)    itemSuper       -= 1;
if (useDownProt) itemDownProtect -= 1;

  // ğŸ•’ 1~2ì´ˆ ëœë¤ ë”œë ˆì´ ë™ì•ˆ "ê°•í™” ì¤‘..." íŒì—…
const delayMs = 500 + Math.random() * 500; // 0.5 ~ 1.0ì´ˆ

showNpcMessage(
  "ê°•í™” ì¤‘ì…ë‹ˆë‹¤...",
  "images/npc/blacksmith_upgrade.png",
  false   // â¬… ë²„íŠ¼ ìˆ¨ê¹€
);


  setTimeout(() => {
    // ì¤€ë¹„ íŒì—… ë‹«ê¸°
    closeNpcPopup();

    // ğŸ² ì„±ê³µ / ì‹¤íŒ¨ íŒì •
if (Math.random() < chance / 100) {
  // âœ… ì„±ê³µ
  let up = useSuper ? 2 : 1; // ìŠˆí¼ê°•í™”ë©´ +2

  while (up > 0 && sword < 30) {
    sword++;
    up--;
  }

  rollPowerForCurrentSword();
  
    // ìµœê³  ê°•í™” ê¸°ë¡ ê°±ì‹ 
  if (sword > maxSwordLevel) {
    maxSwordLevel = sword;
  }

  // í¼ê·¸ë€íŠ¸ ì„±ê³µ ë©˜íŠ¸
  if (useSuper) {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFD700;">
    ìŠˆí¼ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ë‘ ë‹¨ê³„ë‚˜ ì˜¬ë¼ê°”ë‹¤ê³ !? ì „ì„¤ì´ ë³´ì´ëŠ”êµ°!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  } else {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
    ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì•„! ì œëŒ€ë¡œ ë¶™ì—ˆêµ¬ë§Œ!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  }

  if (before >= 20) {
    writeLog(
      `${userId}ì´ ${coloredLevel(before + 1)} ë„ì „ì— ì„±ê³µí•˜ì—¬ ${coloredLevel(sword)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
    );
  }
  } else {
    // âŒ ì‹¤íŒ¨
    // âœ… 5,10,15,20ê¹Œì§€ë§Œ ì„¸ì´í”„ / 25ë¶€í„°ëŠ” ì„¸ì´í”„ ì—†ìŒ
    const isSafeLevel = (before % 5 === 0 && before <= 20);

    if (useProtect) {
      // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš© ì‹œ
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FF5555;">
          ê°•í™”ì‹¤íŒ¨!
        </div>
        <div style="margin-top:6px;">
          ìœ„í—˜í–ˆë„¤â€¦ ì£¼ë¬¸ì„œ ë•ì— ë²„í…¼ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      if (isSafeLevel) {
        // ì„¸ì´í”„ êµ¬ê°„ ì‹¤íŒ¨ â†’ ìœ ì§€
        showNpcMessage(
          `
          <div style="font-size:18px; font-weight:bold; color:#FF5555;">
            ê°•í™”ì‹¤íŒ¨!
          </div>
          <div style="margin-top:6px;">
            í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼. ëŒ€ì‹  ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œë¼ë„¤.
          </div>
          `,
          "images/npc/blacksmith_fail.png"
        );
      } else {
        if (sword <= 10) {
          // ì €ë ˆë²¨ ì‹¤íŒ¨ â†’ ê·¸ëƒ¥ ìœ ì§€
          showNpcMessage(
            `
            <div style="font-size:18px; font-weight:bold; color:#FF5555;">
              ê°•í™”ì‹¤íŒ¨!
            </div>
            <div style="margin-top:6px;">
              í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
            </div>
            `,
            "images/npc/blacksmith_fail.png"
          );
} else if (sword <= 20) {
  // 11~20êµ¬ê°„ : ì ˆë°˜ì€ ìœ ì§€, ì ˆë°˜ì€ ê°•ë“±
  if (Math.random() < 0.5) {
    // ì‹¤íŒ¨ (ìœ ì§€)
    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF5555;">
        ê°•í™”ì‹¤íŒ¨!
      </div>
      <div style="margin-top:6px;">
        í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else {
    // ê°•ë“± or ê°•ë“±ë°©ì§€ ë°œë™
    if (useDownProt) {
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FFA500;">
          ê°•ë“± ë°©ì§€!
        </div>
        <div style="margin-top:6px;">
          ì•„ìŠ¬ì•„ìŠ¬í–ˆë„¤â€¦ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œê°€ ë‹¨ê³„ë¥¼ ì§€ì¼œì¤¬ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      sword--;
      rollPowerForCurrentSword();
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FFA500;">
          ê°•ë“± ë°œìƒ!
        </div>
        <div style="margin-top:6px;">
          ì—êµ¬, í•œ ë‹¨ê³„ ë‚´ë ¤ê°€ ë²„ë ¸ë„¤â€¦
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    }
  }
} else {
  // 21ê°• ì´ìƒ
  if (Math.random() < 0.4) {
    // ê°•ë“± or ê°•ë“±ë°©ì§€ ë°œë™
    if (useDownProt) {
              showNpcMessage(
                `
                <div style="font-size:18px; font-weight:bold; color:#FFA500;">
                  ê°•ë“± ë°©ì§€!
                </div>
                <div style="margin-top:6px;">
                  ë°©ê¸ˆ ê±´ ì •ë§ ìœ„í—˜í–ˆë„¤â€¦ ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œë¼ë„¤.
                </div>
                `,
                "images/npc/blacksmith_fail.png"
              );
            } else {
              sword--;
              rollPowerForCurrentSword();
              showNpcMessage(
                `
                <div style="font-size:18px; font-weight:bold; color:#FFA500;">
                  ê°•ë“± ë°œìƒ!
                </div>
                <div style="margin-top:6px;">
                  ì—êµ¬, í•œ ë‹¨ê³„ ë‚´ë ¤ê°€ ë²„ë ¸ë„¤â€¦
                </div>
                `,
                "images/npc/blacksmith_fail.png"
              );
            }
          } else {
            // íŒŒê´´ (ê°•ë“±ë°©ì§€ëŠ” íŒŒê´´ì—” íš¨ê³¼ ì—†ìŒ)
            sword = 0;
            rollPowerForCurrentSword();

            destroyCount++;  // ğŸ§¨ ëˆ„ì  íŒŒê´´ íšŸìˆ˜ ì¦ê°€

            writeLog(
              `${userId}ì´ ${coloredLevel(before + 1)} ë„ì „ì— ì‹¤íŒ¨í•˜ì—¬ ` +
              `<span style="color:red;font-weight:bold;">íŒŒê´´</span> ë˜ì—ˆìŠµë‹ˆë‹¤!`,
              true
            );
            showNpcMessage(
              `
              <div style="font-size:18px; font-weight:bold; color:#FF3333;">
                ì¥ë¹„ íŒŒê´´!
              </div>
              <div style="margin-top:6px;">
                ë§™ì†Œì‚¬â€¦ ì‚°ì‚°ì´ ë¶€ì„œì ¸ ë²„ë ¸êµ°â€¦
              </div>
              `,
              "images/npc/blacksmith_destroy.png"
            );
          }
        }
      }
    }
  }

// UI ê°±ì‹  + ì €ì¥ + í”Œë˜ê·¸ í•´ì œ
update();
save();

isUpgrading = false;

const actionButtons = document.querySelectorAll(".action-buttons button");
actionButtons.forEach(btn => btn.disabled = false);

  }, delayMs);
}

// ğŸ›’ ì‹¤ì œ íŒë§¤ ì²˜ë¦¬ + "íŒë§¤ ì™„ë£Œ" ë©˜íŠ¸
function completeSell(beforeLevel, rewardGold) {
  setNpcName("ë¬´ê¸°ìƒì¸ â€“ ë°”ë¥´í†¨ ë¡œë„¨");

  // íŒë§¤ ì²˜ë¦¬
  gold += rewardGold;
  sword = 0;
  rollPowerForCurrentSword();

  // 20ê°• ì´ìƒ ì „ìš© ì™„ë£Œ ë©˜íŠ¸
  if (beforeLevel >= 20) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        â€¦ì•Œì•˜ë‹¤.
      </div>
      <div style="margin-top:4px;">
        ì´ ê²€ì€ ë‚´ê°€ ì±…ì„ì§€ê³  ë³´ê´€í•˜ì§€.<br>
        ê·¸ëŒ€ì˜ ì„ íƒì— ê°’í•˜ì—¬
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ë¥¼ ì§€ê¸‰í•˜ê² ë„¤.
      </div>
      `,
      "images/npc/merchant_bartol.png"
    );
  } else {
    // ì¼ë°˜ ì¥ë¹„ íŒë§¤ ì™„ë£Œ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ê±°ë˜ ì„±ì‚¬ëêµ°.
      </div>
      <div style="margin-top:4px;">
        ì¢‹ì€ ì„ íƒì´ì—ˆë„¤, ëª¨í—˜ê°€.<br>
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ë¥¼ ì§€ê¸‰í–ˆë„¤.
      </div>
      `,
      "images/npc/merchant_bartol.png"
    );
  }

  update();
  save();
}

  // ğŸ›’ ë°”ë¥´í†¨ ë¡œë„¨ íŒë§¤ í™•ì¸ íŒì—… (20ê°• ì´ìƒ í¬ê·€ ë©˜íŠ¸ í¬í•¨)
function showMerchantSellPopup(beforeLevel, rewardGold) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ†• ì´ë¦„ ì„¤ì •
  setNpcName("ë¬´ê¸°ìƒì¸ â€“ ë°”ë¥´í†¨ ë¡œë„¨");
  // ìƒì¸ ì´ë¯¸ì§€ë¡œ êµì²´
  imgEl.src = "images/npc/merchant_bartol.png";

  let innerHtml = "";

  if (beforeLevel >= 20) {
    // ğŸ§¿ 20ê°• ì´ìƒ â€” í¬ê·€ í‰ê°€ ë©˜íŠ¸ ëœë¤
    const rareLines = [
      "ì´ ê²€â€¦ ìˆ˜ë§ì€ ì „ì¥ì„ ì§€ë‚˜ì˜¨ í”ì ì´ ë³´ì´ëŠ”êµ°.",
      "ì´ ë¬´ê¸°â€¦ ì£¼ì¸ì„ ì˜ ë§Œë‚¬ë˜ ê²€ì´ì•¼.",
      "ì „ì„¤ê¸‰ì´ë¼ ë¶€ë¥¼ ë§Œí•˜êµ°. ì‰½ê²Œ ë³¼ ë¬¼ê±´ì´ ì•„ë‹ˆì•¼."
    ];
    const flavor =
      rareLines[Math.floor(Math.random() * rareLines.length)];

    innerHtml = `
      <div style="font-size:16px; margin-bottom:6px;">
        ${flavor}
      </div>
      <div>
        ê°€ì¹˜ë¥¼ ì¡´ì¤‘í•´
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ì— ë§¤ì…í•˜ì§€.<br>
        ì •ë§ ë– ë‚˜ë³´ë‚´ê² ë‚˜?
      </div>
    `;
  } else {
    // ğŸŸ¡ ì¼ë°˜ ì¥ë¹„ ë©˜íŠ¸
    innerHtml = `
      <div style="font-size:16px; margin-bottom:6px;">
        í â€¦ ì¢‹ì€ ì¥ë¹„ë¥¼ ê°–ê³  ìˆêµ° ê·¸ë˜.
      </div>
      <div>
        ë‚´ ëˆˆìœ¼ë¡œ ë³´ê±´ëŒ€
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ì— ë§¤ì…í•´ ì£¼ê² ë„¤.<br>
        ì •ë§ íŒë§¤í•˜ê² ë‚˜?
      </div>
    `;
  }

  msgEl.innerHTML = innerHtml;

  // ë²„íŠ¼ ì„¤ì •
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "íŒë§¤í•œë‹¤";
  cancelBtn.textContent = "ê·¸ë§Œë‘”ë‹¤";

  // ê¸°ì¡´ onclick ì œê±° í›„ ìƒˆë¡œ ë“±ë¡
  okBtn.onclick = function () {
    popup.style.display = "none";
    // íŒë§¤ í™•ì •
    completeSell(beforeLevel, rewardGold);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
    // ì·¨ì†Œ ì‹œ ì´ë¯¸ì§€ ì›ë³µ (ëŒ€ì¥ì¥ì´ ê¸°ë³¸ìœ¼ë¡œ)
    imgEl.src = "images/npc/blacksmith_idle.png";
  };

  popup.style.display = "flex";
}
  
function sell() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (sword <= 0) {
    alert("íŒë§¤í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const before = sword;
  const reward = getSellReward(before);

  // ğŸ” ë°”ë¡œ íŒë§¤í•˜ì§€ ì•Šê³ , ë°”ë¥´í†¨ íŒë§¤ í™•ì¸ íŒì—… í˜¸ì¶œ
  showMerchantSellPopup(before, reward);
}

/* ì‚¬ëƒ¥ */
function hunt(){
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  // ì‚¬ëƒ¥ ì „ ìŠ¤íƒœë¯¸ë‚˜ ìµœì‹ í™”
  recalcHuntStamina();

  // ìŠ¤íƒœë¯¸ë‚˜ê°€ 0ì´ë©´ ì‚¬ëƒ¥ ë¶ˆê°€
  if (huntStamina <= 0) {
    showHuntPopup(
      `
      <div style="font-size:18px; font-weight:bold;">
        ì‚¬ëƒ¥ ë¶ˆê°€
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
        ì‹œê°„ì´ ì§€ë‚˜ë©´ ë‹¤ì‹œ íšŒë³µë©ë‹ˆë‹¤.
      </div>
      `,
      "#CCCCCC"
    );
    return;
  }

  const field = HUNT_FIELDS[currentField];
  if (!field) {
    alert("ì‚¬ëƒ¥í„°ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const successChance = getHuntSuccessChance(sword, currentField);

  if (successChance <= 0) {
    alert("ì´ ì‚¬ëƒ¥í„°ëŠ” ì§€ê¸ˆ ì¥ë¹„ë¡œëŠ” ë„ˆë¬´ ìœ„í—˜í•©ë‹ˆë‹¤! (ì„±ê³µë¥  0%)");
    return;
  }

// ì‹¤ì œ ê³µê²©ë ¥ì€ ë¯¸ë¦¬ êµ´ë ¤ë‘” power ì‚¬ìš© (Â±5% í¸ì°¨ ë°˜ì˜ëœ ê°’)
const atk = power; // ì§€ê¸ˆì€ ì‚¬ìš© X, ë‚˜ì¤‘ì— ì‚¬ëƒ¥ ë°ë¯¸ì§€/ì„±ê³µë¥ ì— ë°˜ì˜ ê°€ëŠ¥


// ì„±ê³µ ì—¬ë¶€
const r = Math.random() * 100;
if (r < successChance) {
  // âœ… ì„±ê³µ
  const reward = getHuntReward(currentField);
  gold += reward;

  // ğŸ”” ê¸°ë³¸ íŒì—… ë¬¸êµ¬ (ê³¨ë“œ ë³´ìƒ)
  let popupMsg = `ì‚¬ëƒ¥ ì„±ê³µ!<br>ğŸ’° ${formatGold(reward)} ê³¨ë“œ íšë“`;

  // ğŸ ì•„ì´í…œ ë“œë ì²˜ë¦¬

  // LV6 ì´ìƒ: 3% í™•ë¥ ë¡œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
  if (currentField >= 6 && Math.random() < 0.015) {
    itemScroll15 += 1;

    popupMsg += `<br><br>ğŸ“œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV7 ì´ìƒ: 2% í™•ë¥ ë¡œ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
  if (currentField >= 7 && Math.random() < 0.01) {
    itemProtect += 1;

    popupMsg += `<br>ğŸ›¡ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV8 ì´ìƒ: 1% í™•ë¥ ë¡œ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
  if (currentField >= 8 && Math.random() < 0.005) {
    itemSuper += 1;

    popupMsg += `<br>âœ¨ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV4 ì´ìƒ: 10% í™•ë¥ ë¡œ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ
  if (currentField >= 4 && Math.random() < 0.05) {
    itemDownProtect += 1;

    popupMsg += `<br>ğŸ”’ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // âœ… ìµœì¢… íŒì—… í•œ ë²ˆë§Œ í˜¸ì¶œ (ê³¨ë“œ + ë“œë ê²°ê³¼ ëª¨ë‘ í¬í•¨)
  showHuntPopup(popupMsg, "#6CF");

} else {
  // âŒ ì‹¤íŒ¨
  showHuntPopup(
    "ì‚¬ëƒ¥ ì‹¤íŒ¨...<br>ë‹¤ìŒ ê¸°íšŒë¥¼ ë…¸ë¦¬ì.",
    "#FF6666"
  );
}

  // âœ… ì‚¬ëƒ¥ 1íšŒë‹¹ ìŠ¤íƒœë¯¸ë‚˜ 1 ê°ì†Œ
  const beforeStamina = huntStamina;
  huntStamina = Math.max(0, huntStamina - 1);
  // ì°¸ê³ ìš© ì¹´ìš´íŠ¸ (ì˜¤ëŠ˜ ì‚¬ìš©í•œ íšŸìˆ˜)
  huntCountToday = Math.max(0, 20 - huntStamina);

  // ğŸ” 20/20 â†’ 19/20ìœ¼ë¡œ ì²˜ìŒ ì¤„ì–´ë“œëŠ” ìˆœê°„ë¶€í„° 20ë¶„ ì¹´ìš´íŠ¸ ì‹œì‘
  if (beforeStamina === 20 && huntStamina === 19) {
    lastStaminaUpdate = Date.now();
  }

  update();
  save();
}

// ğŸ¯ ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥  ê³„ì‚°
function getHuntSuccessChance(myLevel, fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;

  const rec = field.recLevel; // ì¶”ì²œ ê°•í™” ë ˆë²¨
  const diff = rec - myLevel;

  if (diff <= 0) return 100;     // ê¶Œì¥ ë ˆë²¨ ì´ìƒì´ë©´ 100%
  if (diff >= 5) return 0;       // ë„ˆë¬´ ì°¨ì´ë‚˜ë©´ 0%

  // 1~4 ì°¨ì´: 80 / 60 / 40 / 20 %
  return 100 - diff * 20;
}

  // ğŸ’° ì‚¬ëƒ¥ ì„±ê³µ ì‹œ ê³¨ë“œ ë³´ìƒ
function getHuntReward(fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;
  
  // ğŸŒ± LV1 ì‚¬ëƒ¥í„°ëŠ” 0~20ê³¨ë“œ ëœë¤
  if (fieldId === 1) {
    return Math.floor(randRange(0, 21)); // 0 ì´ìƒ 21 ë¯¸ë§Œ â†’ 0~20
  }
  // ì„¤ëª…ì— ë”°ë¼: ì˜ˆ) 3LV â†’ 6ê°• ê°•í™”ë¹„ìš© ì‚¬ìš©
  const refLevel = field.recLevel;    // 0,3,6,...,27
  const baseCost = getUpgradeCost(refLevel); // í•´ë‹¹ ê°•ì˜ ê°•í™”ë¹„ìš©

  const mul = randRange(1.0, 1.5);   // 1.0 ~ 1.5 ë°°
  return Math.floor(baseCost * mul * 0.4);
}

function login() {
  // 1ï¸âƒ£ DOMì—ì„œ ì§ì ‘ ì…ë ¥ì°½ ê°€ì ¸ì˜¤ê¸°
  const idInput = document.getElementById("loginId");
  const pwInput = document.getElementById("loginPw");

  if (!idInput || !pwInput) {
    alert("ë¡œê·¸ì¸ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // 2ï¸âƒ£ ê°’ ì½ê¸°
  userId = idInput.value.trim();
  userPassword = pwInput.value;

  if (!userId || !userPassword) {
    alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // 3ï¸âƒ£ Firebase ref ì„¸íŒ…
  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {

    // â­ ì‹ ê·œ ê³„ì • ìƒì„± ì‹œ
    if (!s.exists()) {

      // ì²˜ìŒ ê³„ì • ìƒì„± ì‹œ, í˜„ì¬ sword ê¸°ì¤€ìœ¼ë¡œ ê³µê²©ë ¥ í•œ ë²ˆ êµ´ë ¤ë‘ê¸°
      rollPowerForCurrentSword();

      userRef.set({
        password: userPassword,
        sword,
        power,
        gold,
        updated: Date.now(),
        maxSwordLevel: 0,   
        destroyCount: 0,    
        attendanceCount: 0,
        lastAttendanceDate: "",
        attendanceStreak: 0,      
        lastAttendanceDay: "",    
        currentField: 1,
        huntCountToday: 0,
        lastHuntDate: "",
        itemScroll15: Number(itemScroll15),
        itemProtect: Number(itemProtect),
        itemSuper: Number(itemSuper),
        itemDownProtect: Number(itemDownProtect),
        huntStamina: 20,
        lastStaminaUpdate: Date.now(),
        // âš”ï¸ ê²°íˆ¬ ì´ˆê¸°ê°’
        duelWin: 0,
        duelLose: 0,
        duelCountToday: 0,
        lastDuelDate: "",
        duelTargetsToday: {}
      });

    } else {
      // â­ ê¸°ì¡´ ê³„ì • ë¡œê·¸ì¸ ì‹œ
      const data = s.val();

      if (data.password !== userPassword) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      sword = data.sword ?? 0;
      gold  = data.gold  ?? 100;

      // ìµœê³  ê°•í™” / íŒŒê´´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      maxSwordLevel = data.maxSwordLevel ?? sword; // ì—†ìœ¼ë©´ í˜„ì¬ ê°•í™”ë¡œ ì´ˆê¸°í™”
      destroyCount  = data.destroyCount  ?? 0;
      
      // ğŸŸ¢ ì „íˆ¬ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ê±°ë‚˜ êµ¬ë²„ì „ì´ë©´ ì¬ê³„ì‚°)
      power = Number(data.power ?? 0);
      if (!power || power <= 20) {
        rollPowerForCurrentSword();
      }

      attendanceCount    = data.attendanceCount    ?? 0;
      lastAttendanceDate = data.lastAttendanceDate ?? "";
      attendanceStreak   = data.attendanceStreak   ?? 0;  
lastAttendanceDay  = data.lastAttendanceDay  ?? "";
      currentField       = data.currentField       ?? 1;
      huntCountToday     = data.huntCountToday     ?? 0;
      lastHuntDate       = data.lastHuntDate       ?? "";
      itemScroll15       = data.itemScroll15 ?? 0;
      itemProtect        = data.itemProtect  ?? 0;
      itemSuper          = data.itemSuper    ?? 0;
      itemDownProtect    = data.itemDownProtect ?? 0;
      huntStamina        = data.huntStamina       ?? 20;
      lastStaminaUpdate  = data.lastStaminaUpdate ?? Date.now();

      // âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ê°’
      duelWin        = data.duelWin        ?? 0;
      duelLose       = data.duelLose       ?? 0;
      duelCountToday = data.duelCountToday ?? 0;
      lastDuelDate   = data.lastDuelDate   ?? "";
      duelTargetsToday = data.duelTargetsToday ?? {};
    }
    // í™”ë©´ ì „í™˜
    const loginScreen = document.getElementById("loginScreen");
    const gameScreen  = document.getElementById("gameScreen");
    loginScreen.style.display  = "none";
    gameScreen.style.display   = "block";

    document.getElementById("attendanceBtn").style.display = "block";
    document.getElementById("inventoryBtn").style.display = "block";
    document.getElementById("logToggle").style.display = "block";
    document.getElementById("logoutBtn").style.display = "block";
    document.getElementById("duelBtn").style.display = "block";
    document.getElementById("mapBtn").style.display = "block";

    // ğŸ” ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ìœ ì € ì €ì¥
    try {
      localStorage.setItem("swordGameLastUser", userId);
    } catch (e) {
      console.warn("localStorage set ì‹¤íŒ¨", e);
    }

    // ğŸ† ë¡œê·¸ì¸ ì§í›„ ë­í‚¹/ë‚´ ë­í‚¹ ê°±ì‹ 
    loadRanking();   // ğŸ‘ˆ ì´ ì¤„ ì¶”ê°€!

    update();
    showTutorialIfFirstTime();
    save(); // ì‹ ê·œ ìƒì„± ì§í›„ ê°’ ì €ì¥
  });
}



function save() {
  if (!userRef) return;
  userRef.update({
    sword: Number(sword),
    power: Number(power),
    gold: Number(gold),
    updated: Date.now(),
    maxSwordLevel: Number(maxSwordLevel),
    destroyCount: Number(destroyCount),
    attendanceCount: attendanceCount,
    lastAttendanceDate: lastAttendanceDate,
        attendanceStreak: Number(attendanceStreak),
    lastAttendanceDay: lastAttendanceDay, 
    currentField: currentField,
    huntCountToday: huntCountToday,
    lastHuntDate: lastHuntDate,
    itemScroll15: Number(itemScroll15),
    itemProtect: Number(itemProtect),
    itemSuper: Number(itemSuper),
    itemDownProtect: Number(itemDownProtect),
    huntStamina: Number(huntStamina),
    lastStaminaUpdate: Number(lastStaminaUpdate),
    // âš”ï¸ ê²°íˆ¬ ì •ë³´
    duelWin: Number(duelWin),
    duelLose: Number(duelLose),
    duelCountToday: Number(duelCountToday),
    lastDuelDate: lastDuelDate,
    duelTargetsToday: duelTargetsToday
  });
}

/* ìƒ‰ìƒ */
function getSwordColor(l){
  if (l >= 30) return "rainbow";
  if (l === 29) return "sparkle-gold";
  if (l === 28) return "sparkle-silver";

  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) return colorMap[l] || "white";
  if (l >= 11) return "lime";
  return "white";
}

function coloredLevel(l){
  // ğŸŒˆ 30ê°•
  if (l >= 30) {
    return `<span class="rainbow">+${l}ê°•</span>`;
  }

  // âœ¨ 29 / 28 ë°˜ì§
  if (l === 29) {
    return `<span class="sparkle-gold">+${l}ê°•</span>`;
  }
  if (l === 28) {
    return `<span class="sparkle-silver">+${l}ê°•</span>`;
  }

  // ğŸ¨ 21~27 ê°œë³„ ìƒ‰ìƒ
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) {
    return `<span style="color:${colorMap[l]};font-weight:bold;">+${l}ê°•</span>`;
  }

  // ğŸ‘‰ 11~20ì€ ìƒ‰ ì—†ìŒ (ê¸°ë³¸ í°ìƒ‰)
  return `+${l}ê°•`;
}

  // âš”ï¸ ê°•í™” ë‹¨ê³„ë³„ ì»¬ëŸ¬ ì´ë¦„ (ë­í‚¹ í‘œì‹œìš©)
function getSwordColorName(level) {
  const colorNameMap = {
    21: "ë¹¨ê°•",
    22: "ë…¸ë‘",
    23: "ì´ˆë¡",
    24: "íŒŒë‘",
    25: "ë³´ë¼",
    26: "ê°ˆìƒ‰",
    27: "í•‘í¬",
    28: "ì‹¤ë²„",
    29: "ê³¨ë“œ",
    30: "ë¬´ì§€ê°œ"
  };
  return colorNameMap[level] || "";
}

// âš”ï¸ ê²€ ì´ë¦„ì— ìƒ‰ ì…íˆê¸° (ë­í‚¹ìš©)
function coloredWeaponName(level, baseName) {
  // 20ê°• ì´í•˜ëŠ” ìƒ‰ ì•ˆ ë„£ê³  ê·¸ëƒ¥ ì´ë¦„ë§Œ
  if (level <= 20) return baseName;

  // 30, 29, 28ê°•ì€ ì´ë¯¸ ë§Œë“  í´ë˜ìŠ¤ í™œìš©
  if (level >= 30) {
    return `<span class="rainbow">${baseName}</span>`;
  }
  if (level === 29) {
    return `<span class="sparkle-gold">${baseName}</span>`;
  }
  if (level === 28) {
    return `<span class="sparkle-silver">${baseName}</span>`;
  }

  // 21~27ê°•ì€ coloredLevelì—ì„œ ì“°ëŠ” ìƒ‰ì´ë‘ ë§ì¶”ê¸°
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  const cssColor = colorMap[level] || "#ffffff";
  return `<span style="color:${cssColor};font-weight:bold;">${baseName}</span>`;
}


// ğŸ—º MAP í† ê¸€
function toggleMap() {
  const panel = document.getElementById("mapPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderMap();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

// ğŸ—º MAP ë‚´ìš© ë Œë”ë§
function renderMap() {
  const listEl = document.getElementById("mapList");
  if (!listEl) return;

  listEl.innerHTML = "";

  for (let i = 1; i <= 10; i++) {
    const field = HUNT_FIELDS[i];
    const success = getHuntSuccessChance(sword, i);

    const div = document.createElement("div");
    div.className = "map-field";
    div.innerHTML = `
      <b>LV${i} - ${field.name}</b><br>
      ì¶”ì²œ: +${field.recLevel}ê°• / í˜„ì¬ ì˜ˆìƒ ì„±ê³µë¥ : ${success}%
    `;
    div.onclick = function() {

      // ì´ë¯¸ ì´ë™ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (isMoving) return;

      isMoving = true;

      // "ì‚¬ëƒ¥í„° ì´ë™ ì¤‘..." íŒì—… í‘œì‹œ
      showMovePopup();

      const delay = 1000 + Math.random() * 1000; // 1~2ì´ˆ ëœë¤

      setTimeout(() => {
        // ì‹¤ì œ ì‚¬ëƒ¥í„° ë³€ê²½
        currentField = i;

        applyFieldBackground();
        
        // UI ê°±ì‹  + ì €ì¥
        update();
        save();

        // ë§µ íŒ¨ë„ ë‹«ê¸° + ì´ë™ íŒì—… ë‹«ê¸°
        toggleMap();
        closeMovePopup();

        isMoving = false;
      }, delay);
    };


    // í˜„ì¬ ì„ íƒ ì‚¬ëƒ¥í„° í‘œì‹œ
    if (i === currentField) {
      div.style.borderLeft = "3px solid #6cf";
    }

    listEl.appendChild(div);
  }
}

// ğŸ§± íŒ¨ë„ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (MAP / ì¸ë²¤í† ë¦¬ / ë¡œê·¸ ê³µí†µ)
function closeIfClickOutside(event, panelId, buttonId) {
  const panel = document.getElementById(panelId);
  const btn   = document.getElementById(buttonId);
  if (!panel) return;

  // ì•ˆ ì—´ë ¤ ìˆìœ¼ë©´ ë¬´ì‹œ
  if (panel.style.display === "none" || panel.style.display === "") return;

  const target = event.target;

  // íŒ¨ë„ ì•ˆì„ í´ë¦­í•œ ê²½ìš° â†’ ìœ ì§€
  if (panel.contains(target)) return;

  // í•´ë‹¹ íŒ¨ë„ì˜ í† ê¸€ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° â†’ í† ê¸€ ë¡œì§ì— ë§¡ê¹€
  if (btn && btn.contains(target)) return;

  // ê·¸ ì™¸ ì˜ì—­ í´ë¦­ ì‹œ íŒ¨ë„ ë‹«ê¸°
  panel.style.display = "none";
}

// ğŸ“Œ ì „ì—­ í´ë¦­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener("mousedown", function (e) {
  closeIfClickOutside(e, "mapPanel", "mapBtn");             // MAP
  closeIfClickOutside(e, "inventoryPanel", "inventoryBtn"); // ì¸ë²¤í† ë¦¬
  closeIfClickOutside(e, "logPanel", "logToggle");          // ë¡œê·¸
  closeIfClickOutside(e, "duelPanel", "duelBtn");           // ê²°íˆ¬
});


// ğŸ§· ìƒˆë¡œê³ ì¹¨ ì‹œ ìë™ ë¡œê·¸ì¸
function autoLoginFromStorage() {
  let savedId = null;
  try {
    savedId = localStorage.getItem("swordGameLastUser");
  } catch (e) {
    console.warn("localStorage get ì‹¤íŒ¨", e);
  }

  if (!savedId) return;  // ì €ì¥ëœ ìœ ì € ì—†ìœ¼ë©´ íŒ¨ìŠ¤

  userId = savedId;
  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {
    if (!s.exists()) {
      // í˜¹ì‹œ DBì—ì„œ ì‚¬ë¼ì§„ ê³„ì •ì´ë©´ ê¸°ë¡ë„ ì§€ì›€
      try { localStorage.removeItem("swordGameLastUser"); } catch (e) {}
      return;
    }

    const data = s.val();

    sword = data.sword ?? 0;
    gold  = data.gold  ?? 100;

        // ìµœê³  ê°•í™” / íŒŒê´´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    maxSwordLevel = data.maxSwordLevel ?? sword;
    destroyCount  = data.destroyCount  ?? 0;

    // ğŸŸ¢ ìë™ë¡œê·¸ì¸ ì‹œ ì „íˆ¬ë ¥ ë³´ì • í¬í•¨
power = Number(data.power ?? 0);

if (!power || power <= 20) {
  rollPowerForCurrentSword();
}

    attendanceCount    = data.attendanceCount    ?? 0;
    lastAttendanceDate = data.lastAttendanceDate ?? "";
    attendanceStreak   = data.attendanceStreak   ?? 0;   
lastAttendanceDay  = data.lastAttendanceDay  ?? "";  
    currentField       = data.currentField       ?? 1;
    huntCountToday     = data.huntCountToday     ?? 0;
    lastHuntDate       = data.lastHuntDate       ?? "";
    itemScroll15       = data.itemScroll15 ?? 0;
    itemProtect        = data.itemProtect  ?? 0;
    itemSuper          = data.itemSuper    ?? 0;
    itemDownProtect    = data.itemDownProtect ?? 0;
    huntStamina       = data.huntStamina       ?? 20;
    lastStaminaUpdate = data.lastStaminaUpdate ?? Date.now();
        // âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
    duelWin        = data.duelWin        ?? 0;
    duelLose       = data.duelLose       ?? 0;
    duelCountToday = data.duelCountToday ?? 0;
    lastDuelDate   = data.lastDuelDate   ?? "";
duelTargetsToday = data.duelTargetsToday ?? {};

// í™”ë©´ ì „í™˜
const loginScreen = document.getElementById("loginScreen");
const gameScreen  = document.getElementById("gameScreen");

loginScreen.style.display  = "none";
gameScreen.style.display   = "block";
document.getElementById("attendanceBtn").style.display = "block";
document.getElementById("inventoryBtn").style.display = "block";
document.getElementById("logToggle").style.display = "block";
document.getElementById("logoutBtn").style.display = "block";
document.getElementById("duelBtn").style.display = "block";
document.getElementById("mapBtn").style.display = "block";

    update();
    showTutorialIfFirstTime();
  });
}

// ğŸ§¾ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ì—´ê¸°
function openOtherUserProfilePopup(targetId) {
  const overlay        = document.getElementById("otherProfileOverlay");
  if (!overlay) return;

  const nickEl         = document.getElementById("otherProfileNickname");
  const weaponTitleEl  = document.getElementById("otherProfileWeaponTitle");
  const weaponDescEl   = document.getElementById("otherProfileWeaponDesc");
  const maxInfoEl      = document.getElementById("otherProfileMaxInfo");
  const powerEl        = document.getElementById("otherProfilePower");
  const goldEl         = document.getElementById("otherProfileGold");
  const weaponValueEl  = document.getElementById("otherProfileWeaponValue");
  const recordEl       = document.getElementById("otherProfileRecord");
  const imgEl          = document.getElementById("otherWeaponImage");

  // ê¸°ë³¸ ì´ˆê¸°í™”
  if (nickEl)        nickEl.textContent        = targetId;
  if (weaponTitleEl) weaponTitleEl.textContent = "-";
  if (weaponDescEl)  weaponDescEl.textContent  = "-";
  if (maxInfoEl)     maxInfoEl.textContent     = "-";
  if (powerEl)       powerEl.textContent       = "0";
  if (goldEl)        goldEl.textContent        = "0";
  if (weaponValueEl) weaponValueEl.textContent = "0";
  if (recordEl)      recordEl.textContent      = "ìŠ¹ 0 / íŒ¨ 0";
  if (imgEl)         imgEl.src                 = "images/weapons/sword_real_temp.png";

  // DBì—ì„œ í•´ë‹¹ ìœ ì € ì •ë³´ ì½ê¸°
  db.ref("users/" + targetId).once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const d = snap.val() || {};

    const swordLevel = Number(d.sword || 0);
    const maxSword   = Number(d.maxSwordLevel ?? swordLevel);
    const destroyCnt = Number(d.destroyCount || 0);
    const powerVal   = Number(d.power || 0);
    const goldVal    = Number(d.gold || 0);
    const duelW      = Number(d.duelWin || 0);
    const duelL      = Number(d.duelLose || 0);

    const wInfo = getWeaponInfo(swordLevel);

    if (weaponTitleEl && wInfo) {
      weaponTitleEl.textContent = `${wInfo.name} (+${swordLevel}ê°•)`;
    }
    if (weaponDescEl && wInfo) {
      weaponDescEl.textContent = wInfo.desc;
    }
    if (maxInfoEl) {
      maxInfoEl.innerHTML =
        `+${maxSword}ê°• ` +
        `<span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ ${destroyCnt}íšŒ)</span>`;
    }
    if (powerEl) {
      powerEl.textContent = formatGold(powerVal);
    }
    if (goldEl) {
      goldEl.textContent  = formatGold(goldVal);
    }
    if (weaponValueEl) {
      const avgValue = getSellRewardAverage(swordLevel);
      weaponValueEl.textContent = formatGold(avgValue);
    }
    if (recordEl) {
      recordEl.textContent = `ìŠ¹ ${duelW} / íŒ¨ ${duelL}`;
    }
    if (imgEl && wInfo && wInfo.img) {
      imgEl.src = wInfo.img;
    }

    overlay.style.display = "flex";
  }).catch(err => {
    console.error("í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    alert("í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  });
}
// ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ë‹«ê¸° (í†µí•©)
function closeOtherUserProfilePopup() {
  const overlay = document.getElementById("otherProfileOverlay");
  if (overlay) {
    overlay.style.display = "none";
  }
}

// ğŸ‘‰ íŒì—… ê´€ë ¨ ì´ë²¤íŠ¸ í•œ ë²ˆì— ì´ˆê¸°í™” (DOM ë‹¤ ë§Œë“¤ì–´ì§„ ë’¤ì— ì—°ê²°)
document.addEventListener("DOMContentLoaded", function initOtherProfilePopupEvents() {
  const overlay  = document.getElementById("otherProfileOverlay");
  const closeBtn = document.getElementById("otherProfileCloseBtn");

  // X ë²„íŠ¼ í´ë¦­ â†’ ë‹«ê¸°
  if (closeBtn) {
    closeBtn.addEventListener("click", function (e) {
      e.stopPropagation();
      closeOtherUserProfilePopup();
    });
  }

  // ì–´ë‘ìš´ ë°°ê²½ í´ë¦­ â†’ ë‹«ê¸°
  if (overlay) {
    overlay.addEventListener("click", function (e) {
      // ì¹´ë“œ ë°”ê¹¥ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ë‹«ê¸°
      if (!e.target.closest(".other-profile-card")) {
        closeOtherUserProfilePopup();
      }
    });
  }

  // ESC í‚¤ â†’ ë‹«ê¸°
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      closeOtherUserProfilePopup();
    }
  });
});

  // ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ â†’ "í”„ë¡œí•„ ë³´ê¸°" ë©”ë‰´ â†’ í”„ë¡œí•„ íŒì—…
let lastRankProfileUserId = null;

(function initRankingProfileMenu() {
  const rankingEl = document.getElementById("ranking");
  const menuEl    = document.getElementById("rankProfileMenu");
  const viewBtn   = document.getElementById("rankProfileViewBtn");
  const overlay   = document.getElementById("otherProfileOverlay");
  const closeBtn  = document.getElementById("otherProfileCloseBtn");

  // 1) ë­í‚¹ ì˜ì—­ì—ì„œ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ì‘ì€ ë©”ë‰´ë¥¼ "í„°ì¹˜í•œ ìë¦¬"ì— í‘œì‹œ
  if (rankingEl && menuEl) {
    rankingEl.addEventListener("click", function(e) {
      const userSpan = e.target.closest(".rank-user");
      if (!userSpan) return;

      const uid = userSpan.dataset.userId;
      if (!uid) return;
      lastRankProfileUserId = uid;

      const x = e.pageX;
      const y = e.pageY;

      menuEl.style.left   = x + "px";
      menuEl.style.top    = y + "px";
      menuEl.style.display = "block";

      e.stopPropagation();
    });
  }

  // 2) "í”„ë¡œí•„ ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°
  if (viewBtn && menuEl) {
    viewBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      if (!lastRankProfileUserId) return;
      menuEl.style.display = "none";
      openOtherUserProfilePopup(lastRankProfileUserId);
    });
  }

  // 3) í™”ë©´ ë‹¤ë¥¸ ê³³ í´ë¦­í•˜ë©´ ì‘ì€ ë©”ë‰´ ë‹«ê¸°
  document.addEventListener("click", function(e) {
    if (!menuEl || menuEl.style.display !== "block") return;

    // ë©”ë‰´ ë‚´ë¶€ or ë‹‰ë„¤ì„ ë‹¤ì‹œ í´ë¦­ì´ë©´ ìœ ì§€
    if (e.target.closest("#rankProfileMenu")) return;
    if (e.target.closest(".rank-user")) return;

    menuEl.style.display = "none";
  });

  // 4) íŒì—… ë°”ê¹¥(ì–´ë‘ìš´ ë°°ê²½) í´ë¦­í•˜ë©´ ë‹«ê¸°
  if (overlay) {
    overlay.addEventListener("click", function(e) {
      if (e.target === overlay) {
        closeOtherUserProfilePopup();
      }
    });
  }

  // 5) ë‹«ê¸° ë²„íŠ¼
  if (closeBtn) {
    closeBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      closeOtherUserProfilePopup();
    });
  }
})();
  
/* ë­í‚¹ */
function loadRanking() {

  const usersRef = db.ref("users");

  // ğŸ” TOP 10 (once)
  usersRef
    .orderByChild("sword")
    .limitToLast(10)
    .on("value", s => {
      const rankingEl = document.getElementById("ranking");
      if (!rankingEl) return;

      const arr = [];
      s.forEach(child => {
        const d = child.val() || {};
        arr.push({
          id: child.key,
          sword: Number(d.sword || 0),
          updated: Number(d.updated || 0),
          duelWin: Number(d.duelWin || 0),
          duelLose: Number(d.duelLose || 0)
        });
      });

      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

rankingEl.innerHTML = arr.map((u, i) => {
  const wInfo = getWeaponInfo(u.sword);
  const weaponNameStyled = coloredWeaponName(u.sword, wInfo.name);
  const colorName = getSwordColorName(u.sword);
  const colorLabel = colorName ? ` (${colorName})` : "";

  return `
    <div class="ranking-row" style="font-weight:bold;">
      ${i+1}. <span class="rank-user" data-user-id="${u.id}">${u.id}</span>
      | ${weaponNameStyled} ${coloredLevel(u.sword)}${colorLabel}
      | ì „ì : ${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨
    </div>
  `;
}).join("");

    });

  // ğŸ‘‡ ë‚´ ë­í‚¹ + ê²°íˆ¬ ë§¤ì¹­ ìºì‹œ (on)
  usersRef
    .orderByChild("sword")
    .on("value", s => {
      const myRankEl = document.getElementById("myRank");
      if (!myRankEl) return;

      const arr = [];
      s.forEach(c => {
        const d = c.val() || {};
        arr.push({
          id: c.key,
          sword: Number(d.sword || 0),
          updated: Number(d.updated || 0),
          power: Number(d.power || 0)
        });
      });

      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

      // âš”ï¸ ê²°íˆ¬ìš© ìºì‹œ
      allUsersCache = arr.slice();

      if (!userId) {
        myRankEl.innerText = "";
        return;
      }

      const idx = arr.findIndex(u => u.id === userId);

      if (idx === -1) {
        myRankEl.innerText = "ë‚´ ë­í‚¹: ê¸°ë¡ ì—†ìŒ";
      } else {
        const myInfo = arr[idx];
        myRankEl.innerHTML = `
          ë‚´ ë­í‚¹: <b>${idx + 1}ìœ„</b>
          (${coloredLevel(myInfo.sword)}, ì „ì : ${duelWin}ìŠ¹ ${duelLose}íŒ¨)
        `;
      }
    });
}

  
// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ "YYYY-MM-DD" í˜•íƒœë¡œ ë°˜í™˜ (ì¶œì„ ì²´í¬ìš©)
function getTodayDateString() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

  function getYesterdayDateString() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function formatTime(ts) {
  const d = new Date(ts);

  const MM  = String(d.getMonth() + 1).padStart(2, "0"); // ì›”
  const DD  = String(d.getDate()).padStart(2, "0");      // ì¼
  const hh  = String(d.getHours()).padStart(2, "0");     // ì‹œ
  const mm  = String(d.getMinutes()).padStart(2, "0");   // ë¶„
  const ss  = String(d.getSeconds()).padStart(2, "0");   // ì´ˆ

  return `${MM}/${DD} ${hh}:${mm}:${ss}`;
}

// íŒŒê´´ ë¬µë… ëŒ“ê¸€ ëœë¤
function getRandomMournComment() {
  const lines = [
    "ì™€~! íƒœì´ˆë§ˆì„ì´ì•¼~!",
    "ì´ ë§›ì— ê°•í™”í•˜ì§€ ã…‹ã…‹",
    "ê¹¨ë—í•˜ë‹¤, 0ê°•â€¦",
    "ì € ê°•ì²  ëƒ„ìƒˆ ë§¡ì•„ë´â€¦ ìƒˆê±°ì•¼ ìƒˆê±°.",
    "ê°•í™”ëŠ” ì›ë˜ ì—¬ê¸°ì„œë¶€í„° ì‹œì‘ì´ì£ ?",
    "ì•„ë¦„ë‹¤ìš´ í­ë°œì´ì—ˆìŠµë‹ˆë‹¤.",
    "ë˜ ë§Œë‚˜ì, +0ê°• ì‹œì ˆâ€¦",
    "ì €ê²Œ ë°”ë¡œ í•˜ë“œ ë¦¬ì…‹ì´ë¼ëŠ” ê±°ì•¼.",
    "ìš©ê¸° ìˆëŠ” ìì˜ ê²°ë§ì´êµ°.",
    "ê´€ì§ ì—´ê³  ë‹¤ì‹œ ê³ ê³ ì”½~"
  ];
  const i = Math.floor(Math.random() * lines.length);
  return lines[i];
}

// íŠ¹ì • ë¡œê·¸ ë°‘ì— ëŒ“ê¸€ í•œ ì¤„ ì¶”ê°€ (ìƒë‹¨ ë¡œê·¸ + ì‹¤ì‹œê°„ í† ìŠ¤íŠ¸ ë‘˜ ë‹¤)
function appendMournCommentToLog(logId, commentData) {
  // 1) ìƒë‹¨ ë¡œê·¸ íŒ¨ë„
  const panelItem = document.getElementById("log-" + logId);
  if (panelItem) {
    const commentsBox = panelItem.querySelector(".log-comments");
    if (commentsBox) {
      const div = document.createElement("div");
      div.style.fontSize = "12px";
      div.style.color = "#ccc";
      div.innerHTML = `â†³ ${commentData.text} <span style="color:#888;">- ${commentData.userId}</span>`;
      commentsBox.appendChild(div);
    }
  }

  // 2) í•˜ë‹¨ ì‹¤ì‹œê°„ í† ìŠ¤íŠ¸
  const toastItem = document.getElementById("toast-" + logId);
  if (toastItem) {
    const toastBox = toastItem.querySelector(".toast-comments");
    if (toastBox) {
      const div = document.createElement("div");
      div.style.fontSize = "11px";
      div.style.color = "#bbb";
      div.innerHTML = `â†³ ${commentData.text} <span style="color:#888;">- ${commentData.userId}</span>`;
      toastBox.appendChild(div);
    }
  }
}


  // [ë¬µë…í•˜ê¸°] í´ë¦­ ì‹œ ì²˜ë¦¬ (ìœ ì €ë‹¹ 1íšŒ)
function handleMournClick(e) {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const logId = e.target.dataset.logId;
  if (!logId) return;

  const userMournRef = logRef.child(logId).child("mournedBy").child(userId);

  // ì´ë¯¸ ì´ ë¡œê·¸ì— ë¬µë…í–ˆëŠ”ì§€ ì²´í¬
  userMournRef.once("value").then(snap => {
    if (snap.exists()) {
      alert("ì´ë¯¸ ì´ íŒŒê´´ì— ë¬µë…í–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    // ì´ ìœ ì €ê°€ ì‚¬ìš©í–ˆë‹¤ê³  ê¸°ë¡
    userMournRef.set(true);

    const comment = {
      userId: userId,
      text: getRandomMournComment(),
      time: Date.now()
    };

    // DBì— ëŒ“ê¸€ ë‚¨ê¸°ê¸°
    const commentsRef = logRef.child(logId).child("comments");
    const newRef = commentsRef.push(comment);
  });
}

/* ë¡œê·¸ */
function writeLog(message,isDestroy=false){
  logRef.push({message,isDestroy,time:Date.now()});
}
logRef.limitToLast(50).on("child_added", s => {
  const d = s.val();
  const logId = s.key;          // ì´ ë¡œê·¸ì˜ ê³ ìœ  ID
  const ts = formatTime(d.time || Date.now());

  const toastListEl    = document.getElementById("toastList");
  const logPanelListEl = document.getElementById("logPanelList");
  if (!toastListEl || !logPanelListEl) return;

  /* ğŸ‘‡ í•˜ë‹¨ í† ìŠ¤íŠ¸(5ê°œ ì œí•œ) */
  const toastEl = document.createElement("div");
  toastEl.className = "toast-item" + (d.isDestroy ? " toast-destroy" : "");
  toastEl.id = "toast-" + logId;   // ğŸ”´ ëŒ“ê¸€ ì—°ê²°ìš© ID

  // ë©”ì¸ í•œ ì¤„
  const toastMain = document.createElement("div");
  toastMain.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;

  // íŒŒê´´ ë¡œê·¸ë¼ë©´ [ë¬µë…í•˜ê¸°] ë²„íŠ¼ ì¶”ê°€
  if (d.isDestroy) {
    const btn = document.createElement("span");
    btn.textContent = " [ë¬µë…í•˜ê¸°]";
    btn.style.cursor = "pointer";
    btn.style.color = "#ffffff";  // í°ìƒ‰ ê°•ì¡°
    btn.dataset.logId = logId;
    btn.onclick = handleMournClick;
    toastMain.appendChild(btn);
  }

  toastEl.appendChild(toastMain);

  // â¬‡ ëŒ“ê¸€ì´ ë‹¬ë¦´ ì˜ì—­
  const toastComments = document.createElement("div");
  toastComments.className = "toast-comments";
  toastComments.style.marginLeft = "18px";
  toastComments.style.marginTop  = "2px";
  toastEl.appendChild(toastComments);

  toastListEl.prepend(toastEl);
  while (toastListEl.children.length > 5) toastListEl.lastChild.remove();

  /* ğŸ‘‡ ìƒë‹¨ ë¡œê·¸ íŒ¨ë„ìš© í•­ëª© */
  const panelItem = document.createElement("div");
  panelItem.className = "toast-item" + (d.isDestroy ? " toast-destroy" : "");
  panelItem.id = "log-" + logId;   // ëŒ“ê¸€ ë¶™ì¼ ë•Œ ì°¾ê¸°ìš©

  const mainLine = document.createElement("div");
  mainLine.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;

  if (d.isDestroy) {
    const btn2 = document.createElement("span");
    btn2.textContent = " [ë¬µë…í•˜ê¸°]";
    btn2.style.cursor = "pointer";
    btn2.style.color = "#ffffff";
    btn2.dataset.logId = logId;
    btn2.onclick = handleMournClick;
    mainLine.appendChild(btn2);
  }

  panelItem.appendChild(mainLine);

  // ëŒ“ê¸€ ë°•ìŠ¤
  const commentsBox = document.createElement("div");
  commentsBox.className = "log-comments";
  commentsBox.style.marginLeft = "18px";
  commentsBox.style.marginTop  = "2px";
  panelItem.appendChild(commentsBox);

  logPanelListEl.prepend(panelItem);

  // ì´í›„ì— ë‹¬ë¦¬ëŠ” ëŒ“ê¸€ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜
  logRef.child(logId).child("comments").on("child_added", snap => {
    const c = snap.val();
    appendMournCommentToLog(logId, c);
  });
});

  // ê²€ìƒ‰ì°½ ë³€ê²½ ì‹œ í˜¸ì¶œ
function onDuelSearchChange(value) {
  renderDuelList(value);
}

  // âš”ï¸ ê²°íˆ¬ ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderDuelList(keyword) {
  const listEl = document.getElementById("duelList");
  const helpEl = document.getElementById("duelHelpText");
  if (!listEl) return;

  keyword = (keyword || "").trim();

  // ìœ ì € ëª©ë¡ì´ ì•„ì§ ì•ˆ ì™”ìœ¼ë©´
  if (!allUsersCache || allUsersCache.length === 0) {
    listEl.innerHTML = `<div style="font-size:13px; color:#aaa;">ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
    if (helpEl) helpEl.style.display = "none";
    return;
  }

  // ìê¸° ìì‹ ì€ ì œì™¸
  let base = allUsersCache.filter(u => u.id !== userId);

  let filtered;
if (!keyword) {
  // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ìƒìœ„ 5ëª…ë§Œ í‘œì‹œ
  filtered = base.slice(0, 5);
  if (helpEl) {
    helpEl.textContent = "ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•ŒëŠ” ìƒìœ„ 5ëª…ë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
    helpEl.style.display = "block";
  }
} else {
  const lower = keyword.toLowerCase();
  filtered = base.filter(u => u.id.toLowerCase().includes(lower));
  if (helpEl) {
    helpEl.textContent = filtered.length === 0
      ? `"${keyword}" ì™€(ê³¼) ì¼ì¹˜í•˜ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.`
      : `"${keyword}" ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.`;
    helpEl.style.display = "block";
  }
}

  if (filtered.length === 0) {
    listEl.innerHTML = `<div style="font-size:13px; color:#aaa;">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  listEl.innerHTML = "";

  filtered.forEach(u => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.style.padding = "4px 0";
    row.style.borderBottom = "1px solid #333";

    const left = document.createElement("div");
    left.innerHTML = `
      <div style="font-weight:bold;">${u.id}</div>
      <div style="font-size:12px; color:#ccc;">
        ${coloredLevel(u.sword)} / ì „íˆ¬ë ¥: ${formatGold(u.power || 0)}
      </div>
    `;

    const btn = document.createElement("span");
    btn.textContent = "ê²°íˆ¬ì‹ ì²­";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.style.color = "#ffffff";
    btn.dataset.targetId = u.id;
    
btn.onclick = function () {
  showDuelConfirmPopup(u.id); // â† isRandomMatch ì œê±°
};

    row.appendChild(left);
    row.appendChild(btn);
    listEl.appendChild(row);
  });
}

  // ğŸ² ëœë¤ë§¤ì¹­
function handleRandomMatch() {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (!allUsersCache || allUsersCache.length === 0) {
    alert("ì•„ì§ ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }

  const candidates = allUsersCache.filter(u => u.id !== userId);
  if (candidates.length === 0) {
    alert("ë§¤ì¹­ ê°€ëŠ¥í•œ ë‹¤ë¥¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

const idx = Math.floor(Math.random() * candidates.length);
const target = candidates[idx];

// âœ… ëœë¤ë§¤ì¹­ì€ í™•ì¸ì°½ ì—†ì´ ë°”ë¡œ ê²°íˆ¬
performDuel(target.id, true);

}

// âš”ï¸ ê²°íˆ¬ íŒ¨ë„ í† ê¸€
function toggleDuelPanel() {
  const panel = document.getElementById("duelPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderDuelList("");  // ê²€ìƒ‰ì–´ ì—†ì´ â†’ ë­í‚¹ ìˆœ
    panel.style.display = "block";

    const input = document.getElementById("duelSearchInput");
    if (input) {
      input.value = "";
      input.focus();
    }
  } else {
    panel.style.display = "none";
  }
}
  
/* ë¡œê·¸ í† ê¸€ */
function toggleLog(){
  const panel = document.getElementById("logPanel");
  if (!panel) return;

  panel.style.display = (panel.style.display === "none" || panel.style.display === "")
    ? "block"
    : "none";
}

// ğŸ’ ì¸ë²¤í† ë¦¬ í† ê¸€
function toggleInventory() {
  const panel = document.getElementById("inventoryPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderInventory();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

// ğŸ’ ì¸ë²¤í† ë¦¬ ë‚´ìš© ë Œë”ë§
function renderInventory() {
  const listEl = document.getElementById("inventoryList");
  if (!listEl) return;

  listEl.innerHTML = `
    <p>ë³´ìœ  ì•„ì´í…œ í˜„í™©</p>
    <ul style="list-style:none; padding-left:0;">
      <li>ğŸ“œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ: <b>${itemScroll15}</b>ê°œ</li>
      <li>ğŸ›¡ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ: <b>${itemProtect}</b>ê°œ</li>
      <li>ğŸ”’ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ: <b>${itemDownProtect}</b>ê°œ</li>
      <li>âœ¨ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ: <b>${itemSuper}</b>ê°œ</li>
    </ul>
  `;
}

  loadRanking();
  autoLoginFromStorage();
    // â± ì‚¬ëƒ¥ íšŒë³µ íƒ€ì´ë¨¸ í‘œì‹œìš©
  setInterval(updateHuntUI, 1000);

  // â›” ê°•í™” ì§„í–‰ ì¤‘ì—ëŠ” Enter / Space ì…ë ¥ ì°¨ë‹¨
document.addEventListener("keydown", (e) => {
  if (!isUpgrading) return;

  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    e.stopPropagation();
  }
});

  // ğŸ›  ìš´ì˜ììš© â€” ì „íˆ¬ë ¥ ì¬ê³„ì‚° + DB ë°˜ì˜
async function recalcUserPower(userIdToFix) {

  const ref = db.ref("users/" + userIdToFix);

  const snap = await ref.once("value");
  if (!snap.exists()) {
    console.warn("âŒ ìœ ì € ë°ì´í„° ì—†ìŒ:", userIdToFix);
    return;
  }

  const d = snap.val();

  // í•´ë‹¹ ìœ ì € ê¸°ì¤€ ìƒíƒœ ë¡œë“œ
  sword = Number(d.sword ?? 0);
  gold  = Number(d.gold  ?? 0);

  // ğŸ§® ì „íˆ¬ë ¥ ì¬ì‚°ì¶œ
  rollPowerForCurrentSword();

  // DB ë°˜ì˜
  await ref.update({
    power: Number(power),
    updated: Date.now()
  });

  console.log(`âœ… ì „íˆ¬ë ¥ ì¬ê³„ì‚° ì™„ë£Œ â†’ ${userIdToFix}:`, power);
}

</script>

<!-- ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ (NPC ë²„ì „) -->
<div id="tutorialOverlay">
  <div class="tutorial-box" style="text-align:center;">
    <img src="images/npc/blacksmith_idle.png"
         alt="ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸"
         class="npc-popup-img">

   <p style="margin:6px 0 10px 0; font-weight:bold;">
  í—ˆí—ˆâ€¦ ì˜ ì™”êµ¬ë§Œ. ë‚˜ëŠ” ì´ ì™•êµ­ ìµœê³ ì˜ ëŒ€ì¥ì¥ì´, í¼ê·¸ë€íŠ¸ë¼ í•˜ì§€.
</p>

<p style="margin:4px 0; text-align:left; line-height:1.45;">
  â€¢ ìƒë‹¨ ì™¼ìª½ì˜ <b>[ì¶œì„]</b> ë²„íŠ¼ì€ ìŠì§€ ë§ê²Œ.<br>
    ë‹¨ë ¨ì—ëŠ” ìê¸ˆì´ í•„ìš”í•œ ë²•ì´ê±°ë“ .<br><br>

  â€¢ ìƒë‹¨ ì˜¤ë¥¸ìª½ <b>[MAP]</b>ì—ì„œëŠ”<br>
    ê·¸ëŒ€ê°€ ê²€ì„ ì‹œí—˜í•  ì‚¬ëƒ¥í„°ë¥¼ ê³ ë¥¼ ìˆ˜ ìˆë‹¤ë„¤.<br><br>

  â€¢ í™”ë©´ ì¤‘ì•™ì˜ <b>ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤</b> ë²„íŠ¼â€¦<br>
    ì´ê²ƒë“¤ì´ì•¼ë§ë¡œ ëª¨í—˜ê°€ì˜ ê¸¸ì„ ì¢Œìš°í•˜ëŠ” í•µì‹¬ì´ì§€.<br><br>

  â€¢ ì˜¤ë¥¸ìª½ ì•„ë˜ <b>ì¸ë²¤í† ë¦¬ / ë¡œê·¸</b>ëŠ”<br>
    ê·¸ëŒ€ê°€ ê±¸ì–´ì˜¨ ë°œìì·¨ë¥¼ ë‚¨ê²¨ ë‘ëŠ” ê³³ì´ë¼ë„¤.<br><br>

  â€¢ ê°€ëŠ¥í•˜ë‹¤ë©´ <b>ì „ì²´í™”ë©´</b>ìœ¼ë¡œ ì¦ê¸°ê²Œ.<br>
    ì„¸ê³„ë¥¼ ë„“ê²Œ ë³¼ìˆ˜ë¡, ê²€ë„ í¬ê²Œ ì„±ì¥í•˜ë‹ˆê¹Œ ë§ì´ì•¼.
</p>

    <button class="tutorial-close-btn" onclick="closeTutorial()">
      ì•Œê² ë„¤
    </button>
  </div>
</div>

<!-- ğŸ§” ëŒ€ì¥ì¥ì´ / ë¬´ê¸°ìƒì¸ ê³µìš© NPC íŒì—… -->
<div id="npcPopup">
  <div class="npc-popup-inner">

    <!-- ğŸ†• NPC ì´ë¦„í‘œ -->
    <div id="npcPopupName"
         style="font-weight:bold; font-size:15px; margin-bottom:6px;">
    </div>

    <img id="npcPopupImg"
         src="images/npc/blacksmith_idle.png"
         class="npc-popup-img">

    <div class="npc-popup-text" id="npcPopupText"></div>

    <div style="margin-top:10px;">
      <button class="npc-popup-btn" id="npcConfirmBtn">í™•ì¸</button>
      <button class="npc-popup-btn" id="npcCancelBtn" style="display:none;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

  <!-- ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì—†ìŒ) -->
<div id="otherProfileOverlay">
  <div class="other-profile-card">
    <div class="other-profile-header">
      <div id="otherProfileNickname" class="profile-nickname">-</div>
      <button id="otherProfileCloseBtn" class="other-profile-close-btn">&times;</button>
    </div>

    <div class="profile-card-inner">
      <div class="profile-weapon-box">
        <img id="otherWeaponImage"
             src="images/weapons/sword_real_temp.png"
             alt="ë¬´ê¸°">
      </div>

      <div class="profile-info-box">
        <div id="otherProfileWeaponTitle" class="profile-weapon-title">-</div>

        <hr class="profile-inner-divider">

        <div id="otherProfileWeaponDesc" class="profile-weapon-desc">-</div>

        <hr class="profile-inner-divider">

        <div class="profile-row">
          <span class="profile-label">ìµœëŒ€ ê°•í™”</span>
          <span class="profile-value" id="otherProfileMaxInfo">-</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ì „íˆ¬ë ¥</span>
          <span class="profile-value" id="otherProfilePower">0</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ê³¨ë“œ</span>
          <span class="profile-value" id="otherProfileGold">0</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ë¬´ê¸°ê°€ì¹˜</span>
          <span class="profile-value" id="otherProfileWeaponValue">0</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ì „ì </span>
          <span class="profile-value" id="otherProfileRecord">ìŠ¹ 0 / íŒ¨ 0</span>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
