<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê²€ í‚¤ìš°ê¸°</title>

<style>
body {
  margin: 0;
  background: #111;
  color: white;
  font-family: Arial;
  text-align: center;
}

button {
  padding: 14px 26px;
  font-size: 16px;
  margin: 8px;
}

/* ğŸŒˆ 30ê°• ë¬´ì§€ê°œ */
.rainbow {
  background: linear-gradient(90deg, red, orange, yellow, green, cyan, blue, violet);
  background-size: 400% 400%;
  -webkit-background-clip: text;
  color: transparent;
  animation: rainbow 2s linear infinite;
}
@keyframes rainbow {
  from { background-position: 0% }
  to { background-position: 100% }
}

/* ğŸ” ë¡œê·¸ì¸ */
#loginScreen {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
#loginScreen input {
  padding: 10px;
  font-size: 16px;
  margin: 6px;
}

/* ğŸ”” í† ìŠ¤íŠ¸ ë¡œê·¸ (ë¡œê·¸ì¸ í›„ë§Œ) */
#toastLog {
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 600px;
  background: rgba(0,0,0,0.8);
  border: 1px solid #444;
  padding: 8px;
  display: none;
  max-height: 120px;       /* â­ 5ì¤„ */
  overflow: hidden;
  z-index: 1000;
}
.toast-item {
  line-height: 20px;
  height: 20px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  border-bottom: 1px solid #333;
  font-size: 13px;
}
.toast-destroy {
  color: red;
  font-weight: bold;
}

/* ğŸ“œ ë¡œê·¸ ë²„íŠ¼ */
#logToggle {
  position: fixed;
  bottom: 140px;
  right: 10px;
  z-index: 1001;
}

/* ğŸ“œ ì „ì²´ ë¡œê·¸ íŒ¨ë„ */
#logPanel {
  position: fixed;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 420px;
  height: 60%;
  background: rgba(0,0,0,0.95);
  border: 1px solid #555;
  padding: 10px;
  overflow-y: auto;
  display: none;
  z-index: 1002;
}
</style>
</head>

<body>

<!-- ğŸ” ë¡œê·¸ì¸ -->
<div id="loginScreen">
  <h2>ğŸ” ë¡œê·¸ì¸</h2>
  <input id="loginId" placeholder="ì•„ì´ë””">
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <button onclick="login()">ì ‘ì†</button>
</div>

<!-- ğŸ® ê²Œì„ -->
<div id="gameScreen" style="display:none;">
  <h1>âš”ï¸ ê²€ í‚¤ìš°ê¸°</h1>

  <div id="status"></div>
  <div id="upgradeInfo"></div>

  <button onclick="upgrade()">ğŸ”¨ ê°•í™”</button>
  <button onclick="hunt()">âš”ï¸ ì‚¬ëƒ¥</button>

  <hr>
  <h2>ğŸ† ë­í‚¹ TOP 10</h2>
  <div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<!-- ğŸ”” ë¡œê·¸ -->
<div id="toastLog"><div id="toastList"></div></div>
<button id="logToggle" onclick="toggleLog()">ğŸ“œ ë¡œê·¸</button>

<div id="logPanel">
  <h3>ğŸ“¢ ê°•í™” ë¡œê·¸</h3>
  <div id="logPanelList"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
/* ğŸ”¥ Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  databaseURL: "https://sword-game-1d1a1-default-rtdb.firebaseio.com"
});
const db = firebase.database();
const logRef = db.ref("logs");

/* ğŸ® ìƒíƒœ */
let sword = 1, power = 10, gold = 100;
let userId = "", userPassword = "", userRef = null;

/* ğŸ“Š UI */
function update() {
  document.getElementById("status").innerHTML = `
    ğŸ”° ê°•í™” : +${sword}ê°•<br>
    âš”ï¸ ê³µê²©ë ¥ : ${power}<br>
    ğŸ’° ê³¨ë“œ : ${gold}
  `;
  document.getElementById("upgradeInfo").innerHTML = `
    ê°•í™” í™•ë¥  : ${getUpgradeChance(sword)}%<br>
    í•„ìš” ê³¨ë“œ : 20
  `;
}

/* ğŸ¯ í™•ë¥  */
function getUpgradeChance(lv) {
  if (lv < 10) return 80;
  if (lv < 20) return 40;
  if (lv < 25) return 20;
  if (lv < 30) return 5;
  return 0;
}

/* ğŸ”¨ ê°•í™” */
function upgrade() {
  if (gold < 20) return alert("ê³¨ë“œ ë¶€ì¡±");
  gold -= 20;

  const chance = getUpgradeChance(sword);
  const before = sword;

  if (Math.random() < chance / 100) {
    sword++; power += 5;
    if (before >= 20) writeLog(`${userId}ì´ +${before} â†’ +${sword} ì„±ê³µ`);
  } else {
const safeLevels = [5, 10, 15, 20, 25];

if (safeLevels.includes(before)) {
  // ë³´í˜¸ êµ¬ê°„: ì‹¤íŒ¨ë§Œ í•˜ê³  ì•„ë¬´ ë³€í™” ì—†ìŒ
  alert(`âŒ ê°•í™” ì‹¤íŒ¨ (ë³´í˜¸ êµ¬ê°„ +${before})`);
}
else if (before <= 20) {
  // 6~19ê°•: ìœ ì§€ ë˜ëŠ” ê°•ë“±
  if (Math.random() < 0.5) {
    alert("âŒ ê°•í™” ì‹¤íŒ¨ (ìœ ì§€)");
  } else {
    sword--;
    power -= 5;
    alert("â¬‡ï¸ ê°•í™” ì‹¤íŒ¨ (ê°•ë“±)");
  }
}
else {
  // 21ê°• ì´ìƒ: ë¬´ì¡°ê±´ íŒŒê´´
  sword = 1;
  power = 10;
  alert("ğŸ’¥ ê°•í™” ì‹¤íŒ¨ â†’ íŒŒê´´");
  writeLog(`${userId}ì´ +${before} ë„ì „ ì‹¤íŒ¨ â†’ íŒŒê´´`, true);
}

  }
  update(); save();
}

/* âš”ï¸ ì‚¬ëƒ¥ */
function hunt() {
  const earn = Math.floor(Math.random() * power);
  gold += earn;
  update(); save();
}

/* ğŸ” ë¡œê·¸ì¸ */
function login() {
  userId = loginId.value.trim();
  userPassword = loginPw.value;
  if (!userId || !userPassword) return alert("ì…ë ¥í•˜ì„¸ìš”");

  userRef = db.ref("users/" + userId);
  userRef.once("value").then(s => {
    if (!s.exists()) {
      userRef.set({ password:userPassword, sword, power, gold });
    } else {
      const d = s.val();
// ë¹„ë°€ë²ˆí˜¸ê°€ ì €ì¥ë¼ ìˆìœ¼ë©´ ê²€ì‚¬
if (d.password !== undefined && d.password !== userPassword) {
  alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  return;
}

// ê¸°ì¡´ ë°ì´í„° ë¡œë”© (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
sword = typeof d.sword === "number" ? d.sword : 1;
power = typeof d.power === "number" ? d.power : 10;
gold  = typeof d.gold  === "number" ? d.gold  : 100;

    }
    loginScreen.style.display="none";
    gameScreen.style.display="block";
    toastLog.style.display="block";
    update(); loadRanking();
  });
}

/* ğŸ’¾ ì €ì¥ */
function save() {
  if (!userRef) return;
  userRef.update({ sword, power, gold, updated: Date.now() });
  loadRanking();
}

/* ğŸ† ë­í‚¹ */
function loadRanking() {
  db.ref("users").orderByChild("sword").limitToLast(10).once("value", s=>{
    let html="";
    s.forEach(c=>{
      html=`<div>${c.key} | +${c.val().sword}ê°•</div>`+html;
    });
    ranking.innerHTML=html;
  });
}

/* ğŸ”” ë¡œê·¸ */
function writeLog(msg, destroy=false) {
  logRef.push({
    message: `[${new Date().toLocaleTimeString()}] ${msg}`,
    isDestroy: destroy
  });
}

logRef.limitToLast(50).on("child_added", s=>{
  const d=s.val();
  const el=document.createElement("div");
  el.className="toast-item"+(d.isDestroy?" toast-destroy":"");
  el.innerHTML=d.message;
  toastList.prepend(el);
  while(toastList.children.length>5) toastList.lastChild.remove();

  const p=document.createElement("div");
  p.innerHTML=d.message;
  logPanelList.prepend(p);
});

function toggleLog() {
  logPanel.style.display = logPanel.style.display==="block"?"none":"block";
}
</script>
</body>
</html>
