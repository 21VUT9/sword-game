<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„</title>

<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
}

/* ğŸ¯ ê°•í™” ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ ì¤„ ì •ë¦¬ */
#upgradeItems {
  display: flex;
  flex-wrap: wrap;           /* í™”ë©´ ì¢ìœ¼ë©´ ë¼ë²¨ ë‹¨ìœ„ë¡œ ë‹¤ìŒ ì¤„ë¡œ ë‚´ë ¤ê°€ê²Œ */
  justify-content: center;
  gap: 4px 12px;             /* ë¼ë²¨ ì‚¬ì´ ê°„ê²© */
}
  
#upgradeItems label {
  white-space: nowrap;       /* ğŸ”¥ ë¼ë²¨ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ ê¸ˆì§€ (í•­ìƒ í•œ ì¤„) */
}

/* ê³µìš© ì•¡ì…˜ íŒì—… ë²„íŠ¼ (ê²Œì„ ë²„íŠ¼ ëŠë‚Œ) */
.actionBtn{
  width: 100%;
  margin: 6px 0;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-weight: 800;
  cursor: pointer;
}

.actionBtn:hover{
  background: rgba(255,255,255,0.10);
}

.actionText{
  color: #ddd;
  font-size: 12px;
  line-height: 1.35;
  padding: 6px 4px;
  white-space: pre-line; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
}

.actionTitle{
  font-weight: 900;
  margin-bottom: 6px;
  color: #fff;
}
  
/* ğŸ”¨ ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤ ë²„íŠ¼ ë¬¶ìŒ */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 8px;
  flex-wrap: nowrap;
  margin-top: 6px;
}

.action-buttons button {
  flex: 0 0 auto;        /* ë²„íŠ¼ í­ì„ ê¸€ì ê¸¸ì´ì— ë§ê²Œ */
  padding: 10px 18px;    /* ê°€ë¡œ íŒ¨ë”© ì¤„ì—¬ì„œ í­ í™•ë³´ */
  font-size: 16px;       /* ê¸€ì ì¡°ê¸ˆë§Œ ì¤„ì´ê¸° */
  margin: 0;             /* ê³µìš© button ë§ˆì§„ ì œê±° */
  white-space: nowrap;   /* ğŸ”¥ ë²„íŠ¼ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
}

/* ğŸ“· í”„ë¡œí•„ ì €ì¥ ìº¡ì³ ëª¨ë“œ */
.capture-mode * {
  visibility: hidden !important;
}

/* ğŸ¦  ì—­ë³‘ì¥ ë°˜ì§ í…ìŠ¤íŠ¸ */
.title-plague {
  font-weight: bold;
  background: linear-gradient(90deg, #00c853, #b9ffcc, #00c853);
  background-size: 200% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 0 10px rgba(0, 200, 83, 0.35);
  animation: plagueShine 1.6s linear infinite;
}

@keyframes plagueShine {
  0%   { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}
  
/* ğŸ”— ë­í‚¹ì—ì„œ ë‹‰ë„¤ì„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.rank-user {
  cursor: pointer;
  text-decoration: none;   /* â† ë°‘ì¤„ ì œê±° */
}

.rank-user:hover {
  color: #ffd700;          /* ìƒ‰ìƒë§Œ ê°•ì¡° */
}

/* ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ëœ¨ëŠ” ì‘ì€ ë©”ë‰´ */
#rankProfileMenu {
  position: absolute;
  display: none;
  background: rgba(0,0,0,0.95);
  border: 1px solid #555;
  border-radius: 6px;
  padding: 4px 6px;
  z-index: 1500;
}
#rankProfileMenu button {
  font-size: 13px;
  padding: 4px 8px;
}

  /* ğŸ“Œ ê³µì§€ NEW ë±ƒì§€ */
.badge-new {
  display: inline-block;
  margin-left: 6px;
  padding: 1px 6px;
  font-size: 10px;
  font-weight: bold;
  color: #fff;
  background: #ff4d4d;
  border-radius: 10px;
}
  
/* ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ì˜¤ë²„ë ˆì´ */
#otherProfileOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2100;
}

.other-profile-card {
  background: #222;
  border: 1px solid #555;
  border-radius: 12px;
  padding: 14px 12px 16px 12px;
  max-width: 340px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px rgba(0,0,0,0.9);
}

.other-profile-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.other-profile-close-btn {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 18px;
  padding: 0 6px;
  cursor: pointer;
}

.other-profile-close-btn:hover {
  color: #ff6666;
}
  
/* â¬œ fieldBg ì˜ì—­ë§Œ ë³´ì´ê²Œ */
.capture-mode #fieldBg,
.capture-mode #fieldBg * {
  visibility: visible !important;
}


/* ===========================
   ğŸ“· ìº¡ì³ ì‹œ ìˆ¨ê¸¸ ìš”ì†Œ
   =========================== */

/* ğŸ”» ì¶”ì²œë ˆë²¨ / ì„±ê³µí™•ë¥  ì¤„ ìˆ¨ê¸°ê¸° */
.capture-mode .current-field-info-sub {
  display: none !important;
}

/* ğŸ”» ê°•í™” ì •ë³´ / ë²„íŠ¼ */
.capture-mode #upgradeInfo,
.capture-mode .action-buttons,
.capture-mode #huntInfo,
.capture-mode #upgradeItems {
  display: none !important;
}

/* ğŸ”» ì¶œì„ / ë¡œê·¸ / ë§µ ë²„íŠ¼ / ì¸ë²¤í† ë¦¬ ë“± UI ë²„íŠ¼ */
.capture-mode .side-menu-btn,
.capture-mode #attendanceBtn,
.capture-mode #logoutBtn,
.capture-mode #logToggle {
  display: none !important;
}

/* ğŸ”» ì €ì¥ë²„íŠ¼ / ì €ì¥ì¤‘ í‘œì‹œ */
.capture-mode .no-capture,
.capture-mode .profile-share-btn,
.capture-mode .profile-save-status {
  display: none !important;
}

/* â›” (ì•ˆì „ì¥ì¹˜) no-captureëŠ” í•­ìƒ ìº¡ì³ ì¤‘ ìˆ¨ê¹€ */
.capture-mode .no-capture {
  display:none !important;
}
  
  /* ğŸ« ì¶œì„ ë²„íŠ¼ */
#attendanceBtn {
  position:fixed;
  top:40px;          /* â¬…ï¸ 10 â†’ 40 ìœ¼ë¡œ ë³€ê²½ */
  left:10px;
  z-index:1100;
  display:none;
  font-size:14px;
  padding:8px 16px;
}

  /* ğŸŸ ì¿ í° ë²„íŠ¼ (ì¶œì„ ë²„íŠ¼ ì•„ë˜) */
#couponBtn {
  position:fixed;
  top:80px;       /* ì¶œì„(40px) ì•„ë˜ */
  left:10px;
  z-index:1100;
  display:none;
  font-size:14px;
  padding:8px 16px;
}

/* ìº¡ì²˜ ëª¨ë“œì—ì„œ ìˆ¨ê¸°ê¸° */
.capture-mode #couponBtn {
  display: none !important;
}

/* ğŸ… ì—…ì  ë²„íŠ¼ (ì¿ í° ë²„íŠ¼ ì•„ë˜) */
#achievementBtn{
  position:fixed;
  top:120px;      /* ì¿ í°(80px) ì•„ë˜ */
  left:10px;
  z-index:1200;
  display:none;   /* âœ… ë¡œê·¸ì¸ ì „ì—ëŠ” ìˆ¨ê¹€ */
  font-size:14px;
  padding:8px 16px;
}

/* ìº¡ì²˜ ëª¨ë“œì—ì„œ ìˆ¨ê¸°ê¸° */
.capture-mode #achievementBtn{
  display:none !important;
}

/* ë²„íŠ¼ */
button {
  padding:15px 30px;
  font-size:18px;
  margin:10px;
}

/* ğŸŒˆ 30ê°• ë¬´ì§€ê°œ */
.rainbow {
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 2s linear infinite;
  display:inline-block;
}
@keyframes rainbow {
  from {background-position:0%}
  to {background-position:100%}
}

.rainbowStar{
  background: linear-gradient(90deg, #ff4d4d, #ffb84d, #fff04d, #4dff88, #4dd2ff, #7a5cff, #ff4dff);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 900;
  letter-spacing: 1px;
  text-shadow: 0 0 10px rgba(255,255,255,0.25);
}
  
  /* âœ¨ ì‹¤ë²„ / ê³¨ë“œ ë°˜ì§ì„ */
.sparkle-silver {
  color: #C0C0C0;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(192,192,192,0.8);
  animation: sparkle 1.5s infinite alternate;
}

.sparkle-gold {
  color: #FFD700;
  font-weight: bold;
  text-shadow: 0 0 8px rgba(255,215,0,0.9);
  animation: sparkle 1.2s infinite alternate;
}

/* âœ¨ ê³µí†µ ë°˜ì§ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes sparkle {
  from {
    opacity: 0.85;
    filter: brightness(1);
  }
  to {
    opacity: 1;
    filter: brightness(1.4);
  }

    from { filter: brightness(1); }
  to   { filter: brightness(1.25); }

}

/* ğŸ”¤ ê²€ ì´ë¦„ í•œ ì¤„ í‘œì‹œ (ì¤„ë°”ê¿ˆ ê¸ˆì§€ + ë§ì¤„ì„) */
.profile-weapon-title {
  font-size: 16px;
  font-weight: bold;
  margin: 4px 0 2px 0;
  white-space: nowrap;       /* í•œ ì¤„ ìœ ì§€ */
  overflow: hidden;
  text-overflow: ellipsis;   /* ë„ˆë¬´ ê¸¸ë©´ â€¦ ì²˜ë¦¬ */
}

/* ğŸ“ ê²€ ì„¤ëª… */
.profile-weapon-desc {
  font-size: 13px;
  color: #cccccc;
  line-height: 1.4;
  white-space: pre-line;     /* ìš°ë¦¬ê°€ ì“´ ë¬¸ì¥ êµ¬ì¡° ìœ ì§€ìš© */
  margin-bottom: 2px;
}

/* í”„ë¡œí•„ ì¹´ë“œ ë‚´ë¶€ êµ¬ë¶„ì„  */
.profile-inner-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 6px 0 8px 0;
}
  
/* ğŸ”” í† ìŠ¤íŠ¸ */
#toastLog {
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:600px;
  background:rgba(0,0,0,0.75);
  border:1px solid #444;
  padding:8px;
  font-size:14px;
  z-index:1000;
}
.toast-item {
  padding:4px 0;
  border-bottom:1px solid #333;
}
.toast-destroy {
  color:red;
  font-weight:bold;
}

/* ë¡œê·¸ */
#logToggle {
  position:fixed;
  bottom:80px;
  right:10px;
  z-index:1001;
}
#logPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:90%;
  max-width:400px;
  height:60%;
  background:rgba(0,0,0,0.9);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1002;
  display:none;
}

.userListName {
  color:#fff;             /* ê¸°ë³¸ í°ìƒ‰ ìœ ì§€ */
  cursor:pointer;         /* ì†ê°€ë½ ëª¨ì–‘ ì»¤ì„œ */
  text-decoration:none;   /* ë°‘ì¤„ ì œê±° */
}

.userListName:hover {
  color:#6cf;             /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ í•˜ì´ë¼ì´íŠ¸ */
}

/* ğŸŒ ì „ ì„œë²„ ë„ì „ ì•Œë¦¼ ë°°ë„ˆ */
#worldBanner {
  position: fixed;
  top: 50px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 18px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  font-size: 13px;
  line-height: 1.4;
  z-index: 2000;
  display: none;           /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
  text-align: center;
  white-space: nowrap;
}

#worldBanner span.level {
  color: #ffb74d;
  font-weight: bold;
}

/* ğŸŒ™ +30 ê¸€ë¡œë²Œ ì—°ì¶œ ì˜¤ë²„ë ˆì´ */
#global30Overlay {
  position: fixed;
  inset: 0;
  z-index: 999999;
}

#global30Overlay .global30-backdrop{
  position:absolute;
  inset:0;
  background: rgba(220, 230, 255, 0.22);
  backdrop-filter: blur(2px);
}

#global30Overlay .global30-box{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%);
  width: min(520px, 92vw);
  background: rgba(10,10,12,0.88);
  border: 1px solid rgba(180,200,255,0.35);
  box-shadow: 0 10px 40px rgba(0,0,0,0.55);
  border-radius: 14px;
  padding: 18px 16px 14px 16px;
  text-align:center;
}

#global30Overlay .global30-title{
  font-size: 18px;
  font-weight: 800;
  color: #e8efff;
  margin-bottom: 8px;
  letter-spacing: 0.2px;
}

#global30Overlay .global30-desc{
  font-size: 14px;
  line-height: 1.5;
  color: rgba(235,240,255,0.9);
  white-space: pre-line;
  margin-bottom: 12px;
}

#global30Overlay .global30-btn{
  width: 140px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 0;
  font-weight: 700;
  cursor: pointer;
}

  .toast-30 {
  font-weight: 800;
  letter-spacing: 0.2px;
}

.toast-awe button{
  padding: 6px 10px;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
  font-weight: 700;
}

.toast-awe-msg{
  font-weight: 700;
}
  
/* ================= ìœ ì € í”„ë¡œí•„ ì¹´ë“œ ================ */

#userProfileArea {
  max-width: 320px;
  margin: 10px auto 20px auto;

  /* ğŸ” ë¶ˆíˆ¬ëª… â†’ ë°˜íˆ¬ëª… + ë¸”ëŸ¬ */
  background: rgba(24, 24, 24, 0.55);
  backdrop-filter: blur(5px);

  border-radius: 16px;
  box-shadow: 0 0 18px rgba(0,0,0,0.7);
  padding: 16px 12px 14px 12px;
  position: relative;  /* ê³µìœ  ë²„íŠ¼ ê¸°ì¤€ */
}

  /* í”„ë¡œí•„ ì¹´ë“œ ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ */
.profile-save-status {
  position: absolute;
  top: 30px;
  right: 10px;
  font-size: 11px;
  color: #cccccc;
  opacity: 0;
  transition: opacity 0.2s;
}
 
/* ğŸ“¥ í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ â€” ë¯¸ë‹ˆë©€ ì•„ì´ì½˜í˜• */
.profile-share-btn {
  position: absolute;
  top: 6px;
  right: 6px;

  background: transparent; /* ğŸ”¹ ë°°ê²½ ì œê±° */
  border: none;            /* ğŸ”¹ í…Œë‘ë¦¬ ì œê±° */
  padding: 2px 4px;

  font-size: 18px;         /* ğŸ”¹ ì•„ì´ì½˜ í¬ê¸° */
  cursor: pointer;

  color: #ffffff;          /* ê¸°ë³¸ í°ìƒ‰ */
  opacity: 0.8;            /* ì€ì€í•˜ê²Œ */
  transition: opacity 0.15s, transform 0.1s;
}

/* hover ì‹œë§Œ ê°•ì¡° */
.profile-share-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* ëª¨ë°”ì¼ì—ì„œë„ ëˆŒë¦¬ê¸° ì¢‹ê²Œ */
.profile-share-btn:active {
  transform: scale(0.95);
}
  
.profile-card-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ì„¼í„° ë¬´ê¸° ì´ë¯¸ì§€ */
.profile-weapon-box {
  width: 320px;
  height: 320px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

/* ë‚˜ì¤‘ì— íˆ¬ëª… PNGë¡œ êµì²´í•˜ë©´ ë¨ */
#weaponImage {
  max-width: 100%;
  max-height: 100%;
}

/* í•˜ë‹¨ ì •ë³´ ì˜ì—­ */
.profile-info-box {
  width: 100%;
  text-align: center;
  font-size: 14px;
}

.profile-nickname {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}

.profile-row {
  margin: 2px 0;
}

.profile-label {
  color: #bbbbbb;
  margin-right: 4px;
}

.profile-value {
  font-weight: bold;
}

#profileGold,
#profileSword,
#profilePower,
#profileHuntCount {
  color: #fff;
}

/* ğŸ”˜ ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (MAP / ê²°íˆ¬ / ì¸ë²¤í† ë¦¬) */
.side-menu-btn {
  position: fixed;
  right: 10px;
  z-index: 1100;
  font-size: 14px;
  padding: 8px 16px;
  margin: 0;
  display: none;   /* ë¡œê·¸ì¸ í›„ JSì—ì„œ blockìœ¼ë¡œ ë°”ê¿ˆ */
}

/* ê° ë²„íŠ¼ì˜ ì„¸ë¡œ ìœ„ì¹˜ë§Œ ë‹¤ë¥´ê²Œ */
#mapBtn {
  top: 10px;
}

#scrollShopBtn {
  top: 50px;   
}
  
#duelBtn {
  top: 90px;
}

#inventoryBtn {
  top: 130px;
}

#userListBtn {
  top: 170px;
}
  
/* ğŸ—º MAP íŒ¨ë„ */
#mapPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:260px;
  max-height:70%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1101;
  display:none;
  text-align:left;
  font-size:14px;
}
#mapPanel h3 {
  margin-top:0;
}
.map-field {
  padding:6px 4px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.map-field:hover {
  background:#222;
}

/* ì‚¬ëƒ¥ ì •ë³´ í…ìŠ¤íŠ¸ */
#huntInfo {
  font-size:14px;
  color:#ccc;
  margin-top:4px;
}

 /* ğŸ—º í”„ë¡œí•„ ì¹´ë“œ â€œë°–â€ ìƒë‹¨ í˜„ì¬ ì‚¬ëƒ¥í„° ì •ë³´ */
.current-field-info {
  font-size: 14px;
  color: #ffffff;        /* ê¸°ë³¸ í°ìƒ‰ */
  text-align: center;
  margin-bottom: 8px;    /* ì•„ë˜ ì¹´ë“œë‘ ê°„ê²© */
  line-height: 1.4;
}

  /* ğŸ¨ ê²Œì„ íƒ€ì´í‹€ ë¡œê³  */
.game-title {
  margin: 16px 0 8px 0;
  text-align: center;
}

.game-title-logo {
  max-width: 320px;   /* PCì—ì„œ ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ */
  width: 80%;         /* ëª¨ë°”ì¼ì—ì„œëŠ” í™”ë©´ ê¸°ì¤€ìœ¼ë¡œ ì¤„ì–´ë“¦ */
  height: auto;
  image-rendering: auto;
}


.current-field-info-sub {
  font-size: 14px;
  color: #cccccc;        /* ì¶”ì²œë ˆë²¨/ì„±ê³µí™•ë¥  íšŒìƒ‰ */
}
  
/* ğŸ§” NPC íŒì—… */
#npcPopup {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;              /* ê¸°ë³¸ ìˆ¨ê¹€ */
  align-items:center;
  justify-content:center;
  z-index:2000;
}

.npc-popup-inner {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.npc-popup-img {
  width:140px;
  height:auto;
  display:block;
  margin:0 auto 8px auto;
}

.npc-popup-text {
  font-size:16px;
  margin:8px 0 12px 0;
}

.npc-popup-btn {
  padding:8px 20px;
  font-size:14px;
  cursor:pointer;
}

/* âš”ï¸ ê²°íˆ¬ VS ì—°ì¶œ ì˜¤ë²„ë ˆì´ */
#duelBattleOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;           /* ê¸°ë³¸ ìˆ¨ê¹€ */
  align-items: center;
  justify-content: center;
  z-index: 2050;          /* NPC íŒì—…ë³´ë‹¤ ì‚´ì§ ìœ„ or ì•„ë˜ë¡œ ì¡°ì ˆ */
}

.duel-battle-inner {
  background: #222;
  border: 1px solid #555;
  border-radius: 12px;
  padding: 16px 20px;
  max-width: 360px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px rgba(0,0,0,0.9);
  font-size: 14px;
}

.duel-battle-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
}

.duel-battle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
  margin-bottom: 6px;
}

.duel-side {
  width: 45%;
}

.duel-user-name {
  font-weight: bold;
  margin-bottom: 2px;
}

.duel-weapon-name {
  font-size: 13px;
  margin-bottom: 4px;
}

.duel-weapon-img-box {
  width: 90px;
  height: 90px;
  margin: 0 auto 4px auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.duel-weapon-img-box img {
  max-width: 100%;
  max-height: 100%;
}

.duel-power {
  font-size: 12px;
  color: #ccc;
}

.duel-vs-text {
  font-size: 20px;
  font-weight: bold;
  padding: 0 4px;
}

.duel-battle-sub {
  font-size: 12px;
  color: #aaa;
  margin-top: 6px;
}

/* ğŸ“¢ ì—…ë°ì´íŠ¸ ê³µì§€ íŒì—… */
#updateNoticeOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1950;
}

.update-notice-box {
  background: #222;
  border: 1px solid #555;
  border-radius: 10px;
  padding: 14px 18px;
  max-width: 360px;
  width: 90%;
  color: #fff;
  font-size: 13px;
  text-align: left;
  box-shadow: 0 0 15px rgba(0,0,0,0.8);
}

.update-notice-title {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 14px;
  text-align: center;
}

.update-notice-content {
  white-space: pre-line;
  line-height: 1.4;
  margin-bottom: 10px;
}

.update-notice-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}

.update-notice-nav button {
  font-size: 12px;
  padding: 4px 8px;
}
  
/* ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ */
#tutorialOverlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:flex-start;   /* â¬…ï¸ ìœ„ìª½ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ */
  justify-content:center;   /* ê°€ë¡œëŠ” ì¤‘ì•™ ìœ ì§€ */
  z-index:1900;
  padding-top:60px;         /* â¬…ï¸ ìœ„ì—ì„œ ì•½ê°„ ë„ì›Œì£¼ê¸° */
}

.tutorial-box {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  color:#fff;
  text-align:left;
  font-size:14px;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.tutorial-box h3 {
  margin-top:0;
  margin-bottom:8px;
  text-align:center;
}

.tutorial-box ul {
  padding-left:18px;
  margin:8px 0 12px 0;
}

.tutorial-close-btn {
  display:block;
  width:100%;
  padding:8px 0;
  margin-top:4px;
  text-align:center;
  cursor:pointer;
  border:none;
  border-radius:6px;
  background:#f0f0f0;
  color:#222;
  font-weight:bold;
}

/* ì„¹ì…˜ êµ¬ë¶„ì„  */
.section-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 10px auto 16px auto;
  max-width: 360px;  /* í”„ë¡œí•„ ì¹´ë“œ í­ì´ë‘ ë¹„ìŠ·í•˜ê²Œ */
}

/* ğŸ¨ ì‚¬ëƒ¥í„° ë°°ê²½ ë ˆì´ì–´ */
#gameScreen {
  position: relative;
   padding-bottom: 300px;   /* ğŸ”¹ í† ìŠ¤íŠ¸ ë¡œê·¸ ë†’ì´ë§Œí¼ ì•„ë˜ ì—¬ë°± ì¶”ê°€ */
}

/* fieldBg ì•ˆì˜ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ, ë°°ê²½ë§Œ ::beforeë¡œ ê¹”ê¸° */
.field-bg {
  max-width: 430px;
  margin: 0 auto 20px auto;
  position: relative;
  z-index: 0;                     /* ìŠ¤íƒ ê¸°ì¤€ */
}

/* ì§„ì§œ ë°°ê²½ì€ ê°€ìƒ ìš”ì†Œë¡œ: ê°€ë¡œëŠ” í™”ë©´ ì „ì²´, ì„¸ë¡œëŠ” fieldBg ë†’ì´ê¹Œì§€ë§Œ */
.field-bg::before {
  content: "";
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100vw;
  height: 100%;
  background-image: var(--field-bg-image, none);
  background-size: cover;
  background-position: center top;
  background-repeat: no-repeat;
  filter: brightness(0.6);
  z-index: -1;                    /* ğŸ‘ˆ ë‚´ìš© ë’¤ë¡œ í™•ì‹¤í•˜ê²Œ ë³´ë‚´ê¸° */
}

/* ğŸ’ ì¸ë²¤í† ë¦¬ ê·¸ë¦¬ë“œ */
.inventory-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);  /* 5ì¹¸ */
  gap: 6px;
  margin-top: 6px;
}

/* ê° ì¸ë²¤í† ë¦¬ ìŠ¬ë¡¯ */
.inventory-slot {
  position: relative;
  width: 44px;
  height: 44px;
  background: rgba(255,255,255,0.05);
  border: 1px solid #555;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

/* ì•„ì´í…œ ì•„ì´ì½˜ */
.inventory-slot img {
  max-width: 80%;
  max-height: 80%;
  display: block;
}

/* ê°œìˆ˜ ë°°ì§€ (ì˜¤ë¥¸ìª½ ì•„ë˜) */
.inventory-count {
  position: absolute;
  right: 2px;
  bottom: 2px;
  min-width: 14px;
  padding: 0 3px;
  background: rgba(0,0,0,0.8);
  border-radius: 8px;
  font-size: 11px;
  text-align: center;
}

/* ì¸ë²¤í† ë¦¬ ì œëª© ì‚´ì§ ì—¬ë°± */
#inventoryPanel h3 {
  margin-top: 0;
  margin-bottom: 4px;
}
/* ğŸ’ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ìƒì„¸ íŒì—… */
#itemDetailOverlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 3000;
  background: rgba(0,0,0,0); /* í•„ìš”í•˜ë©´ 0.4 ì •ë„ë¡œ ì–´ë‘¡ê²Œ */
}

#itemDetailBox {
  position: absolute;
  min-width: 200px;
  max-width: 260px;
  background: #111;
  border: 1px solid #666;
  border-radius: 10px;
  padding: 10px;
  color: #fff;
  box-shadow: 0 0 15px rgba(0,0,0,0.8);
  font-size: 13px;
}

#itemDetailImg {
  display: block;
  margin: 0 auto 6px auto;
  width: 96px;
  height: 96px;
  object-fit: contain;
}

#itemDetailName {
  font-weight: bold;
  text-align: center;
  margin-bottom: 4px;
}

#itemDetailDesc {
  font-size: 12px;
  color: #ccc;
  line-height: 1.4;
  text-align: center;
}

/* ğŸ”¥ ê°•í™” ì—°ì¶œ í”Œë˜ì‹œ ì˜¤ë²„ë ˆì´ */
#upgradeFlashOverlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2200;           /* NPC íŒì—…ë³´ë‹¤ ìœ„ë¡œ */
}

/* ê¸°ë³¸ì€ íˆ¬ëª… */
#upgradeFlashOverlay::before {
  content: "";
  position: absolute;
  inset: 0;
  opacity: 0;
}

/* ğŸ’¥ íŒŒê´´(ì‹¤íŒ¨)ìš© ë¶‰ì€ í”Œë˜ì‹œ */
#upgradeFlashOverlay.flash-red::before {
  background: radial-gradient(circle at center, rgba(255,0,0,0.65), rgba(0,0,0,0.9));
  animation: upgradeFlashRed 0.6s ease-out;
}

/* âœ¨ ëŒ€ì„±ê³µ(25ê°• ì´ìƒ ì„±ê³µ)ìš© í™©ê¸ˆ í”Œë˜ì‹œ */
#upgradeFlashOverlay.flash-gold::before {
  background: radial-gradient(circle at center, rgba(255,215,0,0.7), rgba(0,0,0,0.9));
  animation: upgradeFlashGold 0.7s ease-out;
}

@keyframes upgradeFlashRed {
  0%   { opacity: 0;   }
  30%  { opacity: 1;   }
  100% { opacity: 0;   }
}

@keyframes upgradeFlashGold {
  0%   { opacity: 0;   }
  40%  { opacity: 1;   }
  100% { opacity: 0;   }
}

/* =========================
   ğŸ·ï¸ ì—…ì (ì¹­í˜¸) ì˜¤ë²„ë ˆì´ UI ì •ë¦¬
   ========================= */

.titleOverlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.65);
}

.titlePanel{
  position: relative;
  width: min(860px, 92vw);
  height: min(560px, 84vh);
  border-radius: 16px;
  padding: 14px;                 /* âœ… padding-bottom ê³ ì •ê°’ ì œê±° */
  background: rgba(10,10,10,0.88);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  backdrop-filter: blur(6px);

  display: flex;                 /* âœ… 2ë‹¨ ë ˆì´ì•„ì›ƒ */
  flex-direction: column;
  overflow: hidden;              /* âœ… NPC ì‚ì ¸ë‚˜ì˜¤ëŠ”ê±° ë°©ì§€ */
}

/* í—¤ë” */
.titleHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.titleHeaderLeft{
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.2px;
}

.titleHeaderRight{
  display:flex;
  align-items:center;
  gap: 8px;
}

/* ë²„íŠ¼ í¬ê¸° í†µì¼ (ìµœê·¼íšë“ìˆœ / ë‹«ê¸°) */
.titleBtn{
  height: 34px;
  padding: 0 12px;
  font-size: 13px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.08);
  color: #eee;
  cursor: pointer;
}

.titleBtn:hover{
  background: rgba(255,255,255,0.12);
}

.titleBtnClose{
  width: 34px;
  padding: 0;
  font-weight: 900;
}

/* ì¥ì°©ì¤‘ ì¤„ */
.titleEquippedRow{
  margin: 6px 0 12px;
  font-size: 13px;
  color: #cfcfcf;
}

/* ê·¸ë¦¬ë“œ: ê°€ë…ì„± + ì •ëˆ */
.titleGrid{
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  align-content: start;

  flex: 1;                       /* âœ… ë‚¨ëŠ” ê³µê°„ ì „ë¶€ ê·¸ë¦¬ë“œ */
  overflow-y: auto;
  padding: 6px 2px 10px;         /* âœ… ìƒì ì²˜ëŸ¼ ì´˜ì´˜ */
}

/* ì¹´ë“œ ì…€ ê³µí†µ(ê¸°ì¡´ inline styleë³´ë‹¤ ìš°ì„ ë˜ê²Œ í•˜ë ¤ë©´ !importantë„ ê°€ëŠ¥) */
.titleCell{
  border-radius: 14px;
  padding: 10px 8px;
  text-align: center;
  user-select: none;
  background: rgba(255,255,255,0.04);
}

/* âœ… NPC ì˜ì—­: ìŠ¤í¬ë¡¤ìƒì ì²˜ëŸ¼ â€œìš°ì¸¡í•˜ë‹¨ NPC / ì¢Œì¸¡ ëŒ€ì‚¬â€, ê·¸ë¦¬ê³  íŒ¨ë„ì— ë¶™ì´ê¸° */
.titleNpcWrap{
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 12px;

  margin-top: 10px;
  padding: 10px 12px;
  border-top: 1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.22);

  pointer-events: none;          /* í´ë¦­ ë°©í•´ X */
}

/* âœ… ëŒ€ì‚¬ ë°•ìŠ¤ ì œê±°: ë°°ê²½/í…Œë‘ë¦¬ ì—†ì• ê³  í…ìŠ¤íŠ¸ë§Œ */
.titleNpcTalk{
  flex: 1;
  max-width: calc(100% - 160px);
  padding: 0;
  background: transparent;
  border: none;

  color: #e7e7e7;
  text-align: left;
  text-shadow: 0 2px 6px rgba(0,0,0,0.85);
}
  
#titleNpcText{
  line-height: 1.35;
}
  
.titleNpcName{
  font-weight: 900;
  margin-bottom: 6px;
  opacity: 0.95;
}

/* âœ… NPCëŠ” ìš°ì¸¡í•˜ë‹¨ */
.titleNpcImg{
  width: 110px;                  /* âœ… ìƒì ì²˜ëŸ¼ â€˜ì‘ê³  ê·€ì—½ê²Œâ€™ */
  height: auto;
  object-fit: contain;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,0.65));
  pointer-events: none;
}
  
</style>
</head>

<body>

<!-- ğŸ” ë¡œê·¸ì¸ -->
<div id="loginScreen">
<h2>
  ğŸ” ë¡œê·¸ì¸
  <span style="font-size:0.7em; color:#888; margin-left:4px;">
    (v3.965)
  </span>
</h2>
  <input id="loginId" placeholder="ì•„ì´ë””"><br><br>
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><br><br>
  <button onclick="login()">ì ‘ì†</button>
</div>
  
<!-- ğŸ® ê²Œì„ -->
<div id="gameScreen" style="display:none;">
  <h1 class="game-title">
    <img
      src="images/ui/title_forge.png"
      alt="í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„"
      class="game-title-logo"
    >
  </h1>

<div id="updateNoticeBar"
     style="font-size:13px; color:#aaa; margin-top:4px; cursor:pointer; display:none;"
     onclick="openLatestNoticePopup()">
  / <span style="color:#ff5555; font-weight:bold;">[ê³µì§€]</span>
    <span id="updateNoticeTitle" style="margin-left:4px;">ì‹ ê·œ (v3.6) ì—…ë°ì´íŠ¸ í™•ì¸í•˜ê¸°</span> /
</div>

    <hr class="section-divider">
  
  <!-- ğŸ”¥ ì‚¬ëƒ¥í„° ë°°ê²½ ë°•ìŠ¤ (í”„ë¡œí•„~ë­í‚¹ ì „ì²´ë¥¼ ê°ìŒˆ) -->
  <div id="fieldBg" class="field-bg">

  <!-- ğŸ—º í˜„ì¬ ì‚¬ëƒ¥í„° ì •ë³´ (í”„ë¡œí•„ ì¹´ë“œ ë°”ê¹¥ ìƒë‹¨) -->
  <div id="currentFieldInfo" class="current-field-info"></div>

<!-- ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì¹´ë“œ -->
<div id="userProfileArea">
  <!-- ğŸ“· í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ -->
  <button class="profile-share-btn no-capture"
          onclick="saveProfileCard()"
          title="í”„ë¡œí•„ ì €ì¥">
    â¬‡ï¸
  </button>

  <!-- ğŸ”” ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ -->
  <div id="profileSaveStatus"
       class="profile-save-status no-capture"></div>

  <div class="profile-card-inner">
    <!-- ğŸ” ë‹‰ë„¤ì„ (ì¹´ë“œ ìµœìƒë‹¨) -->
    <div class="profile-nickname" id="profileNickname">-</div>
    
    <!-- âš”ï¸ ê²€ ì´ë¯¸ì§€ -->
    <div class="profile-weapon-box">
      <img id="weaponImage"
           src="images/weapons/sword_real_temp.png"
           alt="ë‚´ ë¬´ê¸°">
    </div>

    <!-- âš”ï¸ ê²€ ì´ë¦„ / ì„¤ëª… / ìŠ¤íƒ¯ -->
    <div class="profile-info-box">

      <!-- âœ… ê²€ ì´ë¦„ (+í˜„ì¬ ê°•í™”) -->
      <div class="profile-weapon-title" id="profileWeaponTitle">
        - (+0ê°•)
      </div>

      <hr class="profile-inner-divider">

      <!-- âœ… ê²€ ì„¤ëª… -->
      <div class="profile-weapon-desc" id="profileWeaponDesc">
        -
      </div>

      <hr class="profile-inner-divider">

      <!-- âœ… ìµœëŒ€ ê°•í™” + íŒŒê´´ íšŒìˆ˜ -->
      <div class="profile-row">
        <span class="profile-label">ìµœëŒ€ ê°•í™”</span>
        <span class="profile-value" id="profileMaxInfo">
          +0ê°• <span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ 0íšŒ)</span>
        </span>
      </div>

      <!-- ê¸°ì¡´ ìŠ¤íƒ¯ë“¤ ìœ ì§€ -->
      <div class="profile-row">
        <span class="profile-label">ì „íˆ¬ë ¥</span>
        <span class="profile-value" id="profilePower">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ê³¨ë“œ</span>
        <span class="profile-value" id="profileGold">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ë¬´ê¸°ê°€ì¹˜</span>
        <span class="profile-value" id="profileWeaponValue">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ì „ì </span>
        <span class="profile-value" id="profileRecord">ìŠ¹ 0 / íŒ¨ 0</span>
      </div>
    </div>
  </div>
</div>


  <hr class="section-divider">

   <!-- ğŸ”½ ë§µ ì†Œê°œ ë¬¸êµ¬ í‘œì‹œ ì˜ì—­ -->
<p id="fieldDescription"
   style="font-size:13px; color:#ccc; margin:10px 0 6px 0;"></p>

<hr class="section-divider">

    
  <!-- ê¸°ì¡´ ìƒíƒœ í‘œì‹œ -->
  <p id="status"></p>
<p id="upgradeInfo"
   style="font-size:14px; margin-top:4px; margin-bottom:8px; color:#ccc;">
</p>

<div class="action-buttons">
  <button id="upgradeBtn" onclick="upgrade()">ğŸ”¨ ê°•í™”</button>
  <button id="huntBtn" onclick="hunt()">âš”ï¸ ì‚¬ëƒ¥</button>
  <button id="sellBtn" onclick="sell()">ğŸ’° íŒë§¤</button>

  <!-- ğŸ›ï¸ 30ê°• ì „ìš©: ëª…ì˜ˆì˜ ì „ë‹¹ ë³´ë‚´ê¸° -->
  <button id="hallBtn"
          onclick="openHonorHallSendPopup()"
          style="display:none;">
    ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸°
  </button>
</div>

<p id="huntInfo" style="margin-top:4px; color:#ccc; font-size:13px;"></p>
    
<!-- ğŸ¯ ê°•í™” ì•„ì´í…œ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
<div id="upgradeItems" style="margin-top:8px; font-size:13px;">
  <label style="margin-right:8px;">
    <input type="checkbox" id="useScroll15">
    <span id="labelUseScroll15">15ê°• ê°•í™” ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useScroll21">
    <span id="labelUseScroll21">21ê°• ê°•í™” ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useProtect">
    <span id="labelUseProtect">íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useDownProtect">
    <span id="labelUseDownProtect">ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label>
    <input type="checkbox" id="useSuper">
    <span id="labelUseSuper">ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label>
    <input type="checkbox" id="useRateUp5">
    <span id="labelUseRateUp5">ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ (0)</span>
  </label>
</div>

  <hr>
    
  </div> <!-- ğŸ”š fieldBg : ë°°ê²½ì€ ì—¬ê¸°ê¹Œì§€ë§Œ -->
  
  <h2>ğŸ† ë­í‚¹ TOP 10</h2>
  <div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="myRank" style="margin-top:8px; font-size:14px; color:#ccc;"></div>

  <!-- ğŸŒˆ ëª…ì˜ˆì˜ ì „ë‹¹ -->
<div id="hallOfFameBox"
     style="margin:22px auto 0 auto; max-width:320px; border:1px solid #444; border-radius:8px; padding:8px;"
  <div style="font-weight:bold; margin-bottom:6px; text-align:center;">
    ğŸŒˆ ëª…ì˜ˆì˜ ì „ë‹¹
  </div>
  <div id="hallOfFameList"
       style="font-size:12px; color:#ddd; max-height:180px; overflow-y:auto;">
    ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
  </div>
</div>

  <!-- ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ëœ¨ëŠ” ì‘ì€ ë©”ë‰´ -->
<div id="rankProfileMenu">
  <button id="rankProfileViewBtn">ğŸ‘ í”„ë¡œí•„ ë³´ê¸°</button>
</div>

<!-- ğŸ“¢ ì—…ë°ì´íŠ¸ ê³µì§€ íŒì—… -->
<div id="updateNoticeOverlay" onclick="closeUpdateNoticePopup()">
  <div class="update-notice-box" onclick="event.stopPropagation()">
    <div class="update-notice-title" id="updateNoticePopupTitle"></div>
    <div class="update-notice-content" id="updateNoticePopupContent"></div>

    <div class="update-notice-nav">
      <button onclick="showPrevNotice()">â—€ ì´ì „</button>
      <span id="updateNoticeIndexLabel"></span>
      <button onclick="showNextNotice()">ë‹¤ìŒ â–¶</button>
    </div>

    <button style="margin-top:8px; width:100%; padding:6px 0;"
            onclick="closeUpdateNoticePopup()">
      ë‹«ê¸°
    </button>
  </div>
</div>
  
</div> <!-- ğŸ”š gameScreen -->

<button id="attendanceBtn" onclick="checkAttendance()">ì¶œì„</button>

  <button id="couponBtn" onclick="openCouponPopup()">ì¿ í°</button>

  <button id="achievementBtn" onclick="openTitleOverlay()">ì—…ì </button>

  <button id="logoutBtn" onclick="logout()" style="
  position:fixed;
  top:10px;
  left:10px;
  z-index:1101;
  display:none;
  font-size:14px;
  padding:6px 14px;
">
  ë¡œê·¸ì•„ì›ƒ
</button>
  
<!-- ğŸ”” ë¡œê·¸ -->
<div id="toastLog"><div id="toastList"></div></div>

<button id="mapBtn"
        class="side-menu-btn"
        onclick="toggleMap()">
  ğŸ—º MAP
</button>

<!-- ğŸ“œ ìŠ¤í¬ë¡¤ ìƒì  ë²„íŠ¼ (MAPê³¼ ê²°íˆ¬ì¥ ì‚¬ì´) -->
<button id="scrollShopBtn"
        class="side-menu-btn"
        onclick="openScrollShop()">
  ğŸ“œ ìŠ¤í¬ë¡¤ ìƒì 
</button>
  
<!-- âš”ï¸ ê²°íˆ¬ì¥ ë²„íŠ¼ (MAPê³¼ ì¸ë²¤í† ë¦¬ ì‚¬ì´) -->
<button id="duelBtn"
        class="side-menu-btn"
        onclick="openDuelArena()">
  âš”ï¸ ê²°íˆ¬ì¥
</button>
  
  <!-- ğŸ’ ì¸ë²¤í† ë¦¬ ë²„íŠ¼ (ë¡œê·¸ ë²„íŠ¼ ìœ„) -->
<button id="inventoryBtn"
        class="side-menu-btn"
        onclick="toggleInventory()">
  ğŸ’ ì¸ë²¤í† ë¦¬
</button>

  <button id="userListBtn"
        class="side-menu-btn"
        onclick="openUserListOverlay()">
  ğŸ‘¥ ì „ì²´ ìœ ì €
</button>
  
<button id="logToggle" onclick="toggleLog()" style="
  position:fixed;
  bottom:80px;
  right:10px;
  z-index:1001;
  display:none;
">
  ğŸ“œ ë¡œê·¸
</button>

<!-- ğŸ—º MAP íŒ¨ë„ -->
<div id="mapPanel">
  <h3>ğŸ—º ì‚¬ëƒ¥í„° ì„ íƒ</h3>
  <div id="mapList"></div>
</div>
  
<!-- ğŸ’ ì¸ë²¤í† ë¦¬ íŒ¨ë„ -->
<div id="inventoryPanel" style="
  position:fixed;
  right:140px;
  top:60px;
  width:260px;
  max-height:60%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1002;
  display:none;
  text-align:left;
  font-size:14px;
">
  <h3>ğŸ’ ì¸ë²¤í† ë¦¬</h3>
  <div id="inventoryList"></div>
</div>

<!-- ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì˜¤ë²„ë ˆì´ -->
<div id="userListOverlay"
     style="
       position:fixed;
       inset:0;
       background:rgba(0,0,0,0.6);
       display:none;
       z-index:1190;
     "
     onclick="if (event.target === this) closeUserListOverlay();">

  <div id="userListPanel"
       style="
         position:absolute;
         left:50%;
         top:50%;
         transform:translate(-50%, -50%);
         width:640px;
         max-width:calc(100% - 40px);
         max-height:80%;
         background:#111;
         border:1px solid #666;
         border-radius:10px;
         padding:12px 14px;
         color:#fff;
         box-shadow:0 0 20px rgba(0,0,0,0.9);
         display:flex;
         flex-direction:column;
       "
       onclick="event.stopPropagation();">

    <!-- ìƒë‹¨ í—¤ë” -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
      <div>
        <div style="font-size:16px; font-weight:bold;">ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡</div>
        <div id="userListCount"
             style="font-size:12px; color:#ccc; margin-top:2px;">
          ëª¨í—˜ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
      </div>
      <button style="font-size:12px; padding:4px 8px;"
              onclick="closeUserListOverlay()">
        ë‹«ê¸°
      </button>
    </div>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div style="display:flex; gap:6px; align-items:center; margin-bottom:6px;">
      <input id="userListSearch"
             type="text"
             placeholder="ì•„ì´ë”” ê²€ìƒ‰"
             style="
               flex:1;
               padding:4px 8px;
               background:#000;
               border:1px solid #444;
               border-radius:4px;
               color:#fff;
               font-size:13px;
             "
             oninput="applyUserListSearch()"
      />
      <button style="font-size:12px; padding:4px 8px;"
              onclick="document.getElementById('userListSearch').value=''; applyUserListSearch();">
        ì´ˆê¸°í™”
      </button>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ ë³¸ë¬¸ -->
    <div id="userListBody"
         style="
           flex:1;
           border:1px solid #333;
           border-radius:6px;
           padding:6px;
           overflow-y:auto;
           font-size:13px;
         ">
      <!-- JSë¡œ ì±„ì›Œì§ -->
      <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...
      </div>
    </div>

  </div>
</div>
  
<!-- âš”ï¸ ê²°íˆ¬ì¥ ì¤‘ì•™ íŒì—… ì˜¤ë²„ë ˆì´ -->
<div id="duelArenaOverlay"
     style="
       position:fixed;
       inset:0;
       background:rgba(0,0,0,0.6);
       display:none;
       z-index:1200;
     "
     onclick="if (event.target === this) closeDuelArena();">
  <!-- ì‹¤ì œ ê²°íˆ¬ì¥ íŒ¨ë„ -->
  <div id="duelArenaPanel"
       style="
         position:absolute;
         left:50%;
         top:50%;
         transform:translate(-50%, -50%);
         width:520px;
         max-width:calc(100% - 40px);
         background:#111;
         border:1px solid #666;
         border-radius:10px;
         padding:12px 14px;
         color:#fff;
         box-shadow:0 0 20px rgba(0,0,0,0.9);
         font-size:14px;
       "
       onclick="event.stopPropagation();">
    
    <!-- ìƒë‹¨ í—¤ë” -->
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
  <div>
    <div style="font-size:16px; font-weight:bold;">âš”ï¸ ê²°íˆ¬ì¥</div>
    <div id="duelRemainText"
         style="font-size:12px; color:#ccc; margin-top:2px;">
      ì˜¤ëŠ˜ ë‚¨ì€ ê²°íˆ¬: 10/10
    </div>
  </div>
  <div style="display:flex; gap:4px;">
    <button style="font-size:11px; padding:2px 6px;"
            onclick="openDuelHistoryPopup()">
      ì§€ë‚œ ë­í‚¹
    </button>
    <button style="font-size:11px; padding:2px 6px;"
            onclick="openDuelHelpPopup()">
      ?
    </button>
    <button style="font-size:11px; padding:2px 6px;"
            onclick="closeDuelArena()">
      ë‚˜ê°€ê¸°
    </button>
  </div>
</div>

    <!-- ë­í‚¹ ë°•ìŠ¤ -->
    <div style="border:1px solid #444; border-radius:6px; padding:8px; margin-bottom:8px;">
      <div style="font-weight:bold; text-align:center; margin-bottom:4px;">
        ğŸ† ê²°íˆ¬ì¥ ë­í‚¹
      </div>
      <div id="duelArenaRankList"
           style="max-height:260px; overflow-y:auto; font-size:13px;">
        <!-- ë‚˜ì¤‘ì— ê²°íˆ¬ í¬ì¸íŠ¸ ë­í‚¹ ë Œë”ë§ ì˜ˆì • -->
      </div>
      <div id="duelArenaMyRank"
           style="margin-top:6px; font-size:12px; color:#aaa; text-align:right;">
        <!-- ë‚´ ë­í‚¹ ì •ë³´ -->
      </div>
    </div>

    <!-- í•˜ë‹¨: ì¢Œì¸¡ ë²„íŠ¼ë“¤ / ìš°ì¸¡ ì¹´ë¥´ë‹ˆì•„ -->
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
      <!-- ì¢Œì¸¡: ê²°íˆ¬ ë²„íŠ¼ë“¤ -->
      <div>
<button onclick="openDuelTargetPanel()"
        data-duel-target
        style="display:block; margin-bottom:6px; padding:6px 10px; font-size:14px; width:180px;">
  ğŸ¯ ê²°íˆ¬í•˜ê¸° (ì§€ì •ë§¤ì¹­)
</button>

        <button onclick="handleRandomMatchFromArena()"
                style="display:block; padding:6px 10px; font-size:14px; width:180px;">
          ğŸ² ëœë¤ë§¤ì¹­
        </button>
      </div>

      <!-- ìš°ì¸¡: ì¹´ë¥´ë‹ˆì•„ -->
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <img src="images/npc/duel_carnia.png"
             alt="ê²°íˆ¬ ì‹¬íŒê´€ ì¹´ë¥´ë‹ˆì•„"
             style="width:78px; height:auto; border-radius:6px;">
        <div style="font-size:12px; color:#ddd; max-width:220px; line-height:1.4;">
          <div style="font-weight:bold; margin-bottom:2px;">
            ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸
          </div>
          <div>
            ëœë¤ ë§¤ì¹­ì€ ê²ìŸì´ì—ê²ŒëŠ” ë…,  
            ì§„ì§œ ë„ì „ìì—ê²ŒëŠ” <span style="color:#ffcc66;">ì¶”ê°€ ë³´ìƒ</span>ì´ ë˜ì§€.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
  
  <!-- âš”ï¸ ê²°íˆ¬ íŒ¨ë„ -->
<div id="duelPanel" style="
  position:absolute;
  width:260px;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  border-radius:8px;
  padding:10px;
  z-index:1300;
  display:none;
">

  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
    <div style="font-weight:bold; font-size:15px;">âš”ï¸ ê²°íˆ¬</div>
    <!-- â¬… ì°½ ì¢Œìƒë‹¨(ì— ê°€ê¹Œìš´ ìª½)ì— Xë²„íŠ¼ -->
    <button onclick="toggleDuelPanel()" style="font-size:11px; padding:2px 6px;">X</button>
  </div>

  <div style="margin-bottom:6px;">
    <input id="duelSearchInput"
           type="text"
           placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰"
           oninput="onDuelSearchChange(this.value)"
           style="width:100%; box-sizing:border-box; padding:4px 6px; font-size:13px;">
  </div>

  <div id="duelHelpText" style="font-size:12px; color:#aaa; margin-bottom:4px;">
    ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ìƒìœ„ ë­í‚¹ ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
  </div>

  <div id="duelList"></div>

</div>
  
<div id="logPanel">
  <h3>ğŸ“¢ ê°•í™” ë¡œê·¸</h3>
  <div id="logPanelList"></div>
</div>

  <!-- ğŸ“œ ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì  ì˜¤ë²„ë ˆì´ -->
<div id="scrollShopOverlay"
     style="
       position:fixed;
       inset:0;
       background:rgba(0,0,0,0.6);
       display:none;
       z-index:1200;
     "
     onclick="if (event.target === this) closeScrollShop();">

  <!-- ì‹¤ì œ ìƒì  íŒ¨ë„ -->
  <div id="scrollShopPanel"
       style="
         position:absolute;
         left:50%;
         top:50%;
         transform:translate(-50%, -50%);
         width:520px;
         max-width:calc(100% - 40px);
         background:#111;
         border:1px solid #666;
         border-radius:10px;
         padding:12px 14px;
         color:#fff;
         box-shadow:0 0 20px rgba(0,0,0,0.9);
         font-size:14px;
       "
       onclick="event.stopPropagation();">

    <!-- ìƒë‹¨ í—¤ë” -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
      <div style="font-weight:bold; font-size:16px;">
        ğŸ“œ ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì 
      </div>
      <button onclick="closeScrollShop()"
              style="background:#333; border:1px solid #555; color:#fff;
                     font-size:12px; padding:4px 8px; border-radius:4px; cursor:pointer;">
        ë‹«ê¸° âœ•
      </button>
    </div>

    <!-- ìƒë‹¨ ì¬í™” í‘œì‹œ -->
    <div style="display:flex; gap:12px; margin-bottom:8px; font-size:12px;">
      <div style="display:flex; align-items:center; gap:4px;">
        <img src="images/items/star_shard.png" style="width:18px; height:18px;" alt="">
        <span>ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê° :</span>
        <span id="scrollShopStarShard">0</span>
      </div>
      <div style="display:flex; align-items:center; gap:4px;">
        <img src="images/items/medal_honor.png" style="width:18px; height:18px;" alt="">
        <span>ëª…ì˜ˆì˜ í›ˆì¥ :</span>
        <span id="scrollShopHonorMedal">0</span>
      </div>
    </div>

    <!-- ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
    <div id="scrollShopItemList"
         style="border:1px solid #444; border-radius:6px; padding:4px;
                max-height:220px; overflow-y:auto; margin-bottom:8px;">
      <!-- JSë¡œ í•œ ì¤„ì”© ì±„ìš¸ ì˜ˆì • -->
    </div>

    <!-- í•˜ë‹¨: ì¢Œì¸¡ ì—¬ìœ  / ìš°ì¸¡ ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì¸ (ê²°íˆ¬ì¥ ë ˆì´ì•„ì›ƒ ëŠë‚Œ) -->
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px; margin-top:4px;">
      <!-- ì¢Œì¸¡ì€ ì—¬ìœ  ì˜ì—­ (ë‚˜ì¤‘ì— ì•ˆë‚´ë¬¸ ë„£ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì—) -->
      <div style="flex:1;"></div>

      <!-- ìš°ì¸¡: ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì¸ -->
      <div style="display:flex; align-items:flex-end; gap:12px;">

  <!-- ğŸ—¨ ëŒ€ì‚¬(ì™¼ìª½) -->
  <div style="font-size:12px; line-height:1.5; max-width:300px; text-align:right;">
    <div style="font-weight:bold; margin-bottom:4px;">
      ì„¸ë ˆë‚˜ ì—ë¸ë¦°
    </div>
    <div id="scrollShopNpcText"></div>
  </div>

  <!-- ğŸ§™â€â™‚ï¸ NPC (ì˜¤ë¥¸ìª½ / 2ë°° í™•ëŒ€) -->
  <img id="scrollShopNpcImg"
       src="images/npc/npc_scrollshop_idle.png"
       style="width:156px; height:auto; border-radius:10px;">
</div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- í”„ë¡œí•„ ì¹´ë“œ ìº¡ì³ìš© html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  authDomain:"sword-game-1d1a1.firebaseapp.com",
  databaseURL:"https://sword-game-1d1a1-default-rtdb.firebaseio.com",
  projectId:"sword-game-1d1a1"
});
const db = firebase.database();
const logRef = db.ref("logs");
const globalEventsRef = db.ref("globalEvents");

  // ğŸŒ™ +30 ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ í‚¤
const GLOBAL30_KEY = "latest30";

// ğŸŒ™ ê²½ì™¸ ë¬¸êµ¬(1ì¸ 1íšŒ ëœë¤)
const AWE_MESSAGES = [
  "ê·¸ ê²€ ëì—ì„œâ€¦ ë³„ì´ íƒœì–´ë‚¬ë‹¤. â˜…",
  "30ê°•ì€ ìš°ì—°ì´ ì•„ë‹ˆë¼, ì§‘ë…ì´ ì¦ëª…ëœ ìë¦¬ì˜€ë‹¤.",
  "í¼ê·¸ë€íŠ¸ì˜ ë¶ˆê½ƒì´ ì˜¤ëŠ˜, ì „ì„¤ì„ í•˜ë‚˜ ë” ë§Œë“¤ì—ˆë‹¤.",
  "ë‚˜ëŠ” ë³´ì•˜ë‹¤. ê°•í™”ì˜ ëì—ì„œ í”ë“¤ë¦¬ì§€ ì•Šì€ ì†ì„.",
  "ê·¸ ì´ë¦„ì„ ê¸°ì–µí•˜ë¼. ìš°ë¦¬ì˜ í•˜ëŠ˜ì— ìƒˆê²¨ì§„ ì²« ë¬¸ì¥ì´ë‹¤.",
  "ê²€ì´ ì•„ë‹ˆë¼, ì˜ì§€ê°€ ë¹›ë‚¬ë‹¤.",
  "ì˜¤ëŠ˜ì˜ ê¸°ë¡ì€ ë‚´ì¼ì˜ ê¸°ì¤€ì´ ëœë‹¤. ê²½ì™¸ë¥¼.",
  "ë³„ì€ ì•„ë¬´ì—ê²Œë‚˜ ë¶™ì§€ ì•ŠëŠ”ë‹¤. ì˜¤ì§ ë‹¬ì„±í•œ ìì—ê²Œë§Œ.",
  "ì´ê²ƒì´ â€˜ëâ€™ì´ë¼ë©´â€¦ ì–¼ë§ˆë‚˜ ì•„ë¦„ë‹¤ìš´ ëì¸ê°€.",
  "ê²½ì™¸í•œë‹¤. ê·¸ë¦¬ê³  ë”°ë¼ê°€ê² ë‹¤. ì–¸ì  ê°€ ë‚˜ë„ ê·¸ ìë¦¬ì—."
];

// âœ… +30 ì¶•í•˜ ë¡œê·¸(3ì¤„ ë„íŠ¸ì•„íŠ¸) ë§Œë“¤ê¸°
function build30CongratsLogLines(nick, weaponName) {
  return [
    "âœ¦âœ§âœ¦âœ§âœ¦  ğŸŒŒ  [ +30  ë‹¬ ì„± ]  ğŸŒŒ  âœ¦âœ§âœ¦âœ§âœ¦",
    `â˜…  ${nick} â”ƒ ${weaponName} +30 â”ƒ í¼ê·¸ë€íŠ¸ì˜ ê¸°ë¡ì´ ë¹›ë‚©ë‹ˆë‹¤  âœ¨`
  ];
}

// âœ… ê¸€ë¡œë²Œ +30 ì´ë²¤íŠ¸ ë°œí–‰(ë§ˆì§€ë§‰ 1ê°œë§Œ ìœ ì§€)
function publishGlobal30Event(winnerId, winnerNick, weaponName, weaponType) {
  const eventId = Date.now();
  const payload = {
    id: eventId,
    winnerId: winnerId || "",
    winnerNick: winnerNick || "",
    weaponName: weaponName || "",
    weaponType: weaponType || "",
    time: eventId
  };
  globalEventsRef.child(GLOBAL30_KEY).set(payload);
  return eventId;
}

// âœ… +30 ì˜¤ë²„ë ˆì´ ì—´ê¸°
function openGlobal30Overlay(payload) {
  const overlay = document.getElementById("global30Overlay");
  if (!overlay) return;

  const titleEl = document.getElementById("global30Title");
  const descEl  = document.getElementById("global30Desc");

  const nick = payload?.winnerNick || "ëˆ„êµ°ê°€";
  const weaponName = payload?.weaponName || "ë¬´ê¸°";

  if (titleEl) titleEl.innerHTML = `ğŸŒŒ ${nick} ë‹˜ì´ 30ê°• ë‹¬ì„±ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤!`;
  if (descEl) descEl.textContent =
`í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ì— ìƒˆë¡œìš´ ìš°ì£¼ì˜ ì§ˆì„œê°€ ê¸°ë¡ë©ë‹ˆë‹¤.

ë‹¬ì„± ë¬´ê¸°: ${weaponName} +30`;

  overlay.style.display = "block";
}

// âœ… +30 ì˜¤ë²„ë ˆì´ ë‹«ê¸° + â€˜ë´¤ìŒâ€™ ì €ì¥
function closeGlobal30Overlay() {
  const overlay = document.getElementById("global30Overlay");
  if (overlay) overlay.style.display = "none";

  // í˜„ì¬ ë– ìˆëŠ” ì´ë²¤íŠ¸ë¥¼ â€œë´¤ìŒâ€ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ latest30ì„ ë‹¤ì‹œ ì½ì–´ì„œ ì €ì¥
  globalEventsRef.child(GLOBAL30_KEY).once("value").then(snap => {
    const v = snap.val() || {};
    const id = Number(v.id || 0);
    if (id > 0) {
      lastSeenGlobal30EventId = id;
      save(); // âš ï¸ save()ì— í•„ë“œ ì¶”ê°€ë„ ì•„ë˜ì—ì„œ ì•ˆë‚´í• ê±°ì•¼
    }
  });
}

// âœ… +30 ì´ë²¤íŠ¸ êµ¬ë…: ì•ˆ ë³¸ ìœ ì €ë§Œ ì˜¤ë²„ë ˆì´ + ì¶•í•˜ ë¡œê·¸ + ê²½ì™¸ ë²„íŠ¼ ë¡œê·¸
function subscribeGlobal30Events() {
  globalEventsRef.child(GLOBAL30_KEY).on("value", (snap) => {
    const v = snap.val();
    if (!v) return;

    const eventId = Number(v.id || 0);
    if (!eventId) return;

// 1) ì¶•í•˜ ë¡œê·¸: "ê¸°ì¡´ ì‹¤ì‹œê°„ ë¡œê·¸"ì— 1ê°œë§Œ ë‚¨ê¸°ê¸°(ì¤„ë°”ê¿ˆìœ¼ë¡œ 2ì¤„)
if (lastSeenGlobal30EventId !== eventId) {
  try {
    const nick = v.winnerNick || "ëˆ„êµ°ê°€";
    const weaponName = v.weaponName || "ë¬´ê¸°";

    const msg =
      `${nick}ì´ +30ê°•ì˜ ë²½ì„ ëŒíŒŒí•˜ì—¬ +30ê°•ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!<br>` +
      `ê·¸ ìš©ê¸°ì— í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ì´ ë°•ìˆ˜ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.`;

    // âœ… DBì— ë‚¨ëŠ” ì‹¤ì‹œê°„ ë¡œê·¸ 1ê°œ (5ì¤„ ì œí•œ UIëŠ” ê¸°ì¡´ ë¡œì§ì´ ì´ë¯¸ ì²˜ë¦¬)
    writeLog(msg, false, {
      isReach30: true,
      global30EventId: eventId,
      winnerNick: nick,
      weaponName: weaponName
    });
  } catch(e) {}

  // 2) ì€ë¹› ì˜¤ë²„ë ˆì´(ì•ˆ ë³¸ ì‚¬ëŒë§Œ)
  openGlobal30Overlay(v);

  // âœ… "ë´¤ìŒ" ì²˜ë¦¬(ì¤‘ë³µ ì¶œë ¥ ë°©ì§€)
  lastSeenGlobal30EventId = eventId;
  save();
}
  });
}

// âœ… (í•„ìˆ˜) ì‹œìŠ¤í…œ í† ìŠ¤íŠ¸ í‘¸ì‹œ í•¨ìˆ˜: 3958ì˜ í† ìŠ¤íŠ¸/ë¡œê·¸ ë°©ì‹ì— ë§ì¶° â€œí•œ ì¤„â€ ì¶”ê°€
function pushSystemToast(text, extraClass) {
  const toastLog = document.getElementById("toastLog");
  if (!toastLog) return;

  const div = document.createElement("div");
  div.className = `toast-item ${extraClass || ""}`;
  div.textContent = text;

  toastLog.prepend(div);

  // ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìœ„ì—ì„œ ì˜ë¼ë‚´ê¸°
  while (toastLog.children.length > 50) {
    toastLog.removeChild(toastLog.lastChild);
  }
}

// âœ… ê²½ì™¸í•˜ê¸° ë²„íŠ¼ í† ìŠ¤íŠ¸(1ì¸ 1íšŒ)
function pushAweToast(eventId, winnerNick) {
  const toastLog = document.getElementById("toastLog");
  if (!toastLog) return;

  const row = document.createElement("div");
  row.className = "toast-item toast-awe";

  const left = document.createElement("span");
  left.textContent = `ğŸ™ ${winnerNick} ë‹˜ì˜ ì—…ì ì— ê²½ì™¸ë¥¼ ë°”ì¹©ë‹ˆë‹¤.`;

  const btn = document.createElement("button");
  btn.textContent = "ê²½ì™¸í•˜ê¸°";
  btn.style.marginLeft = "10px";
  btn.onclick = () => {
    // 1ì¸ 1íšŒ ì œí•œ
    if (Number(aweUsedGlobal30EventId || 0) === Number(eventId)) {
      alert("ì´ë¯¸ ê²½ì™¸ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤.");
      return;
    }
    aweUsedGlobal30EventId = Number(eventId);

    // ëœë¤ ë¬¸êµ¬
    const msg = AWE_MESSAGES[Math.floor(Math.random() * AWE_MESSAGES.length)];
    // ë¡œê·¸ì— í•œ ì¤„ ì¶”ê°€(ì‹œìŠ¤í…œ í† ìŠ¤íŠ¸)
    pushSystemToast(`â˜… ê²½ì™¸: ${msg}`, "toast-awe-msg");

    save(); // ìœ ì €ì— ì €ì¥
    btn.disabled = true;
  };

  row.appendChild(left);
  row.appendChild(btn);
  toastLog.prepend(row);
}


  
function getTutorialKeyForUser(id) {
  return `swordGameTutorialSeen_${id}`;
}

// ğŸ•’ NEW í‘œì‹œ ê¸°ì¤€ (24ì‹œê°„)
function isNoticeNew(createdAt) {
  if (!createdAt) return false;
  const DAY_24H = 24 * 60 * 60 * 1000;
  return (Date.now() - Number(createdAt)) < DAY_24H;
}
  
  // ğŸ”” ì—…ë°ì´íŠ¸ ê³µì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadUpdateNotices() {
  const ref = db.ref("updateNotices");

  ref
    .orderByChild("createdAt")
    .limitToLast(20)        // ìµœê·¼ 20ê°œê¹Œì§€ë§Œ
    .once("value")
    .then((snap) => {
      updateNotices = [];
      snap.forEach((child) => {
        const v = child.val() || {};
        updateNotices.push({
          id: child.key,
          title: v.title || "",
          content: v.content || "",
          createdAt: v.createdAt || 0
        });
      });

      if (!updateNotices.length) {
        return;
      }

      // ìµœì‹  ê³µì§€ëŠ” ë°°ì—´ ë§ˆì§€ë§‰
      currentNoticeIndex = updateNotices.length - 1;
      const latest = updateNotices[currentNoticeIndex];

      const bar = document.getElementById("updateNoticeBar");
      const titleEl = document.getElementById("updateNoticeTitle");

      if (bar && titleEl) {
const isNew = isNoticeNew(latest.createdAt);

titleEl.innerHTML = `
  ${latest.title || "ì‹ ê·œ ì—…ë°ì´íŠ¸ í™•ì¸í•˜ê¸°"}
  ${isNew ? '<span class="badge-new">NEW</span>' : ''}
`;

bar.style.display = "block";
      }
    })
    .catch((err) => {
      console.error("[updateNotices] load error", err);
    });
}

  // â± 1ì‹œê°„ ìë™ ìƒˆë¡œê³ ì¹¨ (ms ë‹¨ìœ„)
const AUTO_REFRESH_MS = 60 * 60 * 1000; // 1ì‹œê°„
let autoRefreshTimer = null;

// ë¡œê·¸ì¸ í›„ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì‹œì‘
function startAutoRefreshTimer() {
  // í˜¹ì‹œ ê¸°ì¡´ íƒ€ì´ë¨¸ ìˆìœ¼ë©´ ì •ë¦¬
  if (autoRefreshTimer) {
    clearTimeout(autoRefreshTimer);
  }

  autoRefreshTimer = setTimeout(() => {
    // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì €ì¥ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë¨¼ì € ë„ì›Œë„ ë¨
    // alert("ì•ˆì •ì ì¸ ì—…ë°ì´íŠ¸ ì ìš©ì„ ìœ„í•´ ê²Œì„ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤.");
    location.reload(); // ìµœì‹  ë²„ì „ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨
  }, AUTO_REFRESH_MS);
}

// ë¡œê·¸ì•„ì›ƒ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬ (ì˜µì…˜ì´ì§€ë§Œ ê¹”ë”í•˜ê²Œ)
function stopAutoRefreshTimer() {
  if (autoRefreshTimer) {
    clearTimeout(autoRefreshTimer);
    autoRefreshTimer = null;
  }
}

  function openLatestNoticePopup() {
  if (!updateNotices.length) return;

  // í•­ìƒ ìµœì‹  ê³µì§€ë¶€í„° ì—´ê¸°
  currentNoticeIndex = updateNotices.length - 1;
  showNoticeAt(currentNoticeIndex);

  const overlay = document.getElementById("updateNoticeOverlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}

function closeUpdateNoticePopup() {
  const overlay = document.getElementById("updateNoticeOverlay");
  if (overlay) {
    overlay.style.display = "none";
  }
}

function showNoticeAt(idx) {
  if (!updateNotices.length) return;
  if (idx < 0 || idx >= updateNotices.length) return;

  const n = updateNotices[idx];

  const titleEl   = document.getElementById("updateNoticePopupTitle");
  const contentEl = document.getElementById("updateNoticePopupContent");
  const idxLabel  = document.getElementById("updateNoticeIndexLabel");

  if (!titleEl || !contentEl || !idxLabel) return;

const isNew = isNoticeNew(n.createdAt);

titleEl.innerHTML = `
  ${n.title || "(ì œëª© ì—†ìŒ)"}
  ${isNew ? '<span class="badge-new">NEW</span>' : ''}
`;

  let content = n.content || "";

  // 1) "...\n..." ì²˜ëŸ¼ ì €ì¥ëœ ê²½ìš° â†’ ì‹¤ì œ ê°œí–‰ìœ¼ë¡œ ë³€í™˜
  if (content.indexOf("\\n") >= 0) {
    content = content.replace(/\\n/g, "\n");
  }

  // 2) ì‹¤ì œ ì¤„ë°”ê¿ˆì´ ë“¤ì–´ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (pre-lineì´ ì²˜ë¦¬)
  contentEl.textContent = content;
  
  idxLabel.textContent  = `${idx + 1} / ${updateNotices.length}`;

  currentNoticeIndex = idx;
}

function showPrevNotice() {
  if (!updateNotices.length) return;
  const next = Math.max(0, currentNoticeIndex - 1);
  showNoticeAt(next);
}

function showNextNotice() {
  if (!updateNotices.length) return;
  const next = Math.min(updateNotices.length - 1, currentNoticeIndex + 1);
  showNoticeAt(next);
}

// ğŸ”° ê°•í™” ë‹¨ê³„ë³„ ê²€ ì´ë¦„ / ì„¤ëª… / ì´ë¯¸ì§€ ê²½ë¡œ
const WEAPON_INFO = {
  0: {
    name: "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´",
    desc: "ì•„ì§ ì•„ë¬´ê²ƒë„ ë˜ì§€ ëª»í–ˆì§€ë§Œ, ì„¸ìƒ ì–´ë””ì—ë„ ì—†ëŠ” ê°€ëŠ¥ì„±ì„ ì¡°ìš©íˆ í’ˆê³  ìˆë‹¤.",
    img: "images/weapons/sword_00.png"
  },
  1: {
    name: "ë¶€ëŸ¬ì§„ ê²€",
    desc: "ì˜ê´‘ì˜ ê¸°ì–µë§Œ ë‚¨ì€ ì±„, ë”ëŠ” ëˆ„êµ¬ë„ ì°¾ì§€ ì•ŠëŠ” ìŠ¬í”ˆ ì”í•´ë‹¤.",
    img: "images/weapons/sword_01.png"
  },
  2: {
    name: "ê¸ˆì´ ê°„ ê²€",
    desc: "ì¡°ê¸ˆë§Œ í˜ì„ ì£¼ì–´ë„ ì‚°ì‚°íˆ í©ì–´ì§ˆ ê²ƒì²˜ëŸ¼, ìœ„íƒœë¡­ê²Œ ìˆ¨ì„ ë¶™ë“¤ê³  ìˆë‹¤.",
    img: "images/weapons/sword_02.png"
  },
  3: {
    name: "ë…¹ìŠ¨ ê²€",
    desc: "ì„¸ì›”ì˜ ë°”ëŒì„ ê²¬ë””ì§€ ëª»í•´, í•œë•Œì˜ ê´‘ì±„ë¥¼ ì„œì„œíˆ ìƒì–´ë²„ë ¸ë‹¤.",
    img: "images/weapons/sword_03.png"
  },
  4: {
    name: "ë‚¡ì€ ê²€",
    desc: "ìˆ˜ë§ì€ ì‹¸ì›€ì˜ í”ì ë§Œì´ ë‚¨ì•„, ì¡°ìš©íˆ ì‰¼ì„ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.",
    img: "images/weapons/sword_04.png"
  },
  5: {
    name: "í™ë¨¼ì§€ì— ë®ì¸ ê²€",
    desc: "ê¸´ ì  ì†ì—ì„œë„, ì–¸ì  ê°€ ë‹¤ì‹œ ë¶ˆë¦´ ì´ë¦„ì„ ê¿ˆê¾¸ê³  ìˆë‹¤.",
    img: "images/weapons/sword_05.png"
  },
  6: {
    name: "ì˜ ë²¼ë ¤ì§„ ê²€",
    desc: "ì¥ì¸ì˜ ìˆ¨ê²°ì„ ë¨¸ê¸ˆê³ , ì´ì œì•¼ ë¹„ë¡œì†Œ í•œ ìë£¨ì˜ ê²€ì´ ëœë‹¤.",
    img: "images/weapons/sword_06.png"
  },
  7: {
    name: "ë‹¨ë‹¨íˆ ì—°ë§ˆëœ ì „íˆ¬ê²€",
    desc: "ì „ì¥ì„ í–¥í•œ ë‘ë ¤ì›€ê³¼ ê°ì˜¤ê°€, ë‚  ìœ„ì— ê³ ìš”íˆ ë‚´ë ¤ì•‰ëŠ”ë‹¤.",
    img: "images/weapons/sword_07.png"
  },
  8: {
    name: "ê²°ì˜ì˜ ì¥ê²€",
    desc: "í•œ ë²ˆ ë½‘ì•„ ë“¤ì—ˆë‹¤ë©´, ê²°ì½” ë¬¼ëŸ¬ì„œì§€ ì•Šê² ë‹¤ëŠ” ì˜ì§€ê°€ ê¹ƒë“ ë‹¤.",
    img: "images/weapons/sword_08.png"
  },
  9: {
    name: "ê³ ê·€í•œ ê¸°ì‚¬ì˜ ê²€",
    desc: "ëª…ì˜ˆì™€ ì±…ì„ì„ í•¨ê»˜ ì§Šì–´ì§„, í’ˆìœ„ ìˆëŠ” ì „ì¥ì˜ ë™ë°˜ìë‹¤.",
    img: "images/weapons/sword_09.png"  // ğŸ‘‰ ì§€ê¸ˆ ë„¤ê°€ í™•ì •í•œ 9ê°• ì´ë¯¸ì§€
  },
  10: {
    name: "ì„œì•½ì„ ì§€ë‹Œ ì„±ì „ì˜ ê²€",
    desc: "ì§€ì¼œì•¼ í•  ì´ë¦„ì´ ìƒê¸´ ìˆœê°„, ì´ ê²€ì€ ê¸°ë„ì²˜ëŸ¼ íœ˜ë‘˜ëŸ¬ì§„ë‹¤.",
    img: "images/weapons/sword_10.png"
  },
  11: {
    name: "ìš©ë§¹ì˜ ì„œê´‘ê²€",
    desc: "ëˆ„êµ¬ë³´ë‹¤ ë¨¼ì € ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ëŠ” ì´ì˜, ëœ¨ê±°ìš´ ìš©ê¸°ë¥¼ ë¹„ì¶˜ë‹¤.",
    img: "images/weapons/sword_11.png"
  },
  12: {
    name: "ì€ë¹› ì‹¬íŒì˜ ê²€",
    desc: "ì°¨ê°€ìš´ ì¹¼ë‚  ìœ„ì—ì„œ, ì˜³ê³  ê·¸ë¦„ì´ ì¡°ìš©íˆ ê°ˆë¼ì§„ë‹¤.",
    img: "images/weapons/sword_12.png"
  },
  13: {
    name: "ì„±ë²½ì„ ìˆ˜í˜¸í•˜ëŠ” ê²€",
    desc: "ì¹¨ë¬µ ì†ì—ì„œ í”ë“¤ë¦¼ ì—†ì´, ë§ˆì§€ë§‰ ë°©ì–´ì„ ì— ì„œ ìˆë‹¤.",
    img: "images/weapons/sword_13.png"
  },
  14: {
    name: "ì™•ê°€ì˜ ì˜ì§€ê²€",
    desc: "í•œ ë‚˜ë¼ì˜ ì‹œê°„ê³¼ ë¬´ê²Œê°€, ë¬µì§í•˜ê²Œ ì†ëìœ¼ë¡œ ì „í•´ì§„ë‹¤.",
    img: "images/weapons/sword_14.png"
  },
  15: {
    name: "ì„±ì—­ì„ ì§€í‚¤ëŠ” ì„±ê²€",
    desc: "ê·¸ ì–´ë–¤ ìœ„í˜‘ ì•ì—ì„œë„ ë¬¼ëŸ¬ì„œì§€ ì•ŠëŠ”, ì¹¨ë¬µì˜ ìˆ˜í˜¸ìë‹¤.",
    img: "images/weapons/sword_15.png"
  },
  16: {
    name: "ì‹¬ì—°ì„ ê¿°ëš«ëŠ” ì„±ê²€",
    desc: "ì–´ë‘ ì˜ ê°€ì¥ ê¹Šì€ ìë¦¬ê¹Œì§€, í•œ ì¤„ê¸° ë¹›ì´ ë‚´ë ¤ ê½‚íŒë‹¤.",
    img: "images/weapons/sword_16.png"
  },
  17: {
    name: "ë¶ˆê¸¸ì˜ ì‹¬íŒê²€",
    desc: "íƒ€ëŠ” ë“¯í•œ ë¶„ë…¸ê°€ ì¹¼ë‚ ì„ ê°ì‹¸ë©°, ì•…ì„ ì¬ë¡œ ë‚¨ê¸´ë‹¤.",
    img: "images/weapons/sword_17.png"
  },
  18: {
    name: "ì•…ë§ˆ ì‚´ìœ¡ì",
    desc: "ì§€ì˜¥ì—ì„œ ê¸°ì–´ì˜¤ë¥¸ ê²ƒë“¤ì¡°ì°¨, ì´ ì´ë¦„ ì•ì—ì„œëŠ” ì¹¨ë¬µí•œë‹¤.",
    img: "images/weapons/sword_18.png"
  },
  19: {
    name: "ì§€ì˜¥ë¬¸ ë´‰ì‡„ê²€",
    desc: "ì´ë¯¸ ì—´ë¦° ì¬ì•™ì˜ ë¬¸ì„, ë§ˆì§€ë§‰ í˜ìœ¼ë¡œ ë‹¤ì‹œ ë‹«ì•„ë²„ë¦°ë‹¤.",
    img: "images/weapons/sword_19.png"
  },
  20: {
    name: "ë‚™ì¸ì˜ ì„±í™”ê²€",
    desc: "ê±°ìŠ¤ë¥¼ ìˆ˜ ì—†ëŠ” ê°ì˜¤ê°€, ë¶ˆë©¸ì˜ ë‚™ì¸ì²˜ëŸ¼ ìƒˆê²¨ì§„ë‹¤.",
    img: "images/weapons/sword_20.png"
  },
  21: {
    name: "ì—­ì²œì˜ íšƒë¶ˆê²€",
    desc: "ì •í•´ì§„ ê¸¸ì„ ë”°ë¥´ì§€ ì•Šê³ , ìê¸°ë§Œì˜ í•˜ëŠ˜ì„ ë°íŒë‹¤.",
    img: "images/weapons/sword_21.png"
  },
  22: {
    name: "ì²œìƒì„ ê±°ìŠ¤ë¥´ëŠ” ì„±ê·¹ê²€",
    desc: "ì‹ ì„±ì˜ ì§ˆì„œë¥¼ ë’¤í”ë“¤ê² ë‹¤ëŠ” ìœ„í—˜í•œ ì„ íƒì´ ê¹ƒë“¤ì–´ ìˆë‹¤.",
    img: "images/weapons/sword_22.png"
  },
  23: {
    name: "ì‹ ì¢Œë¥¼ í”ë“œëŠ” ì„œìŠ¬ê²€",
    desc: "ë†’ì€ í•˜ëŠ˜ ìœ„ì˜ ì™•ì¢Œë§ˆì €, ì´ ì¹¼ë ì•ì—ì„œëŠ” í”ë“¤ë¦°ë‹¤.",
    img: "images/weapons/sword_23.png"
  },
  24: {
    name: "ì‹ ì‚´ì˜ ì™•ê²€",
    desc: "ì‹ ì¡°ì°¨ í”¼í•˜ì§€ ëª»í•œ ê²°ë§ì„, ì¹¨ë¬µ ì†ì— ê·¸ì–´ë‚¸ë‹¤.",
    img: "images/weapons/sword_24.png"
  },
  25: {
    name: "ë³„ì„ ê°€ë¥´ëŠ” ì„±ê´‘ê²€",
    desc: "ë°¤í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë³¸ ì´ë¼ë©´, ëˆ„êµ¬ë‚˜ ê·¸ ìì·¨ë¥¼ ëª©ê²©í•˜ê²Œ ëœë‹¤.",
    img: "images/weapons/sword_25.png"
  },
  26: {
    name: "ì°½ê³µì„ ì´ˆì›”í•œ ì´ˆì›”ê²€",
    desc: "ì´ì œ í•˜ëŠ˜ê³¼ ë•…ì˜ ê²½ê³„ëŠ”, ë” ì´ìƒ ì˜ë¯¸ë¥¼ ê°–ì§€ ëª»í•œë‹¤.",
    img: "images/weapons/sword_26.png"
  },
  27: {
    name: "ì°¨ì›ì„ ë² ì–´ë‚´ëŠ” ì ˆì—°ê²€",
    desc: "ì„¸ê³„ì™€ ì„¸ê³„ë¥¼ ë‚˜ëˆ„ëŠ” ë§ˆì§€ë§‰ ì„ ì´, ë‚  ìœ„ì— ê·¸ì–´ì§„ë‹¤.",
    img: "images/weapons/sword_27.png"
  },
  28: {
    name: "ì¢…ì–¸ì˜ ì„œì•½ê²€",
    desc: "í•œ ë²ˆì˜ ê²°ë‹¨ìœ¼ë¡œ, ì„¸ê³„ì˜ ëë§ˆì € ì•½ì†ëœ ê²°ë§ì²˜ëŸ¼ ë‹¤ê°€ì˜¨ë‹¤.",
    img: "images/weapons/sword_28.png"
  },
  29: {
    name: "ìš´ëª…ì˜ ì‹¬íŒê²€",
    desc: "ë³„ê³¼ ì‹œê°„, ì¸ê³¼ì˜ íë¦„ì´ ëª¨ë‘ ì´ ì¹¼ëìœ¼ë¡œ ëª¨ì—¬ë“ ë‹¤.",
    img: "images/weapons/sword_29.png"
  },
  30: {
    name: "ìš´ëª…ì„ ì§‘í–‰í•˜ëŠ” ã€Œë§¹ì„¸ì˜ ê³„ìœ¨ã€",
    desc: "ë” ì´ìƒ ê²€ì´ ì•„ë‹ˆë‹¤ â€” ë§¹ì„¸ê°€ ë°˜ë“œì‹œ ì‹¤í˜„ë˜ëŠ”, ìš°ì£¼ì˜ ì§ˆì„œê°€ ë˜ì—ˆë‹¤.",
    img: "images/weapons/sword_30.png"
  }
};

  // ğŸŒŒ ì°½ ì „ìš© ë¬´ê¸° ì •ë³´ í…Œì´ë¸”
// 0ê°•ì€ ê²€ê³¼ ê³µìš©ìœ¼ë¡œ ê°™ì€ ê°ì²´ë¥¼ ì“´ë‹¤.
const WEAPON_INFO_SPEAR = {
  0: WEAPON_INFO[0],  // "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´" ê³µìš©

  1: {
    name: "ë¶€ëŸ¬ì§„ ì°½ë",
    desc: "ë” ì´ìƒ ëˆ„êµ¬ë¥¼ ê²¨ëˆŒ ìˆ˜ë„ ì—†ëŠ” ì±„, ì „ì¥ì˜ ëì— ë²„ë ¤ì ¸ ìˆë‹¤.",
    img: "images/weapons/spear_01.png"
  },
  2: {
    name: "ê¸ˆì´ ê°„ ì°½",
    desc: "í•œ ë²ˆë§Œ ë” í˜ì„ ì£¼ë©´, ê·¸ëŒ€ë¡œ ì‚°ì‚°ì´ ë¶€ì„œì ¸ ë²„ë¦´ ê²ƒ ê°™ë‹¤.",
    img: "images/weapons/spear_02.png"
  },
  3: {
    name: "í”¼ê°€ êµ³ì€ ì°½",
    desc: "ì˜¤ë˜ì „ì— ë©ˆì¶˜ ì‹¸ì›€ì˜ í”ì ë§Œì´, ì°¨ê°‘ê²Œ ë‚¨ì•„ ìˆë‹¤.",
    img: "images/weapons/spear_03.png"
  },
  4: {
    name: "ë²„ë ¤ì§„ ì°½ëŒ€",
    desc: "ì†ì—ì„œ ë†“ì¸ ìˆœê°„, ì´ ë¬´ê¸°ëŠ” ì‚¬ëƒ¥ê¾¼ì˜ ì´ë¦„ì„ ìƒì—ˆë‹¤.",
    img: "images/weapons/spear_04.png"
  },
  5: {
    name: "ë‹¿ì§€ ëª»í•œ ì°½",
    desc: "ë‹¨ í•œ ë²ˆë„ ê¸‰ì†Œë¥¼ ì°Œë¥´ì§€ ëª»í•œ ì±„, ì‹œê°„ì„ ê²¬ë””ê³  ìˆë‹¤.",
    img: "images/weapons/spear_05.png"
  },

  6: {
    name: "ì‡³ê²° ì°½ë‚ ",
    desc: "ë‹¤ì‹œ ë²¼ë ¤ì§„ ë‚  ìœ„ì—, ì ë“  ê²°ì‹¬ì´ ê¹¨ì–´ë‚œë‹¤.",
    img: "images/weapons/spear_06.png"
  },
  7: {
    name: "ê±°ì¹œ ì—°ë§ˆì°½",
    desc: "ë¶ˆì•ˆì •í–ˆë˜ ë¬´ê²Œê°€ ì ì°¨ ì „íˆ¬ë¥¼ í–¥í•´ ì •ë ¬ëœë‹¤.",
    img: "images/weapons/spear_07.png"
  },
  8: {
    name: "ì•¼ì „ ì „íˆ¬ì°½",
    desc: "ë‚¯ì„  ë•…ê³¼ ë°”ëŒì´, ì´ ë¬´ê¸°ì˜ ì²« ì „ì¥ì„ ë§Œë“¤ì–´ ì¤€ë‹¤.",
    img: "images/weapons/spear_08.png"
  },
  9: {
    name: "ì‚¬ëƒ¥ê¾¼ ì¶”ì ì°½",
    desc: "ë„ë§ì¹œ ì ì„ í—ˆë½í•˜ì§€ ì•Šê² ë‹¤ëŠ” ë¬´ì–¸ì˜ ì˜ì§€ê°€ ê¹ƒë“ ë‹¤.",
    img: "images/weapons/spear_09.png"
  },
  10: {
    name: "ì¥ê±°ë¦¬ ì›ì •ì°½",
    desc: "ì „ì‚¬ëŠ” ê¸°ë‹¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤ â€” ê°•ìë¥¼ ì°¾ì•„ ìŠ¤ìŠ¤ë¡œ ê¸¸ ìœ„ì— ì„ ë‹¤.",
    img: "images/weapons/spear_10.png"
  },

  11: {
    name: "å½±[ì˜]",
    desc: "ì•½ìëŠ” ì§€ë‚˜ì¹œë‹¤ â€” ì´ ì°½ì€ ê°•ìì˜ ëƒ„ìƒˆë§Œì„ ì¢‡ëŠ”ë‹¤.",
    img: "images/weapons/spear_11.png"
  },
  12: {
    name: "ìŠ¤ì¹¼ë“œ ê²Œì´ë¥´",
    desc: "ì „ì‚¬ì˜ ë…¸ë˜ì— ë‚¨ì„ ì‹¸ì›€ë§Œì„, ì˜ë„ì ìœ¼ë¡œ ì„ íƒí•œë‹¤.",
    img: "images/weapons/spear_12.png"
  },
  13: {
    name: "ì•Œë§ˆ ê²Œì´ë¥´",
    desc: "ë¬¼ëŸ¬ë‚  ê¸¸ì„ í—ˆë½í•˜ì§€ ì•ŠëŠ”ë‹¤ â€” ì´ ì°½ì´ ì„ íƒí•œ ì´ëŠ” ë°˜ë“œì‹œ ë§ì„œì•¼ í•œë‹¤.",
    img: "images/weapons/spear_13.png"
  },
  14: {
    name: "ë² ì–´ìš¸í”„ íŒ”ë¼ë”˜",
    desc: "ì „ì„¤ì´ë¼ ë¶ˆë¦° ê´´ìˆ˜ì¡°ì°¨, ê²°ì „ì˜ ìš”ì²­ì„ í”¼í•˜ì§€ ëª»í•œë‹¤.",
    img: "images/weapons/spear_14.png"
  },
  15: {
    name: "ìš¸í”„ê°€ë¥´",
    desc: "ì‚¬ëƒ¥ê¾¼ë“¤ ìœ„ì—ì„œ, ìŠ¹ìë§Œì´ ë°”ë¼ë³¼ ìˆ˜ ìˆëŠ” ì„¸ê³„ê°€ ì—´ë¦°ë‹¤.",
    img: "images/weapons/spear_15.png"
  },

  16: {
    name: "í”„ë¡œë¯¸ë„ŒìŠ¤ ë² ë¥´í¬",
    desc: "ë¶ˆì˜ ì‹¬ì—°ì„ í–¥í•´, ì´ ì°½ì€ í•œ ì¹˜ì˜ ë§ì„¤ì„ë„ ë‚¨ê¸°ì§€ ì•ŠëŠ”ë‹¤.",
    img: "images/weapons/spear_16.png"
  },
  17: {
    name: "í¬íš¨í•˜ëŠ” ë¶ˆê½ƒ",
    desc: "í¬íš¨ì™€ í™”ì—¼ì„ ê°€ë¥´ë©°, ë„ì „ì€ ì˜¤ì§ ì „ë©´ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.",
    img: "images/weapons/spear_17.png"
  },
  18: {
    name: "ìš© ì‚¬ëƒ¥ê¾¼",
    desc: "ê±°ëŒ€í•œ ì‹¬ì¥ì´ ë§ˆì§€ë§‰ìœ¼ë¡œ ë–¨ë¦°ë‹¤ â€” ì—¬ê¸°ì„œ ì‚¬ëƒ¥ì˜ ì—¬ì •ì€ ëë‚œë‹¤.",
    img: "images/weapons/spear_18.png"
  },

  19: {
    name: "ì•Œí‹°ìŠ¤ ì—˜ë¦¬ì˜¨",
    desc: "ì •ë³µí•  ê´´ìˆ˜ê°€ ì‚¬ë¼ì§„ ìë¦¬ì—ì„œ, ì „ì‚¬ëŠ” í•˜ëŠ˜ì„ ë°”ë¼ë³¸ë‹¤.",
    img: "images/weapons/spear_19.png"
  },
  20: {
    name: "ë ˆì§€ìŠ¤ ì´ê·¸ë‹ˆìŠ¤",
    desc: "ê¶Œìœ„ ìœ„ì— ë¶ˆê½ƒì´ ê½‚íˆëŠ” ìˆœê°„, ë„ì „ì€ ë°˜ì—­ì´ ëœë‹¤.",
    img: "images/weapons/spear_20.png"
  },
  21: {
    name: "ì˜¤ë¥´ë„ ë„¤ê°€í‹°ì˜¤",
    desc: "ì´ ì°½ì€ ì¡´ì¬ì˜ ì§ˆì„œ ê·¸ ìì²´ë¥¼ í–¥í•´ ë˜ì ¸ì§„ë‹¤.",
    img: "images/weapons/spear_21.png"
  },

  22: {
    name: "è–æˆŸ[ì„±ê·¹]",
    desc: "ì„±ì—­ì˜ ì‹¬ì¥ë§ˆì €, ë” ì´ìƒ ì•ˆì „í•˜ì§€ ì•Šë‹¤.",
    img: "images/weapons/spear_22.png"
  },
  23: {
    name: "ì“°ë¡ ë¸Œë ˆí—ˆ",
    desc: "ë†’ì´ ì•‰ì€ ìë¥¼ ëŒì–´ë‚´ë¦°ë‹¤ â€” ì™•ì¢Œ ìœ„ì—ì„œë„ ì˜ˆì™¸ëŠ” ì—†ë‹¤.",
    img: "images/weapons/spear_23.png"
  },
  24: {
    name: "ë¡±ê¸°ëˆ„ìŠ¤ ì—‘ìŠ¤ ë§ˆí‚¤ë‚˜",
    desc: "ì‹ ì˜ ëª¸ì„ ê´€í†µí•œ ì°½. ì´ê²ƒì€ ì¡´ì¬ë¥¼ ëš«ëŠ”ë‹¤ëŠ” ì •ì˜ê°€ ëœë‹¤.",
    img: "images/weapons/spear_24.png"
  },

  25: {
    name: "ì•„ìŠ¤íŠ¸ë¼ ë£¨í”„íˆ¬ë¼",
    desc: "ë³„ì˜ ì¤‘ì¶”ê°€ í”ë“¤ë¦¬ë©°, ìš°ì£¼ì˜ ìš¸ë¦¼ì´ ë”°ë¼ ì§„ë™í•œë‹¤.",
    img: "images/weapons/spear_25.png"
  },
  26: {
    name: "è¶…æ»…æ§[ì´ˆë©¸ì°½]",
    desc: "í•˜ëŠ˜ì˜ ê³¨ê²©ì´ ë¶€ì„œì§€ê³ , ê²½ê³„ê°€ ìì‹ ì˜ ì˜ë¯¸ë¥¼ ìƒëŠ”ë‹¤.",
    img: "images/weapons/spear_26.png"
  },
  27: {
    name: "ë””ë©˜í”„ë™íŠ¸",
    desc: "ì°¨ì›ì„ ë‚˜ëˆ„ë˜ ë§ˆì§€ë§‰ ì„ ì´, ì¡°ìš©íˆ ì°¢ê²¨ ë‚˜ê°„ë‹¤.",
    img: "images/weapons/spear_27.png"
  },

  28: {
    name: "í„°ë¯¸ë„ˆìŠ¤ ìŠ¤í”¼ì–´",
    desc: "ì¢…ì–¸ì€ ì´ì œ ì‚¬ê±´ì´ ì•„ë‹ˆë¼ â€” ë°˜ë“œì‹œ ë„ë‹¬í•  ì§€ì ì´ ëœë‹¤.",
    img: "images/weapons/spear_28.png"
  },
  29: {
    name: "ã€Œåˆ‡æ–·ã€[ì ˆë‹¨]",
    desc: "ì ˆë‹¨ì´ë¼ëŠ” ê·œì¹™ë§Œ ë‚¨ì•˜ë‹¤. ì´ê²ƒì˜ í˜•íƒœëŠ” ì´ì œ ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.",
    img: "images/weapons/spear_29.png"
  },
  30: {
    name: "íŒŒê´´ì˜ ê³„ìœ¨ ã€Œë””ì—ìŠ¤ ì´ë¼ì—ã€",
    desc: "ë” ì´ìƒ ë¬´ê¸°ê°€ ì•„ë‹ˆë‹¤ â€” íŒŒê´´ë¼ëŠ” ë²•ì¹™ìœ¼ë¡œ ì¡´ì¬í•œë‹¤.",
    img: "images/weapons/spear_30.png"
  }
};

  // ğŸ”° ê°•í™” ë‹¨ê³„ë³„ ë„ë¼ ì´ë¦„ / ì„¤ëª… / ì´ë¯¸ì§€ ê²½ë¡œ
const WEAPON_INFO_AXE = {
  0: WEAPON_INFO[0],  // "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´" ê³µìš©

  1: {
    name: "ê¸ˆì´ ê°„ ë„ë¼ë‚ ",
    desc: "ê¸ˆì´ ê°„ ë‚¡ì€ ë„ë¼.",
    img: "images/weapons/axe_01.png"
  },
  2: {
    name: "ë…¹ìŠ¨ ë„ë¼",
    desc: "ì „ì¥ì„ ë– ë‚œ ë„ë¼.",
    img: "images/weapons/axe_02.png"
  },
  3: {
    name: "ë¬´ë„ˆì§„ ì†ì¡ì´",
    desc: "ì£¼ì¸ì„ ìƒê³  ë°©ì¹˜ëœ ì±„, ë” ì´ìƒ íœ˜ë‘ë¥¼ ìˆ˜ ì—†ëŠ” ë„ë¼.",
    img: "images/weapons/axe_03.png"
  },
  4: {
    name: "ë²„ë ¤ì§„ ì•½íƒˆë„ë¼",
    desc: "ì•½íƒˆì˜ í”ì ë§Œì„ ë‚¨ê¸°ê³ , ì „ì¥ì— ë²„ë ¤ì§„ ë„ë¼.",
    img: "images/weapons/axe_04.png"
  },
  5: {
    name: "ì ë“¤ì§€ ëª»í•œ ë„ë¼",
    desc: "ì—¬ì „íˆ ì „ì¥ì„ ê¿ˆê¾¸ë©°, ê¹¨ì–´ë‚  ìˆœê°„ì„ ê¸°ë‹¤ë¦°ë‹¤.",
    img: "images/weapons/axe_05.png"
  },

  6: {
    name: "ì•¼ì „ ì „íˆ¬ë„ë¼",
    desc: "ë‹¤ì‹œ ì „ì¥ìœ¼ë¡œ ëŒì•„ì˜¨, ì‹¤ì „ì˜ ë¬´ê²Œë¥¼ ì§€ë‹Œ ë„ë¼.",
    img: "images/weapons/axe_06.png"
  },
  7: {
    name: "í”¼íˆ¬ì„±ì´ ëŒê²©ë„ë¼",
    desc: "ëŒê²© ì†ì—ì„œ í”¼ì™€ í™ì„ í•¨ê»˜ ë’¤ì§‘ì–´ì“´ ë„ë¼.",
    img: "images/weapons/axe_07.png"
  },
  8: {
    name: "ì•½íƒˆì˜ ë„ë¼",
    desc: "ìŠ¹ë¦¬ë³´ë‹¤ ì•½íƒˆì„ ìœ„í•´ íœ˜ë‘˜ëŸ¬ì§€ëŠ”, ì”í˜¹í•œ ë„ë¼.",
    img: "images/weapons/axe_08.png"
  },
  9: {
    name: "ì „ì¥ì˜ ê´‘ì „ì‚¬ ë„ë¼",
    desc: "ì´ì„±ë³´ë‹¤ ë¶„ë…¸ê°€ ë¨¼ì € íœ˜ë‘ë¥´ëŠ” ê´‘ì „ì‚¬ì˜ ë¬´ê¸°.",
    img: "images/weapons/axe_09.png"
  },
  10: {
    name: "í”¼ì˜ ë§¹ì•½ë„ë¼",
    desc: "ë¬¼ëŸ¬ì„¬ì„ í—ˆë½í•˜ì§€ ì•ŠëŠ”, í”¼ë¡œ ë§ºì€ ì „íˆ¬ì˜ ë§¹ì•½.",
    img: "images/weapons/axe_10.png"
  },

  11: {
    name: "ë¼ìš°ë“œ",
    desc: "ì „ì¥ì„ ìš¸ë¦¬ëŠ” ê´‘ê¸°ì˜ í¬íš¨ê°€, ë„ë¼ë¥¼ ë’¤í”ë“ ë‹¤.",
    img: "images/weapons/axe_11.png"
  },
  12: {
    name: "ë² ë¥´ì„¸ë¥´í¬ ë¡œì–´",
    desc: "ê´‘ì „ì‚¬ì˜ ì „íˆ¬ ë³¸ëŠ¥ì´, ë„ë¼ì™€ í•¨ê»˜ ìš¸ë ¤ í¼ì§„ë‹¤.",
    img: "images/weapons/axe_12.png"
  },
  13: {
    name: "ë¸”ëŸ¬ë“œ í•˜ìš¸",
    desc: "í”¼ë¥¼ ë¶€ë¥´ëŠ” ìš¸ìŒì´, ì ì˜ ì˜ì§€ë¥¼ êº¾ëŠ”ë‹¤.",
    img: "images/weapons/axe_13.png"
  },
  14: {
    name: "ì¹´ì˜¤ìŠ¤ ì˜¤ìŠ¤",
    desc: "ë¬´ì§ˆì„œì™€ íŒŒê´´ë¥¼ í–¥í•œ ë§¹ì„¸ê°€ ë„ë¼ì— ê°ì¸ëœë‹¤.",
    img: "images/weapons/axe_14.png"
  },
  15: {
    name: "ë ˆë“œ ë¼ê·¸ë‚˜",
    desc: "ë¶‰ì€ ì¢…ë§ì„ ì˜ˆê³ í•˜ëŠ”, ì „ì¥ì˜ í”¼ë¹› ë„ë¼.",
    img: "images/weapons/axe_15.png"
  },

  16: {
    name: "ë”¥ìŠ¤íŠ¸ë¼ì´ë“œ",
    desc: "ê±°ëŒ€í•œ ì‹¬ì—°ìœ¼ë¡œ, ìŠ¤ìŠ¤ë¡œ ê±¸ì–´ ë“¤ì–´ê°„ ì „ì‚¬ì˜ ë„ë¼.",
    img: "images/weapons/axe_16.png"
  },
  17: {
    name: "ìì´ì–¸íŠ¸ ìŠ¬ë ˆì´ì–´",
    desc: "ê±°ì¸ì„ í•™ì‚´í•œ ë„ë¼, ë‘ë ¤ì›€ì„ ìŠì€ ì¡´ì¬ì—ê²Œ ë‹¤ì‹œ ë‘ë ¤ì›€ì„ ê°ì¸ì‹œí‚¨ë‹¤.",
    img: "images/weapons/axe_17.png"
  },
  18: {
    name: "ìš”íˆ° ë¸Œë ˆì´ì»¤",
    desc: "ì§€ì˜¥ ìì²´ë¥¼ ë¶•ê´´í•´ë²„ë¦° ì „ì„¤ì ì¸ ë„ë¼.",
    img: "images/weapons/axe_18.png"
  },

  19: {
    name: "ì–´ì„¼ë” ì˜¤ë¸Œ ë” í™€",
    desc: "ì„ íƒë°›ì€ ì „ì‚¬ë“¤ì˜ í•˜ëŠ˜ì„ í–¥í•´, ê¸ˆê¸°ë¥¼ ë„˜ì–´ì„ ë‹¤.",
    img: "images/weapons/axe_19.png"
  },
  20: {
    name: "í¬ë¼ìš´í´ ì—£ì§€",
    desc: "ê´‘ê¸°ì— ì –ì€ ì „ì‚¬ë“¤ì˜ ë¶„ë…¸ëŠ” ë©ˆì¶”ì§€ ì•Šê³  ê·¸ë“¤ì˜ ì£¼êµ°ì„ í–¥í•œë‹¤.",
    img: "images/weapons/axe_20.png"
  },
  21: {
    name: "ë°œí• ë¼ ì„¸ë²„ëŸ¬",
    desc: "í•˜ëŠ˜ì˜ ì „ë‹¹ì„ ê°€ë¥´ë©° â€” ì‹ ì¢Œë¥¼ ë¶€ì •í•œ ë„ë¼.",
    img: "images/weapons/axe_21.png"
  },

  22: {
    name: "ì˜¤ìŠ¤ë¸Œë ˆì´ì»¤ìŠ¤ ìš´ë“œ",
    desc: "ì‹ ì„±í•œ ì•½ì†ì´ í”¼ì²˜ëŸ¼ í˜ëŸ¬ë‚´ë¦° ìë¦¬.",
    img: "images/weapons/axe_22.png"
  },
  23: {
    name: "ì“°ë¡  ì–´ì„œí¼",
    desc: "ì™•ì¢ŒëŠ” ì§€ì¼œì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ â€” ë¹¼ì•—ê¸°ëŠ” ê²ƒì´ë‹¤.",
    img: "images/weapons/axe_23.png"
  },
  24: {
    name: "ë¸Œë ˆì´ì»¤ ì˜¤ë¸Œ ì•„ìŠ¤ê°€ë¥´ë“œ",
    desc: "ìì‹ ë§ˆì € ì§‘ì–´ì‚¼í‚¨ ë¶„ë…¸ëŠ” ëë‚´ ê·¸ë“¤ì˜ ì‹ ê²©ë§ˆì € ë§ì‚´í•œë‹¤.",
    img: "images/weapons/axe_24.png"
  },

  25: {
    name: "ë£¨íŠ¸ í”„ë™ì²˜",
    desc: "í•œë²ˆì˜ íœ˜ë‘ë¦„ì— ë³´ì´ì§€ ì•ŠëŠ” ì„¸ê³„ì˜ ë¿Œë¦¬ì—, ì²« ê¸ˆì´ ê°„ë‹¤.",
    img: "images/weapons/axe_25.png"
  },
  26: {
    name: "ì•¡ì‹œìŠ¤ ë¸Œë ˆì´í¬",
    desc: "ì„¸ê³„ë¥¼ ì‡ë˜ ì¶•ì´, ì ì  ê¸°ìš¸ì–´ì§€ê¸° ì‹œì‘í•œë‹¤.",
    img: "images/weapons/axe_26.png"
  },
  27: {
    name: "ì´ê·¸ë“œë¼ì‹¤ ì‹œì–´",
    desc: "ê±°ëŒ€í•œ ë¶„ë…¸ê°€ ë§Œë“¤ì–´ë‚¸ ë¶•ê´´ëŠ” ì°¨ì›ë§ˆì € ì ˆë‹¨ ì‹œí‚¨ë‹¤.",
    img: "images/weapons/axe_27.png"
  },

  28: {
    name: "ì‹±ê·¤ëŸ¬ ë£¨ì¸",
    desc: "íŒŒê´´ëŠ” ë” ì´ìƒ ì‚¬ê±´ì´ ì•„ë‹ˆë‹¤ â€” ì¡´ì¬ì˜ ìƒíƒœë‹¤.",
    img: "images/weapons/axe_28.png"
  },
  29: {
    name: "ë¡œ ì˜¤ë¸Œ ì½œë©ìŠ¤",
    desc: "ë¬´ë„ˆì§ì€ ì„ íƒì´ ì•„ë‹ˆë¼ â€” í•„ì—°ì´ ëœë‹¤.",
    img: "images/weapons/axe_29.png"
  },

  30: {
    name: "í˜¼ëˆì˜ ì„œë§‰ ã€Œì—ìŠ¤ì¹´í†¤ã€",
    desc: "ë” ì´ìƒ ë¬´ê¸°ê°€ ì•„ë‹ˆë‹¤ â€” í˜¼ëˆì˜ í˜•íƒœì¼ ë¿.",
    img: "images/weapons/axe_30.png"
  }
};

  const WEAPON_INFO_BOW = {
0: WEAPON_INFO[0],  // "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´" ê³µìš©
    
  // ğŸŒ‘ 1~10ê°• : í˜„ì‹¤ ì‚¬ëƒ¥ ì¥ë¹„
  1:  { name: "ë‚¡ì€ ì‚¬ëƒ¥ í™œ",          desc: "ì†ì— ìµì€ ë‚˜ë¬´ í™œ. ì‹œì‘ì€ ì¡°ìš©í•˜ë‹¤.", img: "images/weapons/bow_01.png" },
  2:  { name: "ê°€ì£½ ì‹œìœ„ ë‹¨ê¶",        desc: "ê°€ì£½ ì‹œìœ„ê°€ íŒ½íŒ½íˆ ìš¸ë¦°ë‹¤.",         img: "images/weapons/bow_02.png" },
  3:  { name: "ì‚¬ëƒ¥ ë‹¨ê¶",            desc: "ê¸‰ì†Œë¥¼ ì°¾ëŠ” ëˆˆì´ ì¡°ê¸ˆ ë” ì„ ëª…í•´ì§„ë‹¤.", img: "images/weapons/bow_03.png" },
  4:  { name: "ë¡±ë³´ìš°",               desc: "ì‚¬ì •ê±°ë¦¬ê°€ ê³§ ìì‹ ê°ì´ ëœë‹¤.",         img: "images/weapons/bow_04.png" },
  5:  { name: "ì‚¬ëƒ¥ ì¥ê¶",            desc: "í•œ ë°œë¡œ ëë‚´ëŠ” ì‚¬ëƒ¥ê¾¼ì˜ ê¸°ë³¸ê¸°.",       img: "images/weapons/bow_05.png" },
  6:  { name: "ë§¤ë³µ ì¥ê¶",            desc: "ìˆ¨ì„ ì£½ì´ë©´, ë°”ëŒì´ ê¸¸ì„ ì•Œë ¤ì¤€ë‹¤.",    img: "images/weapons/bow_06.png" },
  7:  { name: "ë°”ì´íƒˆìƒ· ë³´ìš°",         desc: "ì‹¬ì¥ ë°•ë™ì„ ë”°ë¼ í™”ì‚´ì´ ê°„ë‹¤.",        img: "images/weapons/bow_07.png" },
  8:  { name: "í”„ë¦¬ì‹œì „",             desc: "ì¡°ì¤€ì´ ì•„ë‹ˆë¼ â€˜í™•ì‹ â€™ìœ¼ë¡œ ìœë‹¤.",        img: "images/weapons/bow_08.png" },
  9:  { name: "ì‹¤ë²„ìŠ¤íŠ¸ë§ ë³´ìš°",       desc: "ì€ë¹› ì‹œìœ„ê°€ ë¯¸ì„¸í•œ ë–¨ë¦¼ê¹Œì§€ ì ê·¼ë‹¤.",   img: "images/weapons/bow_09.png" },
  10: { name: "ëª…ê¶(åå¼“)",            desc: "ì´ì œë¶€í„°ëŠ” â€˜ì¥ë¹„â€™ê°€ ì•„ë‹ˆë¼ â€˜ê¸°ìˆ â€™ì´ë‹¤.", img: "images/weapons/bow_10.png" },

  // ğŸŒ’ 11~17ê°• : ë‹¬Â·ìˆ²Â·ë³„
  11: { name: "ì›”ë¦¼ê¶(æœˆæ—å¼“)",         desc: "ë‹¬ë¹›ì´ ìˆ²ì„ ìŠ¤ì¹˜ë©´, í™”ì‚´ì€ ì†Œë¦¬ ì—†ì´ ì‚¬ë¼ì§„ë‹¤.", img: "images/weapons/bow_11.png" },
  12: { name: "ì€ì—½ê¶(éŠ€è‘‰å¼“)",         desc: "ì€ë¹› ìë§¥ì²˜ëŸ¼ ê¶¤ì ì´ ì–‡ê²Œ ë‚¨ëŠ”ë‹¤.",             img: "images/weapons/bow_12.png" },
  13: { name: "ë³„ ì‚¬ëƒ¥ê¾¼",              desc: "ë³„ì„ ê²¨ëˆ„ëŠ” ìëŠ”, ì´ë¯¸ ëŒì•„ì˜¬ ê¸¸ì„ ë²„ë ¸ë‹¤.",      img: "images/weapons/bow_13.png" },
  14: { name: "ì œí”¼ë¡œìŠ¤",    desc: "ì„œí’ì´ ë“±ì„ ë°€ë©´, ëª…ì¤‘ì€ â€˜ì‹œê°„ ë¬¸ì œâ€™ê°€ ëœë‹¤.",     img: "images/weapons/bow_14.png" },
  15: { name: "ë£¨ë‚˜ë¦¬ìŠ¤ ë³´ìš°", desc: "ë‹¬ì˜ ìœ¤ê³½ì„ ë”°ë¼ ê¶¤ë„ê°€ ì •ë ¬ëœë‹¤.",          img: "images/weapons/bow_15.png" },
  16: { name: "ìŠ¤íƒ€ì²´ì´ì„œ", desc: "ë„ë§ì¹˜ëŠ” ë¹›ì¡°ì°¨ ë†“ì¹˜ì§€ ì•ŠëŠ”ë‹¤.",                 img: "images/weapons/bow_16.png" },
  17: { name: "ë…¹í„´",        desc: "ë°¤ì´ ê¹Šì„ìˆ˜ë¡, í•œ ë°œì€ ë” ì°¨ê°‘ë‹¤.",               img: "images/weapons/bow_17.png" },

  // ğŸŒ• 18~20ê°• : íƒ€ì´íƒ„ ì‚¬ëƒ¥í„° êµ¬ê°„
  18: { name: "íƒ€ì´íƒ„í—Œí„°",             desc: "ê±°ì‹ ì˜ ê·¸ë¦¼ìì—, ê¸‰ì†Œ í•˜ë‚˜ë©´ ì¶©ë¶„í•˜ë‹¤.",           img: "images/weapons/bow_18.png" },
  19: { name: "ì½œë¡œì„œìŠ¤ í”¼ì–´ì„œ", desc: "ê±°ëŒ€í•œ ë°©ì–´ë„ â€˜í•œ ì â€™ì—ì„œ ë¬´ë„ˆì§„ë‹¤.", img: "images/weapons/bow_19.png" },
  20: { name: "ì²œê³µê´€í†µê¶(ç©¿ç©ºè²«å¼“)",   desc: "í•˜ëŠ˜ì„ ì°¢ëŠ” ê²Œ ì•„ë‹ˆë‹¤ â€” í•˜ëŠ˜ì„ â€˜í†µê³¼â€™í•œë‹¤.",       img: "images/weapons/bow_20.png" },

  // ğŸŒŸ 21~23ê°• : ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
  21: { name: "ì˜¤ë¦¬ì˜¨ìë¦¬",             desc: "ì‚¬ëƒ¥ê¾¼ì˜ ë³„ìë¦¬ê°€ ê¹¨ì–´ë‚œë‹¤. ì´ì œ â€˜ì¶”ì â€™ì€ ëê¹Œì§€ ê°„ë‹¤.", img: "images/weapons/bow_21.png" },
  22: { name: "ìƒì¸„ì–´ë¦¬ ìŠ¤í† ì»¤", desc: "ì„±ì—­ì´ë¼ë„, í‘œì ì´ë©´ ì˜ˆì™¸ëŠ” ì—†ë‹¤.",     img: "images/weapons/bow_22.png" },
  23: { name: "ì„¸ë¼í”„ ì• ë¡œìš°", desc: "ë¹›ì´ ë–¨ì–´ì§€ëŠ” ê°ë„ ê·¸ëŒ€ë¡œ, ê¸‰ì†Œì— ë°•íŒë‹¤.",      img: "images/weapons/bow_23.png" },

  // ğŸŒŸ 24~25ê°• : ì‹ ì˜ ì²˜ì†Œ
  24: { name: "ì•„ë¥´í…Œë¯¸ìŠ¤",   desc: "ë‹¬ ì•„ë˜ì„œ ë§¹ì„¸í•œë‹¤ â€” ë¹—ë‚˜ê°ì€ í—ˆë½ë˜ì§€ ì•ŠëŠ”ë‹¤.",     img: "images/weapons/bow_24.png" },
  25: { name: "í¬ë¡œë…¸ìŠ¤ ì•„í¬", desc: "ì‹œìœ„ë¥¼ ë‹¹ê¸°ëŠ” ìˆœê°„, í‘œì ì˜ ì‹œê°„ì´ ëŠë ¤ì§„ë‹¤.",      img: "images/weapons/bow_25.png" },

  // ğŸŒˆ 26~29ê°• : ì‹¬ì—°/ë²•ì¹™/ì˜ê²
  26: { name: "í…œí˜ìŠ¤íŠ¸ ì• ë¡œìš°", desc: "ë°”ëŒì´ ì•„ë‹ˆë¼ í­í’ì„ ìœë‹¤.",                 img: "images/weapons/bow_26.png" },
  27: { name: "ì¸í”¼ë‹ˆíŠ¸ ë“œë¡œìš°", desc: "ëì—†ëŠ” ë‹¹ê¹€ â€” ëì—†ëŠ” í™•ì •.",                img: "images/weapons/bow_27.png" },
  28: { name: "ì•„í¬ì¹¼ë¦½ìŠ¤",              desc: "í•˜ë‚˜ì˜ ë°œì‚¬ë¡œ, ì „ì¥ì˜ ê²°ë§ì´ ì •í•´ì§„ë‹¤.",               img: "images/weapons/bow_28.png" },
  29: { name: "ì˜ê²í¬ì‹ì",              desc: "ëª…ì¤‘ì€ ì‚¬ê±´ì´ ì•„ë‹ˆë‹¤ â€” ì˜ê²ì´ ë¨¹íˆëŠ” ë°©ì‹ì´ë‹¤.",       img: "images/weapons/bow_29.png" },

  // ğŸŒˆ 30ê°• : ìµœì¢…
  30: { name: "ì‹ ê¶(ç¥å¼“) ã€Œì•„ì´ì˜¨ã€", desc: "ì‹œê°„ ë²•ì¹™ ê·¸ ìì²´. â€˜ì˜ëŠ” í–‰ìœ„â€™ê°€ ê³§ ê²°ê³¼ê°€ ëœë‹¤.", img: "images/weapons/bow_30.png" }
};


// í˜„ì¬ ê°•í™” ìˆ˜ì¹˜ & íƒ€ì… ê¸°ì¤€ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getWeaponInfo(level, type) {
  const lv = Math.max(0, Math.min(30, level | 0));

  // ìš°ì„ ìˆœìœ„: ì „ë‹¬ëœ type > ì „ì—­ weaponType > ê¸°ë³¸ "sword"
  const t = type || weaponType || "sword";

  if (t === "spear") {
    return WEAPON_INFO_SPEAR[lv] || WEAPON_INFO_SPEAR[0];
  }

  if (t === "axe") {
    return WEAPON_INFO_AXE[lv] || WEAPON_INFO_AXE[0];
  }

  if (t === "bow") {
    return WEAPON_INFO_BOW[lv] || WEAPON_INFO_BOW[0];
  }

  // ê¸°ë³¸: ê²€
  return WEAPON_INFO[lv] || WEAPON_INFO[0];
}

// 0ê°•ì—ì„œ ì²˜ìŒ ë¬´ê¸°ê°€ ìƒê¸¸ ë•Œ, íƒ€ì…(ê²€/ì°½/ë„ë¼) ëœë¤ í™•ì •
function ensureWeaponTypeAfterUpgrade(beforeLevel, afterLevel) {
  if (beforeLevel <= 0 && afterLevel >= 1) {
    if (!weaponType) {
      const types = ["sword", "spear", "axe", "bow"];
      const idx = Math.floor(Math.random() * types.length);
      weaponType = types[idx];
    }
  }
}

// ì´ë¯¸ì§€ êµì²´ í•¨ìˆ˜
function updateWeaponImage() {
  const info = getWeaponInfo(sword, weaponType);
  const imgEl = document.getElementById("weaponImage");
  if (!imgEl) return;

  imgEl.src = info.img;
  imgEl.alt = info.name;
}
  
/* ìƒíƒœ */
let sword = 0, power = 10, gold = 100;
let userId="", userPassword="", userRef=null;
let attendanceCount = 0;
let lastAttendanceDate = "";
let attendanceStreak = 0;     // ì—°ì† ì¶œì„ ìˆ˜
let lastAttendanceDay = "";   // ë§ˆì§€ë§‰ ì¶œì„ ë‚ ì§œ (streak ì „ìš©)
let maxSwordLevel = 0;   // ê³„ì • ì „ì²´ ìµœê³  ê°•í™” ê¸°ë¡
let destroyCount  = 0;   // ê³„ì • ì „ì²´ ëˆ„ì  íŒŒê´´ íšŸìˆ˜
let currentSessionId = null;   // ğŸ” ì´ ë¸Œë¼ìš°ì € íƒ­ì˜ ì„¸ì…˜ ID
let duelPointWeekKey = "";           // í˜„ì¬ ë‚´ê°€ í”Œë ˆì´ ì¤‘ì¸ ì£¼(ì›”ìš”ì¼ ê¸°ì¤€)
let duelLastWeekPoint = 0;           // ì§€ë‚œì£¼ ë‚´ê°€ ëª¨ì•˜ë˜ ê²°íˆ¬ í¬ì¸íŠ¸
let duelLastWeekRank  = 0;           // ì§€ë‚œì£¼ ë‚´ ë­í‚¹ (0ì´ë©´ ê¸°ë¡ ì—†ìŒ)
let duelLastWeekRewardClaimed = false; // ì§€ë‚œì£¼ ë³´ìƒ ì´ë¯¸ ë°›ì•˜ëŠ”ì§€ ì—¬ë¶€
let duelUpdated = 0;          // ì´ë²ˆ ì£¼ ê²°íˆ¬ í¬ì¸íŠ¸ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ë°”ë€ ì‹œê°
let duelLastWeekUpdated = 0;  // ì§€ë‚œì£¼ ê²°íˆ¬ í¬ì¸íŠ¸ ìµœì¢… ê¸°ë¡ ì‹œê°  
let weaponType = null; 
// null: ì•„ì§ ë¯¸ë°°ì •(0ê°•) / "sword": ê²€ / "spear": ì°½ / "axe": ë„ë¼ / "bow": í™œ
let isUpgrading = false; 
let isDueling   = false;   // âš”ï¸ ê²°íˆ¬ VS ëŒ€ê¸°ì¤‘ì¼ ë•Œ true
let titlesOwned = {};     // { titleId: true }
let equippedTitle = "";   // ì¥ì°©ì¤‘ ì¹­í˜¸ ID
let lastSeenGlobal30EventId = 0;  // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ +30 ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ ID
let aweUsedGlobal30EventId = 0;   // ë§ˆì§€ë§‰ìœ¼ë¡œ â€˜ê²½ì™¸í•˜ê¸°â€™ë¥¼ ì‚¬ìš©í•œ +30 ì´ë²¤íŠ¸ ID (1ì¸ 1íšŒ)


// ğŸ§­ ì‚¬ëƒ¥í„° ì´ë™ ì¤‘ì¸ì§€ ì—¬ë¶€
let isMoving = false;

// â­ ì£¼ê°„ ê²°íˆ¬ ì‹œìŠ¤í…œ
let currentWeekKey = "";
  
// âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ìƒíƒœ
let duelWin = 0;                  // ìŠ¹ ìˆ˜
let duelLose = 0;                 // íŒ¨ ìˆ˜
let duelCountToday = 0;           // ì˜¤ëŠ˜ ê²°íˆ¬í•œ ì´ íšŸìˆ˜ (ëª¨ë“  ìƒëŒ€ í•©ì‚°)
let lastDuelDate = "";            // ë§ˆì§€ë§‰ ê²°íˆ¬ ë‚ ì§œ (YYYY-MM-DD)
// ì˜¤ëŠ˜ ê°™ì€ ìƒëŒ€ì—ê²Œ ëª‡ ë²ˆ ë„ì „í–ˆëŠ”ì§€: { ìƒëŒ€ì•„ì´ë””: íšŸìˆ˜ }
let duelTargetsToday = {};
// ğŸ·ï¸ ê²°íˆ¬ ì—…ì  ì¹´ìš´íŠ¸
let bully10Count = 0;        // ê°•ì•½ì•½ê°•: ì•½í•œ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ 10íšŒ
let challenger10Count = 0;   // ë„ì „ì: ê°•í•œ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ ìŠ¹ë¦¬ 10íšŒ
let brawl500Count = 0;       // ì‹¸ì›€ê¾¼: ê²°íˆ¬ ëˆ„ì  500íšŒ
let warGodWin = false;       // íˆ¬ì‹ : +4ê°• ì´ìƒ ë†’ì€ ìƒëŒ€ì—ê²Œ ìŠ¹ë¦¬ 1íšŒ

let couponUsedMap = {};   // ì‚¬ìš© ì™„ë£Œí•œ ì¿ í°ì½”ë“œ ê¸°ë¡ { CODE: true }

// ğŸ”” ì—…ë°ì´íŠ¸ ê³µì§€ ìƒíƒœ
let updateNotices = [];       // {id, title, content, createdAt} ë°°ì—´
let currentNoticeIndex = 0;   // íŒì—…ì—ì„œ í˜„ì¬ ë³´ê³  ìˆëŠ” ì¸ë±ìŠ¤
  
// ğŸ… ëª…ì˜ˆì˜ í›ˆì¥ (ê²°íˆ¬ ë³´ìƒ ì¬í™”)
let itemHonorMedal = 0;

// â­ ê²°íˆ¬ í¬ì¸íŠ¸ (ê²°íˆ¬ì¥ ë­í‚¹ì— ì“°ì¼ ê°’)
let duelPoint = 0;
  
// ì „ì²´ ìœ ì € ëª©ë¡ ìºì‹œ (ê²°íˆ¬ ê²€ìƒ‰/ëœë¤ë§¤ì¹­ìš©)
let allUsersCache = [];
// â­ updated ê°±ì‹ ì— ì‚¬ìš©í•  ë§ˆì§€ë§‰ ì €ì¥ëœ ê°•í™”ê°’
let lastSavedSwordForUpdated = 0;
  // ğŸ—º ì‚¬ëƒ¥ ê´€ë ¨ ìƒíƒœ
let currentField = 1;          // 1~10 ì‚¬ëƒ¥í„°
let huntCountToday = 0;        // ì˜¤ëŠ˜ ì‚¬ëƒ¥ íšŸìˆ˜
let lastHuntDate = "";         // ë§ˆì§€ë§‰ ì‚¬ëƒ¥ ë‚ ì§œ (YYYY-MM-DD)
let plagueRatHuntCount = 0; // ğŸ¦  2ë ˆë²¨ ì‚¬ëƒ¥í„°(ì‹œê¶ì°½) ì‚¬ëƒ¥ ëˆ„ì  ì¹´ìš´íŠ¸
let superSuccessCount = 0; // ìŠˆí¼ê°•í™” ì„±ê³µ ëˆ„ì 
let downStreak = 0;        // ê°•ë“± ì—°ì† íšŸìˆ˜
let dopamineTried = 0;     // 25ê°•+ì—ì„œ íŒŒê´´ë°©ì§€ ì—†ì´ ê°•í™” ì‹œë„(1íšŒë©´ ì—…ì )

  // âœ… ìŠ¹ë¶€ì‚¬(21~24 ë¬´ì£¼ë¬¸ì„œ ëŸ°) ì¶”ì 
let gamblerRunActive = false;   // 21ê°• ì´ìƒ êµ¬ê°„ ì§„ì… ì—¬ë¶€
let gamblerRunNoScroll = true;  // 21ê°• ì´í›„ ì£¼ë¬¸ì„œ/ìŠ¤í¬ë¡¤ â€œí•œ ë²ˆë„â€ ì•ˆ ì¼ëŠ”ì§€

// âœ… í­ì£½ë†€ì´(21~25 íŒŒê´´ ì²´í¬)
let fireworksDestroyed = { 21:false, 22:false, 23:false, 24:false, 25:false };

// âœ… 30ê°• ë‹¬ì„± íšŸìˆ˜(ì „ì²´/ë¬´ê¸°ë³„)
let reach30Count = 0;           // 30ê°• ë‹¬ì„± ëˆ„ì (ë¬´ê¸° ìƒê´€ì—†ì´)
let weapon30Counts = {};        // { sword:0, axe:0, spear:0, bow:0 } í˜•íƒœë¡œ ì €ì¥

  // ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹(30ê°• ë„ë‹¬ í›„ 72ì‹œê°„ ì¹´ìš´íŠ¸)
let hofDeadline = 0;          // ê°•ì œ ì „ë‹¹í–‰ ë§Œë£Œì‹œê°(ms)
let hofAchievedAt = 0;        // 30ê°• ë‹¬ì„± ì‹œê°(ms)
let hofWeaponTypeAt30 = "";   // 30ê°• ë‹¬ì„± ë‹¹ì‹œ ë¬´ê¸° íƒ€ì…
let hofProcessedAt = 0;       // ì „ë‹¹í–‰ ì²˜ë¦¬ ì™„ë£Œ ì‹œê°(ms) (ì¤‘ë³µë°©ì§€)

// ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜
let huntStamina = 20;          // í˜„ì¬ ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ (0~20)
let lastStaminaUpdate = 0;     // ë§ˆì§€ë§‰ ìŠ¤íƒœë¯¸ë‚˜ ê°±ì‹  ì‹œê° (ms timestamp)

// ğŸ†• 25ê°• ì´ìƒ ê°•í™” ê²½ê³  ì•ˆë‚´ í‘œì‹œ ì—¬ë¶€ (ì„¸ì…˜ ê¸°ì¤€ 1íšŒ)
let hasSeen25Warning = false;
let ignoreNextUpgradeWarning = false;
  
// ğŸ§® ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ ê³„ì‚° (ë¦¬ì…‹ + íšŒë³µ ì²˜ë¦¬)
function recalcHuntStamina() {
  const now = Date.now();
  const today = getTodayDateString();

  // ìµœì´ˆ í˜¸ì¶œ ì‹œ ì´ˆê¸°í™”
  if (!lastStaminaUpdate) {
    lastStaminaUpdate = now;
  }

  // ğŸ” ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ 00ì‹œì— í’€ íšŒë³µ (20ê°œ)
  if (lastHuntDate !== today) {
    lastHuntDate     = today;
    huntStamina      = 20;
    lastStaminaUpdate = now;
    huntCountToday   = 0;
    return;
  }

  // ì´ë¯¸ ê°€ë“ ì°¨ ìˆìœ¼ë©´ ë” íšŒë³µ X
  if (huntStamina >= 20) return;

  const intervalMs = 20 * 60 * 1000; // 20ë¶„
  const elapsed    = now - lastStaminaUpdate;
  if (elapsed <= 0) return;

  // ì§€ë‚œ ì‹œê°„ ë™ì•ˆ íšŒë³µ ê°€ëŠ¥í•œ ê°œìˆ˜
  const gained = Math.floor(elapsed / intervalMs);
  if (gained <= 0) return;

  huntStamina = Math.min(20, huntStamina + gained);
  // ë§ˆì§€ë§‰ íšŒë³µ ê¸°ì¤€ ì‹œê° ì•ìœ¼ë¡œ ë‹¹ê²¨ì£¼ê¸°
  lastStaminaUpdate += gained * intervalMs;

  // ì°¸ê³ ìš©: ì˜¤ëŠ˜ ì‚¬ìš©í•œ íšŸìˆ˜ = 20 - ë‚¨ì€ ìŠ¤íƒœë¯¸ë‚˜
  huntCountToday = Math.max(0, 20 - huntStamina);
}

// ğŸ§­ ì‚¬ëƒ¥ UIë§Œ ê°±ì‹  (ë²„íŠ¼ í…ìŠ¤íŠ¸ + ë‚¨ì€ ì‹œê°„ í‘œì‹œ)
function updateHuntUI() {
  const huntBtnEl  = document.getElementById("huntBtn");
  const huntInfoEl = document.getElementById("huntInfo");
  if (!huntBtnEl || !huntInfoEl) return;

  // ë§¤ë²ˆ ë¶€ë¥¼ ë•Œë§ˆë‹¤ ìŠ¤íƒœë¯¸ë‚˜ ì¬ê³„ì‚°
  recalcHuntStamina();

  const remaining = huntStamina;
  huntBtnEl.textContent = `âš”ï¸ ì‚¬ëƒ¥ (${remaining}/20)`;

  // íšŒë³µê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
  let infoText = "";
  const intervalMs = 20 * 60 * 1000;

 if (remaining >= 20) {
  infoText = `[ 00:00 ]`;
} else {
  const now = Date.now();
  const elapsed = now - lastStaminaUpdate;

  const passed = Math.max(0, elapsed);
  const remainMs = intervalMs - (passed % intervalMs);
  const totalSec = Math.floor(remainMs / 1000);

  const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
  const ss = String(totalSec % 60).padStart(2, "0");

  infoText = `[ ${mm}:${ss} ]`;
}

  huntInfoEl.style.fontSize   = "13px";
  huntInfoEl.style.color      = "#ccc";
  huntInfoEl.style.whiteSpace = "pre-line"; // \n ì¤„ë°”ê¿ˆ
  huntInfoEl.textContent      = infoText;
}

// âš”ï¸ ê²°íˆ¬ ë²„íŠ¼ UI ê°±ì‹ 
function updateDuelUI() {
  const btn = document.getElementById("duelBtn");
  const remainTextEl = document.getElementById("duelRemainText");

  ensureDuelDate(); // ë‚ ì§œ ë°”ë€Œë©´ ê²°íˆ¬íšŸìˆ˜ ë¦¬ì…‹

  const remain = Math.max(0, 10 - duelCountToday);

  // ë²„íŠ¼ ë¼ë²¨ì€ í•­ìƒ 'ê²°íˆ¬ì¥'
  if (btn) {
    btn.textContent = "âš”ï¸ ê²°íˆ¬ì¥";
  }

  // ê²°íˆ¬ì¥ íŒì—… ì•ˆ ë‚¨ì€ íšŸìˆ˜ í‘œì‹œ
  if (remainTextEl) {
    remainTextEl.textContent = `ì˜¤ëŠ˜ ë‚¨ì€ ê²°íˆ¬: ${remain}/10`;
  }
}

// ğŸ ì•„ì´í…œ ë³´ìœ  ìˆ˜ëŸ‰
let itemScroll15 = 0;   // 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
let itemProtect  = 0;   // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
let itemSuper    = 0;   // ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
let itemDownProtect = 0;  // ğŸ†• ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ
let starShard = 0;      // â­ ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°
let itemScroll21 = 0;     // 21ê°• ê°•í™” ì£¼ë¬¸ì„œ
let itemRateUp5  = 0;   // ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ

// ğŸ“œ ë§ˆë²• ìŠ¤í¬ë¡¤ ìƒì  íŒë§¤ ì•„ì´í…œ
const scrollShopItems = [
  {
    id: "scroll21",
    name: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",
    priceType: "starShard",   // ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°
    price: 10,
    img: "images/items/scroll_21.png",
    desc: "í•œ ë²ˆì— ë¬´ê¸°ë¥¼ 21ê°•ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
  },
  {
    id: "protect",
    name: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",
    priceType: "starShard",
    price: 30,
    img: "images/items/scroll_protect.png",
    desc: "ê°•í™” ì‹¤íŒ¨ ì‹œ ë¬´ê¸°ê°€ íŒŒê´´ë˜ëŠ” ê²ƒì„ 1íšŒ ë§‰ì•„ì¤ë‹ˆë‹¤."
  },
  {
    id: "super",
    name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ",
    priceType: "starShard",
    price: 50,
    img: "images/items/scroll_super.png",
    desc: "ê°•í™” ì„±ê³µ ì‹œ í•œ ë²ˆì— +2ê°•ì´ ë˜ëŠ” íŠ¹ë³„í•œ ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
  },
  {
    id: "rateUp5",
    name: "ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ",
    priceType: "honor",       // ëª…ì˜ˆì˜ í›ˆì¥
    price: 50,
    img: "images/items/scroll_rateup_5.png",
    desc: "ì´ë²ˆ ê°•í™” ì‹œ ì„±ê³µ í™•ë¥ ì´ 5%p ì¦ê°€í•©ë‹ˆë‹¤."
  }
];

// ğŸ“¦ ì¿ í° ì½”ë“œ ë³´ìƒ ëª©ë¡ (ì›í•˜ëŠ” ëŒ€ë¡œ ì½”ë“œ/ë³´ìƒ ìˆ˜ì •)
const couponRewards = {
  // 21ê°• ê°•í™” ì£¼ë¬¸ì„œ 1ê°œ
  "SPEARMAN": {
    type: "itemScroll21",
    count: 1,
    desc: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ 1ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤."
  },

  // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œ
  "LINEAR": {
    type: "itemProtect",
    count: 1,
    desc: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤."
  }

  // ğŸ‘‡ ì›í•˜ëŠ” ë§Œí¼ ë” ì¶”ê°€ ê°€ëŠ¥
  // "CODE123": { type: "itemSuper", count: 1, desc: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ 1ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤." }
};
  
// 1. ëœë¤ ì¶œë ¥ìš© ìƒì  ì…ì¥ ê¸°ë³¸ ë©˜íŠ¸ë“¤
const scrollShopNpcIdleLines = [
  "ì™”ë„¤? ì˜¤ëŠ˜ë„ ì£¼ë¬¸ì„œ ì¢€ ë³´ëŸ¬ ì˜¨ ê±°ì§€?",
  "íŒŒê´´í•´ì„œ ëª¨ì€ ì¡°ê°ë“¤, ì—¬ê¸°ì„œ ì œëŒ€ë¡œ ì¨ë³´ìê³ .",
  "ì¡°ê¸ˆ ì²œì²œíˆ ê°€ë„ ê´œì°®ì•„. ì•ˆì „ì¥ì¹˜ ì±™ê¸°ëŠ” ê²ƒë„ ì‹¤ë ¥ì´ì•¼."
];

// ì„ íƒëœ ì•„ì´í…œ / ì²˜ë¦¬ ì¤‘ ì—¬ë¶€
let scrollShopSelectedItem = null;
let scrollShopIsProcessing = false;

  // ğŸ“œ ìƒì  ì—´ê¸°
function openScrollShop() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const overlay = document.getElementById("scrollShopOverlay");
  if (!overlay) return;

  renderScrollShopItems();     // ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
  updateScrollShopCurrency();  // ì¬í™” í‘œì‹œ
  setScrollShopNpcIdle();      // ëœë¤ ë©˜íŠ¸

  overlay.style.display = "block";
}

// ğŸ“œ ìƒì  ë‹«ê¸°
function closeScrollShop() {
  const overlay = document.getElementById("scrollShopOverlay");
  if (!overlay) return;

  overlay.style.display = "none";
  scrollShopSelectedItem = null;
  scrollShopIsProcessing = false;

  const btnBox = document.getElementById("scrollShopNpcButtons");
  if (btnBox) btnBox.style.display = "none";
}

// ìƒë‹¨ ì¬í™” í‘œì‹œ ê°±ì‹ 
function updateScrollShopCurrency() {
  const starEl  = document.getElementById("scrollShopStarShard");
  const honorEl = document.getElementById("scrollShopHonorMedal");

  if (starEl)  starEl.textContent  = starShard;
  if (honorEl) honorEl.textContent = itemHonorMedal;
}

// ğŸ“œ ìƒì  ì „ìš© NPC í™•ì¸ íŒì—… (ì˜ˆ / ì•„ë‹ˆìš”)
function showScrollShopConfirmPopup(item) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) {
    // í˜¹ì‹œë¼ë„ ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ alertë¡œ ëŒ€ì²´
    alert(`ì´ê±´ '${item.name}'ì´ì•¼. êµ¬ë§¤í• ë˜?`);
    return;
  }

  // ìƒì  NPC ì„¸íŒ…
  setNpcName("ì„¸ë ˆë‚˜ ì—ë¸ë¦°");
  imgEl.style.display = "block";
  imgEl.src = "images/npc/npc_scrollshop_talk.png";

  const currencyLabel =
    item.priceType === "starShard"
      ? "ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°"
      : "ëª…ì˜ˆì˜ í›ˆì¥";

  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ì´ê±´ '<b>${item.name}</b>'ì´ì•¼.
    </div>
    <div style="font-size:13px; line-height:1.5;">
      <span style="color:#ffd27f;">${currencyLabel} ${item.price}ê°œ</span>ë¡œ ì‚´ë˜?
    </div>
  `;

  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "ì‚°ë‹¤";
  cancelBtn.textContent = "ê·¸ë§Œë‘˜ë˜";

  okBtn.onclick = function () {
    popup.style.display = "none";
    proceedScrollShopPurchase(item);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
    // ì·¨ì†Œí•˜ë©´ ê·¸ëƒ¥ ìƒì  NPCëŠ” ê¸°ì¡´ ëœë¤ ë©˜íŠ¸ ìœ ì§€
  };

  popup.style.display = "flex";
}
  
// 1. ëœë¤ ì¶œë ¥ : ê¸°ë³¸ NPC ë©˜íŠ¸
function setScrollShopNpcIdle() {
  const textEl = document.getElementById("scrollShopNpcText");
  const imgEl  = document.getElementById("scrollShopNpcImg");
  if (!textEl || !imgEl) return;

  if (scrollShopNpcIdleLines.length === 0) {
    textEl.innerHTML = "";
  } else {
    const idx = Math.floor(Math.random() * scrollShopNpcIdleLines.length);
    textEl.innerHTML = scrollShopNpcIdleLines[idx];
  }

  imgEl.src = "images/npc/npc_scrollshop_idle.png";

  const btnBox = document.getElementById("scrollShopNpcButtons");
  if (btnBox) btnBox.style.display = "none";
}

  // ìƒì  ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderScrollShopItems() {
  const listEl = document.getElementById("scrollShopItemList");
  if (!listEl) return;

  let html = "";

  scrollShopItems.forEach((item) => {
    const priceIcon =
      item.priceType === "starShard"
        ? "images/items/star_shard.png"
        : "images/items/honor_medal.png";

    html += `
      <div
        class="scroll-shop-row"
        style="display:flex; align-items:center; padding:4px 6px;
               border-bottom:1px solid #333; cursor:pointer;"
        onclick="onClickScrollShopItem('${item.id}')"
      >
        <!-- ì•„ì´ì½˜ (í´ë¦­ì‹œ ì„¤ëª…) -->
        <div
  style="width:36px; height:36px; margin-right:8px; flex-shrink:0;"
  onclick="event.stopPropagation(); onClickScrollShopIcon('${item.id}', event)"
>
          <img
            src="${item.img}"
            alt="${item.name}"
            style="max-width:100%; max-height:100%;"
          >
        </div>

        <!-- ì•„ì´í…œëª… -->
        <div style="flex:1; text-align:left;">
          ${item.name}
        </div>

        <!-- ì˜¤ë¥¸ìª½ ê°€ê²© -->
        <div style="display:flex; align-items:center; gap:4px;">
          <img src="${priceIcon}" alt="" style="width:20px; height:20px;">
          <span>x ${item.price}</span>
        </div>
      </div>
    `;
  });

  listEl.innerHTML = html;
}

// ì•„ì´ì½˜ í´ë¦­ â†’ ì¸ë²¤í† ë¦¬ì™€ ê°™ì€ ì•„ì´í…œ ìƒì„¸ íŒì—… ì‚¬ìš©
function onClickScrollShopIcon(itemId, ev) {
  const item = scrollShopItems.find(i => i.id === itemId);
  if (!item) return;

  // ê¸°ì¡´ ì¸ë²¤í† ë¦¬ìš© ìƒì„¸ íŒì—… ì¬ì‚¬ìš©
  // showItemDetail(item, í´ë¦­X, í´ë¦­Y)
  showItemDetail(item, ev.clientX, ev.clientY);
}

// ì¤„ ì „ì²´ í´ë¦­ â†’ ìƒì ìš© NPC íŒì—…ìœ¼ë¡œ êµ¬ë§¤ ì˜ì‚¬ ë¬»ê¸°
function onClickScrollShopItem(itemId) {
  const item = scrollShopItems.find(i => i.id === itemId);
  if (!item) return;

  scrollShopSelectedItem = item;

  // í•˜ë‹¨ NPCëŠ” ê·¸ëƒ¥ ê¸°ë³¸ ëŒ€ì‚¬ ìœ ì§€í•˜ê³ ,
  // ì‹¤ì œ êµ¬ë§¤ í™•ì •ì€ íŒì—…ì—ì„œ ì²˜ë¦¬
  showScrollShopConfirmPopup(item);
}

  // "ì•„ë‹ˆìš”" í´ë¦­ â†’ ì·¨ì†Œ í›„ ë‹¤ì‹œ ëœë¤ ë©˜íŠ¸
function onClickScrollShopNo() {
  scrollShopSelectedItem = null;
  const btnBox = document.getElementById("scrollShopNpcButtons");
  if (btnBox) btnBox.style.display = "none";

  setScrollShopNpcIdle();
}

  

  // ì¬í™” ì¶©ë¶„í•œì§€ ì²´í¬
function checkScrollShopCurrency(item) {
  if (item.priceType === "starShard") {
    return starShard >= item.price;
  }
  if (item.priceType === "honor") {
    return itemHonorMedal >= item.price;
  }
  return false;
}

  // ğŸ“œ ìƒì  êµ¬ë§¤ ì§„í–‰ (ì¬í™” ë¶€ì¡± / êµ¬ë§¤ì¤‘ / ì„±ê³µ ëª¨ë‘ íŒì—… ì²˜ë¦¬)
function proceedScrollShopPurchase(item) {
  if (scrollShopIsProcessing) return;

  // ë¨¼ì € ì¬í™” ë¶€ì¡± ì²´í¬
  if (!checkScrollShopCurrency(item)) {
    showNpcMessage(
      `
      <div style="font-size:15px; margin-bottom:4px;">
        ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
      </div>
      <div style="font-size:13px;">
        ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
      </div>
      `,
      "images/npc/npc_scrollshop_calm.png",
      true,
      "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
    );
    return;
  }

  scrollShopIsProcessing = true;

  // 4. â€œì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.â€ â€“ ì‹œìŠ¤í…œ íŒì—… (NPC ì—†ì´)
  showNpcMessage(
    `<div style="font-size:14px;">ì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.</div>`,
    null,   // imgPath = null â†’ NPC ì—†ì´ ì‚¬ìš©
    false,  // showButton = false â†’ ë²„íŠ¼ ìˆ¨ê¹€
    ""
  );

  setTimeout(() => {
    // ë‹¤ì‹œ í•œ ë²ˆ ì¬í™” ì²´í¬ (ì¤‘ê°„ì— ê°’ ë°”ë€Œì—ˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ)
    if (!checkScrollShopCurrency(item)) {
      showNpcMessage(
        `
        <div style="font-size:15px; margin-bottom:4px;">
          ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
        </div>
        <div style="font-size:13px;">
          ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
        </div>
        `,
        "images/npc/npc_scrollshop_calm.png",
        true,
        "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
      );
      scrollShopIsProcessing = false;
      return;
    }

    // ì‹¤ì œ ì¬í™” ì°¨ê°
    if (item.priceType === "starShard") {
      starShard -= item.price;
      if (starShard < 0) starShard = 0;
    } else if (item.priceType === "honor") {
      itemHonorMedal -= item.price;
      if (itemHonorMedal < 0) itemHonorMedal = 0;
    }

    // ì•„ì´í…œ ì§€ê¸‰ + ë¡œê·¸/ì €ì¥/ì¸ë²¤í† ë¦¬ ê°±ì‹ 
    grantScrollShopItem(item);

    // 5. êµ¬ë§¤ ì„±ê³µ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:15px; margin-bottom:4px;">
        ì¢‹ì•„, ì˜ ìƒ€ë‹¤.
      </div>
      <div style="font-size:13px;">
        ì´ë²ˆì—”â€¦ ëŠë‚Œ ì˜¤ì§€?
      </div>
      `,
      "images/npc/npc_scrollshop_happy.png",
      true,
      "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
    );

    // í•˜ë‹¨ NPC ëŒ€ì‚¬ë„ ë‹¤ì‹œ ëœë¤ìœ¼ë¡œ ë˜ëŒë ¤ì£¼ë©´ ìì—°ìŠ¤ëŸ¬ì›€
    setScrollShopNpcIdle();

    scrollShopIsProcessing = false;
    scrollShopSelectedItem = null;
  }, 1000);  // 1ì´ˆ ë”œë ˆì´
}

// ì‹¤ì œ ì•„ì´í…œ ì§€ê¸‰ ì²˜ë¦¬
function grantScrollShopItem(item) {
  if (item.id === "scroll21")   itemScroll21++;
  if (item.id === "protect")    itemProtect++;
  if (item.id === "super")      itemSuper++;
  if (item.id === "rateUp5")    itemRateUp5++;

  updateScrollShopCurrency();   // ì¬í™” í‘œì‹œ ê°±ì‹ 
  updateUpgradeItemLabels();    // ê¸°ì¡´ í•¨ìˆ˜ (ì•„ì´í…œ ìˆ˜ëŸ‰ ë¼ë²¨ ê°±ì‹ )
  renderInventory();            // ì¸ë²¤í† ë¦¬ ê°±ì‹ 
  update();                     // ë©”ì¸ UI ê°±ì‹ 
  save();                       // Firebase ì €ì¥
}

// "ì˜ˆ" í´ë¦­
function onClickScrollShopYes() {
  if (!scrollShopSelectedItem || scrollShopIsProcessing) return;
  const item = scrollShopSelectedItem;

  const textEl = document.getElementById("scrollShopNpcText");
  const imgEl  = document.getElementById("scrollShopNpcImg");
  const btnBox = document.getElementById("scrollShopNpcButtons");

  // ë¨¼ì € ì¬í™” ë¶€ì¡± ì²´í¬
  if (!checkScrollShopCurrency(item)) {
    // 3. ì¬í™” ë¶€ì¡± ë©˜íŠ¸
    if (textEl) {
      textEl.innerHTML =
        "ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.<br>" +
        "ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.";
    }
    if (imgEl) {
      imgEl.src = "images/npc/scroll_sad.png";
    }
    if (btnBox) {
      btnBox.style.display = "none";
    }
    scrollShopSelectedItem = null;
    return;
  }

  // ì—¬ê¸°ë¶€í„°ëŠ” êµ¬ë§¤ ì§„í–‰ ì¤‘
  scrollShopIsProcessing = true;
  if (btnBox) btnBox.style.display = "none";

  // 4. â€œì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.â€
  if (textEl) {
    textEl.innerHTML = "ì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.";
  }
  if (imgEl) {
    imgEl.src = "images/npc/scroll_talk.png";
  }

  setTimeout(() => {
    // ì•ˆì „í•˜ê²Œ í•œ ë²ˆ ë” ì²´í¬
    if (!checkScrollShopCurrency(item)) {
      if (textEl) {
        textEl.innerHTML =
          "ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.<br>" +
          "ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.";
      }
      if (imgEl) imgEl.src = "images/npc/scroll_sad.png";
      scrollShopIsProcessing = false;
      scrollShopSelectedItem = null;
      return;
    }

    // ì‹¤ì œ ì¬í™” ì°¨ê°
    if (item.priceType === "starShard") {
      starShard -= item.price;
      if (starShard < 0) starShard = 0;
    } else if (item.priceType === "honor") {
      itemHonorMedal -= item.price;
      if (itemHonorMedal < 0) itemHonorMedal = 0;
    }

    // ì•„ì´í…œ ì§€ê¸‰
    grantScrollShopItem(item);

    // 5. êµ¬ë§¤ ì„±ê³µ ë©˜íŠ¸
    if (textEl) {
      textEl.innerHTML = "ì¢‹ì•„, ì˜ ìƒ€ë‹¤.<br>ì´ë²ˆì—”â€¦ ëŠë‚Œ ì˜¤ì§€?";
    }
    if (imgEl) {
      imgEl.src = "images/npc/scroll_happy.png";
    }

    scrollShopIsProcessing = false;
    scrollShopSelectedItem = null;
  }, 1000);   // 1ì´ˆ ë”œë ˆì´
}
  
// ì‚¬ëƒ¥í„° ì •ë³´ (ì¶”ì²œ ë ˆë²¨ / ì´ë¦„)
const HUNT_FIELDS = [
  null, // ì¸ë±ìŠ¤ 0 ë¹„ì›€ (1ë¶€í„° ì‹œì‘)
  { id:1, name:"í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„",   recLevel:0  },
  { id:2, name:"ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½", recLevel:3  },
  { id:3, name:"ë¬´ë²•ìë“¤ì˜ í™©ì•¼",     recLevel:6  },
  { id:4, name:"ëŠªì—˜í”„ì˜ ìˆ²",         recLevel:9  },
  { id:5, name:"ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´",     recLevel:12 },
  { id:6, name:"ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„",   recLevel:15 },
  { id:7, name:"ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´", recLevel:18 },
  { id:8, name:"ëŒ€ì²œì‚¬ì˜ ìš”ëŒ",       recLevel:21 },
  { id:9, name:"ì‹ ì˜ ì²˜ì†Œ",           recLevel:24 },
  { id:10,name:"ì°¨ì›ì˜ í‹ˆìƒˆ",         recLevel:27 }
];
  // ê° ì‚¬ëƒ¥í„°ë³„ ë°°ê²½ ì´ë¯¸ì§€ (íŒŒì¼ëª…ì€ ì˜ˆì‹œ)
const FIELD_BACKGROUNDS = {
  1: "images/fields/field1_mushroom_heinesis.png",    // í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„
  2: "images/fields/field2_sewer_zaun.png",           // ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½
  3: "images/fields/field3_outlaw_west.png",          // ë¬´ë²•ìë“¤ì˜ í™©ì•¼
  4: "images/fields/field4_swamp_elf.png",            // ëŠªì—˜í”„ì˜ ìˆ²
  5: "images/fields/field5_frost_queen_cave.png",     // ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´
  6: "images/fields/field6_lich_deathrealm.png",      // ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„
  7: "images/fields/field7_behemoth_hellpit.png",     // ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´
  8: "images/fields/field8_archangel_cradle.png",     // ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
  9: "images/fields/field9_gods_throne.png",          // ì‹ ì˜ ì²˜ì†Œ
  10:"images/fields/field10_dimensional_rift.png"     // ì°¨ì›ì˜ í‹ˆìƒˆ
};

// âš”ï¸ VS ì—°ì¶œ í‘œì‹œ
function showDuelBattleOverlay(params) {
  const ov = document.getElementById("duelBattleOverlay");
  if (!ov) return;

    // â­ ê²°íˆ¬ VS ëŒ€ê¸° ì‹œì‘ â†’ ì „ì²´ ì•¡ì…˜ ì ê¸ˆ
  isDueling = true;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = true);

  const {
    myName,
    myLevelHtml,
    myPower,
    myWeaponInfo,
    targetName,
    targetLevelHtml,
    targetPower,
    targetWeaponInfo
  } = params;

  const myNameEl    = document.getElementById("duelMyName");
  const myWeaponEl  = document.getElementById("duelMyWeapon");
  const myPowerEl   = document.getElementById("duelMyPower");
  const myImgEl     = document.getElementById("duelMyWeaponImg");

  const tNameEl     = document.getElementById("duelTargetName");
  const tWeaponEl   = document.getElementById("duelTargetWeapon");
  const tPowerEl    = document.getElementById("duelTargetPower");
  const tImgEl      = document.getElementById("duelTargetWeaponImg");

  if (myNameEl)   myNameEl.textContent   = myName || "";
  if (tNameEl)    tNameEl.textContent    = targetName || "";

  // ë¬´ê¸° ì´ë¦„ + ê°•í™”(+00ê°•) ê°™ì´ ì¶œë ¥
  if (myWeaponEl) {
    myWeaponEl.innerHTML =
      (myWeaponInfo?.name || "???") + " " + (myLevelHtml || "");
  }
  if (tWeaponEl) {
    tWeaponEl.innerHTML =
      (targetWeaponInfo?.name || "???") + " " + (targetLevelHtml || "");
  }

  if (myPowerEl) myPowerEl.textContent =
    "ì „íˆ¬ë ¥ " + formatGold(myPower || 0);
  if (tPowerEl) tPowerEl.textContent =
    "ì „íˆ¬ë ¥ " + formatGold(targetPower || 0);

  if (myImgEl && myWeaponInfo?.img) {
    myImgEl.src = myWeaponInfo.img;
  }
  if (tImgEl && targetWeaponInfo?.img) {
    tImgEl.src = targetWeaponInfo.img;
  }

  ov.style.display = "flex";
}

// âš”ï¸ VS ì—°ì¶œ ìˆ¨ê¸°ê¸°
function hideDuelBattleOverlay() {
  const ov = document.getElementById("duelBattleOverlay");
  if (ov) ov.style.display = "none";
  
    // â­ ê²°íˆ¬ VS ì¢…ë£Œ â†’ ì „ì²´ ì•¡ì…˜ ì ê¸ˆ í•´ì œ
  isDueling = false;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = false);
}
  
function logout() {

  // ğŸ” ì„œë²„ì— ë‚¨ì•„ìˆëŠ” ì„¸ì…˜ID ì œê±°
if (userRef) {
  userRef.child("sessionId").remove();
}

currentSessionId = null;
  
    // ğŸ”Œ ë­í‚¹/ìœ ì € ì‹¤ì‹œê°„ êµ¬ë… í•´ì œ (ì„ íƒ)
  db.ref("users").off();
  
  // ì €ì¥ëœ ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
  try {
    localStorage.removeItem("swordGameLastUser");
  } catch (e) {
    console.warn("localStorage remove ì‹¤íŒ¨", e);
  }

  // ìƒíƒœ ì´ˆê¸°í™”
  userId = "";
  userPassword = "";
  userRef = null;

  sword = 0;
  power = 10;
  gold  = 100;
  // âœ… ì—…ì /ì¹­í˜¸ì— ì§ì ‘ ì˜í–¥ ì£¼ëŠ” ê°’ë„ ì´ˆê¸°í™”(ì¤‘ìš”)
weaponType   = null;
maxSwordLevel = 0;
destroyCount  = 0;

  attendanceCount    = 0;
  lastAttendanceDate = "";
  currentField       = 1;
  huntCountToday     = 0;
  lastHuntDate       = "";
  itemScroll15       = 0;
  itemProtect        = 0;
  itemSuper          = 0;
  itemDownProtect    = 0;
  starShard          = 0;
  duelWin = 0;
  duelLose = 0;
  duelCountToday = 0;
  lastDuelDate = "";
  duelTargetsToday = {};

  // í™”ë©´ ì „í™˜
  document.getElementById("gameScreen").style.display   = "none";
  document.getElementById("loginScreen").style.display  = "block";
  document.getElementById("attendanceBtn").style.display = "none";
  document.getElementById("inventoryBtn").style.display = "none";
  document.getElementById("logToggle").style.display    = "none";
  document.getElementById("logoutBtn").style.display    = "none";
  document.getElementById("duelBtn").style.display      = "none";
  document.getElementById("scrollShopBtn").style.display = "none";
  document.getElementById("mapBtn").style.display       = "none";
  document.getElementById("couponBtn").style.display    = "none";
  document.getElementById("userListBtn").style.display  = "none";
  document.getElementById("achievementBtn").style.display = "none";

  titlesOwned = {};
equippedTitle = "";
  closeTitleOverlay();

    // âœ… ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ í•´ì œ
  stopAutoRefreshTimer();

  // í”„ë¡œí•„ ì˜ì—­ë„ ì´ˆê¸° ìƒíƒœë¡œ ê°±ì‹ 
  update();
}

// ğŸ–¼ ì‚¬ëƒ¥í„° ë°°ê²½ ì´ë¯¸ì§€ ì ìš©
function applyFieldBackground() {
  const bgEl = document.getElementById("fieldBg");
  if (!bgEl) return;

  // ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸í•œ FIELD_BACKGROUNDS ì‚¬ìš©
  const url = FIELD_BACKGROUNDS[currentField] || FIELD_BACKGROUNDS[1];

  // CSS ::beforeê°€ ì“¸ ì»¤ìŠ¤í…€ ì†ì„±ì— ì£¼ì…
  bgEl.style.setProperty("--field-bg-image", `url('${url}')`);
}

function setNpcName(name) {
  const nameEl = document.getElementById("npcPopupName");
  if (nameEl) nameEl.textContent = name;
}

// ğŸ” ì´ íƒ­ì˜ ì„¸ì…˜ ì‹œì‘ (ë¡œê·¸ì¸ ì„±ê³µ í›„ í˜¸ì¶œ)
function startSession() {
  if (!userRef) return;

  // ëœë¤ ì„¸ì…˜ID ìƒì„±
  currentSessionId = Date.now() + "_" + Math.random().toString(36).slice(2);

  // ì„œë²„ì— ë‚´ ì„¸ì…˜ID ê¸°ë¡
  userRef.child("sessionId").set(currentSessionId);

  // ì´ íƒ­ì´ ëŠê¸°ë©´ sessionId ìë™ ì œê±°
  userRef.child("sessionId").onDisconnect().remove();
}

  // ================================
// ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹ ì‹œìŠ¤í…œ (30ê°• â†’ 72ì‹œê°„ í›„ ê°•ì œ ì „ë‹¹í–‰)
// ================================
let hofUiTimer = null;
let hofSweepTimer = null;

// â³ ë‚¨ì€ ì‹œê°„ í‘œì‹œ(ì´ˆ ë‹¨ìœ„)
function formatLeftTime(msLeft) {
  const sec = Math.max(0, Math.floor(msLeft / 1000));
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

// ğŸ” 30ê°• ìœ ì €ë©´ ë²„íŠ¼ êµì²´(ê°•í™”/ì‚¬ëƒ¥/íŒë§¤ ìˆ¨ê¸°ê³  ì „ë‹¹ ë²„íŠ¼ë§Œ ë…¸ì¶œ)
function updateHonorHallButton() {
  const upBtn = document.getElementById("upgradeBtn");
  const huBtn = document.getElementById("huntBtn");
  const seBtn = document.getElementById("sellBtn");
  const hallBtn = document.getElementById("hallBtn");

  if (!hallBtn) return;

  // 30ê°• ë¯¸ë§Œ: ì›ë˜ ë²„íŠ¼
  if (Number(sword) < 30) {
    if (upBtn) upBtn.style.display = "";
    if (huBtn) huBtn.style.display = "";
    if (seBtn) seBtn.style.display = "";
    hallBtn.style.display = "none";
    hallBtn.textContent = "ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸°";
    return;
  }

  // 30ê°• ì´ìƒ: ì „ë‹¹ ë²„íŠ¼ë§Œ
  if (upBtn) upBtn.style.display = "none";
  if (huBtn) huBtn.style.display = "none";
  if (seBtn) seBtn.style.display = "none";
  hallBtn.style.display = "";

  // ë‚¨ì€ì‹œê°„ì´ ì—†ìœ¼ë©´ â€œê³§ ì „ë‹¹í–‰â€ í‘œì‹œ
  const left = Number(hofDeadline || 0) - Date.now();
  if (!hofDeadline || left <= 0) {
    hallBtn.textContent = "ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸° (ê³§ ìë™ ì²˜ë¦¬)";
  } else {
    hallBtn.textContent = `ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸° (${formatLeftTime(left)})`;
  }
}

// âœ… ì „ë‹¹ ë²„íŠ¼ í´ë¦­ íŒì—…
function openHonorHallSendPopup() {
  if (!userId || !userRef) return;

  const left = Number(hofDeadline || 0) - Date.now();
  const leftText = (hofDeadline && left > 0) ? formatLeftTime(left) : "ê³§ ìë™ ì²˜ë¦¬";

  const html = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹
    </div>
    <div style="font-size:13px; line-height:1.5;">
      ${leftText} í›„, ë„ˆì˜ ê¸°ë¡ì€ <b>ëª…ì˜ˆì˜ ì „ë‹¹</b>ì— ìƒˆê²¨ì§ˆ ê±°ì•¼.<br>
      ì „ë‹¹ì— ë³´ë‚´ë©´ <b>ë¬´ê¸°ëŠ” 0ê°•ìœ¼ë¡œ ëŒì•„ê°€ê³ </b>, ë‹¤ì‹œ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê²Œ ë¼.<br>
      ê·¸ë˜ë„â€¦ ê·¸ ë³„ì€, ë„¤ ì´ë¦„ ë’¤ì— ë‚¨ì•„. (â˜…)
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
      <button onclick="sendMeToHallOfFame('manual')" style="padding:8px 12px;">
        ë³´ë‚¸ë‹¤
      </button>
      <button onclick="closeNpcPopup()" style="padding:8px 12px;">
        ì ì‹œë§Œ..
      </button>
    </div>
  `;

  showNpcMessage(html, "images/npc/linea_idle.png", false, "ì„œê¸°ê´€ ë¦¬ë„¤ì•„");
}

// âœ… ë‚´ ê³„ì •ì„ ì „ë‹¹ìœ¼ë¡œ ë³´ë‚´ê¸°
function sendMeToHallOfFame(reason) {
  closeNpcPopup();
  sendUserToHallOfFame(userId, reason || "manual");
}

// âœ… ì „ë‹¹ ê¸°ë¡ ìƒì„± + ìœ ì € ë¦¬ì…‹ (ì¤‘ë³µ ë°©ì§€ í¬í•¨)
function sendUserToHallOfFame(targetId, reason) {
  if (!targetId) return;

  const uref = db.ref("users/" + targetId);
  uref.once("value").then(snap => {
    const u = snap.val();
    if (!u) return;

    const uSword = Number(u.sword || 0);
    const uDeadline = Number(u.hofDeadline || 0);
    const uProcessedAt = Number(u.hofProcessedAt || 0);

    // ì´ë¯¸ ì²˜ë¦¬ëœ ìœ ì €ë©´ ì¢…ë£Œ
    if (uProcessedAt && uProcessedAt > 0) {
      db.ref("hofQueue/" + targetId).remove();
      return;
    }

    // 30ê°•ì´ ì•„ë‹ˆë©´ íì—ì„œ ì œê±°
    if (uSword < 30) {
      db.ref("hofQueue/" + targetId).remove();
      return;
    }

    // ìˆ˜ë™ì´ ì•„ë‹Œë° ì•„ì§ ë§Œë£Œ ì „ì´ë©´ ì²˜ë¦¬ ê¸ˆì§€
    const now = Date.now();
    if (reason !== "manual" && uDeadline && now < uDeadline) {
      return;
    }

    const wt = u.hofWeaponTypeAt30 || u.weaponType || "sword";
    const achievedAt = Number(u.hofAchievedAt || now);
    const stars = Number(u.reach30Count || 0);

    // ì „ë‹¹ ê¸°ë¡ ì‘ì„± (push)
    const hofRef = db.ref("hallOfFame").push();
    const wInfo = getWeaponInfo(30, wt);
    const record = {
      id: targetId,
      weaponType: wt,
      weaponName: (wInfo && wInfo.name) ? wInfo.name : "+30ê°•",
      achievedAt: achievedAt,
      recordedAt: now,
      stars: stars,
      reason: reason || "auto"
    };

    // ìœ ì € ë¦¬ì…‹ (ê³¨ë“œëŠ” ìœ ì§€, ë¬´ê¸° 0ê°•)
    const updates = {
      sword: 0,
      power: 10,                 // 0ê°• ê¸°ë³¸ ì „íˆ¬ë ¥ (í˜„ì¬ íŒŒì¼ ê¸°ë³¸ê°’)
      weaponType: null,          // 0ê°• ê³µìš© ìƒíƒœë¡œ ë˜ëŒë¦¼ (ë‹¤ìŒ 1ê°• ë•Œ ë‹¤ì‹œ ëœë¤ë°°ì •)
      hofProcessedAt: now,
      hofDeadline: 0,
      hofAchievedAt: 0,
      hofWeaponTypeAt30: ""
    };

    // ê¸°ë¡ + ë¦¬ì…‹ + í ì œê±°
    const multi = {};
    multi["hallOfFame/" + hofRef.key] = record;
    multi["users/" + targetId + "/sword"] = updates.sword;
    multi["users/" + targetId + "/power"] = updates.power;
    multi["users/" + targetId + "/weaponType"] = updates.weaponType;
    multi["users/" + targetId + "/hofProcessedAt"] = updates.hofProcessedAt;
    multi["users/" + targetId + "/hofDeadline"] = updates.hofDeadline;
    multi["users/" + targetId + "/hofAchievedAt"] = updates.hofAchievedAt;
    multi["users/" + targetId + "/hofWeaponTypeAt30"] = updates.hofWeaponTypeAt30;
    multi["hofQueue/" + targetId] = null;

    db.ref().update(multi).then(() => {
      // ë³¸ì¸ì´ë¼ë©´ ì¦‰ì‹œ ë¡œì»¬ ìƒíƒœë„ ë°˜ì˜
      if (targetId === userId) {
        sword = 0;
        power = 10;
        weaponType = null;

        hofDeadline = 0;
        hofAchievedAt = 0;
        hofWeaponTypeAt30 = "";
        hofProcessedAt = now;

        update();
        updateHonorHallButton();
      }
    });
  });
}

// ğŸ” ì „ë‹¹ í ìŠ¤ìœ•: ë§Œë£Œëœ ìœ ì €ë¥¼ ì°¾ì•„ ìë™ ì „ë‹¹í–‰ ì²˜ë¦¬
function sweepHofQueue() {
  const now = Date.now();

  // 1) hofQueue ê¸°ë°˜ ìŠ¤ìœ• (ê¸°ì¡´ ë°©ì‹)
  db.ref("hofQueue")
    .orderByValue()
    .endAt(now)
    .limitToFirst(10)
    .once("value")
    .then(snap => {
      const val = snap.val();
      if (val) {
        Object.keys(val).forEach(uid => {
          sendUserToHallOfFame(uid, "auto");
        });
      }
    })
    .catch(() => {});

  // 2) âœ… ì•ˆì „ë§: hofQueueê°€ ëˆ„ë½/ê¹¨ì ¸ë„ users.hofDeadline ê¸°ë°˜ìœ¼ë¡œ ë§Œë£Œ ìœ ì €ë¥¼ ì§ì ‘ ì°¾ì•„ ì²˜ë¦¬
  db.ref("users")
    .orderByChild("hofDeadline")
    .endAt(now)
    .limitToFirst(10)
    .once("value")
    .then(snap => {
      snap.forEach(child => {
        const uid = child.key;
        const u = child.val() || {};

        // ì´ë¯¸ ì²˜ë¦¬ëìœ¼ë©´ ìŠ¤í‚µ
        if (Number(u.hofProcessedAt || 0) > 0) return;

        // 30ê°• ì´ìƒ + ë°ë“œë¼ì¸ ë§Œë£Œì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
        if (Number(u.sword || 0) >= 30 && Number(u.hofDeadline || 0) > 0 && Number(u.hofDeadline || 0) <= now) {
          sendUserToHallOfFame(uid, "auto");
        }
      });
    })
    .catch(() => {});
}

// âœ… ë¡œê·¸ì¸ í›„ í˜¸ì¶œ: ë²„íŠ¼ íƒ€ì´ë¨¸ + í ìŠ¤ìœ• íƒ€ì´ë¨¸ ì‹œì‘
function startHonorHallTimers() {
  // UI 1ì´ˆ ê°±ì‹ 
  if (hofUiTimer) clearInterval(hofUiTimer);
  hofUiTimer = setInterval(() => {
    updateHonorHallButton();

    // ë³¸ì¸ì´ ë§Œë£Œë˜ë©´ ìë™ ì²˜ë¦¬ íŠ¸ë¦¬ê±°(ë³¸ì¸ë„ ì¦‰ì‹œ ì „ë‹¹í–‰)
    if (userId && Number(sword) >= 30 && hofDeadline && Date.now() >= hofDeadline) {
      sendUserToHallOfFame(userId, "auto");
    }
  }, 1000);

  // í ìŠ¤ìœ•(ë‹¤ë¥¸ ìœ ì € í¬í•¨)
  if (hofSweepTimer) clearInterval(hofSweepTimer);
   sweepHofQueue();
  hofSweepTimer = setInterval(() => {
    sweepHofQueue();
  }, 15000); // 15ì´ˆë§ˆë‹¤ ìŠ¤ìœ•
}

// ğŸŒˆ ì „ë‹¹ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
function loadHallOfFame() {
  const listEl = document.getElementById("hallOfFameList");
  if (!listEl) return;

  db.ref("hallOfFame")
    .limitToLast(30)
    .on("value", (snap) => {
      const obj = snap.val() || {};
      const arr = Object.keys(obj).map(k => ({ key:k, ...obj[k] }));

      // ìµœì‹  ê¸°ë¡ì´ ìœ„ë¡œ
      arr.sort((a, b) => Number(b.recordedAt || 0) - Number(a.recordedAt || 0));

      if (arr.length === 0) {
        listEl.innerHTML = `<div style="text-align:center; color:#999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

listEl.innerHTML = arr.map((r, i) => {
  const d = r.achievedAt
    ? new Date(Number(r.achievedAt)).toLocaleString("ko-KR")
    : "-";

  const starCount = Math.min(10, Number(r.stars || 0));
  const stars = "â˜…".repeat(starCount);

  return `
    <div style="padding:6px 0; border-bottom:1px solid #333;">
      <div style="font-size:12px; color:#ddd;">
        <b>${i + 1}.</b>
        ${r.id}${starCount > 0 ? ` <span class="rainbowStar">${stars}</span>` : ""}
        <span style="color:#666;"> ã…£ </span>
        <span style="color:#ccc;">${r.weaponName} (+30ê°•)</span>
        <span style="color:#666;"> ã…£ </span>
        <span style="color:#aaa; font-size:11px;">${d}</span>
      </div>
    </div>
  `;
}).join("");
    });
}

// ğŸ¯ ê°•í™” ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ ë¼ë²¨ ìˆ˜ëŸ‰ ê°±ì‹ 
function updateUpgradeItemLabels() {
  const elScroll15 = document.getElementById("labelUseScroll15");
  const elProtect  = document.getElementById("labelUseProtect");
  const elDownProt = document.getElementById("labelUseDownProtect");
  const elSuper    = document.getElementById("labelUseSuper");
  const elScroll21 = document.getElementById("labelUseScroll21");   // ğŸ†•
  const elRate5    = document.getElementById("labelUseRateUp5");    // ğŸ†•


  if (elScroll15) {
    elScroll15.textContent = `15ê°• ê°•í™” ì£¼ë¬¸ì„œ (${itemScroll15})`;
  }
  if (elProtect) {
    elProtect.textContent = `íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ (${itemProtect})`;
  }
  if (elDownProt) {
    elDownProt.textContent = `ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ (${itemDownProtect})`;
  }
  if (elSuper) {
    elSuper.textContent = `ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ (${itemSuper})`;
  }
  if (elScroll21) {
    elScroll21.textContent = `21ê°• ê°•í™” ì£¼ë¬¸ì„œ (${itemScroll21})`;
  }
  if (elRate5) {
    elRate5.textContent = `ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ (${itemRateUp5})`;
  }
}

/* UI */
  
const TITLE_DEFS = [
  { id:"newbie",   name:"ìƒˆë‚´ê¸° ëŒ€ì¥ì¥ì´", how:"ìµœì´ˆ 1íšŒ ê°•í™” ì„±ê³µ" },
  { id:"master15", name:"ëª…ì¸",             how:"ë¬´ê¸° 15ê°• ë‹¬ì„±" },
  { id:"artisan21",name:"ì¥ì¸",             how:"ë¬´ê¸° 21ê°• ë‹¬ì„±" },
  { id:"legend26", name:"ì „ì„¤",             how:"ë¬´ê¸° 26ê°• ë‹¬ì„±" },

  { id:"knight",   name:"ê¸°ì‚¬",   how:"ê²€ìœ¼ë¡œ 21ê°• ë‹¬ì„±" },
  { id:"warrior",  name:"ì „ì‚¬",   how:"ì°½ìœ¼ë¡œ 21ê°• ë‹¬ì„±" },
  { id:"viking",   name:"ë°”ì´í‚¹", how:"ë„ë¼ë¡œ 21ê°• ë‹¬ì„±" },

  { id:"destroy100", name:"íŒŒê´´ì™•", how:"ë¬´ê¸° íŒŒê´´ íšŸìˆ˜ 100íšŒ" },
  { id:"destroy500", name:"íŒŒê´´ì‹ ", how:"ë¬´ê¸° íŒŒê´´ íšŸìˆ˜ 500íšŒ" },

  // âœ… ì„œë²„ ìµœì´ˆ (ë¶‰ì€ ê¸ˆìƒ‰)
  { id:"worldchamp", name:"ì›”ë“œì±”í”¼ì–¸", how:"ì„œë²„ ìµœì´ˆ 30ê°• ë‹¬ì„±", color:"redgold" },

  // âœ… ì—”ë“œ(ì¢…ì°©ì§€) (ê¸ˆìƒ‰)
  { id:"end_sword", name:"ê²€ì˜ ì¢…ì°©ì§€",  how:"ê²€ìœ¼ë¡œ 30ê°• ë‹¬ì„±",  color:"gold" },
  { id:"end_axe",   name:"ë„ë¼ì˜ ì¢…ì°©ì§€",how:"ë„ë¼ë¡œ 30ê°• ë‹¬ì„±", color:"gold" },
  { id:"end_spear", name:"ì°½ì˜ ì¢…ì°©ì§€",  how:"ì°½ìœ¼ë¡œ 30ê°• ë‹¬ì„±",  color:"gold" },

  // âœ… ì—­ë³‘ì¥ (ë°˜ì§ ì´ˆë¡) + ë°©ë²• ìˆ¨ê¹€
  { id:"plague", name:"ì—­ë³‘ì¥", how:"???", color:"plague" },
  
      { id:"bow21", name:"ì‚¬ëƒ¥ê¾¼", how:"í™œ 21ê°• ë‹¬ì„±", color:"" },
  { id:"bow30", name:"í™œì˜ ì¢…ì°©ì§€", how:"í™œ 30ê°• ë‹¬ì„±", color:"gold" },

    // âœ… ê°•í™”/íŒŒê´´/ê°•ë“± ê³„ì—´
  { id:"superstar", name:"ìŠˆí¼ìŠ¤íƒ€", how:"ìŠˆí¼ê°•í™” 1íšŒ ì„±ê³µ" },
  { id:"slide4",    name:"ë¯¸ë„ëŸ¼í‹€", how:"ê°•ë“± ì—°ì† 4íšŒ" },
  { id:"luckyday",  name:"ìš´ìˆ˜ì¢‹ì€ë‚ ", how:"20ê°• ì´ì „ì—ì„œ íŒŒê´´" },
  { id:"icarus",    name:"ì´ì¹´ë£¨ìŠ¤", how:"26ê°• ì´ìƒì—ì„œ íŒŒê´´" },
  { id:"dopamine",  name:"ë„íŒŒë¯¼ì¤‘ë…ì", how:"25ê°• ì´í›„ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì—†ì´ ê°•í™” ì‹œë„" },

  { id:"bully10", name:"ê°•ì•½ì•½ê°•", how:"ì•½í•œ ìƒëŒ€ì—ê²Œ ê²°íˆ¬ì¥ ì§€ì •ë§¤ì¹­ 10íšŒ" },
  { id:"challenger10", name:"ë„ì „ì", how:"ê°•í•œ ìƒëŒ€ì—ê²Œ ê²°íˆ¬ì¥ ì§€ì •ë§¤ì¹­ ìŠ¹ë¦¬ 10íšŒ" },
  { id:"brawl500", name:"ì‹¸ì›€ê¾¼", how:"500íšŒ ì´ìƒ ê²°íˆ¬" },
  { id:"warGod", name:"íˆ¬ì‹ ", how:"4ê°• ì´ìƒ ë†’ì€ ìƒëŒ€ì—ê²Œ ê²°íˆ¬ì¥ ìŠ¹ë¦¬ 1íšŒ" },
  { id:"mansur", name:"ë§Œìˆ˜ë¥´", how:"10ì¡° ê³¨ë“œ ì´ìƒ ë³´ìœ " },

  // âœ… ê°•í™” íƒ€ì´ë° ë¬¶ìŒ
  { id:"gambler",  name:"ìŠ¹ë¶€ì‚¬",  how:"21ê°•ë¶€í„° ì£¼ë¬¸ì„œ ì—†ì´ 24ê°• ë„ë‹¬" },
  { id:"god30",    name:"ì‹ ",      how:"29ê°•ì—ì„œ ì£¼ë¬¸ì„œ ì—†ì´ 30ê°• ë‹¬ì„±" },
  { id:"fireworks",name:"í­ì£½ë†€ì´",how:"21~25ê°• ì „ë¶€ íŒŒê´´í•´ë´„" },

  { id:"best30",   name:"ìµœê°•ì",  how:"ë¬´ê¸° 30ê°• 1íšŒ ë‹¬ì„±", color:"gold" },
  { id:"master30", name:"ë‹¬ì¸",    how:"ë¬´ê¸° 30ê°• 3íšŒ ë‹¬ì„±", color:"gold" },

  { id:"oldwater", name:"ê³ ì¸ë¬¼",  how:"ê°™ì€ ë¬´ê¸°ë¡œ 30ê°• 2íšŒ ë‹¬ì„±", color:"gold" },
  { id:"stale",    name:"ì©ì€ë¬¼",  how:"ê°™ì€ ë¬´ê¸°ë¡œ 30ê°• 3íšŒ ë‹¬ì„±", color:"gold" },
];

  // ğŸ¨ ì¹­í˜¸ ìƒ‰ìƒ ìŠ¤íƒ€ì¼
function getTitleColorStyle(colorKey) {
  // ê¸°ë³¸(íšŒìƒ‰)
  if (!colorKey) return "color:#9a9a9a;";

  // ì—”ë“œ(ê¸ˆìƒ‰)
  if (colorKey === "gold") {
    return "color:#ffd54f;font-weight:bold;text-shadow:0 0 6px rgba(255,213,79,0.35);";
  }

  // ì„œë²„ìµœì´ˆ(ë¶‰ì€ ê¸ˆìƒ‰)
  if (colorKey === "redgold") {
    return "color:#ffb74d;font-weight:bold;text-shadow:0 0 6px rgba(255,120,80,0.35);";
  }

  // ì—­ë³‘ì¥(ë°˜ì§ ì§™ì€ ì´ˆë¡)
  if (colorKey === "plague") {
    return "color:#00c853;font-weight:bold;text-shadow:0 0 10px rgba(0,200,83,0.7); animation:sparkle 1.2s infinite alternate;";
  }

  return "color:#9a9a9a;";
}

// ğŸ·ï¸ ë‹‰ë„¤ì„ì— ì¹­í˜¸ ë¶™ì´ê¸° (ìƒ‰ìƒ í¬í•¨ + 30ê°• ë‹¬ì„± ë³„)
function formatNicknameWithTitle(id, titleId, reach30Count) {
  const safeId = (id ?? "-");
  const n = Math.max(0, Number(reach30Count || 0));

  // â˜… ë¬¸ìì—´ ë§Œë“¤ê¸° (ë„ˆë¬´ ê¸¸ë©´ 5ê°œê¹Œì§€ë§Œ +N)
  let starHtml = "";
  if (n > 0) {
    const show = Math.min(n, 5);
    const more = n - show;
    const starText = "â˜…".repeat(show) + (more > 0 ? `+${more}` : "");
    starHtml = ` <span class="rainbow">${starText}</span>`;
  }

  if (!titleId) return `${safeId}${starHtml}`;

  const def = TITLE_DEFS.find(t => t.id === titleId);
  const titleName = def ? def.name : titleId;

  const colorKey = def?.color || "";
  if (colorKey === "plague") {
    return `<span class="title-plague">[${titleName}]</span>${safeId}${starHtml}`;
  }

  const style = getTitleStyle(colorKey);
  return `<span style="${style}">[${titleName}]</span>${safeId}${starHtml}`;
}
  
function getTitleStyle(colorKey) {
  // ê¸°ë³¸(íšŒìƒ‰)
  if (!colorKey) return "color:#9a9a9a;";

  // ì—”ë“œ(ê¸ˆìƒ‰)
  if (colorKey === "gold") {
    return "color:#ffd54f;font-weight:bold;text-shadow:0 0 6px rgba(255,213,79,0.35);";
  }

  // ì„œë²„ìµœì´ˆ(ë¶‰ì€ ê¸ˆìƒ‰)
  if (colorKey === "redgold") {
    return "color:#ffb74d;font-weight:bold;text-shadow:0 0 6px rgba(255,120,80,0.35);";
  }

  // ì—­ë³‘ì¥(ì§™ì€ ì´ˆë¡ + ë°˜ì§ ëŠë‚Œì€ ì¼ë‹¨ ê¸€ë¡œìš°)
  if (colorKey === "plague") {
    return "color:#00c853;font-weight:bold;text-shadow:0 0 8px rgba(0,200,83,0.45);";
  }

  return "color:#9a9a9a;";
}

// ë¦¬ë„¤ì•„ ëŒ€ì‚¬(ëœë¤)
const LINEA_LINES = [
  "ì¹­í˜¸ëŠ” ëª…ì˜ˆì´ì ê¸°ë¡ì´ì•¼! ì–´ë–¤ ê±¸ ë‹¬ì•„ë³¼ë˜?",
  "ì˜¤â€¦ ë°©ê¸ˆ ë„ˆ ë°ì´í„° ì •ë¦¬í•˜ë‹¤ê°€ ê°íƒ„í–ˆì–´. í—¤í—¤!",
  "ì™”ì–´? ì ê¹ë§Œ, ì´ ì¤„ë§Œ ì“°ê³ !",
  "ì¹­í˜¸ ë‹¬ë©´ ì‚¬ëŒë“¤ì´ ë°”ë¡œ ì•Œì•„ë³´ì§€. ì™„ì „ ë¿Œë“¯!",
  "ì•„â€” ì§€ê¸ˆ ê¸°ë¡ ì¤‘ì´ì—ˆëŠ”ë°, ë­ ë³¼ ê±°ì•¼? ì¹­í˜¸?",
  "ì´ê±° ì•Œì•„? ì¹´ë¥´ë‹ˆì•„ëŠ” ì ˆëŒ€ ë¨¼ì € ë§ ì•ˆ ê±¸ì–´.",
  "ì™€, ì´ í˜ì´ì§€ ì¢€ ë´. ê½¤ ë©‹ì§„ë°?",
  "ì„¸ë ˆë‚˜ëŠ” ëŠ˜ ì–´ë ¤ìš´ ì–˜ê¸°ë§Œ í•´â€¦ ë¨¸ë¦¬ ì•„íŒŒ.",
  "ë‚œ ê·¸ëƒ¥â€¦ ì˜¤ëŠ˜ ëˆ„ê°€ ë¬´ê¸° í„°ëœ¨ë ¸ëŠ”ì§€ê°€ ë” ê¶ê¸ˆí•´.",
];

// =====================
// ğŸ·ï¸ ì¹­í˜¸ ìë™ ì§€ê¸‰ ë¡œì§
// =====================
let titleSortMode = "default"; // "default" | "recent"
  
// changedê°€ trueë©´, í˜¸ì¶œí•œ ìª½ì—ì„œ save() í•œë²ˆë§Œ í•´ì£¼ë©´ ë¨(ì¤‘ë³µ save ë°©ì§€)
function grantTitleOnceNoSave(titleId){
  if(!titleId) return false;
  if(!titlesOwned) titlesOwned = {};
  if(titlesOwned[titleId]) return false;
  titlesOwned[titleId] = Date.now();
  return true;
}

function checkAndGrantTitles(){
  let changed = false;

  // ğŸ¦  ì—­ë³‘ì¥: 2ë ˆë²¨ ì‚¬ëƒ¥í„°(ì‹œê¶ì°½) ì‚¬ëƒ¥ 100íšŒ
if (Number(plagueRatHuntCount || 0) >= 100) {
  if (grantTitleOnceNoSave("plague")) changed = true;
}
    // ğŸ’° ë§Œìˆ˜ë¥´: 10ì¡° ê³¨ë“œ ì´ìƒ ë³´ìœ 
  if (Number(gold || 0) >= 10000000000000) {
    if (grantTitleOnceNoSave("mansur")) changed = true;
  }
  // âš”ï¸ ê²°íˆ¬ ì—…ì 
if (Number(bully10Count || 0) >= 10) {
  if (grantTitleOnceNoSave("bully10")) updated = true;
}
if (Number(challenger10Count || 0) >= 10) {
  if (grantTitleOnceNoSave("challenger10")) updated = true;
}
if (Number(brawl500Count || 0) >= 500) {
  if (grantTitleOnceNoSave("brawl500")) updated = true;
}
if (warGodWin) {
  if (grantTitleOnceNoSave("warGod")) updated = true;
}
  // 1) ìƒˆë‚´ê¸° ëŒ€ì¥ì¥ì´: ìµœì´ˆ 1íšŒ ê°•í™” ì„±ê³µ
  if(Number(maxSwordLevel || 0) >= 1 || Number(sword || 0) >= 1){
    changed = grantTitleOnceNoSave("newbie") || changed;
  }

  // 2) ê°•í™” ë‹¨ê³„ ì—…ì 
  const maxLv = Number(maxSwordLevel || 0);
  if(maxLv >= 15) changed = grantTitleOnceNoSave("master15") || changed;   // [ëª…ì¸]
  if(maxLv >= 21) changed = grantTitleOnceNoSave("artisan21") || changed;  // [ì¥ì¸]
  if(maxLv >= 26) changed = grantTitleOnceNoSave("legend26") || changed;   // [ì „ì„¤]
  if(maxLv >= 30) changed = grantTitleOnceNoSave("best30") || changed;     // [ìµœê°•ì]

  // 3) ë¬´ê¸°ë³„ 21ê°• ì¹­í˜¸(ê²€/ì°½/ë„ë¼)
  // - weaponType ê°’ì€ ë„¤ ë­í‚¹ì—ì„œë„ ì“°ê³  ìˆìŒ (users list ì •ë ¬ ë°ì´í„°ì— ë“¤ì–´ê°) :contentReference[oaicite:1]{index=1}
  if(maxLv >= 21){
    if(weaponType === "sword") changed = grantTitleOnceNoSave("knight")  || changed;
    if(weaponType === "spear") changed = grantTitleOnceNoSave("warrior") || changed;
    if(weaponType === "axe")   changed = grantTitleOnceNoSave("viking")  || changed;
  }

  // 4) íŒŒê´´ ì—…ì 
  const dc = Number(destroyCount || 0);
  if(dc >= 100) changed = grantTitleOnceNoSave("destroy100") || changed; // [íŒŒê´´ì™•]
  if(dc >= 500) changed = grantTitleOnceNoSave("destroy500") || changed; // [íŒŒê´´ì‹ ]

  // 5) ë¬´ê¸°ë³„ "ì¢…ì°©ì§€" (30ê°• ë„ë‹¬ ì‹œì ì˜ weaponType ê¸°ì¤€)
  // - ì—¬ê¸°ì„œëŠ” â€œí˜„ì¬ ë¬´ê¸°ê°€ 30 ì´ìƒâ€ì´ë©´ ì§€ê¸‰.
  if(Number(sword || 0) >= 30){
    if(weaponType === "sword") changed = grantTitleOnceNoSave("end_sword") || changed;
    if(weaponType === "axe")   changed = grantTitleOnceNoSave("end_axe")   || changed;
    if(weaponType === "spear") changed = grantTitleOnceNoSave("end_spear") || changed;
  }

    // ğŸ¹ í™œ ì „ìš© ì¹­í˜¸
  if (weaponType === "bow" && maxSwordLevel >= 21) {
    if (grantTitleOnceNoSave("bow21")) changed = true;
  }

  if (weaponType === "bow" && maxSwordLevel >= 30) {
    if (grantTitleOnceNoSave("bow30")) changed = true;
  }

  return changed;
}
  
function openTitleOverlay(){
  const npcImg = document.getElementById("titleNpcImg");
if (npcImg) npcImg.src = "images/npc/linea_idle.png";

  const ov = document.getElementById("titleOverlay");
  if(!ov) return;
  ov.style.display = "flex";

  const lineEl = document.getElementById("titleNpcText");
  if(lineEl) lineEl.textContent = LINEA_LINES[Math.floor(Math.random()*LINEA_LINES.length)];

const sortBtn = document.getElementById("titleSortBtn");
if (sortBtn) {
  sortBtn.onclick = () => {
    titleSortMode = (titleSortMode === "default") ? "recent" : "default";
    sortBtn.textContent = (titleSortMode === "recent") ? "ê¸°ë³¸ì •ë ¬" : "ìµœê·¼íšë“ìˆœ";
    renderTitleGrid();
  };
}
  
  renderTitleGrid();
}

function closeTitleOverlay(){
  const ov = document.getElementById("titleOverlay");
  if(ov) ov.style.display = "none";
  hideActionPopup();
}

  // =====================
// ğŸªŸ ê³µìš© ì•¡ì…˜ íŒì—… (í”„ë¡œí•„ë³´ê¸° ìŠ¤íƒ€ì¼)
// =====================
let actionPopupEl = null;

function ensureActionPopup(){
  if (actionPopupEl) return actionPopupEl;

  const el = document.createElement("div");
  el.id = "actionPopup";
  el.style.display = "none";
  el.style.position = "fixed";
  el.style.zIndex = 10050;
  el.style.minWidth = "160px";
  el.style.padding = "8px";
  el.style.borderRadius = "12px";
  el.style.border = "1px solid rgba(255,255,255,0.18)";
  el.style.background = "rgba(20,20,20,0.96)";
  el.style.boxShadow = "0 10px 25px rgba(0,0,0,0.55)";
  el.style.backdropFilter = "blur(4px)";

  // ë°”ê¹¥ í´ë¦­ ë‹«ê¸°
  el.addEventListener("click", (e) => e.stopPropagation());
  document.addEventListener("click", () => hideActionPopup());
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideActionPopup(); });

  document.body.appendChild(el);
  actionPopupEl = el;
  return el;
}

function hideActionPopup(){
  const el = ensureActionPopup();
  el.style.display = "none";
  el.innerHTML = "";
}

function showActionPopupAt(x, y, html){
  const el = ensureActionPopup();
  el.innerHTML = html;

  // í™”ë©´ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ê²Œ ë³´ì •
  el.style.display = "block";
  const rect = el.getBoundingClientRect();
  let nx = x, ny = y;
  if (nx + rect.width > window.innerWidth - 8) nx = window.innerWidth - rect.width - 8;
  if (ny + rect.height > window.innerHeight - 8) ny = window.innerHeight - rect.height - 8;
  if (nx < 8) nx = 8;
  if (ny < 8) ny = 8;

  el.style.left = nx + "px";
  el.style.top  = ny + "px";
}

  // âœ… actionPopupì—ì„œ ì“°ëŠ” ë²„íŠ¼ HTML ìƒì„± (ì—†ìœ¼ë©´ íšë“ ì¹­í˜¸ í´ë¦­ ì‹œ íŒì—…ì´ ì•ˆëœ¸)
function popupBtn(label, onClickJs){
  return `
    <button class="actionBtn" onclick="${onClickJs}">
      ${label}
    </button>
  `;
}

// â€œì¥ì°©ì¤‘â€ í‘œì‹œ + 5x6 ê·¸ë¦¬ë“œ ë Œë”
function renderTitleGrid(){
  const grid = document.getElementById("titleGrid");
  const equippedEl = document.getElementById("equippedTitleText");
  if(!grid) return;

  // ì¥ì°©ì¤‘ í‘œì‹œ
  const eqDef = TITLE_DEFS.find(t => t.id === equippedTitle);
  if(equippedEl){
    equippedEl.textContent = eqDef ? `[${eqDef.name}]` : "(ì—†ìŒ)";
    equippedEl.style = eqDef ? getTitleColorStyle(eqDef.color) + "font-weight:bold;" : "color:#999;";
  }

let defs = [...TITLE_DEFS];

// âœ… ìµœê·¼ íšë“ìˆœ ì •ë ¬ ëª¨ë“œì¼ ë•Œë§Œ ì •ë ¬
if (titleSortMode === "recent") {
  defs.sort((a, b) => {
    const aRaw = titlesOwned?.[a.id];
    const bRaw = titlesOwned?.[b.id];

    // number(timestamp)ë©´ ê·¸ ê°’, trueë©´ 1, ì—†ìœ¼ë©´ 0
    const aTs = (typeof aRaw === "number") ? aRaw : (aRaw ? 1 : 0);
    const bTs = (typeof bRaw === "number") ? bRaw : (bRaw ? 1 : 0);

    // 1) íšë“í•œ ê²ƒ ë¨¼ì €
    if (!!aTs !== !!bTs) return bTs - aTs;

    // 2) ë‘˜ ë‹¤ íšë“ì´ë©´ ìµœê·¼ íšë“ì´ ìœ„
    return bTs - aTs;
  });
}

grid.innerHTML = defs.map(def => {
  const owned = !!(titlesOwned && titlesOwned[def.id]);
  const color = owned ? "#fff" : "#777";
  const border = owned ? "1px solid #666" : "1px solid #333";

  const raw = titlesOwned?.[def.id];
  const ts = (typeof raw === "number") ? raw : 0;
  const earnedText = owned
    ? (ts ? new Date(ts).toLocaleDateString("ko-KR") : "íšë“")
    : "ë¯¸íšë“";

  return `
    <div class="titleCell"
         data-id="${def.id}"
         style="padding:10px 6px; text-align:center; border:${border}; border-radius:10px; cursor:pointer; color:${color}; user-select:none;">
      <div style="font-weight:bold;">${def.name}</div>
      <div style="margin-top:4px; font-size:11px; color:${owned ? "#bbb" : "#555"};">
        ${earnedText}
      </div>
    </div>
  `;
}).join("");

  // í´ë¦­ ë°”ì¸ë”©
  grid.querySelectorAll(".titleCell").forEach(el => {
    el.addEventListener("click", (e) => {
  const id = el.getAttribute("data-id");
  onTitleClick(id, e);
});
  });
}

function onTitleClick(titleId){
  const def = TITLE_DEFS.find(t=>t.id===titleId);
  if(!def) return;

  const owned = !!(titlesOwned && titlesOwned[titleId]);

  // í´ë¦­ ìœ„ì¹˜: ì…€ ì¤‘ì‹¬ ê·¼ì²˜ë¡œ ë„ìš°ê¸° (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ê°€ ì œì¼ ìì—°ìŠ¤ëŸ½)
  const x = (window.event && window.event.clientX) ? window.event.clientX : (window.innerWidth/2);
  const y = (window.event && window.event.clientY) ? window.event.clientY : (window.innerHeight/2);

  // âŒ ë¯¸íšë“ â†’ alert ëŒ€ì‹  â€œíšë“ë°©ë²• íŒì—…â€
  if(!owned){
    const how = def.hiddenHow ? "???" : (def.how || "???");
    showActionPopupAt(x, y, `
      <div class="actionTitle">[${def.name}]</div>
      <div class="actionText">ì¹­í˜¸ íšë“ë°©ë²•:\n${how}</div>
    `);
    return;
  }

  // âœ… íšë“í•œ ì¹­í˜¸ í´ë¦­
  // 1) ì´ë¯¸ ì¥ì°©ì¤‘ â†’ â€œì¥ì°©í•´ì œâ€ íŒì—…
  if (equippedTitle === titleId) {
    showActionPopupAt(x, y, `
      <div class="actionTitle">[${def.name}]</div>
      ${popupBtn("ì¥ì°©í•´ì œ", "equippedTitle=''; save(); update(); renderTitleGrid(); hideActionPopup();")}
    `);
    return;
  }

  // 2) ì¥ì°©ì¤‘ ì•„ë‹˜ â†’ â€œì¥ì°©í•˜ê¸°â€ íŒì—…
  showActionPopupAt(x, y, `
    <div class="actionTitle">[${def.name}]</div>
    ${popupBtn("ì¥ì°©í•˜ê¸°", "equippedTitle='" + titleId + "'; save(); update(); renderTitleGrid(); hideActionPopup();")}
  `);
}

// ì˜¤ë²„ë ˆì´: ë°”ê¹¥ í´ë¦­ ë‹«ê¸° + ESC ë‹«ê¸°
document.addEventListener("DOMContentLoaded", () => {
  const ov = document.getElementById("titleOverlay");
  if(ov){
    ov.addEventListener("click", (e) => {
      if(e.target === ov) closeTitleOverlay();
    });
  }

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      const ov2 = document.getElementById("titleOverlay");
      if(ov2 && ov2.style.display !== "none") closeTitleOverlay();
    }
  });
});

  function update() {

   /* ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì˜ì—­ ê°±ì‹  */
  const nameEl = document.getElementById("profileNickname");
  if (nameEl) nameEl.innerHTML = formatNicknameWithTitle(userId, equippedTitle, reach30Count);

  const weaponTitleEl = document.getElementById("profileWeaponTitle");
  const weaponDescEl  = document.getElementById("profileWeaponDesc");
  const maxInfoEl     = document.getElementById("profileMaxInfo");
  const powerEl  = document.getElementById("profilePower");
  const goldEl   = document.getElementById("profileGold");
  const huntEl   = document.getElementById("profileHuntCount");
  const weaponValueEl = document.getElementById("profileWeaponValue");
  const recordEl = document.getElementById("profileRecord");

  if (recordEl) {
    recordEl.textContent = `ìŠ¹ ${duelWin} / íŒ¨ ${duelLose}`;
  }

  // ğŸ”° í˜„ì¬ ê°•í™” ë‹¨ê³„ì— ë”°ë¥¸ ê²€ ì •ë³´
  const wInfo = getWeaponInfo(sword, weaponType || "sword");

  // ê²€ ì´ë¦„ (+í˜„ì¬ê°•)
  if (weaponTitleEl && wInfo) {
    weaponTitleEl.textContent = `${wInfo.name} (+${sword}ê°•)`;
  }

  // ê²€ ì„¤ëª…
  if (weaponDescEl && wInfo) {
    weaponDescEl.textContent = wInfo.desc;
  }

  // ìµœëŒ€ ê°•í™” + íŒŒê´´ níšŒ
  if (maxInfoEl) {
    maxInfoEl.innerHTML =
      `+${maxSwordLevel}ê°• ` +
      `<span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ ${destroyCount}íšŒ)</span>`;
  }

  // âš”ï¸ ê°•í™” ë‹¨ê³„ì— ë§ëŠ” ì´ë¯¸ì§€ë¡œ êµì²´
  updateWeaponImage();

  if (powerEl) {
    powerEl.textContent = formatGold(power);
  }
  if (goldEl) {
    goldEl.textContent  = formatGold(gold);
  }
  if (weaponValueEl) {
    const avgValue = getSellRewardAverage(sword); // í‰ê·  íŒë§¤ê°€
    weaponValueEl.textContent = formatGold(avgValue);
  }
  if (huntEl) {
    const today = getTodayDateString();
    if (lastHuntDate !== today) {
      huntEl.textContent = `0 / 20`;
    } else {
      huntEl.textContent = `${huntCountToday} / 20`;
    }
  }
    
  const statusEl = document.getElementById("status");
  if (statusEl) statusEl.innerHTML = "";

const descEl = document.getElementById("fieldDescription");

const FIELD_DESCRIPTIONS = {
  1: `í•œë•Œ ëª¨í—˜ê°€ë“¤ì˜ ì‰¼í„°ì˜€ë˜ ë§ˆì„.
ì „íˆ¬ë³´ë‹¤ëŠ” ê°ì„ ë˜ì°¾ê³  ëª¸ì„ í’€ê¸°ì— ì í•©í•˜ë‹¤.`,

  2: `ë…ê³¼ ë¶€íŒ¨ê°€ ë’¤ì„ì¸ ë„ì‹œì˜ ë°‘ë°”ë‹¥.
í•œ ë²ˆì˜ ì‹¤ìˆ˜ëŠ” ê³§ ê°ì—¼ì„ ì˜ë¯¸í•œë‹¤.`,

  3: `í˜ê³¼ ë°°ì‹ ë§Œì´ ì§€ë°°í•˜ëŠ” ë•….
ë°©ì‹¬í•œ ìë¶€í„° ì´ê³³ì— ë¬»íŒë‹¤.`,

  4: `ì •ë©´ëŒ€ê²°ë³´ë‹¤ ê¸°ìŠµì„ íƒí•˜ëŠ” ê·¸ë“¤ì˜ ì˜ì—­.
ì ì„ ë³¸ ìˆœê°„ì€ ì´ë¯¸ ëŠ¦ì—ˆì„ì§€ ëª¨ë¥¸ë‹¤.`,

  5: `ì‚´ì„ ë² ì–´ë‚´ëŠ” ëƒ‰ê¸°ì™€ ê³ ë…ì˜ ì „ì¥.
ì˜¤ë˜ ë¨¸ë¬´ëŠ” ìë¶€í„° ë¬´ë„ˆì§„ë‹¤.`,

  6: `ì£½ì€ ì˜í˜¼ì´ ëª¨ì—¬ë“  ëì—†ëŠ” ì†Œëª¨ì „.
ìŠ¹ë¦¬í•´ë„ ëŒì•„ì˜¨ë‹¤ëŠ” ë³´ì¥ì€ ì—†ë‹¤.`,

  7: `ë¶„ë…¸ê°€ íƒ€ì˜¤ë¥´ëŠ” ì§€ì˜¥ì˜ ìš”ìƒˆ.
í•œ ë²ˆ ë°€ë¦¬ë©´, ë‹¤ì‹œëŠ” ë°˜ê²©í•  ìˆ˜ ì—†ë‹¤.`,

  8: `ì‹ ì˜ ì‚¬ìë“¤ì´ ì§‘ê²°í•œ ì‹¬íŒì˜ ì„±ì—­.
ì—¬ê¸°ì„œì˜ íŒ¨ë°°ëŠ” ì£„ë¡œ ê¸°ë¡ëœë‹¤.`,

  9: `ì ˆëŒ€ìì˜ ì¡´ì¬ê°ì´ ì˜ì§€ë¥¼ ì§“ëˆŒëŸ¬ ë²„ë¦°ë‹¤.
ê²½ì™¸ì™€ ì˜¤ë§Œì´ ê³µì¡´í•˜ëŠ” ì¥ì†Œ.`,

  10: `ì„¸ê³„ì˜ ê·œì¹™ì´ ë” ì´ìƒ í†µí•˜ì§€ ì•ŠëŠ” ê³µê°„.
ì—¬ê¸°ì„œ ì‚´ì•„ë‚¨ëŠ”ë‹¤ë©´, ì¸ê°„ì´ë¼ ë¶€ë¥¼ ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤.`
};

if (descEl) {
  descEl.innerText = FIELD_DESCRIPTIONS[currentField] || "";
}

  
  // ğŸ”¹ ê°•í™” ì„±ê³µ/ì‹¤íŒ¨ ì •ë³´
  const success = getUpgradeChance(sword);
  let failInfo = "";
  let failRemain = 100 - success; // ì‹¤íŒ¨ ì´ ë¹„ìœ¨

  const midDestroyRatio = {
    16: 0.10,
    17: 0.12,
    18: 0.13,
    19: 0.14
  };

  if (sword <= 10) {
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b> (ìœ ì§€)
    `;
  } else if (sword >= 16 && sword <= 19) {
    const destroy = Math.round(failRemain * midDestroyRatio[sword]);
    const down    = failRemain - destroy;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  } else if (sword <= 20) {
    const keep = Math.round(failRemain * 0.5);
    const down = failRemain - keep;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ìœ ì§€ <b>${keep}%</b> / ê°•ë“± <b>${down}%</b>
    `;
  } else {
    const down = Math.round(failRemain * 0.4);
    const destroy = failRemain - down;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  }

  const cost = getUpgradeCost(sword);

  let safeNote = "";
  // âœ… 5, 10, 15, 20ê¹Œì§€ë§Œ ì„¸ì´í”„ / 25ëŠ” ì œì™¸
  if (sword % 5 === 0 && sword !== 0 && sword <= 20) {
    safeNote = `<br><span style="color:#6cf;">
      â€» ì„¸ì´í”„ êµ¬ê°„: ì‹¤íŒ¨í•´ë„ ê°•ë“±/íŒŒê´´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </span>`;
  }

  const upgradeInfoEl = document.getElementById("upgradeInfo");
  if (upgradeInfoEl) {
    upgradeInfoEl.innerHTML = `
      ì„±ê³µ <b>${success}%</b> / ${failInfo}
      <br>í•„ìš” ê³¨ë“œ <b>${formatGold(cost)}</b>
      ${safeNote}
    `;
  }

  // ğŸ¯ ì‚¬ëƒ¥ ì •ë³´ UI ì—…ë°ì´íŠ¸
  const field = HUNT_FIELDS[currentField];
  const huntSuccess = getHuntSuccessChance(sword, currentField);

  const fieldInfoEl = document.getElementById("currentFieldInfo"); // ì¹´ë“œ ìœ„ í…ìŠ¤íŠ¸
  const huntBtnEl   = document.getElementById("huntBtn");

  // ğŸ—º ì¹´ë“œ ìœ„ì— í˜„ì¬ ì‚¬ëƒ¥í„° + ë ˆë²¨ + ì„±ê³µí™•ë¥  í‘œì‹œ
  if (field && fieldInfoEl) {
    const huntSuccess = getHuntSuccessChance(sword, currentField);

    fieldInfoEl.innerHTML = `
      <div style="font-size: 21px; font-weight: bold;">
        ${field.name}
      </div>
      <div class="current-field-info-sub">
        ì¶”ì²œ ë ˆë²¨: +${field.recLevel}ê°•
        &nbsp;/&nbsp;
        ë‚´ ë ˆë²¨: +${sword}ê°•
        &nbsp;/&nbsp;
        ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥ : ${huntSuccess}%
      </div>
    `;
  }

  // ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ UI ê°±ì‹ 
  updateHuntUI();
  
// ğŸ†• ê²°íˆ¬ ë‚¨ì€ íšŸìˆ˜ UI ê°±ì‹ 
updateDuelUI();
  
  // ğŸ”¥ í˜„ì¬ ì‚¬ëƒ¥í„° ë°°ê²½ ì ìš© (CSS ::beforeìš© ë³€ìˆ˜ ì„¸íŒ…)
  applyFieldBackground();

  updateHonorHallButton();

    // âœ… ê°•í™” ì•„ì´í…œ ë¼ë²¨ ìˆ˜ëŸ‰ ê°±ì‹ 
  updateUpgradeItemLabels();
}

// âš”ï¸ ê²°íˆ¬ ì¼ì/ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
function ensureDuelDate() {
  const today = getTodayDateString();
  if (lastDuelDate !== today) {
    lastDuelDate = today;
    duelCountToday = 0;
    duelTargetsToday = {};
  }
}

  // ğŸ‡°ğŸ‡· í•œêµ­ì‹œê°„(UTC+9) ê¸°ì¤€ ì£¼ í‚¤ ìƒì„±
function getKstWeekKey() {

  const now = new Date();

  // í•œêµ­ ì‹œê°„ ë³´ì • (+9ì‹œê°„)
  const kst = new Date(now.getTime() + (9 * 60 * 60 * 1000));

  const year = kst.getUTCFullYear();

  // í•´ë‹¹ ì—°ë„ 1ì›” 1ì¼(KST ê¸°ì¤€)
  const start = new Date(Date.UTC(year, 0, 1));

  // ê²½ê³¼ ì¼ìˆ˜
  const days = Math.floor((kst - start) / (24 * 60 * 60 * 1000));

  // 1ì£¼ ë‹¨ìœ„ë¡œ ì¸ë±ì‹±
  const week = Math.floor(days / 7) + 1;

  // ì˜ˆ: 2026-W03
  return `${year}-W${String(week).padStart(2, "0")}`;
}

// ğŸ—“ ì§€ë‚œì£¼(ì›”ìš”ì¼ 00:00 ~ ì´ë²ˆ ì£¼ ì›”ìš”ì¼ 00:00) KST ë²”ìœ„(ms) êµ¬í•˜ê¸°
function getLastWeekRangeKst() {
  const now = getKstNow();
  const day = now.getDay();                 // 0=ì¼, 1=ì›”, ... 6=í† 
  const diffToMonday = (day + 6) % 7;       // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ê¹Œì§€ ë©°ì¹  ë˜ëŒë¦´ì§€
  const thisMonday = new Date(
    now.getTime() - diffToMonday * 24 * 60 * 60 * 1000
  );
  const lastMonday = new Date(
    thisMonday.getTime() - 7 * 24 * 60 * 60 * 1000
  );

  return {
    start: lastMonday.getTime(),   // ì§€ë‚œì£¼ ì›”ìš”ì¼ 00:00
    end: thisMonday.getTime()      // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ 00:00 (ì§ì „ê¹Œì§€ê°€ ì§€ë‚œì£¼)
  };
}
  
  // ğŸ‡°ğŸ‡· í•œêµ­ì‹œê°„ ê¸°ì¤€ ì›”ìš”ì¼ 00:00~00:10 ê²°íˆ¬ì¥ ì§‘ê³„ ì‹œê°„ ì—¬ë¶€
function isDuelSettlementTimeKST() {
  const now = new Date();

  // KST = UTC+9 ë³´ì •
  const kst = new Date(now.getTime() + 9 * 60 * 60 * 1000);

  const day = kst.getUTCDay();    // ì¼:0, ì›”:1, ... í† :6
  const hour = kst.getUTCHours(); // 0~23
  const minute = kst.getUTCMinutes(); // 0~59

  // ì›”ìš”ì¼ì´ë©´ì„œ 00ì‹œ 00ë¶„ ~ 00ì‹œ 09ë¶„(00:10 ì§ì „)ê¹Œì§€
  if (day === 1 && hour === 0 && minute < 10) {
    return true;
  }
  return false;
}

// ğŸŒ™ ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì •ë¦¬
// ğŸŒ™ ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì •ë¦¬
function ensureDuelWeek() {
  const weekKey = getKstWeekKey();   // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì£¼ í‚¤
  currentWeekKey = weekKey;

  // ğŸ”° ì²˜ìŒ ì ‘ì†í•œ ê²½ìš° (ê²°íˆ¬ ì‹œìŠ¤í…œ ìµœì´ˆ ì ìš© / ì‹ ê·œ ê³„ì •)
  if (!duelPointWeekKey) {
    duelPointWeekKey = weekKey;

    // "ì§€ë‚œ ì£¼"ë¼ëŠ” ê°œë… ìì²´ê°€ ì—†ìœ¼ë¯€ë¡œ, ë³´ìƒë„ ì—†ëŠ” ìƒíƒœë¡œ ì´ˆê¸°í™”
    duelLastWeekPoint = 0;
    duelLastWeekRank = 0;
    duelLastWeekRewardClaimed = true;   // ì§€ë‚œì£¼ ë³´ìƒì€ ì—†ë‹¤ê³  ê°„ì£¼

    return;
  }

// ğŸ—“ ì£¼ì°¨ê°€ ë°”ë€Œì—ˆìœ¼ë©´ ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ + ê°±ì‹  ì‹œê° ìŠ¤ëƒ…ìƒ· ì €ì¥ í›„, ì´ë²ˆ ì£¼ ì´ˆê¸°í™”
if (duelPointWeekKey !== weekKey) {
  // ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ & ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê° ìŠ¤ëƒ…ìƒ·
  duelLastWeekPoint   = duelPoint;
  duelLastWeekUpdated = duelUpdated || 0;

  // ì§€ë‚œ ì£¼ ë­í‚¹ì€ ìƒˆë¡œ ì§‘ê³„í•  ì˜ˆì •ì´ë¯€ë¡œ ì´ˆê¸°í™”
  duelLastWeekRank = 0;

  // "ìƒˆ ì£¼ê°€ ì‹œì‘ëë‹¤ â†’ ì§€ë‚œì£¼ ë³´ìƒì€ ì•„ì§ ì•ˆ ë°›ì€ ìƒíƒœ"ë¡œ í‘œì‹œ
  duelLastWeekRewardClaimed = false;

  // ì´ë²ˆ ì£¼ í¬ì¸íŠ¸/ê°±ì‹  ì‹œê° ë¦¬ì…‹
  duelPoint   = 0;
  duelUpdated = 0;

  // ì´ë²ˆ ì£¼ ì£¼ì°¨ í‚¤ ê°±ì‹ 
  duelPointWeekKey = weekKey;
}
}
// âš”ï¸ ì‹¤ì œ ê²°íˆ¬ ì²˜ë¦¬
// targetUserId : ë„ì „ ëŒ€ìƒ ìœ ì € ì•„ì´ë””
// isRandomMatch: ëœë¤ë§¤ì¹­ ì—¬ë¶€ (trueë©´ ê°™ì€ ìƒëŒ€ 3íšŒ ì œí•œ ë¯¸ì ìš©)
function performDuel(targetUserId, isRandomMatch) {
  if (!userId || !userRef) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

    // ì´ë¯¸ VS í™”ë©´ì´ ë–  ìˆìœ¼ë©´ ì¶”ê°€ ê²°íˆ¬ ì‹ ì²­ ë§‰ê¸°
  if (isDueling) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì ê¹, ì•„ì§ ì§€ë‚œ ê²°íˆ¬ ê²°ê³¼ë„ ì•ˆ ë‚˜ì™”ì–ë‚˜.
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ë¨¼ì € ì € ê²€ë“¤ì˜ ìŠ¹ë¶€ë¶€í„° ì§€ì¼œë³´ë„ë¡ í•˜ì§€.
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

    // ğŸ•’ ì§‘ê³„ ì‹œê°„ ê²°íˆ¬ ê¸ˆì§€ (ì„ íƒì‚¬í•­)
  if (isDuelSettlementTimeKST()) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì ê¹ ë©ˆì¶°ë¼, ì§€ê¸ˆì€ ê²°íˆ¬ë¥¼ ê¸°ë¡í•˜ëŠ” ì¤‘ì´ë‹¤.
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ì›”ìš”ì¼ 00:00~00:10ì—ëŠ” ê²°íˆ¬ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ì–´.
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

  // âœ… ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì£¼ì°¨ ì²´í¬ (ì£¼ ë°”ë€Œë©´ í¬ì¸íŠ¸ ë¦¬ì…‹)
  ensureDuelWeek();
  
  // ë‚ ì§œ ë°”ë€Œì—ˆìœ¼ë©´ ì˜¤ëŠ˜ ì¹´ìš´íŠ¸ ë¦¬ì…‹
  ensureDuelDate();

  // âœ… í•˜ë£¨ ì´ 10íšŒ ì œí•œ
  if (duelCountToday >= 10) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì´ë´, ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ë‹¤!
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ìŠ¹ë¶€ëŠ” ì‰¬ì–´ì•¼ ë” ëœ¨ê²ì§€.<br>
        <span style="color:#ccc;">(í•˜ë£¨ 10íšŒ ê²°íˆ¬ ì œí•œ)</span>
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

  // âœ… ê°™ì€ ìƒëŒ€ì—ê²Œ í•˜ë£¨ 3íšŒê¹Œì§€ (ì§ì ‘ ë„ì „ë§Œ)
  if (!isRandomMatch) {
    const cnt = duelTargetsToday[targetUserId] || 0;
    if (cnt >= 3) {
      showNpcMessage(
        `
        <div style="font-size:16px; font-weight:bold;">
          ê·¸ë§Œí•´, ê·¸ ìƒëŒ€ëŠ” ì´ë¯¸ ì¶©ë¶„íˆ ë‘ë“¤ê²¨ íŒ¼ì–ì•„?
        </div>
        <div style="margin-top:4px; font-size:13px;">
          ë‹¤ë¥¸ ì „ì¥ë„ í•œë²ˆ ëŒì•„ë³´ë¼ê³ .<br>
          <span style="color:#ccc;">(ê°™ì€ ìƒëŒ€ í•˜ë£¨ 3íšŒ ì œí•œ)</span>
        </div>
        `,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
      return;
    }
  }

  // ğŸ” ìƒëŒ€ ìœ ì € ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const targetRef = db.ref("users/" + targetUserId);
  targetRef.once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    const t = snap.val();

    const targetWeaponType = t.weaponType || "sword";
    const targetSword = Number(t.sword ?? 0);
    let targetPower = Number(t.power ?? 0);

    const attackerLvHtml = coloredLevel(sword);        // ë‚´ +00ê°• (ì»¬ëŸ¬ í¬í•¨)
    const defenderLvHtml = coloredLevel(targetSword);  // ìƒëŒ€ +00ê°• (ì»¬ëŸ¬ í¬í•¨)

    // ìƒëŒ€ ì „íˆ¬ë ¥ì´ 0ì´ê±°ë‚˜ êµ¬ë²„ì „ì´ë©´ ëŒ€ëµì ì¸ ê³µê²©ë ¥ìœ¼ë¡œ ëŒ€ì‹  ì‚¬ìš©
    if (!targetPower || targetPower <= 0) {
      targetPower = getBaseAttack(targetSword);
    }

    // ë‚´ ì „íˆ¬ë ¥ë„ ì•ˆì „í•˜ê²Œ ë³´ì •
    if (!power || power <= 0) {
      rollPowerForCurrentSword();
    }

    const A = Math.max(1, Number(power));
    const B = Math.max(1, Number(targetPower));
    const sum = A + B;

    const winProb = sum > 0 ? (A / sum) : 0.5;
    const isWin = Math.random() < winProb;

    // ğŸ’° ë³´ìƒ ê³¨ë“œ: ìƒëŒ€ ë¬´ê¸° ê°•í™”ë¹„ìš©ì˜ 2.5ë°° ~ 2.8ë°° â†’ 1/3ë¡œ ì¶•ì†Œ
    const baseLevel = Math.min(targetSword, 29);
    const baseCost = getUpgradeCost(baseLevel);
    const rewardGold = isWin
      ? Math.floor((baseCost * randRange(2.5, 2.8)) / 3)
      : 0;

        // ğŸ´ VS í™”ë©´ì— ì“¸ ë¬´ê¸° ì •ë³´
    const myWeaponInfo     = getWeaponInfo(sword, weaponType || "sword");           // ë‚´ íƒ€ì…
    const targetWeaponInfo = getWeaponInfo(targetSword, targetWeaponType || "sword"); // ìƒëŒ€ íƒ€ì…


    // ğŸ§¾ VS ì˜¤ë²„ë ˆì´ ë¨¼ì € ë„ìš°ê¸°
    showDuelBattleOverlay({
      myName: userId,
      myLevelHtml: attackerLvHtml,
      myPower: A,
      myWeaponInfo,
      targetName: targetUserId,
      targetLevelHtml: defenderLvHtml,
      targetPower: B,
      targetWeaponInfo
    });

    // â³ 2~3ì´ˆ ë’¤ì— ì‹¤ì œ ê²°ê³¼ ì²˜ë¦¬
    const delay = 2000 + Math.random() * 1000; // 2000~3000ms

    setTimeout(() => {
      // ğŸ”¢ ì¹´ìš´íŠ¸/ì „ì  ê°±ì‹ 
      duelCountToday++;

      if (!isRandomMatch) {
        const prev = duelTargetsToday[targetUserId] || 0;
        duelTargetsToday[targetUserId] = prev + 1;
      }

      if (isWin) {
        duelWin++;

        // ğŸ’° ê³¨ë“œ ì§€ê¸‰
        if (rewardGold > 0) {
          gold += rewardGold;
        }

        // ğŸ… ëª…ì˜ˆì˜ í›ˆì¥ ê³„ì‚°
        let honorGain = 0;
        const diff = targetSword - sword; // ìƒëŒ€ - ë‚˜

        // ğŸ·ï¸ ê²°íˆ¬ ì—…ì  ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
// ì‹¸ì›€ê¾¼: ê²°íˆ¬ ëˆ„ì  íšŸìˆ˜
brawl500Count = Number(brawl500Count || 0) + 1;

// ê°•ì•½ì•½ê°•: ë³¸ì¸ë³´ë‹¤ ê°•í™”ê°€ ë‚®ì€ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ 10íšŒ (ìŠ¹íŒ¨ ë¬´ê´€, "ì‹œë„" ê¸°ì¤€)
if (!isRandomMatch && diff < 0) {
  bully10Count = Number(bully10Count || 0) + 1;
}

// ë„ì „ì/íˆ¬ì‹ : ìŠ¹ë¦¬ ê¸°ì¤€
if (isWin) {
  // ë„ì „ì: ë³¸ì¸ë³´ë‹¤ ê°•í•œ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ ìŠ¹ë¦¬ 10íšŒ
  if (!isRandomMatch && diff > 0) {
    challenger10Count = Number(challenger10Count || 0) + 1;
  }

  // íˆ¬ì‹ : ë³¸ì¸ë³´ë‹¤ 4ê°• ì´ìƒ ë†’ì€ ìƒëŒ€ì—ê²Œ ìŠ¹ë¦¬ 1íšŒ
  if (diff >= 4) {
    warGodWin = true;
  }
}

        if (diff >= 5) {
          honorGain = 40;
        } else if (diff === 4) {
          honorGain = 28;
        } else if (diff === 3) {
          honorGain = 18;
        } else if (diff === 2) {
          honorGain = 10;
        } else if (diff === 1) {
          honorGain = 5;
        } else if (diff === 0) {
          honorGain = 3;
        } else if (diff === -1) {
          honorGain = 1;
        } else {
          honorGain = 0; // diff <= -2
        }

        // ğŸ² ëœë¤ë§¤ì¹­ ë³´ë„ˆìŠ¤ +1
// ê¸°ë³¸ í›ˆì¥ì´ 0ì´ì–´ë„ ëœë¤ë§¤ì¹­ì´ë©´ +1 ì§€ê¸‰
if (isRandomMatch) {
  honorGain += 1;
}

// ğŸ‘‡ í•­ìƒ íŒì—…ì„ ë„ìš´ë‹¤
let npcHtml = "";

// ğŸ… í›ˆì¥ ì§€ê¸‰ (0ê°œì¼ ìˆ˜ë„ ìˆìŒ)
itemHonorMedal += honorGain;

// ğŸ”¹ ëª…ì˜ˆì˜ í›ˆì¥ ì§€ê¸‰
if (honorGain > 0) {
  itemHonorMedal += honorGain;
}

// ğŸ”¹ ê²°íˆ¬ í¬ì¸íŠ¸ëŠ” "ëª…ì˜ˆì˜ í›ˆì¥ê³¼ ë™ì¼í•œ ì–‘"ìœ¼ë¡œ ëˆ„ì 
if (honorGain > 0) {
  duelPoint += honorGain;
  duelUpdated = Date.now();
}

// ğŸ¤ ì¹´ë¥´ë‹ˆì•„ ëŒ€ì‚¬ ë¶„ê¸°

if (honorGain > 0) {

  // ìƒìœ„ ìƒëŒ€ ê²©íŒŒ
  if (diff >= 2) {
    npcHtml = `
      <div style="font-size:18px; font-weight:bold; color:#FFD700;">
        ë¶ˆë¦¬í•œ ìŠ¹ë¶€ì˜€ëŠ”ë°ë„ ì˜ ë²„í…¼ë„¤.
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì´ ì •ë„ë©´ ì¸ì •ì´ì§€.<br>
        ëª…ì˜ˆì˜ í›ˆì¥ ${honorGain}ê°œ, ì±™ê²¨ë‘ë„ë¡ í•´.
      </div>
    `;
  }

  // ë¼ì´ë²Œ / ë¹„ìŠ·í•œ êµ¬ê°„
  else if (diff >= -1 && diff <= 1) {
    npcHtml = `
      <div style="font-size:18px; font-weight:bold; color:#FFD700;">
        ê½¤ ê·¼ì‚¬í•œ ìŠ¹ë¶€ì˜€ì–´.
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì´ë²ˆ íŒì€ ë„¤ ì†ì„ ë“¤ì–´ì¤˜ì•¼ê² ë„¤.<br>
        ëª…ì˜ˆì˜ í›ˆì¥ ${honorGain}ê°œ, ê¸°ë¡ì— ë‚¨ê²¨ë‘ì§€.
      </div>
    `;
  }

  // ì‚´ì§ ì•„ë˜ ìƒëŒ€
  else {
    npcHtml = `
      <div style="font-size:18px; font-weight:bold; color:#FFD700;">
        ëª¸ í’€ê¸°ì—” ê´œì°®ì€ ìƒëŒ€ë¡œêµ°.
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ìŠ¹ë¶€ëŠ” ìŠ¹ë¶€ì§€.<br>
        ëª…ì˜ˆì˜ í›ˆì¥ ${honorGain}ê°œ ì§€ê¸‰í–ˆë‹¤.
      </div>
    `;
  }

} else {

  // â­ í›ˆì¥ 0ê°œ ì „ìš© ëŒ€ì‚¬ (ìƒˆë¡œ ì¶”ê°€)

  npcHtml = `
    <div style="font-size:18px; font-weight:bold; color:#CCCCCC;">
      í˜ì˜ ì°¨ì´ê°€ ì¢€ ë§ì´ ë‚¬ì§€.
    </div>
    <div style="margin-top:6px; font-size:14px;">
      ì´ë²ˆ íŒì€ ê¸°ë¡ë§Œ ë‚¨ê²¨ë‘ê² ë‹¤.<br>
      ë‹¤ìŒì—” ë„¤ê²Œ ë§ëŠ” ìƒëŒ€ë¥¼ ê³¨ë¼ë´.
    </div>
  `;
}

// ğŸ¯ í•­ìƒ íŒì—… ì¶œë ¥
showNpcMessage(
  npcHtml,
  "images/npc/duel_carnia.png",
  true,
  "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
);

// ğŸ§¾ ë¡œê·¸ (ê²°ê³¼ë§Œ ë‚¨ê¹€)
let logMsg = isRandomMatch
  ? `${userId}ë‹˜(${attackerLvHtml})ì´ ëœë¤ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ${targetUserId}ë‹˜(${defenderLvHtml})ê³¼ì˜ ê²°íˆ¬ì—ì„œ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤!`
  : `${userId}ë‹˜(${attackerLvHtml})ì´ ${targetUserId}ë‹˜(${defenderLvHtml})ê»˜ ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤!`;

writeLog(logMsg);

      } else {
        // âŒ íŒ¨ë°°
        duelLose++;

        showNpcMessage(
          `
          <div style="font-size:18px; font-weight:bold; color:#FF6666;">
            ì“°ëŸ¬ì¡Œì§€ë§Œ, ê½¤ ê·¼ì‚¬í–ˆëŠ”ê±¸?
          </div>
          <div style="margin-top:6px; font-size:14px;">
            ì´ë²ˆ íŒì€ ì €ìª½ ì†ì„ ë“¤ì–´ì¤˜ì•¼ê² ë„¤.<br>
            ë³´ìƒì€ ì—†ì§€ë§Œ, ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ë…¸ë ¤ë´!
          </div>
          `,
          "images/npc/duel_carnia.png",
          true,
          "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
        );

        const logMsg = isRandomMatch
          ? `${userId}ë‹˜(${attackerLvHtml})ì´ ëœë¤ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ${targetUserId}ë‹˜(${defenderLvHtml})ê³¼ì˜ ê²°íˆ¬ì—ì„œ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤...`
          : `${userId}ë‹˜(${attackerLvHtml})ì´ ${targetUserId}ë‹˜(${defenderLvHtml})ê»˜ ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤...`;

        writeLog(logMsg);
      }

      update();
      save();

      // VS í™”ë©´ ë‹«ê¸°
      hideDuelBattleOverlay();
    }, delay);

  });
}
  
// âš”ï¸ ê²°íˆ¬ ì‹ ì²­ í™•ì¸ íŒì—… (ì§ì ‘ ê²°íˆ¬ ì‹ ì²­ ì „ìš©)
function showDuelConfirmPopup(targetUserId) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ§â€â™€ï¸ ì¹´ë¥´ë‹ˆì•„ ì„¸íŒ…
  setNpcName("ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸");
  imgEl.src = "images/npc/duel_carnia.png";

  // ğŸ—¨ ì¹´ë¥´ë‹ˆì•„ ë§íˆ¬ë¡œ ëŒ€ì‚¬ êµì²´
  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ì¢‹ì•„, ìŠ¹ë¶€ë¥¼ ê³ í•˜ëŠ”êµ°!
    </div>
    <div style="font-size:14px; line-height:1.5;">
      ì •ë§ë¡œ <b>${targetUserId}</b>ì™€(ê³¼) ì •ì •ë‹¹ë‹¹íˆ ë§ì„œê² ë‚˜?
    </div>
  `;

  // ë²„íŠ¼ ë…¸ì¶œ + í…ìŠ¤íŠ¸ ë³€ê²½
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "ê²°íˆ¬í•œë‹¤!";
  cancelBtn.textContent = "ì ê¹ë§Œâ€¦";

  okBtn.onclick = function () {
    popup.style.display = "none";
    // ì§ì ‘ ì‹ ì²­ì€ isRandomMatch = false
    performDuel(targetUserId, false);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
  };

  popup.style.display = "flex";
}
  
function showNpcMessage(
  text,
  imgPath = "images/npc/blacksmith_idle.png",
  showButton = true,
  npcName = "ëŒ€ì¥ì¥ì´ â€“ í¼ê·¸ë€íŠ¸"
) {
  // ğŸ”¹ imgPathê°€ nullì´ë©´ NPC ì—†ì´ ì“°ëŠ” 'ì‹œìŠ¤í…œ íŒì—…' ëª¨ë“œ
  const noNpc = (imgPath === null);

  // ì¶œì„ ê°™ì€ ì‹œìŠ¤í…œ íŒì—…ì´ë©´ ì´ë¦„ ë¹„ìš°ê¸°, ì•„ë‹ˆë©´ ê¸°ë³¸/ì§€ì •ëœ NPC ì´ë¦„ ì‚¬ìš©
  setNpcName(noNpc ? "" : npcName);

  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) {
    alert(text);
    return;
  }

  // ì•ˆë‚´ ë¬¸êµ¬ ì„¸íŒ…
  msgEl.innerHTML = text;

  // ğŸ”¹ NPC ì´ë¯¸ì§€ ì²˜ë¦¬
  if (noNpc) {
    // ì¶œì„ ë“±: NPC ì—°ì¶œ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ
    imgEl.style.display = "none";
  } else {
    imgEl.style.display = "block";
    imgEl.src = imgPath;
  }

  // ë²„íŠ¼ ì²˜ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼)
  if (showButton) {
    okBtn.style.display = "inline-block";
    okBtn.textContent = "í™•ì¸";
    okBtn.onclick = closeNpcPopup;
  } else {
    okBtn.style.display = "none";
  }

  cancelBtn.style.display = "none";
  cancelBtn.onclick = closeNpcPopup;

  popup.style.display = "flex";
}

// âŒ¨ï¸ ì—”í„° í‚¤ë¡œ NPC íŒì—… "í™•ì¸" ëˆ„ë¥´ê¸° (í•œ ë²„íŠ¼ íŒì—… ì „ìš©)
window.addEventListener("keydown", function (e) {
  if (e.key !== "Enter") return;

  const popup = document.getElementById("npcPopup");
  if (!popup) return;

  // íŒì—…ì´ ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ
  if (popup.style.display === "none" || popup.style.display === "") return;

  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!okBtn || !cancelBtn) return;

  // âœ… "í™•ì¸"ë§Œ ìˆëŠ” íŒì—…ì¼ ë•Œë§Œ ì—”í„°ë¡œ ì‘ë™í•˜ê²Œ (íŒë§¤í™•ì¸ ê°™ì€ ê±´ ë³´í˜¸)
  const okVisible     = okBtn.style.display !== "none";
  const cancelVisible = cancelBtn.style.display !== "none";

  if (okVisible && !cancelVisible) {
    e.preventDefault();   // í¼ ì œì¶œ ê°™ì€ ê¸°ë³¸ í–‰ë™ ë§‰ê¸°
    okBtn.click();        // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
  }
});

  
// í”„ë¡œí•„ ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ í‘œì‹œ
let profileSaveTimer = null;

function setProfileSaveStatus(message, durationMs) {
  const el = document.getElementById("profileSaveStatus");
  if (!el) return;

  el.textContent = message;
  el.style.opacity = "1";

  if (profileSaveTimer) {
    clearTimeout(profileSaveTimer);
    profileSaveTimer = null;
  }

  if (durationMs && durationMs > 0) {
    profileSaveTimer = setTimeout(() => {
      el.style.opacity = "0";
    }, durationMs);
  }
}
  // ğŸ“· í”„ë¡œí•„ ì¹´ë“œ ìº¡ì³ í›„ ì´ë¯¸ì§€ ì €ì¥
function saveProfileCard() {

  const card = document.getElementById("fieldBg");

  setProfileSaveStatus("ì €ì¥ì¤‘ ...", 0);

  // âœ… ìº¡ì³ ì „ìš© ëª¨ë“œ í™œì„±í™”
  document.body.classList.add("capture-mode");

  html2canvas(card, {
    scale: 2,
    useCORS: true
  }).then(canvas => {

    // â¬… ì €ì¥ í›„ ì›ë˜ í™”ë©´ ë³µêµ¬
    document.body.classList.remove("capture-mode");

    canvas.toBlob(function (blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${userId}_profile_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);

      setProfileSaveStatus("ì €ì¥ì™„ë£Œ !", 1500);
    });

  }).catch(err => {

    // â›” ì˜¤ë¥˜ ë°œìƒí•´ë„ í™”ë©´ ë³µêµ¬
    document.body.classList.remove("capture-mode");
    setProfileSaveStatus("ì €ì¥ ì‹¤íŒ¨...", 2000);
  });
}


  // âš ï¸ 25ê°• ì´ìƒ ì„¸ì´í”„ì¡´ ì‚­ì œ ì•ˆë‚´ íŒì—…
function showUpgradeWarning25() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // NPC ì´ë¦„ / ì´ë¯¸ì§€ ì„¸íŒ… (ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸)
  setNpcName("ëŒ€ì¥ì¥ì´ â€“ í¼ê·¸ë€íŠ¸");
  imgEl.src = "images/npc/blacksmith_idle.png";

  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px; color:#FFCC00;">
      âš ï¸ 25ê°• ì´ìƒ êµ¬ê°„ ì•ˆë‚´
    </div>
    <div style="font-size:14px; line-height:1.6;">
      25ê°•ë¶€í„°ëŠ” ë” ì´ìƒ <b>ì„¸ì´í”„ì¡´ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë„¤.</b><br>
      ì‹¤íŒ¨í•˜ë©´ <b>ê°•ë“±</b>ì´ë‚˜ <span style="color:#FF5555;">íŒŒê´´</span>ê°€<br>
      ì–¸ì œë“  ì¼ì–´ë‚  ìˆ˜ ìˆì§€.
      <br><br>
      ê·¸ë˜ë„â€¦ ê³„ì† ë„ì „í•˜ê² ë‚˜?
    </div>
  `;

  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";

  okBtn.textContent = "ê·¸ë˜ë„ ë„ì „í•œë‹¤";
  cancelBtn.textContent = "ìƒê°í•´ë³¸ë‹¤";

  okBtn.onclick = function () {
    popup.style.display = "none";
    hasSeen25Warning = true;          // ì´í›„ë¡  ê²½ê³  ë‹¤ì‹œ ì•ˆ ëœ¸
    ignoreNextUpgradeWarning = true;  // ì´ë²ˆì— í•œ ë²ˆì€ ê²½ê³  ìŠ¤í‚µí•˜ê³  upgrade ì¬í˜¸ì¶œ
    upgrade();                        // ì‹¤ì œ ê°•í™” ë¡œì§ ë‹¤ì‹œ ì§„ì…
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
  };

  popup.style.display = "flex";
}

function showTutorialIfFirstTime() {

  if (!userId) return;   // ë¡œê·¸ì¸ ì•ˆ ëìœ¼ë©´ ìˆ˜í–‰ ì•ˆ í•¨

  const key = getTutorialKeyForUser(userId);

  try {
    if (localStorage.getItem(key) === "1") return;
  } catch (e) {}

  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}


function closeTutorial() {
  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) overlay.style.display = "none";

  if (!userId) return;

  const key = getTutorialKeyForUser(userId);

  try {
    localStorage.setItem(key, "1");
  } catch (e) {}
}
  
function closeNpcPopup() {
  const popup = document.getElementById("npcPopup");
  if (popup) popup.style.display = "none";
}

  // ğŸ”¥ ê°•í™” ê²°ê³¼ ì—°ì¶œ (ë¶‰ì€ / í™©ê¸ˆ í”Œë˜ì‹œ)
function playUpgradeFlash(mode) {
  const overlay = document.getElementById("upgradeFlashOverlay");
  if (!overlay) return;

  // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
  overlay.classList.remove("flash-red", "flash-gold");

  // ê°™ì€ í´ë˜ìŠ¤ë¥¼ ë‹¤ì‹œ ì¤„ ë•Œ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ ê°•ì œ
  void overlay.offsetWidth; 

  if (mode === "red") {
    overlay.classList.add("flash-red");
  } else if (mode === "gold") {
    overlay.classList.add("flash-gold");
  }
}

// ğŸ§­ ì‚¬ëƒ¥í„° ì´ë™ ì „ìš© íŒì—… (NPC ì´ë¯¸ì§€/ë²„íŠ¼ ìˆ¨ê¹€)
function showMovePopup() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName"); 

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ”¹ NPC ì´ë¦„ ì§€ìš°ê¸°
  if (nameEl) nameEl.textContent = "";
  
  // ì´ë¯¸ì§€ / ë²„íŠ¼ ì „ë¶€ ìˆ¨ê¸°ê³ , í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
  imgEl.style.display = "none";
  okBtn.style.display = "none";
  cancelBtn.style.display = "none";

  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
      ì‚¬ëƒ¥í„° ì´ë™ ì¤‘...
    </div>
  `;

  popup.style.display = "flex";
}


// âš”ï¸ ì‚¬ëƒ¥ ê²°ê³¼ íŒì—… (NPC ì´ë¯¸ì§€/ë²„íŠ¼ X)
function showHuntPopup(text, color = "#FFFFFF") {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ”¹ ì´ë¦„ ì œê±°
  if (nameEl) nameEl.textContent = "";
  
  // ì´ë¯¸ì§€ / ë²„íŠ¼ ìˆ¨ê¹€
  imgEl.style.display = "none";
  okBtn.style.display = "none";
  cancelBtn.style.display = "none";

  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; color:${color};">
      ${text}
    </div>
  `;

  popup.style.display = "flex";

  // 1.2ì´ˆ í›„ ìë™ ë‹«í˜ + ê¸°ë³¸ ìƒíƒœ ë³µì›
  setTimeout(() => {
    popup.style.display = "none";
    imgEl.style.display = "block";
    okBtn.style.display = "inline-block";
    cancelBtn.style.display = "none";
  }, 1200);
}

// ğŸŸ ì¿ í° ì…ë ¥ íŒì—… ì—´ê¸°
function openCouponPopup() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // NPC ì´ë¦„/ì´ë¯¸ì§€ ìˆ¨ê¹€ (ì‹œìŠ¤í…œ íŒì—… ëª¨ë“œ)
  if (nameEl) nameEl.textContent = "";
  imgEl.style.display = "none";

  // ì…ë ¥ UI êµ¬ì„±
  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; margin-bottom:8px;">
      ì¿ í°
    </div>
    <div style="font-size:13px; margin-bottom:6px;">
      ì¿ í°ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    </div>
    <input id="couponInput"
           type="text"
           maxlength="32"
           style="width:100%; padding:6px 8px; font-size:13px;
                  box-sizing:border-box; text-align:center;"/>
  `;

  // ë²„íŠ¼ ì„¤ì •
  okBtn.style.display = "inline-block";
  okBtn.textContent   = "í™•ì¸";
  okBtn.onclick       = submitCouponCode;

  cancelBtn.style.display = "inline-block";
  cancelBtn.textContent   = "ì·¨ì†Œ";
  cancelBtn.onclick       = closeNpcPopup;

  popup.style.display = "flex";

  // í¬ì»¤ìŠ¤ ì£¼ê¸°
  setTimeout(() => {
    const input = document.getElementById("couponInput");
    if (input) input.focus();
  }, 0);
}

// ğŸŸ ì¿ í° ì½”ë“œ í™•ì¸ ì²˜ë¦¬
function submitCouponCode() {
  const input = document.getElementById("couponInput");
  if (!input) {
    closeNpcPopup();
    return;
  }

  const rawCode = input.value.trim();
  if (!rawCode) {
    // ë¹ˆ ì…ë ¥
    showNpcMessage("ì¿ í°ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", null, true, "");
    return;
  }

  const code = rawCode.toUpperCase();
  const reward = couponRewards[code];

  // 1) ë“±ë¡ë˜ì§€ ì•Šì€ ì½”ë“œ
  if (!reward) {
    closeNpcPopup();
    showNpcMessage("ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•œ ì½”ë“œì…ë‹ˆë‹¤.", null, true, "");
    return;
  }

  // 2) ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œ
  if (couponUsedMap && couponUsedMap[code]) {
    closeNpcPopup();
    showNpcMessage("ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œì…ë‹ˆë‹¤.", null, true, "");
    return;
  }

  // 3) ìµœì´ˆ ì‚¬ìš© â†’ ë³´ìƒ ì§€ê¸‰
  // ì•„ì´í…œ ì§€ê¸‰
  switch (reward.type) {
    case "itemScroll21":
      itemScroll21 = Number(itemScroll21 || 0) + reward.count;
      break;
    case "itemProtect":
      itemProtect = Number(itemProtect || 0) + reward.count;
      break;
    case "itemSuper":
      itemSuper = Number(itemSuper || 0) + reward.count;
      break;
    case "itemDownProtect":
      itemDownProtect = Number(itemDownProtect || 0) + reward.count;
      break;
    case "itemRateUp5":
      itemRateUp5 = Number(itemRateUp5 || 0) + reward.count;
      break;
    case "starShard":
      starShard = Number(starShard || 0) + reward.count;
      break;
    case "honorMedal":
      itemHonorMedal = Number(itemHonorMedal || 0) + reward.count;
      break;
    // í•„ìš”í•˜ë©´ íƒ€ì… ë” ì¶”ê°€ ê°€ëŠ¥
    default:
      break;
  }

  // ì‚¬ìš© ê¸°ë¡
  if (!couponUsedMap) couponUsedMap = {};
  couponUsedMap[code] = true;

  // ì €ì¥ & UI ê°±ì‹ 
  save();
  update();

  closeNpcPopup();
  showNpcMessage(reward.desc || "ì¿ í°ì´ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.", null, true, "");
}
  
function closeMovePopup() {
  const popup     = document.getElementById("npcPopup");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !imgEl || !okBtn || !cancelBtn) return;

  // ë‹¤ìŒì— NPC ëŒ€ì‚¬ ì“¸ ìˆ˜ ìˆë„ë¡ ëŒ€ëµ ê¸°ë³¸ í˜•íƒœë¡œ ë³µì›
  imgEl.style.display = "block";
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "none";

  popup.style.display = "none";
}
  
// ìˆ«ì ê³¨ë“œë¥¼ "1ê²½ 2,345ì¡° 6,789ì–µ 1,234ë§Œ 5,678" í˜•íƒœë¡œ ë³€í™˜
function formatGold(value) {
  const n = Number(value) || 0;

  // 100ë§Œ ë¯¸ë§Œì€ ê·¸ëƒ¥ ìˆ«ì+ì½¤ë§ˆë¡œ
  if (n < 1_000_000) {
    return n.toLocaleString();
  }

  // í•œêµ­ì‹ ë‹¨ìœ„
  const MAN    = 10_000;                  // ë§Œ
  const EOK    = 1_0000_0000;             // ì–µ
  const JO     = 1_0000_0000_0000;        // ì¡°
  const GYEONG = 1_0000_0000_0000_0000;   // ê²½

  let rest = n;

  const gyeong = Math.floor(rest / GYEONG);
  rest = rest % GYEONG;

  const jo = Math.floor(rest / JO);
  rest = rest % JO;

  const eok = Math.floor(rest / EOK);
  rest = rest % EOK;

  const man = Math.floor(rest / MAN);
  const won = rest % MAN;

  const parts = [];
  if (gyeong > 0) parts.push(`${gyeong.toLocaleString()}ê²½`);
  if (jo > 0)     parts.push(`${jo.toLocaleString()}ì¡°`);
  if (eok > 0)    parts.push(`${eok.toLocaleString()}ì–µ`);
  if (man > 0)    parts.push(`${man.toLocaleString()}ë§Œ`);
  if (won > 0)    parts.push(won.toLocaleString());

  if (parts.length === 0) return "0";
  return parts.join(" ");
}
  
function randRange(min, max) {
  return min + Math.random() * (max - min);
}

  function getCurrentUpgradeCost() {
  return getUpgradeCost(Math.min(sword, 29));
}

function getUpgradeCost(level) {

  const costTable = {
    0: 0,
    1: 20,
    2: 50,
    3: 100,
    4: 500,
    5: 1000,
    6: 3000,
    7: 5000,
    8: 10000,
    9: 30000,
    10: 50000,
    11: 100000,
    12: 300000,
    13: 500000,
    14: 1000000,
    15: 3000000,
    16: 5000000,
    17: 10000000,
    18: 30000000,
    19: 50000000,
    20: 100000000,
    21: 300000000,
    22: 500000000,
    23: 1000000000,
    24: 3000000000,
    25: 5000000000,
    26: 10000000000,
    27: 30000000000,
    28: 50000000000,
    29: 100000000000
  };

  return costTable[level] ?? 0;
}

// íŒë§¤ ì‹œ, ê·¸ ë ˆë²¨ì—ì„œ ë‹¤ìŒ ê°•í™”ë¥¼ ëª‡ ë²ˆ ì •ë„ ë„ì „ ê°€ëŠ¥í•˜ê²Œ í•´ì¤„ì§€ ê²°ì •
function getSellAttemptFactor(level) {
  // 30ê°•ì€ 29ê°• ê¸°ì¤€ìœ¼ë¡œ ë³¸ë‹¤ (ë¹„ìš©/í™•ë¥  í…Œì´ë¸”ì´ 29ê¹Œì§€ë¼ì„œ)
  const forChance = Math.min(level, 29);

  const chance = getUpgradeChance(forChance); // 0~100
  if (chance <= 0) return 2; // ì•ˆì „ ì¥ì¹˜

  const expectedTries = 100 / chance; // ì„±ê³µê¹Œì§€ í‰ê·  ì‹œë„ íšŸìˆ˜

  if (expectedTries <= 2.0) {
    return 2;   // ì„±ê³µë¥  ë†’ìŒ â†’ 2ë²ˆ ì •ë„ ë„ì „ê¶Œ
  } else if (expectedTries <= 3.5) {
    return 3;
  } else if (expectedTries <= 4.5) {
    return 4;
  } else if (expectedTries <= 7.0) {
    return 5;   // ì˜ˆ: 20%~25%ëŒ€ í™•ë¥ 
  } else {
    return 6;   // ì•„ì£¼ ë‚®ì€ í™•ë¥  â†’ 5~6ë²ˆ ë„ì „ê¶Œ
  }
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ ê³„ì‚°
// A = 0â†’Lê¹Œì§€ ì„±ê³µ ê°€ì • ì´ë¹„ìš©
// B = Lê°• ê°•í™”ë¹„ìš© Ã— (ê¸°ëŒ“ê°’ ê¸°ë°˜ ë„ì „ íšŸìˆ˜)
// ë³´ìƒ = (A + B) Ã— 1.15~1.20
function getSellReward(level) {
  if (level <= 0) return 0; // 0ê°•ì€ íŒ” ê²Œ ì—†ìŒ

  const totalCost = getTotalCostToLevel(level);   // A
  const costNow   = getUpgradeCost(Math.min(level, 29)); // Lê°• ì‹œë„ ë¹„ìš© (30ê°• ë³´í˜¸)

  const attemptFactor = getSellAttemptFactor(level); // ë„ì „ íšŸìˆ˜ ë³´ì •
  const B = costNow * attemptFactor;

  const base = totalCost + B;
  const mul  = randRange(1.15, 1.20); // 115% ~ 120%

  const reward = Math.floor(base * mul);
  return reward;
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ "í‰ê· " ê°’ (ë¬´ê¸°ê°€ì¹˜ í‘œì‹œìš©)
function getSellRewardAverage(level) {
  if (level <= 0) return 0;

  const totalCost = getTotalCostToLevel(level);
  const costNow   = getUpgradeCost(Math.min(level, 29));
  const attemptFactor = getSellAttemptFactor(level);
  const B = costNow * attemptFactor;

  const base = totalCost + B;

  // getSellReward ì—ì„œ 1.15 ~ 1.20 ëœë¤ì´ë‹ˆê¹Œ, ì¤‘ê°„ê°’ 1.175ë¥¼ í‰ê· ìœ¼ë¡œ ì‚¬ìš©
  const avgMultiplier = (1.15 + 1.20) / 2; // 1.175
  return Math.floor(base * avgMultiplier);
}

  
// 0ê°• â†’ levelê°• ê¹Œì§€, ëª¨ë‘ 1íŠ¸ ì„±ê³µí•œë‹¤ê³  ê°€ì •í•œ ì´ ê°•í™”ë¹„ìš©
function getTotalCostToLevel(level) {
  let sum = 0;
  for (let i = 0; i < level; i++) {
    sum += getUpgradeCost(i);
  }
  return sum;
}

// âš”ï¸ ê°•í™”ë¹„ìš© ê¸°ë°˜ ê³µê²©ë ¥ ê³„ì‚°
function getBaseAttack(level) {
  // 0ê°•ë„ ìµœì†Œ 10 ì´ìƒì€ ë‚˜ì˜¤ê²Œ
  const total = getTotalCostToLevel(level); // 0â†’levelê¹Œì§€ ì´ ê°•í™”ë¹„ìš©
  const atk = Math.floor(total / 1000) + 10;
  return atk;
}

// âš”ï¸ í˜„ì¬ ê°•í™” ë‹¨ê³„ ê¸°ì¤€ ì „íˆ¬ë ¥ ì‚°ì • (ìµœì´ˆ 1íšŒ ê²°ì •, ê³ ì •)
function rollPowerForCurrentSword() {

  // 1ï¸âƒ£ ì§€ê¸ˆê¹Œì§€ ê°•í™”ì— ë“¤ì–´ê°„ ì´ ë¹„ìš© = ê¸°ë³¸ ì „íˆ¬ë ¥ ì§€í‘œ
  const totalCost = getTotalCostToLevel(sword);

  // 2ï¸âƒ£ ì „íˆ¬ë ¥ ê¸°ë³¸ê°’ (ìŠ¤ì¼€ì¼ ì¡°ì ˆìš© ê³„ìˆ˜)
  const basePower = totalCost * 0.6;

  // 3ï¸âƒ£ Â±5% í¸ì°¨ ì ìš© (1íšŒë§Œ êµ´ë¦¼)
  const variance = basePower * (Math.random() * 0.1 - 0.05);
  const finalPower = basePower + variance;

  // 4ï¸âƒ£ ìµœì†Œê°’ ë³´ì • + ì •ìˆ˜í™”
  power = Math.max(1, Math.floor(finalPower));
}
  
/* í™•ë¥  */
function getUpgradeChance(level) {
  // 0 -> 1 ì€ 100% ê³ ì •
  if (level === 0) return 100;

  let chance;

  if (level < 20) {
    // 1 ~ 19ê°• êµ¬ê°„ : ë ˆë²¨ 1 ì˜¤ë¥¼ ë•Œë§ˆë‹¤ -4%
    chance = 100 - (level * 4);
  } else {
    // 20ê°• ì´í›„ : -2%ì”© ê°ì†Œ
    const base20 = 100 - (20 * 4); // 20%
    const extra = level - 20;
    chance = base20 - (extra * 2);
  }

  // ğŸ’« ì „ì²´ êµ¬ê°„ ì†Œí­ ìƒí–¥ (+5%)
  chance += 5;

  // ìƒí•œ/í•˜í•œ ì •ë¦¬
  chance = Math.min(100, chance); // 100% ë„˜ì§€ ì•Šê²Œ
  chance = Math.max(5, chance);   // ì•ˆì „ í•˜í•œ (ì‹¤ì œë¡œëŠ” ê±°ì˜ 10% ì´ìƒì¼ ê²ƒ)

  return chance;
}
// ğŸ° ì¶œì„ ê°€ì±  ë³´ìƒ(ê°€ì¤‘ì¹˜ % í•©ê³„ = 100)
const ATTENDANCE_GACHA_POOL = [
  { type: "itemProtect",     name: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",        count: 1,  weight: 5,  img: "images/items/scroll_protect.png" },
  { type: "itemSuper",       name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ",        count: 1,  weight: 3,  img: "images/items/scroll_super.png" },
  { type: "itemDownProtect", name: "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",        count: 1,  weight: 15, img: "images/items/scroll_down_protect.png" },
  { type: "honorMedal",      name: "ëª…ì˜ˆì˜ í›ˆì¥",            count: 30, weight: 15, img: "images/items/honor_medal.png" },
  { type: "itemRateUp5",     name: "ê°•í™”í™•ë¥  +5% ì£¼ë¬¸ì„œ",    count: 1,  weight: 7,  img: "images/items/scroll_rateup_5.png" },
  { type: "starShard",       name: "ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°",  count: 5,  weight: 15, img: "images/items/star_shard.png" },
  { type: "itemScroll15",    name: "15ê°• ê°•í™” ì£¼ë¬¸ì„œ",       count: 1,  weight: 10, img: "images/items/scroll_15.png" },
  { type: "itemScroll21",    name: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",       count: 1,  weight: 5,  img: "images/items/scroll_21.png" },
  { type: "itemDownProtect", name: "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",        count: 5,  weight: 5,  img: "images/items/scroll_down_protect.png" },
  { type: "gold",            name: "5ì–µ ê³¨ë“œ",               count: 500000000, weight: 20, img: "images/items/gold.png" }
];

// ğŸ² ê°€ì¤‘ì¹˜ ëœë¤ 1ê°œ ë½‘ê¸°
function pickAttendanceGachaReward() {
  const total = ATTENDANCE_GACHA_POOL.reduce((sum, r) => sum + (Number(r.weight) || 0), 0);
  let roll = Math.random() * total;

  for (const r of ATTENDANCE_GACHA_POOL) {
    roll -= (Number(r.weight) || 0);
    if (roll <= 0) return r;
  }
  return ATTENDANCE_GACHA_POOL[ATTENDANCE_GACHA_POOL.length - 1];
}

// ğŸ ì‹¤ì œ ë³´ìƒ ì§€ê¸‰ (ê¸°ì¡´ ë³€ìˆ˜ëª… ê·¸ëŒ€ë¡œ ì‚¬ìš©)
function grantAttendanceGachaReward(reward) {
  if (!reward) return;

  switch (reward.type) {
    case "itemProtect":
      itemProtect = Number(itemProtect || 0) + reward.count;
      break;
    case "itemSuper":
      itemSuper = Number(itemSuper || 0) + reward.count;
      break;
    case "itemDownProtect":
      itemDownProtect = Number(itemDownProtect || 0) + reward.count;
      break;
    case "itemRateUp5":
      itemRateUp5 = Number(itemRateUp5 || 0) + reward.count;
      break;
    case "itemScroll15":
      itemScroll15 = Number(itemScroll15 || 0) + reward.count;
      break;
    case "itemScroll21":
      itemScroll21 = Number(itemScroll21 || 0) + reward.count;
      break;
    case "starShard":
      starShard = Number(starShard || 0) + reward.count;
      break;
    case "honorMedal":
      itemHonorMedal = Number(itemHonorMedal || 0) + reward.count;
      break;
    case "gold":
      gold = Number(gold || 0) + Number(reward.count || 0);
      break;
    default:
      break;
  }
}

function preloadAttendanceGachaImages() {
  try {
    ATTENDANCE_GACHA_POOL.forEach(r => {
      if (!r.img) return;
      const img = new Image();
      img.src = r.img;
    });
  } catch (e) {}
}
  
// ğŸï¸ 3ì´ˆ ê°€ì±  ì—°ì¶œ: ë¹ ë¥´ê²Œâ†’ì ì  ëŠë ¤ì§€ë‹¤ê°€ ë©ˆì¶¤
function playAttendanceGachaAnimationAndGrant(onDone) {
  // ì´ˆê¸° í‘œì‹œìš©(ì²« í”„ë ˆì„ë„ ëœë¤)
  let current = pickAttendanceGachaReward();

  const html = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      âœ… ì¶œì„ ì™„ë£Œ! (ë³´ìƒ ì¶”ì²¨ ì¤‘â€¦)
    </div>

    <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:6px;">
      <img id="attendanceGachaImg"
           src="${current.img || ""}"
           style="width:52px; height:52px; image-rendering:pixelated; border:1px solid #444; border-radius:8px;"
           onerror="this.style.display='none'">
      <div>
        <div id="attendanceGachaName" style="font-size:14px; font-weight:bold;">${current.name}</div>
        <div id="attendanceGachaSub" style="font-size:12px; color:#bbb; margin-top:2px;">
          ${current.type === "gold" ? formatGold(current.count) + " ê³¨ë“œ" : ("x" + current.count)}
        </div>
      </div>
    </div>

    <div style="margin-top:10px; font-size:12px; color:#aaa;">
      ì•„ì´í…œì´ ë©ˆì¶”ë©´ ê·¸ ë³´ìƒì´ ì§€ê¸‰ë©ë‹ˆë‹¤â€¦
    </div>
  `;

  // âœ… ë²„íŠ¼ ìˆ¨ê¸°ê³  íŒì—… ë„ìš°ê¸° (NPC ì—†ì´)
  showNpcMessage(html, null, false, "");

  const imgEl = document.getElementById("attendanceGachaImg");
  const nameEl = document.getElementById("attendanceGachaName");
  const subEl  = document.getElementById("attendanceGachaSub");

  const start = Date.now();
  const endAt = start + 5000; // âœ… ì´ 5ì´ˆ

  let delay = 60; // ì‹œì‘ì€ ë¹ ë¥´ê²Œ

  function tick() {
    const now = Date.now();
    const left = endAt - now;

    // ë‚¨ì€ ì‹œê°„ì´ 0 ì´í•˜ë©´ í™•ì •
    if (left <= 0) {
      // ìµœì¢… ë³´ìƒ ì§€ê¸‰
      grantAttendanceGachaReward(current);

      // ë¡œê·¸
      const rewardText = current.type === "gold"
        ? `${formatGold(current.count)} ê³¨ë“œ`
        : `${current.name} x${current.count}`;

      writeLog(`${userId}ë‹˜ì´ ì¶œì„ ë³´ìƒìœ¼ë¡œ ${rewardText} ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤. (ì—°ì† ${attendanceStreak}íšŒ)`);

      // ì €ì¥/ê°±ì‹ 
      save();
      update();

      // ìµœì¢… ê²°ê³¼ íŒì—…(ë²„íŠ¼ ë³´ì´ê²Œ)
      const finalHtml = `
        <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
          ğŸ‰ ì¶œì„ ë³´ìƒ í™•ì •!
        </div>
        <div style="font-size:13px;">
          <b>${rewardText}</b> ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.<br>
          (ì—°ì† ${attendanceStreak}íšŒ)
        </div>
      `;
      closeNpcPopup();
      showNpcMessage(finalHtml, null, true, "");

      if (typeof onDone === "function") onDone(current);
      return;
    }

    // ê³„ì† êµ´ë¦¬ê¸°: ë§¤ tickë§ˆë‹¤ â€œí‘œì‹œë˜ëŠ” ì•„ì´í…œâ€ì„ ë°”ê¿ˆ
    current = pickAttendanceGachaReward();

    if (imgEl) {
      imgEl.style.display = "block";
      imgEl.src = current.img || "";
    }
    if (nameEl) nameEl.textContent = current.name;
    if (subEl) {
      subEl.textContent = (current.type === "gold")
        ? (formatGold(current.count) + " ê³¨ë“œ")
        : ("x" + current.count);
    }

        // âœ… ë’¤ë¡œ ê°ˆìˆ˜ë¡ í™• ëŠë ¤ì§€ê²Œ (íŠ¹íˆ ë§ˆì§€ë§‰ 2ì´ˆê°€ ë” ì«„ê¹ƒ)
    const totalMs = 5000;
    const t = Math.min(1, (now - start) / totalMs); // 0~1 ì§„í–‰ë¥ 

    // ë§ˆì§€ë§‰ 40% êµ¬ê°„(= ì•½ 2ì´ˆ)ì— ë” ê°•í•œ ê°ì†ì„ ì£¼ê¸° ìœ„í•´ ì§€ìˆ˜ ê°€ì¤‘
    // tê°€ 0.6 ë„˜ì–´ê°€ë©´ ê¸‰ê²©íˆ ëŠë ¤ì§
    const eased = Math.pow(t, 2.6); // ìˆ«ì â†‘ = ëë¶€ë¶„ ë” ëŠ˜ì–´ì§

    // delay ë²”ìœ„: ì´ˆë°˜ 50~90ms, í›„ë°˜ 700msê¹Œì§€
    const minDelay = 130;
    const maxDelay = 720;

    delay = Math.floor(minDelay + (maxDelay - minDelay) * eased);

    setTimeout(tick, delay);
  }

  tick();
}

function checkAttendance() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const today = getTodayDateString();

  // ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•¨
  if (lastAttendanceDate === today) {
    alert("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤!");
    return;
  }

  // ë‚ ì§œ ë¹„êµ (ì—°ì† ì¶œì„ ì²˜ë¦¬)
  const yesterday = getYesterdayDateString();

  // ì–´ì œë„ ì°ì—ˆìœ¼ë©´ ì—°ì† ì¶œì„ +1, ì•„ë‹ˆë©´ 1ë¶€í„°
  if (lastAttendanceDay === yesterday) {
    attendanceStreak++;
  } else {
    attendanceStreak = 1;
  }

  lastAttendanceDay = today;
  lastAttendanceDate = today;
  attendanceCount++;

  // âœ… ì—¬ê¸°ì„œ ë°”ë¡œ â€œê°€ì±  ì—°ì¶œ + ë³´ìƒ ì§€ê¸‰â€
  preloadAttendanceGachaImages();
  playAttendanceGachaAnimationAndGrant();
}
  
/* ê°•í™” */
function upgrade() {
  if (sword >= 30) {
    alert("ìµœëŒ€ ê°•í™”");
    return;
  }

  // ğŸ›‘ 25ê°• ì´ìƒ ì²« ë„ì „ ê²½ê³  ì•ˆë‚´ (ì„¸ì…˜ 1íšŒ)
  if (sword >= 25 && !hasSeen25Warning && !ignoreNextUpgradeWarning) {
    showUpgradeWarning25();
    return;
  }
  // ê²½ê³ ë¥¼ ë³´ê³  ë‹¤ì‹œ ë“¤ì–´ì˜¨ í˜¸ì¶œì€ ì´ í”Œë˜ê·¸ë¡œ í•œ ë²ˆ ìŠ¤í‚µ
  ignoreNextUpgradeWarning = false;

    // âœ… ë„íŒŒë¯¼ì¤‘ë…ì: 25ê°• ì´í›„ íŒŒê´´ë°©ì§€ ì—†ì´ ê°•í™” 'ì‹œë„'
  if (sword >= 25) {
    const usingProtect = (document.getElementById("useProtect")?.checked);
    if (!usingProtect) {
      dopamineTried = 1;
      if (grantTitleOnceNoSave("dopamine")) save();
    }
  }
  
  // ì´ë¯¸ ê°•í™” ì¤‘ì´ë©´ ì¤‘ë³µ í´ë¦­ ë°©ì§€
  if (isUpgrading) return;

  // ğŸ”˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì½ê¸°
  const scroll15El = document.getElementById("useScroll15");
  const protectEl  = document.getElementById("useProtect");
  const downProtEl = document.getElementById("useDownProtect");
  const superEl    = document.getElementById("useSuper");
  const scroll21El = document.getElementById("useScroll21");   // ğŸ†•
  const rate5El    = document.getElementById("useRateUp5");    // ğŸ†•  

  const wantScroll15 = !!(scroll15El && scroll15El.checked);
  const wantProtect  = !!(protectEl  && protectEl.checked);
  const wantDownProt = !!(downProtEl && downProtEl.checked);
  const wantSuper    = !!(superEl    && superEl.checked);
  const wantScroll21 = !!(scroll21El && scroll21El.checked);    // ğŸ†•
  const wantRate5    = !!(rate5El    && rate5El.checked);       // ğŸ†•

  // âš ï¸ ì•„ì´í…œ ì—†ëŠ” ìƒíƒœì—ì„œ ì²´í¬í•œ ê²½ìš° â†’ ê°•í™” ì§„í–‰ ê¸ˆì§€
  if (wantScroll15 && itemScroll15 <= 0) {
    showNpcMessage("15ê°• ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantProtect && itemProtect <= 0) {
    showNpcMessage("íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantDownProt && itemDownProtect <= 0) {
    showNpcMessage("ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantSuper && itemSuper <= 0) {
    showNpcMessage("ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantScroll21 && itemScroll21 <= 0) {
  showNpcMessage("21ê°• ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
  return;
  }
  if (wantRate5 && itemRateUp5 <= 0) {
  showNpcMessage("ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
  return;
  }

  // âœ… UX: ê°•í™” 1íšŒ ì‹œë„ ì‹œì‘ ì‹œ, ì„ íƒí•œ ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ëŠ” ëª¨ë‘ ìë™ í•´ì œ
  [scroll15El, protectEl, downProtEl, superEl, scroll21El, rate5El].forEach(el => {
    if (el) el.checked = false;
  });
  
  // ğŸ›‘ 28ê°• ì´ìƒì—ì„œëŠ” ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ ì‚¬ìš© ë¶ˆê°€
  if (sword >= 28 && wantSuper) {
    showNpcMessage(
      "28ê°• ì´ìƒ ë¬´ê¸°ì—ëŠ” ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œë¥¼ ì“¸ ìˆ˜ ì—†ë‹¤ë„¤.",
      "images/npc/blacksmith_idle.png"
    );
    if (superEl) superEl.checked = false;  // ì²´í¬ë„ í’€ì–´ì£¼ê¸°
    return;
  }

  // ğŸ¯ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ ì „ìš© ì²˜ë¦¬ (ì¦‰ì‹œ ì²˜ë¦¬, ë”œë ˆì´ X)
  if (wantScroll15) {

    if (sword >= 15) {
      alert("15ê°• ì´ìƒì˜ ë¬´ê¸°ì—ëŠ” 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const before = sword;          // ğŸ”¹ ì¶”ê°€: ì£¼ë¬¸ì„œ ì‚¬ìš© ì „ ë ˆë²¨ ê¸°ì–µ

    itemScroll15 -= 1;
    sword = 15;

      // ğŸ”¹ 0ê°• â†’ 15ê°•ìœ¼ë¡œ ì í”„í–ˆë‹¤ë©´ ì—¬ê¸°ì„œ ê²€/ì°½ ëœë¤ í™•ì •
  ensureWeaponTypeAfterUpgrade(before, sword);
    
    rollPowerForCurrentSword();

    if (scroll15El) scroll15El.checked = false; // í•œ ë²ˆ ì“°ê³  ì²´í¬ í•´ì œ

  writeLog(
  `${userId}ë‹˜ì´ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ê¸°ê°€ ${coloredLevel(15)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
);

// í¼ê·¸ë€íŠ¸ ëŒ€ì‚¬ + ì„±ê³µ ì´ë¯¸ì§€
showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#C0C0C0;">
    15ê°• ê°•í™”!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì§€! 15ê°•, ë‹¨ìˆ¨ì— ì˜¬ë ¤ì£¼ì§€.
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

    update();
    save();
    return;
  }

// ğŸ¯ 21ê°• ê°•í™” ì£¼ë¬¸ì„œ ì „ìš© ì²˜ë¦¬ (ì¦‰ì‹œ ì²˜ë¦¬, ë”œë ˆì´ X)
if (wantScroll21) {
  if (sword >= 21) {
    showNpcMessage("ë²Œì¨ 21ê°•ì€ ë„˜ê²¼ì–ë‚˜. ì´ ì£¼ë¬¸ì„œëŠ” ì•„ê¹Œìš°ë‹ˆê¹Œ ì•„ê»´ë‘ìê³ .");
    return;
  }

    const before = sword;        // ğŸ”¹ ì¶”ê°€
  
  itemScroll21 -= 1;
  sword = 21;

    // ğŸ”¹ 0ê°• â†’ 21ê°•ìœ¼ë¡œ ì í”„í–ˆë‹¤ë©´ ì—¬ê¸°ì„œ ê²€/ì°½ ëœë¤ í™•ì •
  ensureWeaponTypeAfterUpgrade(before, sword);
  
  rollPowerForCurrentSword();

  if (sword > maxSwordLevel) {
    maxSwordLevel = sword;
  }

  showNpcMessage(
    `
    <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
      ê°•í™”ì„±ê³µ!
    </div>
    <div style="margin-top:6px;">
      21ê°•ê¹Œì§€ í•œ ë²ˆì— ëŒì–´ì˜¬ë ¸ì–´. ëŒ€ë‹¨í•œ ì„ íƒì´êµ°.
    </div>
    `,
    "images/npc/blacksmith_success.png"
  );

  update();
  save();
  updateUpgradeItemLabels();
  return;
}

// ğŸ” 5% ê°•í™” ì£¼ë¬¸ì„œ ì²´í¬í–ˆëŠ”ë° ì¬ê³ ê°€ ì—†ìœ¼ë©´ ë§‰ê¸°
if (wantRate5 && itemRateUp5 <= 0) {
  showNpcMessage("ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê°€ ì—†êµ¬ë§Œ. ê·¸ê±¸ë¡œ ë¶ˆê¸¸ì„ ì¢€ ë” ì‚´ë ¤ì•¼ í•´.");
  const rate5El = document.getElementById("checkRate5");
  if (rate5El) rate5El.checked = false;  // ì²´í¬ë„ í’€ì–´ì£¼ê¸°
  updateUpgradeItemLabels();
  return;
}
  
   // ğŸª™ ì¼ë°˜ ê°•í™” (íŒŒê´´ë°©ì§€ / ìŠˆí¼ê°•í™”ë§Œ ì˜í–¥)
  const cost = getUpgradeCost(sword);

  if (gold < cost) {
    showNpcMessage(
      "ìë„¤, ê³¨ë“œëŠ” ì¶©ë¶„í•œê²Œ ë§ë‚˜?",
      "images/npc/blacksmith_idle.png"
    );
    return;
  }

  // ğŸ‘‰ ì—¬ê¸°ì„œë¶€í„° ì§„ì§œ ê°•í™” ì‹œì‘ì´ë‹ˆê¹Œ,
  //    ì´ì œ ì ê¸ˆ ì²˜ë¦¬
  isUpgrading = true;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = true);

  // ê³¨ë“œ ì°¨ê° ë° ì•„ì´í…œ ì†Œë¹„ëŠ” ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì²˜ë¦¬
  gold -= cost;

  let chance = getUpgradeChance(sword);
  const before = sword;

const useProtect  = wantProtect  && itemProtect > 0;
const useSuper    = wantSuper    && itemSuper   > 0;
const useDownProt = wantDownProt && itemDownProtect > 0;
const useRate5    = wantRate5    && itemRateUp5 > 0;   // ğŸ†•

  // âœ… ì´ë²ˆ ì‹œë„ì— â€œì£¼ë¬¸ì„œ/ê°•í™”í…œâ€ì„ ì¼ëŠ”ì§€(ìŠ¹ë¶€ì‚¬/ì‹  íŒì •ìš©)
const usedAnyScrollThisAttempt = !!(useProtect || useDownProt || useSuper || useRate5);

// âœ… ìŠ¹ë¶€ì‚¬ ëŸ° ìƒíƒœ ê´€ë¦¬
if (before < 21) {
  // 21ê°• ë¯¸ë§Œì´ë©´ ëŸ° ì´ˆê¸°í™”
  gamblerRunActive = false;
  gamblerRunNoScroll = true;
} else if (!gamblerRunActive) {
  // 21ê°• ì´ìƒ â€œì§„ì… ìˆœê°„â€
  gamblerRunActive = true;
  gamblerRunNoScroll = true;
}

// 21ê°• ëŸ° ë„ì¤‘ ì£¼ë¬¸ì„œë¥¼ í•œ ë²ˆì´ë¼ë„ ì“°ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
if (gamblerRunActive && usedAnyScrollThisAttempt) {
  gamblerRunNoScroll = false;
}

// âœ… ëª¨ë“  ì£¼ë¬¸ì„œëŠ” ê°•í™” ë²„íŠ¼ ëˆ„ë¥¸ ì‹œì ì— ì¦‰ì‹œ ì†Œëª¨
if (useProtect)  itemProtect     -= 1;
if (useSuper)    itemSuper       -= 1;
if (useDownProt) itemDownProtect -= 1;
if (useRate5) {
  itemRateUp5 -= 1;
  chance += 5;
  if (chance > 95) chance = 95;  // ìƒí•œ (ì›í•˜ë©´ ì¡°ì ˆ ê°€ëŠ¥)
}

  // ğŸ•’ 1~2ì´ˆ ëœë¤ ë”œë ˆì´ ë™ì•ˆ "ê°•í™” ì¤‘..." íŒì—…
const delayMs = 500 + Math.random() * 500; // 0.5 ~ 1.0ì´ˆ

showNpcMessage(
  "ê°•í™” ì¤‘ì…ë‹ˆë‹¤...",
  "images/npc/blacksmith_upgrade.png",
  false   // â¬… ë²„íŠ¼ ìˆ¨ê¹€
);


  setTimeout(() => {
    // ì¤€ë¹„ íŒì—… ë‹«ê¸°
    closeNpcPopup();

    // ğŸ² ì„±ê³µ / ì‹¤íŒ¨ íŒì •
if (Math.random() < chance / 100) {
  // âœ… ì„±ê³µ
  let up = useSuper ? 2 : 1; // ìŠˆí¼ê°•í™”ë©´ +2
  
// âœ… ìŠˆí¼ê°•í™” ì„±ê³µì¼ ë•Œë§Œ ì¹´ìš´íŠ¸/ì¹­í˜¸ ì§€ê¸‰ (ìŠˆí¼ìŠ¤íƒ€)
if (useSuper) {
  superSuccessCount = Number(superSuccessCount || 0) + 1;

  // 1íšŒ ë‹¬ì„± ì¦‰ì‹œ ì¹­í˜¸ ì§€ê¸‰
  if (superSuccessCount >= 1) {
    if (grantTitleOnceNoSave("superstar")) save(); // ìµœì´ˆ íšë“ ì‹œë§Œ ì €ì¥
  }
}

  while (up > 0 && sword < 30) {
    sword++;
    up--;
    downStreak = 0;
  }
  
  // ğŸ”¹ 0ê°• â†’ 1ê°• ì´ìƒìœ¼ë¡œ ì²˜ìŒ ì˜¬ë¼ê°”ìœ¼ë©´ ì—¬ê¸°ì„œ íƒ€ì… í™•ì •
      ensureWeaponTypeAfterUpgrade(before, sword);

  // âœ… ìŠ¹ë¶€ì‚¬: 21ê°•ë¶€í„° â€œì£¼ë¬¸ì„œ ì—†ì´â€ 24ê°• ë„ë‹¬
if (gamblerRunActive && gamblerRunNoScroll && before < 24 && sword >= 24) {
  if (grantTitleOnceNoSave("gambler")) save();
}

// âœ… ì‹ : 29ê°•ì—ì„œ â€œì£¼ë¬¸ì„œ ì—†ì´â€ 30ê°• ë‹¬ì„± (ì´ë²ˆ ì‹œë„ ìì²´ê°€ ë¬´ì£¼ë¬¸ì„œì—¬ì•¼ í•¨)
if (before === 29 && sword >= 30 && !usedAnyScrollThisAttempt) {
  if (grantTitleOnceNoSave("god30")) save();
}

// âœ… 30ê°• ë‹¬ì„± â†’ ëª…ì˜ˆì˜ ì „ë‹¹ â€œëŒ€ê¸° ë“±ë¡(72ì‹œê°„)â€
if (before < 30 && sword >= 30) {
  reach30Count = Number(reach30Count || 0) + 1;

  // ë¬´ê¸°ë³„ 30ê°• ë‹¬ì„± ì¹´ìš´íŠ¸ë„ ìœ ì§€(ë³„/ë„ê° ë“±ì— ì¬ì‚¬ìš© ê°€ëŠ¥)
  const wt = weaponType || "sword";
  weapon30Counts = weapon30Counts || {};
  weapon30Counts[wt] = Number(weapon30Counts[wt] || 0) + 1;

  // ğŸ›ï¸ ì „ë‹¹ ì¹´ìš´íŠ¸ ì‹œì‘
  hofAchievedAt = Date.now();
  hofWeaponTypeAt30 = wt;
  hofDeadline = hofAchievedAt + (72 * 60 * 60 * 1000); // 72ì‹œê°„
  hofProcessedAt = 0;

  // âœ… ì „ë‹¹ í ë“±ë¡: í•´ë‹¹ ìœ ì €ê°€ ì ‘ì† ì•ˆ í•´ë„, ë‹¤ë¥¸ ìœ ì €ê°€ ê²Œì„ ì¼œë©´ ìŠ¤ìœ• ì²˜ë¦¬ ê°€ëŠ¥
db.ref("hofQueue/" + userId).set(hofDeadline).catch(() => {});

    // ğŸŒŒ 30ê°• ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ ë°œí–‰
  const weaponName = getWeaponInfo(30, wt).name;
  const winnerNick = formatNicknameWithTitle(userId, equippedTitle, reach30Count);
  const eventId = publishGlobal30Event(userId, winnerNick, weaponName, wt);

  // ë‹¬ì„±ìëŠ” â€˜ë´¤ìŒâ€™ ì²˜ë¦¬ (ì›í•˜ë©´)
  lastSeenGlobal30EventId = eventId;
  save();

}

  rollPowerForCurrentSword();
  
    // ìµœê³  ê°•í™” ê¸°ë¡ ê°±ì‹ 
  if (sword > maxSwordLevel) {
    maxSwordLevel = sword;
  }

  // í¼ê·¸ë€íŠ¸ ì„±ê³µ ë©˜íŠ¸
  if (useSuper) {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFD700;">
    ìŠˆí¼ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ë‘ ë‹¨ê³„ë‚˜ ì˜¬ë¼ê°”ë‹¤ê³ !? ì „ì„¤ì´ ë³´ì´ëŠ”êµ°!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  } else {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
    ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì•„! ì œëŒ€ë¡œ ë¶™ì—ˆêµ¬ë§Œ!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  }

  // âš™ï¸ ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ ì „ìš© ì„±ê³µ ë©˜íŠ¸
if (useRate5) {
  showNpcMessage(
    `
    <div style="font-size:18px; font-weight:bold; margin-bottom:4px; color:#ffd54f;">
      ê°•í™” ì„±ê³µ!
    </div>
    <div style="font-size:13px; line-height:1.6;">
      ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê¹Œì§€ ì¨ ê°€ë©° ë°€ì–´ë¶™ì¸ ë³´ëŒì´ ìˆêµ°.<br>
      <span style="color:#ffb74d;">+${before}ê°• â†’ +${sword}ê°•</span>,<br>
      ì´ì œ ì´ ê²€ì€ í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ì˜ ê°„íŒì´ë¼ ë¶ˆëŸ¬ë„ ë˜ê² ì–´.
    </div>
    `,
    "images/npc/blacksmith_success.png",
    true,
    "í¼ê·¸ë€íŠ¸ â€“ ëŒ€ì¥ê°„ ì£¼ì¸"
  );
}

  if (before >= 24) {
    // ğŸŒŸ 25ê°• ì´ìƒ ë„ì „ ì„±ê³µ ë¡œê·¸ (ë„ì „ ì°¬ì–‘ ë²„ì „)
    writeLog(
      `${userId}ì´ ${coloredLevel(before + 1)}ì˜ ë²½ì„ ëŒíŒŒí•˜ì—¬ ` +
      `${coloredLevel(sword)}ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!<br>` +
      `<span style="color:#ffd54f;">ê·¸ ìš©ê¸°ì— í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ì´ ë°•ìˆ˜ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.</span>`
    );
  } else if (before >= 20) {
    // ê¸°ì¡´ 20ê°• ì´ìƒ ì„±ê³µ ë¡œê·¸
    writeLog(
      `${userId}ì´ ${coloredLevel(before + 1)} ë„ì „ì— ì„±ê³µí•˜ì—¬ ${coloredLevel(sword)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
    );
  }
  
    // âœ¨ 25ê°• ì´ìƒ ë„ì „ ì„±ê³µ ì‹œ í™©ê¸ˆ í”Œë˜ì‹œ
  if (before >= 24) {  // before+1 ì´ 25ê°• ì´ìƒ
    playUpgradeFlash("gold");
  }

  } else {
    // âŒ ì‹¤íŒ¨
    // âœ… 5,10,15,20ê¹Œì§€ë§Œ ì„¸ì´í”„ / 25ë¶€í„°ëŠ” ì„¸ì´í”„ ì—†ìŒ
    const isSafeLevel = (before % 5 === 0 && before <= 20);

    if (useProtect) {
      downStreak = 0;
      // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš© ì‹œ
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FF5555;">
          ê°•í™”ì‹¤íŒ¨!
        </div>
        <div style="margin-top:6px;">
          ìœ„í—˜í–ˆë„¤â€¦ ì£¼ë¬¸ì„œ ë•ì— ë²„í…¼ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      if (isSafeLevel) {
        downStreak = 0;
        // ì„¸ì´í”„ êµ¬ê°„ ì‹¤íŒ¨ â†’ ìœ ì§€
        showNpcMessage(
          `
          <div style="font-size:18px; font-weight:bold; color:#FF5555;">
            ê°•í™”ì‹¤íŒ¨!
          </div>
          <div style="margin-top:6px;">
            í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼. ëŒ€ì‹  ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œë¼ë„¤.
          </div>
          `,
          "images/npc/blacksmith_fail.png"
        );
      } else {
        if (sword <= 10) {
          downStreak = 0;
          // ì €ë ˆë²¨ ì‹¤íŒ¨ â†’ ê·¸ëƒ¥ ìœ ì§€
          showNpcMessage(
            `
            <div style="font-size:18px; font-weight:bold; color:#FF5555;">
              ê°•í™”ì‹¤íŒ¨!
            </div>
            <div style="margin-top:6px;">
              í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
            </div>
            `,
            "images/npc/blacksmith_fail.png"
          );
} else if (sword <= 20) {
  // 11~20êµ¬ê°„ : ì ˆë°˜ì€ ìœ ì§€, ì ˆë°˜ì€ ê°•ë“±
  if (Math.random() < 0.5) {
    downStreak = 0;
    // ì‹¤íŒ¨ (ìœ ì§€)
    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF5555;">
        ê°•í™”ì‹¤íŒ¨!
      </div>
      <div style="margin-top:6px;">
        í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else {
    // ê°•ë“± or ê°•ë“±ë°©ì§€ ë°œë™
    if (useDownProt) {
      downStreak = 0;
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FFA500;">
          ê°•ë“± ë°©ì§€!
        </div>
        <div style="margin-top:6px;">
          ì•„ìŠ¬ì•„ìŠ¬í–ˆë„¤â€¦ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œê°€ ë‹¨ê³„ë¥¼ ì§€ì¼œì¤¬ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      sword--;
      
            downStreak = Number(downStreak || 0) + 1;
      if (downStreak >= 4) {
        if (grantTitleOnceNoSave("slide4")) save();
      }

      rollPowerForCurrentSword();
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FFA500;">
          ê°•ë“± ë°œìƒ!
        </div>
        <div style="margin-top:6px;">
          ì—êµ¬, í•œ ë‹¨ê³„ ë‚´ë ¤ê°€ ë²„ë ¸ë„¤â€¦
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    }
  }
  } else {
    // íŒŒê´´ (ê°•ë“±ë°©ì§€ëŠ” íŒŒê´´ì—” íš¨ê³¼ ì—†ìŒ)
    const targetLevel = before + 1; // ë„ì „í•˜ë˜ ê°•í™” ë‹¨ê³„
    let gainedShard = 0;

    // â­ 22ê°• ì´ìƒ íŒŒê´´ ì‹œ 'ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°' ì§€ê¸‰
    if (targetLevel >= 22) {
      if (targetLevel === 22) gainedShard = 1;
      else if (targetLevel === 23) gainedShard = 2;
      else if (targetLevel === 24) gainedShard = 4;
      else if (targetLevel === 25) gainedShard = 7;
      else if (targetLevel === 26) gainedShard = 10;
      else if (targetLevel === 27) gainedShard = 14;
      else if (targetLevel === 28) gainedShard = 18;
      else if (targetLevel === 29) gainedShard = 23;
      // 30ê°• ì´í›„ëŠ” ì•„ì§ ë¯¸ì •ì´ë©´ 0ìœ¼ë¡œ ë‘ë©´ ë¨
    }

    if (gainedShard > 0) {
      starShard += gainedShard;
    }

    // ì‹¤ì œ íŒŒê´´ ì²˜ë¦¬
    sword = 0;
    downStreak = 0;
    weaponType = null;       // ğŸ”¹ íŒŒê´´ë˜ë©´ ë¬´ê¸° íƒ€ì…ë„ ì´ˆê¸°í™” (ë‹¤ìŒì— ë‹¤ì‹œ ëœë¤)
          // âœ… íŒŒê´´ë˜ë©´ ìŠ¹ë¶€ì‚¬ ëŸ°ì€ ëŠê¹€
gamblerRunActive = false;
gamblerRunNoScroll = true;

// âœ… í­ì£½ë†€ì´: 21~25ê°• ë„ì „(=targetLevel) íŒŒê´´ ì²´í¬
if (targetLevel >= 21 && targetLevel <= 25) {
  fireworksDestroyed = fireworksDestroyed || { 21:false, 22:false, 23:false, 24:false, 25:false };
  fireworksDestroyed[targetLevel] = true;

  const allDone =
    fireworksDestroyed[21] &&
    fireworksDestroyed[22] &&
    fireworksDestroyed[23] &&
    fireworksDestroyed[24] &&
    fireworksDestroyed[25];

  if (allDone) {
    if (grantTitleOnceNoSave("fireworks")) save();
  }
}

          rollPowerForCurrentSword();

    destroyCount++;  
    // ğŸ§¨ ëˆ„ì  íŒŒê´´ íšŸìˆ˜ ì¦ê°€
    checkAndGrantTitles();

   // âœ… ìš´ìˆ˜ì¢‹ì€ë‚  / ì´ì¹´ë£¨ìŠ¤ (íŒŒê´´ ë‹¹ì‹œ ë„ì „ ë ˆë²¨ ê¸°ì¤€)
   if (targetLevel < 20) {
    if (grantTitleOnceNoSave("luckyday")) save();
  }
  if (targetLevel >= 26) {
    if (grantTitleOnceNoSave("icarus")) save();
  }

    // ğŸ”” ë¡œê·¸ ë©”ì‹œì§€
  let logMsg =
    `${userId}ì´ ${coloredLevel(targetLevel)} ë„ì „ì— ì‹¤íŒ¨í•˜ì—¬ ` +
    `<span style="color:red;font-weight:bold;">íŒŒê´´</span> ë˜ì—ˆìŠµë‹ˆë‹¤!`;

  // ğŸ•¯ 25ê°• ì´ìƒ ë„ì „ì€ ë³„ë„ ì°¬ì–‘ ë²„ì „ ë©”ì‹œì§€
 if (before >= 25) {
    logMsg =
      `${userId}ì´ ${coloredLevel(targetLevel)}ì— ë„ì „í•˜ë‹¤ê°€ ` +
      `<span style="color:red;font-weight:bold;">íŒŒê´´</span>ë˜ì—ˆìŠµë‹ˆë‹¤!<br>` +
      `<span style="color:#ffb74d;">ìœ„ëŒ€í•œ ë„ì „ì— ëª¨ë‘ ë¬µë…...</span>`;
  }

  writeLog(logMsg, true);

  // ğŸ’¥ 25ê°• ì´ìƒ íŒŒê´´ ì‹œ ë¶‰ì€ í”Œë˜ì‹œ + ì „ì²´ ì—°ì¶œ
  if (before >= 25) {
    playUpgradeFlash("red");

    // ğŸŒ ì „ ì„œë²„ ê³µìš© ì´ë²¤íŠ¸ ê¸°ë¡ (ì—¬ê¸°ê°€ 4ë‹¨ê³„)
    try {
      globalEventsRef.push({
        type: "destroy25",
        userId: userId,
        level: targetLevel,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
    } catch (e) {
      console.error("globalEventsRef push ì‹¤íŒ¨:", e);
    }
  }

  if (before >= 25) {
    // ğŸ•¯ 25ê°• ì´ìƒ íŒŒê´´ ì‹œ í¼ê·¸ë€íŠ¸ íŠ¹ìˆ˜ ë©˜íŠ¸
    const shardLine =
      gainedShard > 0
        ? `<br><span style="color:#b0e0ff;">ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê° ${gainedShard}ê°œ</span>ê°€ ë‚¨ì•˜ë‹¤...`
        : "";

    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF4444;">
        ì¥ë¹„ê°€ ì‚°ì‚°ì´ ë¶€ì„œì ¸ ë²„ë ¸êµ°...
      </div>
      <div style="margin-top:6px; font-size:13px; line-height:1.5;">
        ${coloredLevel(targetLevel)}ë¥¼ í–¥í•œ ë„ì „ì€ ì‹¤íŒ¨ë¡œ ëë‚¬ì§€ë§Œ,<br>
        ì´ëŸ° ë°œê±¸ìŒì´ ì§„ì§œ ì¥ì¸ì„ ë§Œë“ ë‹¤ë„¤.${shardLine}
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else if (gainedShard > 0) {
    // ê¸°ì¡´: ë³„ ì¡°ê° ì„¤ëª… ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold; color:#FFDD88;">
        ì•ˆíƒ€ê¹ê²Œë„ íŒŒê´´ë˜ì—ˆì§€ë§Œ...
      </div>
      <div style="margin-top:6px; font-size:13px; line-height:1.5;">
        ì¹¼ë‚ ì´ ë¶€ì„œì§„ ìë¦¬ì—ì„œ<br>
        <span style="color:#b0e0ff;">ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê° ${gainedShard}ê°œ</span>ê°€ ë‚¨ì•˜ë„¤.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else {
    // ê¸°ì¡´ ê¸°ë³¸ ì‹¤íŒ¨ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF4444;">
        ì¥ë¹„ê°€ ì‚°ì‚°ì¡°ê° ë‚˜ ë²„ë ¸êµ°...
      </div>
      <div style="margin-top:6px;">
        ë‹¤ìŒ ì¹¼ë‚ ì€ ì˜¤ëŠ˜ì˜ ì‹¤íŒ¨ë¥¼ ê¸°ì–µí•  ê±°ì•¼.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  }

  }
      }
    }
  }

      // ğŸ†• ğŸ”¥ 5% ì£¼ë¬¸ì„œ íŠ¹ìˆ˜ ì‹¤íŒ¨ ë©˜íŠ¸ (ê¸°ì¡´ ì‹¤íŒ¨ ë©˜íŠ¸ë¥¼ ë®ì–´ì”€)
  if (useRate5 && sword <= before) {
    let detailText = "";

    if (sword === 0 && before > 0) {
      // íŒŒê´´ê¹Œì§€ ë‚œ ê²½ìš°
      detailText = "ê²€ì´ ì‚°ì‚°ì¡°ê° ë‚˜ ë²„ë ¸ì§€.";
    } else if (sword < before) {
      // ê°•ë“±ëœ ê²½ìš°
      detailText = `í•œ ë‹¨ê³„ ë‚´ë ¤ì•‰ì•˜ê³ , <span style="color:#ffb74d;">+${before}ê°• â†’ +${sword}ê°•</span>ì´ ë˜ì–´ ë²„ë ¸êµ°.`;
    } else {
      // ë ˆë²¨ì€ ê·¸ëŒ€ë¡œ(ì„¸ì´í”„ êµ¬ê°„ ì‹¤íŒ¨ ë“±)
      detailText = "ë‹¤í–‰íˆ ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œì§€ë§Œ, ë§ˆìŒì€ ê½¤ ì“°ë¦¬ê² êµ°.";
    }

    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; margin-bottom:4px; color:#FF8A80;">
        ê°•í™” ì‹¤íŒ¨...
      </div>
      <div style="font-size:13px; line-height:1.6;">
        ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê¹Œì§€ ì¨ ê°€ë©° ë¶ˆê¸¸ì„ ëŒì–´ì˜¬ë ¸ëŠ”ë°ë„ ì•ˆ ë¶™ë‹¤ë‹ˆâ€¦<br>
        ${detailText}<br>
        ë­, ì§„ì§œ ì¥ì¸ì€ ì´ëŸ° ë‚ ì„ ëª‡ ë²ˆì´ë‚˜ ê²ªê³  ë‚˜ì„œì•¼ ì™„ì„±ë˜ëŠ” ë²•ì´ì§€.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  }
    
// UI ê°±ì‹  + ì €ì¥ + í”Œë˜ê·¸ í•´ì œ
update();
const titleChanged = checkAndGrantTitles();
if (titleChanged) save();
save();

isUpgrading = false;

const actionButtons = document.querySelectorAll(".action-buttons button");
actionButtons.forEach(btn => btn.disabled = false);

  }, delayMs);
}

// ğŸ›’ ì‹¤ì œ íŒë§¤ ì²˜ë¦¬ + "íŒë§¤ ì™„ë£Œ" ë©˜íŠ¸
function completeSell(beforeLevel, rewardGold) {
  setNpcName("ë¬´ê¸°ìƒì¸ â€“ ë°”ë¥´í†¨ ë¡œë„¨");

  // íŒë§¤ ì²˜ë¦¬
  gold += rewardGold;
  sword = 0;
  weaponType = null;
  rollPowerForCurrentSword();

  // 20ê°• ì´ìƒ ì „ìš© ì™„ë£Œ ë©˜íŠ¸
  if (beforeLevel >= 20) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        â€¦ì•Œì•˜ë‹¤.
      </div>
      <div style="margin-top:4px;">
        ì´ ê²€ì€ ë‚´ê°€ ì±…ì„ì§€ê³  ë³´ê´€í•˜ì§€.<br>
        ê·¸ëŒ€ì˜ ì„ íƒì— ê°’í•˜ì—¬
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ë¥¼ ì§€ê¸‰í•˜ê² ë„¤.
      </div>
      `,
      "images/npc/merchant_bartol.png"
    );
  } else {
    // ì¼ë°˜ ì¥ë¹„ íŒë§¤ ì™„ë£Œ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ê±°ë˜ ì„±ì‚¬ëêµ°.
      </div>
      <div style="margin-top:4px;">
        ì¢‹ì€ ì„ íƒì´ì—ˆë„¤, ëª¨í—˜ê°€.<br>
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ë¥¼ ì§€ê¸‰í–ˆë„¤.
      </div>
      `,
      "images/npc/merchant_bartol.png"
    );
  }

  update();
  save();
}

  // ğŸ›’ ë°”ë¥´í†¨ ë¡œë„¨ íŒë§¤ í™•ì¸ íŒì—… (20ê°• ì´ìƒ í¬ê·€ ë©˜íŠ¸ í¬í•¨)
function showMerchantSellPopup(beforeLevel, rewardGold) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ†• ì´ë¦„ ì„¤ì •
  setNpcName("ë¬´ê¸°ìƒì¸ â€“ ë°”ë¥´í†¨ ë¡œë„¨");
  // ìƒì¸ ì´ë¯¸ì§€ë¡œ êµì²´
  imgEl.src = "images/npc/merchant_bartol.png";

  let innerHtml = "";

  if (beforeLevel >= 20) {
    // ğŸ§¿ 20ê°• ì´ìƒ â€” í¬ê·€ í‰ê°€ ë©˜íŠ¸ ëœë¤
    const rareLines = [
      "ì´ ê²€â€¦ ìˆ˜ë§ì€ ì „ì¥ì„ ì§€ë‚˜ì˜¨ í”ì ì´ ë³´ì´ëŠ”êµ°.",
      "ì´ ë¬´ê¸°â€¦ ì£¼ì¸ì„ ì˜ ë§Œë‚¬ë˜ ê²€ì´ì•¼.",
      "ì „ì„¤ê¸‰ì´ë¼ ë¶€ë¥¼ ë§Œí•˜êµ°. ì‰½ê²Œ ë³¼ ë¬¼ê±´ì´ ì•„ë‹ˆì•¼."
    ];
    const flavor =
      rareLines[Math.floor(Math.random() * rareLines.length)];

    innerHtml = `
      <div style="font-size:16px; margin-bottom:6px;">
        ${flavor}
      </div>
      <div>
        ê°€ì¹˜ë¥¼ ì¡´ì¤‘í•´
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ì— ë§¤ì…í•˜ì§€.<br>
        ì •ë§ ë– ë‚˜ë³´ë‚´ê² ë‚˜?
      </div>
    `;
  } else {
    // ğŸŸ¡ ì¼ë°˜ ì¥ë¹„ ë©˜íŠ¸
    innerHtml = `
      <div style="font-size:16px; margin-bottom:6px;">
        í â€¦ ì¢‹ì€ ì¥ë¹„ë¥¼ ê°–ê³  ìˆêµ° ê·¸ë˜.
      </div>
      <div>
        ë‚´ ëˆˆìœ¼ë¡œ ë³´ê±´ëŒ€
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ì— ë§¤ì…í•´ ì£¼ê² ë„¤.<br>
        ì •ë§ íŒë§¤í•˜ê² ë‚˜?
      </div>
    `;
  }

  msgEl.innerHTML = innerHtml;

  // ë²„íŠ¼ ì„¤ì •
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "íŒë§¤í•œë‹¤";
  cancelBtn.textContent = "ê·¸ë§Œë‘”ë‹¤";

  // ê¸°ì¡´ onclick ì œê±° í›„ ìƒˆë¡œ ë“±ë¡
  okBtn.onclick = function () {
    popup.style.display = "none";
    // íŒë§¤ í™•ì •
    completeSell(beforeLevel, rewardGold);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
    // ì·¨ì†Œ ì‹œ ì´ë¯¸ì§€ ì›ë³µ (ëŒ€ì¥ì¥ì´ ê¸°ë³¸ìœ¼ë¡œ)
    imgEl.src = "images/npc/blacksmith_idle.png";
  };

  popup.style.display = "flex";
}
  
function sell() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (sword <= 0) {
    alert("íŒë§¤í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const before = sword;
  const reward = getSellReward(before);

  // ğŸ” ë°”ë¡œ íŒë§¤í•˜ì§€ ì•Šê³ , ë°”ë¥´í†¨ íŒë§¤ í™•ì¸ íŒì—… í˜¸ì¶œ
  showMerchantSellPopup(before, reward);
}

/* ì‚¬ëƒ¥ */
function hunt(){
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  // ì‚¬ëƒ¥ ì „ ìŠ¤íƒœë¯¸ë‚˜ ìµœì‹ í™”
  recalcHuntStamina();

  // ìŠ¤íƒœë¯¸ë‚˜ê°€ 0ì´ë©´ ì‚¬ëƒ¥ ë¶ˆê°€
  if (huntStamina <= 0) {
    showHuntPopup(
      `
      <div style="font-size:18px; font-weight:bold;">
        ì‚¬ëƒ¥ ë¶ˆê°€
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
        ì‹œê°„ì´ ì§€ë‚˜ë©´ ë‹¤ì‹œ íšŒë³µë©ë‹ˆë‹¤.
      </div>
      `,
      "#CCCCCC"
    );
    return;
  }

  const field = HUNT_FIELDS[currentField];
  if (!field) {
    alert("ì‚¬ëƒ¥í„°ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const successChance = getHuntSuccessChance(sword, currentField);

  if (successChance <= 0) {
    alert("ì´ ì‚¬ëƒ¥í„°ëŠ” ì§€ê¸ˆ ì¥ë¹„ë¡œëŠ” ë„ˆë¬´ ìœ„í—˜í•©ë‹ˆë‹¤! (ì„±ê³µë¥  0%)");
    return;
  }

// ì‹¤ì œ ê³µê²©ë ¥ì€ ë¯¸ë¦¬ êµ´ë ¤ë‘” power ì‚¬ìš© (Â±5% í¸ì°¨ ë°˜ì˜ëœ ê°’)
const atk = power; // ì§€ê¸ˆì€ ì‚¬ìš© X, ë‚˜ì¤‘ì— ì‚¬ëƒ¥ ë°ë¯¸ì§€/ì„±ê³µë¥ ì— ë°˜ì˜ ê°€ëŠ¥

// ğŸ¦  ì—­ë³‘ì¥(ì‹œê¶ì°½) ì‚¬ëƒ¥ ì¹´ìš´íŠ¸: "ì‚¬ëƒ¥ ì‹œë„" 1íšŒë¡œ ëˆ„ì 
if (currentField === 2) {
  plagueRatHuntCount = Number(plagueRatHuntCount || 0) + 1;
}

// ì„±ê³µ ì—¬ë¶€
const r = Math.random() * 100;
if (r < successChance) {
  // âœ… ì„±ê³µ
  const reward = getHuntReward(currentField);
  gold += reward;

  // ğŸ”” ê¸°ë³¸ íŒì—… ë¬¸êµ¬ (ê³¨ë“œ ë³´ìƒ)
  let popupMsg = `ì‚¬ëƒ¥ ì„±ê³µ!<br>ğŸ’° ${formatGold(reward)} ê³¨ë“œ íšë“`;

  // ğŸ ì•„ì´í…œ ë“œë ì²˜ë¦¬

  // LV6 ì´ìƒ: 3% í™•ë¥ ë¡œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
  if (currentField >= 6 && Math.random() < 0.015) {
    itemScroll15 += 1;

    popupMsg += `<br><br>ğŸ“œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV7 ì´ìƒ: 2% í™•ë¥ ë¡œ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
  if (currentField >= 7 && Math.random() < 0.01) {
    itemProtect += 1;

    popupMsg += `<br>ğŸ›¡ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV8 ì´ìƒ: 1% í™•ë¥ ë¡œ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
  if (currentField >= 8 && Math.random() < 0.005) {
    itemSuper += 1;

    popupMsg += `<br>âœ¨ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV4 ì´ìƒ: 10% í™•ë¥ ë¡œ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ
  if (currentField >= 4 && Math.random() < 0.05) {
    itemDownProtect += 1;

    popupMsg += `<br>ğŸ”’ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // âœ… ìµœì¢… íŒì—… í•œ ë²ˆë§Œ í˜¸ì¶œ (ê³¨ë“œ + ë“œë ê²°ê³¼ ëª¨ë‘ í¬í•¨)
  showHuntPopup(popupMsg, "#6CF");

} else {
  // âŒ ì‹¤íŒ¨
  showHuntPopup(
    "ì‚¬ëƒ¥ ì‹¤íŒ¨...<br>ë‹¤ìŒ ê¸°íšŒë¥¼ ë…¸ë¦¬ì.",
    "#FF6666"
  );
}

  // âœ… ì‚¬ëƒ¥ 1íšŒë‹¹ ìŠ¤íƒœë¯¸ë‚˜ 1 ê°ì†Œ
  const beforeStamina = huntStamina;
  huntStamina = Math.max(0, huntStamina - 1);
  // ì°¸ê³ ìš© ì¹´ìš´íŠ¸ (ì˜¤ëŠ˜ ì‚¬ìš©í•œ íšŸìˆ˜)
  huntCountToday = Math.max(0, 20 - huntStamina);

  // ğŸ” 20/20 â†’ 19/20ìœ¼ë¡œ ì²˜ìŒ ì¤„ì–´ë“œëŠ” ìˆœê°„ë¶€í„° 20ë¶„ ì¹´ìš´íŠ¸ ì‹œì‘
  if (beforeStamina === 20 && huntStamina === 19) {
    lastStaminaUpdate = Date.now();
  }

  update();
  save();
}

// ğŸ¯ ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥  ê³„ì‚°
function getHuntSuccessChance(myLevel, fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;

  const rec = field.recLevel; // ì¶”ì²œ ê°•í™” ë ˆë²¨
  const diff = rec - myLevel;

  if (diff <= 0) return 100;     // ê¶Œì¥ ë ˆë²¨ ì´ìƒì´ë©´ 100%
  if (diff >= 5) return 0;       // ë„ˆë¬´ ì°¨ì´ë‚˜ë©´ 0%

  // 1~4 ì°¨ì´: 80 / 60 / 40 / 20 %
  return 100 - diff * 20;
}

  // ğŸ’° ì‚¬ëƒ¥ ì„±ê³µ ì‹œ ê³¨ë“œ ë³´ìƒ
function getHuntReward(fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;
  
  // ğŸŒ± LV1 ì‚¬ëƒ¥í„°ëŠ” 0~20ê³¨ë“œ ëœë¤
  if (fieldId === 1) {
    return Math.floor(randRange(0, 21)); // 0 ì´ìƒ 21 ë¯¸ë§Œ â†’ 0~20
  }
  // ì„¤ëª…ì— ë”°ë¼: ì˜ˆ) 3LV â†’ 6ê°• ê°•í™”ë¹„ìš© ì‚¬ìš©
  const refLevel = field.recLevel;    // 0,3,6,...,27
  const baseCost = getUpgradeCost(refLevel); // í•´ë‹¹ ê°•ì˜ ê°•í™”ë¹„ìš©

  const mul = randRange(1.0, 1.5);   // 1.0 ~ 1.5 ë°°
  return Math.floor(baseCost * mul * 0.4);
}

function login() {
    
  // 1ï¸âƒ£ DOMì—ì„œ ì§ì ‘ ì…ë ¥ì°½ ê°€ì ¸ì˜¤ê¸°
  const idInput = document.getElementById("loginId");
  const pwInput = document.getElementById("loginPw");

  if (!idInput || !pwInput) {
    alert("ë¡œê·¸ì¸ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // 2ï¸âƒ£ ê°’ ì½ê¸°
  userId = idInput.value.trim();
  userPassword = pwInput.value;

  if (!userId || !userPassword) {
    alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // âœ… (ì¤‘ìš”) ë¡œê·¸ì¸ ì‹œë„ ì‹œì‘í•  ë•Œ ì´ì „ ê³„ì • ì¹­í˜¸ í”ì  ì œê±°
titlesOwned = {};
equippedTitle = "";
closeTitleOverlay();
  
weaponType   = null;
maxSwordLevel = 0;
destroyCount  = 0;

  
  // 3ï¸âƒ£ Firebase ref ì„¸íŒ…
  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {

    // â­ ì‹ ê·œ ê³„ì • ìƒì„± ì‹œ
    if (!s.exists()) {

      // ì²˜ìŒ ê³„ì • ìƒì„± ì‹œ, í˜„ì¬ sword ê¸°ì¤€ìœ¼ë¡œ ê³µê²©ë ¥ í•œ ë²ˆ êµ´ë ¤ë‘ê¸°
      rollPowerForCurrentSword();

      userRef.set({
        password: userPassword,
        sword,
        weaponType: null,   // ğŸ”¹ ì²˜ìŒ ê³„ì •ì€ ì•„ì§ ë¬´ê¸° íƒ€ì… ë¯¸ì •
        power,
        gold,
        updated: Date.now(),
        maxSwordLevel: 0,   
        destroyCount: 0,    
        attendanceCount: 0,
        lastAttendanceDate: "",
        attendanceStreak: 0,      
        lastAttendanceDay: "",    
        currentField: 1,
        huntCountToday: 0,
        plagueRatHuntCount: 0,
        dopamineTried: false,
        gamblerRunActive: false,
        gamblerRunNoScroll: true,
        fireworksDestroyed: { 21:false, 22:false, 23:false, 24:false, 25:false },
        reach30Count: 0,
        weapon30Counts: {},
        hofDeadline: 0,
        hofAchievedAt: 0,
        hofWeaponTypeAt30: "",
        hofProcessedAt: 0,
        lastHuntDate: "",
        itemScroll15: Number(itemScroll15),
        itemProtect: Number(itemProtect),
        itemSuper: Number(itemSuper),
        itemDownProtect: Number(itemDownProtect),
        starShard: Number(starShard),  
        itemScroll21: 0,   //  21ê°• ê°•í™” ì£¼ë¬¸ì„œ
        itemRateUp5: 0,    //  ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ
        huntStamina: 20,
        lastStaminaUpdate: Date.now(),
        // âš”ï¸ ê²°íˆ¬ ì´ˆê¸°ê°’
        duelWin: 0,
        duelLose: 0,
        duelCountToday: 0,
        lastDuelDate: "",
        duelTargetsToday: {},
        duelPoint: 0,
        duelPointWeekKey: getKstWeekKey(),
        duelLastWeekPoint: 0,
        duelLastWeekRank: 0,
        duelLastWeekRewardClaimed: false,

// ğŸ·ï¸ ì¹­í˜¸(ì—…ì ) ê¸°ë³¸ê°’
titlesOwned: {},
equippedTitle: ""
});

    // âœ… ì‹ ê·œ ê³„ì • ìƒì„± ì§í›„ì—ëŠ” ë°”ë¡œ í™”ë©´ ì „í™˜ + ì €ì¥ìœ¼ë¡œ ë§ˆë¬´ë¦¬
startSession();

try { localStorage.setItem("swordGameLastUser", userId); } catch(e) {}

const loginScreen = document.getElementById("loginScreen");
const gameScreen  = document.getElementById("gameScreen");
loginScreen.style.display = "none";
gameScreen.style.display  = "block";
document.getElementById("attendanceBtn").style.display = "block";
document.getElementById("inventoryBtn").style.display  = "block";
document.getElementById("logToggle").style.display     = "block";
document.getElementById("logoutBtn").style.display     = "block";
document.getElementById("duelBtn").style.display       = "block";
document.getElementById("scrollShopBtn").style.display = "block";
document.getElementById("mapBtn").style.display        = "block";
document.getElementById("couponBtn").style.display     = "block";
document.getElementById("userListBtn").style.display   = "block";
document.getElementById("achievementBtn").style.display = "block";

startAutoRefreshTimer();
subscribeGlobalDestroyEvents();
subscribeGlobal30Events();
update();
showTutorialIfFirstTime();
loadUpdateNotices();
ensureDuelWeek();
loadRanking();

// ì‹ ê·œ ê³„ì •ì€ ì•„ì§ ì—…ì  ì¡°ê±´ì´ ê±°ì˜ ì—†ìœ¼ë‹ˆ(0ê°•), ì²´í¬í•´ë„ ë¬´í•´í•˜ì§€ë§Œ ì•ˆì „ìƒ ì—¬ê¸°ì„  ìƒëµ ê°€ëŠ¥
// checkAndGrantTitles();

save();
return;
      
// âœ… (ì¤‘ìš”) ì‹ ê·œ ê³„ì • ìƒì„± ì§í›„: ë¡œì»¬ ë©”ëª¨ë¦¬ë„ ì´ˆê¸°í™”
// âœ… ì‹ ê·œ ê³„ì •ì€ ë‹¤ë¥¸ ìŠ¤íƒ¯ë„ í™•ì‹¤íˆ ì´ˆê¸°í™”(ì´ì „ ê³„ì • ì”ìƒ ë°©ì§€)
weaponType = null;
maxSwordLevel = 0;
destroyCount = 0;
duelPoint = 0;
duelWin = 0; duelLose = 0;
titlesOwned = {};
equippedTitle = "";

    } else {
      // â­ ê¸°ì¡´ ê³„ì • ë¡œê·¸ì¸ ì‹œ
      const data = s.val();

      // ğŸ” ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì† ì¤‘ì¸ì§€ ì²´í¬
      if (data.sessionId) {
        alert("ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì´ ê³„ì •ìœ¼ë¡œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤.\nê¸°ì¡´ ì ‘ì†ì„ ì¢…ë£Œí•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        userRef = null;   // ì´ íƒ­ì˜ ref ì´ˆê¸°í™”
        return;
      }

      if (data.password !== userPassword) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ì—¬ê¸°ì„œë¶€í„° ì§„ì§œ ë¡œê·¸ì¸ ì„±ê³µì´ í™•ì •ëœ ë’¤ì—ë§Œ ì¹­í˜¸ ë¡œë“œ
titlesOwned = (data.titlesOwned && typeof data.titlesOwned === "object") ? data.titlesOwned : {};
equippedTitle = (typeof data.equippedTitle === "string") ? data.equippedTitle : "";
      // ğŸ§¹ ê³¼ê±° ë²„ê·¸ ê°’ ì •ë¦¬: "${titleId}" ê°™ì€ ì“°ë ˆê¸° ê°’ì´ë©´ ì¥ì°© í•´ì œ
if (equippedTitle && equippedTitle.includes("${")) equippedTitle = "";

      plagueRatHuntCount = Number(data.plagueRatHuntCount || 0);
      gamblerRunActive = !!data.gamblerRunActive;
      gamblerRunNoScroll = (data.gamblerRunNoScroll !== false); // ê¸°ë³¸ true
      fireworksDestroyed = data.fireworksDestroyed || { 21:false, 22:false, 23:false, 24:false, 25:false };
      reach30Count = Number(data.reach30Count || 0);
      weapon30Counts = data.weapon30Counts || {};
      hofDeadline = Number(data.hofDeadline || 0);
      hofAchievedAt = Number(data.hofAchievedAt || 0);
      hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
      hofProcessedAt = Number(data.hofProcessedAt || 0);
      superSuccessCount = Number(data.superSuccessCount || 0);
      downStreak        = Number(data.downStreak || 0);
      dopamineTried     = Number(data.dopamineTried || 0);
      lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
      aweUsedGlobal30EventId  = Number(data.aweUsedGlobal30EventId || 0);

      sword = data.sword ?? 0;
      gold  = data.gold  ?? 100;

      // ğŸ—¡ ë¬´ê¸° íƒ€ì… ë¡œë“œ (v3.8 ì´ì „ ê³„ì • í˜¸í™˜ìš©)
if (data.weaponType !== undefined && data.weaponType !== null) {
  // v3.8 ì´í›„ì— ì €ì¥ëœ ê³„ì •
  weaponType = data.weaponType;
} else {
  // êµ¬ë²„ì „ ê³„ì • (weaponType ì—†ìŒ)
  if (sword > 0) {
    // ì´ë¯¸ ë¬´ê¸°ê°€ 1ê°• ì´ìƒì¸ ìœ ì €ëŠ” ì¼ë‹¨ 'ê²€' ë£¨íŠ¸ë¡œ ê°„ì£¼
    weaponType = "sword";
  } else {
    // 0ê°•ì´ë©´ ì•„ì§ ë¯¸ë°°ì • â†’ ë‹¤ìŒì— ì²˜ìŒ ê°•í™”í•  ë•Œ ëœë¤
    weaponType = null;
  }
}
      
      // â­ ì´ ì‹œì ì˜ ê°•í™”ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ê¸°ë¡
      lastSavedSwordForUpdated = sword;
      
      // ìµœê³  ê°•í™” / íŒŒê´´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      maxSwordLevel = data.maxSwordLevel ?? sword; // ì—†ìœ¼ë©´ í˜„ì¬ ê°•í™”ë¡œ ì´ˆê¸°í™”
      destroyCount  = data.destroyCount  ?? 0;
      
      // ğŸŸ¢ ì „íˆ¬ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ê±°ë‚˜ êµ¬ë²„ì „ì´ë©´ ì¬ê³„ì‚°)
      power = Number(data.power ?? 0);
      if (!power || power <= 20) {
        rollPowerForCurrentSword();
      }

      attendanceCount    = data.attendanceCount    ?? 0;
      lastAttendanceDate = data.lastAttendanceDate ?? "";
      attendanceStreak   = data.attendanceStreak   ?? 0;  
      lastAttendanceDay  = data.lastAttendanceDay  ?? "";
      currentField       = data.currentField       ?? 1;
      huntCountToday     = data.huntCountToday     ?? 0;
      lastHuntDate       = data.lastHuntDate       ?? "";
      itemScroll15       = data.itemScroll15 ?? 0;
      itemProtect        = data.itemProtect  ?? 0;
      itemSuper          = data.itemSuper    ?? 0;
      itemDownProtect    = data.itemDownProtect ?? 0;
      starShard          = data.starShard ?? 0;
      couponUsedMap = data.couponUsed || {};
      // âœ… ëª…ì˜ˆì˜ì „ë‹¹(30ê°•) / ê¸€ë¡œë²Œ 30ê°• ì´ë²¤íŠ¸ ìƒíƒœ ë¡œë“œ
      hofDeadline = Number(data.hofDeadline || 0);
      hofAchievedAt = Number(data.hofAchievedAt || 0);
      hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
      hofProcessedAt = Number(data.hofProcessedAt || 0);

      lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
      aweUsedGlobal30EventId = Number(data.aweUsedGlobal30EventId || 0);

      reach30Count = Number(data.reach30Count || 0);

      itemScroll21    = Number(data.itemScroll21    ?? 0); 
      itemRateUp5     = Number(data.itemRateUp5     ?? 0);
      huntStamina        = data.huntStamina       ?? 20;
      lastStaminaUpdate  = data.lastStaminaUpdate ?? Date.now();

      // âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ê°’
      duelWin        = data.duelWin        ?? 0;
      duelLose       = data.duelLose       ?? 0;
      duelCountToday = data.duelCountToday ?? 0;
      lastDuelDate   = data.lastDuelDate   ?? "";
      duelTargetsToday = data.duelTargetsToday ?? {};
      bully10Count      = Number(data.bully10Count || 0);
      challenger10Count = Number(data.challenger10Count || 0);
      brawl500Count     = Number(data.brawl500Count || 0);
      warGodWin         = Boolean(data.warGodWin || false);
      itemHonorMedal = data.itemHonorMedal ?? 0;
        // â­ ê²°íˆ¬ í¬ì¸íŠ¸ ë¡œë“œ (ì—†ìœ¼ë©´ 0)
      duelPoint       = data.duelPoint ?? 0;
      duelPointWeekKey = data.duelPointWeekKey || "";
      duelLastWeekPoint = data.duelLastWeekPoint ?? 0;
      duelLastWeekRank  = data.duelLastWeekRank ?? 0;
      duelLastWeekRewardClaimed = data.duelLastWeekRewardClaimed ?? false;
      duelUpdated         = data.duelUpdated ?? 0;
      duelLastWeekUpdated = data.duelLastWeekUpdated ?? 0;
      
      // ğŸŸ¢ ì£¼ì°¨ ì •ë¦¬ (ì§€ë‚œì£¼ í¬ì¸íŠ¸ ìŠ¤ëƒ…ìƒ· + ì´ë²ˆ ì£¼ ì´ˆê¸°í™”)
      ensureDuelWeek();
      // ğŸ† ì§€ë‚œì£¼ ë³´ìƒ ì²´í¬ & ì§€ê¸‰
      checkWeeklyDuelReward();

// ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹ UI + ìë™ ì „ë‹¹í–‰ ìŠ¤ìœ• + ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ êµ¬ë… ì‹œì‘
loadHallOfFame();
startHonorHallTimers();
updateHonorHallButton();
subscribeGlobal30Events();
   }

    // ğŸŸ¢ ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ëŠ” ê±´ ì‹¤ì œë¡œ ì´ íƒ­ì´ ì ‘ì†ì„ ê°€ì ¸ê°€ëŠ” ê²ƒ â†’ ì„¸ì…˜ ì‹œì‘
    startSession();

    // í™”ë©´ ì „í™˜
    const loginScreen = document.getElementById("loginScreen");
    const gameScreen  = document.getElementById("gameScreen");
    loginScreen.style.display  = "none";
    gameScreen.style.display   = "block";

    document.getElementById("attendanceBtn").style.display = "block";
    document.getElementById("inventoryBtn").style.display = "block";
    document.getElementById("logToggle").style.display = "block";
    document.getElementById("logoutBtn").style.display = "block";
    document.getElementById("duelBtn").style.display = "block";
    document.getElementById("scrollShopBtn").style.display = "block";
    document.getElementById("mapBtn").style.display = "block";
    document.getElementById("couponBtn").style.display = "block";
    document.getElementById("userListBtn").style.display = "block";
    document.getElementById("achievementBtn").style.display = "block";
    
        // âœ… ì—¬ê¸°ì—ì„œ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì‹œì‘
    startAutoRefreshTimer();

        // ğŸŒ 25ê°• ì´ìƒ íŒŒê´´ ê¸€ë¡œë²Œ ì•Œë¦¼ êµ¬ë… ì‹œì‘
    subscribeGlobalDestroyEvents();
        
    // ğŸ” ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ìœ ì € ì €ì¥
    try {
      localStorage.setItem("swordGameLastUser", userId);
    } catch (e) {
      console.warn("localStorage set ì‹¤íŒ¨", e);
    }

    update();
    showTutorialIfFirstTime();
    loadHallOfFame();
startHonorHallTimers();
updateHonorHallButton();
    loadUpdateNotices();   // ğŸ”” ë¡œê·¸ì¸ í›„ ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    ensureDuelWeek();

    // ğŸ† ë¡œê·¸ì¸ ì§í›„ ë­í‚¹/ë‚´ ë­í‚¹ ê°±ì‹ 
    loadRanking();

// ğŸ·ï¸ ì¹­í˜¸ ìë™ ì§€ê¸‰(ë¡œê·¸ì¸ ë¡œë“œ ì§í›„)
const titleChanged = checkAndGrantTitles();
if(titleChanged) save();
  });
}

function save() {
  if (!userRef) return;

  const updateData = {
    sword: Number(sword),
    weaponType: weaponType,
    power: Number(power),
    gold: Number(gold),
    maxSwordLevel: Number(maxSwordLevel),
    destroyCount: Number(destroyCount),
    attendanceCount: attendanceCount,
    lastAttendanceDate: lastAttendanceDate,
    attendanceStreak: Number(attendanceStreak),
    lastAttendanceDay: lastAttendanceDay,
    currentField: currentField,
    huntCountToday: huntCountToday,
    lastHuntDate: lastHuntDate,
    itemScroll15: Number(itemScroll15),
    itemProtect: Number(itemProtect),
    itemScroll21: Number(itemScroll21 ?? 0),
    itemRateUp5: Number(itemRateUp5 ?? 0),
    itemSuper: Number(itemSuper),
    itemDownProtect: Number(itemDownProtect),
    starShard: Number(starShard),
    huntStamina: Number(huntStamina),
    lastStaminaUpdate: Number(lastStaminaUpdate),
    duelWin: Number(duelWin),
    duelLose: Number(duelLose),
    duelCountToday: Number(duelCountToday),
    lastDuelDate: lastDuelDate,
    duelTargetsToday: duelTargetsToday,
    itemHonorMedal: Number(itemHonorMedal),
    duelPoint: Number(duelPoint),
    duelPointWeekKey: duelPointWeekKey,
    duelLastWeekPoint: Number(duelLastWeekPoint),
    duelLastWeekRank: Number(duelLastWeekRank),
    duelLastWeekRewardClaimed: Boolean(duelLastWeekRewardClaimed),
    duelUpdated: Number(duelUpdated || 0),
    duelLastWeekUpdated: Number(duelLastWeekUpdated || 0),
    couponUsed: couponUsedMap,   // ğŸ†• ì‚¬ìš© ì™„ë£Œ ì¿ í° ê¸°ë¡
    // ğŸ·ï¸ ì¹­í˜¸ ì €ì¥
    titlesOwned: titlesOwned,
    equippedTitle: equippedTitle,
    plagueRatHuntCount: Number(plagueRatHuntCount || 0),
    bully10Count: Number(bully10Count || 0),
    challenger10Count: Number(challenger10Count || 0),
    brawl500Count: Number(brawl500Count || 0),
    warGodWin: Boolean(warGodWin || false),
    superSuccessCount: Number(superSuccessCount || 0),
    downStreak: Number(downStreak || 0),
    dopamineTried: Number(dopamineTried || 0),
    gamblerRunActive: gamblerRunActive,
    gamblerRunNoScroll: gamblerRunNoScroll,
    fireworksDestroyed: fireworksDestroyed,
    reach30Count: reach30Count,
    weapon30Counts: weapon30Counts,
    hofDeadline: Number(hofDeadline || 0),
    hofAchievedAt: Number(hofAchievedAt || 0),
    hofWeaponTypeAt30: hofWeaponTypeAt30 || "",
    hofProcessedAt: Number(hofProcessedAt || 0),
    lastSeenGlobal30EventId: Number(lastSeenGlobal30EventId || 0),
aweUsedGlobal30EventId: Number(aweUsedGlobal30EventId || 0)
  };

  // â­ ê°•í™” ìˆ˜ì¹˜ê°€ ë°”ë€Œì—ˆì„ ë•Œë§Œ updated ê°±ì‹ 
  if (sword !== lastSavedSwordForUpdated) {
    updateData.updated = Date.now();
    lastSavedSwordForUpdated = sword;
  }

  userRef.update(updateData);
}

/* ìƒ‰ìƒ */
function getSwordColor(l){
  if (l >= 30) return "rainbow";
  if (l === 29) return "sparkle-gold";
  if (l === 28) return "sparkle-silver";

  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) return colorMap[l] || "white";
  if (l >= 11) return "lime";
  return "white";
}

function coloredLevel(l){
  // ğŸŒˆ 30ê°•
  if (l >= 30) {
    return `<span class="rainbow">+${l}ê°•</span>`;
  }

  // âœ¨ 29 / 28 ë°˜ì§
  if (l === 29) {
    return `<span class="sparkle-gold">+${l}ê°•</span>`;
  }
  if (l === 28) {
    return `<span class="sparkle-silver">+${l}ê°•</span>`;
  }

  // ğŸ¨ 21~27 ê°œë³„ ìƒ‰ìƒ
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) {
    return `<span style="color:${colorMap[l]};font-weight:bold;">+${l}ê°•</span>`;
  }

  // ğŸ‘‰ 11~20ì€ ìƒ‰ ì—†ìŒ (ê¸°ë³¸ í°ìƒ‰)
  return `+${l}ê°•`;
}

  // âš”ï¸ ê°•í™” ë‹¨ê³„ë³„ ì»¬ëŸ¬ ì´ë¦„ (ë­í‚¹ í‘œì‹œìš©)
function getSwordColorName(level) {
  const colorNameMap = {
    21: "ë¹¨ê°•",
    22: "ë…¸ë‘",
    23: "ì´ˆë¡",
    24: "íŒŒë‘",
    25: "ë³´ë¼",
    26: "ê°ˆìƒ‰",
    27: "í•‘í¬",
    28: "ì‹¤ë²„",
    29: "ê³¨ë“œ",
    30: "ë¬´ì§€ê°œ"
  };
  return colorNameMap[level] || "";
}

// âš”ï¸ ê²€ ì´ë¦„ì— ìƒ‰ ì…íˆê¸° (ë­í‚¹ìš©)
function coloredWeaponName(level, baseName) {
  // 20ê°• ì´í•˜ëŠ” ìƒ‰ ì•ˆ ë„£ê³  ê·¸ëƒ¥ ì´ë¦„ë§Œ
  if (level <= 20) return baseName;

  // 30, 29, 28ê°•ì€ ì´ë¯¸ ë§Œë“  í´ë˜ìŠ¤ í™œìš©
  if (level >= 30) {
    return `<span class="rainbow">${baseName}</span>`;
  }
  if (level === 29) {
    return `<span class="sparkle-gold">${baseName}</span>`;
  }
  if (level === 28) {
    return `<span class="sparkle-silver">${baseName}</span>`;
  }

  // 21~27ê°•ì€ coloredLevelì—ì„œ ì“°ëŠ” ìƒ‰ì´ë‘ ë§ì¶”ê¸°
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  const cssColor = colorMap[level] || "#ffffff";
  return `<span style="color:${cssColor};font-weight:bold;">${baseName}</span>`;
}


// ğŸ—º MAP í† ê¸€
function toggleMap() {
  const panel = document.getElementById("mapPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderMap();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

// ğŸ—º MAP ë‚´ìš© ë Œë”ë§
function renderMap() {
  const listEl = document.getElementById("mapList");
  if (!listEl) return;

  listEl.innerHTML = "";

  for (let i = 1; i <= 10; i++) {
    const field = HUNT_FIELDS[i];
    const success = getHuntSuccessChance(sword, i);

    const div = document.createElement("div");
    div.className = "map-field";
    div.innerHTML = `
      <b>LV${i} - ${field.name}</b><br>
      ì¶”ì²œ: +${field.recLevel}ê°• / í˜„ì¬ ì˜ˆìƒ ì„±ê³µë¥ : ${success}%
    `;
    div.onclick = function() {

      // ì´ë¯¸ ì´ë™ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (isMoving) return;

      isMoving = true;

      // "ì‚¬ëƒ¥í„° ì´ë™ ì¤‘..." íŒì—… í‘œì‹œ
      showMovePopup();

      const delay = 1000 + Math.random() * 1000; // 1~2ì´ˆ ëœë¤

      setTimeout(() => {
        // ì‹¤ì œ ì‚¬ëƒ¥í„° ë³€ê²½
        currentField = i;

        applyFieldBackground();
        
        // UI ê°±ì‹  + ì €ì¥
        update();
        save();

        // ë§µ íŒ¨ë„ ë‹«ê¸° + ì´ë™ íŒì—… ë‹«ê¸°
        toggleMap();
        closeMovePopup();

        isMoving = false;
      }, delay);
    };


    // í˜„ì¬ ì„ íƒ ì‚¬ëƒ¥í„° í‘œì‹œ
    if (i === currentField) {
      div.style.borderLeft = "3px solid #6cf";
    }

    listEl.appendChild(div);
  }
}

// ğŸ§± íŒ¨ë„ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (MAP / ì¸ë²¤í† ë¦¬ / ë¡œê·¸ ê³µí†µ)
function closeIfClickOutside(event, panelId, buttonId) {
  const panel = document.getElementById(panelId);
  const btn   = document.getElementById(buttonId);
  if (!panel) return;

  // ì•ˆ ì—´ë ¤ ìˆìœ¼ë©´ ë¬´ì‹œ
  if (panel.style.display === "none" || panel.style.display === "") return;

  const target = event.target;

  // íŒ¨ë„ ì•ˆì„ í´ë¦­í•œ ê²½ìš° â†’ ìœ ì§€
  if (panel.contains(target)) return;

  // í•´ë‹¹ íŒ¨ë„ì˜ í† ê¸€ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° â†’ í† ê¸€ ë¡œì§ì— ë§¡ê¹€
  if (btn && btn.contains(target)) return;

  // ê·¸ ì™¸ ì˜ì—­ í´ë¦­ ì‹œ íŒ¨ë„ ë‹«ê¸°
  panel.style.display = "none";
}

// ğŸ“Œ ì „ì—­ í´ë¦­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener("mousedown", function (e) {
  closeIfClickOutside(e, "mapPanel", "mapBtn");             // MAP
  closeIfClickOutside(e, "inventoryPanel", "inventoryBtn"); // ì¸ë²¤í† ë¦¬
  closeIfClickOutside(e, "logPanel", "logToggle");          // ë¡œê·¸
  closeIfClickOutside(e, "duelPanel", "duelBtn");           // ê²°íˆ¬
});

// ğŸ§· ìƒˆë¡œê³ ì¹¨ ì‹œ ìë™ ë¡œê·¸ì¸
function autoLoginFromStorage() {
    
      // âœ… ìë™ë¡œê·¸ì¸ ì‹œë„ ì‹œì‘ ì „, ì´ì „ ê³„ì • ì”ìƒ ë°©ì§€
  titlesOwned = {};
  equippedTitle = "";
  closeTitleOverlay();
weaponType   = null;
maxSwordLevel = 0;
destroyCount  = 0;

  let savedId = null;
  try {
    savedId = localStorage.getItem("swordGameLastUser");
  } catch (e) {
    console.warn("localStorage get ì‹¤íŒ¨", e);
  }

  if (!savedId) return;  // ì €ì¥ëœ ìœ ì € ì—†ìœ¼ë©´ íŒ¨ìŠ¤

  userId = savedId;
  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {
    if (!s.exists()) {
      // í˜¹ì‹œ DBì—ì„œ ì‚¬ë¼ì§„ ê³„ì •ì´ë©´ ê¸°ë¡ë„ ì§€ì›€
      try { localStorage.removeItem("swordGameLastUser"); } catch (e) {}
      return;
    }

    const data = s.val();

        // ğŸ” ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ë¡œê·¸ì¸ ì¤‘ì´ë©´ ìë™ë¡œê·¸ì¸ë„ ë§‰ê¸°
     if (data.sessionId) {
      console.log("[autoLogin] ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì† ì¤‘, ìë™ë¡œê·¸ì¸ ì·¨ì†Œ");

      // âœ… ìë™ë¡œê·¸ì¸ ì·¨ì†Œ ì‹œ, ê³„ì • ìƒíƒœë¥¼ ë‚¨ê¸°ì§€ ì•Šê¸°
      userId = "";
      userRef = null;
      titlesOwned = {};
      equippedTitle = "";
      closeTitleOverlay();

      return;
    }

    sword = data.sword ?? 0;
    gold  = data.gold  ?? 100;

titlesOwned = (data.titlesOwned && typeof data.titlesOwned === "object") ? data.titlesOwned : {};
equippedTitle = (typeof data.equippedTitle === "string") ? data.equippedTitle : "";
    // ğŸ§¹ ê³¼ê±° ë²„ê·¸ ê°’ ì •ë¦¬: "${titleId}" ê°™ì€ ì“°ë ˆê¸° ê°’ì´ë©´ ì¥ì°© í•´ì œ
if (equippedTitle && equippedTitle.includes("${")) equippedTitle = "";

    plagueRatHuntCount = Number(data.plagueRatHuntCount || 0);
    gamblerRunActive = !!data.gamblerRunActive;
    gamblerRunNoScroll = (data.gamblerRunNoScroll !== false); // ê¸°ë³¸ true
    fireworksDestroyed = data.fireworksDestroyed || { 21:false, 22:false, 23:false, 24:false, 25:false };
    reach30Count = Number(data.reach30Count || 0);
    weapon30Counts = data.weapon30Counts || {};
    hofDeadline = Number(data.hofDeadline || 0);
    hofAchievedAt = Number(data.hofAchievedAt || 0);
    hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
    hofProcessedAt = Number(data.hofProcessedAt || 0);
    superSuccessCount = Number(data.superSuccessCount || 0);
    downStreak        = Number(data.downStreak || 0);
    dopamineTried     = Number(data.dopamineTried || 0);
    lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
    aweUsedGlobal30EventId  = Number(data.aweUsedGlobal30EventId || 0);

    // ğŸ—¡ ë¬´ê¸° íƒ€ì… ë¡œë“œ (v3.8 ì´ì „ ê³„ì • í˜¸í™˜ í¬í•¨)
  if (data.weaponType !== undefined && data.weaponType !== null) {
    // v3.8 ì´í›„ ì €ì¥ëœ ê³„ì • â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    weaponType = data.weaponType;   // "sword" ë˜ëŠ” "spear"
  } else {
    // êµ¬ë²„ì „ ê³„ì • (weaponType í•„ë“œê°€ ì—†ë˜ ì‹œì ˆ)
    if (sword > 0) {
      // ì´ë¯¸ 1ê°• ì´ìƒ ë¬´ê¸°ë¥¼ ê°€ì§„ ìœ ì €ëŠ” 'ê²€' ë£¨íŠ¸ë¡œ íŒì •
      weaponType = "sword";
    } else {
      // 0ê°•ì´ë©´ ì•„ì§ ë¬´ê¸° ë¯¸ì • â†’ ë‹¤ìŒì— 1/15/21ê°• ì°ì„ ë•Œ ëœë¤ ë°°ì •
      weaponType = null;
    }
  }
    
    // â­ ìë™ë¡œê·¸ì¸ ì‹œì—ë„ ì´ˆê¸°í™”
    lastSavedSwordForUpdated = sword;

        // ìµœê³  ê°•í™” / íŒŒê´´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    maxSwordLevel = data.maxSwordLevel ?? sword;
    destroyCount  = data.destroyCount  ?? 0;

    // ğŸŸ¢ ìë™ë¡œê·¸ì¸ ì‹œ ì „íˆ¬ë ¥ ë³´ì • í¬í•¨
power = Number(data.power ?? 0);

if (!power || power <= 20) {
  rollPowerForCurrentSword();
}

    attendanceCount    = data.attendanceCount    ?? 0;
    lastAttendanceDate = data.lastAttendanceDate ?? "";
    attendanceStreak   = data.attendanceStreak   ?? 0;   
    lastAttendanceDay  = data.lastAttendanceDay  ?? "";  
    currentField       = data.currentField       ?? 1;
    huntCountToday     = data.huntCountToday     ?? 0;
    lastHuntDate       = data.lastHuntDate       ?? "";
    itemScroll15       = data.itemScroll15 ?? 0;
    itemProtect        = data.itemProtect  ?? 0;
    itemSuper          = data.itemSuper    ?? 0;
    itemDownProtect    = data.itemDownProtect ?? 0;
    itemScroll21    = Number(data.itemScroll21    ?? 0); 
    itemRateUp5     = Number(data.itemRateUp5     ?? 0);
    huntStamina       = data.huntStamina       ?? 20;
    lastStaminaUpdate = data.lastStaminaUpdate ?? Date.now();
        // âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
    duelWin        = data.duelWin        ?? 0;
    duelLose       = data.duelLose       ?? 0;
    duelCountToday = data.duelCountToday ?? 0;
    lastDuelDate   = data.lastDuelDate   ?? "";
    duelTargetsToday = data.duelTargetsToday ?? {};
    bully10Count      = Number(data.bully10Count || 0);
    challenger10Count = Number(data.challenger10Count || 0);
    brawl500Count     = Number(data.brawl500Count || 0);
    warGodWin         = Boolean(data.warGodWin || false);
    itemHonorMedal = data.itemHonorMedal ?? 0;
    starShard = data.starShard ?? 0;
    couponUsedMap = data.couponUsed || {};
    // âœ… ëª…ì˜ˆì˜ì „ë‹¹(30ê°•) / ê¸€ë¡œë²Œ 30ê°• ì´ë²¤íŠ¸ ìƒíƒœ ë¡œë“œ
    hofDeadline = Number(data.hofDeadline || 0);
    hofAchievedAt = Number(data.hofAchievedAt || 0);
    hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
    hofProcessedAt = Number(data.hofProcessedAt || 0);

    lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
    aweUsedGlobal30EventId = Number(data.aweUsedGlobal30EventId || 0);

    reach30Count = Number(data.reach30Count || 0);

    duelPoint      = data.duelPoint      ?? 0;
    duelPointWeekKey = data.duelPointWeekKey || "";
    duelLastWeekPoint = data.duelLastWeekPoint ?? 0;
    duelLastWeekRank  = data.duelLastWeekRank ?? 0;
    duelLastWeekRewardClaimed = data.duelLastWeekRewardClaimed ?? false;
    duelUpdated         = data.duelUpdated ?? 0;
    duelLastWeekUpdated = data.duelLastWeekUpdated ?? 0;

    // ğŸŸ¢ ì£¼ì°¨ ì •ë¦¬ (ì§€ë‚œì£¼ í¬ì¸íŠ¸ ìŠ¤ëƒ…ìƒ· + ì´ë²ˆ ì£¼ ì´ˆê¸°í™”)
    ensureDuelWeek();
    // ğŸ† ì§€ë‚œì£¼ ë³´ìƒ ì²´í¬ & ì§€ê¸‰
    checkWeeklyDuelReward();
    
// í™”ë©´ ì „í™˜
const loginScreen = document.getElementById("loginScreen");
const gameScreen  = document.getElementById("gameScreen");

loginScreen.style.display  = "none";
gameScreen.style.display   = "block";
document.getElementById("attendanceBtn").style.display = "block";
document.getElementById("inventoryBtn").style.display = "block";
document.getElementById("logToggle").style.display = "block";
document.getElementById("logoutBtn").style.display = "block";
document.getElementById("duelBtn").style.display = "block";
document.getElementById("scrollShopBtn").style.display = "block";
document.getElementById("mapBtn").style.display = "block";
document.getElementById("couponBtn").style.display = "block";
document.getElementById("userListBtn").style.display = "block";
 document.getElementById("achievementBtn").style.display = "block";

        // âœ… ì—¬ê¸°ì—ì„œ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì‹œì‘
    startAutoRefreshTimer();

        // ğŸŒ 25ê°• ì´ìƒ íŒŒê´´ ê¸€ë¡œë²Œ ì•Œë¦¼ êµ¬ë… ì‹œì‘
    subscribeGlobalDestroyEvents();
    subscribeGlobal30Events();

    // ğŸ” ìë™ë¡œê·¸ì¸ìœ¼ë¡œ ë“¤ì–´ì˜¨ ê²½ìš°ì—ë„ ì´ íƒ­ì´ ì„¸ì…˜ì„ ê°€ì ¸ê°€ë„ë¡
    startSession();

// ğŸ·ï¸ ì¹­í˜¸ ìë™ ì§€ê¸‰(ìë™ë¡œê·¸ì¸ ë¡œë“œ ì§í›„)
const titleChanged = checkAndGrantTitles();
if (titleChanged) save();
    
    update();
    showTutorialIfFirstTime();
    loadUpdateNotices();
    loadHallOfFame();
startHonorHallTimers();
updateHonorHallButton();
    ensureDuelWeek();
  });
}

// ğŸ§¾ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ì—´ê¸°
function openOtherUserProfilePopup(targetId) {
  const overlay        = document.getElementById("otherProfileOverlay");
  if (!overlay) return;

  const nickEl         = document.getElementById("otherProfileNickname");
  const weaponTitleEl  = document.getElementById("otherProfileWeaponTitle");
  const weaponDescEl   = document.getElementById("otherProfileWeaponDesc");
  const maxInfoEl      = document.getElementById("otherProfileMaxInfo");
  const powerEl        = document.getElementById("otherProfilePower");
  const goldEl         = document.getElementById("otherProfileGold");
  const weaponValueEl  = document.getElementById("otherProfileWeaponValue");
  const recordEl       = document.getElementById("otherProfileRecord");
  const imgEl          = document.getElementById("otherWeaponImage");

  // ê¸°ë³¸ ì´ˆê¸°í™”
  if (nickEl)        nickEl.textContent        = targetId;
  if (weaponTitleEl) weaponTitleEl.textContent = "-";
  if (weaponDescEl)  weaponDescEl.textContent  = "-";
  if (maxInfoEl)     maxInfoEl.textContent     = "-";
  if (powerEl)       powerEl.textContent       = "0";
  if (goldEl)        goldEl.textContent        = "0";
  if (weaponValueEl) weaponValueEl.textContent = "0";
  if (recordEl)      recordEl.textContent      = "ìŠ¹ 0 / íŒ¨ 0";
  if (imgEl)         imgEl.src                 = "images/weapons/sword_real_temp.png";

  // DBì—ì„œ í•´ë‹¹ ìœ ì € ì •ë³´ ì½ê¸°
  db.ref("users/" + targetId).once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const d = snap.val() || {};
    if (nickEl) nickEl.innerHTML = formatNicknameWithTitle(targetId, d.equippedTitle || "", d.reach30Count);

    const swordLevel = Number(d.sword || 0);
    const weaponTypeOther = d.weaponType || "sword";
    const maxSword   = Number(d.maxSwordLevel ?? swordLevel);
    const destroyCnt = Number(d.destroyCount || 0);
    const powerVal   = Number(d.power || 0);
    const goldVal    = Number(d.gold || 0);
    const duelW      = Number(d.duelWin || 0);
    const duelL      = Number(d.duelLose || 0);

    const wInfo = getWeaponInfo(swordLevel, weaponTypeOther);

    if (weaponTitleEl && wInfo) {
      weaponTitleEl.textContent = `${wInfo.name} (+${swordLevel}ê°•)`;
    }
    if (weaponDescEl && wInfo) {
      weaponDescEl.textContent = wInfo.desc;
    }
    if (maxInfoEl) {
      maxInfoEl.innerHTML =
        `+${maxSword}ê°• ` +
        `<span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ ${destroyCnt}íšŒ)</span>`;
    }
    if (powerEl) {
      powerEl.textContent = formatGold(powerVal);
    }
    if (goldEl) {
      goldEl.textContent  = formatGold(goldVal);
    }
    if (weaponValueEl) {
      const avgValue = getSellRewardAverage(swordLevel);
      weaponValueEl.textContent = formatGold(avgValue);
    }
    if (recordEl) {
      recordEl.textContent = `ìŠ¹ ${duelW} / íŒ¨ ${duelL}`;
    }
    if (imgEl && wInfo && wInfo.img) {
      imgEl.src = wInfo.img;
    }

    overlay.style.display = "flex";
  }).catch(err => {
    console.error("í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    alert("í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  });
}

// ğŸŒˆ ëª…ì˜ˆì˜ ì „ë‹¹ ì „ìš©: ë‹¬ì„± ë‹¹ì‹œ(+30) ë¬´ê¸° ì´ë¯¸ì§€ë¡œ í”„ë¡œí•„ ë³´ê¸°
function openHallOfFameProfilePopup(targetId, weaponTypeAt30, achievedAt) {
  const overlay        = document.getElementById("otherProfileOverlay");
  if (!overlay) return;

  const nickEl         = document.getElementById("otherProfileNickname");
  const weaponTitleEl  = document.getElementById("otherProfileWeaponTitle");
  const weaponDescEl   = document.getElementById("otherProfileWeaponDesc");
  const maxInfoEl      = document.getElementById("otherProfileMaxInfo");
  const powerEl        = document.getElementById("otherProfilePower");
  const goldEl         = document.getElementById("otherProfileGold");
  const weaponValueEl  = document.getElementById("otherProfileWeaponValue");
  const recordEl       = document.getElementById("otherProfileRecord");
  const imgEl          = document.getElementById("otherWeaponImage");

  // ê¸°ë³¸ ì´ˆê¸°í™”
  if (nickEl)        nickEl.textContent        = targetId;
  if (weaponTitleEl) weaponTitleEl.textContent = "-";
  if (weaponDescEl)  weaponDescEl.textContent  = "-";
  if (maxInfoEl)     maxInfoEl.textContent     = "-";
  if (powerEl)       powerEl.textContent       = "0";
  if (goldEl)        goldEl.textContent        = "0";
  if (weaponValueEl) weaponValueEl.textContent = "0";
  if (recordEl)      recordEl.textContent      = "ìŠ¹ 0 / íŒ¨ 0";
  if (imgEl)         imgEl.src                 = "images/weapons/sword_real_temp.png";

  db.ref("users/" + targetId).once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const d = snap.val() || {};
    if (nickEl) nickEl.innerHTML = formatNicknameWithTitle(targetId, d.equippedTitle || "", d.reach30Count);

    // âœ… ì „ë‹¹ì€ ë¬´ì¡°ê±´ â€œë‹¬ì„± ë‹¹ì‹œ +30â€ë¡œ í‘œì‹œ
    const swordLevel = 30;
    const wt = weaponTypeAt30 || d.hofWeaponTypeAt30 || d.weaponType || "sword";
    const wInfo = getWeaponInfo(swordLevel, wt);

    const powerVal   = Number(d.power || 0);
    const goldVal    = Number(d.gold || 0);
    const duelW      = Number(d.duelWin || 0);
    const duelL      = Number(d.duelLose || 0);

    if (weaponTitleEl && wInfo) weaponTitleEl.textContent = `${wInfo.name} (+${swordLevel}ê°•)`;
    if (weaponDescEl && wInfo)  weaponDescEl.textContent  = wInfo.desc;

    // ì „ë‹¹ ê¸°ë¡ ì •ë³´ í‘œì‹œ(ë‹¬ì„± ì‹œê°)
    if (maxInfoEl) {
      const dt = achievedAt ? new Date(Number(achievedAt)).toLocaleString("ko-KR") : "-";
      maxInfoEl.innerHTML = `<span style="color:#ffd54f;">ëª…ì˜ˆì˜ ì „ë‹¹ ê¸°ë¡</span> <span style="font-size:12px; color:#bbbbbb;">(${dt})</span>`;
    }

    if (powerEl) powerEl.textContent = formatGold(powerVal);
    if (goldEl)  goldEl.textContent  = formatGold(goldVal);

    if (weaponValueEl) {
      const avgValue = getSellRewardAverage(swordLevel);
      weaponValueEl.textContent = formatGold(avgValue);
    }

    if (recordEl) recordEl.textContent = `ìŠ¹ ${duelW} / íŒ¨ ${duelL}`;

    if (imgEl && wInfo && wInfo.img) imgEl.src = wInfo.img;

    overlay.style.display = "flex";
  }).catch(err => {
    console.error("ì „ë‹¹ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    alert("í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  });
}
  
// ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ë‹«ê¸° (í†µí•©)
function closeOtherUserProfilePopup() {
  const overlay = document.getElementById("otherProfileOverlay");
  if (overlay) {
    overlay.style.display = "none";
  }
}

// ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… / ê³µì§€ ESC ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", function () {
  const overlay  = document.getElementById("otherProfileOverlay");
  const closeBtn = document.getElementById("otherProfileCloseBtn");

  // 1) ì–´ë‘ìš´ ë°°ê²½ í´ë¦­ â†’ ì¹´ë“œ ë°”ê¹¥ í´ë¦­ì¼ ë•Œë§Œ ë‹«ê¸°
  if (overlay) {
    overlay.addEventListener("click", function (e) {
      if (!e.target.closest(".other-profile-card")) {
        closeOtherUserProfilePopup();
      }
    });
  }

  // 2) X ë²„íŠ¼ í´ë¦­ â†’ ë‹«ê¸°
  if (closeBtn) {
    closeBtn.addEventListener("click", function (e) {
      e.stopPropagation(); // ë°°ê²½ìœ¼ë¡œ í´ë¦­ ì „íŒŒ ë§‰ê¸°
      closeOtherUserProfilePopup();
    });
  }

  // 3) ESC í‚¤ â†’ í”„ë¡œí•„ / ê³µì§€ ëª¨ë‘ ì²˜ë¦¬
  document.addEventListener("keydown", function (e) {
    if (e.key !== "Escape") return;

    // (1) í”„ë¡œí•„ íŒì—… ë‹«ê¸°
    closeOtherUserProfilePopup();

    // (2) ê³µì§€ íŒì—… ë‹«ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const noticePopup   = document.getElementById("noticePopup");
    const noticeOverlay = document.getElementById("noticeOverlay");

    if (noticePopup && noticePopup.style.display !== "none") {
      if (typeof closeNoticePopup === "function") {
        closeNoticePopup();
      } else {
        noticePopup.style.display = "none";
        if (noticeOverlay) noticeOverlay.style.display = "none";
      }
    }
  });
});

  // ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ â†’ "í”„ë¡œí•„ ë³´ê¸°" ë©”ë‰´ â†’ í”„ë¡œí•„ íŒì—…
let lastRankProfileUserId = null;

(function initRankingProfileMenu() {
  const rankingEl = document.getElementById("ranking");
  const menuEl    = document.getElementById("rankProfileMenu");
  const viewBtn   = document.getElementById("rankProfileViewBtn");
  const overlay   = document.getElementById("otherProfileOverlay");
  const closeBtn  = document.getElementById("otherProfileCloseBtn");

  // 1) ë­í‚¹ ì˜ì—­ì—ì„œ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ì‘ì€ ë©”ë‰´ë¥¼ "í„°ì¹˜í•œ ìë¦¬"ì— í‘œì‹œ
  if (rankingEl && menuEl) {
    rankingEl.addEventListener("click", function(e) {
      const userSpan = e.target.closest(".rank-user");
      if (!userSpan) return;

      const uid = userSpan.dataset.userId;
      if (!uid) return;
      lastRankProfileUserId = uid;

      const x = e.pageX;
      const y = e.pageY;

      menuEl.style.left   = x + "px";
      menuEl.style.top    = y + "px";
      menuEl.style.display = "block";

      e.stopPropagation();
    });
  }

  // 2) "í”„ë¡œí•„ ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°
  if (viewBtn && menuEl) {
    viewBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      if (!lastRankProfileUserId) return;
      menuEl.style.display = "none";
      openOtherUserProfilePopup(lastRankProfileUserId);
    });
  }

  // 3) í™”ë©´ ë‹¤ë¥¸ ê³³ í´ë¦­í•˜ë©´ ì‘ì€ ë©”ë‰´ ë‹«ê¸°
  document.addEventListener("click", function(e) {
    if (!menuEl || menuEl.style.display !== "block") return;

    // ë©”ë‰´ ë‚´ë¶€ or ë‹‰ë„¤ì„ ë‹¤ì‹œ í´ë¦­ì´ë©´ ìœ ì§€
    if (e.target.closest("#rankProfileMenu")) return;
    if (e.target.closest(".rank-user")) return;

    menuEl.style.display = "none";
  });

  // 4) íŒì—… ë°”ê¹¥(ì–´ë‘ìš´ ë°°ê²½) í´ë¦­í•˜ë©´ ë‹«ê¸°
  if (overlay) {
    overlay.addEventListener("click", function(e) {
      if (e.target === overlay) {
        closeOtherUserProfilePopup();
      }
    });
  }

  // 5) ë‹«ê¸° ë²„íŠ¼
  if (closeBtn) {
    closeBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      closeOtherUserProfilePopup();
    });
  }
})();
  
/* ë­í‚¹ */
function loadRanking() {

  const usersRef = db.ref("users");

  // ğŸ” TOP 10 (once)
  usersRef
    .orderByChild("sword")
    .limitToLast(10)
    .on("value", s => {
      const rankingEl = document.getElementById("ranking");
      if (!rankingEl) return;

      const arr = [];
      s.forEach(child => {
        const d = child.val() || {};
        arr.push({
          id: child.key,
          sword: Number(d.sword || 0),
          updated: Number(d.updated || 0),
          duelWin: Number(d.duelWin || 0),
          duelLose: Number(d.duelLose || 0),
          weaponType: d.weaponType || "sword",
          equippedTitle: d.equippedTitle || "",
          reach30Count: Number(d.reach30Count || 0)
        });
      });

      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

rankingEl.innerHTML = arr.map((u, i) => {
  const wInfo = getWeaponInfo(u.sword, u.weaponType || "sword");
  const weaponNameStyled = coloredWeaponName(u.sword, wInfo.name);

  return `
    <div class="ranking-row" style="font-weight:bold;">
      ${i+1}. <span class="rank-user" data-user-id="${u.id}">${formatNicknameWithTitle(u.id, u.equippedTitle, u.reach30Count)
}</span>
      | ${weaponNameStyled} ${coloredLevel(u.sword)}
      | ì „ì : ${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨
    </div>
  `;
}).join("");

    });

  // ğŸ‘‡ ë‚´ ë­í‚¹ + ê²°íˆ¬ ë§¤ì¹­ ìºì‹œ (on)
  usersRef
    .orderByChild("sword")
    .on("value", s => {
      const myRankEl = document.getElementById("myRank");
      if (!myRankEl) return;

      const arr = [];
      s.forEach(c => {
        const d = c.val() || {};
        arr.push({
          id: c.key,
          sword: Number(d.sword || 0),
          updated: Number(d.updated || 0),
          power: Number(d.power || 0),
          weaponType: d.weaponType || "sword",
          equippedTitle: d.equippedTitle || "",
          reach30Count: Number(d.reach30Count || 0)
        });
      });

      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

      // âš”ï¸ ê²°íˆ¬ìš© ìºì‹œ
      allUsersCache = arr.slice();
      refreshUserListOverlayIfOpen();

      if (!userId) {
        myRankEl.innerText = "";
        return;
      }

      const idx = arr.findIndex(u => u.id === userId);

      if (idx === -1) {
        myRankEl.innerText = "ë‚´ ë­í‚¹: ê¸°ë¡ ì—†ìŒ";
      } else {
        const myInfo = arr[idx];
        myRankEl.innerHTML = `
          ë‚´ ë­í‚¹: <b>${idx + 1}ìœ„</b>
          (${coloredLevel(myInfo.sword)}, ì „ì : ${duelWin}ìŠ¹ ${duelLose}íŒ¨)
        `;
      }
    });
}
  
// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ "YYYY-MM-DD" í˜•íƒœë¡œ ë°˜í™˜ (ì¶œì„ ì²´í¬ìš©)
function getTodayDateString() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

  // ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ë Œë”ë§
function renderUserList(list) {
  const body = document.getElementById("userListBody");
  const countEl = document.getElementById("userListCount");
  const searchInput = document.getElementById("userListSearch");
  if (!body || !countEl) return;

  if (!list || list.length === 0) {
    body.innerHTML = `
      <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
        ë“±ë¡ëœ ëª¨í—˜ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    `;
    countEl.textContent = "ì´ 0ëª…";
    return;
  }

  const total = list.length;
  const keyword = (searchInput?.value || "").trim();

  if (!keyword) {
    countEl.textContent = `ì´ ${total}ëª… (ê°•í™” ìˆœ ì „ì²´)`;
  } else {
    countEl.textContent = `ì´ ${total}ëª… ì¤‘ ê²€ìƒ‰ ê²°ê³¼`;
  }

const rows = list.map((u, idx) => {
  const powerText = (u.power != null)
    ? Number(u.power).toLocaleString("ko-KR")
    : "-";

  return `
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #333; font-size:12px;">
      <div>
        <span style="font-weight:bold;">${idx + 1}ìœ„</span>

        <!-- ğŸ‘‡ í•˜ì–€ ê¸€ì, ë°‘ì¤„ ì—†ìŒ, í´ë¦­ ê°€ëŠ¥ -->
        <span
          class="userListName"
          onclick="openUserProfileFromUserList('${u.id}')"
          >
           ${formatNicknameWithTitle(u.id, u.equippedTitle, u.reach30Count)}
        </span>
      </div>

      <div style="text-align:right;">
        <div>+${u.sword}ê°•</div>
        <div style="font-size:11px; color:#ccc;">
          ì „íˆ¬ë ¥ ${powerText}
        </div>
      </div>
    </div>
  `;
});

  body.innerHTML = rows.join("");
}

  // ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ì—ì„œ í”„ë¡œí•„ ì¹´ë“œ ì—´ê¸°
function openUserProfileFromUserList(userId) {

  // 2) ê¸°ì¡´ì— ìˆë˜ í”„ë¡œí•„ íŒì—… í•¨ìˆ˜ í˜¸ì¶œ
  //    (ë­í‚¹ì—ì„œ ì“°ëŠ” ê·¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©)
  if (typeof openOtherUserProfilePopup === "function") {
    openOtherUserProfilePopup(userId);
  } else {
    // í˜¹ì‹œë¼ë„ í•¨ìˆ˜ ëª» ì°¾ì„ ë•Œ ëŒ€ë¹„
    alert("í”„ë¡œí•„ íŒì—… í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
}

  // ğŸ” ì „ì²´ ìœ ì € ëª©ë¡ ê²€ìƒ‰ ì ìš©
function applyUserListSearch() {
  const searchInput = document.getElementById("userListSearch");
  if (!searchInput) return;

  const q = searchInput.value.trim().toLowerCase();
  let filtered = allUsersCache.slice();

  if (q) {
    filtered = filtered.filter(u =>
      String(u.id || "").toLowerCase().includes(q)
    );
  }

  renderUserList(filtered);
}

// ğŸ†• allUsersCache ê°±ì‹ ë  ë•Œ, ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ ìˆìœ¼ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
function refreshUserListOverlayIfOpen() {
  const overlay = document.getElementById("userListOverlay");
  if (!overlay || overlay.style.display === "none") return;

  applyUserListSearch();  // ê²€ìƒ‰ì–´ ìœ ì§€í•œ ì±„ë¡œ ê°±ì‹ 
}

  // ğŸ‡°ğŸ‡· í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ ë‚ ì§œ/ì‹œê°„ ì–»ê¸°
function getKstNow() {
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  // KST = UTC+9
  return new Date(utc + 9 * 60 * 60000);
}

// ğŸ—“ í•œêµ­ ì‹œê°„ ê¸°ì¤€ "ì´ë²ˆ ì£¼ í‚¤" (ì›”ìš”ì¼ ë‚ ì§œ ê¸°ì¤€)
function getKstWeekKey() {
  const now = getKstNow();
  const day = now.getDay(); // 0=ì¼, 1=ì›” ... 6=í† 

  // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ë‚ ì§œë¡œ ë§ì¶”ê¸°
  const diffToMonday = (day + 6) % 7; // ì›”=0, í™”=1 ... ì¼=6
  const monday = new Date(now.getTime() - diffToMonday * 24 * 60 * 60 * 1000);

  const y = monday.getFullYear();
  const m = String(monday.getMonth() + 1).padStart(2, "0");
  const d = String(monday.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;  // ì˜ˆ: "2026-01-05"
}

// ğŸ† ì§€ë‚œì£¼ ê²°íˆ¬ ë³´ìƒ ì²´í¬ & ì§€ê¸‰
function checkWeeklyDuelReward() {
  if (duelLastWeekRewardClaimed) return;
  if (!duelLastWeekPoint || duelLastWeekPoint <= 0) return;

  // ğŸ†• ì´ë²ˆ ê¸°ì¤€ì—ì„œ "ì§„ì§œ ì§€ë‚œì£¼" ë²”ìœ„ ê³„ì‚°
  const range = getLastWeekRangeKst();
  const startTs = range.start;
  const endTs   = range.end;

  const usersRef = db.ref("users");
  usersRef
    .orderByChild("duelLastWeekPoint")
    .once("value")
    .then((snap) => {
      const arr = [];
      snap.forEach((child) => {
        const val = child.val() || {};
        const uid = child.key;
        const p   = Number(val.duelLastWeekPoint || 0);
        const t   = Number(val.duelLastWeekUpdated || 0);

        // ğŸ” 1) í¬ì¸íŠ¸ 0 ì´í•˜ëŠ” ì œì™¸
        if (p <= 0) return;

        // ğŸ” 2) ì§€ë‚œì£¼ ê¸°ê°„ ë°–(ë„ˆë¬´ ì˜›ë‚  ê¸°ë¡)ì€ ì œì™¸
        if (!t || t < startTs || t >= endTs) return;

        arr.push({
          id: uid,
          point: p,
          updated: t
        });
      });

      if (arr.length === 0) return;

      // ì´í•˜ ì •ë ¬/ë­í¬ ê³„ì‚° ë¡œì§ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
      arr.sort((a, b) => {
        if (b.point !== a.point) return b.point - a.point;
        const aTime = Number(a.updated || 0);
        const bTime = Number(b.updated || 0);
        return aTime - bTime;
      });

      const myIndex = arr.findIndex((u) => u.id === userId);
      if (myIndex === -1) {
        // í˜¹ì‹œë‚˜ ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ê·¸ëƒ¥ í”Œë˜ê·¸ë§Œ ë§‰ì•„ë‘”ë‹¤
        duelLastWeekRewardClaimed = true;
        save();
        return;
      }

      const myRank = myIndex + 1;
      duelLastWeekRank = myRank;

      // ì‹¤ì œ ë³´ìƒ ì§€ê¸‰
      const rewardText = grantWeeklyDuelReward(myRank);
      if (!rewardText) return;

      // ì¹´ë¥´ë‹ˆì•„ íŒì—…
      showNpcMessage(
        `
        <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">
          ì§€ë‚œì£¼ ë„¤ ê²°íˆ¬ì¥ ë­í‚¹ì€ <span style="color:#ffd54f;">${myRank}ìœ„</span>ì˜€ì–´.
        </div>
        <div style="font-size:13px; line-height:1.6;">
          ê·¸ ë…¸ë ¥ì— ëŒ€í•œ ë³´ìƒìœ¼ë¡œ,<br>
          <span style="color:#a5e1ff;">${rewardText}</span>ë¥¼ ì§€ê¸‰í•´ ë‘˜ê²Œ.
        </div>
        `,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
    })
    .catch((err) => {
      console.error("ì£¼ê°„ ê²°íˆ¬ ë³´ìƒ ê³„ì‚° ì‹¤íŒ¨:", err);
    });
}

// ğŸ† ì£¼ê°„ ê²°íˆ¬ ë³´ìƒ ì§€ê¸‰
function grantWeeklyDuelReward(myRank) {
  let rewardText = "";

  if (myRank === 1) {
    // 1ìœ„ - íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ 2ê°œ
    itemProtect += 2;
    rewardText = "íŒŒê´´ ë°©ì§€ ì£¼ë¬¸ì„œ 2ê°œ";
  } else if (myRank === 2 || myRank === 3) {
    // 2ìœ„, 3ìœ„ - íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ 1ê°œ
    itemProtect += 1;
    rewardText = "íŒŒê´´ ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œ";
  } else if (myRank >= 4 && myRank <= 6) {
    // 4~6ìœ„ - ê°•ë“±ë°©ì–´ 5ê°œ + 15ê°• ì£¼ë¬¸ì„œ 3ê°œ
    itemDownProtect += 5;
    itemScroll15 += 3;
    rewardText = "ê°•ë“± ë°©ì–´ ì£¼ë¬¸ì„œ 5ê°œ, 15ê°• ê°•í™” ì£¼ë¬¸ì„œ 3ê°œ";
  } else if (myRank >= 7 && myRank <= 10) {
    // 7~10ìœ„ - ê°•ë“±ë°©ì–´ 3ê°œ + 15ê°• ì£¼ë¬¸ì„œ 1ê°œ
    itemDownProtect += 3;
    itemScroll15 += 1;
    rewardText = "ê°•ë“± ë°©ì–´ ì£¼ë¬¸ì„œ 3ê°œ, 15ê°• ê°•í™” ì£¼ë¬¸ì„œ 1ê°œ";
  } else {
    // 10ìœ„ ì´í•˜(í¬ì¸íŠ¸ëŠ” ìˆëŠ” ì‚¬ëŒ) - ê°•ë“±ë°©ì–´ 1ê°œ
    itemDownProtect += 1;
    rewardText = "ê°•ë“± ë°©ì–´ ì£¼ë¬¸ì„œ 1ê°œ";
  }

  // âœ… ì´ë²ˆ ì£¼ ë³´ìƒ ìˆ˜ë ¹ í”Œë˜ê·¸ ì„¸ìš°ê³  ì €ì¥
  duelLastWeekRewardClaimed = true;
  save();

  return rewardText;
}

// â° ê²°íˆ¬ì¥ ì§‘ê³„ ì‹œê°„ ì—¬ë¶€ (ì›”ìš”ì¼ 00:00 ~ 00:10, KST ê¸°ì¤€)
function isDuelSettlementTimeKST() {
  const now = getKstNow();          // ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜í•œ KSTìš© ì‹œê°„ í•¨ìˆ˜
  const day = now.getDay();         // 0=ì¼, 1=ì›” ... 6=í† 

  // ì›”ìš”ì¼ì´ ì•„ë‹ˆë©´ ì§‘ê³„ ì‹œê°„ ì•„ë‹˜
  if (day !== 1) return false;

  const totalMinutes = now.getHours() * 60 + now.getMinutes();
  // 00:00 ~ 00:09 ë¥¼ ì§‘ê³„ ì‹œê°„ìœ¼ë¡œ ë³¸ë‹¤
  return totalMinutes >= 0 && totalMinutes < 10;
}

// ğŸŒ™ ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì •ë¦¬
function ensureDuelWeek() {
  const weekKey = getKstWeekKey();  // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì£¼ í‚¤
  currentWeekKey = weekKey;

  // ì²˜ìŒ ì ‘ì†í•œ ê²½ìš°: ê·¸ëƒ¥ í˜„ì¬ ì£¼ì°¨ë¡œ ì„¸íŒ…
  if (!duelPointWeekKey) {
    duelPointWeekKey = weekKey;
    return;
  }

  // ì£¼ì°¨ê°€ ë°”ë€Œì—ˆìœ¼ë©´ ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ ë„˜ê¸°ê³  ì´ë²ˆ ì£¼ ì´ˆê¸°í™”
  if (duelPointWeekKey !== weekKey) {
    // ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ + ê°±ì‹  ì‹œê° ë°±ì—…
    duelLastWeekPoint   = duelPoint;
    duelLastWeekUpdated = duelUpdated || 0;

    // ì´ë²ˆ ì£¼ ì´ˆê¸°í™”
    duelPoint   = 0;
    duelUpdated = 0;

    // ì´ë²ˆ ì£¼ë¡œ í‚¤ ê°±ì‹ 
    duelPointWeekKey = weekKey;

    // ìƒˆ ì£¼ ì‹œì‘ â†’ ì§€ë‚œì£¼ ë³´ìƒ ì•„ì§ ì•ˆ ë°›ìŒ
    duelLastWeekRewardClaimed = false;
  }
}

// ì–´ì œ ë‚ ì§œ "YYYY-MM-DD"
function getYesterdayDateString() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// íƒ€ì„ìŠ¤íƒ¬í”„ â†’ "MM/DD hh:mm:ss"
function formatTime(ts) {
  const d = new Date(ts);

  const MM  = String(d.getMonth() + 1).padStart(2, "0"); // ì›”
  const DD  = String(d.getDate()).padStart(2, "0");      // ì¼
  const hh  = String(d.getHours()).padStart(2, "0");     // ì‹œ
  const mm  = String(d.getMinutes()).padStart(2, "0");   // ë¶„
  const ss  = String(d.getSeconds()).padStart(2, "0");   // ì´ˆ

  return `${MM}/${DD} ${hh}:${mm}:${ss}`;
}

// íŒŒê´´ ë¬µë… ëŒ“ê¸€ ëœë¤
function getRandomMournComment() {
  const lines = [
    "ì™€~! íƒœì´ˆë§ˆì„ì´ì•¼~!",
    "ì´ ë§›ì— ê°•í™”í•˜ì§€ ã…‹ã…‹",
    "ê¹¨ë—í•˜ë‹¤, 0ê°•â€¦",
    "ì € ê°•ì²  ëƒ„ìƒˆ ë§¡ì•„ë´â€¦ ìƒˆê±°ì•¼ ìƒˆê±°.",
    "ê°•í™”ëŠ” ì›ë˜ ì—¬ê¸°ì„œë¶€í„° ì‹œì‘ì´ì£ ?",
    "ì•„ë¦„ë‹¤ìš´ í­ë°œì´ì—ˆìŠµë‹ˆë‹¤.",
    "ë˜ ë§Œë‚˜ì, +0ê°• ì‹œì ˆâ€¦",
    "ì €ê²Œ ë°”ë¡œ í•˜ë“œ ë¦¬ì…‹ì´ë¼ëŠ” ê±°ì•¼.",
    "ìš©ê¸° ìˆëŠ” ìì˜ ê²°ë§ì´êµ°.",
    "ê´€ì§ ì—´ê³  ë‹¤ì‹œ ê³ ê³ ì”½~"
  ];
  const i = Math.floor(Math.random() * lines.length);
  return lines[i];
}

// íŠ¹ì • ë¡œê·¸ ë°‘ì— ëŒ“ê¸€ í•œ ì¤„ ì¶”ê°€ (ìƒë‹¨ ë¡œê·¸ + ì‹¤ì‹œê°„ í† ìŠ¤íŠ¸ ë‘˜ ë‹¤)
function appendMournCommentToLog(logId, commentData) {
  // 1) ìƒë‹¨ ë¡œê·¸ íŒ¨ë„
  const panelItem = document.getElementById("log-" + logId);
  if (panelItem) {
    const commentsBox = panelItem.querySelector(".log-comments");
    if (commentsBox) {
      const div = document.createElement("div");
      div.style.fontSize = "12px";
      div.style.color = "#ccc";
      div.innerHTML = `â†³ ${commentData.text} <span style="color:#888;">- ${commentData.userId}</span>`;
      commentsBox.appendChild(div);
    }
  }

  // 2) í•˜ë‹¨ ì‹¤ì‹œê°„ í† ìŠ¤íŠ¸
  const toastItem = document.getElementById("toast-" + logId);
  if (toastItem) {
    const toastBox = toastItem.querySelector(".toast-comments");
    if (toastBox) {
      const div = document.createElement("div");
      div.style.fontSize = "11px";
      div.style.color = "#bbb";
      div.innerHTML = `â†³ ${commentData.text} <span style="color:#888;">- ${commentData.userId}</span>`;
      toastBox.appendChild(div);
    }
  }
}


  // [ë¬µë…í•˜ê¸°] í´ë¦­ ì‹œ ì²˜ë¦¬ (ìœ ì €ë‹¹ 1íšŒ)
function handleMournClick(e) {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const logId = e.target.dataset.logId;
  if (!logId) return;

  const userMournRef = logRef.child(logId).child("mournedBy").child(userId);

  // ì´ë¯¸ ì´ ë¡œê·¸ì— ë¬µë…í–ˆëŠ”ì§€ ì²´í¬
  userMournRef.once("value").then(snap => {
    if (snap.exists()) {
      alert("ì´ë¯¸ ì´ íŒŒê´´ì— ë¬µë…í–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    // ì´ ìœ ì €ê°€ ì‚¬ìš©í–ˆë‹¤ê³  ê¸°ë¡
    userMournRef.set(true);

    const comment = {
      userId: userId,
      text: getRandomMournComment(),
      time: Date.now()
    };

    // DBì— ëŒ“ê¸€ ë‚¨ê¸°ê¸°
    const commentsRef = logRef.child(logId).child("comments");
    const newRef = commentsRef.push(comment);
  });
}

  function getRandomAweComment() {
  const lines = [
    "ê·¸ ê²€ ëì—ì„œâ€¦ ë³„ì´ íƒœì–´ë‚¬ë‹¤. â˜…",
    "30ê°•ì€ ìš°ì—°ì´ ì•„ë‹ˆë¼, ì§‘ë…ì´ ì¦ëª…ëœ ìë¦¬ì˜€ë‹¤.",
    "í¼ê·¸ë€íŠ¸ì˜ ë¶ˆê½ƒì´ ì˜¤ëŠ˜, ì „ì„¤ì„ í•˜ë‚˜ ë” ë§Œë“¤ì—ˆë‹¤.",
    "ë‚˜ëŠ” ë³´ì•˜ë‹¤. ê°•í™”ì˜ ëì—ì„œ í”ë“¤ë¦¬ì§€ ì•Šì€ ì†ì„.",
    "ê·¸ ì´ë¦„ì„ ê¸°ì–µí•˜ë¼. ìš°ë¦¬ì˜ í•˜ëŠ˜ì— ìƒˆê²¨ì§„ ì²« ë¬¸ì¥ì´ë‹¤.",
    "ê²€ì´ ì•„ë‹ˆë¼, ì˜ì§€ê°€ ë¹›ë‚¬ë‹¤.",
    "ì˜¤ëŠ˜ì˜ ê¸°ë¡ì€ ë‚´ì¼ì˜ ê¸°ì¤€ì´ ëœë‹¤. ê²½ì™¸ë¥¼.",
    "ë³„ì€ ì•„ë¬´ì—ê²Œë‚˜ ë¶™ì§€ ì•ŠëŠ”ë‹¤. ì˜¤ì§ ë‹¬ì„±í•œ ìì—ê²Œë§Œ.",
    "ê²½ì™¸í•œë‹¤. ê·¸ë¦¬ê³  ë”°ë¼ê°€ê² ë‹¤. ì–¸ì  ê°€ ë‚˜ë„ ê·¸ ìë¦¬ì—.",
    "ì „ì„¤ì€ ì´ë ‡ê²Œ íƒœì–´ë‚œë‹¤â€¦ ì§€ê¸ˆ, ì—¬ê¸°ì„œ."
  ];
  return lines[Math.floor(Math.random() * lines.length)];
}

function handleAweClick(e) {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const logId = e.target.dataset.logId;
  const eventId = Number(e.target.dataset.eventId || 0);
  if (!logId || !eventId) return;

  // âœ… 1ì¸ 1íšŒ(ì´ë²¤íŠ¸ID ê¸°ì¤€) - ë¡œì»¬ ì„¸ì´ë¸Œ ê¸°ì¤€
  if (aweUsedGlobal30EventId === eventId) {
    alert("ì´ë¯¸ ì´ +30 ê¸°ë¡ì— ê²½ì™¸ë¥¼ ë°”ì³¤ìŠµë‹ˆë‹¤.");
    return;
  }

  // âœ… DB ê¸°ì¤€ 1ì¸ 1íšŒ(ë‹¤ë¥¸ ê¸°ê¸°/ë¸Œë¼ìš°ì € ëŒ€ë¹„)
  const userAweRef = logRef.child(logId).child("awedBy").child(userId);
  userAweRef.once("value").then(snap => {
    if (snap.exists()) {
      aweUsedGlobal30EventId = eventId;
      save();
      alert("ì´ë¯¸ ì´ +30 ê¸°ë¡ì— ê²½ì™¸ë¥¼ ë°”ì³¤ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì‚¬ìš© ì²˜ë¦¬
    aweUsedGlobal30EventId = eventId;
    save();
    userAweRef.set(true);

    const comment = {
      userId: userId,
      text: getRandomAweComment(),
      time: Date.now()
    };

    // ê¸°ì¡´ ë¬µë… ëŒ“ê¸€ê³¼ ë™ì¼í•˜ê²Œ commentsì— ë‹¬ê¸°
    logRef.child(logId).child("comments").push(comment);
  });
}

/* ë¡œê·¸ */
function writeLog(message, isDestroy=false, extra=null){
  const payload = { message, isDestroy, time: Date.now() };
  if (extra && typeof extra === "object") Object.assign(payload, extra);
  logRef.push(payload);
}
logRef.limitToLast(50).on("child_added", s => {
  const d = s.val();
  const logId = s.key;          // ì´ ë¡œê·¸ì˜ ê³ ìœ  ID
  const ts = formatTime(d.time || Date.now());

  const toastListEl    = document.getElementById("toastList");
  const logPanelListEl = document.getElementById("logPanelList");
  if (!toastListEl || !logPanelListEl) return;

  /* ğŸ‘‡ í•˜ë‹¨ í† ìŠ¤íŠ¸(5ê°œ ì œí•œ) */
  const toastEl = document.createElement("div");
  toastEl.className = "toast-item" + (d.isDestroy ? " toast-destroy" : "");
  toastEl.id = "toast-" + logId;   // ğŸ”´ ëŒ“ê¸€ ì—°ê²°ìš© ID

  // ë©”ì¸ í•œ ì¤„
  const toastMain = document.createElement("div");
  toastMain.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;

  // íŒŒê´´ ë¡œê·¸ë¼ë©´ [ë¬µë…í•˜ê¸°] ë²„íŠ¼ ì¶”ê°€
  if (d.isDestroy) {
    const btn = document.createElement("span");
    btn.textContent = " [ë¬µë…í•˜ê¸°]";
    btn.style.cursor = "pointer";
    btn.style.color = "#ffffff";  // í°ìƒ‰ ê°•ì¡°
    btn.dataset.logId = logId;
    btn.onclick = handleMournClick;
    toastMain.appendChild(btn);
  }

// +30 ì¶•í•˜ ë¡œê·¸ë¼ë©´ [ê²½ì™¸í•˜ê¸°] ë²„íŠ¼ ì¶”ê°€ (ë¬µë…í•˜ê¸°ì™€ ë™ì¼í•œ í˜•íƒœ)
if (d.isAwe) {
  const btn = document.createElement("span");
  btn.textContent = " [ê²½ì™¸í•˜ê¸°]";
  btn.style.cursor = "pointer";
  btn.style.color = "#ffffff";
  btn.style.fontWeight = "bold"; // âœ… ê¸€ì ì§„í•˜ê²Œ
  btn.dataset.logId = logId;
  btn.dataset.eventId = String(d.aweEventId || 0);
  btn.dataset.winnerNick = String(d.aweWinnerNick || "");
  btn.onclick = handleAweClick;
  toastMain.appendChild(btn);
}
  toastEl.appendChild(toastMain);

  // â¬‡ ëŒ“ê¸€ì´ ë‹¬ë¦´ ì˜ì—­
  const toastComments = document.createElement("div");
  toastComments.className = "toast-comments";
  toastComments.style.marginLeft = "18px";
  toastComments.style.marginTop  = "2px";
  toastEl.appendChild(toastComments);

  toastListEl.prepend(toastEl);
  while (toastListEl.children.length > 5) toastListEl.lastChild.remove();

  /* ğŸ‘‡ ìƒë‹¨ ë¡œê·¸ íŒ¨ë„ìš© í•­ëª© */
  const panelItem = document.createElement("div");
  panelItem.className = "toast-item" + (d.isDestroy ? " toast-destroy" : "");
  panelItem.id = "log-" + logId;   // ëŒ“ê¸€ ë¶™ì¼ ë•Œ ì°¾ê¸°ìš©

  const mainLine = document.createElement("div");
  mainLine.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;

  if (d.isDestroy) {
    const btn2 = document.createElement("span");
    btn2.textContent = " [ë¬µë…í•˜ê¸°]";
    btn2.style.cursor = "pointer";
    btn2.style.color = "#ffffff";
    btn2.dataset.logId = logId;
    btn2.onclick = handleMournClick;
    mainLine.appendChild(btn2);
  }

  if (d.isReach30) {
  const btn3 = document.createElement("span");
  btn3.textContent = " [ê²½ì™¸í•˜ê¸°]";
  btn3.style.cursor = "pointer";
  btn3.style.color = "#ffffff";
  btn3.dataset.logId = logId;
  btn3.dataset.eventId = String(d.global30EventId || 0);
  btn3.onclick = handleAweClick;
  mainLine.appendChild(btn3);
}

  panelItem.appendChild(mainLine);

  // ëŒ“ê¸€ ë°•ìŠ¤
  const commentsBox = document.createElement("div");
  commentsBox.className = "log-comments";
  commentsBox.style.marginLeft = "18px";
  commentsBox.style.marginTop  = "2px";
  panelItem.appendChild(commentsBox);

  logPanelListEl.prepend(panelItem);

  // ì´í›„ì— ë‹¬ë¦¬ëŠ” ëŒ“ê¸€ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜
  logRef.child(logId).child("comments").on("child_added", snap => {
    const c = snap.val();
    appendMournCommentToLog(logId, c);
  });
});

  // ğŸŒ ì „ ì„œë²„ ë„ì „ ì•Œë¦¼ ë°°ë„ˆ
let worldBannerInited = false;

function showWorldBanner(message) {
  const banner = document.getElementById("worldBanner");
  if (!banner) return;

  banner.innerHTML = message;
  banner.style.display = "block";

  // 7ì´ˆ í›„ ìë™ ìˆ¨ê¹€
  setTimeout(() => {
    banner.style.display = "none";
  }, 7000);
}

// ğŸ”” 25ê°• ì´ìƒ íŒŒê´´ ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ êµ¬ë…
function subscribeGlobalDestroyEvents() {
  if (!globalEventsRef) return;

  let initialized = false;

  globalEventsRef
    .orderByChild("createdAt")
    .limitToLast(1)          // ì œì¼ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ë§Œ
    .on("child_added", (snap) => {
      const v = snap.val() || {};

      // ì²˜ìŒ í•œ ë²ˆ ë“¤ì–´ì˜¬ ë•ŒëŠ” "ê¸°ì¡´ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸"ë¼ì„œ ê·¸ëƒ¥ ê¸°ì¤€ì ìœ¼ë¡œë§Œ ì‚¬ìš©
      if (!initialized) {
        initialized = true;
        return;
      }

      if (v.type !== "destroy25") return;

      const name  = v.userId || "ëˆ„êµ°ê°€";
      const level = v.level  || 0;

      const msg =
        `<span class="level">+${level}ê°•</span> ë„ì „ì— ëª¨ë“  ê²ƒì„ ê±¸ì—ˆë˜ ` +
        `<strong>${name}</strong>ë‹˜ì˜ ë¬´ê¸°ê°€ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤... ` +
        `<span style="color:#ffb74d;">ìœ„ëŒ€í•œ ë„ì „ì— ë¬µë…ì„.</span>`;

      showWorldBanner(msg);
    });
}

  // ê²€ìƒ‰ì°½ ë³€ê²½ ì‹œ í˜¸ì¶œ
function onDuelSearchChange(value) {
  renderDuelList(value);
}

  // âš”ï¸ ê²°íˆ¬ ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderDuelList(keyword) {
  const listEl = document.getElementById("duelList");
  const helpEl = document.getElementById("duelHelpText");
  if (!listEl) return;

  keyword = (keyword || "").trim();

  // ìœ ì € ëª©ë¡ì´ ì•„ì§ ì•ˆ ì™”ìœ¼ë©´
  if (!allUsersCache || allUsersCache.length === 0) {
    listEl.innerHTML = `<div style="font-size:13px; color:#aaa;">ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
    if (helpEl) helpEl.style.display = "none";
    return;
  }

  // ìê¸° ìì‹ ì€ ì œì™¸
  let base = allUsersCache.filter(u => u.id !== userId);

  let filtered;
if (!keyword) {
  // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ìƒìœ„ 5ëª…ë§Œ í‘œì‹œ
  filtered = base.slice(0, 5);
  if (helpEl) {
    helpEl.textContent = "ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•ŒëŠ” ìƒìœ„ 5ëª…ë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
    helpEl.style.display = "block";
  }
} else {
  const lower = keyword.toLowerCase();
  filtered = base.filter(u => u.id.toLowerCase().includes(lower));
  if (helpEl) {
    helpEl.textContent = filtered.length === 0
      ? `"${keyword}" ì™€(ê³¼) ì¼ì¹˜í•˜ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.`
      : `"${keyword}" ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.`;
    helpEl.style.display = "block";
  }
}

  if (filtered.length === 0) {
    listEl.innerHTML = `<div style="font-size:13px; color:#aaa;">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  listEl.innerHTML = "";

  filtered.forEach(u => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.style.padding = "4px 0";
    row.style.borderBottom = "1px solid #333";

    const left = document.createElement("div");
    left.innerHTML = `
      <div style="font-weight:bold;">${formatNicknameWithTitle(u.id, u.equippedTitle || "", u.reach30Count)}</div>

      <div style="font-size:12px; color:#ccc;">
        ${coloredLevel(u.sword)} / ì „íˆ¬ë ¥: ${formatGold(u.power || 0)}
      </div>
    `;

    const btn = document.createElement("span");
    btn.textContent = "ê²°íˆ¬ì‹ ì²­";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.style.color = "#ffffff";
    btn.dataset.targetId = u.id;
    
btn.onclick = function () {
  showDuelConfirmPopup(u.id); // â† isRandomMatch ì œê±°
};

    row.appendChild(left);
    row.appendChild(btn);
    listEl.appendChild(row);
  });
}

// ğŸ– ëª…ì˜ˆì˜ í›ˆì¥ ë³´ìƒ ê³„ì‚°
// mySword : ë‚´ ê°•í™” ìˆ˜ì¹˜
// enemySword : ìƒëŒ€ ê°•í™” ìˆ˜ì¹˜
// isRandomMatch : ëœë¤ë§¤ì¹­ì´ë©´ true
function getHonorMedalReward(mySword, enemySword, isRandomMatch) {
  const diff = enemySword - mySword;  // ìƒëŒ€ - ë‚˜ (ì–‘ìˆ˜ë©´ ìƒìœ„ ìƒëŒ€)

  let base = 0;

  // ğŸ‘‰ ë„ˆë‘ ê°™ì´ ì •ë¦¬í•œ ë³´ì • í…Œì´ë¸”
  // n+5 ì´ìƒ : 40
  // n+4     : 28
  // n+3     : 18
  // n+2     : 10
  // n+1     : 5
  // n       : 3
  // n-1     : 1
  // n-2 ì´í•˜: 0
  if (diff >= 5) {
    base = 40;
  } else if (diff === 4) {
    base = 28;
  } else if (diff === 3) {
    base = 18;
  } else if (diff === 2) {
    base = 10;
  } else if (diff === 1) {
    base = 5;
  } else if (diff === 0) {
    base = 3;
  } else if (diff === -1) {
    base = 1;
  } else {
    base = 0;
  }

  // ëœë¤ë§¤ì¹­ ë³´ë„ˆìŠ¤ +1
  if (isRandomMatch && base > 0) {
    base += 1;
  }

  return base;
}
  
  // ğŸ² ëœë¤ë§¤ì¹­
function handleRandomMatch() {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (!allUsersCache || allUsersCache.length === 0) {
    alert("ì•„ì§ ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }

  const candidates = allUsersCache.filter(u => u.id !== userId);
  if (candidates.length === 0) {
    alert("ë§¤ì¹­ ê°€ëŠ¥í•œ ë‹¤ë¥¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

const idx = Math.floor(Math.random() * candidates.length);
const target = candidates[idx];

// âœ… ëœë¤ë§¤ì¹­ì€ í™•ì¸ì°½ ì—†ì´ ë°”ë¡œ ê²°íˆ¬
performDuel(target.id, true);

}

// âš”ï¸ ê²°íˆ¬ì¥ ì—´ê¸°
function openDuelArena() {

  
  // ì§‘ê³„ ì‹œê°„ ì ê¸ˆ
  if (isDuelSettlementTimeKST()) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì§€ê¸ˆì€ ê²°íˆ¬ì¥ ì§‘ê³„ ì¤‘ì´ì•¼.
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ë§¤ì£¼ ì›”ìš”ì¼ 00:00 ~ 00:10 ì‚¬ì´ì—ëŠ”<br>
        ê²°íˆ¬ì¥ì— ì…ì¥í•  ìˆ˜ ì—†ì–´.
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

  // ì£¼ê°„ í¬ì¸íŠ¸ ì •ë¦¬
  if (typeof ensureDuelWeek === "function") {
    ensureDuelWeek();
  }

    // ì§€ë‚œì£¼ ë³´ìƒ ì²´í¬
  checkWeeklyDuelReward();
  
 // ê²°íˆ¬ì¥ ì—´ê¸° ë¡œì§
  const overlay = document.getElementById("duelArenaOverlay");
  if (!overlay) return;

  overlay.style.display = "block";

  updateDuelUI();        // ê²°íˆ¬ì¥ ì—´ë¦´ ë•Œ ë‚¨ì€ íšŸìˆ˜ í•œë²ˆ ê°±ì‹ 
  loadDuelArenaRanking();// ë­í‚¹ ë¡œë“œ
}

// âš”ï¸ ê²°íˆ¬ì¥ ë‹«ê¸°
function closeDuelArena() {
  const overlay = document.getElementById("duelArenaOverlay");
  if (!overlay) return;
  overlay.style.display = "none";
}

// ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì˜¤ë²„ë ˆì´ ì—´ê¸°
function openUserListOverlay() {
  const overlay = document.getElementById("userListOverlay");
  if (!overlay) return;

  // ìºì‹œì— ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ë¡œë”© ë¬¸êµ¬ í‘œì‹œ
  if (!allUsersCache || allUsersCache.length === 0) {
    const body = document.getElementById("userListBody");
    const countEl = document.getElementById("userListCount");
    if (body) {
      body.innerHTML = `
        <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
          ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
      `;
    }
    if (countEl) {
      countEl.textContent = "ëª¨í—˜ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
    }
  } else {
    renderUserList(allUsersCache);
  }

  overlay.style.display = "block";
}

// ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
function closeUserListOverlay() {
  const overlay = document.getElementById("userListOverlay");
  if (!overlay) return;
  overlay.style.display = "none";
}
  
  // âš”ï¸ ê²°íˆ¬ì¥ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° (duelPoint ê¸°ì¤€)
function loadDuelArenaRanking() {
  const listEl = document.getElementById("duelArenaRankList");
  const myEl   = document.getElementById("duelArenaMyRank");
  if (!listEl || !myEl) return;

  listEl.innerHTML = `
    <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
      ê²°íˆ¬ì¥ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </div>
  `;
  myEl.textContent = "";

  const usersRef = db.ref("users");
  const thisWeekKey = getKstWeekKey();   // ğŸ†• ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ê¸°ì¤€ ì£¼í‚¤

  // duelPoint ê¸°ì¤€ìœ¼ë¡œ ëª¨ë‘ ê°€ì ¸ì˜¨ ë’¤, ë©”ëª¨ë¦¬ì—ì„œ í•„í„° + ì •ë ¬
  usersRef
    .orderByChild("duelPoint")
    .once("value")
    .then((snap) => {
      const arr = [];

      snap.forEach((child) => {
        const u = child.val() || {};
        const uid = child.key;

        // ğŸ†• ì´ë²ˆ ì£¼ê°€ ì•„ë‹Œ ê³„ì •ì€ ë­í‚¹ì—ì„œ ì œì™¸
        const userWeekKey = u.duelPointWeekKey || "";
        if (userWeekKey !== thisWeekKey) return;

        const point = Number(u.duelPoint || 0);
        if (!point || point <= 0) return; // í¬ì¸íŠ¸ 0 ì´í•˜ë©´ ë­í‚¹ ì œì™¸

        arr.push({
          id: uid,
          duelPoint: point,
          sword: Number(u.sword || 0),
          duelWin: Number(u.duelWin || 0),
          duelLose: Number(u.duelLose || 0),
          updated: Number(u.duelUpdated || u.updated || 0),
          weaponType: u.weaponType || "sword"
        });
      });

      if (arr.length === 0) {
        listEl.innerHTML = `
          <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
            ì•„ì§ ê²°íˆ¬ í¬ì¸íŠ¸ë¥¼ ê°€ì§„ ëª¨í—˜ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
            ê°€ì¥ ë¨¼ì € ê²°íˆ¬ì¥ì„ ì •ë³µí•´ ë³´ì„¸ìš”!
          </div>
        `;
        myEl.textContent = "";
        return;
      }

      // ğŸ”½ duelPoint ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê°™ì€ í¬ì¸íŠ¸ë©´ updated ë¹ ë¥¸ ìˆœì„œë¡œ)
      arr.sort((a, b) => {
        if (b.duelPoint !== a.duelPoint) {
          return b.duelPoint - a.duelPoint;
        }
        return (a.updated || 0) - (b.updated || 0);
      });

      // ğŸ”Ÿ ìƒìœ„ 10ëª…ë§Œ í‘œì‹œ
      const top = arr.slice(0, 10);

      // ğŸ§¾ ë­í‚¹ HTML êµ¬ì„±
      const rows = top.map((u, idx) => {
        const rank = idx + 1;

          // ë¬´ê¸° ì´ë¦„ ì–»ê¸° (ì´ë¯¸ ìˆëŠ” getWeaponInfo ì¬ì‚¬ìš©)
  let weaponText = `+${u.sword}ê°•`;
  try {
    const info = getWeaponInfo(u.sword, u.weaponType || "sword");   // ğŸ†• type ë„˜ê²¨ì£¼ê¸°
    if (info && info.name) {
      weaponText = `${info.name} +${u.sword}ê°•`;
    }
  } catch (e) {
    // í•¨ìˆ˜ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë‚˜ë©´ ê·¸ëƒ¥ +ê°•ë§Œ í‘œì‹œ
  }

        const recordText = `${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨`;

        return `
          <div style="display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid #333; font-size:12px;">
            <div>
              <span style="font-weight:bold;">${rank}ìœ„</span>
              &nbsp; ${u.id}
            </div>
            <div style="text-align:right;">
              <div>ê²°íˆ¬í¬ì¸íŠ¸ <span style="color:#ffd54f;">${u.duelPoint}</span></div>
              <div style="font-size:11px; color:#ccc;">${weaponText} Â· ${recordText}</div>
            </div>
          </div>
        `;
      });

      listEl.innerHTML = rows.join("");

      // ğŸ‘¤ ë‚´ ë­í‚¹ ì°¾ê¸°
      const myIndex = arr.findIndex(u => u.id === userId);

      if (myIndex === -1) {
        myEl.textContent = "ë‚´ ê²°íˆ¬ í¬ì¸íŠ¸: 0 (ë­í‚¹ ë¯¸ë“±ë¡)";
      } else {
        const myRank = myIndex + 1;
        const me = arr[myIndex];
        myEl.innerHTML = `
          ë‚´ ë­í‚¹: <span style="color:#ffd54f;">${myRank}ìœ„</span>
          Â· ê²°íˆ¬í¬ì¸íŠ¸ ${me.duelPoint}
          Â· ì „ì  ${me.duelWin}ìŠ¹ ${me.duelLose}íŒ¨
        `;
      }
    })
    .catch((err) => {
      console.error("ê²°íˆ¬ì¥ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", err);
      listEl.innerHTML = `
        <div style="padding:8px 0; text-align:center; color:#f88; font-size:12px;">
          ê²°íˆ¬ì¥ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
          ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
        </div>
      `;
    });
}

// ğŸ¯ ê²°íˆ¬í•˜ê¸°(ì§€ì •ë§¤ì¹­) ë²„íŠ¼ â†’ ê²°íˆ¬ íŒ¨ë„ ì—´ê¸° + ìœ„ì¹˜ ì¡°ì •
function openDuelTargetPanel() {
  const panel = document.getElementById("duelPanel");
  if (!panel) return;

  // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  if (panel.style.display === "block") {
    panel.style.display = "none";
    return;
  }

  // âœ… ê¸°ì¡´ í† ê¸€ ë¡œì§ì²˜ëŸ¼ ë¦¬ìŠ¤íŠ¸/ê²€ìƒ‰ ì„¸íŒ…
  renderDuelList("");
  panel.style.display = "block";
  const input = document.getElementById("duelSearchInput");
  if (input) {
    input.value = "";
input.focus({ preventScroll: true });
}

  // ğŸ¯ ê²°íˆ¬ì¥ ì•ˆì˜ "ê²°íˆ¬í•˜ê¸°(ì§€ì •ë§¤ì¹­)" ë²„íŠ¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³„ì‚°
  const btn = document.querySelector("#duelArenaPanel button[onclick='openDuelTargetPanel()']");
  if (!btn) return;

  const btnRect = btn.getBoundingClientRect();

  // íŒ¨ë„ ì‹¤ì œ í¬ê¸° ì¸¡ì • (í‘œì‹œëœ ìƒíƒœì—¬ì•¼ í•¨)
  const panelRect = panel.getBoundingClientRect();
  let panelWidth = panelRect.width || 260;
  let panelHeight = panelRect.height || 260;

  let left;
  let top;

  if (window.innerWidth <= 520) {
    // ğŸ“± ëª¨ë°”ì¼: í™”ë©´ ì•„ë˜ìª½ ì¤‘ì•™ ìª½ì— ìœ„ì¹˜
    left = (window.innerWidth - panelWidth) / 2;
    top = btnRect.bottom + 8;

    // ì•„ë˜ë¡œ ë„˜ì¹˜ë©´ ìœ„ë¡œ ì¡°ê¸ˆ ì˜¬ë¦¬ê¸°
    if (top + panelHeight > window.innerHeight - 10) {
      top = window.innerHeight - panelHeight - 10;
    }
  } else {
    // ğŸ–¥ PC: ë²„íŠ¼ ì˜¤ë¥¸ìª½ì— ë¶™ì´ê¸°
    left = btnRect.right + 8;
    top = btnRect.top;

    // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë„˜ì¹˜ë©´ ë²„íŠ¼ ì™¼ìª½ìœ¼ë¡œ
    if (left + panelWidth > window.innerWidth - 10) {
      left = btnRect.left - panelWidth - 8;
    }
    // ì•„ë˜ë¡œ ë„˜ì¹˜ë©´ í™”ë©´ ì•ˆìœ¼ë¡œ ì˜¬ë¦¬ê¸°
    if (top + panelHeight > window.innerHeight - 10) {
      top = window.innerHeight - panelHeight - 10;
    }
  }

  panel.style.position = "fixed";      // ì˜¤ë²„ë ˆì´ ìœ„ì— ê³ ì •
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;
  panel.style.zIndex = 1300;           // ê²°íˆ¬ì¥ ì˜¤ë²„ë ˆì´(1200)ë³´ë‹¤ ìœ„
}


// ğŸ² ëœë¤ë§¤ì¹­ ë²„íŠ¼ (ê²°íˆ¬ì¥ ì•ˆì—ì„œ)
function handleRandomMatchFromArena() {
  handleRandomMatch(); // ê¸°ì¡´ ëœë¤ë§¤ì¹­ ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš©
}

// âš”ï¸ ê²°íˆ¬ì¥ ê·œì¹™ / ë³´ìƒ ì„¤ëª… íŒì—…
function openDuelHelpPopup() {
  const html = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ê²°íˆ¬ì¥ ê·œì¹™ & ë³´ìƒ ì•ˆë‚´
    </div>
    <div style="font-size:13px; line-height:1.5;">
      <div style="margin-bottom:6px;">
        Â· ê²°íˆ¬ì¥ì—ì„œ ìŠ¹ë¦¬í•˜ë©´ <span style="color:#ffcc66;">ê³¨ë“œ</span>ì™€<br>
          <span style="color:#66ccff;">ëª…ì˜ˆì˜ í›ˆì¥</span>, 
          <span style="color:#ff8888;">ê²°íˆ¬ í¬ì¸íŠ¸</span>ë¥¼ ì–»ìŠµë‹ˆë‹¤.
      </div>
      <div style="margin-bottom:6px;">
        Â· ê²°íˆ¬ í¬ì¸íŠ¸ëŠ” ì£¼ê°„ ëˆ„ì  ì ìˆ˜ë¡œ,<br>
          ë§¤ì£¼ <span style="color:#ffcc66;">ì›”ìš”ì¼ 00:00</span>ì— ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
      </div>
      <div style="margin-bottom:6px;">
        Â· ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ë¡œ <span style="color:#ffcc66;">ê²°íˆ¬ì¥ ë­í‚¹</span>ì´ ê²°ì •ë˜ë©°,<br>
          ìˆœìœ„ì— ë”°ë¼ ë§¤ì£¼ ë³´ìƒì´ ì§€ê¸‰ë©ë‹ˆë‹¤.
      </div>
      <div style="margin-bottom:6px;">
        Â· <span style="color:#ffcc66;">ëœë¤ ë§¤ì¹­</span>ìœ¼ë¡œ ì´ê¸°ë©´<br>
          ì¶”ê°€ë¡œ ëª…ì˜ˆì˜ í›ˆì¥ <span style="color:#ffcc66;">+1</span>ì„ ë” ë°›ìŠµë‹ˆë‹¤.
      </div>
      <div style="margin-top:8px; border-top:1px solid #444; padding-top:6px;">
        <div style="margin-bottom:4px;">[ì£¼ê°„ ë³´ìƒ]</div>
        <div>1ìœ„ : íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 2ê°œ</div>
        <div>2~3ìœ„ : íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œ</div>
        <div>4~6ìœ„ : ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ 5ê°œ, 15ê°• ì£¼ë¬¸ì„œ 3ê°œ</div>
        <div>7~10ìœ„ : ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ 3ê°œ, 15ê°• ì£¼ë¬¸ì„œ 1ê°œ</div>
        <div>10ìœ„ ë°– : ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ 1ê°œ</div>
      </div>
    </div>
  `;

  showNpcMessage(
    html,
    "images/npc/duel_carnia.png",
    true,
    "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
  );
}

// ğŸ•° ì§€ë‚œ ë­í‚¹ íŒì—…
function openDuelHistoryPopup() {
  const usersRef = db.ref("users");

  // ğŸ†• ì§€ë‚œì£¼ ê¸°ê°„ ë²”ìœ„ ê³„ì‚°
  const range = getLastWeekRangeKst();
  const startTs = range.start;
  const endTs   = range.end;

  usersRef
    .orderByChild("duelLastWeekPoint")
    .once("value")
    .then((snap) => {
      const arr = [];

      snap.forEach((child) => {
        const val   = child.val() || {};
        const point = Number(val.duelLastWeekPoint || 0);
        const t     = Number(val.duelLastWeekUpdated || 0);

        if (point <= 0) return;

        // ğŸ§¹ ì§€ë‚œì£¼ ê¸°ê°„ ì•ˆì— ê¸°ë¡ëœ ê²ƒë§Œ ì‚¬ìš©
        if (!t || t < startTs || t >= endTs) return;

        arr.push({
          id: child.key,
          duelLastWeekPoint: point,
          sword: Number(val.sword || 0),
          duelWin: Number(val.duelWin || 0),
          duelLose: Number(val.duelLose || 0),
          updated: t,
          weaponType: val.weaponType || "sword",
          equippedTitle: val.equippedTitle || ""
        });
      });

      if (arr.length === 0) {
        showNpcMessage(
          `
          <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">
            ì§€ë‚œì£¼ ê²°íˆ¬ì¥ ë­í‚¹
          </div>
          <div style="font-size:13px;">
            ì§€ë‚œì£¼ì—ëŠ” ê²°íˆ¬ì¥ì— ê¸°ë¡ì´ ë‚¨ì€ ê²€ì‚¬ê°€ ì—†ì—ˆì–´.<br>
            ì´ë²ˆ ì£¼ì—” ë„¤ ì´ë¦„ì„ ì˜¬ë ¤ë³´ëŠ” ê±´ ì–´ë•Œ?
          </div>
          `,
          "images/npc/duel_carnia.png",
          true,
          "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
        );
        return;
      }

// ğŸ” ì§€ë‚œì£¼ í¬ì¸íŠ¸ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
arr.sort((a, b) => {
  if (b.duelLastWeekPoint !== a.duelLastWeekPoint) {
    return b.duelLastWeekPoint - a.duelLastWeekPoint;  // í¬ì¸íŠ¸ ë†’ì€ ìˆœ
  }

  const aTime = Number(a.updated || 0);
  const bTime = Number(b.updated || 0);
  return aTime - bTime;   // ê°™ì€ í¬ì¸íŠ¸ë©´ ë¨¼ì € ë„ë‹¬í•œ ì‚¬ëŒ
});

      // TOP 10ë§Œ ì¶œë ¥
      const top10 = arr.slice(0, 10);

      const rowsHtml = top10.map((u, i) => {
      const wInfo = getWeaponInfo(u.sword, u.weaponType);
      const weaponNameStyled = coloredWeaponName(u.sword, wInfo.name);

        return `
          <tr>
            <td style="padding:2px 4px; text-align:center;">${i + 1}</td>
            <td style="padding:2px 4px;">${formatNicknameWithTitle(u.id, u.equippedTitle || "", u.reach30Count)}</td>
            <td style="padding:2px 4px; text-align:right;">${u.duelLastWeekPoint}</td>
            <td style="padding:2px 4px;">${weaponNameStyled} ${coloredLevel(u.sword)}</td>
            <td style="padding:2px 4px; text-align:right;">
              ${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨
            </td>
          </tr>
        `;
      }).join("");

      // ë‚´ ì§€ë‚œì£¼ ë­í‚¹ ë¬¸êµ¬
      let myRankText = "ì§€ë‚œì£¼ ë„¤ ê²°íˆ¬ì¥ ê¸°ë¡ì€ ë‚¨ì•„ìˆì§€ ì•Šë„¤.";
      const myIndex = arr.findIndex((u) => u.id === userId);

      if (myIndex !== -1) {
        const myRank = myIndex + 1;
        const myPoint = arr[myIndex].duelLastWeekPoint;
        myRankText =
          `ì§€ë‚œì£¼ ë„¤ ë­í‚¹ì€ <span style="color:#ffd54f;">${myRank}ìœ„</span>, ` +
          `ê²°íˆ¬í¬ì¸íŠ¸ <span style="color:#a5e1ff;">${myPoint}</span>ì ì´ì—ˆì–´.`;
      }

      const html = `
        <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">
          ì§€ë‚œì£¼ ê²°íˆ¬ì¥ ë­í‚¹
        </div>
        <div style="font-size:12px; margin-bottom:6px; color:#ccc;">
          ë§¤ì£¼ ì›”ìš”ì¼ 00:00(KST) ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„ëœ ê¸°ë¡ì´ì•¼.
        </div>
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="border-bottom:1px solid #444;">
              <th style="padding:2px 4px; text-align:center;">ìˆœìœ„</th>
              <th style="padding:2px 4px; text-align:left;">ê²€ì‚¬</th>
              <th style="padding:2px 4px; text-align:right;">í¬ì¸íŠ¸</th>
              <th style="padding:2px 4px; text-align:left;">ë¬´ê¸°</th>
              <th style="padding:2px 4px; text-align:right;">ì „ì </th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
        <div style="margin-top:8px; font-size:12px;">
          ${myRankText}
        </div>
      `;

      showNpcMessage(
        html,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
    })
    .catch((err) => {
      console.error("ì§€ë‚œì£¼ ê²°íˆ¬ì¥ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", err);
      showNpcMessage(
        `
        <div style="font-size:14px;">
          ì§€ë‚œì£¼ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´.<br>
          ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ ì¤˜.
        </div>
        `,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
    });
}

  
// âš”ï¸ ê²°íˆ¬ íŒ¨ë„ í† ê¸€
function toggleDuelPanel() {
  const panel = document.getElementById("duelPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderDuelList("");  // ê²€ìƒ‰ì–´ ì—†ì´ â†’ ë­í‚¹ ìˆœ
    panel.style.display = "block";

    const input = document.getElementById("duelSearchInput");
    if (input) {
      input.value = "";
      input.focus();
    }
  } else {
    panel.style.display = "none";
  }
}
  
/* ë¡œê·¸ í† ê¸€ */
function toggleLog(){
  const panel = document.getElementById("logPanel");
  if (!panel) return;

  panel.style.display = (panel.style.display === "none" || panel.style.display === "")
    ? "block"
    : "none";
}

// ğŸ’ ì¸ë²¤í† ë¦¬ í† ê¸€
function toggleInventory() {
  const panel = document.getElementById("inventoryPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderInventory();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

// ğŸ’ ì¸ë²¤í† ë¦¬ (ê²©ì + ì•„ì´ì½˜ + í´ë¦­ ìƒì„¸ íŒì—…)
function renderInventory() {
  const listEl = document.getElementById("inventoryList");
  if (!listEl) return;

  listEl.innerHTML = "";

  const items = [];

  if (itemScroll15 > 0) {
    items.push({
      id: "scroll15",
      name: "15ê°• ê°•í™” ì£¼ë¬¸ì„œ",
      count: itemScroll15,
      img: "images/items/scroll_15.png",
      desc: "í˜„ì¬ ë¬´ê¸°ë¥¼ 15ê°•ê¹Œì§€ í•œ ë²ˆì— ê°•í™”í•  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜ ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
    });
  }

  // 21ê°• ê°•í™” ì£¼ë¬¸ì„œ
  if (itemScroll21 > 0) {
    items.push({
      id: "scroll21",
      name: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",
      count: itemScroll21,
      img: "images/items/scroll_21.png",   // âœ… íŒŒì¼ëª… í†µì¼
      desc: "í•œ ë²ˆì— ë¬´ê¸°ë¥¼ 21ê°•ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
    });
  }

  if (itemHonorMedal > 0) {
  items.push({
    key: "honorMedal",
    name: "ëª…ì˜ˆì˜ í›ˆì¥",
    count: itemHonorMedal,
    img: "images/items/medal_honor.png",
    desc: "ìŠ¹ë¦¬ì˜ ìˆœê°„ì—ë§Œ ìƒˆê²¨ì§€ëŠ” ì¡°ìš©í•œ ì¦í‘œ.\nì–¸ì  ê°€, ê°€ì¹˜ê°€ ë“œëŸ¬ë‚  ë‚ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤."
  });
}

  if (itemProtect > 0) {
    items.push({
      id: "protect",
      name: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",
      count: itemProtect,
      img: "images/items/scroll_protect.png",
      desc: "ê°•í™” ì‹¤íŒ¨ ì‹œ ë¬´ê¸°ê°€ íŒŒê´´ë˜ëŠ” ê²ƒì„ 1íšŒ ë§‰ì•„ì¤ë‹ˆë‹¤."
    });
  }

  if (itemDownProtect > 0) {
    items.push({
      id: "downProtect",
      name: "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",
      count: itemDownProtect,
      img: "images/items/scroll_down_protect.png", // â­ í™•ì •
      desc: "ê°•í™” ì‹¤íŒ¨ ì‹œ ê°•í™” ë‹¨ê³„ê°€ ë‚´ë ¤ê°€ëŠ” ê²ƒì„ 1íšŒ ë§‰ì•„ì¤ë‹ˆë‹¤."
    });
  }

  if (itemSuper > 0) {
    items.push({
      id: "super",
      name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ",
      count: itemSuper,
      img: "images/items/scroll_super.png",
      desc: "ê°•í™” ì„±ê³µ ì‹œ í•œ ë²ˆì— +2ê°•ì´ ë˜ëŠ” íŠ¹ë³„í•œ ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
    });
  }

if (starShard > 0) {
  items.push({
    id: "starShard",
    name: "ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°",
    count: starShard,
    img: "images/items/star_shard.png",
    desc: "ë¶€ì„œì§„ ì¹¼ë‚  ì†ì— ë‚¨ê²¨ì§„ í”ì ì…ë‹ˆë‹¤. ì¡°ê°ì´ ëª¨ì´ë©´, íŠ¹ìˆ˜í•œ ì•„ì´í…œê³¼ êµí™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
  });
}
  // ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ
  if (itemRateUp5 > 0) {
    items.push({
      id: "rateUp5",
      name: "ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ",
      count: itemRateUp5,
      img: "images/items/scroll_rateup_5.png",  // âœ… íŒŒì¼ëª… í†µì¼
      desc: "ì´ë²ˆ ê°•í™” ì‹œ ì„±ê³µ í™•ë¥ ì´ 5%p ì¦ê°€í•©ë‹ˆë‹¤."
    });
  }

  const title = document.createElement("p");
  title.textContent = "ë³´ìœ  ì•„ì´í…œ";
  title.style.margin = "0 0 4px 0";
  title.style.fontSize = "13px";
  title.style.color = "#ccc";
  listEl.appendChild(title);

  if (items.length === 0) {
    const emptyMsg = document.createElement("p");
    emptyMsg.textContent = "ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.";
    emptyMsg.style.fontSize = "12px";
    emptyMsg.style.color = "#888";
    emptyMsg.style.marginTop = "6px";
    listEl.appendChild(emptyMsg);
    return;
  }

  const grid = document.createElement("div");
  grid.className = "inventory-grid";

  items.forEach(item => {
    const slot = document.createElement("div");
    slot.className = "inventory-slot";

    const img = document.createElement("img");
    img.src = item.img;
    img.alt = item.name;
    img.title = item.name;

    slot.appendChild(img);

    if (item.count > 1) {
      const countBadge = document.createElement("div");
      countBadge.className = "inventory-count";
      countBadge.textContent = item.count;
      slot.appendChild(countBadge);
    }

    // ğŸ–± í´ë¦­ â†’ ìƒì„¸ íŒì—…
    slot.addEventListener("click", (e) => {
      showItemDetail(item, e.clientX, e.clientY);
    });

    grid.appendChild(slot);
  });

  listEl.appendChild(grid);
}

  // ğŸ’ ì•„ì´í…œ ìƒì„¸ í‘œì‹œ
function showItemDetail(item, clickX, clickY) {
  const overlay = document.getElementById("itemDetailOverlay");
  const box     = document.getElementById("itemDetailBox");
  const img     = document.getElementById("itemDetailImg");
  const nameEl  = document.getElementById("itemDetailName");
  const descEl  = document.getElementById("itemDetailDesc");
  if (!overlay || !box) return;

  img.src = item.img;
  img.alt = item.name;
  nameEl.textContent = item.name;
  descEl.textContent = item.desc || "";

  overlay.style.display = "block";

  // í´ë¦­ ìœ„ì¹˜ ê·¼ì²˜ì— í‘œì‹œ
  let left = clickX + 12;
  let top  = clickY + 12;

  const boxRect = box.getBoundingClientRect();
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  if (left + boxRect.width > vw - 10)
    left = clickX - boxRect.width - 12;

  if (top + boxRect.height > vh - 10)
    top = clickY - boxRect.height - 12;

  if (left < 10) left = 10;
  if (top < 10) top = 10;

  box.style.left = left + "px";
  box.style.top  = top  + "px";
}

function hideItemDetail() {
  const overlay = document.getElementById("itemDetailOverlay");
  if (overlay) overlay.style.display = "none";
}

// ğŸ’ ì•„ì´í…œ ìƒì„¸ ì˜¤ë²„ë ˆì´ ì´ë²¤íŠ¸ëŠ” DOMì´ ë‹¤ ë§Œë“¤ì–´ì§„ ë’¤ì— ë¶™ì´ê¸°
window.addEventListener("load", () => {
  const overlay = document.getElementById("itemDetailOverlay");
  const box     = document.getElementById("itemDetailBox");
  if (!overlay || !box) return;

  // ë°°ê²½(ì–´ë‘ìš´ ì˜ì—­) ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ìƒì„¸ì°½ë§Œ ë‹«ê¸°
  overlay.addEventListener("mousedown", (e) => {
    hideItemDetail();
    e.stopPropagation(); // ğŸ‘ˆ ì¸ë²¤í† ë¦¬ ë°”ê¹¥ í´ë¦­ ì²˜ë¦¬ë¡œ ë„˜ì–´ê°€ì§€ ì•Šê²Œ ë§‰ê¸°
  });

  // ìƒì„¸ ë°•ìŠ¤ ì•ˆ í´ë¦­ì€ ìœ ì§€
  box.addEventListener("mousedown", (e) => {
    e.stopPropagation();
  });
});

// ESCë¡œ ë‹«ê¸° (ê·¸ëŒ€ë¡œ ìœ ì§€)
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") hideItemDetail();
});

  // ìƒì  Yes/No ë²„íŠ¼ ì´ˆê¸°í™”
function initScrollShopButtons() {
  const yesBtn = document.getElementById("scrollShopYesBtn");
  const noBtn  = document.getElementById("scrollShopNoBtn");

  if (yesBtn) yesBtn.onclick = onClickScrollShopYes;
  if (noBtn)  noBtn.onclick  = onClickScrollShopNo;
}

  loadRanking();
  autoLoginFromStorage();
    // â± ì‚¬ëƒ¥ íšŒë³µ íƒ€ì´ë¨¸ í‘œì‹œìš©
  setInterval(updateHuntUI, 1000);

    // ğŸ“œ ìŠ¤í¬ë¡¤ ìƒì  ë²„íŠ¼/ì´ë²¤íŠ¸ ì—°ê²°
  initScrollShopButtons();

// â›” ê°•í™”/ê²°íˆ¬ ì§„í–‰ ì¤‘ì—ëŠ” Enter / Space ì…ë ¥ ì°¨ë‹¨
document.addEventListener("keydown", (e) => {
  if (!isUpgrading && !isDueling) return;

  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    e.stopPropagation();
  }
});

  // ğŸ›  ìš´ì˜ììš© â€” ì „íˆ¬ë ¥ ì¬ê³„ì‚° + DB ë°˜ì˜
async function recalcUserPower(userIdToFix) {

  const ref = db.ref("users/" + userIdToFix);

  const snap = await ref.once("value");
  if (!snap.exists()) {
    console.warn("âŒ ìœ ì € ë°ì´í„° ì—†ìŒ:", userIdToFix);
    return;
  }

  const d = snap.val();

  // í•´ë‹¹ ìœ ì € ê¸°ì¤€ ìƒíƒœ ë¡œë“œ
  sword = Number(d.sword ?? 0);
  gold  = Number(d.gold  ?? 0);

  // ğŸ§® ì „íˆ¬ë ¥ ì¬ì‚°ì¶œ
  rollPowerForCurrentSword();

  // DB ë°˜ì˜
  await ref.update({
    power: Number(power)
  });

  console.log(`âœ… ì „íˆ¬ë ¥ ì¬ê³„ì‚° ì™„ë£Œ â†’ ${userIdToFix}:`, power);
}

</script>

<!-- ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ (NPC ë²„ì „) -->
<div id="tutorialOverlay">
  <div class="tutorial-box" style="text-align:center;">
    <img src="images/npc/blacksmith_idle.png"
         alt="ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸"
         class="npc-popup-img">

   <p style="margin:6px 0 10px 0; font-weight:bold;">
  í—ˆí—ˆâ€¦ ì˜ ì™”êµ¬ë§Œ. ë‚˜ëŠ” ì´ ì™•êµ­ ìµœê³ ì˜ ëŒ€ì¥ì¥ì´, í¼ê·¸ë€íŠ¸ë¼ í•˜ì§€.
</p>

<p style="margin:4px 0; text-align:left; line-height:1.45;">
  â€¢ ìƒë‹¨ ì™¼ìª½ì˜ <b>[ì¶œì„]</b> ë²„íŠ¼ì€ ìŠì§€ ë§ê²Œ.<br>
    ë‹¨ë ¨ì—ëŠ” ìê¸ˆì´ í•„ìš”í•œ ë²•ì´ê±°ë“ .<br><br>

  â€¢ ìƒë‹¨ ì˜¤ë¥¸ìª½ <b>[MAP]</b>ì—ì„œëŠ”<br>
    ê·¸ëŒ€ê°€ ê²€ì„ ì‹œí—˜í•  ì‚¬ëƒ¥í„°ë¥¼ ê³ ë¥¼ ìˆ˜ ìˆë‹¤ë„¤.<br><br>

  â€¢ í™”ë©´ ì¤‘ì•™ì˜ <b>ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤</b> ë²„íŠ¼â€¦<br>
    ì´ê²ƒë“¤ì´ì•¼ë§ë¡œ ëª¨í—˜ê°€ì˜ ê¸¸ì„ ì¢Œìš°í•˜ëŠ” í•µì‹¬ì´ì§€.<br><br>

  â€¢ ì˜¤ë¥¸ìª½ ì•„ë˜ <b>ì¸ë²¤í† ë¦¬ / ë¡œê·¸</b>ëŠ”<br>
    ê·¸ëŒ€ê°€ ê±¸ì–´ì˜¨ ë°œìì·¨ë¥¼ ë‚¨ê²¨ ë‘ëŠ” ê³³ì´ë¼ë„¤.<br><br>

  â€¢ ê°€ëŠ¥í•˜ë‹¤ë©´ <b>ì „ì²´í™”ë©´</b>ìœ¼ë¡œ ì¦ê¸°ê²Œ.<br>
    ì„¸ê³„ë¥¼ ë„“ê²Œ ë³¼ìˆ˜ë¡, ê²€ë„ í¬ê²Œ ì„±ì¥í•˜ë‹ˆê¹Œ ë§ì´ì•¼.
</p>

    <button class="tutorial-close-btn" onclick="closeTutorial()">
      ì•Œê² ë„¤
    </button>
  </div>
</div>

<!-- ğŸ§” ëŒ€ì¥ì¥ì´ / ë¬´ê¸°ìƒì¸ ê³µìš© NPC íŒì—… -->
<div id="npcPopup">
  <div class="npc-popup-inner">

    <!-- ğŸ†• NPC ì´ë¦„í‘œ -->
    <div id="npcPopupName"
         style="font-weight:bold; font-size:15px; margin-bottom:6px;">
    </div>

    <img id="npcPopupImg"
         src="images/npc/blacksmith_idle.png"
         class="npc-popup-img">

    <div class="npc-popup-text" id="npcPopupText"></div>

    <div style="margin-top:10px;">
      <button class="npc-popup-btn" id="npcConfirmBtn">í™•ì¸</button>
      <button class="npc-popup-btn" id="npcCancelBtn" style="display:none;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

  <!-- âš”ï¸ ê²°íˆ¬ VS ì—°ì¶œ ì˜¤ë²„ë ˆì´ -->
<div id="duelBattleOverlay">
  <div class="duel-battle-inner">
    <div class="duel-battle-title">âš”ï¸ ê²°íˆ¬ ê°œì‹œ</div>

    <div class="duel-battle-row">
      <!-- ì™¼ìª½: ë‚˜ -->
      <div class="duel-side">
        <div class="duel-user-name" id="duelMyName"></div>
        <div class="duel-weapon-name" id="duelMyWeapon"></div>
        <div class="duel-weapon-img-box">
          <img id="duelMyWeaponImg" src="" alt="ë‚´ ë¬´ê¸°">
        </div>
        <div class="duel-power" id="duelMyPower"></div>
      </div>

      <div class="duel-vs-text">VS</div>

      <!-- ì˜¤ë¥¸ìª½: ìƒëŒ€ -->
      <div class="duel-side">
        <div class="duel-user-name" id="duelTargetName"></div>
        <div class="duel-weapon-name" id="duelTargetWeapon"></div>
        <div class="duel-weapon-img-box">
          <img id="duelTargetWeaponImg" src="" alt="ìƒëŒ€ ë¬´ê¸°">
        </div>
        <div class="duel-power" id="duelTargetPower"></div>
      </div>
    </div>

    <div class="duel-battle-sub">
      ì ì‹œ í›„ ì „íˆ¬ ê²°ê³¼ê°€ ê³µê°œë©ë‹ˆë‹¤...
    </div>
  </div>
</div>

<!-- ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì—†ìŒ) -->
<div id="otherProfileOverlay">
  <div class="other-profile-card">
    <div class="other-profile-header">
      <div id="otherProfileNickname" class="profile-nickname">-</div>

      <!-- âœ… ìš°ì¸¡ ìƒë‹¨ X ë²„íŠ¼ í•˜ë‚˜ë§Œ -->
      <button
        id="otherProfileCloseBtn"
        class="other-profile-close-btn">
        &times;
      </button>
    </div>

    <div class="profile-card-inner">
      <div class="profile-weapon-box">
        <img id="otherWeaponImage"
             src="images/weapons/sword_real_temp.png"
             alt="ë¬´ê¸°">
      </div>

      <div class="profile-info-box">
        <div id="otherProfileWeaponTitle" class="profile-weapon-title">-</div>

        <hr class="profile-inner-divider">

        <div id="otherProfileWeaponDesc" class="profile-weapon-desc">-</div>

        <hr class="profile-inner-divider">

        <div class="profile-row">
          <span class="profile-label">ìµœëŒ€ ê°•í™”</span>
          <span class="profile-value" id="otherProfileMaxInfo">-</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ì „íˆ¬ë ¥</span>
          <span class="profile-value" id="otherProfilePower">0</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ê³¨ë“œ</span>
          <span class="profile-value" id="otherProfileGold">0</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ë¬´ê¸°ê°€ì¹˜</span>
          <span class="profile-value" id="otherProfileWeaponValue">0</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ì „ì </span>
          <span class="profile-value" id="otherProfileRecord">ìŠ¹ 0 / íŒ¨ 0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ’ ì•„ì´í…œ ìƒì„¸ í‘œì‹œ ì˜¤ë²„ë ˆì´ -->
<div id="itemDetailOverlay">
  <div id="itemDetailBox">
    <img id="itemDetailImg" src="" alt="">
    <div id="itemDetailName"></div>
    <div id="itemDetailDesc"></div>
  </div>
</div>

  <!-- ğŸŒ ì „ ì„œë²„ ë„ì „ ì•Œë¦¼ ë°°ë„ˆ -->
  <div id="worldBanner"></div>
  
<div id="upgradeFlashOverlay"></div>

<!-- ğŸ·ï¸ ì—…ì (ì¹­í˜¸) ì˜¤ë²„ë ˆì´ -->
<div id="titleOverlay" class="titleOverlay"
     onclick="if(event.target===this) closeTitleOverlay();">
  <div class="titlePanel" onclick="event.stopPropagation();">

    <!-- í—¤ë” -->
    <div class="titleHeader">
      <div class="titleHeaderLeft">ì—…ì (ì¹­í˜¸)</div>

      <div class="titleHeaderRight">
        <button id="titleSortBtn" class="titleBtn">ìµœê·¼íšë“ìˆœ</button>
        <button class="titleBtn titleBtnClose" onclick="closeTitleOverlay()">âœ•</button>
      </div>
    </div>

    <!-- ì¥ì°©ì¤‘ -->
    <div class="titleEquippedRow">
      ì¥ì°©ì¤‘: <span id="equippedTitleText">(ì—†ìŒ)</span>
    </div>

    <!-- ê·¸ë¦¬ë“œ -->
    <div id="titleGrid" class="titleGrid"></div>

<!-- NPC/ëŒ€ì‚¬ -->
<div class="titleNpcWrap">
  <div class="titleNpcTalk">
    <div class="titleNpcName">ì„œê¸°ê´€ ë¦¬ë„¤ì•„</div>
    <div id="titleNpcText">ì¹­í˜¸ëŠ” ëª…ì˜ˆì´ì ê¸°ë¡ì´ì•¼! ì–´ë–¤ ê±¸ ë‹¬ì•„ë³¼ë˜?</div>
  </div>

  <img id="titleNpcImg"
       class="titleNpcImg"
       src="images/npc/linea_idle.png"
       alt="ë¦¬ë„¤ì•„"
       draggable="false">
</div>
    </div>

  </div>
</div>

  <!-- ğŸŒ™ +30 ê¸€ë¡œë²Œ ì—°ì¶œ ì˜¤ë²„ë ˆì´ -->
<div id="global30Overlay" style="display:none;">
  <div class="global30-backdrop"></div>
  <div class="global30-box">
    <div id="global30Title" class="global30-title"></div>
    <div id="global30Desc" class="global30-desc"></div>
    <button class="global30-btn" onclick="closeGlobal30Overlay()">í™•ì¸</button>
  </div>
</div>

  
</body>
</html>
