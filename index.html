<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê²€ í‚¤ìš°ê¸°</title>

<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
  margin:0;
}

/* ë¡œê·¸ì¸ */
#loginScreen {
  max-width:360px;
  margin:120px auto;
  padding:20px;
  border:1px solid #444;
  background:#000;
}
#loginScreen input {
  width:90%;
  padding:10px;
  font-size:16px;
  margin:6px 0;
}

/* ë²„íŠ¼ */
button {
  padding:12px 26px;
  font-size:18px;
  margin:8px;
  cursor:pointer;
}

/* ë¬´ì§€ê°œ */
.rainbow {
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 2s linear infinite;
  display:inline-block;
}
@keyframes rainbow {
  from {background-position:0%}
  to {background-position:100%}
}

/* ë¡œê·¸ í† ìŠ¤íŠ¸ */
#toastLog {
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:600px;
  background:rgba(0,0,0,0.75);
  border:1px solid #444;
  padding:6px;
  font-size:14px;
}
.toast-item {
  padding:4px 0;
  border-bottom:1px solid #333;
}
.toast-destroy {
  color:red;
  font-weight:bold;
}

/* ë¡œê·¸ íŒ¨ë„ */
#logToggle {
  position:fixed;
  bottom:90px;
  right:10px;
}
#logPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:90%;
  max-width:420px;
  height:60%;
  background:rgba(0,0,0,0.9);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  display:none;
}
</style>
</head>

<body>

<!-- ë¡œê·¸ì¸ -->
<div id="loginScreen">
  <h2>ğŸ” ë¡œê·¸ì¸</h2>
  <input id="loginId" placeholder="ì•„ì´ë””">
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <br>
  <button onclick="login()">ì ‘ì†</button>
</div>

<!-- ê²Œì„ -->
<div id="gameScreen" style="display:none;">

<h1>âš”ï¸ ê²€ í‚¤ìš°ê¸°</h1>

<div id="status"></div>
<div id="upgradeInfo"></div>

<button onclick="upgrade()">ğŸ”¨ ê°•í™”</button>
<button onclick="hunt()">âš”ï¸ ì‚¬ëƒ¥</button>

<hr>
<h2>ğŸ† ë­í‚¹ TOP 10</h2>
<div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
/* Firebase ì„¤ì • */
firebase.initializeApp({
  apiKey: "AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  authDomain: "sword-game-1d1a1.firebaseapp.com",
  databaseURL: "https://sword-game-1d1a1-default-rtdb.firebaseio.com",
  projectId: "sword-game-1d1a1"
});
const db = firebase.database();
const logRef = db.ref("logs");

/* ìƒíƒœ */
let sword=1, power=10, gold=100;
let userId="", userPassword="", userRef=null;

/* ìƒ‰ìƒ */
function getSwordColor(l){
  if(l>=30)return"rainbow";
  if(l==29)return"gold";
  if(l==28)return"silver";
  if(l==27)return"hotpink";
  if(l==26)return"brown";
  if(l==25)return"purple";
  if(l==24)return"dodgerblue";
  if(l==23)return"limegreen";
  if(l==22)return"yellow";
  if(l==21)return"red";
  return"white";
}
function coloredLevel(l){
  if(l>=30)return `<span class="rainbow">+${l}ê°•</span>`;
  return `<span style="color:${getSwordColor(l)};font-weight:bold;">+${l}ê°•</span>`;
}

/* í™•ë¥  */
function getUpgradeChance(l){
  if(l<10)return80;
  if(l<20)return40;
  if(l<25)return20;
  return5;
}

/* UI */
function update(){
  document.getElementById("status").innerHTML=`
    ğŸ”° ê°•í™”: <b>+${sword}ê°•</b><br>
    âš”ï¸ ê³µê²©ë ¥: <b>${power}</b><br>
    ğŸ’° ê³¨ë“œ: <b>${gold}</b>
  `;
  document.getElementById("upgradeInfo").innerHTML=`
    ì„±ê³µí™•ë¥ : ${getUpgradeChance(sword)}% / í•„ìš” ê³¨ë“œ: 20
  `;
}

/* ê°•í™” */
function upgrade(){
  if(sword>=30){alert("ì´ë¯¸ ìµœëŒ€ ê°•í™”!");return;}
  if(gold<20){alert("ê³¨ë“œ ë¶€ì¡±!");return;}
  gold-=20;

  const chance=getUpgradeChance(sword);
  const before=sword;

  if(Math.random()<chance/100){
    sword++; power+=5;
    alert(`âœ¨ ê°•í™” ì„±ê³µ! +${sword}ê°•`);
    if(before>=20){
      writeLog(`${userId}ì´ ${coloredLevel(before)} ë„ì „ì— ì„±ê³µí•˜ì—¬ ${coloredLevel(sword)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    }
  }else{
    const safe=[5,10,15,20,25];
    if(safe.includes(sword)){
      alert("ê°•í™” ì‹¤íŒ¨â€¦ í•˜ì§€ë§Œ ë³´í˜¸!");
    }else if(sword<=20){
      sword--; power-=5;
      alert("ê°•í™” ì‹¤íŒ¨! ë‹¨ê³„ í•˜ë½");
    }else{
      if(Math.random()<0.4){
        sword--; power-=5;
        alert("ê°•í™” ì‹¤íŒ¨! ë‹¨ê³„ í•˜ë½");
      }else{
        sword=1; power=10;
        alert("ğŸ’£ ê²€ íŒŒê´´!");
        writeLog(`${userId}ì´ ${coloredLevel(before)} ë„ì „ì— ì‹¤íŒ¨í•˜ì—¬ <span style="color:red;font-weight:bold;">íŒŒê´´</span> ë˜ì—ˆìŠµë‹ˆë‹¤!`,true);
      }
    }
  }
  update(); save();
}

/* ì‚¬ëƒ¥ */
function hunt(){
  const earn=Math.floor(Math.random()*power);
  gold+=earn;
  alert(`ì‚¬ëƒ¥ ì„±ê³µ! ê³¨ë“œ +${earn}`);
  update(); save();
}

/* ë¡œê·¸ì¸ */
function login(){
  userId=loginId.value.trim();
  userPassword=loginPw.value;
  if(!userId||!userPassword){alert("ì…ë ¥ í•„ìš”");return;}
  userRef=db.ref("users/"+userId);
  userRef.once("value").then(s=>{
    if(!s.exists()){
      userRef.set({password:userPassword,sword, power, gold});
    }else{
      if(s.val().password!==userPassword){alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");return;}
      sword=s.val().sword; power=s.val().power; gold=s.val().gold;
    }
    loginScreen.style.display="none";
    gameScreen.style.display="block";
    update(); loadRanking();
  });
}

/* ì €ì¥ */
function save(){
  if(!userRef)return;
  userRef.update({sword,power,gold,updated:Date.now()});
  loadRanking();
}

/* ë­í‚¹ */
function loadRanking() {
  db.ref("users")
    .once("value", snapshot => {

      let list = [];

      snapshot.forEach(child => {
        const data = child.val();

        // ğŸ”’ sword ê°’ ì—†ëŠ” ìœ ì € ë°©ì–´
        const swordLevel = (data && typeof data.sword === "number")
          ? data.sword
          : 1;

        list.push({
          id: child.key,
          sword: swordLevel
        });
      });

      // ê°•í™” ë†’ì€ ìˆœ ì •ë ¬
      list.sort((a, b) => b.sword - a.sword);

      // TOP 10ë§Œ
      list = list.slice(0, 10);

      if (list.length === 0) {
        document.getElementById("ranking").innerHTML = "ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      let html = "";
      list.forEach((u, i) => {
        html += `
          <div style="font-weight:bold;">
            ${i + 1}. ${u.id} | ${coloredLevel(u.sword)}
          </div>
        `;
      });

      document.getElementById("ranking").innerHTML = html;
    });
}


/* ë¡œê·¸ */
function writeLog(msg,isDestroy=false){
  logRef.push({message:msg,isDestroy,time:Date.now()});
}
logRef.limitToLast(50).on("child_added",s=>{
  const d=s.val();
  const t=new Date(d.time).toLocaleTimeString();
  const div=document.createElement("div");
  div.className="toast-item"+(d.isDestroy?" toast-destroy":"");
  div.innerHTML=`[${t}] ${d.message}`;
  toastList.prepend(div);
  while(toastList.children.length>5)toastList.lastChild.remove();
});

/* ë¡œê·¸ íŒ¨ë„ */
function toggleLog(){
  logPanel.style.display=logPanel.style.display==="none"?"block":"none";
}
</script>

<div id="toastLog"><div id="toastList"></div></div>
<button id="logToggle" onclick="toggleLog()">ğŸ“œ ë¡œê·¸</button>
<div id="logPanel"><h3>ğŸ“¢ ê°•í™” ë¡œê·¸</h3><div id="logPanelList"></div></div>

</body>
</html>
