<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê²€ í‚¤ìš°ê¸°</title>

<style>
body{
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
  margin:0;
}

/* ë¡œê·¸ì¸ */
#loginScreen{
  max-width:360px;
  margin:120px auto;
  padding:20px;
  border:1px solid #444;
  background:#000;
}
#loginScreen input{
  width:90%;
  padding:10px;
  font-size:16px;
  margin:6px 0;
}

/* ë²„íŠ¼ */
button{
  padding:12px 26px;
  font-size:18px;
  margin:8px;
  cursor:pointer;
}

/* ìƒíƒœ UI */
#status, #upgradeInfo{
  margin:10px auto;
  max-width:360px;
  padding:12px;
  border:1px solid #444;
  background:#000;
  font-size:16px;
}

/* ë¬´ì§€ê°œ */
.rainbow{
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 2s linear infinite;
}
@keyframes rainbow{
  from{background-position:0%}
  to{background-position:100%}
}

/* ë¡œê·¸ */
#toastLog{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:600px;
  background:rgba(0,0,0,0.75);
  border:1px solid #444;
  padding:6px;
  font-size:14px;
}
.toast-item{padding:4px 0;border-bottom:1px solid #333;}
.toast-destroy{color:red;font-weight:bold;}

#logToggle{position:fixed;bottom:90px;right:10px;}
#logPanel{
  position:fixed;
  top:60px;
  right:10px;
  width:90%;
  max-width:420px;
  height:60%;
  background:rgba(0,0,0,0.9);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  display:none;
}
</style>
</head>

<body>

<div id="loginScreen">
  <h2>ğŸ” ë¡œê·¸ì¸</h2>
  <input id="loginId" placeholder="ì•„ì´ë””">
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <br>
  <button onclick="login()">ì ‘ì†</button>
</div>

<div id="gameScreen" style="display:none;">
  <h1>âš”ï¸ ê²€ í‚¤ìš°ê¸°</h1>
  <div id="status"></div>
  <div id="upgradeInfo"></div>
  <button onclick="upgrade()">ğŸ”¨ ê°•í™”</button>
  <button onclick="hunt()">âš”ï¸ ì‚¬ëƒ¥</button>
  <hr>
  <h2>ğŸ† ë­í‚¹ TOP 10</h2>
  <div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  authDomain:"sword-game-1d1a1.firebaseapp.com",
  databaseURL:"https://sword-game-1d1a1-default-rtdb.firebaseio.com",
  projectId:"sword-game-1d1a1"
});
const db=firebase.database();
const logRef=db.ref("logs");

let sword=1,power=10,gold=100;
let userId="",userRef=null;

/* í™•ë¥  ìœ ì§€ */
function getUpgradeChance(l){
  if(l<10)return 80;
  if(l<20)return 40;
  if(l<25)return 20;
  return 5;
}

/* UI */
function update(){
  status.innerHTML=`
    ğŸ”° ê°•í™” ë‹¨ê³„: <b>+${sword}ê°•</b><br>
    âš”ï¸ ê³µê²©ë ¥: <b>${power}</b><br>
    ğŸ’° í˜„ì¬ ê³¨ë“œ: <b>${gold}</b>
  `;
  upgradeInfo.innerHTML=`ì„±ê³µí™•ë¥ : ${getUpgradeChance(sword)}% / í•„ìš” ê³¨ë“œ: 20`;
}

/* ê°•í™” ë¡œì§ (ìš”ì²­ì‚¬í•­ ì •í™•íˆ ë°˜ì˜) */
function upgrade(){
  if(sword>=30){alert("ì´ë¯¸ ìµœëŒ€ ê°•í™”!");return;}
  if(gold<20){alert("ê³¨ë“œ ë¶€ì¡±!");return;}
  gold-=20;

  const chance=getUpgradeChance(sword);
  const before=sword;

  if(Math.random()<chance/100){
    sword++; power+=5;
    alert(`âœ¨ ê°•í™” ì„±ê³µ! +${sword}ê°•`);
    if(before>=20){
      writeLog(`${userId}ì´ +${before}ê°• â†’ +${sword}ê°• ê°•í™” ì„±ê³µ`);
    }
  }else{
    // 1~10ê°• : ì‹¤íŒ¨ë§Œ
    if(sword<=10){
      alert("ê°•í™” ì‹¤íŒ¨!");
    }
    // 11~20ê°• : ì‹¤íŒ¨ or ê°•ë“±
    else if(sword<=20){
      sword--; power-=5;
      alert("ê°•í™” ì‹¤íŒ¨! ë‹¨ê³„ í•˜ë½");
    }
    // 21~30ê°• : ì‹¤íŒ¨ / ê°•ë“± / íŒŒê´´
    else{
      if(Math.random()<0.4){
        sword--; power-=5;
        alert("ê°•í™” ì‹¤íŒ¨! ë‹¨ê³„ í•˜ë½");
      }else{
        sword=1; power=10;
        alert("ğŸ’£ ê²€ íŒŒê´´!");
        writeLog(`${userId}ì˜ ê²€ì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤!`,true);
      }
    }
  }
  update(); save();
}

/* ì‚¬ëƒ¥ */
function hunt(){
  const earn=Math.floor(Math.random()*power);
  gold+=earn;
  alert(`ì‚¬ëƒ¥ ì„±ê³µ! ê³¨ë“œ +${earn}`);
  update(); save();
}

/* ë¡œê·¸ì¸ */
function login(){
  userId=loginId.value.trim();
  const pw=loginPw.value;
  if(!userId||!pw){alert("ì…ë ¥ í•„ìš”");return;}

  userRef=db.ref("users/"+userId);
  userRef.once("value").then(s=>{
    if(!s.exists()){
      userRef.set({password:pw,sword,power,gold,updated:Date.now()});
    }else{
      if(s.val().password!==pw){alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");return;}
      sword=s.val().sword; power=s.val().power; gold=s.val().gold;
    }
    loginScreen.style.display="none";
    gameScreen.style.display="block";
    setTimeout(update,0); // âœ… UI ë³´ì¥
    loadRanking();
  });
}

/* ì €ì¥ */
function save(){
  if(!userRef)return;
  userRef.update({sword,power,gold,updated:Date.now()});
  loadRanking();
}

/* ë­í‚¹ */
function loadRanking(){
  db.ref("users").once("value").then(s=>{
    let list=[];
    s.forEach(c=>{
      const v=c.val();
      list.push({id:c.key,sword:v.sword||1,gold:v.gold||0});
    });
    list.sort((a,b)=>b.sword-a.sword);
    ranking.innerHTML=list.slice(0,10).map((u,i)=>
      `<div style="font-weight:bold">
        ${i+1}. ${u.id} | +${u.sword}ê°• | ğŸ’° ${u.gold}
      </div>`
    ).join("");
  });
}

/* ë¡œê·¸ */
function writeLog(msg,isDestroy=false){
  logRef.push({message:msg,isDestroy,time:Date.now()});
}
</script>

<div id="toastLog"><div id="toastList"></div></div>
<button id="logToggle" onclick="logPanel.style.display=logPanel.style.display==='none'?'block':'none'">ğŸ“œ ë¡œê·¸</button>
<div id="logPanel"><h3>ğŸ“¢ ê°•í™” ë¡œê·¸</h3><div id="logPanelList"></div></div>

</body>
</html>
