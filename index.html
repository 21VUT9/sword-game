<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„</title>

<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
}

  /* âœ… PC ê³¼ë„í•œ ê°€ë¡œ í™•ì¥ ë°©ì§€ìš© í”„ë ˆì„ (ëª¨ë°”ì¼ ì˜í–¥ ì—†ìŒ) */
:root{
  --frame-max: 1000px;
  --frame-pad: 0px; /* ê¸°ë³¸(ëª¨ë°”ì¼/ì¢ì€ í™”ë©´) */
  --workbench-h: 200px; /* âœ… ì‘ì—…ëŒ€ ë†’ì´ */
  --field-top-offset: 110px;
}

@media (min-width: 1001px){
  :root{
    /* í™”ë©´ì´ í”„ë ˆì„ë³´ë‹¤ ë„“ì–´ì§ˆ ë•Œ ì¢Œìš° ì—¬ë°±(ì–‘ìª½) ê³„ì‚° */
    --frame-pad: max((100vw - var(--frame-max)) / 2, 0px);
    --workbench-h: 200px;
  }
}

/* ì‹¤ì œ í”„ë ˆì„ */
#appFrame{
  width: 100%;
  max-width: var(--frame-max);
  margin: 0 auto;
  position: relative;
}

/* ğŸ¯ ê°•í™” ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ ì¤„ ì •ë¦¬ */
#upgradeItems {
  display: flex;
  flex-wrap: wrap;           /* í™”ë©´ ì¢ìœ¼ë©´ ë¼ë²¨ ë‹¨ìœ„ë¡œ ë‹¤ìŒ ì¤„ë¡œ ë‚´ë ¤ê°€ê²Œ */
  justify-content: center;
  gap: 4px 12px;             /* ë¼ë²¨ ì‚¬ì´ ê°„ê²© */
}
  
#upgradeItems label {
  white-space: nowrap;       /* ğŸ”¥ ë¼ë²¨ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ ê¸ˆì§€ (í•­ìƒ í•œ ì¤„) */
}

/* ê³µìš© ì•¡ì…˜ íŒì—… ë²„íŠ¼ (ê²Œì„ ë²„íŠ¼ ëŠë‚Œ) */
.actionBtn{
  width: 100%;
  margin: 6px 0;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.06);
  color: #fff;
  font-weight: 800;
  cursor: pointer;
}

.actionBtn:hover{
  background: rgba(255,255,255,0.10);
}

.actionText{
  color: #ddd;
  font-size: 12px;
  line-height: 1.35;
  padding: 6px 4px;
  white-space: pre-line; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
}

.actionTitle{
  font-weight: 900;
  margin-bottom: 6px;
  color: #fff;
}
  
/* ğŸ”¨ ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤ ë²„íŠ¼ ë¬¶ìŒ */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 8px;
  flex-wrap: nowrap;
  margin-top: 6px;
}

.action-buttons button {
  flex: 0 0 auto;        /* ë²„íŠ¼ í­ì„ ê¸€ì ê¸¸ì´ì— ë§ê²Œ */
  padding: 10px 18px;    /* ê°€ë¡œ íŒ¨ë”© ì¤„ì—¬ì„œ í­ í™•ë³´ */
  font-size: 16px;       /* ê¸€ì ì¡°ê¸ˆë§Œ ì¤„ì´ê¸° */
  margin: 0;             /* ê³µìš© button ë§ˆì§„ ì œê±° */
  white-space: nowrap;   /* ğŸ”¥ ë²„íŠ¼ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
}

  /* =========================
   ğŸ”¨/âš”ï¸/ğŸ’° ë²„íŠ¼: ì´ë¯¸ì§€ ë² ì´ìŠ¤ ì ìš©
   ========================= */
.action-buttons button{
  position: relative;
  width: 220px;                 /* âœ… ê°€ë¡œ í¬ê¸°(ì›í•˜ë©´ ì¡°ì ˆ) */
  aspect-ratio: 2.4 / 1;        /* âœ… ë„¤ ì´ë¯¸ì§€ ë¹„ìœ¨ */
  height: auto;

  padding: 0;                   /* âœ… ì´ë¯¸ì§€ ë²„íŠ¼ì´ë¼ íŒ¨ë”© ì œê±° */
  border: 0;
  border-radius: 12px;          /* (ì´ë¯¸ì§€ ëª¨ì„œë¦¬ ë‘¥ê¸€ë©´ ë§ì¶°) */
  background: transparent;
  color: #f2f2f2;               /* í…ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ ìœ„ì— */
  font-weight: 900;
  font-size: 18px;
    /* âœ… í…ìŠ¤íŠ¸ ê°€ë…ì„± ê°•í™”: í°ìƒ‰ + ê²€ì€ í…Œë‘ë¦¬ */
  color: #ffffff;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0   2px  3px rgba(0,0,0,0.9);

  cursor: pointer;

  /* âœ… ì´ë¯¸ì§€ ê¹”ê¸° */
  background-image: url("images/ui/btn_base_forge.png");
  background-size: 100% 100%;
  background-repeat: no-repeat;
  background-position: center;

  /* âœ… íŒŒë€ìƒ‰ í´ë¦­/íƒ­ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;

  /* âœ… ì„ íƒ/ë“œë˜ê·¸ ë°©ì§€ (í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ë°©ì§€) */
  user-select: none;
  -webkit-user-select: none;

  /* ì‚´ì§ ì…ì²´ê°(ì›í•˜ë©´ ì œê±° ê°€ëŠ¥) */
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,0.10),
    inset 0 -2px 3px rgba(0,0,0,0.45),
    0 6px 12px rgba(0,0,0,0.55);

  transition: transform 0.08s ease, filter 0.12s ease;
}

/* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ ë°ê²Œ */
.action-buttons button:hover{
  filter: brightness(1.08);
}

/* ëˆŒë¦´ ë•Œ ì‚´ì§ ë‚´ë ¤ê°€ëŠ” ëŠë‚Œ */
.action-buttons button:active{
  transform: translateY(2px);
  filter: brightness(0.95);
}

/* í¬ì»¤ìŠ¤ í…Œë‘ë¦¬ë„ ì œê±° (í‚¤ë³´ë“œ í¬ì»¤ìŠ¤ ì›ì¹˜ ì•Šìœ¼ë©´) */
.action-buttons button:focus{
  outline: none;
}
.action-buttons button:focus-visible{
  outline: none;
}

/* ğŸ’° ì‚¬ëƒ¥ ë²„íŠ¼ ë™ì „ íŒ ì´í™íŠ¸ */
.hunt-coin-pop{
  position: fixed;
  z-index: 999999;
  pointer-events: none;
  font-size: 22px;
  transform: translate(-50%, 0);
  opacity: 0;
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.35));
  animation: huntCoinPop 720ms ease-out forwards;
}

@keyframes huntCoinPop{
  0%   { opacity: 0; transform: translate(-50%, 10px) scale(0.85); }
  15%  { opacity: 1; transform: translate(-50%, -6px) scale(1.05); }
  100% { opacity: 0; transform: translate(-50%, -34px) scale(1.0); }
}

/* ğŸ“· í”„ë¡œí•„ ì €ì¥ ìº¡ì³ ëª¨ë“œ */
.capture-mode * {
  visibility: hidden !important;
}

/* ğŸ¦  ì—­ë³‘ì¥ ë°˜ì§ í…ìŠ¤íŠ¸ */
.title-plague {
  font-weight: bold;
  background: linear-gradient(90deg, #00c853, #b9ffcc, #00c853);
  background-size: 200% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  text-shadow: 0 0 10px rgba(0, 200, 83, 0.35);
  animation: plagueShine 1.6s linear infinite;
}

/* ğŸ”´ ì›”ë“œì±”í”¼ì–¸(ì„œë²„ìµœì´ˆ) - ì—­ë³‘ì¥ ëŠë‚Œì˜ ë°˜ì§ ë¶‰ì€ ê¸€ë¡œìš° */
@keyframes redGlowPulse {
  0% {
    text-shadow:
      0 0 4px rgba(255, 0, 0, 0.30),
      0 0 10px rgba(255, 0, 0, 0.25),
      0 0 16px rgba(255, 60, 60, 0.18);
    filter: saturate(1.05);
  }
  45% {
    text-shadow:
      0 0 6px rgba(255, 0, 0, 0.55),
      0 0 14px rgba(255, 0, 0, 0.40),
      0 0 22px rgba(255, 80, 80, 0.26);
    filter: saturate(1.25);
  }
  55% {
    text-shadow:
      0 0 10px rgba(255, 20, 20, 0.95),
      0 0 20px rgba(255, 20, 20, 0.55),
      0 0 34px rgba(255, 120, 120, 0.35);
    filter: saturate(1.4);
  }
  100% {
    text-shadow:
      0 0 4px rgba(255, 0, 0, 0.30),
      0 0 10px rgba(255, 0, 0, 0.25),
      0 0 16px rgba(255, 60, 60, 0.18);
    filter: saturate(1.05);
  }
}

.title-redglow {
  color: #ff3b3b !important;
  font-weight: 900 !important;
  animation: redGlowPulse 1.25s infinite ease-in-out;
}
  
@keyframes plagueShine {
  0%   { background-position: 0% 50%; }
  100% { background-position: 200% 50%; }
}
  
/* ğŸ”— ë­í‚¹ì—ì„œ ë‹‰ë„¤ì„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
.rank-user {
  cursor: pointer;
  text-decoration: none;   /* â† ë°‘ì¤„ ì œê±° */
}

.rank-user:hover {
  color: #ffd700;          /* ìƒ‰ìƒë§Œ ê°•ì¡° */
}

/* ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ëœ¨ëŠ” ì‘ì€ ë©”ë‰´ */
#rankProfileMenu {
  position: absolute;
  display: none;
  background: rgba(0,0,0,0.95);
  border: 1px solid #555;
  border-radius: 6px;
  padding: 4px 6px;
  z-index: 1500;
}
#rankProfileMenu button {
  font-size: 13px;
  padding: 4px 8px;
}

  /* ğŸ“Œ ê³µì§€ NEW ë±ƒì§€ */
.badge-new {
  display: inline-block;
  margin-left: 6px;
  padding: 1px 6px;
  font-size: 10px;
  font-weight: bold;
  color: #fff;
  background: #ff4d4d;
  border-radius: 10px;
}
  
/* ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ì˜¤ë²„ë ˆì´ */
#otherProfileOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2100;
}

.other-profile-card {
  background: #222;
  border: 1px solid #555;
  border-radius: 12px;
  padding: 14px 12px 16px 12px;
  max-width: 340px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px rgba(0,0,0,0.9);
}

.other-profile-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 4px;
}

.other-profile-close-btn {
  background: transparent;
  border: none;
  color: #fff;
  font-size: 18px;
  padding: 0 6px;
  cursor: pointer;
}

.other-profile-close-btn:hover {
  color: #ff6666;
}
  
/* â¬œ fieldBg ì˜ì—­ë§Œ ë³´ì´ê²Œ */
.capture-mode #fieldBg,
.capture-mode #fieldBg * {
  visibility: visible !important;
}

/* â„ï¸ ë§ˆë‚˜ì‹¤ë“œ í™œì„±í™” ì‹œ ë³´ìŠ¤ íŒŒë€ ê¸€ë¡œìš° */
.boss-mana-shield {
  /* âœ… í° ì½”ì–´ + íŒŒë‘ + ë³´ë¼ ì™¸ê³½ (ë°°ê²½ì— ë¬»íˆì§€ ì•Šê²Œ ëŒ€ë¹„ ê°•í™”) */
  filter:
    drop-shadow(0 0 5px  rgba(255,255,255,0.95))
    drop-shadow(0 0 12px rgba(120,200,255,0.85))
    drop-shadow(0 0 26px rgba(90,170,255,0.55))
    drop-shadow(0 0 44px rgba(170,90,255,0.35));
  animation: manaShieldPulse 1.9s ease-in-out infinite;
  will-change: filter;
}

/* âœ… ëŠë¦° í„ìŠ¤(ìˆ¨ ì‰¬ë“¯) */
@keyframes manaShieldPulse {
  0%, 100% {
    filter:
      drop-shadow(0 0 4px  rgba(255,255,255,0.85))
      drop-shadow(0 0 10px rgba(120,200,255,0.75))
      drop-shadow(0 0 22px rgba(90,170,255,0.45))
      drop-shadow(0 0 38px rgba(170,90,255,0.28));
  }
  50% {
    filter:
      drop-shadow(0 0 7px  rgba(255,255,255,1.00))
      drop-shadow(0 0 16px rgba(140,220,255,0.95))
      drop-shadow(0 0 34px rgba(90,170,255,0.65))
      drop-shadow(0 0 56px rgba(180,110,255,0.42));
  }
}

  /* â„ï¸ ë§ˆë‚˜ì‹¤ë“œ íŒŒê´´ ìˆœê°„ */
.boss-mana-shield-break {
  animation: shieldBreakFlash 0.6s ease-out;
}

@keyframes shieldBreakFlash {
  0%   { filter: drop-shadow(0 0 40px rgba(180,220,255,1)); }
  100% { filter: none; }
}

/* ===========================
   ğŸ“· ìº¡ì³ ì‹œ ìˆ¨ê¸¸ ìš”ì†Œ
   =========================== */

/* ğŸ”» ì¶”ì²œë ˆë²¨ / ì„±ê³µí™•ë¥  ì¤„ ìˆ¨ê¸°ê¸° */
.capture-mode .current-field-info-sub {
  display: none !important;
}

/* ğŸ”» ê°•í™” ì •ë³´ / ë²„íŠ¼ */
.capture-mode #upgradeInfo,
.capture-mode .action-buttons,
.capture-mode #huntInfo,
.capture-mode #upgradeItems {
  display: none !important;
}

/* ğŸ”» ì¶œì„ / ë¡œê·¸ / ë§µ ë²„íŠ¼ / ì¸ë²¤í† ë¦¬ ë“± UI ë²„íŠ¼ */
.capture-mode .side-menu-btn,
.capture-mode #attendanceIconBtn,
.capture-mode #logoutBtn,
.capture-mode #logToggle {
  display: none !important;
}

/* ğŸ”» ì €ì¥ë²„íŠ¼ / ì €ì¥ì¤‘ í‘œì‹œ */
.capture-mode .no-capture,
.capture-mode .profile-share-btn,
.capture-mode .profile-save-status {
  display: none !important;
}

/* â›” (ì•ˆì „ì¥ì¹˜) no-captureëŠ” í•­ìƒ ìº¡ì³ ì¤‘ ìˆ¨ê¹€ */
.capture-mode .no-capture {
  display:none !important;
}
  
/* ìº¡ì²˜ ëª¨ë“œì—ì„œ ìˆ¨ê¸°ê¸° */
.capture-mode #couponBtn {
  display: none !important;
}

/* ğŸ” í–„ë²„ê±° ë²„íŠ¼ (ë” ì •ê°ˆí•˜ê²Œ: ì–‡ì€ ì„ , ë„“ì€ ê°„ê²©, ì¤‘ì•™ì •ë ¬, ë¼ìš´ë“œ ì¶•ì†Œ) */
#hamburgerBtn{
  position: fixed;
  top: 10px;
  right: calc(var(--frame-pad) + 10px);
  z-index: 1105;

  width: 56px;
  height: 56px;
  box-sizing: border-box;

  /* 4) ë¼ìš´ë“œ ì•ˆ ì–´ìš¸ë¦¼ â†’ ê±°ì˜ ê°ì§„ ëŠë‚Œ */
  border-radius: 4px;

  /* ë°•ìŠ¤ëŠ” ì¡´ì¬í•˜ë˜ ê³¼í•˜ì§€ ì•Šê²Œ */
  border: 2px solid rgba(80,80,80,0.9);
  background: rgba(22,22,22,0.78);

  /* íˆ¬ë°•í•œ ê·¸ë¦¼ì ì¤„ì´ê¸° */
  box-shadow: 0 6px 14px rgba(0,0,0,0.45);

  cursor: pointer;
  padding: 0;
  outline: none;

  /* 2) ì¤‘ì•™ ì •ë ¬ í™•ì‹¤í•˜ê²Œ (flexë³´ë‹¤ í”ë“¤ë¦¼ ì ìŒ) */
  display: grid;
  place-items: center;
}

/* í–„ë²„ê±° 3ì¤„ ë˜í¼ì²˜ëŸ¼ ë³´ì´ê²Œ: span 3ê°œë¥¼ ì„¸ë¡œë¡œ ë°°ì¹˜ */
#hamburgerBtn .hb-line{
  display: block;
  width: 28px;

  /* 3) ë‘ê»˜ ì–‡ê²Œ */
  height: 3px;

  background: rgba(235,235,235,0.92);
  border-radius: 2px;
  margin: 0;

  /* ê³¼í•œ ì…ì²´ê° ì œê±° */
  box-shadow: none;
}

/* 1) ì¤„ ê°„ê²© í›¨ì”¬ ë„“ê²Œ â†’ span ê°„ê²©ì€ marginìœ¼ë¡œ */
#hamburgerBtn .hb-line + .hb-line{
  margin-top: 7px; /* âœ… 9~12 ì‚¬ì´ ì·¨í–¥ëŒ€ë¡œ */
}

/* ì‚´ì§ë§Œ ë°˜ì‘ */
#hamburgerBtn:hover{
  background: rgba(30,30,30,0.82);
}
#hamburgerBtn:active{
  transform: scale(0.98);
}

/* ğŸ” ë©”ë‰´ íŒ¨ë„ */
#hamburgerMenu{
  position: fixed;
  top: 48px; /* ë²„íŠ¼ ì•„ë˜ */
  right: calc(var(--frame-pad) + 10px);
  z-index: 1106;
  min-width: 140px;
  padding: 8px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(20,20,20,0.92);
  box-shadow: 0 10px 25px rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
}

#hamburgerMenu .hm-item{
  width: 100%;
  text-align: left;
  font-size: 14px;
  padding: 10px 10px;
  border: 0;
  border-radius: 10px;
  background: rgba(255,255,255,0.06);
  color: #e8e8e8;
  cursor: pointer;
  margin-bottom: 6px;
}
#hamburgerMenu .hm-item:last-child{ margin-bottom: 0; }

#hamburgerMenu .hm-item:hover{
  background: rgba(255,255,255,0.10);
}

/* ìº¡ì²˜ ëª¨ë“œì—ì„œ ìˆ¨ê¸°ê¸° */
.capture-mode #achievementIconBtn{
  display:none !important;
}

/* ë²„íŠ¼ */
button {
  padding:15px 30px;
  font-size:18px;
  margin:10px;
}

  /* âœ… ê°ì¸ ì˜¤ë²„ë ˆì´ ì•ˆì—ì„œëŠ” ì „ì—­ button ê·œì¹™(ë§ˆì§„/íŒ¨ë”©) ë¬´íš¨í™” */
#engraveOverlay button{
  margin: 0 !important;
  padding: 0 !important;
  font-size: inherit !important;
  box-sizing: border-box;
}

/* ğŸŒˆ 30ê°• ë¬´ì§€ê°œ */
.rainbow {
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 2s linear infinite;
  display:inline-block;
}
@keyframes rainbow {
  from {background-position:0%}
  to {background-position:100%}
}

.rainbowStar{
  background: linear-gradient(90deg, #ff4d4d, #ffb84d, #fff04d, #4dff88, #4dd2ff, #7a5cff, #ff4dff);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 900;
  letter-spacing: 1px;
  text-shadow: 0 0 10px rgba(255,255,255,0.25);
}
  
  /* âœ¨ ì‹¤ë²„ / ê³¨ë“œ ë°˜ì§ì„ */
.sparkle-silver {
  color: #C0C0C0;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(192,192,192,0.8);
  animation: sparkle 1.5s infinite alternate;
}

.sparkle-gold {
  color: #FFD700;
  font-weight: bold;
  text-shadow: 0 0 8px rgba(255,215,0,0.9);
  animation: sparkle 1.2s infinite alternate;
}

  /* ğŸ‘‘ ì¹­í˜¸ : ì‹  (ê·¹ì•… ë‚œì´ë„ ì „ìš©) */
.title-god {
  position: relative;
  color:#050505 !important;
  font-weight: 900 !important;
  letter-spacing: 1px;

  text-shadow:
    0 0 2px rgba(255,255,255,0.95),
    0 0 6px rgba(255,255,255,0.85),
    0 0 14px rgba(255,255,255,0.65),
    0 0 26px rgba(255,255,255,0.40);

  animation: godGlowPulse 1.35s infinite ease-in-out;
}
  /* âœ¨ â€œì‹ â€ ì¹­í˜¸ â€“ í° ì…ì ë¨¼ì§€ */
.title-god::after{
  content: "";
  position: absolute;
  inset: -10px;                 /* ê¸€ì ì£¼ë³€ ì‚´ì§ ì—¬ìœ  */
  pointer-events: none;

  /* í° ì…ì íŒ¨í„´ */
  background-image:
    radial-gradient(circle, rgba(255,255,255,0.35) 1px, transparent 1.6px),
    radial-gradient(circle, rgba(255,255,255,0.18) 1px, transparent 1.8px);

  background-size: 18px 18px, 26px 26px;
  background-position: 0 0, 12px 8px;

  opacity: 0.35;
  filter: blur(0.2px);

  animation: godDustFloat 7.5s linear infinite;
}

/* ì•„ì£¼ ëŠë¦¬ê²Œ íë¥´ëŠ” ëŠë‚Œ */
@keyframes godDustFloat{
  from{
    background-position: 0 0, 12px 8px;
  }
  to{
    background-position: 36px 48px, 60px 72px;
  }
}

/* ëŠë¦° ë§¥ë™ â€” â€œì‹ ì€ ì„œë‘ë¥´ì§€ ì•ŠëŠ”ë‹¤â€ */
@keyframes godPulse {
  0% {
    text-shadow:
      0 0 3px  rgba(255,255,255,0.75),
      0 0 8px  rgba(255,255,255,0.65),
      0 0 14px rgba(255,255,255,0.45),
      0 0 24px rgba(255,255,255,0.25);
  }
  50% {
    text-shadow:
      0 0 6px  rgba(255,255,255,1),
      0 0 14px rgba(255,255,255,0.9),
      0 0 26px rgba(255,255,255,0.7),
      0 0 42px rgba(255,255,255,0.45);
  }
  100% {
    text-shadow:
      0 0 3px  rgba(255,255,255,0.75),
      0 0 8px  rgba(255,255,255,0.65),
      0 0 14px rgba(255,255,255,0.45),
      0 0 24px rgba(255,255,255,0.25);
  }
}

/* âœ¨ ê³µí†µ ë°˜ì§ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes sparkle {
  from {
    opacity: 0.85;
    filter: brightness(1);
  }
  to {
    opacity: 1;
    filter: brightness(1.4);
  }

    from { filter: brightness(1); }
  to   { filter: brightness(1.25); }

}

/* ğŸ”¤ ê²€ ì´ë¦„ í•œ ì¤„ í‘œì‹œ (ì¤„ë°”ê¿ˆ ê¸ˆì§€ + ë§ì¤„ì„) */
.profile-weapon-title {
  font-size: 16px;
  font-weight: bold;
  margin: 4px 0 2px 0;
  white-space: nowrap;       /* í•œ ì¤„ ìœ ì§€ */
  overflow: hidden;
  text-overflow: ellipsis;   /* ë„ˆë¬´ ê¸¸ë©´ â€¦ ì²˜ë¦¬ */
}

/* ğŸ“ ê²€ ì„¤ëª… */
.profile-weapon-desc {
  font-size: 13px;
  color: #cccccc;
  line-height: 1.4;
  white-space: pre-line;     /* ìš°ë¦¬ê°€ ì“´ ë¬¸ì¥ êµ¬ì¡° ìœ ì§€ìš© */
  margin-bottom: 2px;
}

/* í”„ë¡œí•„ ì¹´ë“œ ë‚´ë¶€ êµ¬ë¶„ì„  */
.profile-inner-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 6px 0 8px 0;
}
  
/* ğŸ”” í† ìŠ¤íŠ¸ */
#toastLog {
  position:fixed;
  bottom: calc(var(--workbench-h) + 10px);
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:600px;
  background:rgba(0,0,0,0.75);
  border:1px solid #444;
  padding:8px;
  font-size:14px;
  z-index:1000;
  display: none;
}
  /* ğŸ”” ë¡œê·¸ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ */
.toastLog-controls{
  position: absolute;

  bottom: 100%;        /* âœ… ë¡œê·¸ ë°•ìŠ¤ ë°”ë¡œ ìœ„ */
  margin-bottom: 0.5px;  /* âœ… ë¡œê·¸ì™€ 2px ê°„ê²© */

  right: 0.5px;          /* ìš°ì¸¡ ì •ë ¬ (ë¯¸ì„¸ì¡°ì • ê°€ëŠ¥) */

  display: flex;
  gap: 0.5px;
  z-index: 5;
}

.toastLog-controls button{
  font-size:12px;
  padding:2px 8px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,0.25);
  background: rgba(0,0,0,0.35);
  color:#fff;
  cursor:pointer;
  margin: 0;
}

/* ë²„íŠ¼ ë•Œë¬¸ì— ìƒë‹¨ ì—¬ë°± ì‚´ì§ í™•ë³´(í•„ìš”ì‹œ ìˆ«ìë§Œ ì¡°ì ˆ) */
#toastLog{
  position: fixed; /* ê¸°ì¡´ fixedë©´ ê·¸ëŒ€ë¡œ ë‘ê³ , ì•„ë‹ˆë©´ ì´ ì¤„ì€ ë¹¼ë„ ë¨ */
 }

/* âœ… ëª¨ë“œë³„ í‘œì‹œ ì¤„ìˆ˜ ì œì–´ */
#toastLog.log-view-one  #toastList .toast-item:nth-child(n+2){ display:none; }
#toastLog.log-view-five #toastList .toast-item:nth-child(n+6){ display:none; }

  /* âœ… panel ëª¨ë“œ: 12~13ì¤„ ì •ë„ë§Œ ë³´ì´ê³  ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
#toastLog.log-view-panel{
  max-height: 540px;     /* âœ… ëŒ€ëµ 12~13ì¤„ (ì›í•˜ë©´ 300~360 ì‚¬ì´ë¡œ ì¡°ì ˆ) */
  overflow: visible;      /* ë°”ê¹¥ì€ ê³ ì • */
}

/* panel ëª¨ë“œì—ì„œëŠ” ë¦¬ìŠ¤íŠ¸ë§Œ ìŠ¤í¬ë¡¤ */
#toastLog.log-view-panel #toastList{
  max-height: 270px;     /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì˜ì—­ ì œì™¸í•œ ë†’ì´ */
  overflow-y: auto;
  padding-right: 6px;    /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ */
}

/* panel ëª¨ë“œì—ì„œëŠ” í•˜ë‹¨ì€ ê·¸ëƒ¥ 5ì¤„ë¡œ ë‘¬ë„ ë˜ê³ (ì„ í˜¸),
   í˜¹ì‹œ ìˆ¨ê¸°ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
#toastLog.log-view-panel{ display:none; }
*/

.toast-item {
  padding:4px 0;
  border-bottom:1px solid #333;
}

.stat-line{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  color:#bbb;
}

  .passive-row{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,0.08);
}

.passive-icon{
  width:34px;
  height:34px;
  border-radius:8px;
  object-fit:cover;
  flex:0 0 auto;
  background: rgba(255,255,255,0.06);
}

.passive-name{
  font-weight:900;
  color:#eaeaea;
  font-size:14px;
}

.passive-desc{
  font-size:12px;
  color:#bdbdbd;
  margin-top:2px;
}

.passive-lv{
  margin-left:auto;
  font-weight:900;
  font-size:12px;
  padding:6px 10px;
  border-radius:10px;
  background: rgba(255,255,255,0.08);
  color:#fff;
  flex:0 0 auto;
}

.passive-locked{
  opacity:0.35;
}

.toast-destroy {
  color:red;
  font-weight:bold;
}
  /* âœ… ë³´ìŠ¤ í† ë²Œ ê²°ê³¼ ë¡œê·¸ ìƒ‰ìƒ */
.toast-success {
  color: #37ff63;
  font-weight: 900;
}
.toast-fail {
  color: #ff3b3b;
  font-weight: 900;
}

/* âœ… ë³´ìŠ¤ì „ ì‹ ì²­ ì•Œë¦¼ (íŒŒë€ìƒ‰) */
.toast-boss-apply {
  color: #5bbcff;
  font-weight: 900;
}

/* ğŸ§° í•˜ë‹¨ ì‘ì—…ëŒ€ ë°” (1000x250) */
#workbenchDock{
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: var(--frame-max);
  height: var(--workbench-h);
  z-index: 900; /* í† ìŠ¤íŠ¸(1000)ë³´ë‹¤ ì•„ë˜ */
  pointer-events: none; /* ì§€ê¸ˆì€ ì¥ì‹ë§Œ. ë‚˜ì¤‘ì— ë²„íŠ¼ ë„£ì„ ë• none ì œê±° */
  display: none; /* âœ… ë¡œê·¸ì¸ ì „ ìˆ¨ê¹€ */
}

#workbenchDock img{
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain; /* ì›ë³¸ ë¹„ìœ¨ ìœ ì§€ */
}

  /* ğŸ§­ í•˜ë‹¨ ì‘ì—…ëŒ€ ë„í¬ UI */
#workbenchDockUI{
  position: fixed;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: var(--frame-max);
  height: var(--workbench-h);
  display: flex;
  justify-content: center;
  align-items: flex-end;
  padding-bottom: 60px;    /* â¬†ï¸ ì—¬ê¸°ë¡œ ìœ„ì¹˜ ì¡°ì ˆ */
  gap: 40px;
  z-index: 950;
  pointer-events: auto;
  display: none; /* âœ… ë¡œê·¸ì¸ ì „ ìˆ¨ê¹€ (ë¡œê·¸ì¸ í›„ JSì—ì„œ flexë¡œ ì¼¬) */
}
  
/* âœ… ì‘ì—…ëŒ€ ë„í¬ ì•ˆì˜ ë¼ë²¨ì€ "ì§€ë„/ê²°íˆ¬ì¥" ë¼ë²¨ ê·œì¹™(absolute)ì„ ë¬´ì‹œí•˜ê³ 
   flex(column) íë¦„ì„ íƒ€ê²Œ í•´ì„œ ì•„ì´ì½˜ê³¼ í•¨ê»˜ ì›€ì§ì´ê²Œ í•œë‹¤ */
#workbenchDockUI .dock-slot > .map-icon-label{
  position: static;     /* í•µì‹¬: absolute í•´ì œ */
  transform: none;      /* ê¸°ì¡´ translateX(-50%) ë¬´ë ¥í™” */
  left: auto;
  bottom: auto;

  margin-top: 18px;      /* ì•„ì´ì½˜ ì•„ë˜ ê°„ê²©(ì›í•˜ë©´ -ê°’ìœ¼ë¡œ ë” ì˜¬ë¦´ ìˆ˜ë„ ìˆìŒ) */
  line-height: 1;
  white-space: nowrap;
  text-align: center;
  pointer-events: none;
}

/* ê° ìŠ¬ë¡¯ */
.dock-slot{
  width: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: visible;
  }

/* ë²„íŠ¼ ê³µí†µ */
.dock-btn{
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: none;
  border: none;
  padding: 0;
  position: relative;
  cursor: pointer;
  
  display: flex;             
  align-items: center;        
  justify-content: center;    
  
  transition: transform 180ms ease, filter 180ms ease;
  -webkit-tap-highlight-color: transparent;
  outline: none;
}

/* ì•„ì´ì½˜ */
.dock-btn img {
  width: 90%;
  height: 90%;
  object-fit:contain;     /* âœ… 1:1 ìœ ì§€ + ì•ˆ ì§¤ë¦¬ê²Œ */
  display:block;
  filter: saturate(0.25) brightness(0.65);
  transition: filter .15s ease, transform .15s ease;
  transform: scale(1.7);
  transform-origin: center;
}

/* ğŸ”’ ì ê¸ˆ ìƒíƒœ */
.dock-btn.locked img{
  filter: grayscale(1) brightness(0.45);
}

/* ìë¬¼ì‡  */
.dock-lock{
  position: absolute;
  bottom: -2px;
  right: -2px;
  font-size: 18px;
  pointer-events: none;
}

/* âœ… ë„í¬ í™œì„± ìƒíƒœ(ì˜¤ë²„ë ˆì´ ì—´ë¦¼ ìƒíƒœ) */
.dock-btn.active{
  transform: translateY(-6px) scale(1.12);
}

/* ê¸°ì¡´ ì´ë¯¸ì§€ ì•„ì´ì½˜ìš©(ì¸ë²¤ ë“±) */
.dock-btn.active img{
  filter: saturate(1) brightness(1);
}

/* âœ… ì´ëª¨ì§€ ì•„ì´ì½˜(ìŠ¤í¬ë¡¤ìƒì )ìš© */
.dock-emoji{
  display:inline-block;
  font-size:34px;
  line-height:1;
  filter: saturate(0.35) brightness(0.65);
  transition: transform 0.15s ease, filter 0.15s ease;
  transform: scale(1.0);
}

.dock-btn.active .dock-emoji{
  filter: saturate(1) brightness(1);
  transform: scale(1.08);
}

  #scrollShopTabs{
  display:flex;
  gap:8px;
  margin: 6px 0 10px 0;
}

.scrollShopTab{
  flex:1;
  padding:10px 8px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.15);
  background: rgba(0,0,0,0.35);
  color:#ddd;
  font-weight:700;
  cursor:pointer;
}

.scrollShopTab.active{
  background: rgba(255,215,64,0.18);
  border:1px solid rgba(255,215,64,0.45);
  color:#ffd54f;
}
  
.userListName {
  color:#fff;             /* ê¸°ë³¸ í°ìƒ‰ ìœ ì§€ */
  cursor:pointer;         /* ì†ê°€ë½ ëª¨ì–‘ ì»¤ì„œ */
  text-decoration:none;   /* ë°‘ì¤„ ì œê±° */
}

.userListName:hover {
  color:#6cf;             /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ í•˜ì´ë¼ì´íŠ¸ */
}

/* ğŸŒ ì „ ì„œë²„ ë„ì „ ì•Œë¦¼ ë°°ë„ˆ */
#worldBanner {
  position: fixed;
  top: 50px;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 18px;
  border-radius: 999px;
  background: rgba(0, 0, 0, 0.85);
  color: #fff;
  font-size: 13px;
  line-height: 1.4;
  z-index: 2000;
  display: none;           /* ê¸°ë³¸ì€ ìˆ¨ê¹€ */
  text-align: center;
  white-space: nowrap;
}

#worldBanner span.level {
  color: #ffb74d;
  font-weight: bold;
}

/* ğŸŒ™ +30 ê¸€ë¡œë²Œ ì—°ì¶œ ì˜¤ë²„ë ˆì´ */
#global30Overlay {
  position: fixed;
  inset: 0;
  z-index: 999999;
}

#global30Overlay .global30-backdrop{
  position:absolute;
  inset:0;
  background: rgba(220, 230, 255, 0.22);
  backdrop-filter: blur(2px);
}

#global30Overlay .global30-box{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, -50%);
  width: min(520px, 92vw);
  background: rgba(10,10,12,0.88);
  border: 1px solid rgba(180,200,255,0.35);
  box-shadow: 0 10px 40px rgba(0,0,0,0.55);
  border-radius: 14px;
  padding: 18px 16px 14px 16px;
  text-align:center;
}

#global30Overlay .global30-title{
  font-size: 18px;
  font-weight: 800;
  color: #e8efff;
  margin-bottom: 8px;
  letter-spacing: 0.2px;
}

#global30Overlay .global30-desc{
  font-size: 14px;
  line-height: 1.5;
  color: rgba(235,240,255,0.9);
  white-space: pre-line;
  margin-bottom: 12px;
}

#global30Overlay .global30-btn{
  width: 140px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 0;
  font-weight: 700;
  cursor: pointer;
}

  .toast-30 {
  font-weight: 800;
  letter-spacing: 0.2px;
}

.toast-awe button{
  padding: 6px 10px;
  border-radius: 8px;
  border: 0;
  cursor: pointer;
  font-weight: 900;
}

.toast-awe-msg{
  font-weight: 700;
}
  
/* ================= ìœ ì € í”„ë¡œí•„ ì¹´ë“œ ================ */

#userProfileArea {
  max-width: 320px;
  margin: 10px auto 20px auto;

  /* ğŸ” ë¶ˆíˆ¬ëª… â†’ ë°˜íˆ¬ëª… + ë¸”ëŸ¬ */
  background: rgba(24, 24, 24, 0.55);
  backdrop-filter: blur(5px);

  border-radius: 16px;
  box-shadow: 0 0 18px rgba(0,0,0,0.7);
  padding: 16px 12px 14px 12px;
  position: relative;  /* ê³µìœ  ë²„íŠ¼ ê¸°ì¤€ */
}

  /* í”„ë¡œí•„ ì¹´ë“œ ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ */
.profile-save-status {
  position: absolute;
  top: 30px;
  right: 10px;
  font-size: 11px;
  color: #cccccc;
  opacity: 0;
  transition: opacity 0.2s;
}
 
/* ğŸ“¥ í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ â€” ë¯¸ë‹ˆë©€ ì•„ì´ì½˜í˜• */
.profile-share-btn {
  position: absolute;
  top: 6px;
  right: 6px;

  background: transparent; /* ğŸ”¹ ë°°ê²½ ì œê±° */
  border: none;            /* ğŸ”¹ í…Œë‘ë¦¬ ì œê±° */
  padding: 2px 4px;

  font-size: 18px;         /* ğŸ”¹ ì•„ì´ì½˜ í¬ê¸° */
  cursor: pointer;

  color: #ffffff;          /* ê¸°ë³¸ í°ìƒ‰ */
  opacity: 0.8;            /* ì€ì€í•˜ê²Œ */
  transition: opacity 0.15s, transform 0.1s;
}

/* hover ì‹œë§Œ ê°•ì¡° */
.profile-share-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* ëª¨ë°”ì¼ì—ì„œë„ ëˆŒë¦¬ê¸° ì¢‹ê²Œ */
.profile-share-btn:active {
  transform: scale(0.95);
}
  
.profile-card-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ì„¼í„° ë¬´ê¸° ì´ë¯¸ì§€ */
.profile-weapon-box {
  width: 320px;
  height: 320px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
  position: relative;     /* âœ… ì´í™íŠ¸ ë ˆì´ì–´ ê¸°ì¤€ */
  overflow: hidden;       /* âœ… ë°•ìŠ¤ ë°–ìœ¼ë¡œ ìƒˆëŠ” ê±° ì»· */
}

  /* âœ… ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ì—ì„œëŠ” ë¬´ê¸° ì´ë¯¸ì§€ê°€ ì¹´ë“œ ë°–ìœ¼ë¡œ ì‚ì ¸ë‚˜ì˜¤ê²Œ */
#otherProfileOverlay .profile-weapon-box{
  overflow: visible;
}

  /* ================= ë¬´ê¸° ì„±ê³µ/ì‹¤íŒ¨ ì´í™íŠ¸(íŒŒí¸/ì—°ê¸°) ================= */

.weapon-fx-layer{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index: 5; /* weaponImageë³´ë‹¤ ìœ„ë¡œ(weaponImageê°€ ê¸°ë³¸ z-index 0) */
}

/* âœ… í° íŒŒí¸(ìƒ¤ë“œ) */
.weapon-shard{
  position:absolute;
  left:50%;
  top:50%;
  width: 10px;
  height: 3px;
  background: rgba(255,255,255,0.95);
  border-radius: 2px;
  transform: translate(-50%, -50%);
  filter: drop-shadow(0 0 6px rgba(255,255,255,0.9));
  opacity: 0;
  animation: shardFly 650ms ease-out forwards;
}

/* íŒŒí¸ë§ˆë‹¤ ë°©í–¥/ê±°ë¦¬/íšŒì „ì„ varë¡œ ì¤Œ */
@keyframes shardFly{
  0%{
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.6) rotate(var(--r));
    filter: drop-shadow(0 0 10px rgba(255,255,255,1));
  }
  10%{
    opacity: 1;
  }
  100%{
    opacity: 0;
    transform:
      translate(calc(-50% + var(--dx)), calc(-50% + var(--dy)))
      scale(0.9)
      rotate(calc(var(--r) + 120deg));
    filter: drop-shadow(0 0 0 rgba(255,255,255,0));
  }
}

/* âœ… ì‹¤íŒ¨ ê²€ì€ ì—°ê¸° */
.weapon-smoke{
  position:absolute;
  left:50%;
  top:55%;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%,
    rgba(60,60,60,0.55),
    rgba(0,0,0,0.0) 70%);
  transform: translate(-50%, -50%);
  opacity: 0;
  filter: blur(0.2px);
  animation: smokeRise 900ms ease-out forwards;
}

@keyframes smokeRise{
  0%{
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.65);
  }
  15%{
    opacity: 0.9;
  }
  100%{
    opacity: 0;
    transform: translate(calc(-50% + var(--sx)), calc(-50% - var(--sy)))
               scale(1.8);
  }
}

/* ë‚˜ì¤‘ì— íˆ¬ëª… PNGë¡œ êµì²´í•˜ë©´ ë¨ */
#weaponImage {
  max-width: 100%;
  max-height: 100%;
}

/* =========================
   âš”ï¸ ê°•í™” ë¬´ê¸° ì´ë¯¸ì§€ ì—°ì¶œ
   ========================= */
#weaponImage{
  transition: filter 120ms ease, transform 120ms ease;
  will-change: filter, transform;
}

/* ê°•í™” ì‹œë„ ìˆœê°„: í•˜ì–—ê²Œ í™• ë°ì•„ì§ */
.weapon-flash-charge{
  animation: weaponFlashCharge 0.22s ease-out;
}

/* ì„±ê³µ: í° ë²ˆì© + ê¸€ë¡œìš°, ì´í›„ ì„œì„œíˆ ì •ìƒìœ¼ë¡œ */
.weapon-flash-success{
  animation: weaponFlashSuccess 0.62s ease-out;
}

/* ì‹¤íŒ¨: ì ê¹ ê¹Œë§£ê²Œ(ë¨¹ë¨¹) â†’ ì •ìƒìœ¼ë¡œ */
.weapon-flash-fail{
  animation: weaponFlashFail 0.55s ease-out;
}

@keyframes weaponFlashCharge{
  0%{
    filter: brightness(1) drop-shadow(0 0 0 rgba(255,255,255,0));
    transform: scale(1);
  }
  100%{
    filter: brightness(2.3) drop-shadow(0 0 14px rgba(255,255,255,0.75));
    transform: scale(1.02);
  }
}

@keyframes weaponFlashSuccess{
  0%{
    filter: brightness(2.6) drop-shadow(0 0 18px rgba(255,255,255,0.95));
    transform: scale(1.03);
  }
  45%{
    filter: brightness(2.0) drop-shadow(0 0 26px rgba(255,255,255,0.85));
    transform: scale(1.02);
  }
  100%{
    filter: brightness(1) drop-shadow(0 0 0 rgba(255,255,255,0));
    transform: scale(1);
  }
}

@keyframes weaponFlashFail{
  0%{
    filter: brightness(0.08) saturate(0.2) drop-shadow(0 0 0 rgba(0,0,0,0));
    transform: scale(0.995);
  }
  55%{
    filter: brightness(0.22) saturate(0.35);
  }
  100%{
    filter: brightness(1) saturate(1);
    transform: scale(1);
  }
}

/* í•˜ë‹¨ ì •ë³´ ì˜ì—­ */
.profile-info-box {
  width: 100%;
  text-align: center;
  font-size: 14px;
}

.profile-nickname {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}

.profile-row {
  margin: 2px 0;
}

  .profile-engrave {
  text-align: center;
  font-size: 13px;
  color: #dddddd;
  margin: 3px 0;
}

.profile-label {
  color: #bbbbbb;
  margin-right: 4px;
}

.profile-value {
  font-weight: bold;
}

#profileGold,
#profileSword,
#profilePower,
#profileHuntCount {
  color: #fff;
}

  /* ===== ì¸ë²¤í† ë¦¬(ì•„ì´ì½˜ìš©) ì¤‘ì•™ ì˜¤ë²„ë ˆì´ ===== */
.uiOverlay{
  position:fixed;
  inset:0;
  z-index:5000;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.55);
}

.invPanel{
  width:min(420px, 92vw);
  max-height:82vh;
  background:rgba(35,35,35,0.96);
  border:2px solid rgba(255,255,255,0.18);
  border-radius:14px;
  box-shadow:0 12px 30px rgba(0,0,0,0.55);
  overflow:hidden;
  position: relative;
}

.invHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,0.10);
}

.invTitle{
  font-size:18px;
  font-weight:900;
  letter-spacing:0.5px;
  color:#fff;
}

.invCloseBtn{
  position: absolute;     /* âœ… êµ¬ì„ìœ¼ë¡œ ë³´ë‚´ê¸° */
  top: 8px;
  right: 8px;

  background: none;       /* âœ… ë°•ìŠ¤ ì œê±° */
  border: none;

  padding: 0;
  margin: 0;

  font-size: 20px;        /* X í¬ê¸° */
  font-weight: 900;
  color: rgba(255,255,255,0.75);

  cursor: pointer;
  line-height: 1;
}

  .invCloseBtn:hover{
  color: #fff;
  transform: scale(1.1);
}

#inventoryScrollArea{
  padding:12px;
  max-height:64vh;     /* ì—¬ê¸°ì—ì„œ "ì¼ì • ì¹¸ ë„˜ì–´ê°€ë©´ ìŠ¤í¬ë¡¤" */
  overflow-y:auto;
}

.invFooter{
  padding:10px 14px;
  border-top:1px solid rgba(255,255,255,0.10);
  display:flex;
  justify-content:flex-end; /* ìš°ì¸¡í•˜ë‹¨ */
}

#inventoryCountInfo{
  font-size:13px;
  color:#cfcfcf;
  opacity:0.9;
}

/* ===== ì¸ë²¤í† ë¦¬ ê·¸ë¦¬ë“œ(ê¸°ì¡´ ë Œë”ê°€ inventory-gridë¥¼ ì“°ë¯€ë¡œ ê·¸ê±¸ ê°•í™”) ===== */
.inventory-grid{
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  gap:10px;
}

.inventory-slot{
  position:relative;
  width:100%;
  aspect-ratio:1/1;
  border-radius:10px;
  background:rgba(20,20,20,0.7);
  border:2px solid rgba(255,255,255,0.12);
  box-shadow: inset 0 0 0 2px rgba(0,0,0,0.35);
  cursor:pointer;
}

.inventory-slot::after{
  content:"";
  position:absolute;
  inset:6px;
  border-radius:8px;
  border:2px solid rgba(255,255,255,0.12);
  pointer-events:none;
}

.inventory-slot img{
  position:absolute;
  inset:10px;
  width:calc(100% - 20px);
  height:calc(100% - 20px);
  object-fit:contain;
}

/* ğŸ”˜ ìš°ì¸¡ ìƒë‹¨ ë©”ë‰´ ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (MAP / ê²°íˆ¬ / ì¸ë²¤í† ë¦¬) */
.side-menu-btn {
  position: fixed;
  right: calc(var(--frame-pad) + 10px);
  z-index: 1100;
  font-size: 14px;
  padding: 8px 16px;
  margin: 0;
  display: none;   /* ë¡œê·¸ì¸ í›„ JSì—ì„œ blockìœ¼ë¡œ ë°”ê¿ˆ */
}

/* ê° ë²„íŠ¼ì˜ ì„¸ë¡œ ìœ„ì¹˜ë§Œ ë‹¤ë¥´ê²Œ */
#scrollShopBtn {
  top: 50px;   
}

.guild-alert-badge{
  position:absolute;
  top:-6px;
  left:-6px;     /* âœ… ì¢Œì¸¡ìƒë‹¨ */
  right:auto;    /* âœ… ê¸°ì¡´ right ë¬´ë ¥í™” */

  width:18px;
  height:18px;
  border-radius:999px;
  background:#ff3b3b;
  color:#fff;
  font-size:12px;
  font-weight:900;

  display:none;              /* âœ… ê¸°ë³¸ì€ ìˆ¨ê¹€ */
  align-items:center;
  justify-content:center;

  box-shadow:0 0 10px rgba(255,59,59,0.55);
}

.guild-alert-inline{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:16px;
  height:16px;
  border-radius:999px;
  background:#ff3b3b;
  color:#fff;
  font-size:11px;
  font-weight:900;
  margin-right:6px;
  box-shadow:0 0 10px rgba(255,59,59,0.35);
}

/* ğŸ—º MAP íŒ¨ë„ */
#mapPanel {
  position:fixed;
  top:60px;
  right: calc(var(--frame-pad) + 10px);
  width:260px;
  max-height:70%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:2605;
  display:none;
  text-align:left;
  font-size:14px;
}
#mapPanel h3 {
  margin-top:0;
}
.map-field {
  padding:6px 4px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.map-field:hover {
  background:#222;
}

/* ì‚¬ëƒ¥ ì •ë³´ í…ìŠ¤íŠ¸ */
#huntInfo {
  font-size:14px;
  color:#ccc;
  margin-top:4px;
}

.field-topbar{
  position: sticky;
  top: 0;
  z-index: 1500;

  /* âœ… í™”ë©´ ì „ì²´ í­ìœ¼ë¡œ í™•ì¥í•´ì„œ ìš°ì¸¡ ë ê¸°ì¤€ì„ "ì§„ì§œ í™”ë©´"ìœ¼ë¡œ */
  width: 100vw;
  left: 50%;
  transform: translateX(-50%);

  padding-top: calc(2px + var(--field-top-offset));
  margin-bottom: 8px;

  position: relative; /* ì•„ì´ì½˜ absolute ê¸°ì¤€ */
}

  /* âœ… ìƒë‹¨ ì¬í™”ë°” */
.top-currency-bar{
  position:absolute;

  /* âœ… ì¢Œì¸¡ ì •ë ¬ (ì¢Œì¸¡ ì•„ì´ì½˜(94px) ê³µê°„ì„ í”¼í•´ ì‹œì‘) */
  left: calc(var(--frame-pad) + 22px + 12px);
  top: 15px;
  transform: none;
  display:flex;
  gap:12px;
  align-items:center;
  padding:7px 11px;

  pointer-events: none; /* í´ë¦­ ë°©í•´ ë°©ì§€ */
}

.top-currency-item{
  display:flex;
  align-items:center;
  gap:7px;
  font-size:15px;
  color:#f2f2f2;
  font-weight:700;
  text-shadow: 0 1px 2px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.6);
  white-space: nowrap;
  
}

.top-currency-item img{
  width:27px;
  height:27px;
  image-rendering: auto;
}

/* âœ… ë§µ ì´ë¦„/ì •ë³´ëŠ” ê°€ìš´ë° ìœ ì§€ + ì•„ì´ì½˜ ì˜ì—­ë§Œí¼ ê²¹ì¹¨ ë°©ì§€ */
.field-topbar .current-field-info{
  width: min(430px, calc(100vw - 110px)); /* ì•„ì´ì½˜ ìë¦¬ í™•ë³´ */
  margin: 0 auto;
  text-align: center;
  margin-bottom: 0;
}

/* ğŸ—º MAP ì•„ì´ì½˜ ë²„íŠ¼ (ìš°ì¸¡ "í™”ë©´ ë" ê³ ì •) */
.map-icon-btn{
  display: none; /* âœ… ë¡œê·¸ì¸ í›„ ê¸°ì¡´ JSê°€ ë³´ì—¬ì£¼ëŠ” ë¡œì§ ìœ ì§€ */
  width: 94px;
  height: 94px;
  padding: 0;
  border: 0;
  background: transparent;
  cursor: pointer;

  position: absolute;
  right: calc(var(--frame-pad) + 22px);
  top: 0;
  
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

  /* âœ… ì•„ì´ì½˜/í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
.map-icon-btn{
  text-align: center;
}

.map-icon-btn .map-icon-img{
  display: block;
  margin: 0 auto;
}

.map-icon-btn .map-icon-label{
  display: block;
  width: 100%;
  text-align: center;
}

  /* â¬…ï¸ ì¢Œì¸¡ ì•„ì´ì½˜ ì „ìš© ë°°ì¹˜ */
.left-icon-btn{
  right: auto;
  left: calc(var(--frame-pad) + 22px);
}

/* ì¢Œì¸¡ ì•„ì´ì½˜ ì„¸ë¡œ ìœ„ì¹˜ */
#attendanceIconBtn{ top: var(--field-top-offset); }
#achievementIconBtn{ top: calc(120px + var(--field-top-offset)); }

  /* âœ… ì¶œì„ ë¯¸ì™„ë£Œ ì•Œë¦¼ ë±ƒì§€ (!) */
#attendanceIconBtn{ overflow: visible; } /* (í˜¹ì‹œ ë°–ìœ¼ë¡œ ì‚ì ¸ë„ ë³´ì´ê²Œ) */
#bossBattleIconBtn{ overflow: visible; }
#guildIconBtn{ overflow: visible; }

.icon-alert-badge{
  position: absolute;
  top: 6px;
  right: 8px;
  width: 18px;
  height: 18px;
  border-radius: 999px;
  display: none;              /* âœ… ê¸°ë³¸ì€ ìˆ¨ê¹€ */
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 14px;
  line-height: 18px;
  background: #ff3b30;
  color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.45);
  z-index: 6;
  pointer-events: none;       /* âœ… í´ë¦­ ë°©í•´ X */
}

  /* âœ… ì¹­í˜¸(ì—…ì ) ê·¸ë¦¬ë“œ ì…€ ë‚´ë¶€ìš© !ë”±ì§€ (ì‘ê²Œ) */
.title-alert-badge{
  width: 16px;
  height: 16px;
  font-size: 12px;
  line-height: 16px;
  top: 6px;
  right: 6px;
  z-index: 2;
}

  /* âœ… ì§€ë„ ë²„íŠ¼ ì•„ë˜ë¡œ ê°™ì€ ê·œê²©ìœ¼ë¡œ ìŒ“ê¸° (ì§€ë„ ìŠ¤íƒ€ì¼ ìœ ì§€) */
#mapBtn{ top: var(--field-top-offset) }              /* ì§€ë„ëŠ” ê·¸ëŒ€ë¡œ */
#duelIconBtn{ top: calc(120px + var(--field-top-offset)); }
#guildIconBtn{ top: calc(240px + var(--field-top-offset)); }
#userListIconBtn{ top: calc(360px + var(--field-top-offset)); }
  #bossBattleIconBtn{
  top: calc(480px + var(--field-top-offset));
}

.map-icon-img{
  width: 94px;
  height: 94px;
  display: block;
  margin: 0 auto;
}

/* ì•„ì´ì½˜ í•˜ë‹¨ì— ì‚´ì§ ê²¹ì¹˜ê²Œ "ì§€ë„" */
.map-icon-label{
  position: absolute;
  left: 50%;
  bottom: 2px;
  transform: translateX(-50%);
  font-size: 13px;
  font-weight: 900;
  color: #fff;
  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000;
    z-index: 2;
    pointer-events: none;
}

/* ëˆŒë¦¼ í”¼ë“œë°±(ê°€ë²¼ìš´) */
.map-icon-btn:active{
  transform: translateY(1px);
}
.map-icon-btn:focus,
.map-icon-btn:focus-visible{
  outline: none;
}

.map-icon-label.one-line{
  white-space: nowrap;
}

/* ê¸¸ë“œ ë±ƒì§€ê°€ ì•„ì´ì½˜ ë°–ìœ¼ë¡œ ë‚˜ê°€ë„ ë³´ì´ê²Œ */
#guildIconBtn{ overflow: visible; }

/* ìº¡ì²˜ ëª¨ë“œì—ì„œëŠ” ê¸¸ë“œ ì•„ì´ì½˜ ìˆ¨ê¹€(ê¸°ì¡´ ë£° ëŒ€ì²´) */
.capture-mode #guildIconBtn{
  display:none !important;
}

   /* ğŸ—º í”„ë¡œí•„ ì¹´ë“œ â€œë°–â€ ìƒë‹¨ í˜„ì¬ ì‚¬ëƒ¥í„° ì •ë³´ */
.current-field-info {
  font-size: 14px;
  color: #ffffff;        /* ê¸°ë³¸ í°ìƒ‰ */
  text-align: center;
  margin-bottom: 8px;    /* ì•„ë˜ ì¹´ë“œë‘ ê°„ê²© */
  line-height: 1.4;
}

 /* ğŸ® ê²Œì„ íƒ€ì´í‹€ ì˜ì—­ ì—¬ë°± ì œê±° */
.game-title{
  margin: 6px 0 2px 0;   /* ê¸°ì¡´ë³´ë‹¤ í™• ì¤„ì„ */
  padding: 0;
  line-height: 1;
}

/* ğŸ® ê²Œì„ íƒ€ì´í‹€ ì´ë¯¸ì§€ */
.game-title-logo{
  display: block;
  width: 70%;           /* âœ… ë¡œê³  ìì²´ë¥¼ 70%ë¡œ */
  max-width: 220px;     /* âœ… ë„ˆë¬´ ì»¤ì§€ì§€ ì•Šê²Œ ìƒí•œ */
  height: auto;
  margin: 0 auto;       /* ê°€ìš´ë° ì •ë ¬ */
}

  #updateNoticeBar{
  margin-top: 0 !important;     /* inline margin-top:4px ë®ì–´ì”€ */
  margin-bottom: 2px;           /* ì‚´ì§ë§Œ */
}

hr.section-divider{
  margin: 6px auto 8px auto;    /* ê¸°ë³¸ hr ì—¬ë°±ì´ í° ê²½ìš°ê°€ ë§ì•„ì„œ ì¤„ì„ */
}

.current-field-info-sub {
  font-size: 14px;
  color: #cccccc;        /* ì¶”ì²œë ˆë²¨/ì„±ê³µí™•ë¥  íšŒìƒ‰ */
}
  
/* ğŸ§” NPC íŒì—… */
#npcPopup {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;              /* ê¸°ë³¸ ìˆ¨ê¹€ */
  align-items:center;
  justify-content:center;
  z-index:7000;
}

.npc-popup-inner {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.npc-popup-img {
  width:140px;
  height:auto;
  display:block;
  margin:0 auto 8px auto;
}

.npc-popup-text {
  font-size:16px;
  margin:8px 0 12px 0;
}

.npc-popup-btn {
  padding:8px 20px;
  font-size:14px;
  cursor:pointer;
}

/* âš”ï¸ ê²°íˆ¬ VS ì—°ì¶œ ì˜¤ë²„ë ˆì´ */
#duelBattleOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;           /* ê¸°ë³¸ ìˆ¨ê¹€ */
  align-items: center;
  justify-content: center;
  z-index: 7050;          /* NPC íŒì—…ë³´ë‹¤ ì‚´ì§ ìœ„ or ì•„ë˜ë¡œ ì¡°ì ˆ */
}

.duel-battle-inner {
  background: #222;
  border: 1px solid #555;
  border-radius: 12px;
  padding: 16px 20px;
  max-width: 360px;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px rgba(0,0,0,0.9);
  font-size: 14px;
}

.duel-battle-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 8px;
}

.duel-battle-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
  margin-bottom: 6px;
}

.duel-side {
  width: 45%;
}

.duel-user-name {
  font-weight: bold;
  margin-bottom: 2px;
}

.duel-weapon-name {
  font-size: 13px;
  margin-bottom: 4px;
}

.duel-weapon-img-box {
  width: 90px;
  height: 90px;
  margin: 0 auto 4px auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.duel-weapon-img-box img {
  max-width: 100%;
  max-height: 100%;
}

.duel-power {
  font-size: 12px;
  color: #ccc;
}

.duel-vs-text {
  font-size: 20px;
  font-weight: bold;
  padding: 0 4px;
}

.duel-battle-sub {
  font-size: 12px;
  color: #aaa;
  margin-top: 6px;
}

/* ğŸ“¢ ì—…ë°ì´íŠ¸ ê³µì§€ íŒì—… */
#updateNoticeOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1950;
}

.update-notice-box {
  background: #222;
  border: 1px solid #555;
  border-radius: 10px;
  padding: 14px 18px;
  max-width: 360px;
  width: 90%;
  color: #fff;
  font-size: 13px;
  text-align: left;
  box-shadow: 0 0 15px rgba(0,0,0,0.8);
}

.update-notice-title {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 14px;
  text-align: center;
}

.update-notice-content {
  white-space: pre-line;
  line-height: 1.4;
  margin-bottom: 10px;
}

.update-notice-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}

.update-notice-nav button {
  font-size: 12px;
  padding: 4px 8px;
}
  
/* ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ */
#tutorialOverlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:flex-start;   /* â¬…ï¸ ìœ„ìª½ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ */
  justify-content:center;   /* ê°€ë¡œëŠ” ì¤‘ì•™ ìœ ì§€ */
  z-index:1900;
  padding-top:60px;         /* â¬…ï¸ ìœ„ì—ì„œ ì•½ê°„ ë„ì›Œì£¼ê¸° */
}

.tutorial-box {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  color:#fff;
  text-align:left;
  font-size:14px;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.tutorial-box h3 {
  margin-top:0;
  margin-bottom:8px;
  text-align:center;
}

.tutorial-box ul {
  padding-left:18px;
  margin:8px 0 12px 0;
}

.tutorial-close-btn {
  display:block;
  width:100%;
  padding:8px 0;
  margin-top:4px;
  text-align:center;
  cursor:pointer;
  border:none;
  border-radius:6px;
  background:#f0f0f0;
  color:#222;
  font-weight:bold;
}

/* ì„¹ì…˜ êµ¬ë¶„ì„  */
.section-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 10px auto 16px auto;
  max-width: 360px;  /* í”„ë¡œí•„ ì¹´ë“œ í­ì´ë‘ ë¹„ìŠ·í•˜ê²Œ */
}

/* ğŸ¨ ì‚¬ëƒ¥í„° ë°°ê²½ ë ˆì´ì–´ */
#gameScreen {
  position: relative;
  padding-bottom: calc(300px + var(--workbench-h));
}

/* fieldBg ì•ˆì˜ ë‚´ìš©ì€ ê·¸ëŒ€ë¡œ, ë°°ê²½ë§Œ ::beforeë¡œ ê¹”ê¸° */
.field-bg {
  max-width: 430px;
  margin: 0 auto 20px auto;
  position: relative;
  z-index: 0;                     /* ìŠ¤íƒ ê¸°ì¤€ */
}

  /* âœ… fieldBg ì˜ì—­ì—ë§Œ ë°°ê²½ ê¹”ê¸° (êµ¬ë¶„ì„  ì•„ë˜ ~ ë­í‚¹ ìœ„ê¹Œì§€) */
.field-bg::before{
  content:"";
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);

  /* í”„ë ˆì„ ìµœëŒ€í­(1000)ê¹Œì§€ë§Œ ë°°ê²½ì„ ë³´ì´ê²Œ */
  width: min(100vw, var(--frame-max));
  height:100%;

  background-image: var(--field-bg-image, none);
  background-size: cover;           /* ê¸°ì¡´ì²˜ëŸ¼: ì„¸ë¡œëŠ” ì±„ìš°ê³  ê°€ë¡œëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì˜ë¦¼ */
  background-position: center top;
  background-repeat: no-repeat;

  filter: brightness(0.6);
  z-index:-1;
  pointer-events:none;
}

/* ğŸ’ ì¸ë²¤í† ë¦¬ ê·¸ë¦¬ë“œ */
.inventory-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 4px;
  margin-top: 4px;
}

/* ê° ì¸ë²¤í† ë¦¬ ìŠ¬ë¡¯ */
.inventory-slot {
  position: relative;
  aspect-ratio: 1 / 1;          /* âœ… ì •ì‚¬ê°í˜• ìœ ì§€ */

  background: rgba(0,0,0,0.25);
  border: none;
  border-radius: 6px;

  display: flex;
  align-items: center;
  justify-content: center;
}

/* ì•„ì´í…œ ì•„ì´ì½˜ */
.inventory-slot img {
  max-width: 96%;
  max-height: 96%;
  display: block;
}

/* ê°œìˆ˜ ë°°ì§€ (ì˜¤ë¥¸ìª½ ì•„ë˜) */
.inventory-count {
  position: absolute;
  right: 2px;
  bottom: 2px;
  min-width: 14px;
  padding: 0 3px;
  background: rgba(0,0,0,0.8);
  border-radius: 8px;
  font-size: 11px;
  text-align: center;
}

/* ì¸ë²¤í† ë¦¬ ì œëª© ì‚´ì§ ì—¬ë°± */
#inventoryPanel h3 {
  margin-top: 0;
  margin-bottom: 4px;
}
/* ğŸ’ ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ìƒì„¸ íŒì—… */
#itemDetailOverlay {
  position: fixed;
  inset: 0;
  display: none;
  z-index: 99999;
  background: rgba(0,0,0,0); /* í•„ìš”í•˜ë©´ 0.4 ì •ë„ë¡œ ì–´ë‘¡ê²Œ */
}

#itemDetailBox {
  position: absolute;
  min-width: 200px;
  max-width: 260px;
  background: #111;
  border: 1px solid #666;
  border-radius: 10px;
  padding: 10px;
  color: #fff;
  box-shadow: 0 0 15px rgba(0,0,0,0.8);
  font-size: 13px;
  z-index: 100000;  
}

#itemDetailImg {
  display: block;
  margin: 0 auto 6px auto;
  width: 96px;
  height: 96px;
  object-fit: contain;
}

#itemDetailName {
  font-weight: bold;
  text-align: center;
  margin-bottom: 4px;
}

#itemDetailDesc {
  font-size: 12px;
  color: #ccc;
  line-height: 1.4;
  text-align: center;
}

/* ğŸ”¥ ê°•í™” ì—°ì¶œ í”Œë˜ì‹œ ì˜¤ë²„ë ˆì´ */
#upgradeFlashOverlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2200;           /* NPC íŒì—…ë³´ë‹¤ ìœ„ë¡œ */
}

/* ê¸°ë³¸ì€ íˆ¬ëª… */
#upgradeFlashOverlay::before {
  content: "";
  position: absolute;
  inset: 0;
  opacity: 0;
}

/* ğŸ’¥ íŒŒê´´(ì‹¤íŒ¨)ìš© ë¶‰ì€ í”Œë˜ì‹œ */
#upgradeFlashOverlay.flash-red::before {
  background: radial-gradient(circle at center, rgba(255,0,0,0.65), rgba(0,0,0,0.9));
  animation: upgradeFlashRed 0.6s ease-out;
}

/* âœ¨ ëŒ€ì„±ê³µ(25ê°• ì´ìƒ ì„±ê³µ)ìš© í™©ê¸ˆ í”Œë˜ì‹œ */
#upgradeFlashOverlay.flash-gold::before {
  background: radial-gradient(circle at center, rgba(255,215,0,0.7), rgba(0,0,0,0.9));
  animation: upgradeFlashGold 0.7s ease-out;
}

@keyframes upgradeFlashRed {
  0%   { opacity: 0;   }
  30%  { opacity: 1;   }
  100% { opacity: 0;   }
}

@keyframes upgradeFlashGold {
  0%   { opacity: 0;   }
  40%  { opacity: 1;   }
  100% { opacity: 0;   }
}

/* =========================
   ğŸ·ï¸ ì—…ì (ì¹­í˜¸) ì˜¤ë²„ë ˆì´ UI ì •ë¦¬
   ========================= */

.titleOverlay{
  position: fixed;
  inset: 0;
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.65);
}

.titlePanel{
  position: relative;
  width: min(860px, 92vw);
  height: min(560px, 84vh);
  border-radius: 16px;
  padding: 14px;                 /* âœ… padding-bottom ê³ ì •ê°’ ì œê±° */
  background: rgba(10,10,10,0.88);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  backdrop-filter: blur(6px);

  display: flex;                 /* âœ… 2ë‹¨ ë ˆì´ì•„ì›ƒ */
  flex-direction: column;
  overflow: hidden;              /* âœ… NPC ì‚ì ¸ë‚˜ì˜¤ëŠ”ê±° ë°©ì§€ */
}

/* í—¤ë” */
.titleHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 10px;
}

.titleHeaderLeft{
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.2px;
}

.titleHeaderRight{
  display:flex;
  align-items:center;
  gap: 8px;
}

/* ë²„íŠ¼ í¬ê¸° í†µì¼ (ìµœê·¼íšë“ìˆœ / ë‹«ê¸°) */
.titleBtn{
  height: 34px;
  padding: 0 12px;
  font-size: 13px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.08);
  color: #eee;
  cursor: pointer;
}

.titleBtn:hover{
  background: rgba(255,255,255,0.12);
}

.titleBtnClose{
  width: 34px;
  padding: 0;
  font-weight: 900;
}

/* ì¥ì°©ì¤‘ ì¤„ */
.titleEquippedRow{
  margin: 6px 0 12px;
  font-size: 13px;
  color: #cfcfcf;
}

/* ê·¸ë¦¬ë“œ: ê°€ë…ì„± + ì •ëˆ */
.titleGrid{
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  align-content: start;

  flex: 1;                       /* âœ… ë‚¨ëŠ” ê³µê°„ ì „ë¶€ ê·¸ë¦¬ë“œ */
  overflow-y: auto;
  padding: 6px 2px 10px;         /* âœ… ìƒì ì²˜ëŸ¼ ì´˜ì´˜ */
}

/* ì¹´ë“œ ì…€ ê³µí†µ(ê¸°ì¡´ inline styleë³´ë‹¤ ìš°ì„ ë˜ê²Œ í•˜ë ¤ë©´ !importantë„ ê°€ëŠ¥) */
.titleCell{
  border-radius: 14px;
  padding: 10px 8px;
  text-align: center;
  user-select: none;
  background: rgba(255,255,255,0.04);
}

/* âœ… NPC ì˜ì—­: ìŠ¤í¬ë¡¤ìƒì ì²˜ëŸ¼ â€œìš°ì¸¡í•˜ë‹¨ NPC / ì¢Œì¸¡ ëŒ€ì‚¬â€, ê·¸ë¦¬ê³  íŒ¨ë„ì— ë¶™ì´ê¸° */
.titleNpcWrap{
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
  gap: 12px;

  margin-top: 10px;
  padding: 10px 12px;
  border-top: 1px solid rgba(255,255,255,0.10);
  background: rgba(0,0,0,0.22);

  pointer-events: none;          /* í´ë¦­ ë°©í•´ X */
}

/* âœ… ëŒ€ì‚¬ ë°•ìŠ¤ ì œê±°: ë°°ê²½/í…Œë‘ë¦¬ ì—†ì• ê³  í…ìŠ¤íŠ¸ë§Œ */
.titleNpcTalk{
  flex: 1;
  max-width: calc(100% - 160px);
  padding: 0;
  background: transparent;
  border: none;

  color: #e7e7e7;
  text-align: left;
  text-shadow: 0 2px 6px rgba(0,0,0,0.85);
}
  
#titleNpcText{
  line-height: 1.35;
}
  
.titleNpcName{
  font-weight: 900;
  margin-bottom: 6px;
  opacity: 0.95;
}

/* âœ… NPCëŠ” ìš°ì¸¡í•˜ë‹¨ */
.titleNpcImg{
  width: 120px;           
  height: auto;
  object-fit: contain;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,0.65));
  pointer-events: none;
}

  /* âœ… ëª¨ë°”ì¼ì—ì„œ ëª¨í—˜ê°€ ê¸¸ë“œ íŒ¨ë„ ë†’ì´ ì¤„ì´ê¸° (PC ìœ ì§€) */
@media (max-width: 520px){
  #adventureGuildPanel{
    height: 36% !important;     /* ê¸°ì¡´ 82%ë³´ë‹¤ ì§§ê²Œ */
    max-height: 37vh !important;
  }
}

/* =========================
   ğŸ—º ì–‘í”¼ì§€ ì§€ë„ ì˜¤ë²„ë ˆì´
   ========================= */
/* =========================
   ğŸ—º ì–‘í”¼ì§€ ì§€ë„ ì˜¤ë²„ë ˆì´ (í™”ë©´ ê°€ë“ ëª¨ë“œ)
   ========================= */
#parchmentMapOverlay{
  position: fixed;
  inset: 0;
  display: none;                 /* ì—´ ë•Œ flexë¡œ */
  align-items: center;
  justify-content: center;

  /* ë°”ê¹¥ ì—¬ë°±(ì—¬ë°± í„°ì¹˜ë¡œ ë‹«íˆëŠ” ì˜ì—­) */
  padding: 28px 14px;
  box-sizing: border-box;

  background: rgba(0,0,0,0.72);
  z-index: 2500;
}

#parchmentMapPanel{
  position: relative;
  width: min(96vw, 900px);       /* âœ… ê°€ë¡œ ê¸°ì¤€ìœ¼ë¡œ í¬ê²Œ */
  max-height: calc(100vh - 56px);
  background: transparent;
  overflow: visible;
}

#parchmentMapStage{
  position: relative;
  width: 100%;
}

#parchmentMapImg{
  width: 100%;
  height: auto;                  /* âœ… ì„¸ë¡œëŠ” ë¹„ìœ¨ ìœ ì§€ */
  display: block;
  user-select: none;
  -webkit-user-drag: none;
}

  /* ğŸ—º ì›”ë“œë§µ ë‹«ê¸° í…ìŠ¤íŠ¸ ë²„íŠ¼ (ì–‘í”¼ì§€ í†¤) */
#parchmentMapCloseBtn{
  position:absolute;
  right:83px;
  top:14px;
  z-index:5;

  background:transparent;
  border:0;
  padding:4px 6px;

  font-size:12px;
  font-weight:900;
  letter-spacing:-0.2px;

  /* ì–‘í”¼ì§€ë³´ë‹¤ ì‚´ì§ ì§„í•œ ê°ˆìƒ‰ */
  color:#9a9a9a;

  cursor:pointer;
  user-select:none;

  text-shadow:
    0 1px 0 rgba(255,255,255,0.25),
    0 1px 2px rgba(0,0,0,0.35);
}

#parchmentMapCloseBtn:hover{
  color:#bdbdbd;
  filter:brightness(1.05);
}

#parchmentMapCloseBtn:active{
  transform:translateY(1px);
}

#parchmentMapCloseBtn:active{
  transform: translateY(1px);
}

/* ğŸŒ³ POI: ì´ê·¸ë“œë¼ì‹¤ (ì¤‘ì•™ ë°°ì¹˜) */
#poiYggdrasil{
  position: absolute;
  left: 47.7%;
  top: 43.5%;
  transform: translate(-50%, -50%) ;
  width: 96px;
  height: 96px;
  border: 0;
  padding: 0;
  background: transparent;
  cursor: pointer;
  z-index: 5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

  #poiYggdrasil img{
  width: 110%;
  height: 110%;
  display:block;
}

#poiYggdrasil:active{
  transform: translate(-50%, -50%) scale(1.06);
}

/* ğŸŒ³ ì´ê·¸ë“œë¼ì‹¤ í…ìŠ¤íŠ¸ ë¼ë²¨ */
#poiYggdrasil .poi-label{
  position: absolute;
  bottom: 0px;                 /* ğŸŒ± ë¿Œë¦¬ ìª½ì— ê²¹ì¹˜ê²Œ */
  left: 53%;
  transform: translateX(-50%);

  font-size: 10px;
  font-weight: 900;
  color: #cfcfcf; 

  /* ê²€ì€ í…Œë‘ë¦¬ íš¨ê³¼ (ê°€ë…ì„± í•µì‹¬) */
  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space: nowrap;
  pointer-events: none;         /* âœ… í…ìŠ¤íŠ¸ê°€ í´ë¦­ì„ ë§‰ì§€ ì•Šê²Œ */
}
  
  #poiYggdrasil:hover .poi-label{
  filter: brightness(1.15);
}

  /* ğŸ›ï¸ POI: í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ (ì´ê·¸ë“œë¼ì‹¤ ë¶ì„œìª½ / ë²„ì„¯ë§ˆì„ ë¶ìª½ ì•½ê°„ ë™ìª½) */
#poiFulgurantForge{
  position:absolute;

  /* âœ… ì‹œì‘ ì¢Œí‘œ(ì›í•˜ëŠ” ìœ„ì¹˜ë¡œ ë¯¸ì„¸ì¡°ì •) */
  left: 41.0%;
  top: 33.5%;

  transform: translate(-50%, -50%);
  width: 66px;
  height: 44px;

  border: 0;
  padding: 0;
  background: transparent;
  cursor: pointer;
  z-index: 5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

#poiFulgurantForge img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

#poiFulgurantForge:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸ›ï¸ í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ ë¼ë²¨ (ë‹¤ë¥¸ POI ë¼ë²¨ê³¼ ë™ì¼ í†¤) */
#poiFulgurantForge .poi-label{
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);

  font-size: 9px;
  font-weight: 900;
  color: #cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space: nowrap;
  pointer-events: none;
}

#poiFulgurantForge:hover .poi-label{
  color: #fff;
  filter: brightness(1.15);
}

  /* =========================
   ğŸ—º ì§€ë„: ì¶”ì²œ/ì ê¸ˆ ì‚¬ëƒ¥í„° í‘œì‹œ
   - ì¶”ì²œ(>=80%): glow + 'ì¶”ì²œ'
   - ì ê¸ˆ(0%): ì–´ë‘¡ê²Œ + 'ğŸ”’'
   ========================= */

/* ğŸ—º ì§€ë„: ì¶”ì²œ/ì ê¸ˆ ì‚¬ëƒ¥í„° í‘œì‹œ */
/* ğŸ—º ì§€ë„: ì¶”ì²œ/ì ê¸ˆ ì‚¬ëƒ¥í„° í‘œì‹œ (PNG ì‹¤ë£¨ì—£ ê¸€ë¡œìš° ë²„ì „) */

/* âœ… ì¶”ì²œ: ë²„íŠ¼ ë°•ìŠ¤ê°€ ì•„ë‹ˆë¼ "ì´ë¯¸ì§€ ì‹¤ë£¨ì—£"ì— ê¸€ë¡œìš° */
#parchmentMapStage button.poi-hunt-reco,
#parchmentSkyPanel button.poi-hunt-reco{
  /* ë°•ìŠ¤ ê¸€ë¡œìš° ë°©ì§€ */
  box-shadow: none !important;
  filter: none !important;
}

#parchmentMapStage button.poi-hunt-reco img,
#parchmentSkyPanel button.poi-hunt-reco img{
  filter:
    drop-shadow(0 0 6px rgba(255,255,255,0.55))
    drop-shadow(0 0 14px rgba(180,220,255,0.40))
    drop-shadow(0 0 26px rgba(180,220,255,0.22));
  animation: poiRecoPulse 2.2s ease-in-out infinite;
  will-change: filter;
}

@keyframes poiRecoPulse{
  0%, 100%{
    filter:
      drop-shadow(0 0 5px rgba(255,255,255,0.45))
      drop-shadow(0 0 12px rgba(180,220,255,0.32))
      drop-shadow(0 0 22px rgba(180,220,255,0.18));
  }
  50%{
    filter:
      drop-shadow(0 0 8px rgba(255,255,255,0.75))
      drop-shadow(0 0 18px rgba(180,220,255,0.55))
      drop-shadow(0 0 34px rgba(180,220,255,0.30));
  }
}

/* âœ… ì¶”ì²œ ë°°ì§€ */
#parchmentMapStage button.poi-hunt-reco::after,
#parchmentSkyPanel button.poi-hunt-reco::after{
  content:"ì¶”ì²œ";
  position:absolute;
  top:-8px;
  right:-10px;
  font-size:10px;
  padding:2px 6px;
  border-radius:10px;
  background: rgba(255,255,255,0.95);
  color:#111;
  font-weight:900;
  box-shadow: 0 2px 8px rgba(0,0,0,0.35);
  pointer-events:none;
}

/* âœ… ì ê¸ˆ: ì´ë¯¸ì§€ ìì²´ë¥¼ ì–´ë‘¡ê²Œ */
#parchmentMapStage button.poi-hunt-locked,
#parchmentSkyPanel button.poi-hunt-locked{
  box-shadow: none !important;
  filter: none !important;
}

#parchmentMapStage button.poi-hunt-locked img,
#parchmentSkyPanel button.poi-hunt-locked img{
  filter: brightness(0.45) grayscale(0.9);
}

/* âœ… ì ê¸ˆ ë°°ì§€ */
#parchmentMapStage button.poi-hunt-locked::after,
#parchmentSkyPanel button.poi-hunt-locked::after{
  content:"ğŸ”’";
  position:absolute;
  top:-8px;
  right:-10px;
  font-size:12px;
  padding:2px 6px;
  border-radius:10px;
  background: rgba(0,0,0,0.75);
  color:#fff;
  font-weight:900;
  box-shadow: 0 2px 8px rgba(0,0,0,0.35);
  pointer-events:none;
}

    /* ğŸ„ POI: í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„ (ì´ê·¸ë“œë¼ì‹¤ 1/3 í¬ê¸°) */
#poiMushroomVillage{
  position: absolute;

  /* âœ… ìœ„ì¹˜: ì´ê·¸ë“œë¼ì‹¤(47.7%, 43.5%) ê¸°ì¤€ "ì„œìª½ + í˜¸ìˆ˜ ì•„ë˜" */
  left: 34.5%;
  top: 47.0%;

  transform: translate(-50%, -50%);
  width: 60px;   /* âœ… 96pxì˜ 1/3 */
  height: 40px;  /* âœ… 96pxì˜ 1/3 */
  border: 0;
  padding: 0;
  background: transparent;
  cursor: pointer;
  z-index: 5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

#poiMushroomVillage img{
  width: 100%;
  height: 100%;
  display:block;
}

#poiMushroomVillage:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸ„ ë²„ì„¯ë§ˆì„ í…ìŠ¤íŠ¸ ë¼ë²¨ (ì´ê·¸ë“œë¼ì‹¤ì²˜ëŸ¼ í´ë¦­ ìœ ë„) */
#poiMushroomVillage .poi-label{
  position: absolute;
  bottom: -8px;
  left: 52%;
  transform: translateX(-50%);

  font-size: 9px;
  font-weight: 900;
  color: #cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space: nowrap;
  pointer-events: none;
}

  #poiMushroomVillage:hover .poi-label{
  color: #fff;              /* âœ… â€œíšŒìƒ‰ â†’ í°ìƒ‰â€ í™•ì‹¤í•˜ê²Œ */
  filter: brightness(1.15); /* âœ… ì´ê·¸ë“œë¼ì‹¤ ëŠë‚Œ ê·¸ëŒ€ë¡œ */
}

  /* ğŸ€ POI: ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½ (ëŒ€ë¥™ ë‚¨ì„œìª½ ëë‹¨ ê°•í•˜ë¥˜) */
#poiSewer{
  position: absolute;

  /* âœ… ìœ„ì¹˜: â€œë‚¨ì„œìª½ ëë‹¨ + ê°•í•˜ë¥˜â€ ëŠë‚Œìœ¼ë¡œ ì‹œì‘ê°’ */
  left: 36.5%;
  top: 65%;

  transform: translate(-50%, -50%);
  width: 57px;     /* ë²„ì„¯ë§ˆì„ê³¼ ë™ì¼ í¬ê¸° ì‹œì‘ */
  height: 38px;

  border: 0;
  padding: 0;
  background: transparent;
  cursor: pointer;
  z-index: 5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

#poiSewer img{
  width: 100%;
  height: 100%;
  display: block;
}

#poiSewer:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸ€ ì‹œê¶ì°½ í…ìŠ¤íŠ¸ ë¼ë²¨ (ë²„ì„¯ë§ˆì„ê³¼ ë™ì¼: íšŒìƒ‰ â†’ í°ìƒ‰) */
#poiSewer .poi-label{
  position: absolute;
  bottom: -8px;
  left: 52%;
  transform: translateX(-50%);

  font-size: 9px;
  font-weight: 900;
  color: #cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space: nowrap;
  pointer-events: none;
}

#poiSewer:hover .poi-label{
  color: #fff;
  filter: brightness(1.15);
}

  /* ğŸœï¸ POI: ë¬´ë²•ìë“¤ì˜ í™©ì•¼ (ì´ê·¸ë“œë¼ì‹¤ í•˜ë‹¨ í‰ì•¼) */
#poiOutlawWasteland{
  position: absolute;

  /* âœ… ìœ„ì¹˜: ì´ê·¸ë“œë¼ì‹¤ í•˜ë‹¨ í‰ì•¼ */
  left: 46.5%;
  top: 71.5%;

  transform: translate(-50%, -50%);
  width: 66px;
  height: 44px;

  border: 0;
  padding: 0;
  background: transparent;
  cursor: pointer;
  z-index: 5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline: none;
  user-select: none;
  -webkit-user-select: none;
}

#poiOutlawWasteland img{
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

#poiOutlawWasteland:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸœï¸ ë¬´ë²•ìë“¤ì˜ í™©ì•¼ ë¼ë²¨ */
#poiOutlawWasteland .poi-label{
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);

  font-size: 9px;
  font-weight: 900;
  color: #cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space: nowrap;
  pointer-events: none;
}

#poiOutlawWasteland:hover .poi-label{
  color: #fff;
  filter: brightness(1.15);
}

/* ğŸŒ¿ POI: ëŠªì—˜í”„ì˜ ìˆ² (ì´ê·¸ë“œë¼ì‹¤ ë°”ë¡œ ë°‘) */
#poiSwampElfForest{
  position:absolute;

  /* âœ… ìœ„ì¹˜: ì´ê·¸ë“œë¼ì‹¤ ë°”ë¡œ ì•„ë˜(ì‹œì‘ê°’) */
  left: 53.7%;
  top: 54.5%;

  transform: translate(-50%, -50%);
  width: 66px;   /* ë‹¤ë¥¸ ì†Œí˜• POIì™€ ë™ì¼ ì‹œì‘ */
  height: 44px;

  border:0;
  padding:0;
  background:transparent;
  cursor:pointer;
  z-index:5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline:none;
  user-select:none;
  -webkit-user-select:none;
}

#poiSwampElfForest img{
  width:100%;
  height:100%;
  display:block;
}

#poiSwampElfForest:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸŒ¿ ëŠªì—˜í”„ì˜ ìˆ² í…ìŠ¤íŠ¸ ë¼ë²¨ */
#poiSwampElfForest .poi-label{
  position:absolute;
  bottom:-8px;
  left:52%;
  transform:translateX(-50%);

  font-size:9px;
  font-weight:900;
  color:#cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space:nowrap;
  pointer-events:none;
}

/* âœ… ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´: íšŒìƒ‰ â†’ í°ìƒ‰ (ì´ê·¸ë“œë¼ì‹¤/ë²„ì„¯ë§ˆì„ê³¼ ë™ì¼) */
#poiSwampElfForest:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}

  /* â„ï¸ POI: ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´ (ì´ê·¸ë“œë¼ì‹¤ ë¶ë™ìª½) */
#poiFrostQueenCave{
  position:absolute;

  /* âœ… ìœ„ì¹˜: ì´ê·¸ë“œë¼ì‹¤ ë¶ë™ìª½ (ì‹œì‘ê°’) */
  left: 49%;
  top: 21%;

  transform: translate(-50%, -50%);
  width: 72px;
  height: 48px;

  border:0;
  padding:0;
  background:transparent;
  cursor:pointer;
  z-index:5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline:none;
  user-select:none;
  -webkit-user-select:none;
}

#poiFrostQueenCave img{
  width:100%;
  height:100%;
  display:block;
}

#poiFrostQueenCave:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* â„ï¸ ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´ ë¼ë²¨ */
#poiFrostQueenCave .poi-label{
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);

  font-size:9px;
  font-weight:900;
  color:#cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space:nowrap;
  pointer-events:none;
}

/* âœ… hover ì‹œ íšŒìƒ‰ â†’ í°ìƒ‰ */
#poiFrostQueenCave:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}

  /* ğŸ‘» POI: ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„ (ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´ë³´ë‹¤ ë” ë™ìª½) */
#poiDeathWorld{
  position:absolute;

  /* âœ… ìœ„ì¹˜: ì´ê·¸ë“œë¼ì‹¤ ë™ìª½, ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´ë³´ë‹¤ ë” ë™ìª½ (ì‹œì‘ê°’) */
  left: 67.5%;
  top: 33%;

  transform: translate(-50%, -50%);
  width: 72px;
  height: 48px;

  border:0;
  padding:0;
  background:transparent;
  cursor:pointer;
  z-index:5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline:none;
  user-select:none;
  -webkit-user-select:none;
}

#poiDeathWorld img{
  width:100%;
  height:100%;
  display:block;
}

#poiDeathWorld:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸ‘» ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„ ë¼ë²¨ */
#poiDeathWorld .poi-label{
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);

  font-size:9px;
  font-weight:900;
  color:#cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space:nowrap;
  pointer-events:none;
}

/* âœ… ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´: íšŒìƒ‰ â†’ í°ìƒ‰ (ê¸°ì¡´ POIë“¤ê³¼ ë™ì¼) */
#poiDeathWorld:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}

  /* ğŸ”¥ POI: ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´ (ì´ê·¸ë“œë¼ì‹¤ ë¶ìª½ / ì„œë¦¬ì—¬ì™•ë³´ë‹¤ ë” ë¶ìª½) */
#poiBehemothPit{
  position:absolute;

  /* âœ… ìœ„ì¹˜ ì‹œì‘ê°’: ì´ê·¸ë“œë¼ì‹¤ ë¶ìª½, ì„œë¦¬ì—¬ì™•ë³´ë‹¤ ë” ìœ„ */
  left: 73%;
  top: 16%;

  transform: translate(-50%, -50%);
  width: 76px;
  height: 50px;

  border:0;
  padding:0;
  background:transparent;
  cursor:pointer;
  z-index:5;

  -webkit-tap-highlight-color: rgba(0,0,0,0);
  outline:none;
  user-select:none;
  -webkit-user-select:none;
}

#poiBehemothPit img{
  width:100%;
  height:100%;
  display:block;
}

#poiBehemothPit:active{
  transform: translate(-50%, -50%) scale(1.08);
}

/* ğŸ”¥ ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´ ë¼ë²¨ */
#poiBehemothPit .poi-label{
  position:absolute;
  bottom:-8px;
  left:50%;
  transform:translateX(-50%);

  font-size:9px;
  font-weight:900;
  color:#cfcfcf;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);

  white-space:nowrap;
  pointer-events:none;
}

/* âœ… hover ì‹œ íšŒìƒ‰ â†’ í°ìƒ‰ */
#poiBehemothPit:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}
  
/* =========================
   â˜ï¸ 2ë²ˆ(í•˜ëŠ˜) ì§€ë„ ì˜¤ë²„ë ˆì´ (1ë²ˆ ìœ„ì— ê²¹ì¹¨)
   ========================= */
#parchmentSkyOverlay{
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.65);
  z-index: 2600; /* âœ… 1ë²ˆë³´ë‹¤ ìœ„ */
}

#parchmentSkyPanel{
  position: relative;

  /* ğŸŒ ì›”ë“œë§µ ëŒ€ë¹„ 90% í¬ê¸° */
  width: min(86vw, 810px);          /* â† ì›”ë“œë§µ(900px)ì˜ ì•½ 90% */
  max-height: calc(100vh - 72px);

  background: transparent;
  overflow: visible;
}

#parchmentSkyImg{
  width: 100%;
  height: auto;
  display: block;
  user-select: none;
  -webkit-user-drag: none;
}

#parchmentSkyCloseBtn{
  position:absolute;
  right:66px;
  top:28px;
  z-index:3;

  /* âœ… â€œíšŒìƒ‰ ë°•ìŠ¤â€ ì œê±° â†’ í…ìŠ¤íŠ¸ë§Œ */
  background:transparent;
  border:0;
  padding:4px 6px;

  /* âœ… ì–‘í”¼ì§€ í†¤ë³´ë‹¤ ì§„í•œ ê°ˆìƒ‰ */
  color:#9a9a9a;
  font-size:12px;
  font-weight:900;
  letter-spacing:-0.2px;

  /* í´ë¦­ì€ ì˜ ë˜ê²Œ */
  cursor:pointer;

  /* ì–‘í”¼ì§€ ìœ„ì—ì„œ ì½íˆê²Œ ì‚´ì§ë§Œ */
  text-shadow:
    0 1px 0 rgba(255,255,255,0.25),
    0 1px 2px rgba(0,0,0,0.35);
}

#parchmentSkyCloseBtn:hover{
  color:#bdbdbd;
  filter:brightness(1.05);
}

#parchmentSkyCloseBtn:active{
  transform:translateY(1px);
}

  /* âœ… (ì¶”ê°€) í•˜ëŠ˜ë§µ POI: ëŒ€ì²œì‚¬ì˜ ìš”ëŒ */
#poiArchangelCradle{
  position:absolute;
  left:76%;
  top:42%;
  transform:translate(-50%,-50%);
  width:150px;
  height:100px;
  background:transparent;
  border:0;
  padding:0;
  cursor:pointer;
  z-index:2;
}
#poiArchangelCradle img{
  width:100%;
  height:100%;
  image-rendering:auto;
}
/* ğŸŒŒ í•˜ëŠ˜ë§µ POI: ëŒ€ì²œì‚¬ì˜ ìš”ëŒ ë¼ë²¨ (ì›”ë“œë§µ ìŠ¤íƒ€ì¼ í†µì¼) */
#poiArchangelCradle .poi-label{
  position:absolute;
  top:100%;
  left:55%;
  transform:translateX(-50%);
  margin-top:-8px;

  font-size:11px;
  font-weight:900;
  color:#cfcfcf;

  white-space:nowrap;
  pointer-events:none;

  /* âœ… ì›”ë“œë§µê³¼ ë™ì¼í•œ í…ìŠ¤íŠ¸ í…Œë‘ë¦¬ */
  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);
}

/* hover ì‹œ ê°•ì¡° (ì›”ë“œë§µê³¼ ë™ì¼) */
#poiArchangelCradle:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}

/* âœ… (ì¶”ê°€) í•˜ëŠ˜ë§µ POI: ì‹ ì˜ ì²˜ì†Œ */
#poiGodSanctum{
  position:absolute;
  left:47%;
  top:20%;
  transform:translate(-50%,-50%);
  width:120px;
  height:80px;
  background:transparent;
  border:0;
  padding:0;
  cursor:pointer;
  z-index:2;
}
#poiGodSanctum img{
  width:100%;
  height:100%;
  image-rendering:auto;
}
#poiGodSanctum .poi-label{
  position:absolute;
  top:100%;
  left:56%;
  transform:translateX(-50%);
  margin-top:-8px;

  font-size:11px;
  font-weight:900;
  color:#cfcfcf;

  white-space:nowrap;
  pointer-events:none;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);
}
#poiGodSanctum:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}

/* âœ… (ì¶”ê°€) í•˜ëŠ˜ë§µ POI: ì°¨ì›ì˜ í‹ˆìƒˆ (ìš°ì¸¡ìƒë‹¨ ëª¨ì„œë¦¬, ì‘ê²Œ) */
#poiDimensionalRift{
  position:absolute;
  left:18%;
  top:17%;
  transform:translate(-50%,-50%);
  width:60px;   /* ì‘ê²Œ */
  height:40px;   /* ì‘ê²Œ */
  background:transparent;
  border:0;
  padding:0;
  cursor:pointer;
  z-index:2;
}
#poiDimensionalRift img{
  width:100%;
  height:100%;
  image-rendering:auto;
}
#poiDimensionalRift .poi-label{
  position:absolute;
  top:100%;
  left:50%;
  transform:translateX(-50%);
  margin-top:-12px;

  font-size:11px;
  font-weight:900;
  color:#cfcfcf;

  white-space:nowrap;
  pointer-events:none;

  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000,
     0  2px 4px rgba(0,0,0,0.8);
}
#poiDimensionalRift:hover .poi-label{
  color:#fff;
  filter: brightness(1.15);
}

/* =========================
   ğŸ« ë³´ìŠ¤ í˜¸í¡ ì—…ê·¸ë ˆì´ë“œ + ê·¸ë¦¼ì
   - wrapì´ ê¸°ì¤€ì ì´ ë˜ê²Œ ì¡ì•„ì¤˜ì•¼ hit-sparkë„ ì•ˆì •ì ìœ¼ë¡œ ëœ¸
   ========================= */

/* âœ… wrapì„ "ë³´ìŠ¤ ì „ìš© ë ˆì´ì–´"ë¡œ ì•ˆì •í™” */
#bossBattleBossWrap{
  position:absolute;
  inset:0;
  pointer-events:auto;  /* âœ… wrapì€ í´ë¦­ì„ ë§‰ì§€ ì•Šê²Œ */
}

/* ê·¸ë¦¼ì/ìŠ¤íŒŒí¬ëŠ” í´ë¦­ì„ ì ˆëŒ€ ë¨¹ìœ¼ë©´ ì•ˆ ë¨ */
#bossBattleBossShadow{ pointer-events:none; }
#bossBattleBossWrap::after{ pointer-events:none; }

/* ë³´ìŠ¤ ì´ë¯¸ì§€ëŠ” í´ë¦­ ê°€ëŠ¥ */
#bossBattleBossImg{ pointer-events:auto; }

/* âœ… ë³´ìŠ¤ ì´ë¯¸ì§€ëŠ” í´ë¦­ ê°€ëŠ¥í•´ì•¼ í•˜ë‹ˆê¹Œ ë‹¤ì‹œ ì‚´ë ¤ì¤Œ */
#bossBattleBossImg{
  pointer-events:auto;
  z-index:10;
}

/* âœ… ë°”ë‹¥ ê·¸ë¦¼ì (ì´ë¯¸ì§€ ì•„ë˜) */
#bossBattleBossShadow{
  position:absolute;
  left:50%;
  top:70%;
  width:min(320px, 55vw);
  height: min(110px, 18vw);
  transform: translate(-50%,-50%);
  border-radius: 999px;
  background: radial-gradient(ellipse at center,
    rgba(0,0,0,0.55) 0%,
    rgba(0,0,0,0.25) 45%,
    rgba(0,0,0,0.0) 72%);
  filter: blur(6px);
  opacity: 0.55;
  z-index:6;
  pointer-events:none;
  will-change: transform, opacity, filter;
}

/* âœ… í˜¸í¡ ì• ë‹ˆë©”ì´ì…˜(ìì—°ìŠ¤ëŸ½ê²Œ): scale + ë¯¸ì„¸í•œ y ì´ë™ + ì•½ê°„ì˜ ë¦¬ë“¬ */
#bossBattleBossImg.boss-breathe{
  transform-origin: 50% 72%;
  animation: bossBreathNatural 3.4s cubic-bezier(.45,0,.55,1) infinite;
  will-change: transform;
}

/* âœ… ê·¸ë¦¼ìë„ í˜¸í¡ì— ë§ì¶° ë³€í˜•(ì»¤ì§€ë©´ ê·¸ë¦¼ìëŠ” ì•½ê°„ í¼ì§€ê³  ì§„í•´ì§) */
#bossBattleBossShadow.boss-breathe-shadow{
  animation: bossShadowBreath 3.4s cubic-bezier(.45,0,.55,1) infinite;
}

/* âœ… ìì—°ìŠ¤ëŸ¬ìš´ ìˆ¨: ë“¤ìˆ¨ì—ì„œ ì‚´ì§ â€œìœ„ë¡œ/ì•ìœ¼ë¡œâ€ ì˜¤ëŠ” ëŠë‚Œ(ë¯¸ì„¸) */
@keyframes bossBreathNatural {
  0%   { transform: translate(-50%,-50%) scale(1.000) translateY(0px); }

  /* ë“¤ìˆ¨: í•œ ë²ˆì— */
  32%  { transform: translate(-50%,-50%) scale(1.018) translateY(-2px); }

  /* ì •ì : ì•„ì£¼ ì§§ê²Œ ìœ ì§€ */
  42%  { transform: translate(-50%,-50%) scale(1.018) translateY(-2px); }

  /* ë‚ ìˆ¨: ê¸¸ê³  ë¶€ë“œëŸ½ê²Œ */
  100% { transform: translate(-50%,-50%) scale(1.000) translateY(0px); }
}

@keyframes bossShadowBreath {
  0%   { transform: translate(-50%,-50%) scale(1.00); opacity:0.52; }
  42%  { transform: translate(-50%,-50%) scale(1.10); opacity:0.60; }
  100% { transform: translate(-50%,-50%) scale(1.00); opacity:0.52; }
}
  
  /* =========================
   ğŸ’¥ ë³´ìŠ¤ í”¼ê²© ì—°ì¶œ (wrapì´ í”ë“¤ë¦¬ê³ , ë¹›/ê¸€ë¡œìš°ê°€ ë²ˆì©)
   ========================= */

#bossBattleBossWrap.hit {
  animation: bossHitShake 140ms ease-out 1;
}

@keyframes bossHitShake {
  0%   { transform: translateX(0); }
  20%  { transform: translateX(-4px); }
  45%  { transform: translateX(3px); }
  70%  { transform: translateX(-2px); }
  100% { transform: translateX(0); }
}

/* ë²ˆì©ì´ëŠ” í•˜ì–€ í”Œë˜ì‹œ + ë¶‰ì€ ê¸€ë¡œìš° */
#bossBattleBossImg.hit-flash {
  animation: bossHitFlash 160ms ease-out 1;
  will-change: filter;
}

@keyframes bossHitFlash {
  0% {
    filter: brightness(1) drop-shadow(0 0 0 rgba(255,0,0,0));
  }
  35% {
    filter: brightness(1.35) drop-shadow(0 0 14px rgba(255,60,60,0.75));
  }
  100% {
    filter: brightness(1) drop-shadow(0 0 0 rgba(255,0,0,0));
  }
}

/* ìŠ¤íŒŒí¬(ì§§ì€ ì›í˜• ì„¬ê´‘) - wrapì— pseudoë¡œ ìƒì„± */
#bossBattleBossWrap::after{
  content:"";
  position:absolute;
  left:50%;
  top:52%;
  width: 120px;
  height: 120px;
  transform: translate(-50%,-50%) scale(0.6);
  pointer-events:none;
  opacity:0;
  border-radius:999px;
  background: radial-gradient(circle,
    rgba(255,255,255,0.95) 0%,
    rgba(255,210,210,0.55) 35%,
    rgba(255,80,80,0.25) 60%,
    rgba(0,0,0,0) 72%);
  mix-blend-mode: screen;
}

#bossBattleBossWrap.hit-spark::after{
  animation: bossHitSpark 180ms ease-out 1;
}

@keyframes bossHitSpark{
  0%   { opacity:0; transform:translate(-50%,-50%) scale(0.55); }
  35%  { opacity:1; transform:translate(-50%,-50%) scale(1.05); }
  100% { opacity:0; transform:translate(-50%,-50%) scale(1.2); }
}

/* =========================
   ğŸ‘† í™”ë©´ í„°ì¹˜/í´ë¦­ ìœ„ì¹˜ í‘œì‹œ(ë¦¬í”Œ) - ê°•í™” ë²„ì „
   ========================= */
.touchRipple {
  position: fixed;
  left: 0; top: 0;
  width: 22px; height: 22px;          /* â¬… ê¸°ë³¸ í¬ê¸° ì¦ê°€ */
  border-radius: 999px;
  pointer-events: none;
  z-index: 500000;

  /* ì¤‘ì‹¬ì´ ë” ë˜ë ·í•œ ê¸ˆë¹› ë§ˆë ¥ ë§ */
  background: radial-gradient(circle,
    rgba(255, 235, 170, 0.55) 0%,
    rgba(255, 215, 120, 0.28) 40%,
    rgba(255, 215, 120, 0.10) 55%,
    rgba(255, 215, 120, 0.00) 75%);
  
  border: 2px solid rgba(255, 225, 150, 0.85); /* â¬… í…Œë‘ë¦¬ ì„ ëª… */
  box-shadow:
    0 0 12px rgba(255, 225, 150, 0.55),
    0 0 24px rgba(255, 210, 120, 0.30),
    inset 0 0 6px rgba(255, 255, 255, 0.35);

  transform: translate(-50%, -50%) scale(0.55);
  opacity: 1;
  animation: touchRippleAnim 560ms ease-out forwards;
  will-change: transform, opacity, filter;
}

@keyframes touchRippleAnim {
  0% {
    transform: translate(-50%, -50%) scale(0.55);
    opacity: 1;
    filter: blur(0px);
  }
  45% {
    transform: translate(-50%, -50%) scale(2.8); /* â¬… í¼ì§ ì¦ê°€ */
    opacity: 0.75;
    filter: blur(0.3px);
  }
  100% {
    transform: translate(-50%, -50%) scale(3.8); /* â¬… ìµœì¢… í¬ê¸° ì¦ê°€ */
    opacity: 0;
    filter: blur(0.9px);
  }
}

/* ëª¨ë°”ì¼ ê¸°ë³¸ í„°ì¹˜ í•˜ì´ë¼ì´íŠ¸ ì œê±° */
html, body {
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}

/* ===== ê°ì¸ í…ìŠ¤íŠ¸ ì—°ì¶œ ===== */
.engrave-line {
  position: relative;
  font-weight: 900;
  letter-spacing: 0.2px;
}

.engrave-line.is-rolling {
  animation: engraveFadeOut 0.55s ease forwards;
}

.engrave-line.is-flash {
  animation: engraveFlash 0.35s ease-out forwards;
}

.engrave-line.is-reveal {
  animation: engraveReveal 0.45s ease-out forwards;
}

@keyframes engraveFadeOut {
  0%   { opacity: 1; filter: none; transform: translateY(0); }
  100% { opacity: 0.08; filter: blur(1px); transform: translateY(1px); }
}

@keyframes engraveFlash {
  0%   { opacity: 0.2; text-shadow: none; filter:none; }
  40%  { opacity: 1;   text-shadow: 0 0 10px rgba(255,220,120,0.9), 0 0 22px rgba(255,220,120,0.6); }
  100% { opacity: 0.9; text-shadow: 0 0 6px rgba(255,220,120,0.45); }
}

@keyframes engraveReveal {
  0%   { opacity: 0.0; filter: blur(1px); transform: translateY(2px); text-shadow: 0 0 0 rgba(0,0,0,0); }
  55%  { opacity: 1.0; filter: none; transform: translateY(0); text-shadow: 0 0 10px rgba(255,220,120,0.75), 0 0 20px rgba(255,220,120,0.35); }
  100% { opacity: 1.0; text-shadow: 0 0 6px rgba(255,220,120,0.30); }
}

/* ì—°ì¶œ ì¤‘ ë²„íŠ¼ ì ê¸ˆ ì‹œ ì‹œê° ì²˜ë¦¬ */
#engraveOverlay .btn-disabled {
  pointer-events: none !important;
  opacity: 0.45 !important;
  filter: grayscale(0.2);
}
  
</style>
</head>

<body>
  <div id="appFrame">

<!-- ğŸ” ë¡œê·¸ì¸ -->
<div id="loginScreen">
<h2>
  ğŸ” ë¡œê·¸ì¸
  <span style="font-size:0.7em; color:#888; margin-left:4px;">
    (v4.362)
  </span>
</h2>
  <input id="loginId" placeholder="ì•„ì´ë””"><br><br>
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><br><br>
  <button onclick="login()">ì ‘ì†</button>
  <button onclick="createAccount()">ì‹ ê·œ ìƒì„±</button>
</div>
  
<!-- ğŸ® ê²Œì„ -->
<div id="gameScreen" style="display:none;">
  <h1 class="game-title">
    <img
      src="images/ui/title_forge.png"
      alt="í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„"
      class="game-title-logo"
    >
  </h1>

<div id="updateNoticeBar"
     style="font-size:13px; color:#aaa; margin-top:4px; cursor:pointer; display:none;"
     onclick="openLatestNoticePopup()">
  / <span style="color:#ff5555; font-weight:bold;">[ê³µì§€]</span>
    <span id="updateNoticeTitle" style="margin-left:4px;">ì‹ ê·œ (v3.6) ì—…ë°ì´íŠ¸ í™•ì¸í•˜ê¸°</span> /
</div>

    <hr class="section-divider">
  
  <!-- ğŸ”¥ ì‚¬ëƒ¥í„° ë°°ê²½ ë°•ìŠ¤ (í”„ë¡œí•„~ë­í‚¹ ì „ì²´ë¥¼ ê°ìŒˆ) -->
  <div id="fieldBg" class="field-bg">

  <!-- ğŸ—º í˜„ì¬ ì‚¬ëƒ¥í„° ì •ë³´ (í”„ë¡œí•„ ì¹´ë“œ ë°”ê¹¥ ìƒë‹¨) -->
<div class="field-topbar">
  <div id="currentFieldInfo" class="current-field-info"></div>

  <!-- âœ… ìƒë‹¨ ì¬í™”ë°” -->
<div id="topCurrencyBar" class="top-currency-bar">
  <div class="top-currency-item" title="ê³¨ë“œ">
    <img src="images/items/gold.png" alt="ê³¨ë“œ">
    <span id="topGoldText">0</span>
  </div>

  <div class="top-currency-item" title="ë¹›ë‚˜ì§€ ëª»í•  ë³„ì˜ì¡°ê°">
    <img src="images/items/star_shard.png" alt="ë³„ì˜ì¡°ê°">
    <span id="topStarShardText">0</span>
  </div>

  <div class="top-currency-item" title="ëª…ì˜ˆì˜í›ˆì¥">
    <img src="images/items/medal_honor.png" alt="ëª…ì˜ˆì˜í›ˆì¥">
    <span id="topHonorMedalText">0</span>
  </div>
</div>

  <!-- ğŸ—º MAP ì•„ì´ì½˜ ë²„íŠ¼(ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€: toggleMap) -->
  <button id="mapBtn" class="map-icon-btn" onclick="openParchmentMap()" data-nosfx="1">
    <img class="map-icon-img" src="images/ui/icon_map_roll.png" alt="MAP">
    <span class="map-icon-label">ì§€ë„</span>
  </button>

     <!-- âš”ï¸ ê²°íˆ¬ì¥ (ì§€ë„ ìŠ¤íƒ€ì¼) -->
  <button id="duelIconBtn" class="map-icon-btn" onclick="openDuelArena()" data-nosfx="1">
    <img class="map-icon-img" src="images/ui/icon_duel.png" alt="ê²°íˆ¬ì¥">
    <span class="map-icon-label">ê²°íˆ¬ì¥</span>
  </button>

  <!-- ğŸ›ï¸ ëª¨í—˜ê°€ê¸¸ë“œ (ì§€ë„ ìŠ¤íƒ€ì¼) -->
  <button id="guildIconBtn" class="map-icon-btn" onclick="openAdventureGuild()" data-nosfx="1">
    <img class="map-icon-img" src="images/ui/icon_guild.png" alt="ëª¨í—˜ê°€ê¸¸ë“œ">
    <div id="adventureGuildAlertBadge" class="icon-alert-badge">!</div>
    <span class="map-icon-label">ëª¨í—˜ê°€<br>ê¸¸ë“œ</span>
  </button>
  
  <!-- ğŸ‘¥ ì „ì²´ìœ ì € (ì§€ë„ ìŠ¤íƒ€ì¼) -->
  <button id="userListIconBtn" class="map-icon-btn" onclick="openUserListOverlay()" data-nosfx="1">
    <img class="map-icon-img" src="images/ui/icon_users.png" alt="ì „ì²´ìœ ì €">
    <span class="map-icon-label one-line">ìœ ì €ê²€ìƒ‰</span>
  </button>

  <button id="bossBattleIconBtn"
        class="map-icon-btn"
        onclick="onBossBattleIconClick()" data-nosfx="1">
  <img src="images/ui/icon_boss.png" class="map-icon-img">
  <div id="bossBattleAlertBadge" class="icon-alert-badge">!</div>
  <span class="map-icon-label">ë³´ìŠ¤ì „</span>
</button>

  <!-- ğŸ“… ì¶œì„ (ì¢Œì¸¡ ì•„ì´ì½˜) -->
<button id="attendanceIconBtn"
        class="map-icon-btn left-icon-btn"
        onclick="checkAttendance()" data-nosfx="1">
  <img class="map-icon-img" src="images/ui/icon_attendance.png" alt="ì¶œì„">

  <!-- âœ… ë¯¸ì¶œì„ ì•Œë¦¼ ë±ƒì§€ (ì•„ì´ì½˜ ë‚´ë¶€ ìš°ìƒë‹¨) -->
  <div id="attendanceAlertBadge" class="icon-alert-badge">!</div>

  <span class="map-icon-label">ì¶œì„</span>
</button>

<!-- ğŸ† ì—…ì  (ì¢Œì¸¡ ì•„ì´ì½˜) -->
<button id="achievementIconBtn"
        class="map-icon-btn left-icon-btn"
        onclick="openTitleOverlay()" data-nosfx="1">
  <img class="map-icon-img" src="images/ui/icon_achievement.png" alt="ì—…ì ">
  <div id="achievementAlertBadge" class="icon-alert-badge">!</div>
  <span class="map-icon-label">ì—…ì </span>
</button>
  
</div>

    <!-- ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì¹´ë“œ -->
<div id="userProfileArea">
  <!-- ğŸ“· í”„ë¡œí•„ ì €ì¥ ë²„íŠ¼ -->
  <button class="profile-share-btn no-capture"
          onclick="saveProfileCard()"
          title="í”„ë¡œí•„ ì €ì¥">
    â¬‡ï¸
  </button>

  <!-- ğŸ”” ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ -->
  <div id="profileSaveStatus"
       class="profile-save-status no-capture"></div>

  <div class="profile-card-inner">
    <!-- ğŸ” ë‹‰ë„¤ì„ (ì¹´ë“œ ìµœìƒë‹¨) -->
    <div class="profile-nickname" id="profileNickname">-</div>
    
    <!-- âš”ï¸ ê²€ ì´ë¯¸ì§€ -->
    <div class="profile-weapon-box">
       <div id="weaponFxLayer" class="weapon-fx-layer"></div>
      <img id="weaponImage"
           src="images/weapons/sword_real_temp.png"
           alt="ë‚´ ë¬´ê¸°">
    </div>

    <!-- âš”ï¸ ê²€ ì´ë¦„ / ì„¤ëª… / ìŠ¤íƒ¯ -->
    <div class="profile-info-box">

      <!-- âœ… ê²€ ì´ë¦„ (+í˜„ì¬ ê°•í™”) -->
      <div class="profile-weapon-title" id="profileWeaponTitle">
        - (+0ê°•)
      </div>

      <hr class="profile-inner-divider">

      <!-- âœ… ê²€ ì„¤ëª… -->
      <div class="profile-weapon-desc" id="profileWeaponDesc">
        -
      </div>

      <hr class="profile-inner-divider">

      <!-- âœ… ìµœëŒ€ ê°•í™” + íŒŒê´´ íšŒìˆ˜ -->
      <div class="profile-row">
        <span class="profile-label">ìµœëŒ€ ê°•í™”</span>
        <span class="profile-value" id="profileMaxInfo">
          +0ê°• <span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ 0íšŒ)</span>
        </span>
      </div>

      <!-- ê¸°ì¡´ ìŠ¤íƒ¯ë“¤ ìœ ì§€ -->
      <div class="profile-row">
        <span class="profile-label">ì „íˆ¬ë ¥</span>
        <span class="profile-value" id="profilePower">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ë¬´ê¸°ê°€ì¹˜</span>
        <span class="profile-value" id="profileWeaponValue">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ì „ì </span>
        <span class="profile-value" id="profileRecord">ìŠ¹ 0 / íŒ¨ 0</span>
      </div>
    </div>
  </div>
</div>


  <hr class="section-divider">

   <!-- ğŸ”½ ë§µ ì†Œê°œ ë¬¸êµ¬ í‘œì‹œ ì˜ì—­ -->
<p id="fieldDescription"
   style="font-size:13px; color:#ccc; margin:10px 0 6px 0;"></p>

<hr class="section-divider">

    
  <!-- ê¸°ì¡´ ìƒíƒœ í‘œì‹œ -->
  <p id="status"></p>
<p id="upgradeInfo"
   style="font-size:14px; margin-top:4px; margin-bottom:8px; color:#ccc;">
</p>

<div class="action-buttons">
  <button id="upgradeBtn" onclick="playUiTap(); upgrade()"data-nosfx="1"> ê°•í™”</button>
  <button id="huntBtn" onclick="playUiTap(); hunt()"data-nosfx="1"> ì‚¬ëƒ¥</button>
  <button id="sellBtn" onclick="playUiTap(); sell()"data-nosfx="1"> íŒë§¤</button>

  <!-- ğŸ›ï¸ 30ê°• ì „ìš©: ëª…ì˜ˆì˜ ì „ë‹¹ ë³´ë‚´ê¸° -->
  <button id="hallBtn"
          onclick="openHonorHallSendPopup()"
          style="display:none;">
    ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸°
  </button>
</div>
    
<p id="huntInfo" style="margin-top:4px; color:#ccc; font-size:13px;"></p>
    
<!-- ğŸ¯ ê°•í™” ì•„ì´í…œ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
<div id="upgradeItems" style="margin-top:8px; font-size:13px;">
  <label style="margin-right:8px;">
    <input type="checkbox" id="useScroll15">
    <span id="labelUseScroll15">15ê°• ê°•í™” ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useScroll21">
    <span id="labelUseScroll21">21ê°• ê°•í™” ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useProtect">
    <span id="labelUseProtect">íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useDownProtect">
    <span id="labelUseDownProtect">ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label>
    <input type="checkbox" id="useSuper">
    <span id="labelUseSuper">ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ (0)</span>
  </label>
  <label>
    <input type="checkbox" id="useRateUp5">
    <span id="labelUseRateUp5">ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ (0)</span>
  </label>
</div>

  <hr>
    
  </div> <!-- ğŸ”š fieldBg : ë°°ê²½ì€ ì—¬ê¸°ê¹Œì§€ë§Œ -->
  
  <h2>ğŸ† ë­í‚¹ TOP 10</h2>
  <div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="myRank" style="margin-top:8px; font-size:14px; color:#ccc;"></div>

  <!-- ğŸŒˆ ëª…ì˜ˆì˜ ì „ë‹¹ -->
<div id="hallOfFameBox"
     style="margin:22px auto 0 auto; max-width:320px; border:1px solid #444; border-radius:8px; padding:8px;"
  <div style="font-weight:bold; margin-bottom:6px; text-align:center;">
    ğŸŒˆ ëª…ì˜ˆì˜ ì „ë‹¹
  </div>
  <div id="hallOfFameList"
       style="font-size:12px; color:#ddd; max-height:180px; overflow-y:auto;">
    ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
  </div>
</div>

  <!-- ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ëœ¨ëŠ” ì‘ì€ ë©”ë‰´ -->
<div id="rankProfileMenu">
  <button id="rankProfileViewBtn">ğŸ‘ í”„ë¡œí•„ ë³´ê¸°</button>
</div>

<!-- ğŸ“¢ ì—…ë°ì´íŠ¸ ê³µì§€ íŒì—… -->
<div id="updateNoticeOverlay" onclick="closeUpdateNoticePopup()">
  <div class="update-notice-box" onclick="event.stopPropagation()">
    <div class="update-notice-title" id="updateNoticePopupTitle"></div>
    <div class="update-notice-content" id="updateNoticePopupContent"></div>

    <div class="update-notice-nav">
      <button onclick="showPrevNotice()">â—€ ì´ì „</button>
      <span id="updateNoticeIndexLabel"></span>
      <button onclick="showNextNotice()">ë‹¤ìŒ â–¶</button>
    </div>

    <button style="margin-top:8px; width:100%; padding:6px 0;"
            onclick="closeUpdateNoticePopup()">
      ë‹«ê¸°
    </button>
  </div>
</div>
  
</div> <!-- ğŸ”š gameScreen -->

  <!-- ğŸ” í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼ (í”„ë ˆì„ ë‚´ë¶€ ìš°ì¸¡ìƒë‹¨) -->
<button id="hamburgerBtn" data-nosfx="1" type="button" aria-label="ë©”ë‰´" onclick="toggleHamburgerMenu(event)" style="display:none;">
  <span class="hb-line"></span>
  <span class="hb-line"></span>
  <span class="hb-line"></span>
</button>

<!-- ğŸ” í–„ë²„ê±° ë©”ë‰´ íŒ¨ë„ -->
<div id="hamburgerMenu" style="display:none;">
  <button type="button" class="hm-item" onclick="openCouponPopup(); closeHamburgerMenu();">ì¿ í°ì…ë ¥</button>
  <button type="button" class="hm-item" onclick="logout(); closeHamburgerMenu();">ë¡œê·¸ì•„ì›ƒ</button>
  <div class="hm-item" onclick="openSoundSetting()">ì†Œë¦¬ì„¤ì •</div>

</div>

  <!-- ğŸ”Š ì†Œë¦¬ì„¤ì • ì˜¤ë²„ë ˆì´ -->
<div id="soundSettingOverlay"
     onclick="if(event.target===this) closeSoundSetting();"
     style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:99999; align-items:center; justify-content:center;">
  <div onclick="event.stopPropagation()"
       style="width:min(360px, 92vw); background:#1f1f1f; border:1px solid rgba(255,255,255,0.12); border-radius:14px; padding:16px; color:#fff;">
    <div style="font-weight:800; font-size:16px; margin-bottom:12px;">ğŸ”Š ì†Œë¦¬ì„¤ì •</div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0;">
      <div style="opacity:0.9;">BGM</div>
      <select id="bgmLevelSelect" style="background:#111; color:#fff; border:1px solid rgba(255,255,255,0.18); border-radius:10px; padding:6px 10px;">
        <option value="0">0 (ìŒì†Œê±°)</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option>
      </select>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin:10px 0;">
      <div style="opacity:0.9;">Effect</div>
      <select id="sfxLevelSelect" style="background:#111; color:#fff; border:1px solid rgba(255,255,255,0.18); border-radius:10px; padding:6px 10px;">
        <option value="0">0 (ìŒì†Œê±°)</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button onclick="closeSoundSetting()" style="flex:1; padding:10px 0; border-radius:10px; border:0; background:#333; color:#fff; font-weight:700;">ë‹«ê¸°</button>
      <button onclick="applySoundSettingFromUI()" style="flex:1; padding:10px 0; border-radius:10px; border:0; background:#e6b35a; color:#111; font-weight:900;">ì ìš©</button>
    </div>
  </div>
</div>
  
<!-- ğŸ”” ë¡œê·¸ -->
<div id="toastLog" class="log-view-five">
  <div class="toastLog-controls">
    <button id="toastFoldBtn" type="button">ì ‘ê¸°</button>
    <button id="toastExpandBtn" type="button">í¼ì¹˜ê¸°</button>
  </div>

  <div id="toastList"></div>
</div>

  <div id="workbenchDock">
  <img src="images/ui/workbench_1000x250.png" alt="">
</div>

  <div id="workbenchDockUI">
    
  <div class="dock-slot">
  <button id="scrollShopDockBtn" class="dock-btn" data-nosfx="1">
    <img src="images/ui/icon_shop.png" alt="ìŠ¤í¬ë¡¤ìƒì ">
  </button>
  <span class="map-icon-label one-line">ìŠ¤í¬ë¡¤ìƒì </span>
</div>

  <div class="dock-slot">
  <button id="inventoryDockBtn" class="dock-btn" data-nosfx="1">
    <img src="images/ui/icon_inventory.png" alt="ì¸ë²¤í† ë¦¬">
  </button>
  <span class="map-icon-label one-line">ì¸ë²¤í† ë¦¬</span>
</div>

  <!-- â­ ì¤‘ì•™: ë‚´ ëŠ¥ë ¥ì¹˜ -->
  <div class="dock-slot">
    <button id="statDockBtn" class="dock-btn" data-nosfx="1">
    <img src="images/ui/icon_stat.png" alt="ëŠ¥ë ¥ì¹˜">
        </button>
    <span class="map-icon-label one-line">ëŠ¥ë ¥ì¹˜</span>
  </div>

  <div class="dock-slot">
  <button id="runeDockBtn" class="dock-btn locked" data-nosfx="1">
    <img src="images/ui/icon_rune.png" alt="ë£¬">
    <span class="dock-lock">ğŸ”’</span>
  </button>
  <span class="map-icon-label one-line">ë£¬</span>
</div>

  <div class="dock-slot">
  <button id="beastDockBtn" class="dock-btn locked" data-nosfx="1">
    <img src="images/ui/icon_beast.png" alt="ì‹ ìˆ˜">
    <span class="dock-lock">ğŸ”’</span>
  </button>
  <span class="map-icon-label one-line">ì‹ ìˆ˜</span>
</div>

</div>
      
<!-- ğŸ—º (ì‹ ê·œ) ì–‘í”¼ì§€ ì§€ë„ ì˜¤ë²„ë ˆì´ -->
<div id="parchmentMapOverlay" onclick="if(event.target===this) closeParchmentMap();">
  <div id="parchmentMapPanel" onclick="event.stopPropagation();">

    <button id="parchmentMapCloseBtn" onclick="closeParchmentMap()">ë‹«ê¸°</button>

      <!-- âœ… ì—¬ê¸° srcë§Œ ë„¤ê°€ ì €ì¥í•œ ì–‘í”¼ì§€ ì§€ë„ ê²½ë¡œë¡œ ë°”ê¿”ì£¼ë©´ ë¨ -->
    <div id="parchmentMapStage">
  <img id="parchmentMapImg" src="images/maps/parchment_world.png" />

  <!-- ğŸŒ³ ì¤‘ì•™ POI: ì´ê·¸ë“œë¼ì‹¤ -->
  <button id="poiYggdrasil" onclick="openSkyMap(event)">
  <img src="images/maps/poi_yggdrasil.png" alt="ì´ê·¸ë“œë¼ì‹¤">
  <span class="poi-label">ì´ê·¸ë“œë¼ì‹¤</span>
</button>

      <!-- ì›”ë“œë§µ POI: í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ -->
<button id="poiFulgurantForge" class="poi-btn" onclick="playUiClickCommon(); moveToFulgurantForgeFromWorldMap(event)">
  <img src="images/maps/poi_fulgurant_forge.png" alt="">
  <span class="poi-label">í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„</span>
</button>

        <!-- ğŸ„ POI: í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„ (ì´ê·¸ë“œë¼ì‹¤ ì„œìª½/í˜¸ìˆ˜ ì•„ë˜) -->
  <button id="poiMushroomVillage" onclick="playUiClickCommon(); moveToMushroomVillageFromWorldMap(event)">
    <img src="images/maps/poi_mushroom_village.png" alt="í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„">
    <span class="poi-label">í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„</span>
  </button>

      <!-- ğŸ€ POI: ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½ (ëŒ€ë¥™ ë‚¨ì„œìª½ ëë‹¨ ê°•í•˜ë¥˜) -->
<button id="poiSewer" onclick="playUiClickCommon(); moveToSewerFromWorldMap(event)">
  <img src="images/maps/poi_sewer.png" alt="ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½">
  <span class="poi-label">ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½</span>
</button>

      <!-- ğŸœï¸ POI: ë¬´ë²•ìë“¤ì˜ í™©ì•¼ (ì´ê·¸ë“œë¼ì‹¤ í•˜ë‹¨ í‰ì•¼) -->
<button id="poiOutlawWasteland" onclick="playUiClickCommon(); moveToOutlawWastelandFromWorldMap(event)">
  <img src="images/maps/poi_outlaw_wasteland.png" alt="ë¬´ë²•ìë“¤ì˜ í™©ì•¼">
  <span class="poi-label">ë¬´ë²•ìë“¤ì˜ í™©ì•¼</span>
</button>

      <!-- ğŸŒ¿ POI: ëŠªì—˜í”„ì˜ ìˆ² (ì´ê·¸ë“œë¼ì‹¤ ë°”ë¡œ ë°‘) -->
<button id="poiSwampElfForest" onclick="playUiClickCommon(); moveToSwampElfForestFromWorldMap(event)">
  <img src="images/maps/poi_swamp_elf_forest.png" alt="ëŠªì—˜í”„ì˜ ìˆ²">
  <span class="poi-label">ëŠªì—˜í”„ì˜ ìˆ²</span>
</button>

      <!-- â„ï¸ POI: ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´ (ì´ê·¸ë“œë¼ì‹¤ ë¶ë™ìª½) -->
<button id="poiFrostQueenCave" onclick="playUiClickCommon(); moveToFrostQueenCaveFromWorldMap(event)">
  <img src="images/maps/poi_frost_queen_cave.png" alt="ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´">
  <span class="poi-label">ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´</span>
</button>

      <!-- ğŸ‘» POI: ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„ (ì´ê·¸ë“œë¼ì‹¤ ë™ìª½ / ì„œë¦¬ì—¬ì™• ë™êµ´ë³´ë‹¤ ë” ë™ìª½) -->
<button id="poiDeathWorld" onclick="playUiClickCommon(); moveToDeathWorldFromWorldMap(event)">
  <img src="images/maps/poi_death_world.png" alt="ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„">
  <span class="poi-label">ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„</span>
</button>

      <!-- ğŸ”¥ POI: ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´ -->
<button id="poiBehemothPit" onclick="playUiClickCommon(); moveToBehemothPitFromWorldMap(event)">
  <img src="images/maps/poi_behemoth_pit.png" alt="ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´">
  <span class="poi-label">ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´</span>
</button>

</div>
  </div>
</div>

  <!-- â˜ï¸ 2ë²ˆ ì§€ë„(í•˜ëŠ˜) ì˜¤ë²„ë ˆì´: 1ë²ˆ ìœ„ì— ê²¹ì³ì„œ ëœ¸ -->
<div id="parchmentSkyOverlay" onclick="closeSkyMap()">
  <div id="parchmentSkyPanel" onclick="event.stopPropagation()">
    <button id="parchmentSkyCloseBtn" onclick="closeSkyMap()">ë‹«ê¸°</button>
    <img id="parchmentSkyImg" src="images/maps/parchment_sky.png">

    <!-- âœ… (ì¶”ê°€) í•˜ëŠ˜ë§µ POI: ëŒ€ì²œì‚¬ì˜ ìš”ëŒ -->
<button id="poiArchangelCradle" class="poi-btn" onclick="playUiClickCommon(); moveToArchangelCradleFromSkyMap(event)">
  <img src="images/maps/poi_archangel_cradle.png" alt="">
  <span class="poi-label">ëŒ€ì²œì‚¬ì˜ ìš”ëŒ</span>
</button>

    <!-- âœ… (ì¶”ê°€) í•˜ëŠ˜ë§µ POI: ì‹ ì˜ ì²˜ì†Œ -->
<button id="poiGodSanctum" class="poi-btn" onclick="playUiClickCommon(); moveToGodSanctumFromSkyMap(event)">
  <img src="images/maps/poi_divine_sanctum.png" alt="">
  <span class="poi-label">ì‹ ì˜ ì²˜ì†Œ</span>
</button>

<!-- âœ… (ì¶”ê°€) í•˜ëŠ˜ë§µ POI: ì°¨ì›ì˜ í‹ˆìƒˆ -->
<button id="poiDimensionalRift" class="poi-btn" onclick="playUiClickCommon(); moveToDimensionalRiftFromSkyMap(event)">
  <img src="images/maps/poi_dimensional_rift.png" alt="">
  <span class="poi-label">ì°¨ì›ì˜ í‹ˆìƒˆ</span>
</button>
    
  </div>
</div>
  
<!-- ğŸ’ ì¸ë²¤í† ë¦¬ ì˜¤ë²„ë ˆì´ -->
<div id="inventoryOverlay" class="uiOverlay"
     onclick="if(event.target===this) closeInventoryOverlay();"
     style="display:none;">
  <div id="inventoryPanel" class="invPanel" onclick="event.stopPropagation();">
    <div class="invHeader">
      <div class="invTitle">ì¸ë²¤í† ë¦¬</div>
      <button class="invCloseBtn" onclick="closeInventoryOverlay()">âœ•</button>
    </div>

    <div id="inventoryScrollArea">
      <div id="inventoryList"></div>
    </div>

    <div class="invFooter">
      <div id="inventoryCountInfo">0ì¢…</div>
    </div>
  </div>
</div>

<!-- ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì˜¤ë²„ë ˆì´ -->
<div id="userListOverlay"
     style="
       position:fixed;
       inset:0;
       background:rgba(0,0,0,0.6);
       display:none;
       z-index:1190;
     "
     onclick="if (event.target === this) closeUserListOverlay();">

  <div id="userListPanel"
       style="
         position:absolute;
         left:50%;
         top:50%;
         transform:translate(-50%, -50%);
         width:640px;
         max-width:calc(100% - 40px);
         max-height:80%;
         background:#111;
         border:1px solid #666;
         border-radius:10px;
         padding:12px 14px;
         color:#fff;
         box-shadow:0 0 20px rgba(0,0,0,0.9);
         display:flex;
         flex-direction:column;
       "
       onclick="event.stopPropagation();">

    <!-- ìƒë‹¨ í—¤ë” -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
      <div>
        <div style="font-size:16px; font-weight:bold;">ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡</div>
        <div id="userListCount"
             style="font-size:12px; color:#ccc; margin-top:2px;">
          ëª¨í—˜ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
      </div>
      <button style="font-size:12px; padding:4px 8px;"
              onclick="closeUserListOverlay()">
        ë‹«ê¸°
      </button>
    </div>

    <!-- ê²€ìƒ‰ ì˜ì—­ -->
    <div style="display:flex; gap:6px; align-items:center; margin-bottom:6px;">
      <input id="userListSearch"
             type="text"
             placeholder="ì•„ì´ë”” ê²€ìƒ‰"
             style="
               flex:1;
               padding:4px 8px;
               background:#000;
               border:1px solid #444;
               border-radius:4px;
               color:#fff;
               font-size:13px;
             "
             oninput="applyUserListSearch()"
      />
      <button style="font-size:12px; padding:4px 8px;"
              onclick="document.getElementById('userListSearch').value=''; applyUserListSearch();">
        ì´ˆê¸°í™”
      </button>
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ ë³¸ë¬¸ -->
    <div id="userListBody"
     style="
       height:360px;
       max-height:min(360px, 55vh);
       border:1px solid #333;
       border-radius:6px;
       padding:6px;
       overflow-y:auto;
       font-size:13px;
     ">
      <!-- JSë¡œ ì±„ì›Œì§ -->
      <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...
      </div>
    </div>

  </div>
</div>

<!-- ğŸ›ï¸ ëª¨í—˜ê°€ê¸¸ë“œ ì˜¤ë²„ë ˆì´ -->
<div id="adventureGuildOverlay" onclick="closeAdventureGuild()"
     style="position:fixed; inset:0; background:rgba(0,0,0,0.7);
            display:none; align-items:center; justify-content:center; z-index:2200;">
  
  <div id="adventureGuildPanel" onclick="event.stopPropagation()"
     style="position:relative; width:min(720px, 92vw); height:min(560px, 86vh);
            background:#1b1b1b; border:1px solid #555; border-radius:14px;
            box-shadow:0 0 18px rgba(0,0,0,0.9); padding:12px; overflow:hidden;">

    <!-- ìƒë‹¨ë°” -->
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
      <div style="text-align:left;">
        <div style="font-weight:900; font-size:18px;">ğŸ›ï¸ ëª¨í—˜ê°€ê¸¸ë“œ</div>
        <div id="adventureGuildHuntRemain"
             style="margin-top:2px; font-size:12px; color:#bbb;">
          ì˜¤ëŠ˜ ë‚¨ì€ ì‚¬ëƒ¥íšŸìˆ˜: -
        </div>
      </div>

      <div style="display:flex; gap:8px;">
        <button class="actionBtn" style="width:auto; padding:8px 12px; font-size:13px;"
                onclick="openAdventureGuildHelp()">?</button>
        <button class="actionBtn" style="width:auto; padding:8px 12px; font-size:13px;"
                onclick="closeAdventureGuild()">ë‹«ê¸°</button>
      </div>
    </div>

    <!-- ì¤‘ì•™: ì§„í–‰ì¤‘ ë³´ìŠ¤ì „ ë¦¬ìŠ¤íŠ¸ -->
      <div style="margin-top:10px; height: calc(100% - 130px); padding-right:6px;">
      <div style="font-weight:900; margin-bottom:8px;">í˜„ì¬ ì§„í–‰ì¤‘ì¸ ë³´ìŠ¤ì „</div>

      <!-- âœ… ì§€ê¸ˆì€ UIë§Œ: ë‚˜ì¤‘ì— Firebaseì—ì„œ ìµœì‹ ìˆœìœ¼ë¡œ ì±„ìš¸ ì˜ˆì • -->
      <div id="adventureGuildRaidList"
           style= "max-height:260px; overflow-y:auto; padding-right:4px;
        background:#141414; border:1px solid #444; border-radius:12px;
                  padding:10px; color:#bbb; font-size:13px;">
        ì§„í–‰ì¤‘ì¸ ë³´ìŠ¤ì „ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- ì¢Œí•˜ë‹¨: ì‹ ì²­ ë²„íŠ¼ -->
    <div style="position:absolute; left:12px; bottom:12px;">
      <button class="actionBtn"
              style="width:auto; padding:10px 14px; font-size:14px;"
              onclick="openBossApplyList()">
        ğŸ—¡ï¸ ë³´ìŠ¤ì „ ì‹ ì²­í•˜ê¸°
      </button>
    </div>

<!-- ìš°í•˜ë‹¨: NPC + ëŒ€ì‚¬ -->
<div style="position:absolute; right:12px; bottom:10px; display:flex; align-items:flex-end; gap:10px;">

  <!-- âœ… ë§í’ì„  + ì´ë¦„(ì´ë¦„ì€ ë§í’ì„  'ë°–' ìœ„) -->
  <div style="text-align:left; max-width:360px;">
    <div id="adventureGuildNpcName"
         style="font-size:12px; color:#fff; margin:0 0 6px 4px; font-weight:900;">
      ê¸¸ë“œë§ˆìŠ¤í„°-ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ
    </div>

    <div id="adventureGuildNpcLine"
         style="text-align:left; font-size:13px; color:#ddd;
                background:rgba(0,0,0,0.45); border:1px solid rgba(255,255,255,0.12);
                border-radius:12px; padding:10px; white-space:pre-line;">
      -
    </div>
  </div>

  <!-- âœ… NPC ì´ë¯¸ì§€ -->
  <img id="adventureGuildNpcImg"
       src="images/npc/leonhardt_idle.png"
       style="width:110px; height:auto; image-rendering:auto;"
       alt="ê¸¸ë“œë§ˆìŠ¤í„° ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ">

</div>

  </div>
</div>

<!-- ğŸ² ë³´ìŠ¤ì „ ì˜¤ë²„ë ˆì´ -->
<div id="bossBattleOverlay"
     style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:3000; background:rgba(0,0,0,0.72);">

  <div style="width:min(980px, 96vw); height:min(680px, 92vh); background:#111; border:1px solid #555; border-radius:14px; overflow:hidden; position:relative;">

<!-- âœ… í† ë²Œ ê²°ê³¼ ë°°ë„ˆ(ì„±ê³µ/ì‹¤íŒ¨) -->
<div id="bossBattleResultBanner"
     style="position:absolute; left:0; right:0; top:52%; transform:translateY(-50%);
            z-index:50; display:none; pointer-events:none; text-align:center;">
  <div id="bossBattleResultText"
       style="display:inline-block; padding:14px 18px; border-radius:14px;
              font-weight:900; font-size:28px; letter-spacing:2px;
              background:rgba(0,0,0,0.65); border:1px solid rgba(255,255,255,0.18);
              text-shadow:0 2px 6px #000;">
    -
  </div>
</div>

<!-- âœ… ë³´ìƒìˆ˜ë ¹ ë²„íŠ¼(ìš°í•˜ë‹¨) -->
<button id="bossBattleRewardBtn"
        onclick="openBossRewardOverlay()"
        style="position:absolute; right:14px; bottom:14px; z-index:60;
               display:none; padding:10px 14px; border-radius:12px; font-weight:900;">
  ğŸ ë³´ìƒìˆ˜ë ¹
</button>
    
    <!-- ìƒë‹¨ í—¤ë” -->
<div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #333;">
  <div style="text-align:left;">
    <div style="display:flex; align-items:baseline; gap:8px; flex-wrap:wrap;">
  <div style="font-weight:900; font-size:16px; color:#ddd;">âš”ï¸ ë³´ìŠ¤ì „</div>
  <div id="bossBattleHeaderHuntRemain" style="font-size:12px; color:#9fd3ff; font-weight:900;">
    (ì‚¬ëƒ¥íšŸìˆ˜ -/20)
  </div>
</div>

    <div id="bossBattleMapName" style="margin-top:2px; font-weight:900; font-size:14px; color:#ddd; text-align:left;">-</div>
  </div>

    <div style="display:flex; gap:8px;">
    <button onclick="openBossBattleRewards()" style="padding:6px 10px; border-radius:10px;">ë³´ìƒ</button>
    <button onclick="openBossBattleStat()" style="padding:6px 10px; border-radius:10px;">ë³´ìŠ¤ì •ë³´</button>
    <button onclick="closeBossBattle()" style="padding:6px 10px; border-radius:10px;">ë‹«ê¸°</button>
  </div>
</div>

    <!-- âœ… 2ì»¬ëŸ¼(ì¢Œ60 / ìš°40) -->
    <div style="display:flex; height:calc(100% - 52px);">

      <!-- =======================
           ì¢Œì¸¡(60%) : ë³´ìŠ¤ì „ í™”ë©´
           ======================= -->
      <div style="width:60%; border-right:1px solid #2a2a2a; display:flex; flex-direction:column;">

        <!-- ì „íˆ¬ í•„ë“œ(ì¢Œì¸¡ ë‚´ë¶€ì—ì„œë§Œ) -->
        <div style="flex:1; position:relative; overflow:hidden;">
          <!-- âœ… ë¨¸ë¦¬ ìœ„ UI (ë§µì´ë¦„/ë³´ìŠ¤ì´ë¦„/ì‚¬ëƒ¥íšŸìˆ˜/ì‹œê°„/HPë°”) -->
<div id="bossBattleTopUi"
     style="position:absolute; left:12px; right:12px; top:10px; z-index:10; pointer-events:none;">

  <!-- âœ… ìš°ìƒë‹¨: ë‚¨ì€ì‹œê°„ + ì‚¬ëƒ¥íšŸìˆ˜(=íƒ€ê²©íšŸìˆ˜) -->
  <div style="display:flex; justify-content:flex-end; align-items:center; gap:10px;">
    <div id="bossBattleRemain"
         style="min-width:96px; text-align:right; font-size:12px; color:#ffd54f; font-weight:900;">
      --:--:--
    </div>
  </div>

  <!-- âœ… ë³´ìŠ¤ ì´ë¦„: HPë°” ìƒë‹¨ ì¤‘ì•™ -->
  <div id="bossBattleBossName"
     style="margin-top:0px; margin-bottom:2px; text-align:center; font-size:14px; color:#fff; font-weight:900; text-shadow:0 2px 3px #000;">
    -
  </div>

  <!-- âœ… HP ë°” (ë¹„ìœ¨: ë†’ì´1 / ë„ˆë¹„7) : ì¤‘ì•™ ì •ë ¬ -->
 <div style="margin:-6px auto 0; width:min(560px, 100%); position:relative; height:64px;">

    <!-- ì±„ì›€(ë’¤) -->
    <div id="bossHpFillWrap"
         style="position:absolute; left:0; top:0; bottom:0; width:100%; overflow:hidden; z-index:1;
      padding-left: 45px;box-sizing: border-box;">
      <img id="bossHpFillImg" src="images/ui/boss_hp_fill.png"
           style="width:100%; height:100%; object-fit:fill; pointer-events:none;">
    </div>
   <!-- âœ… (ì¶”ê°€) ë§ˆë‚˜ì‹¤ë“œ ì±„ì›€(HP ìœ„ì— ë®ëŠ” ë ˆì´ì–´) -->
<div id="bossShieldFillWrap"
     style="position:absolute; left:0; top:0; bottom:0; width:0%; overflow:hidden; z-index:3.2; pointer-events:none;padding-left: 45px;
box-sizing: border-box;">
  <img id="bossShieldFillImg" src="images/ui/boss_shield_fill.png"
       style="width:100%; height:100%; object-fit:fill; pointer-events:none; opacity:0.95;">
</div>

    <!-- í…Œë‘ë¦¬(ì•) -->
    <img src="images/ui/boss_hp_frame.png"
         style="position:absolute; inset:0; width:100%; height:100%; object-fit:fill; pointer-events:none; z-index:2;">

    <div id="bossHpText"
     style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            font-size:12px; font-weight:900; line-height:1; transform:translateY(0px); text-shadow:0 1px 2px #000; z-index:3;">
      -
    </div>
   
   <div id="bossShieldText"
     style="position:absolute; inset:0; display:none; align-items:center; justify-content:center;
            font-size:12px; font-weight:900; line-height:1; transform:translateY(0px);
            text-shadow:0 1px 2px #000; z-index:3; color:#bfe7ff;">
  -
</div>

  </div>
</div>

          <!-- ë§µ ë°°ê²½ -->
          <img id="bossBattleBg"
               src="images/bossmaps/swamp_elf_forest.png"
               style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:0.95;">

          <!-- ë³´ìŠ¤ ì´ë¯¸ì§€(í„°ì¹˜ ëŒ€ìƒ) -->
<div id="bossBattleBossWrap">
  <!-- âœ… (ì¶”ê°€) ë°”ë‹¥ ê·¸ë¦¼ì -->
  <div id="bossBattleBossShadow"></div>

  <img id="bossBattleBossImg"
       src="images/bosses/silvana_idle.png"
       style="position:absolute; left:50%; top:52%; transform:translate(-50%,-50%); width:min(420px, 70vw); height:auto; cursor:pointer; user-select:none;
         -webkit-tap-highlight-color: rgba(0,0,0,0);
         -webkit-user-select:none;
         -webkit-touch-callout:none;"
       onclick="attackBossByClick(event)">
</div>
          
          <!-- âœ… (ì‹ ê·œ) ë³´ìŠ¤ íƒ€ê²©/ìˆ«ì FX ë ˆì´ì–´ (ë³´ìŠ¤ í™”ë©´ ë‚´ë¶€ ì „ìš©) -->
    <div id="bossFxLayer"
     style="position:absolute; inset:0; pointer-events:none; z-index:20;"></div>

          <div id="bossBattleFadeOverlay"
     style="
       position:fixed;
       left:0; top:0;
       width:100vw; height:100vh;
       background:#000;
       opacity:0;
       pointer-events:none;
       z-index:999999;
       transition: opacity 220ms ease;
     ">
</div>

          <!-- âœ… í•˜ë‹¨ ì•ˆë‚´/ë³´ìŠ¤ ëŒ€ì‚¬(ë³´ìŠ¤ ë°œë°‘) -->
<div id="bossBattleBottomUi"
     style="position:absolute; left:12px; right:12px; bottom:60px; padding-bottom:6px; z-index:10; text-align:center; pointer-events:none;">

  <!-- âœ… ë³´ìŠ¤ ëŒ€ì‚¬(ì•ˆë‚´ë¬¸ ìœ„, ì¡°ê¸ˆ ë” í¼) -->
  <div id="bossBattleBossLineMain"
       style="font-size:14px; color:#eee; font-weight:400; text-shadow:0 2px 8px rgba(0,0,0,0.95);">
  </div>
  <div id="bossBattleBossLineSub"
       style="margin-top:4px; font-size:11px; color:#a9a9a9; font-weight:400; text-shadow:0 2px 8px rgba(0,0,0,0.95);">
  </div>

  <!-- âœ… ì•ˆë‚´ë¬¸(ë³´ìŠ¤ ëŒ€ì‚¬ ì•„ë˜) -->
  <div style="margin-top:8px; font-size:11px; color:#aaa;">
    â€» ë³´ìŠ¤ë¥¼ í„°ì¹˜í•˜ë©´ ì‚¬ëƒ¥íšŸìˆ˜ë¥¼ ì†Œëª¨í•˜ì—¬ ê³µê²©í•©ë‹ˆë‹¤.
  </div>

</div>
        </div>
      </div>
      
      <!-- =======================
           ìš°ì¸¡(40%) : íŒŒí‹°/ë¡œê·¸
           ======================= -->
     <div style="width:40%; display:flex; flex-direction:column; min-height:0;">

        <!-- íŒŒí‹° í˜„í™© -->
        <div style="padding:10px 12px; border-bottom:1px solid #2a2a2a;">
          <div style="font-weight:900; margin-bottom:8px;">í† ë²ŒëŒ€ ì§„í–‰ìƒí™©</div>

          <div id="bossBattlePartyList"
     style="background:#141414; border:1px solid #333; border-radius:12px; padding:10px; font-size:12px; color:#ddd; max-height:140px; overflow:auto; text-align:left;">
            -
          </div>
        </div>

        <!-- ë³´ìŠ¤ì „ ì „ìš© ë¡œê·¸(ìë¦¬ë§Œ ë¨¼ì €) -->
        <div style="padding:10px 12px; flex:1; display:flex; flex-direction:column; min-height:0;">
          <div style="font-weight:900; margin-bottom:8px;">ì „íˆ¬ ì§„í–‰ ë¡œê·¸</div>

         <div id="bossBattleLogList"
     style="flex:1; min-height:0; background:#141414; border:1px solid #333; border-radius:12px; padding:10px; font-size:12px; color:#bbb; overflow-y:auto; -webkit-overflow-scrolling:touch; line-height:1.4; text-align:left;">
            Â· ì „ìš© ë¡œê·¸ëŠ” ë‹¤ìŒ ë‹¨ê³„ì—ì„œ Firebaseë¡œ ë¶„ë¦¬ ì—°ê²°í•©ë‹ˆë‹¤.
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

  <!-- ğŸ ë³´ìŠ¤ ë³´ìƒ ì§‘ê³„ ì˜¤ë²„ë ˆì´ -->
<div id="bossRewardOverlay"
     style="display:none; position:fixed; inset:0; z-index:99998; background:rgba(0,0,0,0.7);">
  <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
              width:min(760px, 92vw); height:min(560px, 86vh);
              background:rgba(20,20,20,0.96); border:1px solid rgba(255,255,255,0.18);
              border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.6); padding:14px;">

    <!-- ìƒë‹¨ -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
      <div style="font-weight:900; font-size:16px;">
        ğŸ§¾ í† ë²Œ ê²°ê³¼ ì§‘ê³„
      </div>
      <button onclick="closeBossRewardOverlay()"
              style="padding:6px 10px; border-radius:10px; font-weight:900;">
        ë‹«ê¸°
      </button>
    </div>

    <div id="bossRewardSummary"
         style="font-size:12px; color:#bbb; margin-bottom:10px; line-height:1.5;">
      -
    </div>

    <!-- ë¦¬ìŠ¤íŠ¸ -->
    <div id="bossRewardList"
         style="height:300px; overflow:auto; border:1px solid rgba(255,255,255,0.12);
                border-radius:12px; padding:10px; background:rgba(0,0,0,0.25);">
    </div>

    <!-- í•˜ë‹¨ ë ˆì˜¨í•˜ë¥´íŠ¸ + ë²„íŠ¼ -->
    <div style="display:flex; gap:10px; align-items:flex-end; margin-top:12px;">
      <img id="bossRewardLeonImg"
           src="images/npc/leonhardt_focus.png"
           style="width:120px; height:auto; border-radius:12px; border:1px solid rgba(255,255,255,0.12);" />
      <div style="flex:1;">
        <div id="bossRewardLeonLine"
             style="min-height:64px; font-size:13px; line-height:1.5; color:#eee;
                    background:rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.12);
                    border-radius:12px; padding:10px;">
          -
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
          <button id="bossRewardClaimBtn"
                  onclick="claimBossReward()"
                  style="display:none; padding:10px 12px; border-radius:12px; font-weight:900;">
            ğŸ ìˆ˜ë ¹í•œë‹¤
          </button>

          <button id="bossRewardGiveUpBtn"
                  onclick="giveUpBossRun()"
                  style="display:none; padding:10px 12px; border-radius:12px; font-weight:900;">
            ğŸšª í¬ê¸°í•˜ê¸°
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
  
<!-- âš”ï¸ ê²°íˆ¬ì¥ ì¤‘ì•™ íŒì—… ì˜¤ë²„ë ˆì´ -->
<div id="duelArenaOverlay"
     style="
       position:fixed;
       inset:0;
       background:rgba(0,0,0,0.6);
       display:none;
       z-index:1200;
     "
     onclick="if (event.target === this) closeDuelArena();">
  <!-- ì‹¤ì œ ê²°íˆ¬ì¥ íŒ¨ë„ -->
  <div id="duelArenaPanel"
       style="
         position:absolute;
         left:50%;
         top:50%;
         transform:translate(-50%, -50%);
         width:520px;
         max-width:calc(100% - 40px);
         background:#111;
         border:1px solid #666;
         border-radius:10px;
         padding:12px 14px;
         color:#fff;
         box-shadow:0 0 20px rgba(0,0,0,0.9);
         font-size:14px;
       "
       onclick="event.stopPropagation();">
    
    <!-- ìƒë‹¨ í—¤ë” -->
<div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
  <div>
    <div style="font-size:16px; font-weight:bold;">âš”ï¸ ê²°íˆ¬ì¥</div>
    <div id="duelRemainText"
         style="font-size:12px; color:#ccc; margin-top:2px;">
      ì˜¤ëŠ˜ ë‚¨ì€ ê²°íˆ¬: 10/10
    </div>
  </div>
  <div style="display:flex; gap:4px;">
    <button style="font-size:11px; padding:2px 6px;"
            onclick="openDuelHistoryPopup()">
      ì§€ë‚œ ë­í‚¹
    </button>
    <button style="font-size:11px; padding:2px 6px;"
            onclick="openDuelHelpPopup()">
      ?
    </button>
    <button style="font-size:11px; padding:2px 6px;"
            onclick="closeDuelArena()">
      ë‚˜ê°€ê¸°
    </button>
  </div>
</div>

    <!-- ë­í‚¹ ë°•ìŠ¤ -->
    <div style="border:1px solid #444; border-radius:6px; padding:8px; margin-bottom:8px;">
      <div style="font-weight:bold; text-align:center; margin-bottom:4px;">
        ğŸ† ê²°íˆ¬ì¥ ë­í‚¹
      </div>
      <div id="duelArenaRankList"
           style="max-height:260px; overflow-y:auto; font-size:13px;">
        <!-- ë‚˜ì¤‘ì— ê²°íˆ¬ í¬ì¸íŠ¸ ë­í‚¹ ë Œë”ë§ ì˜ˆì • -->
      </div>
      <div id="duelArenaMyRank"
           style="margin-top:6px; font-size:12px; color:#aaa; text-align:right;">
        <!-- ë‚´ ë­í‚¹ ì •ë³´ -->
      </div>
    </div>

    <!-- í•˜ë‹¨: ì¢Œì¸¡ ë²„íŠ¼ë“¤ / ìš°ì¸¡ ì¹´ë¥´ë‹ˆì•„ -->
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px;">
      <!-- ì¢Œì¸¡: ê²°íˆ¬ ë²„íŠ¼ë“¤ -->
      <div>
<button onclick="openDuelTargetPanel()"
        data-duel-target
        style="display:block; margin-bottom:6px; padding:6px 10px; font-size:14px; width:180px;">
  ğŸ¯ ê²°íˆ¬í•˜ê¸° (ì§€ì •ë§¤ì¹­)
</button>

        <button onclick="handleRandomMatchFromArena()"
                style="display:block; padding:6px 10px; font-size:14px; width:180px;">
          ğŸ² ëœë¤ë§¤ì¹­
        </button>
      </div>

      <!-- ìš°ì¸¡: ì¹´ë¥´ë‹ˆì•„ -->
      <div style="display:flex; align-items:flex-end; gap:8px;">
        <img src="images/npc/duel_carnia.png"
             alt="ê²°íˆ¬ ì‹¬íŒê´€ ì¹´ë¥´ë‹ˆì•„"
             style="width:78px; height:auto; border-radius:6px;">
        <div style="font-size:12px; color:#ddd; max-width:220px; line-height:1.4;">
          <div style="font-weight:bold; margin-bottom:2px;">
            ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸
          </div>
          <div>
            ëœë¤ ë§¤ì¹­ì€ ê²ìŸì´ì—ê²ŒëŠ” ë…,  
            ì§„ì§œ ë„ì „ìì—ê²ŒëŠ” <span style="color:#ffcc66;">ì¶”ê°€ ë³´ìƒ</span>ì´ ë˜ì§€.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
  
  <!-- âš”ï¸ ê²°íˆ¬ íŒ¨ë„ -->
<div id="duelPanel" style="
  position:absolute;
  width:260px;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  border-radius:8px;
  padding:10px;
  z-index:1300;
  display:none;
">

  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
    <div style="font-weight:bold; font-size:15px;">âš”ï¸ ê²°íˆ¬</div>
    <!-- â¬… ì°½ ì¢Œìƒë‹¨(ì— ê°€ê¹Œìš´ ìª½)ì— Xë²„íŠ¼ -->
    <button onclick="toggleDuelPanel()" style="font-size:11px; padding:2px 6px;">X</button>
  </div>

  <div style="margin-bottom:6px;">
    <input id="duelSearchInput"
           type="text"
           placeholder="ë‹‰ë„¤ì„ ê²€ìƒ‰"
           oninput="onDuelSearchChange(this.value)"
           style="width:100%; box-sizing:border-box; padding:4px 6px; font-size:13px;">
  </div>

  <div id="duelHelpText" style="font-size:12px; color:#aaa; margin-bottom:4px;">
    ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ìƒìœ„ ë­í‚¹ ìˆœìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
  </div>

  <div id="duelList"></div>

</div>
  
  <!-- ğŸ“œ ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì  ì˜¤ë²„ë ˆì´ -->
<div id="scrollShopOverlay"
     style="
       position:fixed;
       inset:0;
       background:rgba(0,0,0,0.6);
       display:none;
       z-index:1200;
     "
     onclick="if (event.target === this) closeScrollShop();">

  <!-- ì‹¤ì œ ìƒì  íŒ¨ë„ -->
  <div id="scrollShopPanel"
       style="
         position:absolute;
         left:50%;
         top:50%;
         transform:translate(-50%, -50%);
         width:520px;
         max-width:calc(100% - 40px);
         background:#111;
         border:1px solid #666;
         border-radius:10px;
         padding:12px 14px;
         color:#fff;
         box-shadow:0 0 20px rgba(0,0,0,0.9);
         font-size:14px;
       "
       onclick="event.stopPropagation();">

    <!-- ìƒë‹¨ í—¤ë” -->
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
      <div style="font-weight:bold; font-size:16px;">
        ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì 
      </div>
      <button onclick="closeScrollShop()"
              style="background:#333; border:1px solid #555; color:#fff;
                     font-size:12px; padding:4px 8px; border-radius:4px; cursor:pointer;">
        ë‹«ê¸° âœ•
      </button>
    </div>

    <!-- ìƒë‹¨ ì¬í™” í‘œì‹œ -->
    <div style="display:flex; gap:12px; margin-bottom:8px; font-size:12px;">
      <div style="display:flex; align-items:center; gap:4px;">
        <img src="images/items/star_shard.png" style="width:18px; height:18px;" alt="">
        <span>ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê° :</span>
        <span id="scrollShopStarShard">0</span>
      </div>
      <div style="display:flex; align-items:center; gap:4px;">
        <img src="images/items/medal_honor.png" style="width:18px; height:18px;" alt="">
        <span>ëª…ì˜ˆì˜ í›ˆì¥ :</span>
        <span id="scrollShopHonorMedal">0</span>
      </div>
    </div>

    <!-- ğŸ†• ìŠ¤í¬ë¡¤ìƒì  íƒ­ -->
<div id="scrollShopTabs">
  <button class="scrollShopTab active" id="tabShopBuy" onclick="setScrollShopTab('buy')">êµ¬ë§¤</button>
  <button class="scrollShopTab" id="tabShopDis" onclick="setScrollShopTab('dis')">ì£¼ë¬¸ì„œë¶„í•´</button>
  <button class="scrollShopTab" id="tabShopSyn" onclick="setScrollShopTab('syn')">ì£¼ë¬¸ì„œí•©ì„±</button>
</div>
    
    <!-- ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
    <div id="scrollShopItemList"
     style="border:1px solid #444; border-radius:6px; padding:4px;
            height:220px; overflow-y:auto; margin-bottom:8px;">
  <!-- JSë¡œ í•œ ì¤„ì”© ì±„ìš¸ ì˜ˆì • -->
</div>

    <!-- í•˜ë‹¨: ì¢Œì¸¡ ì—¬ìœ  / ìš°ì¸¡ ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì¸ (ê²°íˆ¬ì¥ ë ˆì´ì•„ì›ƒ ëŠë‚Œ) -->
    <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px; margin-top:4px;">
      <!-- ì¢Œì¸¡ì€ ì—¬ìœ  ì˜ì—­ (ë‚˜ì¤‘ì— ì•ˆë‚´ë¬¸ ë„£ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì—) -->
      <div style="flex:1;"></div>

      <!-- ìš°ì¸¡: ë§ˆë²•ìŠ¤í¬ë¡¤ ìƒì¸ -->
      <div style="display:flex; align-items:flex-end; gap:12px;">

  <!-- ğŸ—¨ ëŒ€ì‚¬(ì™¼ìª½) -->
  <div style="font-size:12px; line-height:1.5; max-width:300px; text-align:right;">
    <div style="font-weight:bold; margin-bottom:4px;">
      ì„¸ë ˆë‚˜ ì—ë¸ë¦°
    </div>
    <div id="scrollShopNpcText"></div>
  </div>

  <!-- ğŸ§™â€â™‚ï¸ NPC (ì˜¤ë¥¸ìª½ / 2ë°° í™•ëŒ€) -->
  <img id="scrollShopNpcImg"
       src="images/npc/npc_scrollshop_idle.png"
       style="width:156px; height:auto; border-radius:10px;">
</div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <!-- í”„ë¡œí•„ ì¹´ë“œ ìº¡ì³ìš© html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  authDomain:"sword-game-1d1a1.firebaseapp.com",
  databaseURL:"https://sword-game-1d1a1-default-rtdb.firebaseio.com",
  projectId:"sword-game-1d1a1"
});
const db = firebase.database();

  // ğŸ”Š ê³µí†µ ë²„íŠ¼ í´ë¦­ SFX
let uiClickCommonAudio = null;

function playUiClickCommon(){
  try{
    if (!uiClickCommonAudio) {
      uiClickCommonAudio = new Audio("sounds/ui_click_common.mp3");
      uiClickCommonAudio.volume = 0.7; // í•„ìš”í•˜ë©´ ì¡°ì ˆ
    }
    uiClickCommonAudio.currentTime = 0;
    uiClickCommonAudio.play();
  }catch(e){}
}
  
// ============================
// ğŸ”Š ì•„ì´ì½˜ íƒ­ ì‚¬ìš´ë“œ(ì´ˆì €ì§€ì—°: WebAudio)
// ============================
const ICON_TAP_SOUND_SRC = "sounds/ui_tap_icon.mp3";

let _tapCtx = null;
let _tapBuf = null;
let _tapGain = null;

async function _initTapAudioOnce() {
  if (_tapBuf) return;

  _tapCtx = _tapCtx || new (window.AudioContext || window.webkitAudioContext)();

  // iOS/í¬ë¡¬ ì •ì±…: ì²« ìœ ì € ì œìŠ¤ì²˜ì—ì„œ resume í•„ìš”í•  ìˆ˜ ìˆìŒ
  if (_tapCtx.state === "suspended") {
    try { await _tapCtx.resume(); } catch (e) {}
  }

  const res = await fetch(ICON_TAP_SOUND_SRC);
  const arr = await res.arrayBuffer();
  _tapBuf = await _tapCtx.decodeAudioData(arr);

  _tapGain = _tapCtx.createGain();
  _tapGain.gain.value = 0.85 * getSfxScale(); // âœ… Effect(0~5) ë°˜ì˜
  _tapGain.connect(_tapCtx.destination);
}

function playIconTapSound() {
  if (!_tapBuf || !_tapCtx) return;

  try {
    const src = _tapCtx.createBufferSource();
    src.buffer = _tapBuf;
    src.connect(_tapGain);
    src.start(0);
  } catch (e) {}
}

function bindIconTapSound(id) {
  const el = document.getElementById(id);
  if (!el) return;

  // âœ… í´ë¦­ë³´ë‹¤ ë¹ ë¥¸ "í„°ì¹˜ ìˆœê°„"ì— ë°˜ì‘
  el.addEventListener(
  "pointerdown",
  async () => {
    if (!_tapBuf) await _initTapAudioOnce(); // ì²« í„°ì¹˜ì—ì„œ ë¡œë“œ/ë””ì½”ë“œ
    playIconTapSound();
  },
  { passive: true }
);
}

// âœ… ì§€ì •í•œ ë²„íŠ¼ë§Œ ë°”ì¸ë”©
document.addEventListener("DOMContentLoaded", () => {
  [
    "hamburgerBtn",
    "attendanceIconBtn",
    "achievementIconBtn",
    "mapBtn",
    "duelIconBtn",
    "guildIconBtn",
    "userListIconBtn",
    "bossBattleIconBtn",

  ].forEach(bindIconTapSound);
});

  function applyIconTapVolumeNow(){
  try{
    if (window._tapGain) _tapGain.gain.value = 0.85 * getSfxScale();
  }catch(e){}
}

const logRef = db.ref("logs");
const globalEventsRef = db.ref("globalEvents");

  // ğŸŒ™ +30 ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ í‚¤
const GLOBAL30_KEY = "latest30";

// ğŸŒ™ ê²½ì™¸ ë¬¸êµ¬(1ì¸ 1íšŒ ëœë¤)
const AWE_MESSAGES = [
  "ê·¸ ê²€ ëì—ì„œâ€¦ ë³„ì´ íƒœì–´ë‚¬ë‹¤. â˜…",
  "30ê°•ì€ ìš°ì—°ì´ ì•„ë‹ˆë¼, ì§‘ë…ì´ ì¦ëª…ëœ ìë¦¬ì˜€ë‹¤.",
  "í¼ê·¸ë€íŠ¸ì˜ ë¶ˆê½ƒì´ ì˜¤ëŠ˜, ì „ì„¤ì„ í•˜ë‚˜ ë” ë§Œë“¤ì—ˆë‹¤.",
  "ë‚˜ëŠ” ë³´ì•˜ë‹¤. ê°•í™”ì˜ ëì—ì„œ í”ë“¤ë¦¬ì§€ ì•Šì€ ì†ì„.",
  "ê·¸ ì´ë¦„ì„ ê¸°ì–µí•˜ë¼. ìš°ë¦¬ì˜ í•˜ëŠ˜ì— ìƒˆê²¨ì§„ ì²« ë¬¸ì¥ì´ë‹¤.",
  "ê²€ì´ ì•„ë‹ˆë¼, ì˜ì§€ê°€ ë¹›ë‚¬ë‹¤.",
  "ì˜¤ëŠ˜ì˜ ê¸°ë¡ì€ ë‚´ì¼ì˜ ê¸°ì¤€ì´ ëœë‹¤. ê²½ì™¸ë¥¼.",
  "ë³„ì€ ì•„ë¬´ì—ê²Œë‚˜ ë¶™ì§€ ì•ŠëŠ”ë‹¤. ì˜¤ì§ ë‹¬ì„±í•œ ìì—ê²Œë§Œ.",
  "ì´ê²ƒì´ â€˜ëâ€™ì´ë¼ë©´â€¦ ì–¼ë§ˆë‚˜ ì•„ë¦„ë‹¤ìš´ ëì¸ê°€.",
  "ê²½ì™¸í•œë‹¤. ê·¸ë¦¬ê³  ë”°ë¼ê°€ê² ë‹¤. ì–¸ì  ê°€ ë‚˜ë„ ê·¸ ìë¦¬ì—."
];

// âœ… +30 ì¶•í•˜ ë¡œê·¸(3ì¤„ ë„íŠ¸ì•„íŠ¸) ë§Œë“¤ê¸°
function build30CongratsLogLines(nick, weaponName) {
  return [
    "âœ¦âœ§âœ¦âœ§âœ¦  ğŸŒŒ  [ +30  ë‹¬ ì„± ]  ğŸŒŒ  âœ¦âœ§âœ¦âœ§âœ¦",
    `â˜…  ${nick} â”ƒ ${weaponName} +30 â”ƒ í¼ê·¸ë€íŠ¸ì˜ ê¸°ë¡ì´ ë¹›ë‚©ë‹ˆë‹¤  âœ¨`
  ];
}

// âœ… ê¸€ë¡œë²Œ +30 ì´ë²¤íŠ¸ ë°œí–‰(ë§ˆì§€ë§‰ 1ê°œë§Œ ìœ ì§€)
function publishGlobal30Event(winnerId, winnerNick, weaponName, weaponType) {
  const eventId = Date.now();
  const payload = {
    id: eventId,
    winnerId: winnerId || "",
    winnerNick: winnerNick || "",
    weaponName: weaponName || "",
    weaponType: weaponType || "",
    time: eventId
  };
  globalEventsRef.child(GLOBAL30_KEY).set(payload);
  return eventId;
}

// âœ… ì„œë²„ ìµœì´ˆ 30ê°•(ì›”ë“œì±”í”¼ì–¸) 1ëª…ë§Œ ì§€ê¸‰ìš© í‚¤
const GLOBAL_FIRST30_KEY = "first30";

// âœ… ì„œë²„ ìµœì´ˆ 30ê°•ì´ë©´ worldchamp ì§€ê¸‰ (íŠ¸ëœì­ì…˜ìœ¼ë¡œ 1ëª…ë§Œ í™•ì •)
function tryGrantWorldChampionIfFirst(winnerId, winnerNick, weaponName, weaponType) {
  const now = Date.now();

  return globalEventsRef.child(GLOBAL_FIRST30_KEY).transaction((cur) => {
    // ì´ë¯¸ ëˆ„ê°€ ë¨¼ì € ê¸°ë¡í–ˆìœ¼ë©´ ì•„ë¬´ ê²ƒë„ ì•ˆ í•¨
    if (cur) return;

    // ìµœì´ˆ ê¸°ë¡ì í™•ì •
    return {
      id: now,
      winnerId: winnerId || "",
      winnerNick: winnerNick || "",
      weaponName: weaponName || "",
      weaponType: weaponType || "",
      time: now
    };
  }).then((res) => {
    if (res && res.committed) {
      // âœ… ìµœì´ˆ 1ëª…ë§Œ ì—¬ê¸°ë¡œ ë“¤ì–´ì˜´
      grantTitleOnceNoSave("worldchamp");
      save(); // ì‰¼í‘œ/ê´„í˜¸ ëˆ„ë½ ì£¼ì˜: save(); ë¡œ ë
      update();
    }
  }).catch((e) => {
    // ë„¤ ì½˜ì†”ì—ë§Œ ì°ê³  ê²Œì„ íë¦„ì€ ë§‰ì§€ ì•ŠìŒ
    console.log("tryGrantWorldChampionIfFirst error:", e);
  });
}
  
// âœ… +30 ì˜¤ë²„ë ˆì´ ì—´ê¸°
function openGlobal30Overlay(payload) {
  const overlay = document.getElementById("global30Overlay");
  if (!overlay) return;

  const titleEl = document.getElementById("global30Title");
  const descEl  = document.getElementById("global30Desc");

  const nick = payload?.winnerNick || "ëˆ„êµ°ê°€";
  const weaponName = payload?.weaponName || "ë¬´ê¸°";

  if (titleEl) titleEl.innerHTML = `ğŸŒŒ ${nick} ë‹˜ì´ 30ê°• ë‹¬ì„±ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤!`;
  if (descEl) descEl.textContent =
`í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ì— ìƒˆë¡œìš´ ìš°ì£¼ì˜ ì§ˆì„œê°€ ê¸°ë¡ë©ë‹ˆë‹¤.

ë‹¬ì„± ë¬´ê¸°: ${weaponName} +30`;

  overlay.style.display = "block";
}

// âœ… +30 ì˜¤ë²„ë ˆì´ ë‹«ê¸° + â€˜ë´¤ìŒâ€™ ì €ì¥
function closeGlobal30Overlay() {
  const overlay = document.getElementById("global30Overlay");
  if (overlay) overlay.style.display = "none";

  // í˜„ì¬ ë– ìˆëŠ” ì´ë²¤íŠ¸ë¥¼ â€œë´¤ìŒâ€ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ latest30ì„ ë‹¤ì‹œ ì½ì–´ì„œ ì €ì¥
  globalEventsRef.child(GLOBAL30_KEY).once("value").then(snap => {
    const v = snap.val() || {};
    const id = Number(v.id || 0);
    if (id > 0) {
      lastSeenGlobal30EventId = id;
      save(); // âš ï¸ save()ì— í•„ë“œ ì¶”ê°€ë„ ì•„ë˜ì—ì„œ ì•ˆë‚´í• ê±°ì•¼
    }
  });
}

// âœ… +30 ì´ë²¤íŠ¸ êµ¬ë…: ì•ˆ ë³¸ ìœ ì €ë§Œ ì˜¤ë²„ë ˆì´ (ë¡œê·¸ëŠ” ì ˆëŒ€ ì“°ì§€ ì•ŠìŒ)
function subscribeGlobal30Events() {
  // âœ… ì¤‘ë³µ ë¦¬ìŠ¤ë„ˆ ë°©ì§€: ê¸°ì¡´ êµ¬ë… í•´ì œ í›„ ì¬êµ¬ë…
  globalEventsRef.child(GLOBAL30_KEY).off();

  globalEventsRef.child(GLOBAL30_KEY).on("value", (snap) => {
    const v = snap.val();
    if (!v) return;

    const eventId = Number(v.id || 0);
    if (!eventId) return;

    // âœ… ì´ë¯¸ ë³¸ ì´ë²¤íŠ¸ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ì‹ ê·œ ê³„ì •/ì¬ë¡œê·¸ì¸ ë°˜ë³µ ë°©ì§€ í•µì‹¬)
    if (Number(lastSeenGlobal30EventId || 0) >= eventId) return;

    // âœ… ì˜¤ë²„ë ˆì´ë§Œ ë„ìš°ê¸° (DB logsì—ëŠ” ì“°ì§€ ì•ŠëŠ”ë‹¤!)
    openGlobal30Overlay(v);

    // âœ… "ë´¤ìŒ" ì²˜ë¦¬(ì¤‘ë³µ ì¶œë ¥ ë°©ì§€)
    lastSeenGlobal30EventId = eventId;
    save();
  });
}

// âœ… (í•„ìˆ˜) ì‹œìŠ¤í…œ í† ìŠ¤íŠ¸ í‘¸ì‹œ í•¨ìˆ˜: í•­ìƒ #toastListì— ìŒ“ê¸°
function pushSystemToast(text, extraClass) {
  const toastList = document.getElementById("toastList");
  if (!toastList) return;

  const div = document.createElement("div");
  div.className = `toast-item ${extraClass || ""}`;
  div.textContent = text;

  toastList.prepend(div);

  // ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìœ„ì—ì„œ ì˜ë¼ë‚´ê¸°
  while (toastList.children.length > 50) {
    toastList.removeChild(toastList.lastChild);
  }
}

// âœ… ê²½ì™¸í•˜ê¸° ë²„íŠ¼ í† ìŠ¤íŠ¸(1ì¸ 1íšŒ)
function pushAweToast(eventId, winnerNick) {
  const toastList = document.getElementById("toastList"); // âœ… ì—¬ê¸°ë¡œ ë³€ê²½
  if (!toastList) return;

  const row = document.createElement("div");
  row.className = "toast-item toast-awe";

  const left = document.createElement("span");
  left.textContent = `ğŸ™ ${winnerNick} ë‹˜ì˜ ì—…ì ì— ê²½ì™¸ë¥¼ ë°”ì¹©ë‹ˆë‹¤.`;

  const btn = document.createElement("button");
  btn.textContent = "ê²½ì™¸í•˜ê¸°";
  btn.style.marginLeft = "10px";
  btn.onclick = () => {
    // 1ì¸ 1íšŒ ì œí•œ
    if (Number(aweUsedGlobal30EventId || 0) === Number(eventId)) {
      alert("ì´ë¯¸ ê²½ì™¸ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤.");
      return;
    }
    aweUsedGlobal30EventId = Number(eventId);

    // ëœë¤ ë¬¸êµ¬
    const msg = AWE_MESSAGES[Math.floor(Math.random() * AWE_MESSAGES.length)];

    // ë¡œê·¸ì— í•œ ì¤„ ì¶”ê°€(ì‹œìŠ¤í…œ í† ìŠ¤íŠ¸)
    pushSystemToast(`â˜… ê²½ì™¸: ${msg}`, "toast-awe-msg");

    save(); // ìœ ì €ì— ì €ì¥
    btn.disabled = true;
  };

  row.appendChild(left);
  row.appendChild(btn);

  // âœ… ì»¨íŠ¸ë¡¤ë°”(#toastLog) ë§ê³ , ë¦¬ìŠ¤íŠ¸(#toastList)ì—ë§Œ ìŒ“ëŠ”ë‹¤
  toastList.prepend(row);

  // âœ… ìµœëŒ€ 50ê°œ ìœ ì§€ (ì›í•˜ë©´ ìˆ«ìë§Œ ì¡°ì ˆ)
  while (toastList.children.length > 50) {
    toastList.removeChild(toastList.lastChild);
  }
}

  
function getTutorialKeyForUser(id) {
  return `swordGameTutorialSeen_${id}`;
}

// ğŸ•’ NEW í‘œì‹œ ê¸°ì¤€ (24ì‹œê°„)
function isNoticeNew(createdAt) {
  if (!createdAt) return false;
  const DAY_24H = 24 * 60 * 60 * 1000;
  return (Date.now() - Number(createdAt)) < DAY_24H;
}
  
  // ğŸ”” ì—…ë°ì´íŠ¸ ê³µì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
function loadUpdateNotices() {
  const ref = db.ref("updateNotices");

  ref
    .orderByChild("createdAt")
    .limitToLast(20)        // ìµœê·¼ 20ê°œê¹Œì§€ë§Œ
    .once("value")
    .then((snap) => {
      updateNotices = [];
      snap.forEach((child) => {
        const v = child.val() || {};
        updateNotices.push({
          id: child.key,
          title: v.title || "",
          content: v.content || "",
          createdAt: v.createdAt || 0
        });
      });

      if (!updateNotices.length) {
        return;
      }

      // ìµœì‹  ê³µì§€ëŠ” ë°°ì—´ ë§ˆì§€ë§‰
      currentNoticeIndex = updateNotices.length - 1;
      const latest = updateNotices[currentNoticeIndex];

      const bar = document.getElementById("updateNoticeBar");
      const titleEl = document.getElementById("updateNoticeTitle");

      if (bar && titleEl) {
const isNew = isNoticeNew(latest.createdAt);

titleEl.innerHTML = `
  ${latest.title || "ì‹ ê·œ ì—…ë°ì´íŠ¸ í™•ì¸í•˜ê¸°"}
  ${isNew ? '<span class="badge-new">NEW</span>' : ''}
`;

bar.style.display = "block";
      }
    })
    .catch((err) => {
      console.error("[updateNotices] load error", err);
    });
}

  // â± 1ì‹œê°„ ìë™ ìƒˆë¡œê³ ì¹¨ (ms ë‹¨ìœ„)
const AUTO_REFRESH_MS = 60 * 60 * 1000; // 1ì‹œê°„
let autoRefreshTimer = null;

// ë¡œê·¸ì¸ í›„ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì‹œì‘
function startAutoRefreshTimer() {
  // í˜¹ì‹œ ê¸°ì¡´ íƒ€ì´ë¨¸ ìˆìœ¼ë©´ ì •ë¦¬
  if (autoRefreshTimer) {
    clearTimeout(autoRefreshTimer);
  }

  autoRefreshTimer = setTimeout(() => {
    // í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ ì €ì¥ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ë¨¼ì € ë„ì›Œë„ ë¨
    // alert("ì•ˆì •ì ì¸ ì—…ë°ì´íŠ¸ ì ìš©ì„ ìœ„í•´ ê²Œì„ì´ ìƒˆë¡œê³ ì¹¨ ë©ë‹ˆë‹¤.");
    location.reload(); // ìµœì‹  ë²„ì „ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨
  }, AUTO_REFRESH_MS);
}

// ë¡œê·¸ì•„ì›ƒ ì‹œ íƒ€ì´ë¨¸ ì •ë¦¬ (ì˜µì…˜ì´ì§€ë§Œ ê¹”ë”í•˜ê²Œ)
function stopAutoRefreshTimer() {
  if (autoRefreshTimer) {
    clearTimeout(autoRefreshTimer);
    autoRefreshTimer = null;
  }
}

  function openLatestNoticePopup() {
  if (!updateNotices.length) return;

  // í•­ìƒ ìµœì‹  ê³µì§€ë¶€í„° ì—´ê¸°
  currentNoticeIndex = updateNotices.length - 1;
  showNoticeAt(currentNoticeIndex);

  const overlay = document.getElementById("updateNoticeOverlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}

function closeUpdateNoticePopup() {
  const overlay = document.getElementById("updateNoticeOverlay");
  if (overlay) {
    overlay.style.display = "none";
  }
}

function showNoticeAt(idx) {
  if (!updateNotices.length) return;
  if (idx < 0 || idx >= updateNotices.length) return;

  const n = updateNotices[idx];

  const titleEl   = document.getElementById("updateNoticePopupTitle");
  const contentEl = document.getElementById("updateNoticePopupContent");
  const idxLabel  = document.getElementById("updateNoticeIndexLabel");

  if (!titleEl || !contentEl || !idxLabel) return;

const isNew = isNoticeNew(n.createdAt);

titleEl.innerHTML = `
  ${n.title || "(ì œëª© ì—†ìŒ)"}
  ${isNew ? '<span class="badge-new">NEW</span>' : ''}
`;

  let content = n.content || "";

  // 1) "...\n..." ì²˜ëŸ¼ ì €ì¥ëœ ê²½ìš° â†’ ì‹¤ì œ ê°œí–‰ìœ¼ë¡œ ë³€í™˜
  if (content.indexOf("\\n") >= 0) {
    content = content.replace(/\\n/g, "\n");
  }

  // 2) ì‹¤ì œ ì¤„ë°”ê¿ˆì´ ë“¤ì–´ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš© (pre-lineì´ ì²˜ë¦¬)
  contentEl.textContent = content;
  
  idxLabel.textContent  = `${idx + 1} / ${updateNotices.length}`;

  currentNoticeIndex = idx;
}

function showPrevNotice() {
  if (!updateNotices.length) return;
  const next = Math.max(0, currentNoticeIndex - 1);
  showNoticeAt(next);
}

function showNextNotice() {
  if (!updateNotices.length) return;
  const next = Math.min(updateNotices.length - 1, currentNoticeIndex + 1);
  showNoticeAt(next);
}

// ğŸ”° ê°•í™” ë‹¨ê³„ë³„ ê²€ ì´ë¦„ / ì„¤ëª… / ì´ë¯¸ì§€ ê²½ë¡œ
const WEAPON_INFO = {
  0: {
    name: "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´",
    desc: "ì•„ì§ ì•„ë¬´ê²ƒë„ ë˜ì§€ ëª»í–ˆì§€ë§Œ, ì„¸ìƒ ì–´ë””ì—ë„ ì—†ëŠ” ê°€ëŠ¥ì„±ì„ ì¡°ìš©íˆ í’ˆê³  ìˆë‹¤.",
    img: "images/weapons/sword_00.png"
  },
  1: {
    name: "ë¶€ëŸ¬ì§„ ê²€",
    desc: "ì˜ê´‘ì˜ ê¸°ì–µë§Œ ë‚¨ì€ ì±„, ë”ëŠ” ëˆ„êµ¬ë„ ì°¾ì§€ ì•ŠëŠ” ìŠ¬í”ˆ ì”í•´ë‹¤.",
    img: "images/weapons/sword_01.png"
  },
  2: {
    name: "ê¸ˆì´ ê°„ ê²€",
    desc: "ì¡°ê¸ˆë§Œ í˜ì„ ì£¼ì–´ë„ ì‚°ì‚°íˆ í©ì–´ì§ˆ ê²ƒì²˜ëŸ¼, ìœ„íƒœë¡­ê²Œ ìˆ¨ì„ ë¶™ë“¤ê³  ìˆë‹¤.",
    img: "images/weapons/sword_02.png"
  },
  3: {
    name: "ë…¹ìŠ¨ ê²€",
    desc: "ì„¸ì›”ì˜ ë°”ëŒì„ ê²¬ë””ì§€ ëª»í•´, í•œë•Œì˜ ê´‘ì±„ë¥¼ ì„œì„œíˆ ìƒì–´ë²„ë ¸ë‹¤.",
    img: "images/weapons/sword_03.png"
  },
  4: {
    name: "ë‚¡ì€ ê²€",
    desc: "ìˆ˜ë§ì€ ì‹¸ì›€ì˜ í”ì ë§Œì´ ë‚¨ì•„, ì¡°ìš©íˆ ì‰¼ì„ ê¸°ë‹¤ë¦¬ê³  ìˆë‹¤.",
    img: "images/weapons/sword_04.png"
  },
  5: {
    name: "í™ë¨¼ì§€ì— ë®ì¸ ê²€",
    desc: "ê¸´ ì  ì†ì—ì„œë„, ì–¸ì  ê°€ ë‹¤ì‹œ ë¶ˆë¦´ ì´ë¦„ì„ ê¿ˆê¾¸ê³  ìˆë‹¤.",
    img: "images/weapons/sword_05.png"
  },
  6: {
    name: "ì˜ ë²¼ë ¤ì§„ ê²€",
    desc: "ì¥ì¸ì˜ ìˆ¨ê²°ì„ ë¨¸ê¸ˆê³ , ì´ì œì•¼ ë¹„ë¡œì†Œ í•œ ìë£¨ì˜ ê²€ì´ ëœë‹¤.",
    img: "images/weapons/sword_06.png"
  },
  7: {
    name: "ë‹¨ë‹¨íˆ ì—°ë§ˆëœ ì „íˆ¬ê²€",
    desc: "ì „ì¥ì„ í–¥í•œ ë‘ë ¤ì›€ê³¼ ê°ì˜¤ê°€, ë‚  ìœ„ì— ê³ ìš”íˆ ë‚´ë ¤ì•‰ëŠ”ë‹¤.",
    img: "images/weapons/sword_07.png"
  },
  8: {
    name: "ê²°ì˜ì˜ ì¥ê²€",
    desc: "í•œ ë²ˆ ë½‘ì•„ ë“¤ì—ˆë‹¤ë©´, ê²°ì½” ë¬¼ëŸ¬ì„œì§€ ì•Šê² ë‹¤ëŠ” ì˜ì§€ê°€ ê¹ƒë“ ë‹¤.",
    img: "images/weapons/sword_08.png"
  },
  9: {
    name: "ê³ ê·€í•œ ê¸°ì‚¬ì˜ ê²€",
    desc: "ëª…ì˜ˆì™€ ì±…ì„ì„ í•¨ê»˜ ì§Šì–´ì§„, í’ˆìœ„ ìˆëŠ” ì „ì¥ì˜ ë™ë°˜ìë‹¤.",
    img: "images/weapons/sword_09.png"  // ğŸ‘‰ ì§€ê¸ˆ ë„¤ê°€ í™•ì •í•œ 9ê°• ì´ë¯¸ì§€
  },
  10: {
    name: "ì„œì•½ì„ ì§€ë‹Œ ì„±ì „ì˜ ê²€",
    desc: "ì§€ì¼œì•¼ í•  ì´ë¦„ì´ ìƒê¸´ ìˆœê°„, ì´ ê²€ì€ ê¸°ë„ì²˜ëŸ¼ íœ˜ë‘˜ëŸ¬ì§„ë‹¤.",
    img: "images/weapons/sword_10.png"
  },
  11: {
    name: "ìš©ë§¹ì˜ ì„œê´‘ê²€",
    desc: "ëˆ„êµ¬ë³´ë‹¤ ë¨¼ì € ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ëŠ” ì´ì˜, ëœ¨ê±°ìš´ ìš©ê¸°ë¥¼ ë¹„ì¶˜ë‹¤.",
    img: "images/weapons/sword_11.png"
  },
  12: {
    name: "ì€ë¹› ì‹¬íŒì˜ ê²€",
    desc: "ì°¨ê°€ìš´ ì¹¼ë‚  ìœ„ì—ì„œ, ì˜³ê³  ê·¸ë¦„ì´ ì¡°ìš©íˆ ê°ˆë¼ì§„ë‹¤.",
    img: "images/weapons/sword_12.png"
  },
  13: {
    name: "ì„±ë²½ì„ ìˆ˜í˜¸í•˜ëŠ” ê²€",
    desc: "ì¹¨ë¬µ ì†ì—ì„œ í”ë“¤ë¦¼ ì—†ì´, ë§ˆì§€ë§‰ ë°©ì–´ì„ ì— ì„œ ìˆë‹¤.",
    img: "images/weapons/sword_13.png"
  },
  14: {
    name: "ì™•ê°€ì˜ ì˜ì§€ê²€",
    desc: "í•œ ë‚˜ë¼ì˜ ì‹œê°„ê³¼ ë¬´ê²Œê°€, ë¬µì§í•˜ê²Œ ì†ëìœ¼ë¡œ ì „í•´ì§„ë‹¤.",
    img: "images/weapons/sword_14.png"
  },
  15: {
    name: "ì„±ì—­ì„ ì§€í‚¤ëŠ” ì„±ê²€",
    desc: "ê·¸ ì–´ë–¤ ìœ„í˜‘ ì•ì—ì„œë„ ë¬¼ëŸ¬ì„œì§€ ì•ŠëŠ”, ì¹¨ë¬µì˜ ìˆ˜í˜¸ìë‹¤.",
    img: "images/weapons/sword_15.png"
  },
  16: {
    name: "ì‹¬ì—°ì„ ê¿°ëš«ëŠ” ì„±ê²€",
    desc: "ì–´ë‘ ì˜ ê°€ì¥ ê¹Šì€ ìë¦¬ê¹Œì§€, í•œ ì¤„ê¸° ë¹›ì´ ë‚´ë ¤ ê½‚íŒë‹¤.",
    img: "images/weapons/sword_16.png"
  },
  17: {
    name: "ë¶ˆê¸¸ì˜ ì‹¬íŒê²€",
    desc: "íƒ€ëŠ” ë“¯í•œ ë¶„ë…¸ê°€ ì¹¼ë‚ ì„ ê°ì‹¸ë©°, ì•…ì„ ì¬ë¡œ ë‚¨ê¸´ë‹¤.",
    img: "images/weapons/sword_17.png"
  },
  18: {
    name: "ì•…ë§ˆ ì‚´ìœ¡ì",
    desc: "ì§€ì˜¥ì—ì„œ ê¸°ì–´ì˜¤ë¥¸ ê²ƒë“¤ì¡°ì°¨, ì´ ì´ë¦„ ì•ì—ì„œëŠ” ì¹¨ë¬µí•œë‹¤.",
    img: "images/weapons/sword_18.png"
  },
  19: {
    name: "ì§€ì˜¥ë¬¸ ë´‰ì‡„ê²€",
    desc: "ì´ë¯¸ ì—´ë¦° ì¬ì•™ì˜ ë¬¸ì„, ë§ˆì§€ë§‰ í˜ìœ¼ë¡œ ë‹¤ì‹œ ë‹«ì•„ë²„ë¦°ë‹¤.",
    img: "images/weapons/sword_19.png"
  },
  20: {
    name: "ë‚™ì¸ì˜ ì„±í™”ê²€",
    desc: "ê±°ìŠ¤ë¥¼ ìˆ˜ ì—†ëŠ” ê°ì˜¤ê°€, ë¶ˆë©¸ì˜ ë‚™ì¸ì²˜ëŸ¼ ìƒˆê²¨ì§„ë‹¤.",
    img: "images/weapons/sword_20.png"
  },
  21: {
    name: "ì—­ì²œì˜ íšƒë¶ˆê²€",
    desc: "ì •í•´ì§„ ê¸¸ì„ ë”°ë¥´ì§€ ì•Šê³ , ìê¸°ë§Œì˜ í•˜ëŠ˜ì„ ë°íŒë‹¤.",
    img: "images/weapons/sword_21.png"
  },
  22: {
    name: "ì²œìƒì„ ê±°ìŠ¤ë¥´ëŠ” ì„±ê·¹ê²€",
    desc: "ì‹ ì„±ì˜ ì§ˆì„œë¥¼ ë’¤í”ë“¤ê² ë‹¤ëŠ” ìœ„í—˜í•œ ì„ íƒì´ ê¹ƒë“¤ì–´ ìˆë‹¤.",
    img: "images/weapons/sword_22.png"
  },
  23: {
    name: "ì‹ ì¢Œë¥¼ í”ë“œëŠ” ì„œìŠ¬ê²€",
    desc: "ë†’ì€ í•˜ëŠ˜ ìœ„ì˜ ì™•ì¢Œë§ˆì €, ì´ ì¹¼ë ì•ì—ì„œëŠ” í”ë“¤ë¦°ë‹¤.",
    img: "images/weapons/sword_23.png"
  },
  24: {
    name: "ì‹ ì‚´ì˜ ì™•ê²€",
    desc: "ì‹ ì¡°ì°¨ í”¼í•˜ì§€ ëª»í•œ ê²°ë§ì„, ì¹¨ë¬µ ì†ì— ê·¸ì–´ë‚¸ë‹¤.",
    img: "images/weapons/sword_24.png"
  },
  25: {
    name: "ë³„ì„ ê°€ë¥´ëŠ” ì„±ê´‘ê²€",
    desc: "ë°¤í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë³¸ ì´ë¼ë©´, ëˆ„êµ¬ë‚˜ ê·¸ ìì·¨ë¥¼ ëª©ê²©í•˜ê²Œ ëœë‹¤.",
    img: "images/weapons/sword_25.png"
  },
  26: {
    name: "ì°½ê³µì„ ì´ˆì›”í•œ ì´ˆì›”ê²€",
    desc: "ì´ì œ í•˜ëŠ˜ê³¼ ë•…ì˜ ê²½ê³„ëŠ”, ë” ì´ìƒ ì˜ë¯¸ë¥¼ ê°–ì§€ ëª»í•œë‹¤.",
    img: "images/weapons/sword_26.png"
  },
  27: {
    name: "ì°¨ì›ì„ ë² ì–´ë‚´ëŠ” ì ˆì—°ê²€",
    desc: "ì„¸ê³„ì™€ ì„¸ê³„ë¥¼ ë‚˜ëˆ„ëŠ” ë§ˆì§€ë§‰ ì„ ì´, ë‚  ìœ„ì— ê·¸ì–´ì§„ë‹¤.",
    img: "images/weapons/sword_27.png"
  },
  28: {
    name: "ì¢…ì–¸ì˜ ì„œì•½ê²€",
    desc: "í•œ ë²ˆì˜ ê²°ë‹¨ìœ¼ë¡œ, ì„¸ê³„ì˜ ëë§ˆì € ì•½ì†ëœ ê²°ë§ì²˜ëŸ¼ ë‹¤ê°€ì˜¨ë‹¤.",
    img: "images/weapons/sword_28.png"
  },
  29: {
    name: "ìš´ëª…ì˜ ì‹¬íŒê²€",
    desc: "ë³„ê³¼ ì‹œê°„, ì¸ê³¼ì˜ íë¦„ì´ ëª¨ë‘ ì´ ì¹¼ëìœ¼ë¡œ ëª¨ì—¬ë“ ë‹¤.",
    img: "images/weapons/sword_29.png"
  },
  30: {
    name: "ìš´ëª…ì„ ì§‘í–‰í•˜ëŠ” ã€Œë§¹ì„¸ì˜ ê³„ìœ¨ã€",
    desc: "ë” ì´ìƒ ê²€ì´ ì•„ë‹ˆë‹¤ â€” ë§¹ì„¸ê°€ ë°˜ë“œì‹œ ì‹¤í˜„ë˜ëŠ”, ìš°ì£¼ì˜ ì§ˆì„œê°€ ë˜ì—ˆë‹¤.",
    img: "images/weapons/sword_30.png"
  }
};

  // ğŸŒŒ ì°½ ì „ìš© ë¬´ê¸° ì •ë³´ í…Œì´ë¸”
// 0ê°•ì€ ê²€ê³¼ ê³µìš©ìœ¼ë¡œ ê°™ì€ ê°ì²´ë¥¼ ì“´ë‹¤.
const WEAPON_INFO_SPEAR = {
  0: WEAPON_INFO[0],  // "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´" ê³µìš©

  1: {
    name: "ë¶€ëŸ¬ì§„ ì°½ë",
    desc: "ë” ì´ìƒ ëˆ„êµ¬ë¥¼ ê²¨ëˆŒ ìˆ˜ë„ ì—†ëŠ” ì±„, ì „ì¥ì˜ ëì— ë²„ë ¤ì ¸ ìˆë‹¤.",
    img: "images/weapons/spear_01.png"
  },
  2: {
    name: "ê¸ˆì´ ê°„ ì°½",
    desc: "í•œ ë²ˆë§Œ ë” í˜ì„ ì£¼ë©´, ê·¸ëŒ€ë¡œ ì‚°ì‚°ì´ ë¶€ì„œì ¸ ë²„ë¦´ ê²ƒ ê°™ë‹¤.",
    img: "images/weapons/spear_02.png"
  },
  3: {
    name: "í”¼ê°€ êµ³ì€ ì°½",
    desc: "ì˜¤ë˜ì „ì— ë©ˆì¶˜ ì‹¸ì›€ì˜ í”ì ë§Œì´, ì°¨ê°‘ê²Œ ë‚¨ì•„ ìˆë‹¤.",
    img: "images/weapons/spear_03.png"
  },
  4: {
    name: "ë²„ë ¤ì§„ ì°½ëŒ€",
    desc: "ì†ì—ì„œ ë†“ì¸ ìˆœê°„, ì´ ë¬´ê¸°ëŠ” ì‚¬ëƒ¥ê¾¼ì˜ ì´ë¦„ì„ ìƒì—ˆë‹¤.",
    img: "images/weapons/spear_04.png"
  },
  5: {
    name: "ë‹¿ì§€ ëª»í•œ ì°½",
    desc: "ë‹¨ í•œ ë²ˆë„ ê¸‰ì†Œë¥¼ ì°Œë¥´ì§€ ëª»í•œ ì±„, ì‹œê°„ì„ ê²¬ë””ê³  ìˆë‹¤.",
    img: "images/weapons/spear_05.png"
  },

  6: {
    name: "ì‡³ê²° ì°½ë‚ ",
    desc: "ë‹¤ì‹œ ë²¼ë ¤ì§„ ë‚  ìœ„ì—, ì ë“  ê²°ì‹¬ì´ ê¹¨ì–´ë‚œë‹¤.",
    img: "images/weapons/spear_06.png"
  },
  7: {
    name: "ê±°ì¹œ ì—°ë§ˆì°½",
    desc: "ë¶ˆì•ˆì •í–ˆë˜ ë¬´ê²Œê°€ ì ì°¨ ì „íˆ¬ë¥¼ í–¥í•´ ì •ë ¬ëœë‹¤.",
    img: "images/weapons/spear_07.png"
  },
  8: {
    name: "ì•¼ì „ ì „íˆ¬ì°½",
    desc: "ë‚¯ì„  ë•…ê³¼ ë°”ëŒì´, ì´ ë¬´ê¸°ì˜ ì²« ì „ì¥ì„ ë§Œë“¤ì–´ ì¤€ë‹¤.",
    img: "images/weapons/spear_08.png"
  },
  9: {
    name: "ì‚¬ëƒ¥ê¾¼ ì¶”ì ì°½",
    desc: "ë„ë§ì¹œ ì ì„ í—ˆë½í•˜ì§€ ì•Šê² ë‹¤ëŠ” ë¬´ì–¸ì˜ ì˜ì§€ê°€ ê¹ƒë“ ë‹¤.",
    img: "images/weapons/spear_09.png"
  },
  10: {
    name: "ì¥ê±°ë¦¬ ì›ì •ì°½",
    desc: "ì „ì‚¬ëŠ” ê¸°ë‹¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤ â€” ê°•ìë¥¼ ì°¾ì•„ ìŠ¤ìŠ¤ë¡œ ê¸¸ ìœ„ì— ì„ ë‹¤.",
    img: "images/weapons/spear_10.png"
  },

  11: {
    name: "å½±[ì˜]",
    desc: "ì•½ìëŠ” ì§€ë‚˜ì¹œë‹¤ â€” ì´ ì°½ì€ ê°•ìì˜ ëƒ„ìƒˆë§Œì„ ì¢‡ëŠ”ë‹¤.",
    img: "images/weapons/spear_11.png"
  },
  12: {
    name: "ìŠ¤ì¹¼ë“œ ê²Œì´ë¥´",
    desc: "ì „ì‚¬ì˜ ë…¸ë˜ì— ë‚¨ì„ ì‹¸ì›€ë§Œì„, ì˜ë„ì ìœ¼ë¡œ ì„ íƒí•œë‹¤.",
    img: "images/weapons/spear_12.png"
  },
  13: {
    name: "ì•Œë§ˆ ê²Œì´ë¥´",
    desc: "ë¬¼ëŸ¬ë‚  ê¸¸ì„ í—ˆë½í•˜ì§€ ì•ŠëŠ”ë‹¤ â€” ì´ ì°½ì´ ì„ íƒí•œ ì´ëŠ” ë°˜ë“œì‹œ ë§ì„œì•¼ í•œë‹¤.",
    img: "images/weapons/spear_13.png"
  },
  14: {
    name: "ë² ì–´ìš¸í”„ íŒ”ë¼ë”˜",
    desc: "ì „ì„¤ì´ë¼ ë¶ˆë¦° ê´´ìˆ˜ì¡°ì°¨, ê²°ì „ì˜ ìš”ì²­ì„ í”¼í•˜ì§€ ëª»í•œë‹¤.",
    img: "images/weapons/spear_14.png"
  },
  15: {
    name: "ìš¸í”„ê°€ë¥´",
    desc: "ì‚¬ëƒ¥ê¾¼ë“¤ ìœ„ì—ì„œ, ìŠ¹ìë§Œì´ ë°”ë¼ë³¼ ìˆ˜ ìˆëŠ” ì„¸ê³„ê°€ ì—´ë¦°ë‹¤.",
    img: "images/weapons/spear_15.png"
  },

  16: {
    name: "í”„ë¡œë¯¸ë„ŒìŠ¤ ë² ë¥´í¬",
    desc: "ë¶ˆì˜ ì‹¬ì—°ì„ í–¥í•´, ì´ ì°½ì€ í•œ ì¹˜ì˜ ë§ì„¤ì„ë„ ë‚¨ê¸°ì§€ ì•ŠëŠ”ë‹¤.",
    img: "images/weapons/spear_16.png"
  },
  17: {
    name: "í¬íš¨í•˜ëŠ” ë¶ˆê½ƒ",
    desc: "í¬íš¨ì™€ í™”ì—¼ì„ ê°€ë¥´ë©°, ë„ì „ì€ ì˜¤ì§ ì „ë©´ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.",
    img: "images/weapons/spear_17.png"
  },
  18: {
    name: "ìš© ì‚¬ëƒ¥ê¾¼",
    desc: "ê±°ëŒ€í•œ ì‹¬ì¥ì´ ë§ˆì§€ë§‰ìœ¼ë¡œ ë–¨ë¦°ë‹¤ â€” ì—¬ê¸°ì„œ ì‚¬ëƒ¥ì˜ ì—¬ì •ì€ ëë‚œë‹¤.",
    img: "images/weapons/spear_18.png"
  },

  19: {
    name: "ì•Œí‹°ìŠ¤ ì—˜ë¦¬ì˜¨",
    desc: "ì •ë³µí•  ê´´ìˆ˜ê°€ ì‚¬ë¼ì§„ ìë¦¬ì—ì„œ, ì „ì‚¬ëŠ” í•˜ëŠ˜ì„ ë°”ë¼ë³¸ë‹¤.",
    img: "images/weapons/spear_19.png"
  },
  20: {
    name: "ë ˆì§€ìŠ¤ ì´ê·¸ë‹ˆìŠ¤",
    desc: "ê¶Œìœ„ ìœ„ì— ë¶ˆê½ƒì´ ê½‚íˆëŠ” ìˆœê°„, ë„ì „ì€ ë°˜ì—­ì´ ëœë‹¤.",
    img: "images/weapons/spear_20.png"
  },
  21: {
    name: "ì˜¤ë¥´ë„ ë„¤ê°€í‹°ì˜¤",
    desc: "ì´ ì°½ì€ ì¡´ì¬ì˜ ì§ˆì„œ ê·¸ ìì²´ë¥¼ í–¥í•´ ë˜ì ¸ì§„ë‹¤.",
    img: "images/weapons/spear_21.png"
  },

  22: {
    name: "è–æˆŸ[ì„±ê·¹]",
    desc: "ì„±ì—­ì˜ ì‹¬ì¥ë§ˆì €, ë” ì´ìƒ ì•ˆì „í•˜ì§€ ì•Šë‹¤.",
    img: "images/weapons/spear_22.png"
  },
  23: {
    name: "ì“°ë¡ ë¸Œë ˆí—ˆ",
    desc: "ë†’ì´ ì•‰ì€ ìë¥¼ ëŒì–´ë‚´ë¦°ë‹¤ â€” ì™•ì¢Œ ìœ„ì—ì„œë„ ì˜ˆì™¸ëŠ” ì—†ë‹¤.",
    img: "images/weapons/spear_23.png"
  },
  24: {
    name: "ë¡±ê¸°ëˆ„ìŠ¤ ì—‘ìŠ¤ ë§ˆí‚¤ë‚˜",
    desc: "ì‹ ì˜ ëª¸ì„ ê´€í†µí•œ ì°½. ì´ê²ƒì€ ì¡´ì¬ë¥¼ ëš«ëŠ”ë‹¤ëŠ” ì •ì˜ê°€ ëœë‹¤.",
    img: "images/weapons/spear_24.png"
  },

  25: {
    name: "ì•„ìŠ¤íŠ¸ë¼ ë£¨í”„íˆ¬ë¼",
    desc: "ë³„ì˜ ì¤‘ì¶”ê°€ í”ë“¤ë¦¬ë©°, ìš°ì£¼ì˜ ìš¸ë¦¼ì´ ë”°ë¼ ì§„ë™í•œë‹¤.",
    img: "images/weapons/spear_25.png"
  },
  26: {
    name: "è¶…æ»…æ§[ì´ˆë©¸ì°½]",
    desc: "í•˜ëŠ˜ì˜ ê³¨ê²©ì´ ë¶€ì„œì§€ê³ , ê²½ê³„ê°€ ìì‹ ì˜ ì˜ë¯¸ë¥¼ ìƒëŠ”ë‹¤.",
    img: "images/weapons/spear_26.png"
  },
  27: {
    name: "ë””ë©˜í”„ë™íŠ¸",
    desc: "ì°¨ì›ì„ ë‚˜ëˆ„ë˜ ë§ˆì§€ë§‰ ì„ ì´, ì¡°ìš©íˆ ì°¢ê²¨ ë‚˜ê°„ë‹¤.",
    img: "images/weapons/spear_27.png"
  },

  28: {
    name: "í„°ë¯¸ë„ˆìŠ¤ ìŠ¤í”¼ì–´",
    desc: "ì¢…ì–¸ì€ ì´ì œ ì‚¬ê±´ì´ ì•„ë‹ˆë¼ â€” ë°˜ë“œì‹œ ë„ë‹¬í•  ì§€ì ì´ ëœë‹¤.",
    img: "images/weapons/spear_28.png"
  },
  29: {
    name: "ã€Œåˆ‡æ–·ã€[ì ˆë‹¨]",
    desc: "ì ˆë‹¨ì´ë¼ëŠ” ê·œì¹™ë§Œ ë‚¨ì•˜ë‹¤. ì´ê²ƒì˜ í˜•íƒœëŠ” ì´ì œ ì¤‘ìš”í•˜ì§€ ì•Šë‹¤.",
    img: "images/weapons/spear_29.png"
  },
  30: {
    name: "íŒŒê´´ì˜ ê³„ìœ¨ ã€Œë””ì—ìŠ¤ ì´ë¼ì—ã€",
    desc: "ë” ì´ìƒ ë¬´ê¸°ê°€ ì•„ë‹ˆë‹¤ â€” íŒŒê´´ë¼ëŠ” ë²•ì¹™ìœ¼ë¡œ ì¡´ì¬í•œë‹¤.",
    img: "images/weapons/spear_30.png"
  }
};

  // ğŸ”° ê°•í™” ë‹¨ê³„ë³„ ë„ë¼ ì´ë¦„ / ì„¤ëª… / ì´ë¯¸ì§€ ê²½ë¡œ
const WEAPON_INFO_AXE = {
  0: WEAPON_INFO[0],  // "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´" ê³µìš©

  1: {
    name: "ê¸ˆì´ ê°„ ë„ë¼ë‚ ",
    desc: "ê¸ˆì´ ê°„ ë‚¡ì€ ë„ë¼.",
    img: "images/weapons/axe_01.png"
  },
  2: {
    name: "ë…¹ìŠ¨ ë„ë¼",
    desc: "ì „ì¥ì„ ë– ë‚œ ë„ë¼.",
    img: "images/weapons/axe_02.png"
  },
  3: {
    name: "ë¬´ë„ˆì§„ ì†ì¡ì´",
    desc: "ì£¼ì¸ì„ ìƒê³  ë°©ì¹˜ëœ ì±„, ë” ì´ìƒ íœ˜ë‘ë¥¼ ìˆ˜ ì—†ëŠ” ë„ë¼.",
    img: "images/weapons/axe_03.png"
  },
  4: {
    name: "ë²„ë ¤ì§„ ì•½íƒˆë„ë¼",
    desc: "ì•½íƒˆì˜ í”ì ë§Œì„ ë‚¨ê¸°ê³ , ì „ì¥ì— ë²„ë ¤ì§„ ë„ë¼.",
    img: "images/weapons/axe_04.png"
  },
  5: {
    name: "ì ë“¤ì§€ ëª»í•œ ë„ë¼",
    desc: "ì—¬ì „íˆ ì „ì¥ì„ ê¿ˆê¾¸ë©°, ê¹¨ì–´ë‚  ìˆœê°„ì„ ê¸°ë‹¤ë¦°ë‹¤.",
    img: "images/weapons/axe_05.png"
  },

  6: {
    name: "ì•¼ì „ ì „íˆ¬ë„ë¼",
    desc: "ë‹¤ì‹œ ì „ì¥ìœ¼ë¡œ ëŒì•„ì˜¨, ì‹¤ì „ì˜ ë¬´ê²Œë¥¼ ì§€ë‹Œ ë„ë¼.",
    img: "images/weapons/axe_06.png"
  },
  7: {
    name: "í”¼íˆ¬ì„±ì´ ëŒê²©ë„ë¼",
    desc: "ëŒê²© ì†ì—ì„œ í”¼ì™€ í™ì„ í•¨ê»˜ ë’¤ì§‘ì–´ì“´ ë„ë¼.",
    img: "images/weapons/axe_07.png"
  },
  8: {
    name: "ì•½íƒˆì˜ ë„ë¼",
    desc: "ìŠ¹ë¦¬ë³´ë‹¤ ì•½íƒˆì„ ìœ„í•´ íœ˜ë‘˜ëŸ¬ì§€ëŠ”, ì”í˜¹í•œ ë„ë¼.",
    img: "images/weapons/axe_08.png"
  },
  9: {
    name: "ì „ì¥ì˜ ê´‘ì „ì‚¬ ë„ë¼",
    desc: "ì´ì„±ë³´ë‹¤ ë¶„ë…¸ê°€ ë¨¼ì € íœ˜ë‘ë¥´ëŠ” ê´‘ì „ì‚¬ì˜ ë¬´ê¸°.",
    img: "images/weapons/axe_09.png"
  },
  10: {
    name: "í”¼ì˜ ë§¹ì•½ë„ë¼",
    desc: "ë¬¼ëŸ¬ì„¬ì„ í—ˆë½í•˜ì§€ ì•ŠëŠ”, í”¼ë¡œ ë§ºì€ ì „íˆ¬ì˜ ë§¹ì•½.",
    img: "images/weapons/axe_10.png"
  },

  11: {
    name: "ë¼ìš°ë“œ",
    desc: "ì „ì¥ì„ ìš¸ë¦¬ëŠ” ê´‘ê¸°ì˜ í¬íš¨ê°€, ë„ë¼ë¥¼ ë’¤í”ë“ ë‹¤.",
    img: "images/weapons/axe_11.png"
  },
  12: {
    name: "ë² ë¥´ì„¸ë¥´í¬ ë¡œì–´",
    desc: "ê´‘ì „ì‚¬ì˜ ì „íˆ¬ ë³¸ëŠ¥ì´, ë„ë¼ì™€ í•¨ê»˜ ìš¸ë ¤ í¼ì§„ë‹¤.",
    img: "images/weapons/axe_12.png"
  },
  13: {
    name: "ë¸”ëŸ¬ë“œ í•˜ìš¸",
    desc: "í”¼ë¥¼ ë¶€ë¥´ëŠ” ìš¸ìŒì´, ì ì˜ ì˜ì§€ë¥¼ êº¾ëŠ”ë‹¤.",
    img: "images/weapons/axe_13.png"
  },
  14: {
    name: "ì¹´ì˜¤ìŠ¤ ì˜¤ìŠ¤",
    desc: "ë¬´ì§ˆì„œì™€ íŒŒê´´ë¥¼ í–¥í•œ ë§¹ì„¸ê°€ ë„ë¼ì— ê°ì¸ëœë‹¤.",
    img: "images/weapons/axe_14.png"
  },
  15: {
    name: "ë ˆë“œ ë¼ê·¸ë‚˜",
    desc: "ë¶‰ì€ ì¢…ë§ì„ ì˜ˆê³ í•˜ëŠ”, ì „ì¥ì˜ í”¼ë¹› ë„ë¼.",
    img: "images/weapons/axe_15.png"
  },

  16: {
    name: "ë”¥ìŠ¤íŠ¸ë¼ì´ë“œ",
    desc: "ê±°ëŒ€í•œ ì‹¬ì—°ìœ¼ë¡œ, ìŠ¤ìŠ¤ë¡œ ê±¸ì–´ ë“¤ì–´ê°„ ì „ì‚¬ì˜ ë„ë¼.",
    img: "images/weapons/axe_16.png"
  },
  17: {
    name: "ìì´ì–¸íŠ¸ ìŠ¬ë ˆì´ì–´",
    desc: "ê±°ì¸ì„ í•™ì‚´í•œ ë„ë¼, ë‘ë ¤ì›€ì„ ìŠì€ ì¡´ì¬ì—ê²Œ ë‹¤ì‹œ ë‘ë ¤ì›€ì„ ê°ì¸ì‹œí‚¨ë‹¤.",
    img: "images/weapons/axe_17.png"
  },
  18: {
    name: "ìš”íˆ° ë¸Œë ˆì´ì»¤",
    desc: "ì§€ì˜¥ ìì²´ë¥¼ ë¶•ê´´í•´ë²„ë¦° ì „ì„¤ì ì¸ ë„ë¼.",
    img: "images/weapons/axe_18.png"
  },

  19: {
    name: "ì–´ì„¼ë” ì˜¤ë¸Œ ë” í™€",
    desc: "ì„ íƒë°›ì€ ì „ì‚¬ë“¤ì˜ í•˜ëŠ˜ì„ í–¥í•´, ê¸ˆê¸°ë¥¼ ë„˜ì–´ì„ ë‹¤.",
    img: "images/weapons/axe_19.png"
  },
  20: {
    name: "í¬ë¼ìš´í´ ì—£ì§€",
    desc: "ê´‘ê¸°ì— ì –ì€ ì „ì‚¬ë“¤ì˜ ë¶„ë…¸ëŠ” ë©ˆì¶”ì§€ ì•Šê³  ê·¸ë“¤ì˜ ì£¼êµ°ì„ í–¥í•œë‹¤.",
    img: "images/weapons/axe_20.png"
  },
  21: {
    name: "ë°œí• ë¼ ì„¸ë²„ëŸ¬",
    desc: "í•˜ëŠ˜ì˜ ì „ë‹¹ì„ ê°€ë¥´ë©° â€” ì‹ ì¢Œë¥¼ ë¶€ì •í•œ ë„ë¼.",
    img: "images/weapons/axe_21.png"
  },

  22: {
    name: "ì˜¤ìŠ¤ë¸Œë ˆì´ì»¤ìŠ¤ ìš´ë“œ",
    desc: "ì‹ ì„±í•œ ì•½ì†ì´ í”¼ì²˜ëŸ¼ í˜ëŸ¬ë‚´ë¦° ìë¦¬.",
    img: "images/weapons/axe_22.png"
  },
  23: {
    name: "ì“°ë¡  ì–´ì„œí¼",
    desc: "ì™•ì¢ŒëŠ” ì§€ì¼œì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ â€” ë¹¼ì•—ê¸°ëŠ” ê²ƒì´ë‹¤.",
    img: "images/weapons/axe_23.png"
  },
  24: {
    name: "ë¸Œë ˆì´ì»¤ ì˜¤ë¸Œ ì•„ìŠ¤ê°€ë¥´ë“œ",
    desc: "ìì‹ ë§ˆì € ì§‘ì–´ì‚¼í‚¨ ë¶„ë…¸ëŠ” ëë‚´ ê·¸ë“¤ì˜ ì‹ ê²©ë§ˆì € ë§ì‚´í•œë‹¤.",
    img: "images/weapons/axe_24.png"
  },

  25: {
    name: "ë£¨íŠ¸ í”„ë™ì²˜",
    desc: "í•œë²ˆì˜ íœ˜ë‘ë¦„ì— ë³´ì´ì§€ ì•ŠëŠ” ì„¸ê³„ì˜ ë¿Œë¦¬ì—, ì²« ê¸ˆì´ ê°„ë‹¤.",
    img: "images/weapons/axe_25.png"
  },
  26: {
    name: "ì•¡ì‹œìŠ¤ ë¸Œë ˆì´í¬",
    desc: "ì„¸ê³„ë¥¼ ì‡ë˜ ì¶•ì´, ì ì  ê¸°ìš¸ì–´ì§€ê¸° ì‹œì‘í•œë‹¤.",
    img: "images/weapons/axe_26.png"
  },
  27: {
    name: "ì´ê·¸ë“œë¼ì‹¤ ì‹œì–´",
    desc: "ê±°ëŒ€í•œ ë¶„ë…¸ê°€ ë§Œë“¤ì–´ë‚¸ ë¶•ê´´ëŠ” ì°¨ì›ë§ˆì € ì ˆë‹¨ ì‹œí‚¨ë‹¤.",
    img: "images/weapons/axe_27.png"
  },

  28: {
    name: "ì‹±ê·¤ëŸ¬ ë£¨ì¸",
    desc: "íŒŒê´´ëŠ” ë” ì´ìƒ ì‚¬ê±´ì´ ì•„ë‹ˆë‹¤ â€” ì¡´ì¬ì˜ ìƒíƒœë‹¤.",
    img: "images/weapons/axe_28.png"
  },
  29: {
    name: "ë¡œ ì˜¤ë¸Œ ì½œë©ìŠ¤",
    desc: "ë¬´ë„ˆì§ì€ ì„ íƒì´ ì•„ë‹ˆë¼ â€” í•„ì—°ì´ ëœë‹¤.",
    img: "images/weapons/axe_29.png"
  },

  30: {
    name: "í˜¼ëˆì˜ ì„œë§‰ ã€Œì—ìŠ¤ì¹´í†¤ã€",
    desc: "ë” ì´ìƒ ë¬´ê¸°ê°€ ì•„ë‹ˆë‹¤ â€” í˜¼ëˆì˜ í˜•íƒœì¼ ë¿.",
    img: "images/weapons/axe_30.png"
  }
};

  const WEAPON_INFO_BOW = {
0: WEAPON_INFO[0],  // "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´" ê³µìš©
    
  // ğŸŒ‘ 1~10ê°• : í˜„ì‹¤ ì‚¬ëƒ¥ ì¥ë¹„
  1:  { name: "ë‚¡ì€ ì‚¬ëƒ¥ í™œ",          desc: "ì†ì— ìµì€ ë‚˜ë¬´ í™œ. ì‹œì‘ì€ ì¡°ìš©í•˜ë‹¤.", img: "images/weapons/bow_01.png" },
  2:  { name: "ê°€ì£½ ì‹œìœ„ ë‹¨ê¶",        desc: "ê°€ì£½ ì‹œìœ„ê°€ íŒ½íŒ½íˆ ìš¸ë¦°ë‹¤.",         img: "images/weapons/bow_02.png" },
  3:  { name: "ì‚¬ëƒ¥ ë‹¨ê¶",            desc: "ê¸‰ì†Œë¥¼ ì°¾ëŠ” ëˆˆì´ ì¡°ê¸ˆ ë” ì„ ëª…í•´ì§„ë‹¤.", img: "images/weapons/bow_03.png" },
  4:  { name: "ë¡±ë³´ìš°",               desc: "ì‚¬ì •ê±°ë¦¬ê°€ ê³§ ìì‹ ê°ì´ ëœë‹¤.",         img: "images/weapons/bow_04.png" },
  5:  { name: "ì‚¬ëƒ¥ ì¥ê¶",            desc: "í•œ ë°œë¡œ ëë‚´ëŠ” ì‚¬ëƒ¥ê¾¼ì˜ ê¸°ë³¸ê¸°.",       img: "images/weapons/bow_05.png" },
  6:  { name: "ë§¤ë³µ ì¥ê¶",            desc: "ìˆ¨ì„ ì£½ì´ë©´, ë°”ëŒì´ ê¸¸ì„ ì•Œë ¤ì¤€ë‹¤.",    img: "images/weapons/bow_06.png" },
  7:  { name: "ë°”ì´íƒˆìƒ· ë³´ìš°",         desc: "ì‹¬ì¥ ë°•ë™ì„ ë”°ë¼ í™”ì‚´ì´ ê°„ë‹¤.",        img: "images/weapons/bow_07.png" },
  8:  { name: "í”„ë¦¬ì‹œì „",             desc: "ì¡°ì¤€ì´ ì•„ë‹ˆë¼ â€˜í™•ì‹ â€™ìœ¼ë¡œ ìœë‹¤.",        img: "images/weapons/bow_08.png" },
  9:  { name: "ì‹¤ë²„ìŠ¤íŠ¸ë§ ë³´ìš°",       desc: "ì€ë¹› ì‹œìœ„ê°€ ë¯¸ì„¸í•œ ë–¨ë¦¼ê¹Œì§€ ì ê·¼ë‹¤.",   img: "images/weapons/bow_09.png" },
  10: { name: "ëª…ê¶(åå¼“)",            desc: "ì´ì œë¶€í„°ëŠ” â€˜ì¥ë¹„â€™ê°€ ì•„ë‹ˆë¼ â€˜ê¸°ìˆ â€™ì´ë‹¤.", img: "images/weapons/bow_10.png" },

  // ğŸŒ’ 11~17ê°• : ë‹¬Â·ìˆ²Â·ë³„
  11: { name: "ì›”ë¦¼ê¶(æœˆæ—å¼“)",         desc: "ë‹¬ë¹›ì´ ìˆ²ì„ ìŠ¤ì¹˜ë©´, í™”ì‚´ì€ ì†Œë¦¬ ì—†ì´ ì‚¬ë¼ì§„ë‹¤.", img: "images/weapons/bow_11.png" },
  12: { name: "ì€ì—½ê¶(éŠ€è‘‰å¼“)",         desc: "ì€ë¹› ìë§¥ì²˜ëŸ¼ ê¶¤ì ì´ ì–‡ê²Œ ë‚¨ëŠ”ë‹¤.",             img: "images/weapons/bow_12.png" },
  13: { name: "ë³„ ì‚¬ëƒ¥ê¾¼",              desc: "ë³„ì„ ê²¨ëˆ„ëŠ” ìëŠ”, ì´ë¯¸ ëŒì•„ì˜¬ ê¸¸ì„ ë²„ë ¸ë‹¤.",      img: "images/weapons/bow_13.png" },
  14: { name: "ì œí”¼ë¡œìŠ¤",    desc: "ì„œí’ì´ ë“±ì„ ë°€ë©´, ëª…ì¤‘ì€ â€˜ì‹œê°„ ë¬¸ì œâ€™ê°€ ëœë‹¤.",     img: "images/weapons/bow_14.png" },
  15: { name: "ë£¨ë‚˜ë¦¬ìŠ¤ ë³´ìš°", desc: "ë‹¬ì˜ ìœ¤ê³½ì„ ë”°ë¼ ê¶¤ë„ê°€ ì •ë ¬ëœë‹¤.",          img: "images/weapons/bow_15.png" },
  16: { name: "ìŠ¤íƒ€ì²´ì´ì„œ", desc: "ë„ë§ì¹˜ëŠ” ë¹›ì¡°ì°¨ ë†“ì¹˜ì§€ ì•ŠëŠ”ë‹¤.",                 img: "images/weapons/bow_16.png" },
  17: { name: "ë…¹í„´",        desc: "ë°¤ì´ ê¹Šì„ìˆ˜ë¡, í•œ ë°œì€ ë” ì°¨ê°‘ë‹¤.",               img: "images/weapons/bow_17.png" },

  // ğŸŒ• 18~20ê°• : íƒ€ì´íƒ„ ì‚¬ëƒ¥í„° êµ¬ê°„
  18: { name: "íƒ€ì´íƒ„í—Œí„°",             desc: "ê±°ì‹ ì˜ ê·¸ë¦¼ìì—, ê¸‰ì†Œ í•˜ë‚˜ë©´ ì¶©ë¶„í•˜ë‹¤.",           img: "images/weapons/bow_18.png" },
  19: { name: "ì½œë¡œì„œìŠ¤ í”¼ì–´ì„œ", desc: "ê±°ëŒ€í•œ ë°©ì–´ë„ â€˜í•œ ì â€™ì—ì„œ ë¬´ë„ˆì§„ë‹¤.", img: "images/weapons/bow_19.png" },
  20: { name: "ì²œê³µê´€í†µê¶(ç©¿ç©ºè²«å¼“)",   desc: "í•˜ëŠ˜ì„ ì°¢ëŠ” ê²Œ ì•„ë‹ˆë‹¤ â€” í•˜ëŠ˜ì„ â€˜í†µê³¼â€™í•œë‹¤.",       img: "images/weapons/bow_20.png" },

  // ğŸŒŸ 21~23ê°• : ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
  21: { name: "ì˜¤ë¦¬ì˜¨ìë¦¬",             desc: "ì‚¬ëƒ¥ê¾¼ì˜ ë³„ìë¦¬ê°€ ê¹¨ì–´ë‚œë‹¤. ì´ì œ â€˜ì¶”ì â€™ì€ ëê¹Œì§€ ê°„ë‹¤.", img: "images/weapons/bow_21.png" },
  22: { name: "ìƒì¸„ì–´ë¦¬ ìŠ¤í† ì»¤", desc: "ì„±ì—­ì´ë¼ë„, í‘œì ì´ë©´ ì˜ˆì™¸ëŠ” ì—†ë‹¤.",     img: "images/weapons/bow_22.png" },
  23: { name: "ì„¸ë¼í”„ ì• ë¡œìš°", desc: "ë¹›ì´ ë–¨ì–´ì§€ëŠ” ê°ë„ ê·¸ëŒ€ë¡œ, ê¸‰ì†Œì— ë°•íŒë‹¤.",      img: "images/weapons/bow_23.png" },

  // ğŸŒŸ 24~25ê°• : ì‹ ì˜ ì²˜ì†Œ
  24: { name: "ì•„ë¥´í…Œë¯¸ìŠ¤",   desc: "ë‹¬ ì•„ë˜ì„œ ë§¹ì„¸í•œë‹¤ â€” ë¹—ë‚˜ê°ì€ í—ˆë½ë˜ì§€ ì•ŠëŠ”ë‹¤.",     img: "images/weapons/bow_24.png" },
  25: { name: "í¬ë¡œë…¸ìŠ¤ ì•„í¬", desc: "ì‹œìœ„ë¥¼ ë‹¹ê¸°ëŠ” ìˆœê°„, í‘œì ì˜ ì‹œê°„ì´ ëŠë ¤ì§„ë‹¤.",      img: "images/weapons/bow_25.png" },

  // ğŸŒˆ 26~29ê°• : ì‹¬ì—°/ë²•ì¹™/ì˜ê²
  26: { name: "í…œí˜ìŠ¤íŠ¸ ì• ë¡œìš°", desc: "ë°”ëŒì´ ì•„ë‹ˆë¼ í­í’ì„ ìœë‹¤.",                 img: "images/weapons/bow_26.png" },
  27: { name: "ì¸í”¼ë‹ˆíŠ¸ ë“œë¡œìš°", desc: "ëì—†ëŠ” ë‹¹ê¹€ â€” ëì—†ëŠ” í™•ì •.",                img: "images/weapons/bow_27.png" },
  28: { name: "ì•„í¬ì¹¼ë¦½ìŠ¤",              desc: "í•˜ë‚˜ì˜ ë°œì‚¬ë¡œ, ì „ì¥ì˜ ê²°ë§ì´ ì •í•´ì§„ë‹¤.",               img: "images/weapons/bow_28.png" },
  29: { name: "ì˜ê²í¬ì‹ì",              desc: "ëª…ì¤‘ì€ ì‚¬ê±´ì´ ì•„ë‹ˆë‹¤ â€” ì˜ê²ì´ ë¨¹íˆëŠ” ë°©ì‹ì´ë‹¤.",       img: "images/weapons/bow_29.png" },

  // ğŸŒˆ 30ê°• : ìµœì¢…
  30: { name: "ì‹ ê¶(ç¥å¼“) ã€Œì•„ì´ì˜¨ã€", desc: "ì‹œê°„ ë²•ì¹™ ê·¸ ìì²´. â€˜ì˜ëŠ” í–‰ìœ„â€™ê°€ ê³§ ê²°ê³¼ê°€ ëœë‹¤.", img: "images/weapons/bow_30.png" }
};

  // ğŸ”® ê°•í™” ë‹¨ê³„ë³„ ìŠ¤íƒœí”„ ì´ë¦„ / ì„¤ëª… / ì´ë¯¸ì§€ ê²½ë¡œ
// 0ê°•ì€ ê³µìš©(ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´)
const WEAPON_INFO_STAFF = {
  0: WEAPON_INFO[0],

  // ğŸŒ‘ 1~10ê°• : í˜„ì‹¤ ë§ˆë²• ì¥ë¹„ (ê³ ìœ ëª…ì‚¬ ì—†ìŒ)
  1:  { name: "ë‚¡ì€ ë‚˜ë¬´ ì§€íŒ¡ì´",          desc: "ë§ˆë ¥ì´ ê±°ì˜ ë‚¨ì§€ ì•Šì€, ì˜¤ë˜ëœ ë‚˜ë¬´ ì§€íŒ¡ì´.", img: "images/weapons/staff_01.png" },
  2:  { name: "ìˆ˜ë ¨ìš© ë§ˆë²• ì§€íŒ¡ì´",        desc: "ê¸°ì´ˆ ì£¼ë¬¸ì„ ì—°ìŠµí•˜ê¸° ìœ„í•œ ìˆ˜ë ¨ ì¥ë¹„.",       img: "images/weapons/staff_02.png" },
  3:  { name: "ê°€ì£½ëˆ ë§ˆë ¥ë´‰",            desc: "ì†ì—ì„œ ë¯¸ë„ëŸ¬ì§€ì§€ ì•Šê²Œ ê°€ì£½ëˆì„ ê°ì•„ ë‘ì—ˆë‹¤.", img: "images/weapons/staff_03.png" },
  4:  { name: "ìš°ë“œ ìŠ¤íƒœí”„",              desc: "ë‚˜ë¬´ê²° ì†ì— ì”ì”í•œ ë§ˆë ¥ì´ íë¥¸ë‹¤.",           img: "images/weapons/staff_04.png" },
  5:  { name: "í‰ë²”í•œ ë§ˆë²• ì§€íŒ¡ì´",        desc: "íŠ¹ë³„í•˜ì§„ ì•Šì§€ë§Œ, ì£¼ë¬¸ì„ ë‹´ì•„ë‚´ê¸°ì—” ì¶©ë¶„í•˜ë‹¤.", img: "images/weapons/staff_05.png" },
  6:  { name: "ë£¬ ê°ì¸ ì§€íŒ¡ì´",            desc: "ì§§ì€ ë£¬ì´ ìƒˆê²¨ì ¸, ë§ˆë ¥ì´ ì¡°ê¸ˆ ë” ë˜ë ·í•´ì¡Œë‹¤.", img: "images/weapons/staff_06.png" },
  7:  { name: "ë§ˆë ¥ ì¦í­ ìŠ¤íƒœí”„",          desc: "ì£¼ë¬¸ì´ í¼ì§€ëŠ” ë°˜ê²½ì´ ë„“ì–´ì§„ë‹¤.",               img: "images/weapons/staff_07.png" },
  8:  { name: "ì •ë ¹ ì¹œí™” ì§€íŒ¡ì´",          desc: "ì •ë ¹ì´ ê³ì„ ë§´ë„ëŠ” ë“¯í•œ, ê°€ë²¼ìš´ ì§„ë™ì´ ëŠê»´ì§„ë‹¤.", img: "images/weapons/staff_08.png" },
  9:  { name: "ìƒê¸‰ ë§ˆë ¥ ìŠ¤íƒœí”„",          desc: "ë§ˆë ¥ì˜ íë¦„ì´ ì•ˆì •ì ì´ë‹¤. ì‹¤íŒ¨ê°€ ì¤„ì–´ë“  ëŠë‚Œ.", img: "images/weapons/staff_09.png" },
  10: { name: "ì•„ì¼€ì¸ íŠ¸ë ˆì´ìŠ¤",           desc: "ë¹„ì „ì˜ â€˜í”ì â€™ë§Œìœ¼ë¡œë„ ì£¼ë¬¸ì´ í˜•íƒœë¥¼ ê°€ì§„ë‹¤.",   img: "images/weapons/staff_10.png" },

  // ğŸŒ’ 11~17ê°• : ë§ˆë„í•™íŒŒÂ·íƒ‘Â·ê¸ˆì„œ
  11: { name: "ë¬¸ë¦¿ ì•„ì¹´ì´ë¸Œ",             desc: "ë‹¬ë¹› ì•„ë˜ ë´‰ì¸ëœ ê¸°ë¡ì´, ì†ëì—ì„œ í˜ì´ì§€ì²˜ëŸ¼ í¼ì³ì§„ë‹¤.", img: "images/weapons/staff_11.png" },
  12: { name: "ì—í…Œë¥´ ì‹œê¸¸",               desc: "ë³´ì´ì§€ ì•ŠëŠ” ì¸ì¥ì´ ë§ˆë ¥ì„ ë¶™ì¡ì•„, í­ì£¼ë¥¼ ë§‰ì•„ì¤€ë‹¤.",     img: "images/weapons/staff_12.png" },
  13: { name: "ìŠ¤íƒ€í´ ì—ì½”",               desc: "ë³„ì´ ë–¨ì–´ì§„ ìë¦¬ì˜ ë©”ì•„ë¦¬ê°€, ì£¼ë¬¸ì„ ë” ë©€ë¦¬ ë³´ë‚¸ë‹¤.",   img: "images/weapons/staff_13.png" },
  14: { name: "ì´í´ë¦½ìŠ¤ ì¹¸í‹°í´",           desc: "ì‹(è•)ì˜ ì„±ê°€ê°€ ìš¸ë¦´ ë•Œ, ë¹›ê³¼ ì–´ë‘ ì´ ê°™ì€ ê·œì¹™ìœ¼ë¡œ ì›€ì§ì¸ë‹¤.", img: "images/weapons/staff_14.png" },
  15: { name: "ì„¸í”¼ë¡œíŠ¸ ì„œí‚·",             desc: "ë§ˆë„ì˜ â€˜íšŒë¡œâ€™ê°€ ì™„ì„±ë˜ë©°, ì£¼ë¬¸ì´ í•œ ë‹¨ê³„ ì •êµí•´ì§„ë‹¤.",   img: "images/weapons/staff_15.png" },
  16: { name: "ì¸ë²„ìŠ¤ ë£°",                 desc: "ë²•ì¹™ì´ ê±°ê¾¸ë¡œ ì„œëŠ” ìˆœê°„, ë¶ˆê°€ëŠ¥ì´ ê°€ëŠ¥ì²˜ëŸ¼ êµ´ëŸ¬ê°„ë‹¤.",   img: "images/weapons/staff_16.png" },
  17: { name: "ì˜¤ë²¨ë¦¬ìŠ¤í¬ ë¦¬ì¹˜",           desc: "íƒ‘ì˜ ê¼­ëŒ€ê¸°ì— ë‹¿ëŠ” ì†. ì£¼ë¬¸ì˜ ì‚¬ê±°ë¦¬ê°€ ì•„ë‹Œ, ì„¸ê³„ì˜ ë†’ì´ë¥¼ ê²¨ëˆˆë‹¤.", img: "images/weapons/staff_17.png" },

  // ğŸŒ• 18~20ê°• : ë² íˆëª¨ìŠ¤ ì‚¬ëƒ¥í„° êµ¬ê°„
  18: { name: "ë² íˆëª¨ìŠ¤ ë°±ë³¸",             desc: "ê±°ìˆ˜ì˜ ì²™ì¶”ë¥¼ ë½‘ì•„ëƒˆë‹¤. ë§ˆë ¥ì€ ì´ì œ â€˜ì¬ë£Œâ€™ê°€ ì•„ë‹ˆë¼ â€˜ì „ë¦¬í’ˆâ€™ì´ë‹¤.", img: "images/weapons/staff_18.png" },
  19: { name: "ì–´ë¹„ìŠ¤ í’‹í”„ë¦°íŠ¸",           desc: "ì‹¬ì—°ì„ ë°Ÿì•˜ë˜ í”ì . ë˜ëŒì•„ì˜¬ìˆ˜ë¡ ì£¼ë¬¸ì€ ë” ì°¨ê°‘ê³  ì •í™•í•´ì§„ë‹¤.",     img: "images/weapons/staff_19.png" },
  20: { name: "ì´ë¸” ë¦¬í€´ì— ",               desc: "ì•…ì˜ ì¥ë¡€ê³¡. ì“°ëŸ¬ì§„ ê²ƒë“¤ì˜ ì´ë¦„ì´ ì£¼ë¬¸ì˜ í™”ìŒìœ¼ë¡œ ë‚¨ëŠ”ë‹¤.",         img: "images/weapons/staff_20.png" },

  // ğŸŒŸ 21~23ê°• : ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
  21: { name: "ì•„í¬ìœ™ì¦ˆ ë‹¤ìš´í´",           desc: "ë‚ ê°œê°€ êº¾ì¸ ìˆœê°„, ì„±ì—­ì€ ë” ì´ìƒ ì•ˆì „ì§€ëŒ€ê°€ ì•„ë‹ˆê²Œ ëœë‹¤.",           img: "images/weapons/staff_21.png" },
  22: { name: "ìƒ¤ì¸ë½ í”½ì»¤",               desc: "ë¹›ì˜ ìë¬¼ì‡ ë¥¼ â€˜ë”°ëŠ”â€™ ì†. ë‹«íŒ ê¸°ì ì„ ê°•ì œë¡œ ì—´ì–´ì –íŒë‹¤.",           img: "images/weapons/staff_22.png" },
  23: { name: "í”„ë ˆì´ í´ì•„ì›ƒ",             desc: "ê¸°ë„ê°€ ë¬´ë„ˆì ¸ ë‚´ë¦¬ë©°, ì‹ ì„±ì€ ì”í•´ì²˜ëŸ¼ ë–¨ì–´ì§„ë‹¤.",                     img: "images/weapons/staff_23.png" },

  // ğŸŒŸ 24~25ê°• : ì‹ ì˜ ì²˜ì†Œ
  24: { name: "ë„¤ì„ë¦¬ìŠ¤ ë””ë°”ì¸",           desc: "ì´ë¦„ ì—†ëŠ” ì‹ ì„±. ì‹ ì„ ì£½ì¸ ë’¤ì—ì•¼ â€˜í˜¸ì¹­â€™ì´ ì˜ë¯¸ ì—†ì–´ì§„ë‹¤.",           img: "images/weapons/staff_24.png" },
  25: { name: "ê°“ìŠ¬ë ˆì´ì–´ ì½”ë“œ",           desc: "ì‹ ì‚´ì˜ í•´ì„ì‹. â€˜ì£½ì¼ ìˆ˜ ìˆë‹¤â€™ëŠ” ì‚¬ì‹¤ì´ ê³§ ìƒˆë¡œìš´ ì£¼ë¬¸ì´ ëœë‹¤.",        img: "images/weapons/staff_25.png" },

  // ğŸŒˆ 26~29ê°• : ì´ˆì›” â€” ìƒˆë¡œìš´ ì—ë„ˆì§€ ë²•ì¹™ì˜ íƒ„ìƒ
  26: { name: "í”„ë¼ì„ ìŠ¤íŒŒí¬",             desc: "ì²« ë¶ˆê½ƒ. ì—ë„ˆì§€ëŠ” ë” ì´ìƒ â€˜ì†Œëª¨â€™ê°€ ì•„ë‹ˆë¼ â€˜ë°œìƒâ€™ìœ¼ë¡œ ë°”ë€ë‹¤.",         img: "images/weapons/staff_26.png" },
  27: { name: "ì´í„°ë„ ë¸Œë ˆì“°",             desc: "ëë‚˜ì§€ ì•ŠëŠ” ìˆ¨ê²°. ì£¼ë¬¸ì´ ëŠê¸°ì§€ ì•Šê³ , ì„¸ê³„ì— ë‚¨ì•„ ìˆœí™˜í•œë‹¤.",          img: "images/weapons/staff_27.png" },
  28: { name: "ë£¨ë©˜ í”„ë ˆì„",               desc: "ë¹›ì˜ ê³¨ê²©. ë§ˆë ¥ì€ í˜•íƒœë¥¼ ê°–ê³ , í˜•íƒœëŠ” ê³§ ê·œì¹™ì´ ëœë‹¤.",                img: "images/weapons/staff_28.png" },
  29: { name: "ì˜¤ë¡œë¼ ë² ì¸",               desc: "ì˜¤ë¡œë¼ì˜ í˜ˆê´€. í•˜ëŠ˜ì˜ íë¦„ì´ ì†ëìœ¼ë¡œ ì—°ê²°ëœë‹¤.",                      img: "images/weapons/staff_29.png" },

  // ğŸŒˆ 30ê°• : ìµœì¢…
  30: { name: "íƒœê³ ì˜ ì—ë„ˆì§€ ã€Œì•„ë¥´ì¹´ë‚˜ã€", desc: "ë§ˆë²•ì´ ì•„ë‹ˆë‹¤ â€” ì—ë„ˆì§€ì˜ ì›í˜•(åŸå½¢) ê·¸ ìì²´ë¡œ ì¡´ì¬í•œë‹¤.",             img: "images/weapons/staff_30.png" }
};

  // ğŸ—¡ï¸ ë‹¨ê²€(ì•”ì‚´ì/ì–´ë‘ )
const WEAPON_INFO_DAGGER = {
  0: { name: "ì œë ¨ë˜ì§€ ì•Šì€ ê¸ˆì†ê´´", desc: "ì•„ì§ ì•„ë¬´ê²ƒë„ ë˜ì§€ ëª»í–ˆì§€ë§Œ, ì„¸ìƒ ì–´ë””ì—ë„ ì—†ëŠ” ê°€ëŠ¥ì„±ì„ ì¡°ìš©íˆ í’ˆê³  ìˆë‹¤.", img: "images/weapons/sword_00.png" },

  1:  { name: "ë¶€ëŸ¬ì§„ ë‹¨ê²€", desc: "ëì´ ë¶€ëŸ¬ì§„ ë‹¨ê²€. ê¸‰ì†Œë¥¼ ë…¸ë¦¬ê¸°ì—” ë¶ˆì•ˆì •í•˜ë‹¤.", img: "images/weapons/dagger_01.png" },
  2:  { name: "ê¸ˆì´ ê°„ ë‹¨ê²€", desc: "ì¹¼ë‚ ì— ì‹¤ê¸ˆì´ í¼ì ¸ ìˆë‹¤. ë‹¤ìŒ ì¶©ê²©ì´ ë§ˆì§€ë§‰ì¼ì§€ë„ ëª¨ë¥¸ë‹¤.", img: "images/weapons/dagger_02.png" },
  3:  { name: "ë…¹ìŠ¨ ë‹¨ê²€", desc: "ì˜¤ë˜ ë°©ì¹˜ëœ ë‹¨ê²€. ì‡  ëƒ„ìƒˆê°€ ë¨¼ì € ë‚œë‹¤.", img: "images/weapons/dagger_03.png" },
  4:  { name: "ë¬´ë”˜ ë‹¨ê²€", desc: "ë‚ ì´ ì£½ì–´ ìˆë‹¤. ì •í™•í•˜ì§€ ì•Šìœ¼ë©´ ëë‚˜ì§€ ì•ŠëŠ”ë‹¤.", img: "images/weapons/dagger_04.png" },
  5:  { name: "í”¼ê°€ êµ³ì€ ë‹¨ê²€", desc: "ì˜¤ë˜ëœ í•ìêµ­ì´ ë‚ ì— ì—‰ê²¨ ë¶™ì–´ ìˆë‹¤.", img: "images/weapons/dagger_05.png" },

  6:  { name: "ìˆ˜ë¦¬ëœ ë‹¨ê²€", desc: "ê¸ˆì„ ë©”ìš°ê³  ë‹¤ì‹œ ë²¼ë ¤ë‚¸ ë‹¨ê²€.", img: "images/weapons/dagger_06.png" },
  7:  { name: "ì˜ ë²¼ë¦° ë‹¨ê²€", desc: "ì§§ì§€ë§Œ ë‹¨ë‹¨í•œ ë‚ .", img: "images/weapons/dagger_07.png" },
  8:  { name: "ê· í˜• ì¡íŒ ë‹¨ê²€", desc: "ì†ëì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒì•„ë‚˜ê°„ë‹¤.", img: "images/weapons/dagger_08.png" },
  9:  { name: "ì†Œë¦¬ ì£½ì¸ ë‹¨ê²€", desc: "ë½‘íˆëŠ” ì†Œë¦¬ì¡°ì°¨ ê±°ì˜ ì—†ë‹¤.", img: "images/weapons/dagger_09.png" },
  10: { name: "ë§¤ë³µìì˜ ë‹¨ê²€", desc: "ì‹¸ìš°ê¸° ìœ„í•œ ë¬´ê¸°ê°€ ì•„ë‹ˆë‹¤. ì€ë°€í•˜ê²Œ ìƒëŒ€ë¥¼ ì œê±°í•˜ëŠ” ë„êµ¬ì¼ë¿.", img: "images/weapons/dagger_10.png" },

  11: { name: "ê·¸ë¦¼ì ì†ì¡ì´", desc: "ì¥ëŠ” ìˆœê°„, ì†ì´ ì–´ë‘ ì— ì ê¸´ë‹¤.", img: "images/weapons/dagger_11.png" },
  12: { name: "ê²€ì€ ì‹¤", desc: "ë² ê³  ë‚œ ìë¦¬ì—” ê²€ì€ ì‹¤ê°™ì€ ì—¬ë°±ë§Œ ë‚¨ì„ ë¿.", img: "images/weapons/dagger_12.png" },
  13: { name: "ë’·ê³¨ëª©ì˜ ë§¹ì„¸", desc: "ë§ë¡œ ë‚¨ê¸°ì§€ ì•ŠëŠ” ì•½ì†.", img: "images/weapons/dagger_13.png" },
  14: { name: "ìŠí˜€ì§„ ì´ë¦„", desc: "ëˆ„ê°€ ì¥ì—ˆëŠ”ì§€ ê¸°ë¡ì´ ì—†ë‹¤. ì´ ê²€ì„ ì•„ëŠ” ì„¸ìƒì— ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ.", img: "images/weapons/dagger_14.png" },
  15: { name: "å½±(ì˜)", desc: "ë¹›ì˜ ë’¤ì— ë¶™ëŠ”ë‹¤.", img: "images/weapons/dagger_15.png" },

  16: { name: "ì‚¬ì¼ëŸ°íŠ¸ ë”œ", desc: "ê±°ë˜ëŠ” ëë‚¬ë‹¤. ì†Œë¦¬ ì—†ì´.", img: "images/weapons/dagger_16.png" },
  17: { name: "ì•¼í–‰ìì˜ ì´ë¹¨", desc: "ë°¤ì—ë§Œ ì„ ëª…í•´ì§€ëŠ” ë‚ .", img: "images/weapons/dagger_17.png" },
  18: { name: "ì¬ì˜ ì²¨ë‹¨", desc: "ë¶ˆê¸¸ ë§ˆì € ê°ˆë¼ë‚´ì–´ ì¬ë¥¼ ë‚¨ê¸´ë‹¤.", img: "images/weapons/dagger_18.png" },
  19: { name: "ìš©ê´‘ì˜ ì†¡ê³³", desc: "ê°•ì² ìš©ì˜ ë¹„ëŠ˜ì„ ëš«ì–´ë‚¸ ê²€.", img: "images/weapons/dagger_19.png" },
  20: { name: "ì¸í˜ë¥´ë…¸ ìŠ¤íŒ…ì–´", desc: "ê±°ëŒ€í•œ ê´´ìˆ˜ëŠ” í•œ ìˆœê°„ìœ¼ë¡œ ë¬´ë„ˆì¡Œë‹¤.", img: "images/weapons/dagger_20.png" },

  21: { name: "ë´‰ì¸ ì™¸ê³½", desc: "ë‹¿ì§€ ì•Šì•„ë„ ëœë‹¤. ë°”ê¹¥ì—ì„œë¶€í„° ì´ë¯¸ ê· ì—´ì´ ì‹œì‘ëœë‹¤.", img: "images/weapons/dagger_21.png" },
  22: { name: "è–åŸŸç ´(ì„±ì—­íŒŒ)", desc: "ê·¸ ë‹¨ê²€ ì•ì—ì„ , ì„±ì—­ì´ ì•ˆì „í•˜ë‹¤ëŠ” ë¯¿ìŒë„ ê¹¨ì§„ë‹¤.", img: "images/weapons/dagger_22.png" },
  23: { name: "ì„±ìŒ ë‹¨ì ˆ", desc: "ìœ„ë¡œ ë‹¿ë˜ ì†Œë¦¬ì¡°ì°¨ ë² ì–´ëƒˆë‹¤. ì‘ë‹µì€ ë” ì´ìƒ ë‚´ë ¤ì˜¤ì§€ ì•ŠëŠ”ë‹¤.", img: "images/weapons/dagger_23.png" },
  24: { name: "ì‹ ì¢Œì˜ ì‚¬ê°", desc: "ê·¸ ì–´ë‘ ì€ ì‹ ì—ê²Œë„ ê·¸ë¦¼ìë¥¼ ë§Œë“¤ì–´ë‚¸ë‹¤.", img: "images/weapons/dagger_24.png" },

  25: { name: "ëì„ ", desc: "ë² ì–´ë‚´ëŠ” í–‰ìœ„ê°€ ì•„ë‹Œ, ëì„ ë‚´ëŠ” í–‰ìœ„ë¡œ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.", img: "images/weapons/dagger_25.png" },
  26: { name: "ê²°(çµ)", desc: "ë¬¼ì§ˆë§Œ ë² ì–´ë‚¼ ë¿ ì•„ë‹Œ, ê°œë…ë§ˆì € ëŠì–´ë‚´ë‹¤.", img: "images/weapons/dagger_26.png" },
  27: { name: "æ–·ç•Œ(ë‹¨ê³„)", desc: "ì„¸ê³„ê°€ ì´ì–´ì§€ëŠ” ê²½ê³„ë¥¼ ê¸‹ë‹¤.", img: "images/weapons/dagger_27.png" },
  28: { name: "ë¸”ë™ì•„ì›ƒ", desc: "ë¹›ì„ ë² ì–´ë‚´ ëª¨ë“  ê°ê°ì´ êº¼íŠ¸ë¦°ë‹¤.", img: "images/weapons/dagger_28.png" },
  29: { name: "ç„¡(ë¬´)", desc: "ë² ì–´ëƒ„ìœ¼ë¡œì¨ ì¡´ì¬ê°€ ì‚¬ë¼ì§„ ìë¦¬.", img: "images/weapons/dagger_29.png" },

  // ğŸŒˆ 30ê°• : ìµœì¢…
  30: { name: "ì–´ë‘ ì˜ ê³„ìœ¨ ã€Œë…¹ìŠ¤(Nox)ã€", desc: "íƒœê³ ì˜ ì–´ë‘ .\nì´ ì´ë¦„ì€ ê³§ ì–´ë‘ ì˜ ë²•ì¹™ì´ë‹¤.", img: "images/weapons/dagger_30.png" }
};

// í˜„ì¬ ê°•í™” ìˆ˜ì¹˜ & íƒ€ì… ê¸°ì¤€ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
function getWeaponInfo(level, type) {
  const lv = Math.max(0, Math.min(30, level | 0));

  // ìš°ì„ ìˆœìœ„: ì „ë‹¬ëœ type > ì „ì—­ weaponType > ê¸°ë³¸ "sword"
  const t = type || weaponType || "sword";

  if (t === "spear") {
    return WEAPON_INFO_SPEAR[lv] || WEAPON_INFO_SPEAR[0];
  }

  if (t === "axe") {
    return WEAPON_INFO_AXE[lv] || WEAPON_INFO_AXE[0];
  }

  if (t === "bow") {
    return WEAPON_INFO_BOW[lv] || WEAPON_INFO_BOW[0];
  }

  if (t === "staff") {
    return WEAPON_INFO_STAFF[lv] || WEAPON_INFO_STAFF[0];
  }

  if (t === "dagger") {
  return WEAPON_INFO_DAGGER[lv] || WEAPON_INFO_DAGGER[0];
}

  // ê¸°ë³¸: ê²€
  return WEAPON_INFO[lv] || WEAPON_INFO[0];
}

// 0ê°•ì—ì„œ ì²˜ìŒ ë¬´ê¸°ê°€ ìƒê¸¸ ë•Œ, íƒ€ì…(ê²€/ì°½/ë„ë¼) ëœë¤ í™•ì •
function ensureWeaponTypeAfterUpgrade(beforeLevel, afterLevel) {
  if (beforeLevel <= 0 && afterLevel >= 1) {
    if (!weaponType) {
      const types = ["sword", "spear", "axe", "bow", "staff", "dagger"];
      const idx = Math.floor(Math.random() * types.length);
      weaponType = types[idx];
    }
  }
}

// ì´ë¯¸ì§€ êµì²´ í•¨ìˆ˜
function updateWeaponImage() {
  const info = getWeaponInfo(sword, weaponType);
  const imgEl = document.getElementById("weaponImage");
  if (!imgEl) return;

  imgEl.src = info.img;
  imgEl.alt = info.name;
}

  /* ================= ë¬´ê¸° ì„±ê³µ/ì‹¤íŒ¨ ì´í™íŠ¸(íŒŒí¸/ì—°ê¸°/ì‚¬ìš´ë“œ) ================= */

function getWeaponFxLayer(){
  return document.getElementById("weaponFxLayer");
}

function clearWeaponFx(){
  const layer = getWeaponFxLayer();
  if (!layer) return;
  layer.innerHTML = "";
}

/** âœ… ì„±ê³µ: í° íŒŒí¸(ìƒ¤ë“œ) íŠ€ê¸°ê¸° */
function spawnWeaponShards(count = 18){
  const layer = getWeaponFxLayer();
  if (!layer) return;

  clearWeaponFx();

  for (let i = 0; i < count; i++){
    const d = document.createElement("div");
    d.className = "weapon-shard";

    // ë°©í–¥/ê±°ë¦¬ ëœë¤
    const ang = Math.random() * Math.PI * 2;
    const dist = 70 + Math.random() * 120; // í¼ì§ ê±°ë¦¬
    const dx = Math.cos(ang) * dist;
    const dy = Math.sin(ang) * dist;

    // íšŒì „/ì§€ì—° ëœë¤
    const rot = (Math.random() * 360) + "deg";
    d.style.setProperty("--dx", dx.toFixed(1) + "px");
    d.style.setProperty("--dy", dy.toFixed(1) + "px");
    d.style.setProperty("--r", rot);
    d.style.animationDelay = (Math.random() * 60).toFixed(0) + "ms";

    // í¬ê¸°ë„ ì‚´ì§ ëœë¤
    const w = 8 + Math.random() * 14;
    const h = 2 + Math.random() * 4;
    d.style.width = w.toFixed(1) + "px";
    d.style.height = h.toFixed(1) + "px";

    layer.appendChild(d);
  }

  // ì• ë‹ˆë©”ì´ì…˜ ëë‚˜ë©´ ì •ë¦¬
  setTimeout(() => clearWeaponFx(), 900);
}

/** âœ… ì‹¤íŒ¨: ê²€ì€ ì—°ê¸° (íŒŒê´´ë©´ ë” í¬ê²Œ) */
function spawnWeaponSmoke(intensity = 1){
  const layer = getWeaponFxLayer();
  if (!layer) return;

  clearWeaponFx();

  const base = (intensity >= 2) ? 10 : 7;
  for (let i = 0; i < base; i++){
    const s = document.createElement("div");
    s.className = "weapon-smoke";

    const sx = (-40 + Math.random() * 80);     // ì¢Œìš° í¼ì§
    const sy = (60 + Math.random() * 90);      // ìœ„ë¡œ ìƒìŠ¹ëŸ‰
    s.style.setProperty("--sx", sx.toFixed(0) + "px");
    s.style.setProperty("--sy", sy.toFixed(0) + "px");
    s.style.animationDelay = (Math.random() * 80).toFixed(0) + "ms";

    // íŒŒê´´ë©´ ì—°ê¸° í¬ê¸°/ì§„í•¨ ì—…
    if (intensity >= 2){
      s.style.width  = (28 + Math.random() * 18).toFixed(0) + "px";
      s.style.height = s.style.width;
      s.style.filter = "blur(0.6px)";
    }

    layer.appendChild(s);
  }

  setTimeout(() => clearWeaponFx(), 1100);
}

/* ---------- SFX: ê¸ˆì† íŒŒì—´ìŒ(ì›¹ ì˜¤ë””ì˜¤, íŒŒì¼ ì—†ì´ êµ¬í˜„) ---------- */

let _fxAudioCtx = null;
function getFxAudioCtx(){
  try {
    if (!_fxAudioCtx) _fxAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ìë™ì¬ìƒ ì œí•œ ë•Œë¬¸ì— suspendedì¼ ìˆ˜ ìˆìŒ
    if (_fxAudioCtx.state === "suspended") _fxAudioCtx.resume().catch(()=>{});
    return _fxAudioCtx;
  } catch (e) {
    return null;
  }
}

// âœ… ê³µí†µ íš¨ê³¼ìŒ ì¬ìƒ í—¬í¼ (mp3)
// (Effect ì„¤ì • ì¦‰ì‹œ ë°˜ì˜: ì¬ìƒí•  ë•Œë§ˆë‹¤ getSfxScale()ë¡œ ë³¼ë¥¨ ê³„ì‚°)
function playSfx(src, baseVol=1.0){
  try{
    const a = new Audio(src);
    a.preload = "auto";
    a.volume = Math.max(0, Math.min(1, baseVol * getSfxScale()));
    a.currentTime = 0;

    const p = a.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
    return a;
  }catch(e){
    return null;
  }
}
  
// âœ… ê°•í™” ì„±ê³µ SFX
function playShardSfx(){
  playSfx("sounds/sfx_upgrade_success.mp3", 0.9);
}

/** âœ… ì‹¤íŒ¨: ê¸ˆì† íŒŒì—´ìŒ(ë…¸ì´ì¦ˆ + ì €ì£¼íŒŒ í€ì¹˜) */
function playMetalCrackSfx(){
  const ctx = getFxAudioCtx();
  if (!ctx) return;

  const t = ctx.currentTime;

  // noise burst
  const bufferSize = Math.floor(ctx.sampleRate * 0.12);
  const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i=0;i<bufferSize;i++){
    // ì•ë¶€ë¶„ì€ ê°•í•˜ê²Œ, ë’¤ë¡œ ê°ˆìˆ˜ë¡ ì•½í•˜ê²Œ
    const k = 1 - (i / bufferSize);
    data[i] = (Math.random()*2-1) * (k*k);
  }
  const noise = ctx.createBufferSource();
  noise.buffer = buffer;

  const nFilter = ctx.createBiquadFilter();
  nFilter.type = "highpass";
  nFilter.frequency.setValueAtTime(600, t);

  const nGain = ctx.createGain();
  nGain.gain.setValueAtTime(0.0001, t);
  nGain.gain.exponentialRampToValueAtTime(0.35, t + 0.01);
  nGain.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);

  noise.connect(nFilter).connect(nGain).connect(ctx.destination);
  noise.start(t);
  noise.stop(t + 0.13);

  // low punch
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = "sine";
  o.frequency.setValueAtTime(140, t);
  o.frequency.exponentialRampToValueAtTime(70, t + 0.12);

  g.gain.setValueAtTime(0.0001, t);
  g.gain.exponentialRampToValueAtTime(0.22, t + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t + 0.14);

  o.connect(g).connect(ctx.destination);
  o.start(t);
  o.stop(t + 0.15);
}

function playEngraveSound(delayMs = 1000){
  try {
    setTimeout(() => {
      const sfx = new Audio("sounds/sfx_engrave_roll.mp3");
      sfx.volume = 0.8;
      sfx.play();
    }, delayMs);
  } catch (e) {}
}

  
/* ìƒíƒœ */
let sword = 0, power = 10, gold = 100;
let userId="", userPassword="", userRef=null;
let attendanceCount = 0;
let lastAttendanceDate = "";
let attendanceStreak = 0;     // ì—°ì† ì¶œì„ ìˆ˜
let lastAttendanceDay = "";   // ë§ˆì§€ë§‰ ì¶œì„ ë‚ ì§œ (streak ì „ìš©)
let maxSwordLevel = 0;   // ê³„ì • ì „ì²´ ìµœê³  ê°•í™” ê¸°ë¡
let destroyCount  = 0;   // ê³„ì • ì „ì²´ ëˆ„ì  íŒŒê´´ íšŸìˆ˜
let currentSessionId = null;   // ğŸ” ì´ ë¸Œë¼ìš°ì € íƒ­ì˜ ì„¸ì…˜ ID
let duelPointWeekKey = "";           // í˜„ì¬ ë‚´ê°€ í”Œë ˆì´ ì¤‘ì¸ ì£¼(ì›”ìš”ì¼ ê¸°ì¤€)
let duelLastWeekPoint = 0;           // ì§€ë‚œì£¼ ë‚´ê°€ ëª¨ì•˜ë˜ ê²°íˆ¬ í¬ì¸íŠ¸
let duelLastWeekRank  = 0;           // ì§€ë‚œì£¼ ë‚´ ë­í‚¹ (0ì´ë©´ ê¸°ë¡ ì—†ìŒ)
let duelLastWeekRewardClaimed = false; // ì§€ë‚œì£¼ ë³´ìƒ ì´ë¯¸ ë°›ì•˜ëŠ”ì§€ ì—¬ë¶€
let duelUpdated = 0;          // ì´ë²ˆ ì£¼ ê²°íˆ¬ í¬ì¸íŠ¸ê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ë°”ë€ ì‹œê°
let duelLastWeekUpdated = 0;  // ì§€ë‚œì£¼ ê²°íˆ¬ í¬ì¸íŠ¸ ìµœì¢… ê¸°ë¡ ì‹œê°  
let weaponType = null; 
// null: ì•„ì§ ë¯¸ë°°ì •(0ê°•) / "sword": ê²€ / "spear": ì°½ / "axe": ë„ë¼ / "bow": í™œ / "staff": ìŠ¤íƒœí”„
// âœ… ê°ì¸ í”„ë¦¬ì…‹(1~3)
// - engravePresets[engravePresetIdx] ê°€ "í˜„ì¬ ì ìš© í”„ë¦¬ì…‹"ì´ê³ 
// - engraveLines ëŠ” ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš©ìœ¼ë¡œ "í˜„ì¬ í”„ë¦¬ì…‹ 3ì¤„"ì„ ê°€ë¦¬í‚´
let engravePresetIdx = 0; // 0=Preset1, 1=Preset2, 2=Preset3
let engravePresets = [
  ["-","-","-"],
  ["-","-","-"],
  ["-","-","-"]
];

// âœ… (í˜¸í™˜) ê¸°ì¡´ ì½”ë“œë“¤ì´ engraveLines ë¥¼ ë§ì´ ì“°ë‹ˆê¹Œ ìœ ì§€
let engraveLines = engravePresets[engravePresetIdx];

// âœ… í”„ë¦¬ì…‹/ë¼ì¸ ëª¨ì–‘ ë³´ì • + engraveLines ë™ê¸°í™”
function ensureEngravePresetShape(){
  if (!Array.isArray(engravePresets)) engravePresets = [];
  for (let i = 0; i < 3; i++){
    if (!Array.isArray(engravePresets[i])) engravePresets[i] = ["-","-","-"];
    engravePresets[i] = [
      engravePresets[i][0] || "-",
      engravePresets[i][1] || "-",
      engravePresets[i][2] || "-"
    ];
  }
  if (![0,1,2].includes(Number(engravePresetIdx))) engravePresetIdx = 0;
  engraveLines = engravePresets[engravePresetIdx];
}

// âœ… â€œí˜„ì¬ í”„ë¦¬ì…‹â€ì˜ ê°ì¸ 3ì¤„ì„ ì„¸íŒ…(= ê¸°ì¡´ engraveLines = ... ëŒ€ì²´ìš©)
function setActiveEngraveLines(lines){
  ensureEngravePresetShape();
  const arr = [
    (lines && lines[0]) ? lines[0] : "-",
    (lines && lines[1]) ? lines[1] : "-",
    (lines && lines[2]) ? lines[2] : "-"
  ];
  engravePresets[engravePresetIdx] = arr;
  engraveLines = engravePresets[engravePresetIdx];
}

let isUpgrading = false; 
let isDueling   = false;   // âš”ï¸ ê²°íˆ¬ VS ëŒ€ê¸°ì¤‘ì¼ ë•Œ true
let titlesOwned = {};     // { titleId: true }
let equippedTitle = "";   // ì¥ì°©ì¤‘ ì¹­í˜¸ ID
let lastSeenGlobal30EventId = 0;  // ë§ˆì§€ë§‰ìœ¼ë¡œ ë³¸ +30 ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ ID
let aweUsedGlobal30EventId = 0;   // ë§ˆì§€ë§‰ìœ¼ë¡œ â€˜ê²½ì™¸í•˜ê¸°â€™ë¥¼ ì‚¬ìš©í•œ +30 ì´ë²¤íŠ¸ ID (1ì¸ 1íšŒ)
let pendingLoginData = null;
let pendingLoginUserId = null;

// ğŸ§­ ì‚¬ëƒ¥í„° ì´ë™ ì¤‘ì¸ì§€ ì—¬ë¶€
let isMoving = false;

// â­ ì£¼ê°„ ê²°íˆ¬ ì‹œìŠ¤í…œ
let currentWeekKey = "";
  
// âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ìƒíƒœ
let duelWin = 0;                  // ìŠ¹ ìˆ˜
let duelLose = 0;                 // íŒ¨ ìˆ˜
let duelCountToday = 0;           // ì˜¤ëŠ˜ ê²°íˆ¬í•œ ì´ íšŸìˆ˜ (ëª¨ë“  ìƒëŒ€ í•©ì‚°)
let lastDuelDate = "";            // ë§ˆì§€ë§‰ ê²°íˆ¬ ë‚ ì§œ (YYYY-MM-DD)
// ì˜¤ëŠ˜ ê°™ì€ ìƒëŒ€ì—ê²Œ ëª‡ ë²ˆ ë„ì „í–ˆëŠ”ì§€: { ìƒëŒ€ì•„ì´ë””: íšŸìˆ˜ }
let duelTargetsToday = {};
// ğŸ·ï¸ ê²°íˆ¬ ì—…ì  ì¹´ìš´íŠ¸
let bully10Count = 0;        // ê°•ì•½ì•½ê°•: ì•½í•œ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ 10íšŒ
let challenger10Count = 0;   // ë„ì „ì: ê°•í•œ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ ìŠ¹ë¦¬ 10íšŒ
let brawl500Count = 0;       // ì‹¸ì›€ê¾¼: ê²°íˆ¬ ëˆ„ì  500íšŒ
let warGodWin = false;       // íˆ¬ì‹ : +4ê°• ì´ìƒ ë†’ì€ ìƒëŒ€ì—ê²Œ ìŠ¹ë¦¬ 1íšŒ

let couponUsedMap = {};   // ì‚¬ìš© ì™„ë£Œí•œ ì¿ í°ì½”ë“œ ê¸°ë¡ { CODE: true }

// ğŸ”” ì—…ë°ì´íŠ¸ ê³µì§€ ìƒíƒœ
let updateNotices = [];       // {id, title, content, createdAt} ë°°ì—´
let currentNoticeIndex = 0;   // íŒì—…ì—ì„œ í˜„ì¬ ë³´ê³  ìˆëŠ” ì¸ë±ìŠ¤
  
// ğŸ… ëª…ì˜ˆì˜ í›ˆì¥ (ê²°íˆ¬ ë³´ìƒ ì¬í™”)
let itemHonorMedal = 0;

// â­ ê²°íˆ¬ í¬ì¸íŠ¸ (ê²°íˆ¬ì¥ ë­í‚¹ì— ì“°ì¼ ê°’)
let duelPoint = 0;
  
// ì „ì²´ ìœ ì € ëª©ë¡ ìºì‹œ (ê²°íˆ¬ ê²€ìƒ‰/ëœë¤ë§¤ì¹­ìš©)
let allUsersCache = [];
// â­ updated ê°±ì‹ ì— ì‚¬ìš©í•  ë§ˆì§€ë§‰ ì €ì¥ëœ ê°•í™”ê°’
let lastSavedSwordForUpdated = 0;
  // ğŸ—º ì‚¬ëƒ¥ ê´€ë ¨ ìƒíƒœ
let currentField = 0;          // 1~10 ì‚¬ëƒ¥í„°
let huntCountToday = 0;        // ì˜¤ëŠ˜ ì‚¬ëƒ¥ íšŸìˆ˜
let lastHuntDate = "";         // ë§ˆì§€ë§‰ ì‚¬ëƒ¥ ë‚ ì§œ (YYYY-MM-DD)
let plagueRatHuntCount = 0; // ğŸ¦  2ë ˆë²¨ ì‚¬ëƒ¥í„°(ì‹œê¶ì°½) ì‚¬ëƒ¥ ëˆ„ì  ì¹´ìš´íŠ¸
let superSuccessCount = 0; // ìŠˆí¼ê°•í™” ì„±ê³µ ëˆ„ì 
let downStreak = 0;        // ê°•ë“± ì—°ì† íšŸìˆ˜
let dopamineTried = 0;     // 25ê°•+ì—ì„œ íŒŒê´´ë°©ì§€ ì—†ì´ ê°•í™” ì‹œë„(1íšŒë©´ ì—…ì )

  // âœ… ìŠ¹ë¶€ì‚¬(21~24 ë¬´ì£¼ë¬¸ì„œ ëŸ°) ì¶”ì 
let gamblerRunActive = false;   // 21ê°• ì´ìƒ êµ¬ê°„ ì§„ì… ì—¬ë¶€
let gamblerRunNoScroll = true;  // 21ê°• ì´í›„ ì£¼ë¬¸ì„œ/ìŠ¤í¬ë¡¤ â€œí•œ ë²ˆë„â€ ì•ˆ ì¼ëŠ”ì§€

// âœ… í­ì£½ë†€ì´(21~25 íŒŒê´´ ì²´í¬)
let fireworksDestroyed = { 21:false, 22:false, 23:false, 24:false, 25:false };

// âœ… 30ê°• ë‹¬ì„± íšŸìˆ˜(ì „ì²´/ë¬´ê¸°ë³„)
let reach30Count = 0;           // 30ê°• ë‹¬ì„± ëˆ„ì (ë¬´ê¸° ìƒê´€ì—†ì´)
let weapon30Counts = {};        // { sword:0, axe:0, spear:0, bow:0 } í˜•íƒœë¡œ ì €ì¥

  // ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹(30ê°• ë„ë‹¬ í›„ 72ì‹œê°„ ì¹´ìš´íŠ¸)
let hofDeadline = 0;          // ê°•ì œ ì „ë‹¹í–‰ ë§Œë£Œì‹œê°(ms)
let hofAchievedAt = 0;        // 30ê°• ë‹¬ì„± ì‹œê°(ms)
let hofWeaponTypeAt30 = "";   // 30ê°• ë‹¬ì„± ë‹¹ì‹œ ë¬´ê¸° íƒ€ì…
let hofProcessedAt = 0;       // ì „ë‹¹í–‰ ì²˜ë¦¬ ì™„ë£Œ ì‹œê°(ms) (ì¤‘ë³µë°©ì§€)

// ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜
let huntStamina = 20;          // í˜„ì¬ ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ (0~20)
let lastStaminaUpdate = 0;     // ë§ˆì§€ë§‰ ìŠ¤íƒœë¯¸ë‚˜ ê°±ì‹  ì‹œê° (ms timestamp)

  // ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ ìµœëŒ€ì¹˜ (ê¸°ë³¸ 20 + ë§ˆë²•ì‚¬ íŒ¨ì‹œë¸Œ)
function getHuntStaminaMax() {
  const base = 20;

  let plus = 0;
  try {
    // getPlayerFinalCombatStats() ì•ˆì—ì„œ ë§ˆë²•ì‚¬ íŒ¨ì‹œë¸Œë¡œ huntMaxPlus ë¥¼ ë§Œë“¤ê³  ìˆìŒ
    const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
    plus = Number(st && st.huntMaxPlus ? st.huntMaxPlus : 0);
  } catch (e) {
    plus = 0;
  }

  return base + Math.max(0, plus);
}

// ğŸ†• 25ê°• ì´ìƒ ê°•í™” ê²½ê³  ì•ˆë‚´ í‘œì‹œ ì—¬ë¶€ (ì„¸ì…˜ ê¸°ì¤€ 1íšŒ)
let hasSeen25Warning = false;
let ignoreNextUpgradeWarning = false;

let activeBossId = "";
   
// ğŸ§® ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ ê³„ì‚° (ë¦¬ì…‹ + íšŒë³µ ì²˜ë¦¬)
function recalcHuntStamina() {
  const now = Date.now();
  const today = getTodayDateString();
  const max = getHuntStaminaMax();

  // ìµœì´ˆ í˜¸ì¶œ ì‹œ ì´ˆê¸°í™”
  if (!lastStaminaUpdate) {
    lastStaminaUpdate = now;
  }

  // í˜¹ì‹œ ì €ì¥ëœ ê°’ì´ maxë¥¼ ë„˜ìœ¼ë©´ í´ë¨í”„
  if (huntStamina > max) huntStamina = max;

  // ğŸ” ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë©´ 00ì‹œì— í’€ íšŒë³µ (maxê°œ)
  if (lastHuntDate !== today) {
    lastHuntDate      = today;
    huntStamina       = max;
    lastStaminaUpdate = now;
    huntCountToday    = 0;
    return;
  }

  // ì´ë¯¸ ê°€ë“ ì°¨ ìˆìœ¼ë©´ ë” íšŒë³µ X
  if (huntStamina >= max) return;

    let intervalMin = 20; // ê¸°ë³¸ 20ë¶„
  try {
    const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
    intervalMin = 20 - Math.max(0, Number(st && st.huntRechargeMinusMin ? st.huntRechargeMinusMin : 0));
  } catch (e) {}

  intervalMin = Math.max(1, intervalMin); // ìµœì†Œ 1ë¶„(ì›í•˜ë©´ 5ë¡œ ë°”ê¿”ë„ ë¨)
  const intervalMs = intervalMin * 60 * 1000;
  const elapsed    = now - lastStaminaUpdate;
  if (elapsed <= 0) return;

  // ì§€ë‚œ ì‹œê°„ ë™ì•ˆ íšŒë³µ ê°€ëŠ¥í•œ ê°œìˆ˜
  const gained = Math.floor(elapsed / intervalMs);
  if (gained <= 0) return;

  huntStamina = Math.min(max, huntStamina + gained);

  // ë§ˆì§€ë§‰ íšŒë³µ ê¸°ì¤€ ì‹œê° ì•ìœ¼ë¡œ ë‹¹ê²¨ì£¼ê¸°
  lastStaminaUpdate += gained * intervalMs;

  // ì°¸ê³ ìš©: ì˜¤ëŠ˜ ì‚¬ìš©í•œ íšŸìˆ˜ = max - ë‚¨ì€ ìŠ¤íƒœë¯¸ë‚˜
  huntCountToday = Math.max(0, max - huntStamina);
}

  // ğŸ’° ì‚¬ëƒ¥ ë²„íŠ¼ ìœ„ë¡œ ë™ì „ ì´ëª¨ì§€ íŠ€ëŠ” ì´í™íŠ¸
function spawnHuntCoinPop() {
  const btn = document.getElementById("huntBtn");
  if (!btn) return;

  const r = btn.getBoundingClientRect();

  const x = r.left + r.width / 2;
  const y = r.top + 6;

  // ğŸ’° 1~3ê°œ ëœë¤ ìƒì„±
  const n = 1 + Math.floor(Math.random() * 3);

  for (let i = 0; i < n; i++) {
    const el = document.createElement("div");
    el.className = "hunt-coin-pop";
    el.textContent = "ğŸ’°";

    // ì‚´ì§ í©ì–´ì§€ê²Œ ìœ„ì¹˜ ëœë¤
    el.style.left = `${x + (Math.random() * 16 - 8)}px`;
    el.style.top  = `${y + (Math.random() * 6 - 3)}px`;

    // ì—°ì†ìœ¼ë¡œ íŠ€ëŠ” ëŠë‚Œ
    el.style.animationDelay = `${i * 60}ms`;

    document.body.appendChild(el);

    setTimeout(() => {
      if (el && el.parentNode) el.parentNode.removeChild(el);
    }, 900);
  }
}

// ğŸ§­ ì‚¬ëƒ¥ UIë§Œ ê°±ì‹  (ë²„íŠ¼ í…ìŠ¤íŠ¸ + ë‚¨ì€ ì‹œê°„ í‘œì‹œ)
function updateHuntUI() {
  const huntBtnEl  = document.getElementById("huntBtn");
  const huntInfoEl = document.getElementById("huntInfo");
  if (!huntBtnEl || !huntInfoEl) return;

  // ë§¤ë²ˆ ë¶€ë¥¼ ë•Œë§ˆë‹¤ ìŠ¤íƒœë¯¸ë‚˜ ì¬ê³„ì‚°
  recalcHuntStamina();

  const max = getHuntStaminaMax();
  const remaining = Math.min(max, Number(huntStamina || 0));

  huntBtnEl.textContent = ` ì‚¬ëƒ¥ (${remaining}/${max})`;

  // íšŒë³µê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
  let infoText = "";
  let intervalMin = 20; // ê¸°ë³¸ 20ë¶„
try {
  const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
  intervalMin = 20 - Math.max(0, Number(st && st.huntRechargeMinusMin ? st.huntRechargeMinusMin : 0));
} catch (e) {}

intervalMin = Math.max(1, intervalMin); // ìµœì†Œ 1ë¶„
const intervalMs = intervalMin * 60 * 1000;

  if (remaining >= max) {
    infoText = `[ 00:00 ]`;
  } else {
    const now = Date.now();
    const elapsed = now - lastStaminaUpdate;

    const passed = Math.max(0, elapsed);
    const remainMs = intervalMs - (passed % intervalMs);
    const totalSec = Math.floor(remainMs / 1000);

    const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
    const ss = String(totalSec % 60).padStart(2, "0");

    infoText = `[ ${mm}:${ss} ]`;
  }

  huntInfoEl.style.fontSize   = "13px";
  huntInfoEl.style.color      = "#ccc";
  huntInfoEl.style.whiteSpace = "pre-line";
  huntInfoEl.textContent      = infoText;
}

// âš”ï¸ ê²°íˆ¬ ë²„íŠ¼ UI ê°±ì‹ 
function updateDuelUI() {
  const btn = document.getElementById("duelIconBtn");
  const remainTextEl = document.getElementById("duelRemainText");

  ensureDuelDate(); // ë‚ ì§œ ë°”ë€Œë©´ ê²°íˆ¬íšŸìˆ˜ ë¦¬ì…‹

  const remain = Math.max(0, 10 - duelCountToday);

   // ê²°íˆ¬ì¥ íŒì—… ì•ˆ ë‚¨ì€ íšŸìˆ˜ í‘œì‹œ
  if (remainTextEl) {
    remainTextEl.textContent = `ì˜¤ëŠ˜ ë‚¨ì€ ê²°íˆ¬: ${remain}/10`;
  }
}

// ğŸ ì•„ì´í…œ ë³´ìœ  ìˆ˜ëŸ‰
let itemScroll15 = 0;   // 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
let itemProtect  = 0;   // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
let itemSuper    = 0;   // ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
let itemDownProtect = 0;  //  ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ
let starShard = 0;      // â­ ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°
let itemEssence = 0; // ğŸŸ£ ë§ˆë ¥ì˜ ì •ìˆ˜
let itemScroll21 = 0;     // 21ê°• ê°•í™” ì£¼ë¬¸ì„œ
let itemRateUp5  = 0;   // ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ
let itemMagicPaper = 0; // ğŸ†• ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´
let itemEngraveNormal = 0;  // ğŸª¬ ì¼ë°˜ê°ì¸ì˜ ì£¼ë¬¸ì„œ
let itemEngraveAdvanced = 0; // ğŸª¬ ê³ ê¸‰ê°ì¸ì˜ ì£¼ë¬¸ì„œ

// ğŸ“œ ë§ˆë²• ìŠ¤í¬ë¡¤ ìƒì  íŒë§¤ ì•„ì´í…œ
const scrollShopItems = [
  {
    id: "scroll21",
    name: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",
    priceType: "starShard",   // ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°
    price: 10,
    img: "images/items/scroll_21.png",
    desc: "í•œ ë²ˆì— ë¬´ê¸°ë¥¼ 21ê°•ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
  },
  {
    id: "protect",
    name: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",
    priceType: "starShard",
    price: 30,
    img: "images/items/scroll_protect.png",
    desc: "ê°•í™” ì‹¤íŒ¨ ì‹œ ë¬´ê¸°ê°€ íŒŒê´´ë˜ëŠ” ê²ƒì„ 1íšŒ ë§‰ì•„ì¤ë‹ˆë‹¤."
  },

  {
    id: "super",
    name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ",
    priceType: "starShard",
    price: 50,
    img: "images/items/scroll_super.png",
    desc: "ê°•í™” ì„±ê³µ ì‹œ í•œ ë²ˆì— +2ê°•ì´ ë˜ëŠ” íŠ¹ë³„í•œ ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
  },
    {
    id: "rateUp5",
    name: "ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ",
    priceType: "honor",       // ëª…ì˜ˆì˜ í›ˆì¥
    price: 50,
    img: "images/items/scroll_rateup_5.png",
    desc: "ì´ë²ˆ ê°•í™” ì‹œ ì„±ê³µ í™•ë¥ ì´ 5%p ì¦ê°€í•©ë‹ˆë‹¤."
  },

  // êµ¬ë§¤ ì¦‰ì‹œ ì‚¬ìš©: ì‚¬ëƒ¥íšŸìˆ˜ ì´ˆê¸°í™”
  {
    id: "huntReset",
    name: "ì‚¬ëƒ¥íšŸìˆ˜ ì´ˆê¸°í™”",
    priceType: "honor",       // ëª…ì˜ˆì˜ í›ˆì¥
    price: 30,
    img: "images/items/scroll_hunt_reset.png",
    desc: "êµ¬ë§¤ ì¦‰ì‹œ ì˜¤ëŠ˜ì˜ ì‚¬ëƒ¥íšŸìˆ˜ê°€ 20/20ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤."
  },
    {
    id: "engraveNormalScroll",
    name: "ì¼ë°˜ê°ì¸ì˜ ì£¼ë¬¸ì„œ",
    priceType: "gold",
    price: 3000000000,
    img: "images/items/engrave_normal.png",
    desc: "ê°ì¸ì„ ìƒˆë¡œ ìƒˆê¸¸ ë•Œ ì†Œëª¨ë˜ëŠ” ì£¼ë¬¸ì„œì…ë‹ˆë‹¤. (ì¼ë°˜ê°ì¸ ì „ìš©)"
  },
  {
    id: "engraveAdvancedScroll",
    name: "ê³ ê¸‰ê°ì¸ì˜ ì£¼ë¬¸ì„œ",
    priceType: "gold",
    price: 12000000000,
    img: "images/items/engrave_advanced.png",
    desc: "ê°ì¸ì„ ìƒˆë¡œ ìƒˆê¸¸ ë•Œ ì†Œëª¨ë˜ëŠ” ì£¼ë¬¸ì„œì…ë‹ˆë‹¤. (ê³ ê¸‰ê°ì¸ ì „ìš©)"
  },
];

// ğŸ“¦ ì¿ í° ì½”ë“œ ë³´ìƒ ëª©ë¡ (ì›í•˜ëŠ” ëŒ€ë¡œ ì½”ë“œ/ë³´ìƒ ìˆ˜ì •)
const couponRewards = {
  // 1
  "ENGRAVE": {
    type: "engraveNormalScroll",
    count: 5,
    desc: "ì¼ë°˜ ê°ì¸ì˜ ì£¼ë¬¸ì„œ 5ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤."
  },

  // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œ
  "FROSTQUEEN": {
    type: "itemProtect",
    count: 2,
    desc: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 2ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤."
  }

  // ğŸ‘‡ ì›í•˜ëŠ” ë§Œí¼ ë” ì¶”ê°€ ê°€ëŠ¥
  // "CODE123": { type: "itemSuper", count: 1, desc: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ 1ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤." }//itemDownProtect//
  //engraveNormalScroll//engraveAdvancedScroll//
};
  
// 1. ëœë¤ ì¶œë ¥ìš© ìƒì  ì…ì¥ ê¸°ë³¸ ë©˜íŠ¸ë“¤
const scrollShopNpcIdleLines = [
  "ì™”ë„¤? ì˜¤ëŠ˜ë„ ì£¼ë¬¸ì„œ ì¢€ ë³´ëŸ¬ ì˜¨ ê±°ì§€?",
  "íŒŒê´´í•´ì„œ ëª¨ì€ ì¡°ê°ë“¤, ì—¬ê¸°ì„œ ì œëŒ€ë¡œ ì¨ë³´ìê³ .",
  "ì¡°ê¸ˆ ì²œì²œíˆ ê°€ë„ ê´œì°®ì•„. ì•ˆì „ì¥ì¹˜ ì±™ê¸°ëŠ” ê²ƒë„ ì‹¤ë ¥ì´ì•¼."
];

// ì„ íƒëœ ì•„ì´í…œ / ì²˜ë¦¬ ì¤‘ ì—¬ë¶€
let scrollShopSelectedItem = null;
let scrollShopIsProcessing = false;
let scrollShopPendingQty = 1;          // âœ… ì„ íƒëœ êµ¬ë§¤ ìˆ˜ëŸ‰
let scrollShopPendingItem = null;      // âœ… ìˆ˜ëŸ‰ ì„ íƒ ì¤‘ì¸ ì•„ì´í…œ

  // âœ… ìŠ¤í¬ë¡¤ìƒì  ë„í¬ í™œì„± í† ê¸€
function setScrollShopDockActive(on){
  const b = document.getElementById("scrollShopDockBtn");
  if (b) b.classList.toggle("active", !!on);
}

  // ğŸ“œ ìƒì  ì—´ê¸°
function openScrollShop() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const overlay = document.getElementById("scrollShopOverlay");
  if (!overlay) return;

  renderScrollShopItems();     // ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
  updateScrollShopCurrency();  // ì¬í™” í‘œì‹œ
  setScrollShopNpcIdle();      // ëœë¤ ë©˜íŠ¸

  overlay.style.display = "block";
  setScrollShopDockActive(true);
}

// ğŸ“œ ìƒì  ë‹«ê¸°
function closeScrollShop() {
  const overlay = document.getElementById("scrollShopOverlay");
  if (!overlay) return;

  overlay.style.display = "none";
  setScrollShopDockActive(false);
  
  scrollShopSelectedItem = null;
  scrollShopIsProcessing = false;

  const btnBox = document.getElementById("scrollShopNpcButtons");
  if (btnBox) btnBox.style.display = "none";
}

// ìƒë‹¨ ì¬í™” í‘œì‹œ ê°±ì‹ 
function updateScrollShopCurrency() {
  const starEl  = document.getElementById("scrollShopStarShard");
  const honorEl = document.getElementById("scrollShopHonorMedal");

  if (starEl)  starEl.textContent  = starShard;
  if (honorEl) honorEl.textContent = itemHonorMedal;
}

// ğŸ“œ ìƒì  ì „ìš© NPC í™•ì¸ íŒì—… (ì˜ˆ / ì•„ë‹ˆìš”)
function showScrollShopConfirmPopup(item) {
  if (!item) return;

  scrollShopPendingItem = item;
  scrollShopPendingQty = 1;

  // ê°€ê²© ë¼ë²¨
  const currencyLabel =
  item.priceType === "gold" ? "ê³¨ë“œ" :
  item.priceType === "starShard" ? "ë³„ì¡°ê°" :
  item.priceType === "honorMedal" ? "ëª…ì˜ˆì˜ í›ˆì¥" :
  "";

  const maxBuy = getScrollShopMaxBuyable(item);

  const msg =
    `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ${item.name}
    </div>
    <div style="font-size:13px; line-height:1.6;">
      ${item.desc || ""}
    </div>
    <div style="margin-top:10px; font-size:13px; color:#ddd;">
      ê°€ê²©: <b>${item.priceType === "gold" ? formatGoldFullKR(item.price) : item.price}</b> ${currencyLabel}
      <span style="color:#888;">(ìµœëŒ€ ${maxBuy}ê°œ)</span>
    </div>
    <div style="margin-top:8px; font-size:13px; color:#aaa;">
      ì´ê±¸ ì‚´ë˜?
    </div>
    `;

  showConfirmPopup(
    msg,
    "images/npc/npc_scrollshop_talk.png",
    "ì„¸ë ˆë‚˜ ì—ë¸ë¦°",
    "ì‚°ë‹¤",
    () => {
      // âœ… 1ë‹¨ê³„: ì‚°ë‹¤ í´ë¦­ â†’ ìˆ˜ëŸ‰ ì„ íƒ ë‹¨ê³„ë¡œ
      openScrollShopQtyStep();
    },
    "ê·¸ë§Œë‘˜ë˜",
    () => {
      scrollShopPendingItem = null;
      scrollShopPendingQty = 1;
      scrollShopSelectedItem = null;
      closeNpcPopup();
      setScrollShopNpcIdle();
    }
  );
}

// âœ… ìˆ˜ëŸ‰ ì„ íƒ ë‹¨ê³„ ë Œë”
function openScrollShopQtyStep(){
  const item = scrollShopPendingItem;
  if (!item) { closeNpcPopup(); return; }

  const maxBuy = getScrollShopMaxBuyable(item);
  if (maxBuy <= 0) {
    showNpcMessage(
      `
      <div style="font-size:15px; margin-bottom:4px;">
        ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
      </div>
      <div style="font-size:13px;">
        ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
      </div>
      `,
      "images/npc/npc_scrollshop_calm.png",
      true,
      "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
    );
    scrollShopPendingItem = null;
    scrollShopPendingQty = 1;
    scrollShopSelectedItem = null;
    return;
  }

  // âœ… í˜„ì¬ ì„ íƒ ìˆ˜ëŸ‰ ë³´ì •
  if (scrollShopPendingQty > maxBuy) scrollShopPendingQty = maxBuy;
  if (scrollShopPendingQty < 1) scrollShopPendingQty = 1;

  const currencyLabel =
    item.priceType === "starShard" ? "ë³„ì¡°ê°" :
    item.priceType === "honor" ? "ëª…ì˜ˆë©”ë‹¬" :
    item.priceType === "downProtect" ? "íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ" : "";

  const totalCost = Number(item.price || 0) * Number(scrollShopPendingQty || 0);

  // ë²„íŠ¼(1/5/20/MAX)
  const mkBtn = (n, label) => {
    const disabled = (n > maxBuy);
    const active = (scrollShopPendingQty === n);
    return `
      <button
        style="
          padding:8px 10px; border-radius:10px;
          border:1px solid ${active ? "#f7d37a" : "rgba(255,255,255,0.18)"};
          background:${active ? "rgba(247,211,122,0.18)" : "rgba(0,0,0,0.35)"};
          color:${disabled ? "rgba(255,255,255,0.25)" : "#fff"};
          cursor:${disabled ? "not-allowed" : "pointer"};
          min-width:56px;
        "
        ${disabled ? "disabled" : ""}
        onclick="setScrollShopPendingQty(${n});"
      >${label}</button>
    `;
  };

  // MAXëŠ” â€œìµœëŒ€ êµ¬ë§¤ ê°€ëŠ¥ ìˆ˜ëŸ‰â€ì„ ì„ íƒí•˜ê²Œ
  const maxBtnHtml = `
    <button
      style="
        padding:8px 10px; border-radius:10px;
        border:1px solid ${scrollShopPendingQty === maxBuy ? "#f7d37a" : "rgba(255,255,255,0.18)"};
        background:${scrollShopPendingQty === maxBuy ? "rgba(247,211,122,0.18)" : "rgba(0,0,0,0.35)"};
        color:#fff;
        cursor:pointer;
        min-width:56px;
      "
      onclick="setScrollShopPendingQty(${maxBuy});"
    >MAX</button>
  `;

  const msg =
    `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ${item.name}
    </div>
    <div style="font-size:13px; color:#aaa; margin-bottom:10px;">
      ìˆ˜ëŸ‰ì„ ì„ íƒí•´ì¤˜. (ìµœëŒ€ ${maxBuy}ê°œ)
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:10px;">
      ${mkBtn(1, "1")}
      ${mkBtn(5, "5")}
      ${mkBtn(20, "20")}
      ${maxBtnHtml}
    </div>

    <div style="text-align:center; font-size:13px; color:#ddd; line-height:1.6;">
      ì„ íƒ ìˆ˜ëŸ‰: <b>${scrollShopPendingQty}</b>ê°œ<br>
      ì´ ê°€ê²©: <b>${item.priceType === "gold" ? formatGoldFullKR(totalCost) : totalCost}</b> ${currencyLabel}
    </div>
    `;

  showConfirmPopup(
    msg,
    "images/npc/npc_scrollshop_talk.png",
    "ì„¸ë ˆë‚˜ ì—ë¸ë¦°",
    "êµ¬ë§¤í™•ì •",
    () => {
      const chosen = Number(scrollShopPendingQty || 1);
      proceedScrollShopPurchase(item, chosen); // âœ… ìˆ˜ëŸ‰ í¬í•¨
      scrollShopPendingItem = null;
      scrollShopPendingQty = 1;
    },
    "ë’¤ë¡œ",
    () => {
      // âœ… ë’¤ë¡œ: 1ë‹¨ê³„(ì‚´ë˜?) í™”ë©´ìœ¼ë¡œ ë³µê·€
      showScrollShopConfirmPopup(item);
    }
  );
}

// âœ… ì „ì—­ì—ì„œ í˜¸ì¶œë˜ë„ë¡ windowì— ë°”ì¸ë”©(ì¸ë¼ì¸ onclick ë•Œë¬¸)
window.setScrollShopPendingQty = function(n){
  scrollShopPendingQty = Number(n || 1);
  openScrollShopQtyStep();
};
  
// 1. ëœë¤ ì¶œë ¥ : ê¸°ë³¸ NPC ë©˜íŠ¸
function setScrollShopNpcIdle() {
  const textEl = document.getElementById("scrollShopNpcText");
  const imgEl  = document.getElementById("scrollShopNpcImg");
  if (!textEl || !imgEl) return;

  if (scrollShopNpcIdleLines.length === 0) {
    textEl.innerHTML = "";
  } else {
    const idx = Math.floor(Math.random() * scrollShopNpcIdleLines.length);
    textEl.innerHTML = scrollShopNpcIdleLines[idx];
  }

  imgEl.src = "images/npc/npc_scrollshop_idle.png";

  const btnBox = document.getElementById("scrollShopNpcButtons");
  if (btnBox) btnBox.style.display = "none";
}

  // ìƒì  ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderScrollShopItems() {
  const listEl = document.getElementById("scrollShopItemList");
  if (!listEl) return;

   // ğŸ†• ì£¼ë¬¸ì„œë¶„í•´ íƒ­
  if (scrollShopTabMode === "dis") {
    const disList = [
      { id:"itemDownProtect", name:"ê°•ë“±ë°©ì§€ì£¼ë¬¸ì„œ", img:"images/items/scroll_down_protect.png",  count:Number(itemDownProtect||0), paper:1 },
      { id:"itemScroll15",    name:"15ê°•ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_15.png",     count:Number(itemScroll15||0),    paper:2 },
      { id:"itemScroll21",    name:"21ê°•ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_21.png",     count:Number(itemScroll21||0),    paper:5 },
      { id:"itemProtect",     name:"íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ", img:"images/items/scroll_protect.png",       count:Number(itemProtect||0),     paper:10 },
      { id:"itemSuper",       name:"ìŠˆí¼ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_super.png",         count:Number(itemSuper||0),       paper:15 },
      { id:"itemRateUp5",     name:"ê°•í™”í™•ë¥ 5%ì£¼ë¬¸ì„œ", img:"images/items/scroll_rateup_5.png",     count:Number(itemRateUp5||0),     paper:5 },
    ].filter(x => x.count > 0);

    if (disList.length === 0) {
      listEl.innerHTML = `<div style="padding:10px;color:#aaa;">ë¶„í•´í•  ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    listEl.innerHTML = disList.map(it => `
  <div
    class="scroll-shop-row"
    style="display:flex; align-items:center; padding:4px 6px;
           border-bottom:1px solid #333; cursor:pointer;
           height:44px; box-sizing:border-box;"
    onclick="openScrollDisassembleConfirm('${it.id}')"
  >
    <!-- ì•„ì´ì½˜ -->
    <div style="width:36px; height:36px; margin-right:8px; flex-shrink:0;">
      <img src="${it.img}" alt="" style="max-width:100%; max-height:100%; image-rendering:pixelated;">
    </div>

    <!-- ì´ë¦„ + ì„¤ëª… -->
    <div style="flex:1; text-align:left; line-height:1.15;">
      <div style="font-weight:800;">${it.name}</div>
      <div style="font-size:12px;color:#aaa;">ë³´ìœ : ${it.count}ê°œ Â· 1ê°œ ë¶„í•´ â†’ ì¢…ì´ ${it.paper}ê°œ</div>
    </div>

    <!-- ìš°ì¸¡(ê°„ë‹¨ í‘œê¸°) -->
    <div style="display:flex; align-items:center; gap:4px; flex-shrink:0;">
      <span style="font-size:12px;color:#aaa;">â†’</span>
      <span style="font-weight:800;">${it.paper}</span>
    </div>
  </div>
`).join("");
    return;
  }

    // =========================
  // âœ… ì£¼ë¬¸ì„œ í•©ì„±(syn) íƒ­ ë Œë”
  // =========================
  if (scrollShopTabMode === "syn") {
    const listEl = document.getElementById("scrollShopItemList");
    if (!listEl) return;

    const synList = [
      { id:"itemDownProtect", name:"ê°•ë“±ë°©ì§€ì£¼ë¬¸ì„œ", img:"images/items/scroll_down_protect.png", paper:2,  essence:5,  gold:10000000 },
      { id:"itemProtect",     name:"íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ", img:"images/items/scroll_protect.png",      paper:20, essence:40, gold:1000000000 },
      { id:"itemSuper",       name:"ìŠˆí¼ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_super.png",        paper:30, essence:60, gold:3000000000 },
      { id:"itemScroll15",    name:"15ê°•ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_15.png",           paper:3,  essence:6,  gold:10000000 },
      { id:"itemScroll21",    name:"21ê°•ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_21.png",           paper:7,  essence:13, gold:300000000 },
      { id:"itemRateUp5",     name:"ê°•í™”í™•ë¥ 5%ì£¼ë¬¸ì„œ", img:"images/items/scroll_rateup_5.png",   paper:10, essence:20, gold:2000000000 }
    ];

    const havePaper   = Number(itemMagicPaper || 0);
    const haveEssence = Number(itemEssence || 0);
    const haveGold    = Number(gold || 0);

    let html = "";
    synList.forEach((it) => {
      const maxByPaper   = it.paper   > 0 ? Math.floor(havePaper / it.paper) : 999999;
      const maxByEssence = it.essence > 0 ? Math.floor(haveEssence / it.essence) : 999999;
      const maxByGold    = it.gold    > 0 ? Math.floor(haveGold / it.gold) : 999999;
      const max = Math.max(0, Math.min(maxByPaper, maxByEssence, maxByGold));

      html += `
  <div
    class="scroll-shop-row"
    style="display:flex; align-items:center; padding:4px 6px;
           border-bottom:1px solid #333; cursor:pointer;
           height:44px; box-sizing:border-box;"
    onclick="openScrollSynthesizeConfirm('${it.id}')"
  >
    <!-- ì•„ì´ì½˜ -->
    <div style="width:36px; height:36px; margin-right:8px; flex-shrink:0;">
      <img src="${it.img}" alt="" style="max-width:100%; max-height:100%; image-rendering:pixelated;">
    </div>

    <!-- ì´ë¦„ + í•„ìš”ì¬ë£Œ -->
    <div style="flex:1; text-align:left; line-height:1.15;">
      <div style="font-weight:800;">${it.name}</div>
      <div style="font-size:12px;color:#aaa;">
        í•„ìš”: ì¢…ì´ ${it.paper} / ì •ìˆ˜ ${it.essence} / ê³¨ë“œ ${formatGold(it.gold)}
      </div>
    </div>

    <!-- ìš°ì¸¡: í•©ì„± ê°€ëŠ¥ -->
    <div style="display:flex; align-items:center; gap:6px; flex-shrink:0;">
      <span style="font-size:12px;color:#aaa;">ê°€ëŠ¥</span>
      <span style="font-weight:800;">${max}</span>
    </div>
  </div>
`;
    });

    listEl.innerHTML = html;
    return;
  }

  let html = "";

  scrollShopItems.forEach((item) => {
    const priceIcon =
  item.priceType === "starShard"
    ? "images/items/star_shard.png"
    : item.priceType === "honor"
      ? "images/items/honor_medal.png"
      : "images/items/scroll_down_protect.png";

    html += `
      <div
        class="scroll-shop-row"
        style="display:flex; align-items:center; padding:4px 6px;
       border-bottom:1px solid #333; cursor:pointer;
       height:44px; box-sizing:border-box;"
        onclick="onClickScrollShopItem('${item.id}')"
      >
        <!-- ì•„ì´ì½˜ (í´ë¦­ì‹œ ì„¤ëª…) -->
        <div
  style="width:36px; height:36px; margin-right:8px; flex-shrink:0;"
  onclick="event.stopPropagation(); onClickScrollShopIcon('${item.id}', event)"
>
          <img
            src="${item.img}"
            alt="${item.name}"
            style="max-width:100%; max-height:100%;"
          >
        </div>

        <!-- ì•„ì´í…œëª… -->
        <div style="flex:1; text-align:left;">
          ${item.name}
        </div>

        <!-- ì˜¤ë¥¸ìª½ ê°€ê²© -->
        <div style="display:flex; align-items:center; gap:4px;">
          <img src="${priceIcon}" alt="" style="width:20px; height:20px;">
          <span>x ${item.priceType === "gold" ? formatGoldFullKR(item.price) : item.price}</span>
        </div>
      </div>
    `;
  });

  listEl.innerHTML = html;
}

  let scrollShopTabMode = "buy"; // "buy" | "dis" | "syn"

function setScrollShopTab(mode){
  scrollShopTabMode = mode;

  const b = document.getElementById("tabShopBuy");
  const d = document.getElementById("tabShopDis");
  const s = document.getElementById("tabShopSyn");
  if (b) b.classList.toggle("active", mode === "buy");
  if (d) d.classList.toggle("active", mode === "dis");
  if (s) s.classList.toggle("active", mode === "syn");

  renderScrollShopItems(); // buy/dis ê³µí†µ ë Œë”
}

// ì•„ì´ì½˜ í´ë¦­ â†’ ì¸ë²¤í† ë¦¬ì™€ ê°™ì€ ì•„ì´í…œ ìƒì„¸ íŒì—… ì‚¬ìš©
function onClickScrollShopIcon(itemId, ev) {
  const item = scrollShopItems.find(i => i.id === itemId);
  if (!item) return;

  // ê¸°ì¡´ ì¸ë²¤í† ë¦¬ìš© ìƒì„¸ íŒì—… ì¬ì‚¬ìš©
  // showItemDetail(item, í´ë¦­X, í´ë¦­Y)
  showItemDetail(item, ev.clientX, ev.clientY);
}

// ì¤„ ì „ì²´ í´ë¦­ â†’ ìƒì ìš© NPC íŒì—…ìœ¼ë¡œ êµ¬ë§¤ ì˜ì‚¬ ë¬»ê¸°
function onClickScrollShopItem(itemId) {
  const item = scrollShopItems.find(i => i.id === itemId);
  if (!item) return;

  scrollShopSelectedItem = item;

  // í•˜ë‹¨ NPCëŠ” ê·¸ëƒ¥ ê¸°ë³¸ ëŒ€ì‚¬ ìœ ì§€í•˜ê³ ,
  // ì‹¤ì œ êµ¬ë§¤ í™•ì •ì€ íŒì—…ì—ì„œ ì²˜ë¦¬
  showScrollShopConfirmPopup(item);
}

  // "ì•„ë‹ˆìš”" í´ë¦­ â†’ ì·¨ì†Œ í›„ ë‹¤ì‹œ ëœë¤ ë©˜íŠ¸
function onClickScrollShopNo() {
  scrollShopSelectedItem = null;
  const btnBox = document.getElementById("scrollShopNpcButtons");
  if (btnBox) btnBox.style.display = "none";

  setScrollShopNpcIdle();
}

// ì¬í™” ì¶©ë¶„í•œì§€ ì²´í¬
function checkScrollShopCurrency(item) {
  if (item.priceType === "starShard") {
    return starShard >= item.price;
  }
  if (item.priceType === "honor") {
    return itemHonorMedal >= item.price;
  }
  if (item.priceType === "downProtect") {
    return itemDownProtect >= item.price;
  }
  if (item.priceType === "gold") {
    return Number(gold || 0) >= item.price;
  }
  return false;
}

  function getScrollShopCurrencyAmount(item){
  if (item.priceType === "starShard") return Number(starShard || 0);
  if (item.priceType === "honor") return Number(itemHonorMedal || 0);
  if (item.priceType === "downProtect") return Number(itemDownProtect || 0);
  if (item.priceType === "gold") return Number(gold || 0);
  return 0;
}

function deductScrollShopCurrency(item, totalCost){
  totalCost = Number(totalCost || 0);
  if (totalCost <= 0) return;

  if (item.priceType === "starShard") {
    starShard = Math.max(0, Number(starShard || 0) - totalCost);
  } else if (item.priceType === "honor") {
    itemHonorMedal = Math.max(0, Number(itemHonorMedal || 0) - totalCost);
  } else if (item.priceType === "downProtect") {
    itemDownProtect = Math.max(0, Number(itemDownProtect || 0) - totalCost);
  } else if (item.priceType === "gold") {
    gold = Math.max(0, Number(gold || 0) - totalCost);
  }
}

function getScrollShopMaxBuyable(item){
  const price = Number(item?.price || 0);
  if (price <= 0) return 0;

  // âœ… huntResetì€ ì—¬ëŸ¬ ê°œ ì‚¬ë„ ì˜ë¯¸ê°€ ì—†ì–´ì„œ 1ê°œë¡œ ì œí•œ(í˜„ì¬ grantì—ì„œ ì¦‰ì‹œì‚¬ìš© ì²˜ë¦¬)
  if (item.id === "huntReset") return (getScrollShopCurrencyAmount(item) >= price) ? 1 : 0;

  const have = getScrollShopCurrencyAmount(item);
  return Math.floor(have / price);
}

  // ğŸ“œ ìƒì  êµ¬ë§¤ ì§„í–‰ (ì¬í™” ë¶€ì¡± / êµ¬ë§¤ì¤‘ / ì„±ê³µ ëª¨ë‘ íŒì—… ì²˜ë¦¬)
function proceedScrollShopPurchase(item, qty) {
  if (scrollShopIsProcessing) return;
  if (!item) return;

  qty = Number(qty || 1);
  if (!Number.isFinite(qty) || qty < 1) qty = 1;

  // âœ… MAX/í˜„ì¬ì¬í™”ì— ë§ì¶° ìƒí•œ ë³´ì •
  const maxBuy = getScrollShopMaxBuyable(item);
  if (maxBuy <= 0) {
    showNpcMessage(
      `
      <div style="font-size:15px; margin-bottom:4px;">
        ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
      </div>
      <div style="font-size:13px;">
        ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
      </div>
      `,
      "images/npc/npc_scrollshop_calm.png",
      true,
      "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
    );
    return;
  }
  if (qty > maxBuy) qty = maxBuy;

  const totalCost = Number(item.price || 0) * qty;

  // ë¨¼ì € ì¬í™” ë¶€ì¡± ì²´í¬(ìˆ˜ëŸ‰ ê¸°ì¤€)
  if (getScrollShopCurrencyAmount(item) < totalCost) {
    showNpcMessage(
      `
      <div style="font-size:15px; margin-bottom:4px;">
        ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
      </div>
      <div style="font-size:13px;">
        ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
      </div>
      `,
      "images/npc/npc_scrollshop_calm.png",
      true,
      "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
    );
    return;
  }

  scrollShopIsProcessing = true;

  // â€œì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.â€ â€“ ì‹œìŠ¤í…œ íŒì—… (NPC ì—†ì´)
  showNpcMessage(
    `<div style="font-size:14px;">ì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.</div>`,
    null,
    false,
    ""
  );

  setTimeout(() => {
    // âœ… ì¤‘ê°„ì— ì¬í™”ê°€ ë°”ë€Œì—ˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë‹¤ì‹œ ê³„ì‚°/ë³´ì •
    const maxBuy2 = getScrollShopMaxBuyable(item);
    if (maxBuy2 <= 0) {
      showNpcMessage(
        `
        <div style="font-size:15px; margin-bottom:4px;">
          ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
        </div>
        <div style="font-size:13px;">
          ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
        </div>
        `,
        "images/npc/npc_scrollshop_calm.png",
        true,
        "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
      );
      scrollShopIsProcessing = false;
      return;
    }

    let qty2 = qty;
    if (qty2 > maxBuy2) qty2 = maxBuy2;

    const totalCost2 = Number(item.price || 0) * qty2;
    if (getScrollShopCurrencyAmount(item) < totalCost2) {
      showNpcMessage(
        `
        <div style="font-size:15px; margin-bottom:4px;">
          ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.
        </div>
        <div style="font-size:13px;">
          ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.
        </div>
        `,
        "images/npc/npc_scrollshop_calm.png",
        true,
        "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
      );
      scrollShopIsProcessing = false;
      return;
    }

    // âœ… ì‹¤ì œ ì¬í™” ì°¨ê°(ìˆ˜ëŸ‰ ë°˜ì˜)
    deductScrollShopCurrency(item, totalCost2);

    // âœ… ì•„ì´í…œ ì§€ê¸‰(ìˆ˜ëŸ‰ ë°˜ì˜)
    grantScrollShopItem(item, qty2);

    // êµ¬ë§¤ ì„±ê³µ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:15px; margin-bottom:4px;">
        ì¢‹ì•„, ì˜ ìƒ€ë‹¤.
      </div>
      <div style="font-size:13px;">
        ì´ë²ˆì—”â€¦ ëŠë‚Œ ì˜¤ì§€?
      </div>
      `,
      "images/npc/npc_scrollshop_happy.png",
      true,
      "ì„¸ë ˆë‚˜ ì—ë¸ë¦°"
    );

    setScrollShopNpcIdle();

    scrollShopIsProcessing = false;
    scrollShopSelectedItem = null;
  }, 1000);
}

  // ===============================
// ğŸ§¾ ì£¼ë¬¸ì„œ ë¶„í•´(ìˆ˜ëŸ‰ ì„ íƒ) ìƒíƒœ
// ===============================
let disTargetId = "";
let disQty = 1;

function getDisMetaById(id){
  const map = {
    itemDownProtect: { name:"ê°•ë“±ë°©ì§€ì£¼ë¬¸ì„œ", count: () => Number(itemDownProtect||0), paper:1 },
    itemScroll15:    { name:"15ê°•ê°•í™”ì£¼ë¬¸ì„œ", count: () => Number(itemScroll15||0),    paper:2 },
    itemScroll21:    { name:"21ê°•ê°•í™”ì£¼ë¬¸ì„œ", count: () => Number(itemScroll21||0),    paper:5 },
    itemProtect:     { name:"íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ", count: () => Number(itemProtect||0),     paper:10 },
    itemSuper:       { name:"ìŠˆí¼ê°•í™”ì£¼ë¬¸ì„œ", count: () => Number(itemSuper||0),       paper:15 },
    itemRateUp5:     { name:"ê°•í™”í™•ë¥ 5%ì£¼ë¬¸ì„œ", count: () => Number(itemRateUp5||0),   paper:5 },
  };
  return map[id] || null;
}

// âœ… ë¶„í•´ ë¦¬ìŠ¤íŠ¸ì—ì„œ í´ë¦­ ì‹œ í˜¸ì¶œ
function openScrollDisassembleConfirm(id){
  const meta = getDisMetaById(id);
  if(!meta) return;

  disTargetId = id;
  disQty = 1;

  const owned = meta.count();
  if (owned <= 0) {
    showNpcMessage("ë¶„í•´í•  ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.", null, true, ""); // NPC ì—†ìŒ
    return;
  }

  renderDisassemblePopup(); // ìˆ˜ëŸ‰ ì„ íƒ íŒì—… ì˜¤í”ˆ
}

// âœ… ìˆ˜ëŸ‰ ì„ íƒ íŒì—…(1/5/20/MAX) + ë¶„í•´/ì·¨ì†Œ
function renderDisassemblePopup(){
  const meta = getDisMetaById(disTargetId);
  if(!meta) return;

  const owned = meta.count();
  if (owned <= 0) {
    closeNpcPopup();
    return;
  }

  // ìˆ˜ëŸ‰ ë³´ì •
  disQty = Math.max(1, Math.min(Number(disQty||1), owned));
  const max = owned;
  const paperGet = meta.paper * disQty;

  // ë²„íŠ¼ í™œì„±/ë¹„í™œì„± (ë³´ìœ ëŸ‰ ì´ˆê³¼ë©´ ë¹„í™œì„±)
  const qtyBtn = (n, label) => {
    const disabled = (n > max);
    const active = (disQty === n);
    return `
      <button
        style="
          padding:8px 10px; border-radius:10px;
          border:1px solid ${active ? "rgba(255,215,64,0.65)" : "rgba(255,255,255,0.18)"};
          background:${active ? "rgba(255,215,64,0.18)" : "rgba(0,0,0,0.35)"};
          color:${disabled ? "rgba(255,255,255,0.25)" : "#fff"};
          cursor:${disabled ? "not-allowed" : "pointer"};
          min-width:56px;
        "
        ${disabled ? "disabled" : ""}
        onclick="setDisQty(${n});"
      >${label}</button>
    `;
  };

  const msg = `
    <div style="font-weight:900;font-size:18px;margin-bottom:8px;">ì£¼ë¬¸ì„œë¶„í•´</div>
    <div style="color:#aaa;margin-bottom:10px;">${meta.name} (ë³´ìœ : ${owned}ê°œ)</div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:10px;">
      ${qtyBtn(1,"1")}
      ${qtyBtn(5,"5")}
      ${qtyBtn(20,"20")}
      ${qtyBtn(max,"MAX")}
    </div>

    <div style="text-align:center; font-size:13px; color:#ddd; line-height:1.6;">
      ì„ íƒ ìˆ˜ëŸ‰: <b>${disQty}</b>ê°œ<br>
      íšë“: <span style="color:#ffd54f;">ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´ ${paperGet}ê°œ</span>
    </div>
  `;

  // âœ… NPC ì—†ì´(ì´ë¯¸ì§€/ì´ë¦„ ìˆ¨ê¹€), ë²„íŠ¼ 2ê°œë§Œ ì‚¬ìš©
  showConfirmPopup(
    msg,
    null,
    "",
    "ë¶„í•´í•œë‹¤",
    () => { confirmDisassemble(); },
    "ì·¨ì†Œí•œë‹¤",
    () => {
      disTargetId = "";
      disQty = 1;
      closeNpcPopup();
    }
  );
}

// âœ… ìˆ˜ëŸ‰ ë²„íŠ¼ í´ë¦­ìš© (íŒì—… ë‹¤ì‹œ ë Œë”)
function setDisQty(q){
  disQty = Number(q || 1);
  renderDisassemblePopup();
}

// âœ… ì‹¤ì œ ë¶„í•´ ì²˜ë¦¬
function confirmDisassemble(){
  const meta = getDisMetaById(disTargetId);
  if(!meta) return;

  const owned = meta.count();
  disQty = Math.max(1, Math.min(Number(disQty||1), owned));

   runWithShortDelay("ì ê¹ë§Œ ì£¼ë¬¸ì„œë¥¼ í•´ì²´ ì¤‘ì´ì•¼â€¦", () => {

  // 1) ì£¼ë¬¸ì„œ ì°¨ê°
  if (disTargetId === "itemDownProtect") itemDownProtect = Math.max(0, Number(itemDownProtect||0) - disQty);
  if (disTargetId === "itemScroll15")    itemScroll15    = Math.max(0, Number(itemScroll15||0) - disQty);
  if (disTargetId === "itemScroll21")    itemScroll21    = Math.max(0, Number(itemScroll21||0) - disQty);
  if (disTargetId === "itemProtect")     itemProtect     = Math.max(0, Number(itemProtect||0) - disQty);
  if (disTargetId === "itemSuper")       itemSuper       = Math.max(0, Number(itemSuper||0) - disQty);
  if (disTargetId === "itemRateUp5")     itemRateUp5     = Math.max(0, Number(itemRateUp5||0) - disQty);

  // 2) ì¢…ì´ ì§€ê¸‰
  itemMagicPaper = Number(itemMagicPaper||0) + (meta.paper * disQty);

  // 3) ì €ì¥/ê°±ì‹ 
  save();
  update();
  renderInventory();
  renderScrollShopItems();

  // 4) íŒì—… ë‹«ê³  ì™„ë£Œ ë©”ì‹œì§€
  closeNpcPopup();
  showNpcMessage(
    `ë¶„í•´ ì™„ë£Œ!<br><span style="color:#ffd54f;">ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´ ${meta.paper * disQty}ê°œ</span> íšë“`,
    null, true, ""
  );

  // ìƒíƒœ ì´ˆê¸°í™”
  disTargetId = "";
  disQty = 1;
  });
}

  // ===============================
// â³ ì§§ì€ ì—°ì¶œìš© ë”œë ˆì´ (1~1.5ì´ˆ)
// ===============================
function runWithShortDelay(message, callback){
  showNpcMessage(message, null, false, "ì„¸ë ˆë‚˜ ì—ë¸ë¦°");

  const delay = 1000 + Math.random() * 500; // 1.0 ~ 1.5ì´ˆ
  setTimeout(() => {
    closeNpcPopup();
    callback();
  }, delay);
}

// âœ… ì¸ë¼ì¸ onclickì„ ì“°ëŠ” ê²½ìš° ëŒ€ë¹„(ì•ˆì „)
window.openScrollDisassembleConfirm = openScrollDisassembleConfirm;
window.setDisQty = setDisQty;

// ì‹¤ì œ ì•„ì´í…œ ì§€ê¸‰ ì²˜ë¦¬
function grantScrollShopItem(item, qty) {
  qty = Number(qty || 1);
  if (!Number.isFinite(qty) || qty < 1) qty = 1;

  // âœ… huntResetì€ ì¦‰ì‹œì‚¬ìš©í˜•ì´ë¼ 1ë¡œ ì œí•œ
  if (item.id === "huntReset") qty = 1;

  // ìˆ˜ëŸ‰ ì§€ê¸‰(ê¸°ì¡´ if êµ¬ì¡° ìœ ì§€ + qtyë§Œ ë°˜ì˜)
  if (item.id === "scroll21")   itemScroll21 += qty;

  if (item.id === "protect")    itemProtect += qty;
  else if (item.id === "protect_trade_down10") {
    itemProtect += qty;
  }
  if (item.id === "engraveNormalScroll")   itemEngraveNormal   += qty;
  if (item.id === "engraveAdvancedScroll") itemEngraveAdvanced += qty;

  if (item.id === "super")      itemSuper += qty;
  if (item.id === "rateUp5")    itemRateUp5 += qty;

  // êµ¬ë§¤ ì¦‰ì‹œ ì‚¬ìš©: ì‚¬ëƒ¥íšŸìˆ˜ 20/20 ì´ˆê¸°í™”
  if (item.id === "huntReset") {
    huntCountToday = 0;
    huntStamina = getHuntStaminaMax();
    lastHuntDate = getTodayDateString();
  }

  updateScrollShopCurrency();
  updateUpgradeItemLabels();
  renderInventory();
  update();
  save();
}

// "ì˜ˆ" í´ë¦­
function onClickScrollShopYes() {
  if (!scrollShopSelectedItem || scrollShopIsProcessing) return;
  const item = scrollShopSelectedItem;

  const textEl = document.getElementById("scrollShopNpcText");
  const imgEl  = document.getElementById("scrollShopNpcImg");
  const btnBox = document.getElementById("scrollShopNpcButtons");

  // ë¨¼ì € ì¬í™” ë¶€ì¡± ì²´í¬
  if (!checkScrollShopCurrency(item)) {
    // 3. ì¬í™” ë¶€ì¡± ë©˜íŠ¸
    if (textEl) {
      textEl.innerHTML =
        "ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.<br>" +
        "ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.";
    }
    if (imgEl) {
      imgEl.src = "images/npc/scroll_sad.png";
    }
    if (btnBox) {
      btnBox.style.display = "none";
    }
    scrollShopSelectedItem = null;
    return;
  }

  // ì—¬ê¸°ë¶€í„°ëŠ” êµ¬ë§¤ ì§„í–‰ ì¤‘
  scrollShopIsProcessing = true;
  if (btnBox) btnBox.style.display = "none";

  // 4. â€œì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.â€
  if (textEl) {
    textEl.innerHTML = "ì ê¹ë§Œ, í™•ì¸í•˜ê³  ìˆì–´.";
  }
  if (imgEl) {
    imgEl.src = "images/npc/scroll_talk.png";
  }

  setTimeout(() => {
    // ì•ˆì „í•˜ê²Œ í•œ ë²ˆ ë” ì²´í¬
    if (!checkScrollShopCurrency(item)) {
      if (textEl) {
        textEl.innerHTML =
          "ì¡°ê¸‰í•˜ê²Œ êµ´ë‹¤ê°„ ë” í˜ë“¤ì–´ì§ˆ ìˆ˜ë„ ìˆì–´.<br>" +
          "ì¡°ê¸ˆë§Œ ë” ëª¨ì•„ì„œ ì˜¤ì.";
      }
      if (imgEl) imgEl.src = "images/npc/scroll_sad.png";
      scrollShopIsProcessing = false;
      scrollShopSelectedItem = null;
      return;
    }

    // ì‹¤ì œ ì¬í™” ì°¨ê°
    if (item.priceType === "starShard") {
      starShard -= item.price;
      if (starShard < 0) starShard = 0;
    } else if (item.priceType === "honor") {
      itemHonorMedal -= item.price;
      if (itemHonorMedal < 0) itemHonorMedal = 0;
    }

    // ì•„ì´í…œ ì§€ê¸‰
    grantScrollShopItem(item);

    // 5. êµ¬ë§¤ ì„±ê³µ ë©˜íŠ¸
    if (textEl) {
      textEl.innerHTML = "ì¢‹ì•„, ì˜ ìƒ€ë‹¤.<br>ì´ë²ˆì—”â€¦ ëŠë‚Œ ì˜¤ì§€?";
    }
    if (imgEl) {
      imgEl.src = "images/npc/scroll_happy.png";
    }

    scrollShopIsProcessing = false;
    scrollShopSelectedItem = null;
  }, 1000);   // 1ì´ˆ ë”œë ˆì´
}
  
// ì‚¬ëƒ¥í„° ì •ë³´ (ì¶”ì²œ ë ˆë²¨ / ì´ë¦„)
const HUNT_FIELDS = [
  { id: 0,  name: "í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„",       recLevel: 0  },
  { id: 1,  name: "í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„",       recLevel: 0  },
  { id: 2,  name: "ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½",  recLevel: 3  },
  { id: 3,  name: "ë¬´ë²•ìë“¤ì˜ í™©ì•¼",         recLevel: 6  },
  { id: 4,  name: "ëŠªì—˜í”„ì˜ ìˆ²",             recLevel: 9  },
  { id: 5,  name: "ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´",         recLevel: 12 },
  { id: 6,  name: "ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„",       recLevel: 15 },
  { id: 7,  name: "ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´",     recLevel: 18 },
  { id: 8,  name: "ëŒ€ì²œì‚¬ì˜ ìš”ëŒ",           recLevel: 21 },
  { id: 9,  name: "ì‹ ì˜ ì²˜ì†Œ",               recLevel: 24 },
  { id: 10, name: "ì°¨ì›ì˜ í‹ˆìƒˆ",             recLevel: 27 }
];
  
  const FORGE_FIELD_ID = 0;

  // ê° ì‚¬ëƒ¥í„°ë³„ ë°°ê²½ ì´ë¯¸ì§€ (íŒŒì¼ëª…ì€ ì˜ˆì‹œ)
const FIELD_BACKGROUNDS = {
  0: "images/fields/field0_forge_pugrant.png",
  1: "images/fields/field1_mushroom_heinesis.png",    // í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„
  2: "images/fields/field2_sewer_zaun.png",           // ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½
  3: "images/fields/field3_outlaw_west.png",          // ë¬´ë²•ìë“¤ì˜ í™©ì•¼
  4: "images/fields/field4_swamp_elf.png",            // ëŠªì—˜í”„ì˜ ìˆ²
  5: "images/fields/field5_frost_queen_cave.png",     // ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´
  6: "images/fields/field6_lich_deathrealm.png",      // ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„
  7: "images/fields/field7_behemoth_hellpit.png",     // ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´
  8: "images/fields/field8_archangel_cradle.png",     // ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
  9: "images/fields/field9_gods_throne.png",          // ì‹ ì˜ ì²˜ì†Œ
  10:"images/fields/field10_dimensional_rift.png"     // ì°¨ì›ì˜ í‹ˆìƒˆ
};

// âš”ï¸ VS ì—°ì¶œ í‘œì‹œ
function showDuelBattleOverlay(params) {
  const ov = document.getElementById("duelBattleOverlay");
  if (!ov) return;

    // â­ ê²°íˆ¬ VS ëŒ€ê¸° ì‹œì‘ â†’ ì „ì²´ ì•¡ì…˜ ì ê¸ˆ
  isDueling = true;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = true);

  const {
    myName,
    myLevelHtml,
    myPower,
    myWeaponInfo,
    targetName,
    targetLevelHtml,
    targetPower,
    targetWeaponInfo
  } = params;

  const myNameEl    = document.getElementById("duelMyName");
  const myWeaponEl  = document.getElementById("duelMyWeapon");
  const myPowerEl   = document.getElementById("duelMyPower");
  const myImgEl     = document.getElementById("duelMyWeaponImg");

  const tNameEl     = document.getElementById("duelTargetName");
  const tWeaponEl   = document.getElementById("duelTargetWeapon");
  const tPowerEl    = document.getElementById("duelTargetPower");
  const tImgEl      = document.getElementById("duelTargetWeaponImg");

  if (myNameEl)   myNameEl.textContent   = myName || "";
  if (tNameEl)    tNameEl.textContent    = targetName || "";

  // ë¬´ê¸° ì´ë¦„ + ê°•í™”(+00ê°•) ê°™ì´ ì¶œë ¥
  if (myWeaponEl) {
    myWeaponEl.innerHTML =
      (myWeaponInfo?.name || "???") + " " + (myLevelHtml || "");
  }
  if (tWeaponEl) {
    tWeaponEl.innerHTML =
      (targetWeaponInfo?.name || "???") + " " + (targetLevelHtml || "");
  }

  if (myPowerEl) myPowerEl.textContent =
    "ì „íˆ¬ë ¥ " + formatGold(myPower || 0);
  if (tPowerEl) tPowerEl.textContent =
    "ì „íˆ¬ë ¥ " + formatGold(targetPower || 0);

  if (myImgEl && myWeaponInfo?.img) {
    myImgEl.src = myWeaponInfo.img;
  }
  if (tImgEl && targetWeaponInfo?.img) {
    tImgEl.src = targetWeaponInfo.img;
  }

  ov.style.display = "flex";
}

// âš”ï¸ VS ì—°ì¶œ ìˆ¨ê¸°ê¸°
function hideDuelBattleOverlay() {
  const ov = document.getElementById("duelBattleOverlay");
  if (ov) ov.style.display = "none";
  
    // â­ ê²°íˆ¬ VS ì¢…ë£Œ â†’ ì „ì²´ ì•¡ì…˜ ì ê¸ˆ í•´ì œ
  isDueling = false;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = false);
}
  
function logout() {

  // ğŸ” ì„œë²„ì— ë‚¨ì•„ìˆëŠ” ì„¸ì…˜ID ì œê±°
if (userRef) {
  userRef.child("sessionId").remove();
}

currentSessionId = null;
  
    // ğŸ”Œ ë­í‚¹/ìœ ì € ì‹¤ì‹œê°„ êµ¬ë… í•´ì œ (ì„ íƒ)
  db.ref("users").off();

  // âœ… ë³´ìŠ¤ì „ êµ¬ë…/ìºì‹œ ì™„ì „ ì´ˆê¸°í™” (ê³„ì • ì „í™˜ ë²„ê·¸ ë°©ì§€)
resetBossRunsSubscription();
activeBossId = "";
  
  // ì €ì¥ëœ ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
  try {
    localStorage.removeItem("swordGameLastUser");
  } catch (e) {
    console.warn("localStorage remove ì‹¤íŒ¨", e);
  }

  // ìƒíƒœ ì´ˆê¸°í™”
  userId = "";
  userPassword = "";
  userRef = null;

  sword = 0;
  power = 10;
  gold  = 100;
  // âœ… ì—…ì /ì¹­í˜¸ì— ì§ì ‘ ì˜í–¥ ì£¼ëŠ” ê°’ë„ ì´ˆê¸°í™”(ì¤‘ìš”)
weaponType   = null;
maxSwordLevel = 0;
destroyCount  = 0;
  
  attendanceCount    = 0;
  lastAttendanceDate = "";
  currentField       = 1;
  huntCountToday     = 0;
  lastHuntDate       = "";
  itemScroll15       = 0;
  itemProtect        = 0;
  itemSuper          = 0;
  itemDownProtect    = 0;
  itemMagicPaper = 0;
  starShard          = 0;
  duelWin = 0;
  duelLose = 0;
  duelCountToday = 0;
  lastDuelDate = "";
  duelTargetsToday = {};

   // í™”ë©´ ì „í™˜ (âœ… ì—†ëŠ” ìš”ì†Œê°€ ìˆì–´ë„ ì ˆëŒ€ ì•ˆ í„°ì§€ê²Œ)
  const setDisp = (id, disp) => {
    const el = document.getElementById(id);
    if (el) el.style.display = disp;
  };

  setDisp("gameScreen", "none");
  setDisp("loginScreen", "block");

  // âœ… ì¢Œ/ìš° ì•„ì´ì½˜ë“¤
  setDisp("attendanceIconBtn", "none");
  setDisp("achievementIconBtn", "none");

  setDisp("duelIconBtn", "none");
  setDisp("guildIconBtn", "none");
  setDisp("mapBtn", "none");
  setDisp("userListIconBtn", "none");
  setDisp("bossBattleIconBtn", "none");

  // âœ… ë¡œê·¸/ì‘ì—…ëŒ€
  setDisp("toastLog", "none");
  setDisp("workbenchDock", "none");
  setDisp("workbenchDockUI", "none");

  // âœ… í–„ë²„ê±° ë²„íŠ¼/ë©”ë‰´
  setDisp("hamburgerBtn", "none");
  if (typeof closeHamburgerMenu === "function") closeHamburgerMenu();

  // âœ… (êµ¬ë²„ì „ ë²„íŠ¼ì´ ë‚¨ì•„ìˆì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ) ìˆìœ¼ë©´ ìˆ¨ê¹€
  setDisp("logoutBtn", "none");
  setDisp("couponBtn", "none");

  titlesOwned = {};
equippedTitle = "";
  closeTitleOverlay();

    // âœ… ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ í•´ì œ
  stopAutoRefreshTimer();

  // í”„ë¡œí•„ ì˜ì—­ë„ ì´ˆê¸° ìƒíƒœë¡œ ê°±ì‹ 
  update();
}

// ğŸ–¼ ì‚¬ëƒ¥í„° ë°°ê²½ ì´ë¯¸ì§€ ì ìš©
function applyFieldBackground() {
  const fieldBgEl = document.getElementById("fieldBg");
  const gameScreenEl = document.getElementById("gameScreen");
  if (!gameScreenEl) return;

  // ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸í•œ FIELD_BACKGROUNDS ì‚¬ìš©
  const url = FIELD_BACKGROUNDS[currentField] || FIELD_BACKGROUNDS[1];

  // âœ… CSSê°€ #gameScreen::beforeì—ì„œ var(--field-bg-image)ë¥¼ ì½ìœ¼ë¯€ë¡œ
  //    ë³€ìˆ˜ë¥¼ #gameScreenì— ì„¸íŒ…í•´ì•¼ ë°°ê²½ì´ ëœ¸
  gameScreenEl.style.setProperty("--field-bg-image", `url('${url}')`);

  // (ì˜µì…˜) í˜¹ì‹œ ë‹¤ë¥¸ ê³³ì—ì„œ fieldBg ê¸°ì¤€ìœ¼ë¡œ ì½ëŠ” ì½”ë“œê°€ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆì–´ì„œ ê°™ì´ ì„¸íŒ…
  if (fieldBgEl) {
    fieldBgEl.style.setProperty("--field-bg-image", `url('${url}')`);
  }
  
  if (typeof updateBgmByField === "function") updateBgmByField();

}

  // ============================
// ğŸµ BGM (í•„ë“œë³„)
// ============================
let currentBgm = null;

function playBgm(bgm){
  if (!bgm) return;

  // âœ… ê°™ì€ BGMì´ë¼ë„ "ì¼ì‹œì •ì§€ ìƒíƒœ"ë©´ ë‹¤ì‹œ ì¬ìƒ ì‹œë„í•´ì•¼ í•¨
  if (currentBgm === bgm) {
    try{
      if (bgm.paused) {
        const p = bgm.play();
        if (p && typeof p.catch === "function") {
          p.catch(() => { window._bgmNeedUserGesture = true; });
        }
      }
    }catch(e){}
    return;
  }

  try{
    if (currentBgm){
      currentBgm.pause();
      currentBgm.currentTime = 0;
    }
  }catch(e){}

  currentBgm = bgm;

  try{
    const p = bgm.play();
    if (p && typeof p.catch === "function") {
      p.catch(() => {
        // âœ… ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ â†’ ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì¬ì‹œë„
        window._bgmNeedUserGesture = true;
      });
    }
  }catch(e){}
}

function stopBgm(){
  if (!currentBgm) return;
  try{
    currentBgm.pause();
    currentBgm.currentTime = 0;
  }catch(e){}
  currentBgm = null;
}

// âœ… í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ BGM (íŒŒì¼ëª…ì€ ë„¤ê°€ sounds/ì— ë„£ì€ ê±¸ë¡œ)
const BGM_FULGURANT_FORGE = new Audio("sounds/bgm_fugrant_forge.mp3");
BGM_FULGURANT_FORGE.loop = true;
BGM_FULGURANT_FORGE.volume = Math.min(1, 0.5 * 1.3); // ê¸°ë³¸ ë³¼ë¥¨ (ì›í•˜ë©´ 0.25~0.50 ì¡°ì ˆ)

  // ============================
// ğŸ—º MAP Open SFX
// ============================
// íŒŒì¼ëª…: sounds/ui_map_open.mp3
const MAP_OPEN_SFX_SRC = "sounds/ui_map_open.mp3";

const MAP_OPEN_POOL = Array.from({ length: 2 }, () => {
  const a = new Audio(MAP_OPEN_SFX_SRC);
  a.volume = 0.7;
  a.preload = "auto";
  return a;
});
let _mapOpenIdx = 0;

function playMapOpenSfx(){
  try{
    const a = MAP_OPEN_POOL[_mapOpenIdx++ % MAP_OPEN_POOL.length];
    a.currentTime = 0;
    const p = a.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }catch(e){}
}

  // ============================
// ğŸ¹ Hunt Success SFX (ì‚¬ëƒ¥ ì„±ê³µ)
// ============================

// íŒŒì¼ëª…: sounds/sfx_hunt_success.mp3
const HUNT_SUCCESS_SFX_SRC = "sounds/sfx_hunt_success.mp3";

// ì—°ì† ì„±ê³µ ëŒ€ë¹„ í’€
const HUNT_SUCCESS_POOL = Array.from({ length: 3 }, () => {
  const a = new Audio(HUNT_SUCCESS_SFX_SRC);
  a.volume = 0.75;   // ë³´ìƒ ì‚¬ìš´ë“œëŠ” UIë³´ë‹¤ ì‚´ì§ í¼
  a.preload = "auto";
  return a;
});
let _huntSuccessIdx = 0;

function playHuntSuccessSfx(){
  try{
    const a = HUNT_SUCCESS_POOL[_huntSuccessIdx++ % HUNT_SUCCESS_POOL.length];
    a.currentTime = 0;
    const p = a.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }catch(e){}
}

// ============================
// ğŸ‘† UI Tap SFX (ê°•í™”/ì‚¬ëƒ¥/íŒë§¤ ë²„íŠ¼ í´ë¦­ìŒ)
// ============================

const UI_TAP_SFX_SRC = "sounds/ui_tap_action.mp3";

// ë¹ ë¥´ê²Œ ì—°íƒ€í•´ë„ ì”¹íˆì§€ ì•Šê²Œ 4ê°œ í’€ë¡œ ëŒë¦¼
const UI_TAP_POOL = Array.from({ length: 4 }, () => {
  const a = new Audio(UI_TAP_SFX_SRC);
  a.volume = 0.65;     // ì·¨í–¥ëŒ€ë¡œ 0.4~0.8
  a.preload = "auto";
  return a;
});
let _uiTapIdx = 0;

function playUiTap(){
  try{
    const a = UI_TAP_POOL[_uiTapIdx++ % UI_TAP_POOL.length];
    a.currentTime = 0;
    const p = a.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }catch(e){}
}


function updateBgmByField(){
  if (typeof isInFulgurantForge === "function" && isInFulgurantForge()){
  applyBgmVolumeNow();     // âœ… ì¶”ê°€
  playBgm(BGM_FULGURANT_FORGE);
} else {
  stopBgm();
}
}

  // âœ… ëª¨ë°”ì¼ ìë™ì¬ìƒ ì°¨ë‹¨ ëŒ€ì‘: ì²« ì‚¬ìš©ì ì…ë ¥ì—ì„œ BGM ì¬ì‹œë„
window._bgmNeedUserGesture = false;

document.addEventListener("pointerdown", () => {
  if (!window._bgmNeedUserGesture) return;
  window._bgmNeedUserGesture = false;

  try {
    if (currentBgm) {
      const p = currentBgm.play();
      if (p && typeof p.catch === "function") p.catch(()=>{});
    } else if (typeof updateBgmByField === "function") {
      updateBgmByField();
    }
  } catch(e){}
}, { passive: true });

  // ==================================================
// ğŸ”‡ ëª¨ë°”ì¼ ë°±ê·¸ë¼ìš´ë“œ ì§„ì… ì‹œ ì‚¬ìš´ë“œ ê°•ì œ ì¤‘ë‹¨
// (í™ˆë²„íŠ¼ / ì•± ì „í™˜ ëŒ€ì‘)
// ==================================================

function pauseAllSounds(){
  // ğŸµ BGM ì •ì§€
  if (typeof currentBgm !== "undefined" && currentBgm) {
    try { currentBgm.pause(); } catch(e){}
  }

    // ğŸ”Š UI íƒ­ ì‚¬ìš´ë“œ ì •ì§€
  if (typeof UI_TAP_POOL !== "undefined" && UI_TAP_POOL) {
    UI_TAP_POOL.forEach(a => { try { a.pause(); a.currentTime = 0; } catch(e){} });
  }

    // ğŸ¹ ì‚¬ëƒ¥ ì„±ê³µ ì‚¬ìš´ë“œ ì •ì§€
  if (typeof HUNT_SUCCESS_POOL !== "undefined") {
    HUNT_SUCCESS_POOL.forEach(a => {
      try { a.pause(); a.currentTime = 0; } catch(e){}
    });
  }

  // ğŸ”Š WebAudio (í‹±í‹±í‹± / í´ë¦­ìŒ ë“±)
  try {
    if (typeof _tapCtx !== "undefined" && _tapCtx && _tapCtx.state === "running") {
      _tapCtx.suspend();
    }
  } catch(e){}
}

function resumeBgmIfNeeded(){
  // WebAudio ë³µêµ¬
  try {
    if (typeof _tapCtx !== "undefined" && _tapCtx && _tapCtx.state === "suspended") {
      _tapCtx.resume();
    }
  } catch(e){}

  // í˜„ì¬ í•„ë“œ ê¸°ì¤€ìœ¼ë¡œ BGM ì¬ìƒ
  if (typeof updateBgmByField === "function") {
    updateBgmByField();
  }
}

// ğŸ”´ í™”ë©´ì´ ë³´ì´ì§€ ì•Šê²Œ ë˜ëŠ” ìˆœê°„ (í™ˆë²„íŠ¼ í¬í•¨)
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    pauseAllSounds();
  } else {
    resumeBgmIfNeeded();
  }
});

// ğŸ”´ iOS / ì¼ë¶€ ë¸Œë¼ìš°ì € ë³´ì¡° ëŒ€ì‘
window.addEventListener("blur", () => {
  pauseAllSounds();
});

window.addEventListener("focus", () => {
  resumeBgmIfNeeded();
});

  function isInFulgurantForge(){
  return Number(currentField) === FORGE_FIELD_ID;
}

  function showGoToForgeMessage(){
  showSimpleMessage(
    "í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ìœ¼ë¡œ ë³µê·€í•˜ì.",
    "ì•ˆë‚´"
  );
}

function setNpcName(name) {
  const nameEl = document.getElementById("npcPopupName");
  if (nameEl) nameEl.textContent = name;
}

// ğŸ” ì„¸ì…˜(ê°™ì€ ê¸°ê¸° ìƒˆë¡œê³ ì¹¨ì€ ê°™ì€ sessionId ì¬ì‚¬ìš© + í•˜íŠ¸ë¹„íŠ¸)
let sessionPingTimer = null;

function _sessKey(uid){ return "swordGameSession_" + String(uid || ""); }

function getLocalSessionId(uid){
  try { return localStorage.getItem(_sessKey(uid)) || ""; } catch(e){ return ""; }
}
function setLocalSessionId(uid, sid){
  try { localStorage.setItem(_sessKey(uid), String(sid || "")); } catch(e){}
}
function clearLocalSessionId(uid){
  try { localStorage.removeItem(_sessKey(uid)); } catch(e){}
}

function startSession() {
  if (!userRef || !userId) return;

  // âœ… ê°™ì€ ê¸°ê¸°/ë¸Œë¼ìš°ì €ë©´ ìƒˆë¡œê³ ì¹¨í•´ë„ ê°™ì€ ì„¸ì…˜ ìœ ì§€
  let sid = getLocalSessionId(userId);
  if (!sid) {
    sid = Date.now() + "_" + Math.random().toString(36).slice(2);
    setLocalSessionId(userId, sid);
  }
  currentSessionId = sid;

  // âœ… sessionId + í•˜íŠ¸ë¹„íŠ¸ ê¸°ë¡
  userRef.update({
    sessionId: currentSessionId,
    sessionUpdatedAt: Date.now()
  });

  // âœ… í•˜íŠ¸ë¹„íŠ¸(ì£½ì€ ì„¸ì…˜ íŒë³„ìš©)
  if (sessionPingTimer) clearInterval(sessionPingTimer);
  sessionPingTimer = setInterval(() => {
    if (!userRef || !currentSessionId) return;
    userRef.child("sessionUpdatedAt").set(Date.now());
  }, 15000);

  watchSessionId(userId, currentSessionId);

  // âœ… ì—°ê²°ì´ ë‹¤ì‹œ ì‚´ì•„ë‚˜ë©´ ë‚´ ì„¸ì…˜ ì¬ê¸°ë¡(ëª¨ë°”ì¼ ìˆœê°„ ëŠê¹€ ë³µêµ¬)
  db.ref(".info/connected").on("value", (snap) => {
    if (snap.val() === true && userRef && currentSessionId) {
      userRef.update({
        sessionId: currentSessionId,
        sessionUpdatedAt: Date.now()
      });
    }
  });

  // âœ… ì´ íƒ­ì´ ëŠê¸°ë©´ session ì •ë³´ ì •ë¦¬
  userRef.child("sessionId").onDisconnect().remove();
  userRef.child("sessionUpdatedAt").onDisconnect().remove();

  resetBossRunsSubscription();
  ensureBossRunsSubscription();
}

// âœ… ë‚´ sessionIdê°€ "ë‹¤ë¥¸ ê°’"ìœ¼ë¡œ ë°”ë€ ê²½ìš°ì—ë§Œ íŠ•ê¹€(ê°™ì€ ì„¸ì…˜ì€ ìœ ì§€)
function watchSessionId(uid, mySessionId) {
  const ref = db.ref("users/" + uid + "/sessionId");

  ref.on("value", (snap) => {
    const cur = snap.val();

    // sessionIdê°€ ë¹„ëŠ” ê±´(ëª¨ë°”ì¼ ìˆœê°„ ëŠê¹€) í—ˆìš©
    if (!cur) return;

    // ë‹¤ë¥¸ ê°’ì´ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì†í•œ ê²ƒ
    if (cur !== mySessionId) {
      console.warn("[SESSION] ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì†í•˜ì—¬ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬");

      showNpcMessage(
        "ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì ‘ì†í•˜ì—¬<br>í˜„ì¬ ì ‘ì†ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
        null,
        true,
        ""
      );

      // ë‚´ ë¡œì»¬ ì„¸ì…˜í‚¤ë„ ë¹„ì›Œì„œ ë‹¤ìŒ ì ‘ì† ë•Œ ì •ìƒ ì¬ë°œê¸‰
      clearLocalSessionId(uid);

      logout();
    }
  });
}

// âœ… ì‚´ì•„ìˆëŠ” ì„¸ì…˜ì¸ì§€ íŒë‹¨(í•˜íŠ¸ë¹„íŠ¸ ê¸°ì¤€)
function isSessionStale(data){
  const t = Number(data?.sessionUpdatedAt || 0);
  // 90ì´ˆ ì´ìƒ ì—…ë°ì´íŠ¸ ì—†ìœ¼ë©´ ì£½ì€ ì„¸ì…˜ìœ¼ë¡œ ê°„ì£¼
  return !t || (Date.now() - t > 90000);
}

  // ================================
// ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹ ì‹œìŠ¤í…œ (30ê°• â†’ 72ì‹œê°„ í›„ ê°•ì œ ì „ë‹¹í–‰)
// ================================
let hofUiTimer = null;
let hofSweepTimer = null;

// â³ ë‚¨ì€ ì‹œê°„ í‘œì‹œ(ì´ˆ ë‹¨ìœ„)
function formatLeftTime(msLeft) {
  const sec = Math.max(0, Math.floor(msLeft / 1000));
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  const m = String(Math.floor((sec % 3600) / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

// ğŸ” 30ê°• ìœ ì €ë©´ ë²„íŠ¼ êµì²´(ê°•í™”/ì‚¬ëƒ¥/íŒë§¤ ìˆ¨ê¸°ê³  ì „ë‹¹ ë²„íŠ¼ë§Œ ë…¸ì¶œ)
function updateHonorHallButton() {
  const upBtn = document.getElementById("upgradeBtn");
  const huBtn = document.getElementById("huntBtn");
  const seBtn = document.getElementById("sellBtn");
  const hallBtn = document.getElementById("hallBtn");

  if (!hallBtn) return;

  // 30ê°• ë¯¸ë§Œ: ì›ë˜ ë²„íŠ¼
  if (Number(sword) < 30) {
    if (upBtn) upBtn.style.display = "";
    if (huBtn) huBtn.style.display = "";
    if (seBtn) seBtn.style.display = "";
    hallBtn.style.display = "none";
    hallBtn.textContent = "ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸°";
    return;
  }

  // 30ê°• ì´ìƒ: ì „ë‹¹ ë²„íŠ¼ë§Œ
  if (upBtn) upBtn.style.display = "none";
  if (huBtn) huBtn.style.display = "none";
  if (seBtn) seBtn.style.display = "none";
  hallBtn.style.display = "";

  // ë‚¨ì€ì‹œê°„ì´ ì—†ìœ¼ë©´ â€œê³§ ì „ë‹¹í–‰â€ í‘œì‹œ
  const left = Number(hofDeadline || 0) - Date.now();
  if (!hofDeadline || left <= 0) {
    hallBtn.textContent = "ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸° (ê³§ ìë™ ì²˜ë¦¬)";
  } else {
    hallBtn.textContent = `ğŸ›ï¸ ëª…ì˜ˆì˜ì „ë‹¹ ë³´ë‚´ê¸° (${formatLeftTime(left)})`;
  }
}

// âœ… ì „ë‹¹ ë²„íŠ¼ í´ë¦­ íŒì—…
function openHonorHallSendPopup() {
  if (!userId || !userRef) return;

  const left = Number(hofDeadline || 0) - Date.now();
  const leftText = (hofDeadline && left > 0) ? formatLeftTime(left) : "ê³§ ìë™ ì²˜ë¦¬";

  const html = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹
    </div>
    <div style="font-size:13px; line-height:1.5;">
      ${leftText} í›„, ë„ˆì˜ ê¸°ë¡ì€ <b>ëª…ì˜ˆì˜ ì „ë‹¹</b>ì— ìƒˆê²¨ì§ˆ ê±°ì•¼.<br>
      ì „ë‹¹ì— ë³´ë‚´ë©´ <b>ë¬´ê¸°ëŠ” 0ê°•ìœ¼ë¡œ ëŒì•„ê°€ê³ </b>, ë‹¤ì‹œ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê²Œ ë¼. í˜¹ì‹œ ì§€ê¸ˆ ë°”ë¡œ ë³´ë‚¼ë˜?<br>
      ê·¸ë˜ë„â€¦ ê·¸ ë³„ì€, ë„¤ ì´ë¦„ ë’¤ì— ë‚¨ì•„. (â˜…)
    </div>
    <div style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
      <button onclick="sendMeToHallOfFame('manual')" style="padding:8px 12px;">
        ë³´ë‚¸ë‹¤
      </button>
      <button onclick="closeNpcPopup()" style="padding:8px 12px;">
        ì ì‹œë§Œ..
      </button>
    </div>
  `;

  showNpcMessage(html, "images/npc/linea_idle.png", false, "ì„œê¸°ê´€ ë¦¬ë„¤ì•„");
}

// âœ… ë‚´ ê³„ì •ì„ ì „ë‹¹ìœ¼ë¡œ ë³´ë‚´ê¸°
function sendMeToHallOfFame(reason) {
  closeNpcPopup();
  sendUserToHallOfFame(userId, reason || "manual");
}

// âœ… ì „ë‹¹ ê¸°ë¡ ìƒì„± + ìœ ì € ë¦¬ì…‹ (ì¤‘ë³µ ë°©ì§€ í¬í•¨)
function sendUserToHallOfFame(targetId, reason) {
  if (!targetId) return;

  const uref = db.ref("users/" + targetId);
  uref.once("value").then(snap => {
    const u = snap.val();
    if (!u) return;

    const uSword = Number(u.sword || 0);
    const uDeadline = Number(u.hofDeadline || 0);
    const uProcessedAt = Number(u.hofProcessedAt || 0);

    // ì´ë¯¸ ì²˜ë¦¬ëœ ìœ ì €ë©´ ì¢…ë£Œ
    if (uProcessedAt && uProcessedAt > 0) {
      return;
      }


    // 30ê°•ì´ ì•„ë‹ˆë©´ íì—ì„œ ì œê±°
    if (uSword < 30) {
      return;
    }

    // ìˆ˜ë™ì´ ì•„ë‹Œë° ì•„ì§ ë§Œë£Œ ì „ì´ë©´ ì²˜ë¦¬ ê¸ˆì§€
    const now = Date.now();
    if (reason !== "manual" && uDeadline && now < uDeadline) {
      return;
    }

    const wt = u.hofWeaponTypeAt30 || u.weaponType || "sword";
    const achievedAt = Number(u.hofAchievedAt || now);
    const stars = Number(u.reach30Count || 0);

    // ì „ë‹¹ ê¸°ë¡ ì‘ì„± (push)
    const hofRef = db.ref("hallOfFame").push();
    const wInfo = getWeaponInfo(30, wt);
    const record = {
      id: targetId,
      weaponType: wt,
      weaponName: (wInfo && wInfo.name) ? wInfo.name : "+30ê°•",
      achievedAt: achievedAt,
      recordedAt: now,
      stars: stars,
      reason: reason || "auto"
    };

    // ìœ ì € ë¦¬ì…‹ (ê³¨ë“œëŠ” ìœ ì§€, ë¬´ê¸° 0ê°•)
    const updates = {
      sword: 0,
      power: 10,                 // 0ê°• ê¸°ë³¸ ì „íˆ¬ë ¥ (í˜„ì¬ íŒŒì¼ ê¸°ë³¸ê°’)
      weaponType: null,          // 0ê°• ê³µìš© ìƒíƒœë¡œ ë˜ëŒë¦¼ (ë‹¤ìŒ 1ê°• ë•Œ ë‹¤ì‹œ ëœë¤ë°°ì •)
      hofProcessedAt: now,
      hofDeadline: 0,
      hofAchievedAt: 0,
      hofWeaponTypeAt30: ""
    };

// ê¸°ë¡ + ë¦¬ì…‹ + í ì œê±°
const multi = {};
multi["hallOfFame/" + hofRef.key] = record;

multi["users/" + targetId + "/sword"] = updates.sword;
multi["users/" + targetId + "/power"] = updates.power;
multi["users/" + targetId + "/weaponType"] = updates.weaponType;

multi["users/" + targetId + "/hofProcessedAt"] = updates.hofProcessedAt;
multi["users/" + targetId + "/hofDeadline"] = updates.hofDeadline;
multi["users/" + targetId + "/hofAchievedAt"] = updates.hofAchievedAt;
multi["users/" + targetId + "/hofWeaponTypeAt30"] = updates.hofWeaponTypeAt30;

// âœ… hofQueueë„ ê°™ì´ ì œê±°(ì•ˆ ì§€ìš°ë©´ ë§Œë£Œ ìŠ¤ìœ•ì—ì„œ ë‹¤ì‹œ ê±´ë“œë¦´ ì—¬ì§€ê°€ ìƒê¹€)
multi["hofQueue/" + targetId] = null;

db.ref().update(multi)
  .then(() => {

    // âœ… ì „ë‹¹ ë“±ë¡ ë¡œê·¸ (ì„±ê³µí–ˆì„ ë•Œ 1íšŒë§Œ)
    const nickHtml = formatNicknameWithTitle(targetId, u.equippedTitle, u.reach30Count);
    writeLog(`ğŸ›ï¸ ${nickHtml}ë‹˜ì´ ${record.weaponName}ì„ ëª…ì˜ˆì˜ ì „ë‹¹ì— ë“±ë¡í•˜ì˜€ìŠµë‹ˆë‹¤.`);

    // ë³¸ì¸ì´ë¼ë©´ ì¦‰ì‹œ ë¡œì»¬ ìƒíƒœë„ ë°˜ì˜
    if (targetId === userId) {
      sword = 0;
      power = 10;
      weaponType = null;

      hofDeadline = 0;
      hofAchievedAt = 0;
      hofWeaponTypeAt30 = "";
      hofProcessedAt = now;

      save(); // âœ… ë¡œì»¬ ì„¸ì´ë¸Œë„ í™•ì •(í•„ë“œë“¤ ì €ì¥)
      update();
      updateHonorHallButton();

      showNpcMessage(
        `<div style="font-size:14px; line-height:1.6;">
          ê¸°ë¡ ì™„ë£Œ. <b>ëª…ì˜ˆì˜ ì „ë‹¹</b>ì— ìƒˆê²¨ì¡Œì–´.<br>
          ì´ì œâ€¦ ë‹¤ì‹œ ì²˜ìŒë¶€í„°, ë³„ì„ í–¥í•´.
        </div>`,
        "images/npc/linea_idle.png"
      );
    }
  })
  .catch((e) => {
    // âœ… ì§€ê¸ˆì²˜ëŸ¼ "ì•„ë¬´ ë°˜ì‘ ì—†ìŒ"ì„ ë§‰ê¸° ìœ„í•´ ì—ëŸ¬ë¥¼ í™”ë©´ì— ë„ì›€
    showNpcMessage(
      `<div style="font-size:13px; line-height:1.6;">
        ì „ë‹¹ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆì–´.<br>
        <b>Firebase ê¶Œí•œ(PERMISSION_DENIED)</b> ê°€ëŠ¥ì„±ì´ ë†’ì•„.<br>
        ì½˜ì†”ì„ í™•ì¸í•´ì¤˜.
      </div>`,
      "images/npc/linea_idle.png"
    );
    console.error(e);
  });
  });
}

// ğŸ” ì „ë‹¹ í ìŠ¤ìœ•: ë§Œë£Œëœ ìœ ì €ë¥¼ ì°¾ì•„ ìë™ ì „ë‹¹í–‰ ì²˜ë¦¬
function sweepHofQueue() {
  const now = Date.now();

  // 1) hofQueue ê¸°ë°˜ ìŠ¤ìœ• (ê¸°ì¡´ ë°©ì‹)
  db.ref("hofQueue")
    .orderByValue()
    .endAt(now)
    .limitToFirst(10)
    .once("value")
    .then(snap => {
      const val = snap.val();
      if (val) {
        Object.keys(val).forEach(uid => {
          sendUserToHallOfFame(uid, "auto");
        });
      }
    })
    .catch(() => {});

  // 2) âœ… ì•ˆì „ë§: hofQueueê°€ ëˆ„ë½/ê¹¨ì ¸ë„ users.hofDeadline ê¸°ë°˜ìœ¼ë¡œ ë§Œë£Œ ìœ ì €ë¥¼ ì§ì ‘ ì°¾ì•„ ì²˜ë¦¬
  db.ref("users")
    .orderByChild("hofDeadline")
    .endAt(now)
    .limitToFirst(10)
    .once("value")
    .then(snap => {
      snap.forEach(child => {
        const uid = child.key;
        const u = child.val() || {};

        // ì´ë¯¸ ì²˜ë¦¬ëìœ¼ë©´ ìŠ¤í‚µ
        if (Number(u.hofProcessedAt || 0) > 0) return;

        // 30ê°• ì´ìƒ + ë°ë“œë¼ì¸ ë§Œë£Œì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
        if (Number(u.sword || 0) >= 30 && Number(u.hofDeadline || 0) > 0 && Number(u.hofDeadline || 0) <= now) {
          sendUserToHallOfFame(uid, "auto");
        }
      });
    })
    .catch(() => {});
}

// âœ… ë¡œê·¸ì¸ í›„ í˜¸ì¶œ: ë²„íŠ¼ íƒ€ì´ë¨¸ + í ìŠ¤ìœ• íƒ€ì´ë¨¸ ì‹œì‘
function startHonorHallTimers() {
  // UI 1ì´ˆ ê°±ì‹ 
  if (hofUiTimer) clearInterval(hofUiTimer);
  hofUiTimer = setInterval(() => {
    updateHonorHallButton();

    // ë³¸ì¸ì´ ë§Œë£Œë˜ë©´ ìë™ ì²˜ë¦¬ íŠ¸ë¦¬ê±°(ë³¸ì¸ë„ ì¦‰ì‹œ ì „ë‹¹í–‰)
    if (userId && Number(sword) >= 30 && hofDeadline && Date.now() >= hofDeadline) {
      sendUserToHallOfFame(userId, "auto");
    }
  }, 1000);

  // í ìŠ¤ìœ•(ë‹¤ë¥¸ ìœ ì € í¬í•¨)
  if (hofSweepTimer) clearInterval(hofSweepTimer);
   sweepHofQueue();
  hofSweepTimer = setInterval(() => {
    sweepHofQueue();
  }, 15000); // 15ì´ˆë§ˆë‹¤ ìŠ¤ìœ•
}

// ğŸŒˆ ì „ë‹¹ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
function loadHallOfFame() {
  const listEl = document.getElementById("hallOfFameList");
  if (!listEl) return;

  db.ref("hallOfFame")
    .limitToLast(30)
    .on("value", (snap) => {
      const obj = snap.val() || {};
      const arr = Object.keys(obj).map(k => ({ key:k, ...obj[k] }));

      // ìµœì‹  ê¸°ë¡ì´ ìœ„ë¡œ
      arr.sort((a, b) => Number(b.recordedAt || 0) - Number(a.recordedAt || 0));

      if (arr.length === 0) {
        listEl.innerHTML = `<div style="text-align:center; color:#999;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

listEl.innerHTML = arr.map((r, i) => {
  const d = r.achievedAt
    ? new Date(Number(r.achievedAt)).toLocaleString("ko-KR")
    : "-";

  const starCount = Math.min(10, Number(r.stars || 0));
  const stars = "â˜…".repeat(starCount);

  return `
    <div style="padding:6px 0; border-bottom:1px solid #333;">
      <div style="font-size:12px; color:#ddd;">
        <b>${i + 1}.</b>
        ${r.id}${starCount > 0 ? ` <span class="rainbowStar">${stars}</span>` : ""}
        <span style="color:#666;"> ã…£ </span>
        <span style="color:#ccc;">${r.weaponName} (+30ê°•)</span>
        <span style="color:#666;"> ã…£ </span>
        <span style="color:#aaa; font-size:11px;">${d}</span>
      </div>
    </div>
  `;
}).join("");
    });
}

// ğŸ¯ ê°•í™” ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ ë¼ë²¨ ìˆ˜ëŸ‰ ê°±ì‹ 
function updateUpgradeItemLabels() {
  const elScroll15 = document.getElementById("labelUseScroll15");
  const elProtect  = document.getElementById("labelUseProtect");
  const elDownProt = document.getElementById("labelUseDownProtect");
  const elSuper    = document.getElementById("labelUseSuper");
  const elScroll21 = document.getElementById("labelUseScroll21");   // ğŸ†•
  const elRate5    = document.getElementById("labelUseRateUp5");    // ğŸ†•


  if (elScroll15) {
    elScroll15.textContent = `15ê°• ê°•í™” ì£¼ë¬¸ì„œ (${itemScroll15})`;
  }
  if (elProtect) {
    elProtect.textContent = `íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ (${itemProtect})`;
  }
  if (elDownProt) {
    elDownProt.textContent = `ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ (${itemDownProtect})`;
  }
  if (elSuper) {
    elSuper.textContent = `ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ (${itemSuper})`;
  }
  if (elScroll21) {
    elScroll21.textContent = `21ê°• ê°•í™” ì£¼ë¬¸ì„œ (${itemScroll21})`;
  }
  if (elRate5) {
    elRate5.textContent = `ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ (${itemRateUp5})`;
  }
}

/* UI */
  
const TITLE_DEFS = [
  { id:"newbie",   name:"ìƒˆë‚´ê¸° ëŒ€ì¥ì¥ì´", how:"ìµœì´ˆ 1íšŒ ê°•í™” ì„±ê³µ" },
  { id:"master15", name:"ëª…ì¸",             how:"ë¬´ê¸° 15ê°• ë‹¬ì„±" },
  { id:"artisan21",name:"ì¥ì¸",             how:"ë¬´ê¸° 21ê°• ë‹¬ì„±" },
  { id:"legend26", name:"ì „ì„¤",             how:"ë¬´ê¸° 26ê°• ë‹¬ì„±" },

  { id:"knight",   name:"ê¸°ì‚¬",   how:"ê²€ìœ¼ë¡œ 21ê°• ë‹¬ì„±" },
  { id:"warrior",  name:"ì „ì‚¬",   how:"ì°½ìœ¼ë¡œ 21ê°• ë‹¬ì„±" },
  { id:"viking",   name:"ë°”ì´í‚¹", how:"ë„ë¼ë¡œ 21ê°• ë‹¬ì„±" },
  { id:"assassin", name:"ì–´ìŒ”ì‹ ", how:"ë‹¨ê²€ìœ¼ë¡œ 21ê°• ë‹¬ì„±" },

  { id:"destroy100", name:"íŒŒê´´ì™•", how:"ë¬´ê¸° íŒŒê´´ íšŸìˆ˜ 100íšŒ" },
  { id:"destroy500", name:"íŒŒê´´ì‹ ", how:"ë¬´ê¸° íŒŒê´´ íšŸìˆ˜ 500íšŒ" },

  // âœ… ì„œë²„ ìµœì´ˆ (ë¶‰ì€ ê¸ˆìƒ‰)
  { id:"worldchamp", name:"ì›”ë“œì±”í”¼ì–¸", how:"ì„œë²„ ìµœì´ˆ 30ê°• ë‹¬ì„±", color:"redgold" },

  // âœ… ì—”ë“œ(ì¢…ì°©ì§€) (ê¸ˆìƒ‰)
  { id:"end_sword", name:"ê²€ì˜ ì¢…ì°©ì§€",  how:"ê²€ìœ¼ë¡œ 30ê°• ë‹¬ì„±",  color:"gold" },
  { id:"end_axe",   name:"ë„ë¼ì˜ ì¢…ì°©ì§€",how:"ë„ë¼ë¡œ 30ê°• ë‹¬ì„±", color:"gold" },
  { id:"end_spear", name:"ì°½ì˜ ì¢…ì°©ì§€",  how:"ì°½ìœ¼ë¡œ 30ê°• ë‹¬ì„±",  color:"gold" },
  { id:"end_dagger", name:"ë‹¨ê²€ì˜ ì¢…ì°©ì§€", how:"ë‹¨ê²€ìœ¼ë¡œ 30ê°• ë‹¬ì„±", color:"gold" },

  // âœ… ì—­ë³‘ì¥ (ë°˜ì§ ì´ˆë¡) + ë°©ë²• ìˆ¨ê¹€
  { id:"plague", name:"ì—­ë³‘ì¥", how:"???", color:"plague" },
  
  { id:"bow21", name:"ì‚¬ëƒ¥ê¾¼", how:"í™œ 21ê°• ë‹¬ì„±", color:"" },
  { id:"bow30", name:"í™œì˜ ì¢…ì°©ì§€", how:"í™œ 30ê°• ë‹¬ì„±", color:"gold" },

  { id:"staff21", name:"ë§ˆë²•ì‚¬",       how:"ìŠ¤íƒœí”„ 21ê°• ë‹¬ì„±", color:"" },
  { id:"staff30", name:"ìŠ¤íƒœí”„ ì¢…ì°©ì§€", how:"ìŠ¤íƒœí”„ 30ê°• ë‹¬ì„±", color:"gold" },

    // âœ… ê°•í™”/íŒŒê´´/ê°•ë“± ê³„ì—´
  { id:"superstar", name:"ìŠˆí¼ìŠ¤íƒ€", how:"ìŠˆí¼ê°•í™” 1íšŒ ì„±ê³µ" },
  { id:"slide4",    name:"ë¯¸ë„ëŸ¼í‹€", how:"ê°•ë“± ì—°ì† 4íšŒ" },
  { id:"luckyday",  name:"ìš´ìˆ˜ì¢‹ì€ë‚ ", how:"20ê°• ì´ì „ì—ì„œ íŒŒê´´" },
  { id:"icarus",    name:"ì´ì¹´ë£¨ìŠ¤", how:"26ê°• ì´ìƒì—ì„œ íŒŒê´´" },
  { id:"dopamine",  name:"ë„íŒŒë¯¼ì¤‘ë…ì", how:"25ê°• ì´í›„ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì—†ì´ ê°•í™” ì‹œë„" },

  { id:"bully10", name:"ê°•ì•½ì•½ê°•", how:"ì•½í•œ ìƒëŒ€ì—ê²Œ ê²°íˆ¬ì¥ ì§€ì •ë§¤ì¹­ 10íšŒ" },
  { id:"challenger10", name:"ë„ì „ì", how:"ê°•í•œ ìƒëŒ€ì—ê²Œ ê²°íˆ¬ì¥ ì§€ì •ë§¤ì¹­ ìŠ¹ë¦¬ 10íšŒ" },
  { id:"brawl500", name:"ì‹¸ì›€ê¾¼", how:"500íšŒ ì´ìƒ ê²°íˆ¬" },
  { id:"warGod", name:"íˆ¬ì‹ ", how:"4ê°• ì´ìƒ ë†’ì€ ìƒëŒ€ì—ê²Œ ê²°íˆ¬ì¥ ìŠ¹ë¦¬ 1íšŒ" },
  { id:"mansur", name:"ë§Œìˆ˜ë¥´", how:"10ì¡° ê³¨ë“œ ì´ìƒ ë³´ìœ " },

  // âœ… ê°•í™” íƒ€ì´ë° ë¬¶ìŒ
  { id:"gambler",  name:"ìŠ¹ë¶€ì‚¬",  how:"21ê°•ë¶€í„° ì£¼ë¬¸ì„œ ì—†ì´ 24ê°• ë„ë‹¬" },
  { id:"god30",    name:"ì‹ ",      how:"29ê°•ì—ì„œ ì£¼ë¬¸ì„œ ì—†ì´ 30ê°• ë‹¬ì„±" },
  { id:"fireworks",name:"í­ì£½ë†€ì´",how:"21~25ê°• ì „ë¶€ íŒŒê´´í•´ë´„" },

  { id:"best30",   name:"ìµœê°•ì",  how:"ë¬´ê¸° 30ê°• 1íšŒ ë‹¬ì„±", color:"gold" },
  { id:"master30", name:"ë‹¬ì¸",    how:"ë¬´ê¸° 30ê°• 3íšŒ ë‹¬ì„±", color:"gold" },

  { id:"oldwater", name:"ê³ ì¸ë¬¼",  how:"ê°™ì€ ë¬´ê¸°ë¡œ 30ê°• 2íšŒ ë‹¬ì„±", color:"gold" },
  { id:"stale",    name:"ì©ì€ë¬¼",  how:"ê°™ì€ ë¬´ê¸°ë¡œ 30ê°• 3íšŒ ë‹¬ì„±", color:"gold" },
  { id: "boss_raider",  name: "í† ë²ŒëŒ€", how:"ë³´ìŠ¤ì „ í† ë²Œ1íšŒ ì„±ê³µ" },

];

  // ğŸ¨ ì¹­í˜¸ ìƒ‰ìƒ ìŠ¤íƒ€ì¼
function getTitleColorStyle(colorKey) {
  // ê¸°ë³¸(íšŒìƒ‰)
  if (!colorKey) return "color:#9a9a9a;";

  // ì—”ë“œ(ê¸ˆìƒ‰)
  if (colorKey === "gold") {
    return "color:#ffd54f;font-weight:bold;text-shadow:0 0 6px rgba(255,213,79,0.35);";
  }

  // ì„œë²„ìµœì´ˆ(ë¶‰ì€ ê¸ˆìƒ‰)
  if (colorKey === "redgold") {
    return "color:#ffb74d;font-weight:bold;text-shadow:0 0 6px rgba(255,120,80,0.35);";
  }

  // ì—­ë³‘ì¥(ë°˜ì§ ì§™ì€ ì´ˆë¡)
  if (colorKey === "plague") {
    return "color:#00c853;font-weight:bold;text-shadow:0 0 10px rgba(0,200,83,0.7); animation:sparkle 1.2s infinite alternate;";
  }

  return "color:#9a9a9a;";
}

// ğŸ·ï¸ ë‹‰ë„¤ì„ì— ì¹­í˜¸ ë¶™ì´ê¸° (ìƒ‰ìƒ í¬í•¨ + 30ê°• ë‹¬ì„± ë³„)
function formatNicknameWithTitle(id, titleId, reach30Count) {
  const safeId = (id ?? "-");
  const n = Math.max(0, Number(reach30Count || 0));

  // â˜… ë¬¸ìì—´ ë§Œë“¤ê¸° (ë„ˆë¬´ ê¸¸ë©´ 5ê°œê¹Œì§€ë§Œ +N)
  let starHtml = "";
  if (n > 0) {
    const show = Math.min(n, 5);
    const more = n - show;
    const starText = "â˜…".repeat(show) + (more > 0 ? `+${more}` : "");
    starHtml = ` <span class="rainbow">${starText}</span>`;
  }

  if (!titleId) return `${safeId}${starHtml}`;

  const def = TITLE_DEFS.find(t => t.id === titleId);
  const titleName = def ? def.name : titleId;

  const colorKey = def?.color || "";
  if (colorKey === "plague") {
    return `<span class="title-plague">[${titleName}]</span>${safeId}${starHtml}`;
  }

  // ğŸ‘‘ â€œì‹ â€ ì¹­í˜¸ë©´: ê²€ì€ ê¸€ì”¨ + í°ìƒ‰ ê¸€ë¡œìš° (ì „ìš© í´ë˜ìŠ¤)
if (titleId === "god" || titleName === "ì‹ ") {
  return `<span class="title-god">[${titleName}]</span>${safeId}${starHtml}`;
}

  const style = getTitleStyle(colorKey);

  const titleSpan =
    (colorKey === "redgold")
      ? `<span class="title-redglow">[${titleName}]</span>`
      : `<span style="${style}">[${titleName}]</span>`;

  // âœ… ì¹­í˜¸ + ë‹‰ë„¤ì„ + â˜… ëª¨ë‘ ìœ ì§€
  return `${titleSpan}${safeId}${starHtml}`;
  }
  
function getTitleStyle(colorKey) {
  // ê¸°ë³¸(íšŒìƒ‰)
  if (!colorKey) return "color:#9a9a9a;";

// ì—”ë“œ(ê¸ˆìƒ‰) âœ… 30ê°• ì¹­í˜¸ = ë” í™©ê¸ˆë¹›
if (colorKey === "gold") {
  return "color:#ffd700;font-weight:bold;text-shadow:0 0 10px rgba(255,215,0,0.60), 0 0 18px rgba(255,215,0,0.35);";
}

  // ì„œë²„ìµœì´ˆ(ë¶‰ì€ ê¸ˆìƒ‰)
  if (colorKey === "redgold") {
    return "color:#ffb74d;font-weight:bold;text-shadow:0 0 6px rgba(255,120,80,0.35);";
  }

  // ì—­ë³‘ì¥(ì§™ì€ ì´ˆë¡ + ë°˜ì§ ëŠë‚Œì€ ì¼ë‹¨ ê¸€ë¡œìš°)
  if (colorKey === "plague") {
    return "color:#00c853;font-weight:bold;text-shadow:0 0 8px rgba(0,200,83,0.45);";
  }

  return "color:#9a9a9a;";
}

// ë¦¬ë„¤ì•„ ëŒ€ì‚¬(ëœë¤)
const LINEA_LINES = [
  "ì¹­í˜¸ëŠ” ëª…ì˜ˆì´ì ê¸°ë¡ì´ì•¼! ì–´ë–¤ ê±¸ ë‹¬ì•„ë³¼ë˜?",
  "ì˜¤â€¦ ë°©ê¸ˆ ë„ˆ ë°ì´í„° ì •ë¦¬í•˜ë‹¤ê°€ ê°íƒ„í–ˆì–´. í—¤í—¤!",
  "ì™”ì–´? ì ê¹ë§Œ, ì´ ì¤„ë§Œ ì“°ê³ !",
  "ì¹­í˜¸ ë‹¬ë©´ ì‚¬ëŒë“¤ì´ ë°”ë¡œ ì•Œì•„ë³´ì§€. ì™„ì „ ë¿Œë“¯!",
  "ì•„â€” ì§€ê¸ˆ ê¸°ë¡ ì¤‘ì´ì—ˆëŠ”ë°, ë­ ë³¼ ê±°ì•¼? ì¹­í˜¸?",
  "ì´ê±° ì•Œì•„? ì¹´ë¥´ë‹ˆì•„ëŠ” ì ˆëŒ€ ë¨¼ì € ë§ ì•ˆ ê±¸ì–´.",
  "ì™€, ì´ í˜ì´ì§€ ì¢€ ë´. ê½¤ ë©‹ì§„ë°?",
  "ì„¸ë ˆë‚˜ëŠ” ëŠ˜ ì–´ë ¤ìš´ ì–˜ê¸°ë§Œ í•´â€¦ ë¨¸ë¦¬ ì•„íŒŒ.",
  "ë‚œ ê·¸ëƒ¥â€¦ ì˜¤ëŠ˜ ëˆ„ê°€ ë¬´ê¸° í„°ëœ¨ë ¸ëŠ”ì§€ê°€ ë” ê¶ê¸ˆí•´.",
];

// =====================
// ğŸ·ï¸ ì¹­í˜¸ ìë™ ì§€ê¸‰ ë¡œì§
// =====================
let titleSortMode = "default"; // "default" | "recent"

  // =====================
// ğŸ† ì—…ì (ì¹­í˜¸) ì‹ ê·œ ì•Œë¦¼(!) ê´€ë¦¬
// =====================
const UNSEEN_TITLES_KEY = "pug_unseen_titles"; // { titleId: 1, ... }
let unseenTitles = {};

function loadUnseenTitles(){
  try{
    const raw = localStorage.getItem(UNSEEN_TITLES_KEY);
    unseenTitles = raw ? (JSON.parse(raw) || {}) : {};
  }catch(e){
    unseenTitles = {};
  }
}

function saveUnseenTitles(){
  try{
    localStorage.setItem(UNSEEN_TITLES_KEY, JSON.stringify(unseenTitles || {}));
  }catch(e){}
}

function markTitleUnseen(titleId){
  if(!titleId) return;
  if(!unseenTitles) unseenTitles = {};
  unseenTitles[titleId] = 1;
  saveUnseenTitles();
}

function markTitleSeen(titleId){
  if(!titleId || !unseenTitles) return;
  if(unseenTitles[titleId]){
    delete unseenTitles[titleId];
    saveUnseenTitles();
  }
}

function isTitleUnseen(titleId){
  return !!(unseenTitles && unseenTitles[titleId]);
}

function updateAchievementBadge(){
  const badge = document.getElementById("achievementAlertBadge");
  if(!badge) return;

  // ë¡œê·¸ì¸ ì „ì´ë©´ ìˆ¨ê¹€
  if(!userId || !userRef){
    badge.style.display = "none";
    return;
  }

  // â€œíšë“í–ˆê³  + ì•„ì§ í™•ì¸ ì•ˆ í•œ ì¹­í˜¸â€ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í‘œì‹œ
  let hasNew = false;
  if(unseenTitles && titlesOwned){
    for(const id in unseenTitles){
      if(titlesOwned[id]){
        hasNew = true;
        break;
      }
    }
  }
  badge.style.display = hasNew ? "flex" : "none";
}
  
// changedê°€ trueë©´, í˜¸ì¶œí•œ ìª½ì—ì„œ save() í•œë²ˆë§Œ í•´ì£¼ë©´ ë¨(ì¤‘ë³µ save ë°©ì§€)
function grantTitleOnceNoSave(titleId){
  if(!titleId) return false;
  if(!titlesOwned) titlesOwned = {};
  if(titlesOwned[titleId]) return false;

  titlesOwned[titleId] = Date.now();

  // âœ… ìƒˆë¡œ íšë“í•œ ì¹­í˜¸ëŠ” â€œë¯¸í™•ì¸â€ìœ¼ë¡œ ë“±ë¡ â†’ ì•„ì´ì½˜/ê·¸ë¦¬ë“œì— ! í‘œì‹œ
  markTitleUnseen(titleId);
  updateAchievementBadge();

  return true;
}

function checkAndGrantTitles(){
  let changed = false;

  // ğŸ¦  ì—­ë³‘ì¥: 2ë ˆë²¨ ì‚¬ëƒ¥í„°(ì‹œê¶ì°½) ì‚¬ëƒ¥ 100íšŒ
if (Number(plagueRatHuntCount || 0) >= 100) {
  if (grantTitleOnceNoSave("plague")) changed = true;
}
    // ğŸ’° ë§Œìˆ˜ë¥´: 10ì¡° ê³¨ë“œ ì´ìƒ ë³´ìœ 
  if (Number(gold || 0) >= 10000000000000) {
    if (grantTitleOnceNoSave("mansur")) changed = true;
  }
  // âš”ï¸ ê²°íˆ¬ ì—…ì 
if (Number(bully10Count || 0) >= 10) {
  if (grantTitleOnceNoSave("bully10")) updated = true;
}
if (Number(challenger10Count || 0) >= 10) {
  if (grantTitleOnceNoSave("challenger10")) updated = true;
}
if (Number(brawl500Count || 0) >= 500) {
  if (grantTitleOnceNoSave("brawl500")) updated = true;
}
if (warGodWin) {
  if (grantTitleOnceNoSave("warGod")) updated = true;
}
  // 1) ìƒˆë‚´ê¸° ëŒ€ì¥ì¥ì´: ìµœì´ˆ 1íšŒ ê°•í™” ì„±ê³µ
  if(Number(maxSwordLevel || 0) >= 1 || Number(sword || 0) >= 1){
    changed = grantTitleOnceNoSave("newbie") || changed;
  }

  // 2) ê°•í™” ë‹¨ê³„ ì—…ì 
  const maxLv = Number(maxSwordLevel || 0);
  if(maxLv >= 15) changed = grantTitleOnceNoSave("master15") || changed;   // [ëª…ì¸]
  if(maxLv >= 21) changed = grantTitleOnceNoSave("artisan21") || changed;  // [ì¥ì¸]
  if(maxLv >= 26) changed = grantTitleOnceNoSave("legend26") || changed;   // [ì „ì„¤]
  if(maxLv >= 30) changed = grantTitleOnceNoSave("best30") || changed;     // [ìµœê°•ì]

  // 3) ë¬´ê¸°ë³„ 21ê°• ì¹­í˜¸(ê²€/ì°½/ë„ë¼)
  // - weaponType ê°’ì€ ë„¤ ë­í‚¹ì—ì„œë„ ì“°ê³  ìˆìŒ (users list ì •ë ¬ ë°ì´í„°ì— ë“¤ì–´ê°) :contentReference[oaicite:1]{index=1}
  if(maxLv >= 21){
    if(weaponType === "sword") changed = grantTitleOnceNoSave("knight")  || changed;
    if(weaponType === "spear") changed = grantTitleOnceNoSave("warrior") || changed;
    if(weaponType === "axe")   changed = grantTitleOnceNoSave("viking")  || changed;
  }

  // 4) íŒŒê´´ ì—…ì 
  const dc = Number(destroyCount || 0);
  if(dc >= 100) changed = grantTitleOnceNoSave("destroy100") || changed; // [íŒŒê´´ì™•]
  if(dc >= 500) changed = grantTitleOnceNoSave("destroy500") || changed; // [íŒŒê´´ì‹ ]

  // 5) ë¬´ê¸°ë³„ "ì¢…ì°©ì§€" (30ê°• ë„ë‹¬ ì‹œì ì˜ weaponType ê¸°ì¤€)
  // - ì—¬ê¸°ì„œëŠ” â€œí˜„ì¬ ë¬´ê¸°ê°€ 30 ì´ìƒâ€ì´ë©´ ì§€ê¸‰.
  if(Number(sword || 0) >= 30){
    if(weaponType === "sword") changed = grantTitleOnceNoSave("end_sword") || changed;
    if(weaponType === "axe")   changed = grantTitleOnceNoSave("end_axe")   || changed;
    if(weaponType === "spear") changed = grantTitleOnceNoSave("end_spear") || changed;
    if(weaponType === "dagger") changed = grantTitleOnceNoSave("end_dagger") || changed;
  }

    // ğŸ¹ í™œ ì „ìš© ì¹­í˜¸
  if (weaponType === "bow" && maxSwordLevel >= 21) {
    if (grantTitleOnceNoSave("bow21")) changed = true;
  }

  if (weaponType === "bow" && maxSwordLevel >= 30) {
    if (grantTitleOnceNoSave("bow30")) changed = true;
  }

    // ğŸ”® ìŠ¤íƒœí”„ ì „ìš© ì¹­í˜¸
  if (weaponType === "staff" && maxSwordLevel >= 21) {
    if (grantTitleOnceNoSave("staff21")) changed = true;
  }

  if (weaponType === "staff" && maxSwordLevel >= 30) {
    if (grantTitleOnceNoSave("staff30")) changed = true;
  }

  // ğŸ—¡ ë‹¨ê²€ ì „ìš© ì¹­í˜¸
if (weaponType === "dagger" && maxSwordLevel >= 21) {
  if (grantTitleOnceNoSave("assassin")) changed = true;
}
 
  return changed;
}
  
function openTitleOverlay(){
  const npcImg = document.getElementById("titleNpcImg");
if (npcImg) npcImg.src = "images/npc/linea_idle.png";

  const ov = document.getElementById("titleOverlay");
  if(!ov) return;
  ov.style.display = "flex";

  const lineEl = document.getElementById("titleNpcText");
  if(lineEl) lineEl.textContent = LINEA_LINES[Math.floor(Math.random()*LINEA_LINES.length)];

const sortBtn = document.getElementById("titleSortBtn");
if (sortBtn) {
  sortBtn.onclick = () => {
    titleSortMode = (titleSortMode === "default") ? "recent" : "default";
    sortBtn.textContent = (titleSortMode === "recent") ? "ê¸°ë³¸ì •ë ¬" : "ìµœê·¼íšë“ìˆœ";
    renderTitleGrid();
  };
}
  
  renderTitleGrid();
}

function closeTitleOverlay(){
  const ov = document.getElementById("titleOverlay");
  if(ov) ov.style.display = "none";
  hideActionPopup();
}

  // =====================
// ğŸªŸ ê³µìš© ì•¡ì…˜ íŒì—… (í”„ë¡œí•„ë³´ê¸° ìŠ¤íƒ€ì¼)
// =====================
let actionPopupEl = null;

function ensureActionPopup(){
  if (actionPopupEl) return actionPopupEl;

  const el = document.createElement("div");
  el.id = "actionPopup";
  el.style.display = "none";
  el.style.position = "fixed";
  el.style.zIndex = 10050;
  el.style.minWidth = "160px";
  el.style.padding = "8px";
  el.style.borderRadius = "12px";
  el.style.border = "1px solid rgba(255,255,255,0.18)";
  el.style.background = "rgba(20,20,20,0.96)";
  el.style.boxShadow = "0 10px 25px rgba(0,0,0,0.55)";
  el.style.backdropFilter = "blur(4px)";

  // ë°”ê¹¥ í´ë¦­ ë‹«ê¸°
  el.addEventListener("click", (e) => e.stopPropagation());
  document.addEventListener("click", () => hideActionPopup());
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") hideActionPopup(); });

  document.body.appendChild(el);
  actionPopupEl = el;
  return el;
}

function hideActionPopup(){
  const el = ensureActionPopup();
  el.style.display = "none";
  el.innerHTML = "";
}

function showActionPopupAt(x, y, html){
  const el = ensureActionPopup();
  el.innerHTML = html;

  // í™”ë©´ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ê²Œ ë³´ì •
  el.style.display = "block";
  const rect = el.getBoundingClientRect();
  let nx = x, ny = y;
  if (nx + rect.width > window.innerWidth - 8) nx = window.innerWidth - rect.width - 8;
  if (ny + rect.height > window.innerHeight - 8) ny = window.innerHeight - rect.height - 8;
  if (nx < 8) nx = 8;
  if (ny < 8) ny = 8;

  el.style.left = nx + "px";
  el.style.top  = ny + "px";
}

  // âœ… actionPopupì—ì„œ ì“°ëŠ” ë²„íŠ¼ HTML ìƒì„± (ì—†ìœ¼ë©´ íšë“ ì¹­í˜¸ í´ë¦­ ì‹œ íŒì—…ì´ ì•ˆëœ¸)
function popupBtn(label, onClickJs){
  return `
    <button class="actionBtn" onclick="${onClickJs}">
      ${label}
    </button>
  `;
}

// â€œì¥ì°©ì¤‘â€ í‘œì‹œ + 5x6 ê·¸ë¦¬ë“œ ë Œë”
function renderTitleGrid(){
  const grid = document.getElementById("titleGrid");
  const equippedEl = document.getElementById("equippedTitleText");
  if(!grid) return;

  // ì¥ì°©ì¤‘ í‘œì‹œ
  const eqDef = TITLE_DEFS.find(t => t.id === equippedTitle);
  if(equippedEl){
    equippedEl.textContent = eqDef ? `[${eqDef.name}]` : "(ì—†ìŒ)";
    equippedEl.style = eqDef ? getTitleColorStyle(eqDef.color) + "font-weight:bold;" : "color:#999;";
  }

let defs = [...TITLE_DEFS];

// âœ… ìµœê·¼ íšë“ìˆœ ì •ë ¬ ëª¨ë“œì¼ ë•Œë§Œ ì •ë ¬
if (titleSortMode === "recent") {
  defs.sort((a, b) => {
    const aRaw = titlesOwned?.[a.id];
    const bRaw = titlesOwned?.[b.id];

    // number(timestamp)ë©´ ê·¸ ê°’, trueë©´ 1, ì—†ìœ¼ë©´ 0
    const aTs = (typeof aRaw === "number") ? aRaw : (aRaw ? 1 : 0);
    const bTs = (typeof bRaw === "number") ? bRaw : (bRaw ? 1 : 0);

    // 1) íšë“í•œ ê²ƒ ë¨¼ì €
    if (!!aTs !== !!bTs) return bTs - aTs;

    // 2) ë‘˜ ë‹¤ íšë“ì´ë©´ ìµœê·¼ íšë“ì´ ìœ„
    return bTs - aTs;
  });
}

grid.innerHTML = defs.map(def => {
  const owned = !!(titlesOwned && titlesOwned[def.id]);
  const color = owned ? "#fff" : "#777";
  const border = owned ? "1px solid #666" : "1px solid #333";

  const raw = titlesOwned?.[def.id];
  const ts = (typeof raw === "number") ? raw : 0;
  const earnedText = owned
    ? (ts ? new Date(ts).toLocaleDateString("ko-KR") : "íšë“")
    : "ë¯¸íšë“";

  const isNew = owned && isTitleUnseen(def.id);

  return `
    <div class="titleCell"
         data-id="${def.id}"
         style="position:relative; padding:10px 6px; text-align:center; border:${border}; border-radius:10px; cursor:pointer; color:${color}; user-select:none;">
      ${isNew ? `<div class="icon-alert-badge title-alert-badge" style="display:flex;">!</div>` : ``}

      <div style="font-weight:bold;">${def.name}</div>
      <div style="margin-top:4px; font-size:11px; color:${owned ? "#bbb" : "#555"};">
        ${earnedText}
      </div>
    </div>
  `;
}).join("");

  // í´ë¦­ ë°”ì¸ë”©
  grid.querySelectorAll(".titleCell").forEach(el => {
    el.addEventListener("click", (e) => {
  const id = el.getAttribute("data-id");
  onTitleClick(id, e);
});
  });
}

function onTitleClick(titleId){
  const def = TITLE_DEFS.find(t=>t.id===titleId);
  if(!def) return;

  const owned = !!(titlesOwned && titlesOwned[titleId]);

  // í´ë¦­ ìœ„ì¹˜: ì…€ ì¤‘ì‹¬ ê·¼ì²˜ë¡œ ë„ìš°ê¸° (ë§ˆìš°ìŠ¤ ìœ„ì¹˜ê°€ ì œì¼ ìì—°ìŠ¤ëŸ½)
  const x = (window.event && window.event.clientX) ? window.event.clientX : (window.innerWidth/2);
  const y = (window.event && window.event.clientY) ? window.event.clientY : (window.innerHeight/2);

  // âŒ ë¯¸íšë“ â†’ alert ëŒ€ì‹  â€œíšë“ë°©ë²• íŒì—…â€
  if(!owned){
    const how = def.hiddenHow ? "???" : (def.how || "???");
    showActionPopupAt(x, y, `
      <div class="actionTitle">[${def.name}]</div>
      <div class="actionText">ì¹­í˜¸ íšë“ë°©ë²•:\n${how}</div>
    `);
    return;
  }

  // âœ… íšë“í•œ ì¹­í˜¸ í´ë¦­
  // âœ… â€œìƒˆë¡œ íšë“â€ ë±ƒì§€ í•´ì œ (í•œ ë²ˆ ëˆŒëŸ¬ í™•ì¸í•˜ë©´ ì‚¬ë¼ì§)
  markTitleSeen(titleId);
  updateAchievementBadge();
  renderTitleGrid();

  // 1) ì´ë¯¸ ì¥ì°©ì¤‘ â†’ â€œì¥ì°©í•´ì œâ€ íŒì—…
  if (equippedTitle === titleId) {
    showActionPopupAt(x, y, `
      <div class="actionTitle">[${def.name}]</div>
      ${popupBtn("ì¥ì°©í•´ì œ", "equippedTitle=''; save(); update(); renderTitleGrid(); hideActionPopup();")}
    `);
    return;
  }

  // 2) ì¥ì°©ì¤‘ ì•„ë‹˜ â†’ â€œì¥ì°©í•˜ê¸°â€ íŒì—…
  showActionPopupAt(x, y, `
    <div class="actionTitle">[${def.name}]</div>
    ${popupBtn("ì¥ì°©í•˜ê¸°", "equippedTitle='" + titleId + "'; save(); update(); renderTitleGrid(); hideActionPopup();")}
  `);
}

  // âœ… ì¹­í˜¸ ID â†’ ì¹­í˜¸ ì´ë¦„ ë³€í™˜ (ë³´ìŠ¤ì „ í† ë²ŒëŒ€ ë¦¬ìŠ¤íŠ¸ í‘œê¸°ìš©)
function getTitleNameById(titleId){
  titleId = String(titleId || "");
  const def = TITLE_DEFS.find(t => String(t.id) === titleId);
  return def ? String(def.name || "") : "";
}

// ì˜¤ë²„ë ˆì´: ë°”ê¹¥ í´ë¦­ ë‹«ê¸° + ESC ë‹«ê¸°
document.addEventListener("DOMContentLoaded", () => {
  const ov = document.getElementById("titleOverlay");
  if(ov){
    ov.addEventListener("click", (e) => {
      if(e.target === ov) closeTitleOverlay();
    });
  }

  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape"){
      const ov2 = document.getElementById("titleOverlay");
      if(ov2 && ov2.style.display !== "none") closeTitleOverlay();
    }
  });
});

    // ===============================
  // ğŸ‘† í™”ë©´ í„°ì¹˜/í´ë¦­ ìœ„ì¹˜ ë¦¬í”Œ ì´í™íŠ¸
  // ===============================
  function spawnTouchRipple(x, y){
    const d = document.createElement("div");
    d.className = "touchRipple";
    d.style.left = x + "px";
    d.style.top  = y + "px";
    document.body.appendChild(d);

    // ì• ë‹ˆ ëë‚˜ë©´ ì œê±°
    d.addEventListener("animationend", () => d.remove());
    // ì•ˆì „ì¥ì¹˜(í˜¹ì‹œ animationend ëˆ„ë½ ì‹œ)
    setTimeout(() => { if(d && d.remove) d.remove(); }, 800);
  }

  // pointerdown: ëª¨ë°”ì¼ í„°ì¹˜/PC í´ë¦­ ëª¨ë‘ ì»¤ë²„
  document.addEventListener("pointerdown", (e) => {
    // ì…ë ¥ì°½/ë²„íŠ¼ ë“± UI ì¡°ì‘ì€ êµ³ì´ ì•ˆ ë„ìš°ê³  ì‹¶ìœ¼ë©´ ì œì™¸
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "textarea") return;

    // ìš°í´ë¦­ ì œì™¸(PC)
    if (e.button === 2) return;

    spawnTouchRipple(e.clientX, e.clientY);
  }, { passive: true });

  // ===============================
// ğŸ”Š íŒŒì¼ ì—†ëŠ” UI í´ë¦­ ì‚¬ìš´ë“œ (WebAudio)
// - ëª¨ë°”ì¼ ìë™ì¬ìƒ ì œí•œ ë•Œë¬¸ì— "ì²« ì‚¬ìš©ì ì…ë ¥"ì—ì„œ contextê°€ ì—´ë¦¬ë„ë¡ ì²˜ë¦¬
// ===============================
let uiAudioCtx = null;

function ensureUiAudio(){
  if (!uiAudioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    uiAudioCtx = new AC();
  }
  // iOS ë“± suspended ìƒíƒœë©´ resume í•„ìš”
  if (uiAudioCtx.state === "suspended"){
    uiAudioCtx.resume().catch(()=>{});
  }
  return uiAudioCtx;
}

// ì•„ì£¼ ì§§ì€ "í‹±" (ì²´í¬ë°•ìŠ¤ìš©)
function playUiTick(){
  const ctx = ensureUiAudio();
  if (!ctx) return;

  const t0 = ctx.currentTime;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "square";
  osc.frequency.setValueAtTime(820, t0);

  // ë³¼ë¥¨ ì—”ë²¨ë¡œí”„(ì§§ê³  ì„ ëª…)
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.085, t0 + 0.005);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.05);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start(t0);
  osc.stop(t0 + 0.055);
}

  // ===============================
// ğŸ”Š ê°•í™” ì²´í¬ë°•ìŠ¤(ì£¼ë¬¸ì„œ ì‚¬ìš©) í„°ì¹˜ ì‚¬ìš´ë“œ
// ===============================
document.addEventListener("DOMContentLoaded", () => {
  const wrap = document.getElementById("upgradeItems");
  if (!wrap) return;

  // changeê°€ ì œì¼ ì•ˆì •ì (ë¼ë²¨ ëˆŒëŸ¬ë„ ì²´í¬ ë³€ê²½ì´ë©´ í™•ì‹¤íˆ ë“¤ì–´ì˜´)
  wrap.addEventListener("change", (e) => {
    const t = e.target;
    if (t && t.matches && t.matches('input[type="checkbox"]')){
      playUiTick();
    }
  });
});

// ì¡°ê¸ˆ ë” "í†¡" (ë²„íŠ¼ìš©)
function playUiClick(){
  const ctx = ensureUiAudio();
  if (!ctx) return;

  const t0 = ctx.currentTime;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "triangle";
  osc.frequency.setValueAtTime(520, t0);
  osc.frequency.exponentialRampToValueAtTime(260, t0 + 0.06);

  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(0.65, t0 + 0.006);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.08);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start(t0);
  osc.stop(t0 + 0.085);
}

  // ============================
// ğŸ”Š Dock / Icon Tap SFX (mp3)
// ============================
// íŒŒì¼ëª…: sounds/ui_tap_dock.mp3
const UI_DOCK_TAP_SRC = "sounds/ui_tap_dock.mp3";

// ì—°íƒ€ ëŒ€ë¹„ í’€(ì”¹í˜ ë°©ì§€)
const UI_DOCK_TAP_POOL = Array.from({ length: 4 }, () => {
  const a = new Audio(UI_DOCK_TAP_SRC);
  a.volume = 0.65;
  a.preload = "auto";
  return a;
});
let _uiDockTapIdx = 0;

function playUiDockTap(){
  try{
    const a = UI_DOCK_TAP_POOL[_uiDockTapIdx++ % UI_DOCK_TAP_POOL.length];
    a.currentTime = 0;
    const p = a.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }catch(e){}
}

// âœ… ì²« ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ í™œì„±í™”(ëª¨ë°”ì¼ ëŒ€ì‘)
// (ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ì•„ë¬´ ì¼ë„ ì•ˆ í•¨)
document.addEventListener("pointerdown", () => {
  ensureUiAudio();
}, { once: true });

  // âœ… ìƒë‹¨ ì¬í™”ë°” ê°±ì‹ 
function updateTopCurrencyBar(){
  const goldEl  = document.getElementById("topGoldText");
  const starEl  = document.getElementById("topStarShardText");
  const honorEl = document.getElementById("topHonorMedalText");

  if (goldEl)  goldEl.textContent  = formatGold(Number(gold || 0));
  if (starEl)  starEl.textContent  = Number(starShard || 0).toLocaleString("ko-KR");
  if (honorEl) honorEl.textContent = Number(itemHonorMedal || 0).toLocaleString("ko-KR");
}

  function update() {

   /* ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì˜ì—­ ê°±ì‹  */
  const nameEl = document.getElementById("profileNickname");
  if (nameEl) nameEl.innerHTML = formatNicknameWithTitle(userId, equippedTitle, reach30Count);

  const weaponTitleEl = document.getElementById("profileWeaponTitle");
  const weaponDescEl  = document.getElementById("profileWeaponDesc");
  const maxInfoEl     = document.getElementById("profileMaxInfo");
  const powerEl  = document.getElementById("profilePower");
  const huntEl   = document.getElementById("profileHuntCount");
  const weaponValueEl = document.getElementById("profileWeaponValue");
  const recordEl = document.getElementById("profileRecord");

  if (recordEl) {
    recordEl.textContent = `ìŠ¹ ${duelWin} / íŒ¨ ${duelLose}`;
  }

  // ğŸ”° í˜„ì¬ ê°•í™” ë‹¨ê³„ì— ë”°ë¥¸ ê²€ ì •ë³´
  const wInfo = getWeaponInfo(sword, weaponType || "sword");

  // ê²€ ì´ë¦„ (+í˜„ì¬ê°•)
  if (weaponTitleEl && wInfo) {
    weaponTitleEl.textContent = `${wInfo.name} (+${sword}ê°•)`;
  }

  // ê²€ ì„¤ëª…
  if (weaponDescEl && wInfo) {
    weaponDescEl.textContent = wInfo.desc;
  }

  // ìµœëŒ€ ê°•í™” + íŒŒê´´ níšŒ
  if (maxInfoEl) {
    maxInfoEl.innerHTML =
      `+${maxSwordLevel}ê°• ` +
      `<span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ ${destroyCount}íšŒ)</span>`;
  }

  // âš”ï¸ ê°•í™” ë‹¨ê³„ì— ë§ëŠ” ì´ë¯¸ì§€ë¡œ êµì²´
  updateWeaponImage();

  if (powerEl) {
    powerEl.textContent = formatGold(power);
  }
  if (weaponValueEl) {
    const avgValue = getSellRewardAverage(sword); // í‰ê·  íŒë§¤ê°€
    weaponValueEl.textContent = formatGold(avgValue);
  }
  if (huntEl) {
    const today = getTodayDateString();
    if (lastHuntDate !== today) {
      huntEl.textContent = `0 / 20`;
    } else {
      huntEl.textContent = `${huntCountToday} / 20`;
    }
  }
    
  const statusEl = document.getElementById("status");
  if (statusEl) statusEl.innerHTML = "";

const descEl = document.getElementById("fieldDescription");

const FIELD_DESCRIPTIONS = {
  1: `í•œë•Œ ëª¨í—˜ê°€ë“¤ì˜ ì‰¼í„°ì˜€ë˜ ë§ˆì„.
ì „íˆ¬ë³´ë‹¤ëŠ” ê°ì„ ë˜ì°¾ê³  ëª¸ì„ í’€ê¸°ì— ì í•©í•˜ë‹¤.`,

  2: `ë…ê³¼ ë¶€íŒ¨ê°€ ë’¤ì„ì¸ ë„ì‹œì˜ ë°‘ë°”ë‹¥.
í•œ ë²ˆì˜ ì‹¤ìˆ˜ëŠ” ê³§ ê°ì—¼ì„ ì˜ë¯¸í•œë‹¤.`,

  3: `í˜ê³¼ ë°°ì‹ ë§Œì´ ì§€ë°°í•˜ëŠ” ë•….
ë°©ì‹¬í•œ ìë¶€í„° ì´ê³³ì— ë¬»íŒë‹¤.`,

  4: `ì •ë©´ëŒ€ê²°ë³´ë‹¤ ê¸°ìŠµì„ íƒí•˜ëŠ” ê·¸ë“¤ì˜ ì˜ì—­.
ì ì„ ë³¸ ìˆœê°„ì€ ì´ë¯¸ ëŠ¦ì—ˆì„ì§€ ëª¨ë¥¸ë‹¤.`,

  5: `ì‚´ì„ ë² ì–´ë‚´ëŠ” ëƒ‰ê¸°ì™€ ê³ ë…ì˜ ì „ì¥.
ì˜¤ë˜ ë¨¸ë¬´ëŠ” ìë¶€í„° ë¬´ë„ˆì§„ë‹¤.`,

  6: `ê³¼ê±°ì—” ì°¬ë€í•œ ë¬¸ëª…ì„ ê½ƒí”¼ì› ë˜ ì œêµ­ì´ì˜€ë‹¤ê³ í•œë‹¤.
ì–´ì§¸ì„œì¸ì§€ ì§€ê¸ˆì€ ì£½ìŒì˜ ê¸°ìš´ë§Œ ë‚¨ì•˜ë‹¤.`,

  7: `ë¶„ë…¸ê°€ íƒ€ì˜¤ë¥´ëŠ” ì§€ì˜¥ì˜ ìš”ìƒˆ.
í•œ ë²ˆ ë°€ë¦¬ë©´, ë‹¤ì‹œëŠ” ë°˜ê²©í•  ìˆ˜ ì—†ë‹¤.`,

  8: `ì‹ ì˜ ì‚¬ìë“¤ì´ ì§‘ê²°í•œ ì‹¬íŒì˜ ì„±ì—­.
ì—¬ê¸°ì„œì˜ íŒ¨ë°°ëŠ” ì£„ë¡œ ê¸°ë¡ëœë‹¤.`,

  9: `ì ˆëŒ€ìì˜ ì¡´ì¬ê°ì´ ì˜ì§€ë¥¼ ì§“ëˆŒëŸ¬ ë²„ë¦°ë‹¤.
ê²½ì™¸ì™€ ì˜¤ë§Œì´ ê³µì¡´í•˜ëŠ” ì¥ì†Œ.`,

  10: `ì„¸ê³„ì˜ ê·œì¹™ì´ ë” ì´ìƒ í†µí•˜ì§€ ì•ŠëŠ” ê³µê°„.
ì—¬ê¸°ì„œ ì‚´ì•„ë‚¨ëŠ”ë‹¤ë©´, ì¸ê°„ì´ë¼ ë¶€ë¥¼ ìˆ˜ ì—†ì„ ê²ƒì´ë‹¤.`
};

if (descEl) {
  descEl.innerText = FIELD_DESCRIPTIONS[currentField] || "";
}

  
  // ğŸ”¹ ê°•í™” ì„±ê³µ/ì‹¤íŒ¨ ì •ë³´
  const success = getUpgradeChance(sword);
  let failInfo = "";
  let failRemain = 100 - success; // ì‹¤íŒ¨ ì´ ë¹„ìœ¨

  const midDestroyRatio = {
    16: 0.10,
    17: 0.12,
    18: 0.13,
    19: 0.14
  };

  if (sword <= 10) {
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b> (ìœ ì§€)
    `;
  } else if (sword >= 16 && sword <= 19) {
    const destroy = Math.round(failRemain * midDestroyRatio[sword]);
    const down    = failRemain - destroy;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  } else if (sword <= 20) {
    const keep = Math.round(failRemain * 0.5);
    const down = failRemain - keep;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ìœ ì§€ <b>${keep}%</b> / ê°•ë“± <b>${down}%</b>
    `;
  } else {
    const down = Math.round(failRemain * 0.4);
    const destroy = failRemain - down;
    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  }

  const cost = getUpgradeCost(sword);

  let safeNote = "";
  // âœ… 5, 10, 15, 20ê¹Œì§€ë§Œ ì„¸ì´í”„ / 25ëŠ” ì œì™¸
  if (sword % 5 === 0 && sword !== 0 && sword <= 20) {
    safeNote = `<br><span style="color:#6cf;">
      â€» ì„¸ì´í”„ êµ¬ê°„: ì‹¤íŒ¨í•´ë„ ê°•ë“±/íŒŒê´´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </span>`;
  }

  const upgradeInfoEl = document.getElementById("upgradeInfo");
  if (upgradeInfoEl) {
    upgradeInfoEl.innerHTML = `
      ì„±ê³µ <b>${success}%</b> / ${failInfo}
      <br>í•„ìš” ê³¨ë“œ <b>${formatGold(cost)}</b>
      ${safeNote}
    `;
  }

  // ğŸ¯ ì‚¬ëƒ¥ ì •ë³´ UI ì—…ë°ì´íŠ¸
  const field = HUNT_FIELDS[currentField];
  const huntSuccess = getHuntSuccessChance(sword, currentField);

  const fieldInfoEl = document.getElementById("currentFieldInfo"); // ì¹´ë“œ ìœ„ í…ìŠ¤íŠ¸
  const huntBtnEl   = document.getElementById("huntBtn");
    
  // ğŸ—º ì¹´ë“œ ìœ„ì— í˜„ì¬ ì‚¬ëƒ¥í„° + ë ˆë²¨ + ì„±ê³µí™•ë¥  í‘œì‹œ
  if (field && fieldInfoEl) {
    const huntSuccess = getHuntSuccessChance(sword, currentField);

    fieldInfoEl.innerHTML = `
      <div style="font-size: 21px; font-weight: bold;">
        ${field.name}
      </div>
      <div class="current-field-info-sub">
        ì¶”ì²œ ë ˆë²¨: +${field.recLevel}ê°•
        &nbsp;/&nbsp;
        ë‚´ ë ˆë²¨: +${sword}ê°•
        &nbsp;/&nbsp;
        ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥ : ${huntSuccess}%
      </div>
    `;
  }

    updateTopCurrencyBar();

  // ğŸ†• ì‚¬ëƒ¥ ìŠ¤íƒœë¯¸ë‚˜ UI ê°±ì‹ 
  updateHuntUI();
  
// ğŸ†• ê²°íˆ¬ ë‚¨ì€ íšŸìˆ˜ UI ê°±ì‹ 
updateDuelUI();
  
  // ğŸ”¥ í˜„ì¬ ì‚¬ëƒ¥í„° ë°°ê²½ ì ìš© (CSS ::beforeìš© ë³€ìˆ˜ ì„¸íŒ…)
  applyFieldBackground();

  updateHonorHallButton();

    // âœ… ê°•í™” ì•„ì´í…œ ë¼ë²¨ ìˆ˜ëŸ‰ ê°±ì‹ 
  updateUpgradeItemLabels();

}

// âš”ï¸ ê²°íˆ¬ ì¼ì/ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
function ensureDuelDate() {
  const today = getTodayDateString();
  if (lastDuelDate !== today) {
    lastDuelDate = today;
    duelCountToday = 0;
    duelTargetsToday = {};
  }
}

  // ğŸ‡°ğŸ‡· í•œêµ­ì‹œê°„(UTC+9) ê¸°ì¤€ ì£¼ í‚¤ ìƒì„±
function getKstWeekKey() {

  const now = new Date();

  // í•œêµ­ ì‹œê°„ ë³´ì • (+9ì‹œê°„)
  const kst = new Date(now.getTime() + (9 * 60 * 60 * 1000));

  const year = kst.getUTCFullYear();

  // í•´ë‹¹ ì—°ë„ 1ì›” 1ì¼(KST ê¸°ì¤€)
  const start = new Date(Date.UTC(year, 0, 1));

  // ê²½ê³¼ ì¼ìˆ˜
  const days = Math.floor((kst - start) / (24 * 60 * 60 * 1000));

  // 1ì£¼ ë‹¨ìœ„ë¡œ ì¸ë±ì‹±
  const week = Math.floor(days / 7) + 1;

  // ì˜ˆ: 2026-W03
  return `${year}-W${String(week).padStart(2, "0")}`;
}

// ğŸ—“ ì§€ë‚œì£¼(ì›”ìš”ì¼ 00:00 ~ ì´ë²ˆ ì£¼ ì›”ìš”ì¼ 00:00) KST ë²”ìœ„(ms) êµ¬í•˜ê¸°
function getLastWeekRangeKst() {
  const now = getKstNow();
  const day = now.getDay();                 // 0=ì¼, 1=ì›”, ... 6=í† 
  const diffToMonday = (day + 6) % 7;       // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ê¹Œì§€ ë©°ì¹  ë˜ëŒë¦´ì§€
  const thisMonday = new Date(
    now.getTime() - diffToMonday * 24 * 60 * 60 * 1000
  );
  const lastMonday = new Date(
    thisMonday.getTime() - 7 * 24 * 60 * 60 * 1000
  );

  return {
    start: lastMonday.getTime(),   // ì§€ë‚œì£¼ ì›”ìš”ì¼ 00:00
    end: thisMonday.getTime()      // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ 00:00 (ì§ì „ê¹Œì§€ê°€ ì§€ë‚œì£¼)
  };
}
  
  // ğŸ‡°ğŸ‡· í•œêµ­ì‹œê°„ ê¸°ì¤€ ì›”ìš”ì¼ 00:00~00:10 ê²°íˆ¬ì¥ ì§‘ê³„ ì‹œê°„ ì—¬ë¶€
function isDuelSettlementTimeKST() {
  const now = new Date();

  // KST = UTC+9 ë³´ì •
  const kst = new Date(now.getTime() + 9 * 60 * 60 * 1000);

  const day = kst.getUTCDay();    // ì¼:0, ì›”:1, ... í† :6
  const hour = kst.getUTCHours(); // 0~23
  const minute = kst.getUTCMinutes(); // 0~59

  // ì›”ìš”ì¼ì´ë©´ì„œ 00ì‹œ 00ë¶„ ~ 00ì‹œ 09ë¶„(00:10 ì§ì „)ê¹Œì§€
  if (day === 1 && hour === 0 && minute < 10) {
    return true;
  }
  return false;
}

// ğŸŒ™ ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì •ë¦¬
// ğŸŒ™ ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì •ë¦¬
function ensureDuelWeek() {
  const weekKey = getKstWeekKey();   // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì£¼ í‚¤
  currentWeekKey = weekKey;

  // ğŸ”° ì²˜ìŒ ì ‘ì†í•œ ê²½ìš° (ê²°íˆ¬ ì‹œìŠ¤í…œ ìµœì´ˆ ì ìš© / ì‹ ê·œ ê³„ì •)
  if (!duelPointWeekKey) {
    duelPointWeekKey = weekKey;

    // "ì§€ë‚œ ì£¼"ë¼ëŠ” ê°œë… ìì²´ê°€ ì—†ìœ¼ë¯€ë¡œ, ë³´ìƒë„ ì—†ëŠ” ìƒíƒœë¡œ ì´ˆê¸°í™”
    duelLastWeekPoint = 0;
    duelLastWeekRank = 0;
    duelLastWeekRewardClaimed = true;   // ì§€ë‚œì£¼ ë³´ìƒì€ ì—†ë‹¤ê³  ê°„ì£¼

    return;
  }

// ğŸ—“ ì£¼ì°¨ê°€ ë°”ë€Œì—ˆìœ¼ë©´ ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ + ê°±ì‹  ì‹œê° ìŠ¤ëƒ…ìƒ· ì €ì¥ í›„, ì´ë²ˆ ì£¼ ì´ˆê¸°í™”
if (duelPointWeekKey !== weekKey) {
  // ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ & ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê° ìŠ¤ëƒ…ìƒ·
  duelLastWeekPoint   = duelPoint;
  duelLastWeekUpdated = duelUpdated || 0;

  // ì§€ë‚œ ì£¼ ë­í‚¹ì€ ìƒˆë¡œ ì§‘ê³„í•  ì˜ˆì •ì´ë¯€ë¡œ ì´ˆê¸°í™”
  duelLastWeekRank = 0;

  // "ìƒˆ ì£¼ê°€ ì‹œì‘ëë‹¤ â†’ ì§€ë‚œì£¼ ë³´ìƒì€ ì•„ì§ ì•ˆ ë°›ì€ ìƒíƒœ"ë¡œ í‘œì‹œ
  duelLastWeekRewardClaimed = false;

  // ì´ë²ˆ ì£¼ í¬ì¸íŠ¸/ê°±ì‹  ì‹œê° ë¦¬ì…‹
  duelPoint   = 0;
  duelUpdated = 0;

  // ì´ë²ˆ ì£¼ ì£¼ì°¨ í‚¤ ê°±ì‹ 
  duelPointWeekKey = weekKey;
}
}
// âš”ï¸ ì‹¤ì œ ê²°íˆ¬ ì²˜ë¦¬
// targetUserId : ë„ì „ ëŒ€ìƒ ìœ ì € ì•„ì´ë””
// isRandomMatch: ëœë¤ë§¤ì¹­ ì—¬ë¶€ (trueë©´ ê°™ì€ ìƒëŒ€ 3íšŒ ì œí•œ ë¯¸ì ìš©)
function performDuel(targetUserId, isRandomMatch) {
  if (!userId || !userRef) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

    // ì´ë¯¸ VS í™”ë©´ì´ ë–  ìˆìœ¼ë©´ ì¶”ê°€ ê²°íˆ¬ ì‹ ì²­ ë§‰ê¸°
  if (isDueling) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì ê¹, ì•„ì§ ì§€ë‚œ ê²°íˆ¬ ê²°ê³¼ë„ ì•ˆ ë‚˜ì™”ì–ë‚˜.
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ë¨¼ì € ì € ê²€ë“¤ì˜ ìŠ¹ë¶€ë¶€í„° ì§€ì¼œë³´ë„ë¡ í•˜ì§€.
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

    // ğŸ•’ ì§‘ê³„ ì‹œê°„ ê²°íˆ¬ ê¸ˆì§€ (ì„ íƒì‚¬í•­)
  if (isDuelSettlementTimeKST()) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì ê¹ ë©ˆì¶°ë¼, ì§€ê¸ˆì€ ê²°íˆ¬ë¥¼ ê¸°ë¡í•˜ëŠ” ì¤‘ì´ë‹¤.
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ì›”ìš”ì¼ 00:00~00:10ì—ëŠ” ê²°íˆ¬ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ì–´.
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

  // âœ… ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì£¼ì°¨ ì²´í¬ (ì£¼ ë°”ë€Œë©´ í¬ì¸íŠ¸ ë¦¬ì…‹)
  ensureDuelWeek();
  
  // ë‚ ì§œ ë°”ë€Œì—ˆìœ¼ë©´ ì˜¤ëŠ˜ ì¹´ìš´íŠ¸ ë¦¬ì…‹
  ensureDuelDate();

  // âœ… í•˜ë£¨ ì´ 10íšŒ ì œí•œ
  if (duelCountToday >= 10) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì´ë´, ì˜¤ëŠ˜ì€ ì—¬ê¸°ê¹Œì§€ë‹¤!
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ìŠ¹ë¶€ëŠ” ì‰¬ì–´ì•¼ ë” ëœ¨ê²ì§€.<br>
        <span style="color:#ccc;">(í•˜ë£¨ 10íšŒ ê²°íˆ¬ ì œí•œ)</span>
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

  // âœ… ê°™ì€ ìƒëŒ€ì—ê²Œ í•˜ë£¨ 3íšŒê¹Œì§€ (ì§ì ‘ ë„ì „ë§Œ)
  if (!isRandomMatch) {
    const cnt = duelTargetsToday[targetUserId] || 0;
    if (cnt >= 3) {
      showNpcMessage(
        `
        <div style="font-size:16px; font-weight:bold;">
          ê·¸ë§Œí•´, ê·¸ ìƒëŒ€ëŠ” ì´ë¯¸ ì¶©ë¶„íˆ ë‘ë“¤ê²¨ íŒ¼ì–ì•„?
        </div>
        <div style="margin-top:4px; font-size:13px;">
          ë‹¤ë¥¸ ì „ì¥ë„ í•œë²ˆ ëŒì•„ë³´ë¼ê³ .<br>
          <span style="color:#ccc;">(ê°™ì€ ìƒëŒ€ í•˜ë£¨ 3íšŒ ì œí•œ)</span>
        </div>
        `,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
      return;
    }
  }

  // ğŸ” ìƒëŒ€ ìœ ì € ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  const targetRef = db.ref("users/" + targetUserId);
  targetRef.once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    const t = snap.val();

    const targetWeaponType = t.weaponType || "sword";
    const targetSword = Number(t.sword ?? 0);
    let targetPower = Number(t.power ?? 0);

    const attackerLvHtml = coloredLevel(sword);        // ë‚´ +00ê°• (ì»¬ëŸ¬ í¬í•¨)
    const defenderLvHtml = coloredLevel(targetSword);  // ìƒëŒ€ +00ê°• (ì»¬ëŸ¬ í¬í•¨)

    // ìƒëŒ€ ì „íˆ¬ë ¥ì´ 0ì´ê±°ë‚˜ êµ¬ë²„ì „ì´ë©´ ëŒ€ëµì ì¸ ê³µê²©ë ¥ìœ¼ë¡œ ëŒ€ì‹  ì‚¬ìš©
    if (!targetPower || targetPower <= 0) {
      targetPower = getBaseAttack(targetSword);
    }

    // ë‚´ ì „íˆ¬ë ¥ë„ ì•ˆì „í•˜ê²Œ ë³´ì •
    if (!power || power <= 0) {
      rollPowerForCurrentSword();
    }

    const A = Math.max(1, Number(power));
    const B = Math.max(1, Number(targetPower));
    const sum = A + B;

    const winProb = sum > 0 ? (A / sum) : 0.5;
    const isWin = Math.random() < winProb;

    // ğŸ’° ë³´ìƒ ê³¨ë“œ: ìƒëŒ€ ë¬´ê¸° ê°•í™”ë¹„ìš©ì˜ 2.5ë°° ~ 2.8ë°° â†’ 1/3ë¡œ ì¶•ì†Œ
    const baseLevel = Math.min(targetSword, 29);
    const baseCost = getUpgradeCost(baseLevel);
    const rewardGold = isWin
      ? Math.floor((baseCost * randRange(2.5, 2.8)) / 3)
      : 0;

        // ğŸ´ VS í™”ë©´ì— ì“¸ ë¬´ê¸° ì •ë³´
    const myWeaponInfo     = getWeaponInfo(sword, weaponType || "sword");           // ë‚´ íƒ€ì…
    const targetWeaponInfo = getWeaponInfo(targetSword, targetWeaponType || "sword"); // ìƒëŒ€ íƒ€ì…


    // ğŸ§¾ VS ì˜¤ë²„ë ˆì´ ë¨¼ì € ë„ìš°ê¸°
    showDuelBattleOverlay({
      myName: userId,
      myLevelHtml: attackerLvHtml,
      myPower: A,
      myWeaponInfo,
      targetName: targetUserId,
      targetLevelHtml: defenderLvHtml,
      targetPower: B,
      targetWeaponInfo
    });

    // â³ 2~3ì´ˆ ë’¤ì— ì‹¤ì œ ê²°ê³¼ ì²˜ë¦¬
    const delay = 2000 + Math.random() * 1000; // 2000~3000ms

    setTimeout(() => {
      // ğŸ”¢ ì¹´ìš´íŠ¸/ì „ì  ê°±ì‹ 
      duelCountToday++;

      if (!isRandomMatch) {
        const prev = duelTargetsToday[targetUserId] || 0;
        duelTargetsToday[targetUserId] = prev + 1;
      }

      if (isWin) {
        duelWin++;

        // ğŸ’° ê³¨ë“œ ì§€ê¸‰
        if (rewardGold > 0) {
          gold += rewardGold;
        }

        // ğŸ… ëª…ì˜ˆì˜ í›ˆì¥ ê³„ì‚°
        let honorGain = 0;
        const diff = targetSword - sword; // ìƒëŒ€ - ë‚˜

        // ğŸ·ï¸ ê²°íˆ¬ ì—…ì  ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
// ì‹¸ì›€ê¾¼: ê²°íˆ¬ ëˆ„ì  íšŸìˆ˜
brawl500Count = Number(brawl500Count || 0) + 1;

// ê°•ì•½ì•½ê°•: ë³¸ì¸ë³´ë‹¤ ê°•í™”ê°€ ë‚®ì€ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ 10íšŒ (ìŠ¹íŒ¨ ë¬´ê´€, "ì‹œë„" ê¸°ì¤€)
if (!isRandomMatch && diff < 0) {
  bully10Count = Number(bully10Count || 0) + 1;
}

// ë„ì „ì/íˆ¬ì‹ : ìŠ¹ë¦¬ ê¸°ì¤€
if (isWin) {
  // ë„ì „ì: ë³¸ì¸ë³´ë‹¤ ê°•í•œ ìƒëŒ€ì—ê²Œ ì§€ì •ë§¤ì¹­ ìŠ¹ë¦¬ 10íšŒ
  if (!isRandomMatch && diff > 0) {
    challenger10Count = Number(challenger10Count || 0) + 1;
  }

  // íˆ¬ì‹ : ë³¸ì¸ë³´ë‹¤ 4ê°• ì´ìƒ ë†’ì€ ìƒëŒ€ì—ê²Œ ìŠ¹ë¦¬ 1íšŒ
  if (diff >= 4) {
    warGodWin = true;
  }
}

        if (diff >= 5) {
          honorGain = 40;
        } else if (diff === 4) {
          honorGain = 28;
        } else if (diff === 3) {
          honorGain = 18;
        } else if (diff === 2) {
          honorGain = 10;
        } else if (diff === 1) {
          honorGain = 5;
        } else if (diff === 0) {
          honorGain = 3;
        } else if (diff === -1) {
          honorGain = 1;
        } else {
          honorGain = 0; // diff <= -2
        }

        // ğŸ² ëœë¤ë§¤ì¹­ ë³´ë„ˆìŠ¤ +1
// ê¸°ë³¸ í›ˆì¥ì´ 0ì´ì–´ë„ ëœë¤ë§¤ì¹­ì´ë©´ +1 ì§€ê¸‰
if (isRandomMatch) {
  honorGain += 1;
}

// ğŸ‘‡ í•­ìƒ íŒì—…ì„ ë„ìš´ë‹¤
let npcHtml = "";

// ğŸ… í›ˆì¥ ì§€ê¸‰ (0ê°œì¼ ìˆ˜ë„ ìˆìŒ)
itemHonorMedal += honorGain;

// ğŸ”¹ ëª…ì˜ˆì˜ í›ˆì¥ ì§€ê¸‰
if (honorGain > 0) {
  itemHonorMedal += honorGain;
}

// ğŸ”¹ ê²°íˆ¬ í¬ì¸íŠ¸ëŠ” "ëª…ì˜ˆì˜ í›ˆì¥ê³¼ ë™ì¼í•œ ì–‘"ìœ¼ë¡œ ëˆ„ì 
if (honorGain > 0) {
  duelPoint += honorGain;
  duelUpdated = Date.now();
}

// ğŸ¤ ì¹´ë¥´ë‹ˆì•„ ëŒ€ì‚¬ ë¶„ê¸°

if (honorGain > 0) {

  // ìƒìœ„ ìƒëŒ€ ê²©íŒŒ
  if (diff >= 2) {
    npcHtml = `
      <div style="font-size:18px; font-weight:bold; color:#FFD700;">
        ë¶ˆë¦¬í•œ ìŠ¹ë¶€ì˜€ëŠ”ë°ë„ ì˜ ë²„í…¼ë„¤.
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì´ ì •ë„ë©´ ì¸ì •ì´ì§€.<br>
        ëª…ì˜ˆì˜ í›ˆì¥ ${honorGain}ê°œ, ì±™ê²¨ë‘ë„ë¡ í•´.
      </div>
    `;
  }

  // ë¼ì´ë²Œ / ë¹„ìŠ·í•œ êµ¬ê°„
  else if (diff >= -1 && diff <= 1) {
    npcHtml = `
      <div style="font-size:18px; font-weight:bold; color:#FFD700;">
        ê½¤ ê·¼ì‚¬í•œ ìŠ¹ë¶€ì˜€ì–´.
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì´ë²ˆ íŒì€ ë„¤ ì†ì„ ë“¤ì–´ì¤˜ì•¼ê² ë„¤.<br>
        ëª…ì˜ˆì˜ í›ˆì¥ ${honorGain}ê°œ, ê¸°ë¡ì— ë‚¨ê²¨ë‘ì§€.
      </div>
    `;
  }

  // ì‚´ì§ ì•„ë˜ ìƒëŒ€
  else {
    npcHtml = `
      <div style="font-size:18px; font-weight:bold; color:#FFD700;">
        ëª¸ í’€ê¸°ì—” ê´œì°®ì€ ìƒëŒ€ë¡œêµ°.
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ìŠ¹ë¶€ëŠ” ìŠ¹ë¶€ì§€.<br>
        ëª…ì˜ˆì˜ í›ˆì¥ ${honorGain}ê°œ ì§€ê¸‰í–ˆë‹¤.
      </div>
    `;
  }

} else {

  // â­ í›ˆì¥ 0ê°œ ì „ìš© ëŒ€ì‚¬ (ìƒˆë¡œ ì¶”ê°€)

  npcHtml = `
    <div style="font-size:18px; font-weight:bold; color:#CCCCCC;">
      í˜ì˜ ì°¨ì´ê°€ ì¢€ ë§ì´ ë‚¬ì§€.
    </div>
    <div style="margin-top:6px; font-size:14px;">
      ì´ë²ˆ íŒì€ ê¸°ë¡ë§Œ ë‚¨ê²¨ë‘ê² ë‹¤.<br>
      ë‹¤ìŒì—” ë„¤ê²Œ ë§ëŠ” ìƒëŒ€ë¥¼ ê³¨ë¼ë´.
    </div>
  `;
}

// ğŸ¯ í•­ìƒ íŒì—… ì¶œë ¥
showNpcMessage(
  npcHtml,
  "images/npc/duel_carnia.png",
  true,
  "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
);

// ğŸ§¾ ë¡œê·¸ (ê²°ê³¼ë§Œ ë‚¨ê¹€)
let logMsg = isRandomMatch
  ? `${userId}ë‹˜(${attackerLvHtml})ì´ ëœë¤ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ${targetUserId}ë‹˜(${defenderLvHtml})ê³¼ì˜ ê²°íˆ¬ì—ì„œ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤!`
  : `${userId}ë‹˜(${attackerLvHtml})ì´ ${targetUserId}ë‹˜(${defenderLvHtml})ê»˜ ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ìŠ¹ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤!`;

writeLog(logMsg);

      } else {
        // âŒ íŒ¨ë°°
        duelLose++;

        showNpcMessage(
          `
          <div style="font-size:18px; font-weight:bold; color:#FF6666;">
            ì“°ëŸ¬ì¡Œì§€ë§Œ, ê½¤ ê·¼ì‚¬í–ˆëŠ”ê±¸?
          </div>
          <div style="margin-top:6px; font-size:14px;">
            ì´ë²ˆ íŒì€ ì €ìª½ ì†ì„ ë“¤ì–´ì¤˜ì•¼ê² ë„¤.<br>
            ë³´ìƒì€ ì—†ì§€ë§Œ, ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ë…¸ë ¤ë´!
          </div>
          `,
          "images/npc/duel_carnia.png",
          true,
          "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
        );

        const logMsg = isRandomMatch
          ? `${userId}ë‹˜(${attackerLvHtml})ì´ ëœë¤ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ ${targetUserId}ë‹˜(${defenderLvHtml})ê³¼ì˜ ê²°íˆ¬ì—ì„œ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤...`
          : `${userId}ë‹˜(${attackerLvHtml})ì´ ${targetUserId}ë‹˜(${defenderLvHtml})ê»˜ ê²°íˆ¬ë¥¼ ì‹ ì²­í•˜ì—¬ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤...`;

        writeLog(logMsg);
      }

      update();
      save();

      // VS í™”ë©´ ë‹«ê¸°
      hideDuelBattleOverlay();
    }, delay);

  });
}
  
// âš”ï¸ ê²°íˆ¬ ì‹ ì²­ í™•ì¸ íŒì—… (ì§ì ‘ ê²°íˆ¬ ì‹ ì²­ ì „ìš©)
function showDuelConfirmPopup(targetUserId) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ§â€â™€ï¸ ì¹´ë¥´ë‹ˆì•„ ì„¸íŒ…
  setNpcName("ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸");
  imgEl.src = "images/npc/duel_carnia.png";

  // ğŸ—¨ ì¹´ë¥´ë‹ˆì•„ ë§íˆ¬ë¡œ ëŒ€ì‚¬ êµì²´
  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ì¢‹ì•„, ìŠ¹ë¶€ë¥¼ ê³ í•˜ëŠ”êµ°!
    </div>
    <div style="font-size:14px; line-height:1.5;">
      ì •ë§ë¡œ <b>${targetUserId}</b>ì™€(ê³¼) ì •ì •ë‹¹ë‹¹íˆ ë§ì„œê² ë‚˜?
    </div>
  `;

  // ë²„íŠ¼ ë…¸ì¶œ + í…ìŠ¤íŠ¸ ë³€ê²½
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "ê²°íˆ¬í•œë‹¤!";
  cancelBtn.textContent = "ì ê¹ë§Œâ€¦";

  okBtn.onclick = function () {
    popup.style.display = "none";
    // ì§ì ‘ ì‹ ì²­ì€ isRandomMatch = false
    performDuel(targetUserId, false);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
  };

  popup.style.display = "flex";
}
  
function showNpcMessage(
  text,
  imgPath = "images/npc/blacksmith_idle.png",
  showButton = true,
  npcName = "ëŒ€ì¥ì¥ì´ â€“ í¼ê·¸ë€íŠ¸"
) {
  // ğŸ”¹ imgPathê°€ nullì´ë©´ NPC ì—†ì´ ì“°ëŠ” 'ì‹œìŠ¤í…œ íŒì—…' ëª¨ë“œ
  const noNpc = (imgPath === null);

  // ì¶œì„ ê°™ì€ ì‹œìŠ¤í…œ íŒì—…ì´ë©´ ì´ë¦„ ë¹„ìš°ê¸°, ì•„ë‹ˆë©´ ê¸°ë³¸/ì§€ì •ëœ NPC ì´ë¦„ ì‚¬ìš©
  setNpcName(noNpc ? "" : npcName);

  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) {
    alert(text);
    return;
  }

  // ì•ˆë‚´ ë¬¸êµ¬ ì„¸íŒ…
  msgEl.innerHTML = text;

  // ğŸ”¹ NPC ì´ë¯¸ì§€ ì²˜ë¦¬
  if (noNpc) {
    // ì¶œì„ ë“±: NPC ì—°ì¶œ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ
    imgEl.style.display = "none";
  } else {
    imgEl.style.display = "block";
    imgEl.src = imgPath;
  }

  // ë²„íŠ¼ ì²˜ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼)
  if (showButton) {
    okBtn.style.display = "inline-block";
    okBtn.textContent = "í™•ì¸";
    okBtn.onclick = closeNpcPopup;
  } else {
    okBtn.style.display = "none";
  }

  cancelBtn.style.display = "none";
  cancelBtn.onclick = closeNpcPopup;

  popup.style.display = "flex";
}

// âŒ¨ï¸ ì—”í„° í‚¤ë¡œ NPC íŒì—… "í™•ì¸" ëˆ„ë¥´ê¸° (í•œ ë²„íŠ¼ íŒì—… ì „ìš©)
window.addEventListener("keydown", function (e) {
  if (e.key !== "Enter") return;

  const popup = document.getElementById("npcPopup");
  if (!popup) return;

  // íŒì—…ì´ ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ë¬´ì‹œ
  if (popup.style.display === "none" || popup.style.display === "") return;

  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!okBtn || !cancelBtn) return;

  // âœ… "í™•ì¸"ë§Œ ìˆëŠ” íŒì—…ì¼ ë•Œë§Œ ì—”í„°ë¡œ ì‘ë™í•˜ê²Œ (íŒë§¤í™•ì¸ ê°™ì€ ê±´ ë³´í˜¸)
  const okVisible     = okBtn.style.display !== "none";
  const cancelVisible = cancelBtn.style.display !== "none";

  if (okVisible && !cancelVisible) {
    e.preventDefault();   // í¼ ì œì¶œ ê°™ì€ ê¸°ë³¸ í–‰ë™ ë§‰ê¸°
    okBtn.click();        // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
  }
});

  
// í”„ë¡œí•„ ì €ì¥ ìƒíƒœ í…ìŠ¤íŠ¸ í‘œì‹œ
let profileSaveTimer = null;

function setProfileSaveStatus(message, durationMs) {
  const el = document.getElementById("profileSaveStatus");
  if (!el) return;

  el.textContent = message;
  el.style.opacity = "1";

  if (profileSaveTimer) {
    clearTimeout(profileSaveTimer);
    profileSaveTimer = null;
  }

  if (durationMs && durationMs > 0) {
    profileSaveTimer = setTimeout(() => {
      el.style.opacity = "0";
    }, durationMs);
  }
}
  // ğŸ“· í”„ë¡œí•„ ì¹´ë“œ ìº¡ì³ í›„ ì´ë¯¸ì§€ ì €ì¥
function saveProfileCard() {

  const card = document.getElementById("fieldBg");

  setProfileSaveStatus("ì €ì¥ì¤‘ ...", 0);

  // âœ… ìº¡ì³ ì „ìš© ëª¨ë“œ í™œì„±í™”
  document.body.classList.add("capture-mode");

  html2canvas(card, {
    scale: 2,
    useCORS: true
  }).then(canvas => {

    // â¬… ì €ì¥ í›„ ì›ë˜ í™”ë©´ ë³µêµ¬
    document.body.classList.remove("capture-mode");

    canvas.toBlob(function (blob) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${userId}_profile_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);

      setProfileSaveStatus("ì €ì¥ì™„ë£Œ !", 1500);
    });

  }).catch(err => {

    // â›” ì˜¤ë¥˜ ë°œìƒí•´ë„ í™”ë©´ ë³µêµ¬
    document.body.classList.remove("capture-mode");
    setProfileSaveStatus("ì €ì¥ ì‹¤íŒ¨...", 2000);
  });
}

  // âš ï¸ 25ê°• ì´ìƒ ì„¸ì´í”„ì¡´ ì‚­ì œ ì•ˆë‚´ íŒì—…
function showUpgradeWarning25() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // NPC ì´ë¦„ / ì´ë¯¸ì§€ ì„¸íŒ… (ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸)
  setNpcName("ëŒ€ì¥ì¥ì´ â€“ í¼ê·¸ë€íŠ¸");
  imgEl.src = "images/npc/blacksmith_idle.png";

  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px; color:#FFCC00;">
      âš ï¸ 25ê°• ì´ìƒ êµ¬ê°„ ì•ˆë‚´
    </div>
    <div style="font-size:14px; line-height:1.6;">
      25ê°•ë¶€í„°ëŠ” ë” ì´ìƒ <b>ì„¸ì´í”„ì¡´ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ë„¤.</b><br>
      ì‹¤íŒ¨í•˜ë©´ <b>ê°•ë“±</b>ì´ë‚˜ <span style="color:#FF5555;">íŒŒê´´</span>ê°€<br>
      ì–¸ì œë“  ì¼ì–´ë‚  ìˆ˜ ìˆì§€.
      <br><br>
      ê·¸ë˜ë„â€¦ ê³„ì† ë„ì „í•˜ê² ë‚˜?
    </div>
  `;

  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";

  okBtn.textContent = "ê·¸ë˜ë„ ë„ì „í•œë‹¤";
  cancelBtn.textContent = "ìƒê°í•´ë³¸ë‹¤";

  okBtn.onclick = function () {
    popup.style.display = "none";
    hasSeen25Warning = true;          // ì´í›„ë¡  ê²½ê³  ë‹¤ì‹œ ì•ˆ ëœ¸
    ignoreNextUpgradeWarning = true;  // ì´ë²ˆì— í•œ ë²ˆì€ ê²½ê³  ìŠ¤í‚µí•˜ê³  upgrade ì¬í˜¸ì¶œ
    upgrade();                        // ì‹¤ì œ ê°•í™” ë¡œì§ ë‹¤ì‹œ ì§„ì…
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
  };

  popup.style.display = "flex";
}

function showTutorialIfFirstTime() {

  if (!userId) return;   // ë¡œê·¸ì¸ ì•ˆ ëìœ¼ë©´ ìˆ˜í–‰ ì•ˆ í•¨

  const key = getTutorialKeyForUser(userId);

  try {
    if (localStorage.getItem(key) === "1") return;
  } catch (e) {}

  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}


function closeTutorial() {
  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) overlay.style.display = "none";

  if (!userId) return;

  const key = getTutorialKeyForUser(userId);

  try {
    localStorage.setItem(key, "1");
  } catch (e) {}
}
  
function closeNpcPopup() {
  const popup = document.getElementById("npcPopup");
  if (popup) popup.style.display = "none";
}

  // ğŸ”¥ ê°•í™” ê²°ê³¼ ì—°ì¶œ (ë¶‰ì€ / í™©ê¸ˆ í”Œë˜ì‹œ)
function playUpgradeFlash(mode) {
  const overlay = document.getElementById("upgradeFlashOverlay");
  if (!overlay) return;

  // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ ì´ˆê¸°í™”
  overlay.classList.remove("flash-red", "flash-gold");

  // ê°™ì€ í´ë˜ìŠ¤ë¥¼ ë‹¤ì‹œ ì¤„ ë•Œ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒ ê°•ì œ
  void overlay.offsetWidth; 

  if (mode === "red") {
    overlay.classList.add("flash-red");
  } else if (mode === "gold") {
    overlay.classList.add("flash-gold");
  }
}

// ğŸ§­ ì‚¬ëƒ¥í„° ì´ë™ ì „ìš© íŒì—… (NPC ì´ë¯¸ì§€/ë²„íŠ¼ ìˆ¨ê¹€)
function showMovePopup() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName"); 

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ”¹ NPC ì´ë¦„ ì§€ìš°ê¸°
  if (nameEl) nameEl.textContent = "";
  
  // ì´ë¯¸ì§€ / ë²„íŠ¼ ì „ë¶€ ìˆ¨ê¸°ê³ , í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
  imgEl.style.display = "none";
  okBtn.style.display = "none";
  cancelBtn.style.display = "none";

  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
      ì‚¬ëƒ¥í„° ì´ë™ ì¤‘...
    </div>
  `;

  popup.style.display = "flex";
}

  // ğŸ§­ ì›”ë“œë§µ POI ì´ë™ í™•ì¸ íŒì—… (NPC ì—†ìŒ / ë„¤Â·ì•„ë‹ˆì˜¤)
function showWorldMapMoveConfirm(fieldId, fieldName, recommendLvText) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !okBtn || !cancelBtn) return;

    // âœ… ì ê¸ˆ(ì„±ê³µë¥  0%) ì‚¬ëƒ¥í„°ëŠ” ì´ë™ ë¶ˆê°€ + ì•ˆë‚´ íŒì—…
  const field = HUNT_FIELDS[fieldId];
  if (fieldId !== 0 && field) {
    const chance = getHuntSuccessChance(sword, fieldId);
    if (chance <= 0) {
      const need = field.recLevel;

      msgEl.innerHTML = `
        <div style="font-size:16px; font-weight:800; margin-bottom:6px;">
          ğŸ”’ ì ê¸´ ì‚¬ëƒ¥í„°
        </div>
        <div style="font-size:13px; line-height:1.6; color:#ddd;">
          í˜„ì¬ ì¥ë¹„ë¡œëŠ” ì´ ì‚¬ëƒ¥í„°ì—ì„œ <b>ì‚¬ëƒ¥ ì„±ê³µë¥ ì´ 0%</b>ì…ë‹ˆë‹¤.<br>
          <span style="color:#aaa;">ê¶Œì¥ ê°•í™”:</span> <b>+${need}ê°•</b><br>
          <span style="color:#aaa;">í˜„ì¬ ê°•í™”:</span> <b>+${sword}ê°•</b>
        </div>
      `;

      okBtn.style.display = "inline-block";
      cancelBtn.style.display = "none";
      okBtn.textContent = "í™•ì¸";
      okBtn.onclick = () => closeNpcPopup();
      popup.style.display = "flex";
      return;
    }
  }

  // NPC ìš”ì†Œ ìˆ¨ê¹€
  if (nameEl) nameEl.textContent = "";
  if (imgEl) imgEl.style.display = "none";

  // ì•ˆë‚´ ë¬¸êµ¬ (ì¶”ì²œ ê°•í™”ìˆ˜ì¹˜ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ)
  const recommendHtml = recommendLvText
    ? `<div style="margin-top:6px; font-size:12px; color:#aaa;">
         / ${recommendLvText} /
       </div>`
    : "";

  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:600; margin-bottom:4px;">
      ${fieldName}ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
    </div>
    ${recommendHtml}
  `;

  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";

  okBtn.textContent = "ë„¤";
  cancelBtn.textContent = "ì•„ë‹ˆì˜¤";

  okBtn.onclick = () => {
    closeNpcPopup();
    moveToFieldFromWorldMap(fieldId);
  };

  cancelBtn.onclick = closeNpcPopup;

  popup.style.display = "flex";
}

  // âœ… í•˜ëŠ˜ë§µ ì´ë™ í™•ì¸ì°½ (ì›”ë“œë§µê³¼ ë™ì¼ UI/ë²„íŠ¼ ì²´ê³„ë¡œ í†µì¼)
function showSkyMapMoveConfirm(fieldId){
  const f = HUNT_FIELDS?.[fieldId];
  if (!f) return;

  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");   // âœ… ì›”ë“œë§µê³¼ ë™ì¼
  const cancelBtn = document.getElementById("npcCancelBtn");    // âœ… ì›”ë“œë§µê³¼ ë™ì¼
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !okBtn || !cancelBtn) return;

    // ğŸ”’ ì„±ê³µë¥  0% ì‚¬ëƒ¥í„° â†’ ì ê¸ˆ ì•ˆë‚´ë§Œ ë„ìš°ê³  ì¢…ë£Œ
  const chance = getHuntSuccessChance(sword, fieldId);
  if (chance <= 0) {

    // NPC ìš”ì†Œ ìˆ¨ê¹€ (ê¸°ì¡´ íë¦„ê³¼ ë™ì¼)
    if (nameEl) nameEl.textContent = "";
    if (imgEl) imgEl.style.display = "none";

    msgEl.innerHTML = `
      <div style="font-size:16px; font-weight:700; margin-bottom:6px;">
        ğŸ”’ ì ê¸´ ì‚¬ëƒ¥í„°
      </div>
      <div style="font-size:13px; line-height:1.6; color:#ddd;">
        í˜„ì¬ ê°•í™” ë‹¨ê³„ì—ì„œëŠ” ì´ ì‚¬ëƒ¥í„°ì— ë„ì „í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
        <span style="color:#ffb3b3; font-weight:700;">
          ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥ : 0%
        </span><br><br>
        <span style="color:#aaa;">ì¶”ì²œ ê°•í™”:</span>
        <b>+${Number(f.recLevel || "?")}ê°•</b>
      </div>
    `;

    okBtn.style.display = "inline-block";
    cancelBtn.style.display = "none";
    okBtn.textContent = "í™•ì¸";
    okBtn.onclick = closeNpcPopup;

    popup.style.display = "flex";
    return;
  }

  // NPC ìš”ì†Œ ìˆ¨ê¹€(ì›”ë“œë§µê³¼ ë™ì¼)
  if (nameEl) nameEl.textContent = "";
  if (imgEl) imgEl.style.display = "none";

  const recommendLvText = `+${Number(f.recLevel || 0)}ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°`;
  const recommendHtml = `
    <div style="margin-top:6px; font-size:12px; color:#aaa;">
      / ${recommendLvText} /
    </div>
  `;

  msgEl.innerHTML = `
    <div style="font-size:16px; font-weight:600; margin-bottom:4px;">
      ${f.name}ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
    </div>
    ${recommendHtml}
  `;

  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";

  okBtn.textContent = "ë„¤";
  cancelBtn.textContent = "ì•„ë‹ˆì˜¤";

  okBtn.onclick = () => {
    closeNpcPopup();

    // âœ… í•˜ëŠ˜ë§µ ë‹«ê¸° (í•¨ìˆ˜ëª…ì´ í”„ë¡œì íŠ¸ë§ˆë‹¤ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ì„œ ì•ˆì „ ì²˜ë¦¬)
    if (typeof closeSkyMap === "function") closeSkyMap();
    else if (typeof closeParchmentSky === "function") closeParchmentSky();

    // âœ… ì´ë™(ì´ë™ì¤‘...íŒì—…/ì €ì¥/ê°±ì‹  ë“± ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©)
    moveToFieldFromWorldMap(fieldId);
  };

  cancelBtn.onclick = closeNpcPopup;

  popup.style.display = "flex";
}

// âš”ï¸ ì‚¬ëƒ¥ ê²°ê³¼ íŒì—… (NPC ì´ë¯¸ì§€/ë²„íŠ¼ X)
function showHuntPopup(text, color = "#FFFFFF") {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ”¹ ì´ë¦„ ì œê±°
  if (nameEl) nameEl.textContent = "";
  
  // ì´ë¯¸ì§€ / ë²„íŠ¼ ìˆ¨ê¹€
  imgEl.style.display = "none";
  okBtn.style.display = "none";
  cancelBtn.style.display = "none";

  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; color:${color};">
      ${text}
    </div>
  `;

  popup.style.display = "flex";

  // 1.2ì´ˆ í›„ ìë™ ë‹«í˜ + ê¸°ë³¸ ìƒíƒœ ë³µì›
  setTimeout(() => {
    popup.style.display = "none";
    imgEl.style.display = "block";
    okBtn.style.display = "inline-block";
    cancelBtn.style.display = "none";
  }, 1200);
}

// ğŸŸ ì¿ í° ì…ë ¥ íŒì—… ì—´ê¸°
function openCouponPopup() {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // NPC ì´ë¦„/ì´ë¯¸ì§€ ìˆ¨ê¹€ (ì‹œìŠ¤í…œ íŒì—… ëª¨ë“œ)
  if (nameEl) nameEl.textContent = "";
  imgEl.style.display = "none";

  // ì…ë ¥ UI êµ¬ì„±
  msgEl.innerHTML = `
    <div style="font-size:18px; font-weight:bold; margin-bottom:8px;">
      ì¿ í°
    </div>
    <div style="font-size:13px; margin-bottom:6px;">
      ì¿ í°ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.
    </div>
    <input id="couponInput"
           type="text"
           maxlength="32"
           style="width:100%; padding:6px 8px; font-size:13px;
                  box-sizing:border-box; text-align:center;"/>
  `;

  // ë²„íŠ¼ ì„¤ì •
  okBtn.style.display = "inline-block";
  okBtn.textContent   = "í™•ì¸";
  okBtn.onclick       = submitCouponCode;

  cancelBtn.style.display = "inline-block";
  cancelBtn.textContent   = "ì·¨ì†Œ";
  cancelBtn.onclick       = closeNpcPopup;

  popup.style.display = "flex";

  // í¬ì»¤ìŠ¤ ì£¼ê¸°
  setTimeout(() => {
    const input = document.getElementById("couponInput");
    if (input) input.focus();
  }, 0);
}

// ğŸŸ ì¿ í° ì½”ë“œ í™•ì¸ ì²˜ë¦¬
function submitCouponCode() {
  const input = document.getElementById("couponInput");
  if (!input) {
    closeNpcPopup();
    return;
  }

  const rawCode = input.value.trim();
  if (!rawCode) {
    // ë¹ˆ ì…ë ¥
    showNpcMessage("ì¿ í°ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", null, true, "");
    return;
  }

  const code = rawCode.toUpperCase();
  const reward = couponRewards[code];

  // 1) ë“±ë¡ë˜ì§€ ì•Šì€ ì½”ë“œ
  if (!reward) {
    closeNpcPopup();
    showNpcMessage("ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•œ ì½”ë“œì…ë‹ˆë‹¤.", null, true, "");
    return;
  }

  // 2) ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œ
  if (couponUsedMap && couponUsedMap[code]) {
    closeNpcPopup();
    showNpcMessage("ì´ë¯¸ ì‚¬ìš©í•œ ì½”ë“œì…ë‹ˆë‹¤.", null, true, "");
    return;
  }

  // 3) ìµœì´ˆ ì‚¬ìš© â†’ ë³´ìƒ ì§€ê¸‰
  // ì•„ì´í…œ ì§€ê¸‰
  switch (reward.type) {
    case "itemScroll21":
      itemScroll21 = Number(itemScroll21 || 0) + reward.count;
      break;
    case "itemProtect":
      itemProtect = Number(itemProtect || 0) + reward.count;
      break;
    case "itemSuper":
      itemSuper = Number(itemSuper || 0) + reward.count;
      break;
    case "itemDownProtect":
      itemDownProtect = Number(itemDownProtect || 0) + reward.count;
      break;
    case "itemRateUp5":
      itemRateUp5 = Number(itemRateUp5 || 0) + reward.count;
      break;
    case "starShard":
      starShard = Number(starShard || 0) + reward.count;
      break;
    case "honorMedal":
      itemHonorMedal = Number(itemHonorMedal || 0) + reward.count;
      break;
    case "engraveNormalScroll":
  itemEngraveNormal = Number(itemEngraveNormal || 0) + reward.count;
  break;

case "engraveAdvancedScroll":
  itemEngraveAdvanced = Number(itemEngraveAdvanced || 0) + reward.count;
  break;

    // í•„ìš”í•˜ë©´ íƒ€ì… ë” ì¶”ê°€ ê°€ëŠ¥
    default:
      break;
  }

  // ì‚¬ìš© ê¸°ë¡
  if (!couponUsedMap) couponUsedMap = {};
  couponUsedMap[code] = true;

  // ì €ì¥ & UI ê°±ì‹ 
  save();
  update();

  closeNpcPopup();
  showNpcMessage(reward.desc || "ì¿ í°ì´ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.", null, true, "");
}
  
function closeMovePopup() {
  const popup     = document.getElementById("npcPopup");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !imgEl || !okBtn || !cancelBtn) return;

  // ë‹¤ìŒì— NPC ëŒ€ì‚¬ ì“¸ ìˆ˜ ìˆë„ë¡ ëŒ€ëµ ê¸°ë³¸ í˜•íƒœë¡œ ë³µì›
  imgEl.style.display = "block";
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "none";

  popup.style.display = "none";
}
  
// ìˆ«ì ê³¨ë“œë¥¼ "1ê²½ 2,345ì¡° 6,789ì–µ 1,234ë§Œ 5,678" í˜•íƒœë¡œ ë³€í™˜
function formatGold(value) {
  const n = Number(value) || 0;

  // 100ë§Œ ë¯¸ë§Œì€ ê·¸ëƒ¥ ìˆ«ì+ì½¤ë§ˆë¡œ
  if (n < 1_000_000) {
    return n.toLocaleString();
  }

  // í•œêµ­ì‹ ë‹¨ìœ„
  const MAN    = 10_000;                  // ë§Œ
  const EOK    = 1_0000_0000;             // ì–µ
  const JO     = 1_0000_0000_0000;        // ì¡°
  const GYEONG = 1_0000_0000_0000_0000;   // ê²½

  let rest = n;

  const gyeong = Math.floor(rest / GYEONG);
  rest = rest % GYEONG;

  const jo = Math.floor(rest / JO);
  rest = rest % JO;

  const eok = Math.floor(rest / EOK);
  rest = rest % EOK;

  const man = Math.floor(rest / MAN);
  const won = rest % MAN;

  const parts = [];
  if (gyeong > 0) parts.push(`${gyeong.toLocaleString()}ê²½`);
  if (jo > 0)     parts.push(`${jo.toLocaleString()}ì¡°`);
  if (eok > 0)    parts.push(`${eok.toLocaleString()}ì–µ`);
  if (man > 0)    parts.push(`${man.toLocaleString()}ë§Œ`);
  if (won > 0)    parts.push(won.toLocaleString());

  if (parts.length === 0) return "0";
  return parts.join(" ");
}
  
function randRange(min, max) {
  return min + Math.random() * (max - min);
}

  function getCurrentUpgradeCost() {
  return getUpgradeCost(Math.min(sword, 29));
}

function getUpgradeCost(level) {

  const costTable = {
    0: 0,
    1: 20,
    2: 50,
    3: 100,
    4: 500,
    5: 1000,
    6: 3000,
    7: 5000,
    8: 10000,
    9: 30000,
    10: 50000,
    11: 100000,
    12: 300000,
    13: 500000,
    14: 1000000,
    15: 3000000,
    16: 5000000,
    17: 10000000,
    18: 30000000,
    19: 50000000,
    20: 100000000,
    21: 300000000,
    22: 500000000,
    23: 1000000000,
    24: 3000000000,
    25: 5000000000,
    26: 10000000000,
    27: 30000000000,
    28: 50000000000,
    29: 100000000000
  };

  return costTable[level] ?? 0;
}

// íŒë§¤ ì‹œ, ê·¸ ë ˆë²¨ì—ì„œ ë‹¤ìŒ ê°•í™”ë¥¼ ëª‡ ë²ˆ ì •ë„ ë„ì „ ê°€ëŠ¥í•˜ê²Œ í•´ì¤„ì§€ ê²°ì •
function getSellAttemptFactor(level) {
  // 30ê°•ì€ 29ê°• ê¸°ì¤€ìœ¼ë¡œ ë³¸ë‹¤ (ë¹„ìš©/í™•ë¥  í…Œì´ë¸”ì´ 29ê¹Œì§€ë¼ì„œ)
  const forChance = Math.min(level, 29);

  const chance = getUpgradeChance(forChance); // 0~100
  if (chance <= 0) return 2; // ì•ˆì „ ì¥ì¹˜

  const expectedTries = 100 / chance; // ì„±ê³µê¹Œì§€ í‰ê·  ì‹œë„ íšŸìˆ˜

  if (expectedTries <= 2.0) {
    return 2;   // ì„±ê³µë¥  ë†’ìŒ â†’ 2ë²ˆ ì •ë„ ë„ì „ê¶Œ
  } else if (expectedTries <= 3.5) {
    return 3;
  } else if (expectedTries <= 4.5) {
    return 4;
  } else if (expectedTries <= 7.0) {
    return 5;   // ì˜ˆ: 20%~25%ëŒ€ í™•ë¥ 
  } else {
    return 6;   // ì•„ì£¼ ë‚®ì€ í™•ë¥  â†’ 5~6ë²ˆ ë„ì „ê¶Œ
  }
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ ê³„ì‚°
// A = 0â†’Lê¹Œì§€ ì„±ê³µ ê°€ì • ì´ë¹„ìš©
// B = Lê°• ê°•í™”ë¹„ìš© Ã— (ê¸°ëŒ“ê°’ ê¸°ë°˜ ë„ì „ íšŸìˆ˜)
// ë³´ìƒ = (A + B) Ã— 1.15~1.20
function getSellReward(level) {
  if (level <= 0) return 0; // 0ê°•ì€ íŒ” ê²Œ ì—†ìŒ

  const totalCost = getTotalCostToLevel(level);   // A
  const costNow   = getUpgradeCost(Math.min(level, 29)); // Lê°• ì‹œë„ ë¹„ìš© (30ê°• ë³´í˜¸)

  const attemptFactor = getSellAttemptFactor(level); // ë„ì „ íšŸìˆ˜ ë³´ì •
  const B = costNow * attemptFactor;

  const base = totalCost + B;
  const mul  = randRange(1.15, 1.20); // 115% ~ 120%

  const reward = Math.floor(base * mul);
  return reward;
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ "í‰ê· " ê°’ (ë¬´ê¸°ê°€ì¹˜ í‘œì‹œìš©)
function getSellRewardAverage(level) {
  if (level <= 0) return 0;

  const totalCost = getTotalCostToLevel(level);
  const costNow   = getUpgradeCost(Math.min(level, 29));
  const attemptFactor = getSellAttemptFactor(level);
  const B = costNow * attemptFactor;

  const base = totalCost + B;

  // getSellReward ì—ì„œ 1.15 ~ 1.20 ëœë¤ì´ë‹ˆê¹Œ, ì¤‘ê°„ê°’ 1.175ë¥¼ í‰ê· ìœ¼ë¡œ ì‚¬ìš©
  const avgMultiplier = (1.15 + 1.20) / 2; // 1.175
  return Math.floor(base * avgMultiplier);
}

  
// 0ê°• â†’ levelê°• ê¹Œì§€, ëª¨ë‘ 1íŠ¸ ì„±ê³µí•œë‹¤ê³  ê°€ì •í•œ ì´ ê°•í™”ë¹„ìš©
function getTotalCostToLevel(level) {
  let sum = 0;
  for (let i = 0; i < level; i++) {
    sum += getUpgradeCost(i);
  }
  return sum;
}

// âš”ï¸ ê°•í™”ë¹„ìš© ê¸°ë°˜ ê³µê²©ë ¥ ê³„ì‚°
function getBaseAttack(level) {
  // 0ê°•ë„ ìµœì†Œ 10 ì´ìƒì€ ë‚˜ì˜¤ê²Œ
  const total = getTotalCostToLevel(level); // 0â†’levelê¹Œì§€ ì´ ê°•í™”ë¹„ìš©
  const atk = Math.floor(total / 1000) + 10;
  return atk;
}

// âš”ï¸ í˜„ì¬ ê°•í™” ë‹¨ê³„ ê¸°ì¤€ ì „íˆ¬ë ¥ ì‚°ì • (ìµœì´ˆ 1íšŒ ê²°ì •, ê³ ì •)
function rollPowerForCurrentSword() {

  // 1ï¸âƒ£ ì§€ê¸ˆê¹Œì§€ ê°•í™”ì— ë“¤ì–´ê°„ ì´ ë¹„ìš© = ê¸°ë³¸ ì „íˆ¬ë ¥ ì§€í‘œ
  const totalCost = getTotalCostToLevel(sword);

  // 2ï¸âƒ£ ì „íˆ¬ë ¥ ê¸°ë³¸ê°’ (ìŠ¤ì¼€ì¼ ì¡°ì ˆìš© ê³„ìˆ˜)
  const basePower = totalCost * 0.6;

  // 3ï¸âƒ£ Â±5% í¸ì°¨ ì ìš© (1íšŒë§Œ êµ´ë¦¼)
  const variance = basePower * (Math.random() * 0.1 - 0.05);
  const finalPower = basePower + variance;

  // 4ï¸âƒ£ ìµœì†Œê°’ ë³´ì • + ì •ìˆ˜í™”
  power = Math.max(1, Math.floor(finalPower));
}
  
/* í™•ë¥  */
function getUpgradeChance(level) {
  // 0 -> 1 ì€ 100% ê³ ì •
  if (level === 0) return 100;

  let chance;

  if (level < 20) {
    // 1 ~ 19ê°• êµ¬ê°„ : ë ˆë²¨ 1 ì˜¤ë¥¼ ë•Œë§ˆë‹¤ -4%
    chance = 100 - (level * 4);
  } else {
    // 20ê°• ì´í›„ : -2%ì”© ê°ì†Œ
    const base20 = 100 - (20 * 4); // 20%
    const extra = level - 20;
    chance = base20 - (extra * 2);
  }

  // ğŸ’« ì „ì²´ êµ¬ê°„ ì†Œí­ ìƒí–¥ (+5%)
  chance += 5;

    // âœ… ê°ì¸: ê°•í™” ì„±ê³µí™•ë¥  +N%
  try {
    const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
    chance += Number(st && st.upgradeChancePlus ? st.upgradeChancePlus : 0);
  } catch (e) {}

  // ìƒí•œ/í•˜í•œ ì •ë¦¬
  chance = Math.min(100, chance); // 100% ë„˜ì§€ ì•Šê²Œ
  chance = Math.max(5, chance);   // ì•ˆì „ í•˜í•œ (ì‹¤ì œë¡œëŠ” ê±°ì˜ 10% ì´ìƒì¼ ê²ƒ)

  return chance;
}
const ATTENDANCE_GACHA_POOL = [
  { type: "itemProtect",     name: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",        count: 1,  weight: 4,  img: "images/items/scroll_protect.png" }, // 5â†’4
  { type: "itemSuper",       name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ",        count: 1,  weight: 2,  img: "images/items/scroll_super.png" },   // 3â†’2

  // âœ… ì¶”ê°€(ë„ˆê°€ ì§€ì •í•œ í™•ë¥ )
  { type: "engraveAdvancedScroll", name: "ê³ ê¸‰ê°ì¸ì˜ ì£¼ë¬¸ì„œ", count: 1, weight: 3, img: "images/items/engrave_advanced.png" },
  { type: "engraveNormalScroll",   name: "ì¼ë°˜ê°ì¸ì˜ ì£¼ë¬¸ì„œ", count: 1, weight: 5, img: "images/items/engrave_normal.png" },

  // (ì—¬ê¸° ì•„ë˜ ê¸°ì¡´ í•­ëª©ë“¤ì€ ê·¸ëŒ€ë¡œ)
  { type: "itemDownProtect", name: "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",        count: 1,  weight: 13, img: "images/items/scroll_down_protect.png" },
  { type: "honorMedal",      name: "ëª…ì˜ˆì˜ í›ˆì¥",            count: 30, weight: 13, img: "images/items/honor_medal.png" },
  { type: "itemRateUp5",     name: "ê°•í™”í™•ë¥  +5% ì£¼ë¬¸ì„œ",    count: 1,  weight: 7,  img: "images/items/scroll_rateup_5.png" },
  { type: "starShard",       name: "ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°",  count: 5,  weight: 15, img: "images/items/star_shard.png" },
  { type: "itemScroll15",    name: "15ê°• ê°•í™” ì£¼ë¬¸ì„œ",       count: 1,  weight: 10, img: "images/items/scroll_15.png" },
  { type: "itemScroll21",    name: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",       count: 1,  weight: 5,  img: "images/items/scroll_21.png" },
  { type: "itemDownProtect", name: "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",        count: 5,  weight: 5,  img: "images/items/scroll_down_protect.png" },
  { type: "gold",            name: "5ì–µ ê³¨ë“œ",               count: 500000000, weight: 18, img: "images/items/gold.png" } // 20â†’14
];


// ğŸ² ê°€ì¤‘ì¹˜ ëœë¤ 1ê°œ ë½‘ê¸°
function pickAttendanceGachaReward() {
  const total = ATTENDANCE_GACHA_POOL.reduce((sum, r) => sum + (Number(r.weight) || 0), 0);
  let roll = Math.random() * total;

  for (const r of ATTENDANCE_GACHA_POOL) {
    roll -= (Number(r.weight) || 0);
    if (roll <= 0) return r;
  }
  return ATTENDANCE_GACHA_POOL[ATTENDANCE_GACHA_POOL.length - 1];
}

// ğŸ ì‹¤ì œ ë³´ìƒ ì§€ê¸‰ (ê¸°ì¡´ ë³€ìˆ˜ëª… ê·¸ëŒ€ë¡œ ì‚¬ìš©)
function grantAttendanceGachaReward(reward) {
  if (!reward) return;

  switch (reward.type) {
    case "itemProtect":
      itemProtect = Number(itemProtect || 0) + reward.count;
      break;
    case "itemSuper":
      itemSuper = Number(itemSuper || 0) + reward.count;
      break;
    case "itemDownProtect":
      itemDownProtect = Number(itemDownProtect || 0) + reward.count;
      break;
    case "itemRateUp5":
      itemRateUp5 = Number(itemRateUp5 || 0) + reward.count;
      break;
    case "itemScroll15":
      itemScroll15 = Number(itemScroll15 || 0) + reward.count;
      break;
    case "itemScroll21":
      itemScroll21 = Number(itemScroll21 || 0) + reward.count;
      break;
    case "starShard":
      starShard = Number(starShard || 0) + reward.count;
      break;
    case "honorMedal":
      itemHonorMedal = Number(itemHonorMedal || 0) + reward.count;
      break;
    case "gold":
      gold = Number(gold || 0) + Number(reward.count || 0);
      break;
      
    case "engraveNormalScroll":
  itemEngraveNormal = Number(itemEngraveNormal || 0) + Number(reward.count || 1);
  break;

case "engraveAdvancedScroll":
  itemEngraveAdvanced = Number(itemEngraveAdvanced || 0) + Number(reward.count || 1);
  break;

    default:
      break;
  }
}

function preloadAttendanceGachaImages() {
  try {
    ATTENDANCE_GACHA_POOL.forEach(r => {
      if (!r.img) return;
      const img = new Image();
      img.src = r.img;
    });
  } catch (e) {}
}

  // ============================
// ğŸ° ì¶œì„ ë£°ë › ì‚¬ìš´ë“œ
// 1) "í‹±í‹±í‹±" = WebAudio(ì‹œìŠ¤í…œ ì‚¬ìš´ë“œ)
// 2) "ë¾°ë¡±"   = mp3 (Audio íƒœê·¸)
// ============================

// âœ… ë£°ë › í™•ì • "ë¾°ë¡±"
function playAttendancePyorong(){
  playSfx("sounds/ui_attendance_pyorong.mp3", 0.85);
}

// âœ… ë£°ë › "í‹±/íƒ" (WebAudio)
function playRouletteTick(strength = 1){
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if (!Ctx) return;

  // ë„¤ íŒŒì¼ì— ì´ë¯¸ ìˆëŠ” ensureUiAudio()ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©
  const ctx = (typeof ensureUiAudio === "function") ? ensureUiAudio() : null;
  if (!ctx) return;

  const t0 = ctx.currentTime;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  // strength(0~1.2): ë§ˆì§€ë§‰ìœ¼ë¡œ ê°ˆìˆ˜ë¡ "íƒ" ëŠë‚Œ ê°•í•˜ê²Œ
  const s = Math.max(0, Math.min(1.2, strength));
  const freq = 750 - (s * 220);

  osc.type = "square";
  osc.frequency.setValueAtTime(freq, t0);

  const peak = (0.70 + (s * 0.70)) * getSfxScale();
  gain.gain.setValueAtTime(0.0001, t0);
  gain.gain.exponentialRampToValueAtTime(peak, t0 + 0.004);
  gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.03);

  osc.connect(gain);
  gain.connect(ctx.destination);

  osc.start(t0);
  osc.stop(t0 + 0.035);
}
  
// ğŸï¸ 3ì´ˆ ê°€ì±  ì—°ì¶œ: ë¹ ë¥´ê²Œâ†’ì ì  ëŠë ¤ì§€ë‹¤ê°€ ë©ˆì¶¤
function playAttendanceGachaAnimationAndGrant(onDone) {
  // ì´ˆê¸° í‘œì‹œìš©(ì²« í”„ë ˆì„ë„ ëœë¤)
  let current = pickAttendanceGachaReward();

  const html = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      âœ… ì¶œì„ ì™„ë£Œ! (ë³´ìƒ ì¶”ì²¨ ì¤‘â€¦)
    </div>

    <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-top:6px;">
      <img id="attendanceGachaImg"
           src="${current.img || ""}"
           style="width:52px; height:52px; image-rendering:pixelated; border:1px solid #444; border-radius:8px;"
           onerror="this.style.display='none'">
      <div>
        <div id="attendanceGachaName" style="font-size:14px; font-weight:bold;">${current.name}</div>
        <div id="attendanceGachaSub" style="font-size:12px; color:#bbb; margin-top:2px;">
          ${current.type === "gold" ? formatGold(current.count) + " ê³¨ë“œ" : ("x" + current.count)}
        </div>
      </div>
    </div>

    <div style="margin-top:10px; font-size:12px; color:#aaa;">
      ì•„ì´í…œì´ ë©ˆì¶”ë©´ ê·¸ ë³´ìƒì´ ì§€ê¸‰ë©ë‹ˆë‹¤â€¦
    </div>
  `;

  // âœ… ë²„íŠ¼ ìˆ¨ê¸°ê³  íŒì—… ë„ìš°ê¸° (NPC ì—†ì´)
  showNpcMessage(html, null, false, "");

  const imgEl = document.getElementById("attendanceGachaImg");
  const nameEl = document.getElementById("attendanceGachaName");
  const subEl  = document.getElementById("attendanceGachaSub");

  const start = Date.now();
  const endAt = start + 5000; // âœ… ì´ 5ì´ˆ

  let delay = 60; // ì‹œì‘ì€ ë¹ ë¥´ê²Œ

  function tick() {
    const now = Date.now();
    const left = endAt - now;

    // ë‚¨ì€ ì‹œê°„ì´ 0 ì´í•˜ë©´ í™•ì •
    if (left <= 0) {
      // ìµœì¢… ë³´ìƒ ì§€ê¸‰
      playAttendancePyorong();
      grantAttendanceGachaReward(current);

      // ë¡œê·¸
      const rewardText = current.type === "gold"
        ? `${formatGold(current.count)} ê³¨ë“œ`
        : `${current.name} x${current.count}`;

      writeLog(`${userId}ë‹˜ì´ ì¶œì„ ë³´ìƒìœ¼ë¡œ ${rewardText} ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤. (ì—°ì† ${attendanceStreak}íšŒ)`);

      // ì €ì¥/ê°±ì‹ 
      save();
      update();

      // ìµœì¢… ê²°ê³¼ íŒì—…(ë²„íŠ¼ ë³´ì´ê²Œ)
      const finalHtml = `
        <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
          ğŸ‰ ì¶œì„ ë³´ìƒ í™•ì •!
        </div>
        <div style="font-size:13px;">
          <b>${rewardText}</b> ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.<br>
          (ì—°ì† ${attendanceStreak}íšŒ)
        </div>
      `;
      closeNpcPopup();
      showNpcMessage(finalHtml, null, true, "");

      if (typeof onDone === "function") onDone(current);
      return;
    }

    // ê³„ì† êµ´ë¦¬ê¸°: ë§¤ tickë§ˆë‹¤ â€œí‘œì‹œë˜ëŠ” ì•„ì´í…œâ€ì„ ë°”ê¿ˆ
    current = pickAttendanceGachaReward();
    playRouletteTick(Math.min(1.2, delay / 600));

    if (imgEl) {
      imgEl.style.display = "block";
      imgEl.src = current.img || "";
    }
    if (nameEl) nameEl.textContent = current.name;
    if (subEl) {
      subEl.textContent = (current.type === "gold")
        ? (formatGold(current.count) + " ê³¨ë“œ")
        : ("x" + current.count);
    }

        // âœ… ë’¤ë¡œ ê°ˆìˆ˜ë¡ í™• ëŠë ¤ì§€ê²Œ (íŠ¹íˆ ë§ˆì§€ë§‰ 2ì´ˆê°€ ë” ì«„ê¹ƒ)
    const totalMs = 5000;
    const t = Math.min(1, (now - start) / totalMs); // 0~1 ì§„í–‰ë¥ 

    // ë§ˆì§€ë§‰ 40% êµ¬ê°„(= ì•½ 2ì´ˆ)ì— ë” ê°•í•œ ê°ì†ì„ ì£¼ê¸° ìœ„í•´ ì§€ìˆ˜ ê°€ì¤‘
    // tê°€ 0.6 ë„˜ì–´ê°€ë©´ ê¸‰ê²©íˆ ëŠë ¤ì§
    const eased = Math.pow(t, 2.6); // ìˆ«ì â†‘ = ëë¶€ë¶„ ë” ëŠ˜ì–´ì§

    // delay ë²”ìœ„: ì´ˆë°˜ 50~90ms, í›„ë°˜ 700msê¹Œì§€
    const minDelay = 130;
    const maxDelay = 720;

    delay = Math.floor(minDelay + (maxDelay - minDelay) * eased);

    setTimeout(tick, delay);
  }

  tick();
}

function checkAttendance() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const today = getTodayDateString();

  // ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„í•¨
if (lastAttendanceDate === today) {
  showNpcMessage(
    `<div style="font-size:15px; font-weight:700;">
      ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤.
     </div>
     <div style="font-size:12px; color:#aaa; margin-top:6px;">
      ë‚´ì¼ ë‹¤ì‹œ ì¶œì„ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     </div>`,
    null,   // âœ… NPC ì´ë¯¸ì§€ ì—†ìŒ
    true,   // âœ… í™•ì¸ ë²„íŠ¼ í‘œì‹œ
    ""      // âœ… ì´ë¦„ ì—†ìŒ
  );
  return;
}

  // ë‚ ì§œ ë¹„êµ (ì—°ì† ì¶œì„ ì²˜ë¦¬)
  const yesterday = getYesterdayDateString();

  // ì–´ì œë„ ì°ì—ˆìœ¼ë©´ ì—°ì† ì¶œì„ +1, ì•„ë‹ˆë©´ 1ë¶€í„°
  if (lastAttendanceDay === yesterday) {
    attendanceStreak++;
  } else {
    attendanceStreak = 1;
  }

  lastAttendanceDay = today;
  lastAttendanceDate = today;
  attendanceCount++;
  updateAttendanceBadge();

  // âœ… ì—¬ê¸°ì„œ ë°”ë¡œ â€œê°€ì±  ì—°ì¶œ + ë³´ìƒ ì§€ê¸‰â€
  preloadAttendanceGachaImages();
  playAttendanceGachaAnimationAndGrant();
}

  // âœ… ì¶œì„ ë±ƒì§€(!) í‘œì‹œ/ìˆ¨ê¹€ ê°±ì‹ 
function updateAttendanceBadge(){
  const badge = document.getElementById("attendanceAlertBadge");
  if (!badge) return;

  // ë¡œê·¸ì¸ ì „ì´ë©´ ìˆ¨ê¹€
  if (!userId || !userRef) {
    badge.style.display = "none";
    return;
  }

  const today = getTodayDateString();

  // ì˜¤ëŠ˜ ì¶œì„ ì•ˆí–ˆìœ¼ë©´ ë³´ì´ê¸° / í–ˆìœ¼ë©´ ìˆ¨ê¸°ê¸°
  badge.style.display = (lastAttendanceDate === today) ? "none" : "flex";
}

// âœ… ë§¤ì¼ 00:00(ìì •)ë§ˆë‹¤ ë±ƒì§€ ìƒíƒœ ê°±ì‹  (ê²Œì„ ì¼œë†“ì€ ì±„ë¡œ ë‚ ì§œ ë„˜ì–´ê°€ë„ ë°˜ì˜)
let attendanceResetTimer = null;
function startAttendanceResetTimer(){
  if (attendanceResetTimer) clearTimeout(attendanceResetTimer);

  const now = new Date();
  const next = new Date(now);
  next.setHours(24, 0, 0, 0);           // ë‹¤ìŒ ìì •
  const ms = Math.max(1000, next - now);

  attendanceResetTimer = setTimeout(() => {
    updateAttendanceBadge();            // ë‚ ì§œ ë°”ë€Œì—ˆìœ¼ë‹ˆ ë‹¤ì‹œ ê³„ì‚°
    startAttendanceResetTimer();        // ë‹¤ìŒë‚  ê²ƒë„ ì˜ˆì•½
  }, ms);
}

// âš”ï¸ ë¬´ê¸° ì´ë¯¸ì§€(#weaponImage) ê°•í™” ì—°ì¶œ ìœ í‹¸
function getWeaponImgEl(){
  return document.getElementById("weaponImage");
}

function playWeaponAnim(cls){
  const el = getWeaponImgEl();
  if(!el) return;

  // ê°™ì€ ì• ë‹ˆë©”ì´ì…˜ ì—°ì† ì¬ìƒì„ ìœ„í•´ ë¦¬ì…‹
  el.classList.remove("weapon-flash-charge","weapon-flash-success","weapon-flash-fail");
  void el.offsetWidth; // reflow

  el.classList.add(cls);
  // ì• ë‹ˆ ëë‚˜ë©´ í´ë˜ìŠ¤ ì •ë¦¬
  setTimeout(() => el.classList.remove(cls), 700);
}

/**
 * ê²°ê³¼ ë°˜ì˜ íƒ€ì´ë° ì œì–´:
 * 1) ë¨¼ì € ë²ˆì©(ë˜ëŠ” ì•”ì „) ì‹œì‘
 * 2) midDelay í›„ì— ì‹¤ì œ update() ì‹¤í–‰ (ì´ë¯¸ì§€ src ë³€ê²½ íƒ€ì´ë°)
 * 3) ì´í›„ ë‚˜ë¨¸ì§€ ì• ë‹ˆëŠ” CSSê°€ ë§ˆë¬´ë¦¬
 */
function playWeaponResultAndUpdate(isSuccess, doUpdate){
  const cls = isSuccess ? "weapon-flash-success" : "weapon-flash-fail";
  const midDelay = isSuccess ? 120 : 90;

  const el = getWeaponImgEl();
  if(!el){
    doUpdate();
    return;
  }

  el.classList.remove("weapon-flash-charge","weapon-flash-success","weapon-flash-fail");
  void el.offsetWidth;
  el.classList.add(cls);

  setTimeout(() => {
    doUpdate(); // âœ… ì—¬ê¸°ì„œ ë¬´ê¸° ì´ë¯¸ì§€ê°€ ë°”ë€Œê²Œ(ì„±ê³µ) / ì‹¤íŒ¨ ê²°ê³¼(ê¸ˆì†ê´´ ë“±) ë°˜ì˜
  }, midDelay);

  setTimeout(() => {
    el.classList.remove(cls);
  }, 700);
}
  
/* ê°•í™” */
function upgrade() {

  // âŒ ëŒ€ì¥ê°„ì´ ì•„ë‹ˆë©´ ê°•í™” ë¶ˆê°€
if (!isInFulgurantForge()) {
  showGoToForgeMessage();
  return;
}

  if (sword >= 30) {
    alert("ìµœëŒ€ ê°•í™”");
    return;
  }

  // ğŸ›‘ 25ê°• ì´ìƒ ì²« ë„ì „ ê²½ê³  ì•ˆë‚´ (ì„¸ì…˜ 1íšŒ)
  if (sword >= 25 && !hasSeen25Warning && !ignoreNextUpgradeWarning) {
    showUpgradeWarning25();
    return;
  }
  // ê²½ê³ ë¥¼ ë³´ê³  ë‹¤ì‹œ ë“¤ì–´ì˜¨ í˜¸ì¶œì€ ì´ í”Œë˜ê·¸ë¡œ í•œ ë²ˆ ìŠ¤í‚µ
  ignoreNextUpgradeWarning = false;

    // âœ… ë„íŒŒë¯¼ì¤‘ë…ì: 25ê°• ì´í›„ íŒŒê´´ë°©ì§€ ì—†ì´ ê°•í™” 'ì‹œë„'
  if (sword >= 25) {
    const usingProtect = (document.getElementById("useProtect")?.checked);
    if (!usingProtect) {
      dopamineTried = 1;
      if (grantTitleOnceNoSave("dopamine")) save();
    }
  }
  
  // ì´ë¯¸ ê°•í™” ì¤‘ì´ë©´ ì¤‘ë³µ í´ë¦­ ë°©ì§€
  if (isUpgrading) return;

  playWeaponAnim("weapon-flash-charge");

  // ğŸ”˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì½ê¸°
  const scroll15El = document.getElementById("useScroll15");
  const protectEl  = document.getElementById("useProtect");
  const downProtEl = document.getElementById("useDownProtect");
  const superEl    = document.getElementById("useSuper");
  const scroll21El = document.getElementById("useScroll21");   // ğŸ†•
  const rate5El    = document.getElementById("useRateUp5");    // ğŸ†•  

  const wantScroll15 = !!(scroll15El && scroll15El.checked);
  const wantProtect  = !!(protectEl  && protectEl.checked);
  const wantDownProt = !!(downProtEl && downProtEl.checked);
  const wantSuper    = !!(superEl    && superEl.checked);
  const wantScroll21 = !!(scroll21El && scroll21El.checked);    // ğŸ†•
  const wantRate5    = !!(rate5El    && rate5El.checked);       // ğŸ†•

  // âš ï¸ ì•„ì´í…œ ì—†ëŠ” ìƒíƒœì—ì„œ ì²´í¬í•œ ê²½ìš° â†’ ê°•í™” ì§„í–‰ ê¸ˆì§€
  if (wantScroll15 && itemScroll15 <= 0) {
    showNpcMessage("15ê°• ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantProtect && itemProtect <= 0) {
    showNpcMessage("íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantDownProt && itemDownProtect <= 0) {
    showNpcMessage("ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantSuper && itemSuper <= 0) {
    showNpcMessage("ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantScroll21 && itemScroll21 <= 0) {
  showNpcMessage("21ê°• ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
  return;
  }
  if (wantRate5 && itemRateUp5 <= 0) {
  showNpcMessage("ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
  return;
  }

  // âœ… UX: ê°•í™” 1íšŒ ì‹œë„ ì‹œì‘ ì‹œ, ì„ íƒí•œ ì•„ì´í…œ ì²´í¬ë°•ìŠ¤ëŠ” ëª¨ë‘ ìë™ í•´ì œ
  [scroll15El, protectEl, downProtEl, superEl, scroll21El, rate5El].forEach(el => {
    if (el) el.checked = false;
  });
  
  // ğŸ›‘ 28ê°• ì´ìƒì—ì„œëŠ” ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ ì‚¬ìš© ë¶ˆê°€
  if (sword >= 28 && wantSuper) {
    showNpcMessage(
      "28ê°• ì´ìƒ ë¬´ê¸°ì—ëŠ” ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œë¥¼ ì“¸ ìˆ˜ ì—†ë‹¤ë„¤.",
      "images/npc/blacksmith_idle.png"
    );
    if (superEl) superEl.checked = false;  // ì²´í¬ë„ í’€ì–´ì£¼ê¸°
    return;
  }

  // ğŸ¯ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ ì „ìš© ì²˜ë¦¬ (ì¦‰ì‹œ ì²˜ë¦¬, ë”œë ˆì´ X)
  if (wantScroll15) {

    if (sword >= 15) {
      alert("15ê°• ì´ìƒì˜ ë¬´ê¸°ì—ëŠ” 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const before = sword;          // ğŸ”¹ ì¶”ê°€: ì£¼ë¬¸ì„œ ì‚¬ìš© ì „ ë ˆë²¨ ê¸°ì–µ

    itemScroll15 -= 1;
    sword = 15;

      // ğŸ”¹ 0ê°• â†’ 15ê°•ìœ¼ë¡œ ì í”„í–ˆë‹¤ë©´ ì—¬ê¸°ì„œ ê²€/ì°½ ëœë¤ í™•ì •
  ensureWeaponTypeAfterUpgrade(before, sword);
    
    rollPowerForCurrentSword();

    if (scroll15El) scroll15El.checked = false; // í•œ ë²ˆ ì“°ê³  ì²´í¬ í•´ì œ

  writeLog(
  `${userId}ë‹˜ì´ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ê¸°ê°€ ${coloredLevel(15)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
);

// í¼ê·¸ë€íŠ¸ ëŒ€ì‚¬ + ì„±ê³µ ì´ë¯¸ì§€
showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#C0C0C0;">
    15ê°• ê°•í™”!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì§€! 15ê°•, ë‹¨ìˆ¨ì— ì˜¬ë ¤ì£¼ì§€.
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

    update();
    save();
    return;
  }

// ğŸ¯ 21ê°• ê°•í™” ì£¼ë¬¸ì„œ ì „ìš© ì²˜ë¦¬ (ì¦‰ì‹œ ì²˜ë¦¬, ë”œë ˆì´ X)
if (wantScroll21) {
  if (sword >= 21) {
    showNpcMessage("ë²Œì¨ 21ê°•ì€ ë„˜ê²¼ì–ë‚˜. ì´ ì£¼ë¬¸ì„œëŠ” ì•„ê¹Œìš°ë‹ˆê¹Œ ì•„ê»´ë‘ìê³ .");
    return;
  }

    const before = sword;        // ğŸ”¹ ì¶”ê°€
  
  itemScroll21 -= 1;
  sword = 21;

    // ğŸ”¹ 0ê°• â†’ 21ê°•ìœ¼ë¡œ ì í”„í–ˆë‹¤ë©´ ì—¬ê¸°ì„œ ê²€/ì°½ ëœë¤ í™•ì •
  ensureWeaponTypeAfterUpgrade(before, sword);
  
  rollPowerForCurrentSword();

  if (sword > maxSwordLevel) {
    maxSwordLevel = sword;
  }

  showNpcMessage(
    `
    <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
      ê°•í™”ì„±ê³µ!
    </div>
    <div style="margin-top:6px;">
      21ê°•ê¹Œì§€ í•œ ë²ˆì— ëŒì–´ì˜¬ë ¸ì–´. ëŒ€ë‹¨í•œ ì„ íƒì´êµ°.
    </div>
    `,
    "images/npc/blacksmith_success.png"
  );

  update();
  save();
  updateUpgradeItemLabels();
  return;
}

// ğŸ” 5% ê°•í™” ì£¼ë¬¸ì„œ ì²´í¬í–ˆëŠ”ë° ì¬ê³ ê°€ ì—†ìœ¼ë©´ ë§‰ê¸°
if (wantRate5 && itemRateUp5 <= 0) {
  showNpcMessage("ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê°€ ì—†êµ¬ë§Œ. ê·¸ê±¸ë¡œ ë¶ˆê¸¸ì„ ì¢€ ë” ì‚´ë ¤ì•¼ í•´.");
  const rate5El = document.getElementById("checkRate5");
  if (rate5El) rate5El.checked = false;  // ì²´í¬ë„ í’€ì–´ì£¼ê¸°
  updateUpgradeItemLabels();
  return;
}
  
   // ğŸª™ ì¼ë°˜ ê°•í™” (íŒŒê´´ë°©ì§€ / ìŠˆí¼ê°•í™”ë§Œ ì˜í–¥)
  const cost = getUpgradeCost(sword);

  if (gold < cost) {
    showNpcMessage(
      "ìë„¤, ê³¨ë“œëŠ” ì¶©ë¶„í•œê²Œ ë§ë‚˜?",
      "images/npc/blacksmith_idle.png"
    );
    return;
  }

  // ğŸ‘‰ ì—¬ê¸°ì„œë¶€í„° ì§„ì§œ ê°•í™” ì‹œì‘ì´ë‹ˆê¹Œ,
  //    ì´ì œ ì ê¸ˆ ì²˜ë¦¬
  isUpgrading = true;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = true);

  // ê³¨ë“œ ì°¨ê° ë° ì•„ì´í…œ ì†Œë¹„ëŠ” ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì²˜ë¦¬
  gold -= cost;

  let chance = getUpgradeChance(sword);
  const before = sword;

const useProtect  = wantProtect  && itemProtect > 0;
const useSuper    = wantSuper    && itemSuper   > 0;
const useDownProt = wantDownProt && itemDownProtect > 0;
const useRate5    = wantRate5    && itemRateUp5 > 0;   // ğŸ†•

  // âœ… ì´ë²ˆ ì‹œë„ì— â€œì£¼ë¬¸ì„œ/ê°•í™”í…œâ€ì„ ì¼ëŠ”ì§€(ìŠ¹ë¶€ì‚¬/ì‹  íŒì •ìš©)
const usedAnyScrollThisAttempt = !!(useProtect || useDownProt || useSuper || useRate5);

// âœ… ìŠ¹ë¶€ì‚¬ ëŸ° ìƒíƒœ ê´€ë¦¬
if (before < 21) {
  // 21ê°• ë¯¸ë§Œì´ë©´ ëŸ° ì´ˆê¸°í™”
  gamblerRunActive = false;
  gamblerRunNoScroll = true;
} else if (!gamblerRunActive) {
  // 21ê°• ì´ìƒ â€œì§„ì… ìˆœê°„â€
  gamblerRunActive = true;
  gamblerRunNoScroll = true;
}

// 21ê°• ëŸ° ë„ì¤‘ ì£¼ë¬¸ì„œë¥¼ í•œ ë²ˆì´ë¼ë„ ì“°ë©´ ì‹¤íŒ¨ ì²˜ë¦¬
if (gamblerRunActive && usedAnyScrollThisAttempt) {
  gamblerRunNoScroll = false;
}

// âœ… ëª¨ë“  ì£¼ë¬¸ì„œëŠ” ê°•í™” ë²„íŠ¼ ëˆ„ë¥¸ ì‹œì ì— ì¦‰ì‹œ ì†Œëª¨
if (useProtect)  itemProtect     -= 1;
if (useSuper)    itemSuper       -= 1;
if (useDownProt) itemDownProtect -= 1;
if (useRate5) {
  itemRateUp5 -= 1;
  chance += 5;
  if (chance > 95) chance = 95;  // ìƒí•œ (ì›í•˜ë©´ ì¡°ì ˆ ê°€ëŠ¥)
}

  // ğŸ•’ 1~2ì´ˆ ëœë¤ ë”œë ˆì´ ë™ì•ˆ "ê°•í™” ì¤‘..." íŒì—…
const delayMs = 500 + Math.random() * 500; // 0.5 ~ 1.0ì´ˆ

showNpcMessage(
  "ê°•í™” ì¤‘ì…ë‹ˆë‹¤...",
  "images/npc/blacksmith_upgrade.png",
  false   // â¬… ë²„íŠ¼ ìˆ¨ê¹€
);


  setTimeout(() => {
    // ì¤€ë¹„ íŒì—… ë‹«ê¸°
    closeNpcPopup();

    /// ğŸ² ì„±ê³µ / ì‹¤íŒ¨ íŒì • (í•œ ë²ˆë§Œ êµ´ë¦¬ê³  ë³€ìˆ˜ë¡œ ì €ì¥)
const isSuccess = (Math.random() < chance / 100);

if (isSuccess) {
  // âœ… ì„±ê³µ
  let up = useSuper ? 2 : 1; // ìŠˆí¼ê°•í™”ë©´ +2
  playShardSfx();
spawnWeaponShards(18);
  
// âœ… ìŠˆí¼ê°•í™” ì„±ê³µì¼ ë•Œë§Œ ì¹´ìš´íŠ¸/ì¹­í˜¸ ì§€ê¸‰ (ìŠˆí¼ìŠ¤íƒ€)
if (useSuper) {
  superSuccessCount = Number(superSuccessCount || 0) + 1;

  // 1íšŒ ë‹¬ì„± ì¦‰ì‹œ ì¹­í˜¸ ì§€ê¸‰
  if (superSuccessCount >= 1) {
    if (grantTitleOnceNoSave("superstar")) save(); // ìµœì´ˆ íšë“ ì‹œë§Œ ì €ì¥
  }
}

  while (up > 0 && sword < 30) {
    sword++;
    up--;
    downStreak = 0;
  }
  
  // ğŸ”¹ 0ê°• â†’ 1ê°• ì´ìƒìœ¼ë¡œ ì²˜ìŒ ì˜¬ë¼ê°”ìœ¼ë©´ ì—¬ê¸°ì„œ íƒ€ì… í™•ì •
      ensureWeaponTypeAfterUpgrade(before, sword);

  // âœ… ìŠ¹ë¶€ì‚¬: 21ê°•ë¶€í„° â€œì£¼ë¬¸ì„œ ì—†ì´â€ 24ê°• ë„ë‹¬
if (gamblerRunActive && gamblerRunNoScroll && before < 24 && sword >= 24) {
  if (grantTitleOnceNoSave("gambler")) save();
}

// âœ… ì‹ : 29ê°•ì—ì„œ â€œì£¼ë¬¸ì„œ ì—†ì´â€ 30ê°• ë‹¬ì„± (ì´ë²ˆ ì‹œë„ ìì²´ê°€ ë¬´ì£¼ë¬¸ì„œì—¬ì•¼ í•¨)
if (before === 29 && sword >= 30 && !usedAnyScrollThisAttempt) {
  if (grantTitleOnceNoSave("god30")) save();
}

// âœ… 30ê°• ë‹¬ì„± â†’ ëª…ì˜ˆì˜ ì „ë‹¹ â€œëŒ€ê¸° ë“±ë¡(72ì‹œê°„)â€
if (before < 30 && sword >= 30) {
  reach30Count = Number(reach30Count || 0) + 1;

  // ë¬´ê¸°ë³„ 30ê°• ë‹¬ì„± ì¹´ìš´íŠ¸ë„ ìœ ì§€(ë³„/ë„ê° ë“±ì— ì¬ì‚¬ìš© ê°€ëŠ¥)
  const wt = weaponType || "sword";
  weapon30Counts = weapon30Counts || {};
  weapon30Counts[wt] = Number(weapon30Counts[wt] || 0) + 1;

  // ğŸ›ï¸ ì „ë‹¹ ì¹´ìš´íŠ¸ ì‹œì‘
  hofAchievedAt = Date.now();
  hofWeaponTypeAt30 = wt;
  hofDeadline = hofAchievedAt + (72 * 60 * 60 * 1000); // 72ì‹œê°„
  hofProcessedAt = 0;

  // âœ… ì „ë‹¹ í ë“±ë¡: í•´ë‹¹ ìœ ì €ê°€ ì ‘ì† ì•ˆ í•´ë„, ë‹¤ë¥¸ ìœ ì €ê°€ ê²Œì„ ì¼œë©´ ìŠ¤ìœ• ì²˜ë¦¬ ê°€ëŠ¥
db.ref("hofQueue/" + userId).set(hofDeadline).catch(() => {});

    // ğŸŒŒ 30ê°• ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ ë°œí–‰
  const weaponName = getWeaponInfo(30, wt).name;
  const winnerNick = formatNicknameWithTitle(userId, equippedTitle, reach30Count);
  const eventId = publishGlobal30Event(userId, winnerNick, weaponName, wt);
    // âœ… (ì¤‘ìš”) 30ê°• ì¶•í•˜ ë¡œê·¸ëŠ” "ë‹¬ì„± ìˆœê°„"ì—ë§Œ DB logsì— 1íšŒ ê¸°ë¡
  const msg =
    `âœ¦âœ§âœ¦âœ§âœ¦ <span class="sparkle-silver">[ì²œìƒ(å¤©ä¸Š) 30ê°•]</span> âœ¦âœ§âœ¦âœ§âœ¦<br>` +
    `<span class="sparkle-gold">${winnerNick}</span>ì´ <span class="rainbowStar">+30</span>ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!<br>` +
    `<span style="color:#cfd8ff;">í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ì— ìƒˆë¡œìš´ ìš°ì£¼ì˜ ì§ˆì„œê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</span>`;

  writeLog(msg, false, {
    isReach30: true,
    global30EventId: eventId,
    winnerNick: winnerNick,
    weaponName: weaponName
  });

  tryGrantWorldChampionIfFirst(userId, winnerNick, weaponName, weaponType);

  // ë‹¬ì„±ìëŠ” â€˜ë´¤ìŒâ€™ ì²˜ë¦¬ (ì›í•˜ë©´)
  lastSeenGlobal30EventId = eventId;
  save();

}

  rollPowerForCurrentSword();
  
    // ìµœê³  ê°•í™” ê¸°ë¡ ê°±ì‹ 
  if (sword > maxSwordLevel) {
    maxSwordLevel = sword;
  }

  // í¼ê·¸ë€íŠ¸ ì„±ê³µ ë©˜íŠ¸
  if (useSuper) {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFD700;">
    ìŠˆí¼ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ë‘ ë‹¨ê³„ë‚˜ ì˜¬ë¼ê°”ë‹¤ê³ !? ì „ì„¤ì´ ë³´ì´ëŠ”êµ°!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  } else {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
    ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì•„! ì œëŒ€ë¡œ ë¶™ì—ˆêµ¬ë§Œ!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  }

  // âš™ï¸ ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ ì „ìš© ì„±ê³µ ë©˜íŠ¸
if (useRate5) {
  showNpcMessage(
    `
    <div style="font-size:18px; font-weight:bold; margin-bottom:4px; color:#ffd54f;">
      ê°•í™” ì„±ê³µ!
    </div>
    <div style="font-size:13px; line-height:1.6;">
      ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê¹Œì§€ ì¨ ê°€ë©° ë°€ì–´ë¶™ì¸ ë³´ëŒì´ ìˆêµ°.<br>
      <span style="color:#ffb74d;">+${before}ê°• â†’ +${sword}ê°•</span>,<br>
      ì´ì œ ì´ ê²€ì€ í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ì˜ ê°„íŒì´ë¼ ë¶ˆëŸ¬ë„ ë˜ê² ì–´.
    </div>
    `,
    "images/npc/blacksmith_success.png",
    true,
    "í¼ê·¸ë€íŠ¸ â€“ ëŒ€ì¥ê°„ ì£¼ì¸"
  );
}

  if (before >= 24) {
    // ğŸŒŸ 25ê°• ì´ìƒ ë„ì „ ì„±ê³µ ë¡œê·¸ (ë„ì „ ì°¬ì–‘ ë²„ì „)
    writeLog(
      `${userId}ì´ ${coloredLevel(before + 1)}ì˜ ë²½ì„ ëŒíŒŒí•˜ì—¬ ` +
      `${coloredLevel(sword)}ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!<br>` +
      `<span style="color:#ffd54f;">ê·¸ ìš©ê¸°ì— í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ì´ ë°•ìˆ˜ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.</span>`
    );
  } else if (before >= 20) {
    // ê¸°ì¡´ 20ê°• ì´ìƒ ì„±ê³µ ë¡œê·¸
    writeLog(
      `${userId}ì´ ${coloredLevel(before + 1)} ë„ì „ì— ì„±ê³µí•˜ì—¬ ${coloredLevel(sword)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
    );
  }
  
    // âœ¨ 25ê°• ì´ìƒ ë„ì „ ì„±ê³µ ì‹œ í™©ê¸ˆ í”Œë˜ì‹œ
  if (before >= 24) {  // before+1 ì´ 25ê°• ì´ìƒ
    playUpgradeFlash("gold");
  }

  } else {
    // âŒ ì‹¤íŒ¨
    // âœ… 5,10,15,20ê¹Œì§€ë§Œ ì„¸ì´í”„ / 25ë¶€í„°ëŠ” ì„¸ì´í”„ ì—†ìŒ
    const isSafeLevel = (before % 5 === 0 && before <= 20);
    playMetalCrackSfx();

      // âœ… ê°ì¸: ê°•í™” ì‹¤íŒ¨ ì‹œ ê³¨ë“œ ì†Œëª¨ ê°ì†Œ(+30/+50) â†’ ì‹¤íŒ¨ ì‹œ í™˜ê¸‰
    try {
      const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
      const refundPct = Number(st && st.upgradeFailGoldRefundPct ? st.upgradeFailGoldRefundPct : 0);
      if (refundPct > 0) {
        const refund = Math.floor(cost * (refundPct / 100));
        if (refund > 0) gold += refund;
      }
    } catch (e) {}

    if (useProtect) {
      downStreak = 0;
      // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš© ì‹œ
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FF5555;">
          ê°•í™”ì‹¤íŒ¨!
        </div>
        <div style="margin-top:6px;">
          ìœ„í—˜í–ˆë„¤â€¦ ì£¼ë¬¸ì„œ ë•ì— ë²„í…¼ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      if (isSafeLevel) {
        downStreak = 0;
        // ì„¸ì´í”„ êµ¬ê°„ ì‹¤íŒ¨ â†’ ìœ ì§€
        showNpcMessage(
          `
          <div style="font-size:18px; font-weight:bold; color:#FF5555;">
            ê°•í™”ì‹¤íŒ¨!
          </div>
          <div style="margin-top:6px;">
            í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼. ëŒ€ì‹  ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œë¼ë„¤.
          </div>
          `,
          "images/npc/blacksmith_fail.png"
        );
      } else {
        if (sword <= 10) {
          downStreak = 0;
          // ì €ë ˆë²¨ ì‹¤íŒ¨ â†’ ê·¸ëƒ¥ ìœ ì§€
          showNpcMessage(
            `
            <div style="font-size:18px; font-weight:bold; color:#FF5555;">
              ê°•í™”ì‹¤íŒ¨!
            </div>
            <div style="margin-top:6px;">
              í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
            </div>
            `,
            "images/npc/blacksmith_fail.png"
          );
} else if (sword <= 20) {
  // 11~20êµ¬ê°„ : ì ˆë°˜ì€ ìœ ì§€, ì ˆë°˜ì€ ê°•ë“±
  if (Math.random() < 0.5) {
    downStreak = 0;
    // ì‹¤íŒ¨ (ìœ ì§€)
    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF5555;">
        ê°•í™”ì‹¤íŒ¨!
      </div>
      <div style="margin-top:6px;">
        í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else {
    // ê°•ë“± or ê°•ë“±ë°©ì§€ ë°œë™
    if (useDownProt) {
      downStreak = 0;
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FFA500;">
          ê°•ë“± ë°©ì§€!
        </div>
        <div style="margin-top:6px;">
          ì•„ìŠ¬ì•„ìŠ¬í–ˆë„¤â€¦ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œê°€ ë‹¨ê³„ë¥¼ ì§€ì¼œì¤¬ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      sword--;
      
            downStreak = Number(downStreak || 0) + 1;
      if (downStreak >= 4) {
        if (grantTitleOnceNoSave("slide4")) save();
      }

      rollPowerForCurrentSword();
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FFA500;">
          ê°•ë“± ë°œìƒ!
        </div>
        <div style="margin-top:6px;">
          ì—êµ¬, í•œ ë‹¨ê³„ ë‚´ë ¤ê°€ ë²„ë ¸ë„¤â€¦
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    }
  }
  } else {
    // íŒŒê´´ (ê°•ë“±ë°©ì§€ëŠ” íŒŒê´´ì—” íš¨ê³¼ ì—†ìŒ)
    const targetLevel = before + 1; // ë„ì „í•˜ë˜ ê°•í™” ë‹¨ê³„
    let gainedShard = 0;

    // â­ 22ê°• ì´ìƒ íŒŒê´´ ì‹œ 'ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°' ì§€ê¸‰
    if (targetLevel >= 22) {
      if (targetLevel === 22) gainedShard = 1;
      else if (targetLevel === 23) gainedShard = 2;
      else if (targetLevel === 24) gainedShard = 4;
      else if (targetLevel === 25) gainedShard = 7;
      else if (targetLevel === 26) gainedShard = 10;
      else if (targetLevel === 27) gainedShard = 14;
      else if (targetLevel === 28) gainedShard = 18;
      else if (targetLevel === 29) gainedShard = 23;
      // 30ê°• ì´í›„ëŠ” ì•„ì§ ë¯¸ì •ì´ë©´ 0ìœ¼ë¡œ ë‘ë©´ ë¨
    }

    if (gainedShard > 0) {
      starShard += gainedShard;
    }

    // ì‹¤ì œ íŒŒê´´ ì²˜ë¦¬
    sword = 0;
    downStreak = 0;
    weaponType = null;       // ğŸ”¹ íŒŒê´´ë˜ë©´ ë¬´ê¸° íƒ€ì…ë„ ì´ˆê¸°í™” (ë‹¤ìŒì— ë‹¤ì‹œ ëœë¤)
          // âœ… íŒŒê´´ë˜ë©´ ìŠ¹ë¶€ì‚¬ ëŸ°ì€ ëŠê¹€
gamblerRunActive = false;
gamblerRunNoScroll = true;

// âœ… í­ì£½ë†€ì´: 21~25ê°• ë„ì „(=targetLevel) íŒŒê´´ ì²´í¬
if (targetLevel >= 21 && targetLevel <= 25) {
  fireworksDestroyed = fireworksDestroyed || { 21:false, 22:false, 23:false, 24:false, 25:false };
  fireworksDestroyed[targetLevel] = true;

  const allDone =
    fireworksDestroyed[21] &&
    fireworksDestroyed[22] &&
    fireworksDestroyed[23] &&
    fireworksDestroyed[24] &&
    fireworksDestroyed[25];

  if (allDone) {
    if (grantTitleOnceNoSave("fireworks")) save();
  }
}

          rollPowerForCurrentSword();

    destroyCount++;  
    // ğŸ§¨ ëˆ„ì  íŒŒê´´ íšŸìˆ˜ ì¦ê°€
    checkAndGrantTitles();

   // âœ… ìš´ìˆ˜ì¢‹ì€ë‚  / ì´ì¹´ë£¨ìŠ¤ (íŒŒê´´ ë‹¹ì‹œ ë„ì „ ë ˆë²¨ ê¸°ì¤€)
   if (targetLevel < 20) {
    if (grantTitleOnceNoSave("luckyday")) save();
  }
  if (targetLevel >= 26) {
    if (grantTitleOnceNoSave("icarus")) save();
  }

    // ğŸ”” ë¡œê·¸ ë©”ì‹œì§€
  let logMsg =
    `${userId}ì´ ${coloredLevel(targetLevel)} ë„ì „ì— ì‹¤íŒ¨í•˜ì—¬ ` +
    `<span style="color:red;font-weight:bold;">íŒŒê´´</span> ë˜ì—ˆìŠµë‹ˆë‹¤!`;

  // ğŸ•¯ 25ê°• ì´ìƒ ë„ì „ì€ ë³„ë„ ì°¬ì–‘ ë²„ì „ ë©”ì‹œì§€
 if (before >= 25) {
    logMsg =
      `${userId}ì´ ${coloredLevel(targetLevel)}ì— ë„ì „í•˜ë‹¤ê°€ ` +
      `<span style="color:red;font-weight:bold;">íŒŒê´´</span>ë˜ì—ˆìŠµë‹ˆë‹¤!<br>` +
      `<span style="color:#ffb74d;">ìœ„ëŒ€í•œ ë„ì „ì— ëª¨ë‘ ë¬µë…...</span>`;
  }

  writeLog(logMsg, true);

  // ğŸ’¥ 25ê°• ì´ìƒ íŒŒê´´ ì‹œ ë¶‰ì€ í”Œë˜ì‹œ + ì „ì²´ ì—°ì¶œ
  if (before >= 25) {
    playUpgradeFlash("red");

    // ğŸŒ ì „ ì„œë²„ ê³µìš© ì´ë²¤íŠ¸ ê¸°ë¡ (ì—¬ê¸°ê°€ 4ë‹¨ê³„)
    try {
      globalEventsRef.push({
        type: "destroy25",
        userId: userId,
        level: targetLevel,
        createdAt: firebase.database.ServerValue.TIMESTAMP
      });
    } catch (e) {
      console.error("globalEventsRef push ì‹¤íŒ¨:", e);
    }
  }

  if (before >= 25) {
    // ğŸ•¯ 25ê°• ì´ìƒ íŒŒê´´ ì‹œ í¼ê·¸ë€íŠ¸ íŠ¹ìˆ˜ ë©˜íŠ¸
    const shardLine =
      gainedShard > 0
        ? `<br><span style="color:#b0e0ff;">ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê° ${gainedShard}ê°œ</span>ê°€ ë‚¨ì•˜ë‹¤...`
        : "";

    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF4444;">
        ì¥ë¹„ê°€ ì‚°ì‚°ì´ ë¶€ì„œì ¸ ë²„ë ¸êµ°...
      </div>
      <div style="margin-top:6px; font-size:13px; line-height:1.5;">
        ${coloredLevel(targetLevel)}ë¥¼ í–¥í•œ ë„ì „ì€ ì‹¤íŒ¨ë¡œ ëë‚¬ì§€ë§Œ,<br>
        ì´ëŸ° ë°œê±¸ìŒì´ ì§„ì§œ ì¥ì¸ì„ ë§Œë“ ë‹¤ë„¤.${shardLine}
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else if (gainedShard > 0) {
    // ê¸°ì¡´: ë³„ ì¡°ê° ì„¤ëª… ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold; color:#FFDD88;">
        ì•ˆíƒ€ê¹ê²Œë„ íŒŒê´´ë˜ì—ˆì§€ë§Œ...
      </div>
      <div style="margin-top:6px; font-size:13px; line-height:1.5;">
        ì¹¼ë‚ ì´ ë¶€ì„œì§„ ìë¦¬ì—ì„œ<br>
        <span style="color:#b0e0ff;">ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê° ${gainedShard}ê°œ</span>ê°€ ë‚¨ì•˜ë„¤.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  } else {
    // ê¸°ì¡´ ê¸°ë³¸ ì‹¤íŒ¨ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; color:#FF4444;">
        ì¥ë¹„ê°€ ì‚°ì‚°ì¡°ê° ë‚˜ ë²„ë ¸êµ°...
      </div>
      <div style="margin-top:6px;">
        ë‹¤ìŒ ì¹¼ë‚ ì€ ì˜¤ëŠ˜ì˜ ì‹¤íŒ¨ë¥¼ ê¸°ì–µí•  ê±°ì•¼.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  }

  }
      }
    }
  }

      // ğŸ†• ğŸ”¥ 5% ì£¼ë¬¸ì„œ íŠ¹ìˆ˜ ì‹¤íŒ¨ ë©˜íŠ¸ (ê¸°ì¡´ ì‹¤íŒ¨ ë©˜íŠ¸ë¥¼ ë®ì–´ì”€)
  if (useRate5 && sword <= before) {
    let detailText = "";

    if (sword === 0 && before > 0) {
      // íŒŒê´´ê¹Œì§€ ë‚œ ê²½ìš°
      detailText = "ê²€ì´ ì‚°ì‚°ì¡°ê° ë‚˜ ë²„ë ¸ì§€.";
    } else if (sword < before) {
      // ê°•ë“±ëœ ê²½ìš°
      detailText = `í•œ ë‹¨ê³„ ë‚´ë ¤ì•‰ì•˜ê³ , <span style="color:#ffb74d;">+${before}ê°• â†’ +${sword}ê°•</span>ì´ ë˜ì–´ ë²„ë ¸êµ°.`;
    } else {
      // ë ˆë²¨ì€ ê·¸ëŒ€ë¡œ(ì„¸ì´í”„ êµ¬ê°„ ì‹¤íŒ¨ ë“±)
      detailText = "ë‹¤í–‰íˆ ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œì§€ë§Œ, ë§ˆìŒì€ ê½¤ ì“°ë¦¬ê² êµ°.";
    }

    showNpcMessage(
      `
      <div style="font-size:18px; font-weight:bold; margin-bottom:4px; color:#FF8A80;">
        ê°•í™” ì‹¤íŒ¨...
      </div>
      <div style="font-size:13px; line-height:1.6;">
        ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œê¹Œì§€ ì¨ ê°€ë©° ë¶ˆê¸¸ì„ ëŒì–´ì˜¬ë ¸ëŠ”ë°ë„ ì•ˆ ë¶™ë‹¤ë‹ˆâ€¦<br>
        ${detailText}<br>
        ë­, ì§„ì§œ ì¥ì¸ì€ ì´ëŸ° ë‚ ì„ ëª‡ ë²ˆì´ë‚˜ ê²ªê³  ë‚˜ì„œì•¼ ì™„ì„±ë˜ëŠ” ë²•ì´ì§€.
      </div>
      `,
      "images/npc/blacksmith_fail.png"
    );
  }

    // âœ… ì‹¤íŒ¨ ì—°ê¸°(íŒŒê´´ë©´ ë” ê°•í•˜ê²Œ) â€” ì‹¤íŒ¨ ë¶„ê¸°ì—ì„œë§Œ ì‹¤í–‰
if (!isSuccess) {
  spawnWeaponSmoke((sword === 0 && before > 0) ? 2 : 1);
}
    
// âœ… ê²°ê³¼ ì—°ì¶œ + UI ê°±ì‹ (ë¬´ê¸° ì´ë¯¸ì§€ ë³€ê²½ íƒ€ì´ë° ì œì–´)
save(); // ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨) ê³„ì‚°ìœ¼ë¡œ ë°”ë€ ê°’ë“¤ ë¨¼ì € ì €ì¥

playWeaponResultAndUpdate(isSuccess, () => {
  // ì—¬ê¸°ì„œ update()ê°€ ì‹¤í–‰ë˜ë©´ì„œ â€œì´ë¯¸ì§€ êµì²´ íƒ€ì´ë°â€ì´ ì—°ì¶œ ì¤‘ê°„ì— ë“¤ì–´ê°
  update();

  const titleChanged = checkAndGrantTitles();
  if (titleChanged) save();
  save();

  // ì ê¸ˆ í•´ì œ
  isUpgrading = false;
  const actionButtons = document.querySelectorAll(".action-buttons button");
  actionButtons.forEach(btn => btn.disabled = false);
});

  }, delayMs);
}

// ğŸ›’ ì‹¤ì œ íŒë§¤ ì²˜ë¦¬ + "íŒë§¤ ì™„ë£Œ" ë©˜íŠ¸
function completeSell(beforeLevel, rewardGold) {
  setNpcName("ë¬´ê¸°ìƒì¸ â€“ ë°”ë¥´í†¨ ë¡œë„¨");

  // íŒë§¤ ì²˜ë¦¬
  gold += rewardGold;
  sword = 0;
  weaponType = null;
  rollPowerForCurrentSword();

  // 20ê°• ì´ìƒ ì „ìš© ì™„ë£Œ ë©˜íŠ¸
  if (beforeLevel >= 20) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        â€¦ì•Œì•˜ë‹¤.
      </div>
      <div style="margin-top:4px;">
        ì´ ê²€ì€ ë‚´ê°€ ì±…ì„ì§€ê³  ë³´ê´€í•˜ì§€.<br>
        ê·¸ëŒ€ì˜ ì„ íƒì— ê°’í•˜ì—¬
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ë¥¼ ì§€ê¸‰í•˜ê² ë„¤.
      </div>
      `,
      "images/npc/merchant_bartol.png"
    );
  } else {
    // ì¼ë°˜ ì¥ë¹„ íŒë§¤ ì™„ë£Œ ë©˜íŠ¸
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ê±°ë˜ ì„±ì‚¬ëêµ°.
      </div>
      <div style="margin-top:4px;">
        ì¢‹ì€ ì„ íƒì´ì—ˆë„¤, ëª¨í—˜ê°€.<br>
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ë¥¼ ì§€ê¸‰í–ˆë„¤.
      </div>
      `,
      "images/npc/merchant_bartol.png"
    );
  }

  update();
  save();
}

  // ğŸ›’ ë°”ë¥´í†¨ ë¡œë„¨ íŒë§¤ í™•ì¸ íŒì—… (20ê°• ì´ìƒ í¬ê·€ ë©˜íŠ¸ í¬í•¨)
function showMerchantSellPopup(beforeLevel, rewardGold) {
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ğŸ†• ì´ë¦„ ì„¤ì •
  setNpcName("ë¬´ê¸°ìƒì¸ â€“ ë°”ë¥´í†¨ ë¡œë„¨");
  // ìƒì¸ ì´ë¯¸ì§€ë¡œ êµì²´
  imgEl.src = "images/npc/merchant_bartol.png";

  let innerHtml = "";

  if (beforeLevel >= 20) {
    // ğŸ§¿ 20ê°• ì´ìƒ â€” í¬ê·€ í‰ê°€ ë©˜íŠ¸ ëœë¤
    const rareLines = [
      "ì´ ê²€â€¦ ìˆ˜ë§ì€ ì „ì¥ì„ ì§€ë‚˜ì˜¨ í”ì ì´ ë³´ì´ëŠ”êµ°.",
      "ì´ ë¬´ê¸°â€¦ ì£¼ì¸ì„ ì˜ ë§Œë‚¬ë˜ ê²€ì´ì•¼.",
      "ì „ì„¤ê¸‰ì´ë¼ ë¶€ë¥¼ ë§Œí•˜êµ°. ì‰½ê²Œ ë³¼ ë¬¼ê±´ì´ ì•„ë‹ˆì•¼."
    ];
    const flavor =
      rareLines[Math.floor(Math.random() * rareLines.length)];

    innerHtml = `
      <div style="font-size:16px; margin-bottom:6px;">
        ${flavor}
      </div>
      <div>
        ê°€ì¹˜ë¥¼ ì¡´ì¤‘í•´
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ì— ë§¤ì…í•˜ì§€.<br>
        ì •ë§ ë– ë‚˜ë³´ë‚´ê² ë‚˜?
      </div>
    `;
  } else {
    // ğŸŸ¡ ì¼ë°˜ ì¥ë¹„ ë©˜íŠ¸
    innerHtml = `
      <div style="font-size:16px; margin-bottom:6px;">
        í â€¦ ì¢‹ì€ ì¥ë¹„ë¥¼ ê°–ê³  ìˆêµ° ê·¸ë˜.
      </div>
      <div>
        ë‚´ ëˆˆìœ¼ë¡œ ë³´ê±´ëŒ€
        <b>${formatGold(rewardGold)} ê³¨ë“œ</b>ì— ë§¤ì…í•´ ì£¼ê² ë„¤.<br>
        ì •ë§ íŒë§¤í•˜ê² ë‚˜?
      </div>
    `;
  }

  msgEl.innerHTML = innerHtml;

  // ë²„íŠ¼ ì„¤ì •
  okBtn.style.display = "inline-block";
  cancelBtn.style.display = "inline-block";
  okBtn.textContent = "íŒë§¤í•œë‹¤";
  cancelBtn.textContent = "ê·¸ë§Œë‘”ë‹¤";

  // ê¸°ì¡´ onclick ì œê±° í›„ ìƒˆë¡œ ë“±ë¡
  okBtn.onclick = function () {
    popup.style.display = "none";
    // íŒë§¤ í™•ì •
    completeSell(beforeLevel, rewardGold);
  };

  cancelBtn.onclick = function () {
    popup.style.display = "none";
    // ì·¨ì†Œ ì‹œ ì´ë¯¸ì§€ ì›ë³µ (ëŒ€ì¥ì¥ì´ ê¸°ë³¸ìœ¼ë¡œ)
    imgEl.src = "images/npc/blacksmith_idle.png";
  };

  popup.style.display = "flex";
}
  
function sell() {

  // âŒ ëŒ€ì¥ê°„ì´ ì•„ë‹ˆë©´ íŒë§¤ ë¶ˆê°€
if (!isInFulgurantForge()) {
  showGoToForgeMessage();
  return;
}

  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (sword <= 0) {
    alert("íŒë§¤í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const before = sword;
  const reward = getSellReward(before);

  // ğŸ” ë°”ë¡œ íŒë§¤í•˜ì§€ ì•Šê³ , ë°”ë¥´í†¨ íŒë§¤ í™•ì¸ íŒì—… í˜¸ì¶œ
  showMerchantSellPopup(before, reward);
}

/* ì‚¬ëƒ¥ */
function hunt(){

     // âœ… íŠœí† ë¦¬ì–¼ ì‹œì‘ ë§µ(0ë²ˆ)ì—ì„œëŠ” ì‚¬ëƒ¥ ë¶ˆê°€
if (currentField === 0) {
  showHuntPopup(
    "ì—¬ê¸´ ì‚¬ëƒ¥ê°ì´ ì—†ì–´.<br>ì˜¤ë¥¸ìª½ ìœ„ <b>ì§€ë„</b>ë¥¼ ëˆŒëŸ¬ ì‚¬ëƒ¥í„°ë¡œ ì´ë™í•´ì•¼ í•´.",
    "#FFD27D"
  );
  return;
}
    
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  // ì‚¬ëƒ¥ ì „ ìŠ¤íƒœë¯¸ë‚˜ ìµœì‹ í™”
  recalcHuntStamina();

  // ìŠ¤íƒœë¯¸ë‚˜ê°€ 0ì´ë©´ ì‚¬ëƒ¥ ë¶ˆê°€
  if (huntStamina <= 0) {
    showHuntPopup(
      `
      <div style="font-size:18px; font-weight:bold;">
        ì‚¬ëƒ¥ ë¶ˆê°€
      </div>
      <div style="margin-top:6px; font-size:14px;">
        ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
        ì‹œê°„ì´ ì§€ë‚˜ë©´ ë‹¤ì‹œ íšŒë³µë©ë‹ˆë‹¤.
      </div>
      `,
      "#CCCCCC"
    );
    return;
  }

   spawnHuntCoinPop();

  const field = HUNT_FIELDS[currentField];
  if (!field) {
    alert("ì‚¬ëƒ¥í„°ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const successChance = getHuntSuccessChance(sword, currentField);

  if (successChance <= 0) {
    alert("ì´ ì‚¬ëƒ¥í„°ëŠ” ì§€ê¸ˆ ì¥ë¹„ë¡œëŠ” ë„ˆë¬´ ìœ„í—˜í•©ë‹ˆë‹¤! (ì„±ê³µë¥  0%)");
    return;
  }

// ì‹¤ì œ ê³µê²©ë ¥ì€ ë¯¸ë¦¬ êµ´ë ¤ë‘” power ì‚¬ìš© (Â±5% í¸ì°¨ ë°˜ì˜ëœ ê°’)
const atk = power; // ì§€ê¸ˆì€ ì‚¬ìš© X, ë‚˜ì¤‘ì— ì‚¬ëƒ¥ ë°ë¯¸ì§€/ì„±ê³µë¥ ì— ë°˜ì˜ ê°€ëŠ¥

// ğŸ¦  ì—­ë³‘ì¥(ì‹œê¶ì°½) ì‚¬ëƒ¥ ì¹´ìš´íŠ¸: "ì‚¬ëƒ¥ ì‹œë„" 1íšŒë¡œ ëˆ„ì 
if (currentField === 2) {
  plagueRatHuntCount = Number(plagueRatHuntCount || 0) + 1;
}

// ì„±ê³µ ì—¬ë¶€
const r = Math.random() * 100;
if (r < successChance) {
  // âœ… ì„±ê³µ
  playHuntSuccessSfx();
  const reward = getHuntReward(currentField);

  const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
  const goldPct = Number(st && st.huntGoldGainPct ? st.huntGoldGainPct : 0);
  const dropPct = Number(st && st.huntDropPct ? st.huntDropPct : 0);

  const finalReward = Math.floor(reward * (1 + Math.max(0, goldPct) / 100));
  gold += finalReward;

  // ğŸ”” ê¸°ë³¸ íŒì—… ë¬¸êµ¬ (ê³¨ë“œ ë³´ìƒ)
  let popupMsg = `ì‚¬ëƒ¥ ì„±ê³µ!<br>ğŸ’° ${formatGold(finalReward)} ê³¨ë“œ íšë“` + (goldPct > 0 ? ` <span style="color:#7CFCB0;">(+${goldPct}%)</span>` : "");

  // âœ… ë“œëí™•ë¥  ë³´ì • í•¨ìˆ˜
  const adjDrop = (base) => {
    const p = base * (1 + Math.max(0, dropPct) / 100);
    return Math.min(0.95, p);
  };

  // ğŸ ì•„ì´í…œ ë“œë ì²˜ë¦¬

  // LV6 ì´ìƒ: 3% í™•ë¥ ë¡œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
  if (currentField >= 6 && Math.random() < adjDrop(0.015)) {
    itemScroll15 += 1;

    popupMsg += `<br><br>ğŸ“œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV7 ì´ìƒ: 2% í™•ë¥ ë¡œ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
  if (currentField >= 7 && Math.random() < adjDrop(0.01)) {
    itemProtect += 1;

    popupMsg += `<br>ğŸ›¡ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV8 ì´ìƒ: 1% í™•ë¥ ë¡œ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
  if (currentField >= 8 && Math.random() < adjDrop(0.005)) {
    itemSuper += 1;

    popupMsg += `<br>âœ¨ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // LV4 ì´ìƒ: 10% í™•ë¥ ë¡œ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ
  if (currentField >= 4 && Math.random() < adjDrop(0.05)) {
    itemDownProtect += 1;

    popupMsg += `<br>ğŸ”’ ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œë¥¼ íšë“í–ˆë‹¤!`;

    writeLog(
      `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  // âœ… ìµœì¢… íŒì—… í•œ ë²ˆë§Œ í˜¸ì¶œ (ê³¨ë“œ + ë“œë ê²°ê³¼ ëª¨ë‘ í¬í•¨)
  showHuntPopup(popupMsg, "#6CF");

} else {
  // âŒ ì‹¤íŒ¨
  showHuntPopup(
    "ì‚¬ëƒ¥ ì‹¤íŒ¨...<br>ë‹¤ìŒ ê¸°íšŒë¥¼ ë…¸ë¦¬ì.",
    "#FF6666"
  );
}

  // âœ… ì‚¬ëƒ¥ 1íšŒë‹¹ ìŠ¤íƒœë¯¸ë‚˜ 1 ê°ì†Œ
  const beforeStamina = huntStamina;
  huntStamina = Math.max(0, huntStamina - 1);
  // ì°¸ê³ ìš© ì¹´ìš´íŠ¸ (ì˜¤ëŠ˜ ì‚¬ìš©í•œ íšŸìˆ˜)
  huntCountToday = Math.max(0, 20 - huntStamina);

  // ğŸ” 20/20 â†’ 19/20ìœ¼ë¡œ ì²˜ìŒ ì¤„ì–´ë“œëŠ” ìˆœê°„ë¶€í„° 20ë¶„ ì¹´ìš´íŠ¸ ì‹œì‘
  if (beforeStamina === 20 && huntStamina === 19) {
    lastStaminaUpdate = Date.now();
  }

  update();
  save();
}

// ğŸ¯ ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥  ê³„ì‚°
function getHuntSuccessChance(myLevel, fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;

  const rec = field.recLevel; // ì¶”ì²œ ê°•í™” ë ˆë²¨
  const diff = rec - myLevel;

  if (diff <= 0) return 100;     // ê¶Œì¥ ë ˆë²¨ ì´ìƒì´ë©´ 100%
  if (diff >= 5) return 0;       // ë„ˆë¬´ ì°¨ì´ë‚˜ë©´ 0%

  // 1~4 ì°¨ì´: 80 / 60 / 40 / 20 %
  return 100 - diff * 20;
}

  // ğŸ’° ì‚¬ëƒ¥ ì„±ê³µ ì‹œ ê³¨ë“œ ë³´ìƒ
function getHuntReward(fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;
  
  // ğŸŒ± LV1 ì‚¬ëƒ¥í„°ëŠ” 0~20ê³¨ë“œ ëœë¤
  if (fieldId === 1) {
    return Math.floor(randRange(0, 21)); // 0 ì´ìƒ 21 ë¯¸ë§Œ â†’ 0~20
  }
  // ì„¤ëª…ì— ë”°ë¼: ì˜ˆ) 3LV â†’ 6ê°• ê°•í™”ë¹„ìš© ì‚¬ìš©
  const refLevel = field.recLevel;    // 0,3,6,...,27
  const baseCost = getUpgradeCost(refLevel); // í•´ë‹¹ ê°•ì˜ ê°•í™”ë¹„ìš©

  const mul = randRange(1.0, 1.5);   // 1.0 ~ 1.5 ë°°
  // âœ… ì°¨ì›ì˜ í‹ˆìƒˆ(í•„ë“œ 10) ê³¨ë“œ ìˆ˜ê¸‰ ì ˆë°˜ íŒ¨ì¹˜
const rate = (fieldId === 10) ? 0.2 : 0.4;
return Math.floor(baseCost * mul * rate);
}

// âœ… (ì¶”ê°€) ìš”ì†Œê°€ ì—†ì–´ë„ í¬ë˜ì‹œ ì•ˆ ë‚˜ê²Œ display í† ê¸€
function setDisplay(id, displayValue) {
  const el = document.getElementById(id);
  if (!el) return;
  el.style.display = displayValue;
}

function login() {
    
  // 1ï¸âƒ£ DOMì—ì„œ ì§ì ‘ ì…ë ¥ì°½ ê°€ì ¸ì˜¤ê¸°
  const idInput = document.getElementById("loginId");
  const pwInput = document.getElementById("loginPw");

  if (!idInput || !pwInput) {
    alert("ë¡œê·¸ì¸ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // 2ï¸âƒ£ ê°’ ì½ê¸°
  userId = idInput.value.trim();
  userPassword = pwInput.value;

  if (!userId || !userPassword) {
    alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // âœ… (ì¤‘ìš”) ë¡œê·¸ì¸ ì‹œë„ ì‹œì‘í•  ë•Œ ì´ì „ ê³„ì • ì¹­í˜¸ í”ì  ì œê±°
titlesOwned = {};
equippedTitle = "";
closeTitleOverlay();
  
weaponType   = null;
maxSwordLevel = 0;
destroyCount  = 0;

  
  // 3ï¸âƒ£ Firebase ref ì„¸íŒ…
  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {

      // âœ… (ì‹ ê·œ ê³„ì •) ì„œë²„ì— ì˜¬ë¼ì™€ ìˆëŠ” ìµœì‹  +30 ì´ë²¤íŠ¸ë¥¼ ì½ì–´ì„œ "ì´ë¯¸ ë³¸ ê²ƒ"ìœ¼ë¡œ ì €ì¥
// Date.now()ë¡œ ì°ìœ¼ë©´ ì‹ ê·œìœ ì € ì²« ë¡œê·¸ì¸ì— ê¸°ì¡´ +30 íŒì—…ì´ ëœ° ìˆ˜ ìˆìŒ
function initNewUserGlobal30Seen() {
  return globalEventsRef.child(GLOBAL30_KEY).once("value").then(snap => {
    const v = snap.val() || {};
    lastSeenGlobal30EventId = Number(v.id || 0); // ì´ë²¤íŠ¸ ì—†ìœ¼ë©´ 0
    aweUsedGlobal30EventId = 0;
    weaponLocked = {};
  }).catch(() => {
    lastSeenGlobal30EventId = 0;
    aweUsedGlobal30EventId = 0;
    weaponLocked = {};
  });
}
    
    // â­ ì‹ ê·œ ê³„ì • ìƒì„± ì‹œ (ë¡œê·¸ì¸ì—ì„œëŠ” ì‹ ê·œ ìƒì„± ê¸ˆì§€)
if (!s.exists()) {
  alert("ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì •ì…ë‹ˆë‹¤.\nì‹ ê·œ ê³„ì •ì€ 'ì‹ ê·œ ìƒì„±' ë²„íŠ¼ìœ¼ë¡œë§Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  return;
} else {
  // â­ ê¸°ì¡´ ê³„ì • ë¡œê·¸ì¸ ì‹œ
  const data = s.val();

// ğŸ” ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì† ì¤‘ì´ë©´: ì‹œìŠ¤í…œ alert ëŒ€ì‹  "ì ‘ì†ëŠê¸°" íŒì—…
// ğŸ” ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì† ì¤‘ì´ë©´: "ì‚´ì•„ìˆëŠ”" ë‹¤ë¥¸ ì„¸ì…˜ë§Œ ë§‰ê¸°
// - ê°™ì€ ê¸°ê¸° ìƒˆë¡œê³ ì¹¨(ê°™ì€ sessionId)ì´ë©´ í†µê³¼
// - í•˜íŠ¸ë¹„íŠ¸ ëŠê¸´ ì£½ì€ ì„¸ì…˜ì´ë©´ í†µê³¼(ìë™ ë³µêµ¬)
if (data.sessionId) {
  const mySid = getLocalSessionId(userId);

  const isSameDeviceSession = (mySid && data.sessionId === mySid);
  const isDead = isSessionStale(data);

  if (!isSameDeviceSession && !isDead) {
    showAlreadyOnlinePopup(userId, data);
    return;
  }
}

      if (data.password !== userPassword) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        return;
      }

      // âœ… ì—¬ê¸°ì„œë¶€í„° ì§„ì§œ ë¡œê·¸ì¸ ì„±ê³µì´ í™•ì •ëœ ë’¤ì—ë§Œ ì¹­í˜¸ ë¡œë“œ
titlesOwned = (data.titlesOwned && typeof data.titlesOwned === "object") ? data.titlesOwned : {};
equippedTitle = (typeof data.equippedTitle === "string") ? data.equippedTitle : "";
      // ğŸ§¹ ê³¼ê±° ë²„ê·¸ ê°’ ì •ë¦¬: "${titleId}" ê°™ì€ ì“°ë ˆê¸° ê°’ì´ë©´ ì¥ì°© í•´ì œ
if (equippedTitle && equippedTitle.includes("${")) equippedTitle = "";

      plagueRatHuntCount = Number(data.plagueRatHuntCount || 0);
      gamblerRunActive = !!data.gamblerRunActive;
      gamblerRunNoScroll = (data.gamblerRunNoScroll !== false); // ê¸°ë³¸ true
      fireworksDestroyed = data.fireworksDestroyed || { 21:false, 22:false, 23:false, 24:false, 25:false };
      reach30Count = Number(data.reach30Count || 0);
      weapon30Counts = data.weapon30Counts || {};
      hofDeadline = Number(data.hofDeadline || 0);
      hofAchievedAt = Number(data.hofAchievedAt || 0);
      hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
      hofProcessedAt = Number(data.hofProcessedAt || 0);
      superSuccessCount = Number(data.superSuccessCount || 0);
      downStreak        = Number(data.downStreak || 0);
      dopamineTried     = Number(data.dopamineTried || 0);
      lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
      aweUsedGlobal30EventId  = Number(data.aweUsedGlobal30EventId || 0);

      sword = data.sword ?? 0;
      gold  = data.gold  ?? 100;

// âœ… ê°ì¸(í”„ë¦¬ì…‹) ë¡œë“œ + êµ¬ë²„ì „(engraveLines) â†’ Preset1 ì´ê´€
engravePresetIdx = Number(data.engravePresetIdx ?? 0);

// Firebase RTDBëŠ” ë°°ì—´ì´ {0:...,1:...,2:...} í˜•íƒœë¡œ ë‚´ë ¤ì˜¬ ìˆ˜ ìˆìŒ
const toArr3 = (v) => {
  if (Array.isArray(v)) return v;
  if (v && typeof v === "object") return [v[0] ?? v["0"], v[1] ?? v["1"], v[2] ?? v["2"]];
  return null;
};

const normLines3 = (v) => {
  const a = toArr3(v);
  if (!a) return ["-","-","-"];
  return [a[0] || "-", a[1] || "-", a[2] || "-"];
};

// presets ìì²´ë„ ë°°ì—´/ê°ì²´ ëª¨ë‘ ì²˜ë¦¬
const rawPresets = toArr3(data.engravePresets);

if (rawPresets) {
  // ê° preset(0/1/2)ë„ ë°°ì—´/ê°ì²´ ëª¨ë‘ ì²˜ë¦¬
  const p0 = rawPresets[0] ?? rawPresets["0"];
  const p1 = rawPresets[1] ?? rawPresets["1"];
  const p2 = rawPresets[2] ?? rawPresets["2"];
  engravePresets = [normLines3(p0), normLines3(p1), normLines3(p2)];
} else {
  // êµ¬ë²„ì „ ì €ì¥ê°’(engraveLines)ë§Œ ìˆëŠ” ìœ ì €ëŠ” Preset1ë¡œ ì´ê´€
  const old = (Array.isArray(data.engraveLines) && data.engraveLines.length)
    ? [data.engraveLines[0] || "-", data.engraveLines[1] || "-", data.engraveLines[2] || "-"]
    : ["-","-","-"];
  engravePresets = [old, ["-","-","-"], ["-","-","-"]];
  engravePresetIdx = 0;
}

ensureEngravePresetShape();

      // ğŸ—¡ ë¬´ê¸° íƒ€ì… ë¡œë“œ (v3.8 ì´ì „ ê³„ì • í˜¸í™˜ìš©)
if (data.weaponType !== undefined && data.weaponType !== null) {
  // v3.8 ì´í›„ì— ì €ì¥ëœ ê³„ì •
  weaponType = data.weaponType;
} else {
  // êµ¬ë²„ì „ ê³„ì • (weaponType ì—†ìŒ)
  if (sword > 0) {
    // ì´ë¯¸ ë¬´ê¸°ê°€ 1ê°• ì´ìƒì¸ ìœ ì €ëŠ” ì¼ë‹¨ 'ê²€' ë£¨íŠ¸ë¡œ ê°„ì£¼
    weaponType = "sword";
  } else {
    // 0ê°•ì´ë©´ ì•„ì§ ë¯¸ë°°ì • â†’ ë‹¤ìŒì— ì²˜ìŒ ê°•í™”í•  ë•Œ ëœë¤
    weaponType = null;
  }
}
      
      // â­ ì´ ì‹œì ì˜ ê°•í™”ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ ê¸°ë¡
      lastSavedSwordForUpdated = sword;
      
      // ìµœê³  ê°•í™” / íŒŒê´´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
      maxSwordLevel = data.maxSwordLevel ?? sword; // ì—†ìœ¼ë©´ í˜„ì¬ ê°•í™”ë¡œ ì´ˆê¸°í™”
      destroyCount  = data.destroyCount  ?? 0;
      
      // ğŸŸ¢ ì „íˆ¬ë ¥ ë¶ˆëŸ¬ì˜¤ê¸° (ì—†ê±°ë‚˜ êµ¬ë²„ì „ì´ë©´ ì¬ê³„ì‚°)
      power = Number(data.power ?? 0);
      if (!power || power <= 20) {
        rollPowerForCurrentSword();
      }

      attendanceCount    = data.attendanceCount    ?? 0;
      lastAttendanceDate = data.lastAttendanceDate ?? "";
      attendanceStreak   = data.attendanceStreak   ?? 0;  
      lastAttendanceDay  = data.lastAttendanceDay  ?? "";
      currentField       = data.currentField       ?? 1;
      huntCountToday     = data.huntCountToday     ?? 0;
      lastHuntDate       = data.lastHuntDate       ?? "";
      itemScroll15       = data.itemScroll15 ?? 0;
      itemProtect        = data.itemProtect  ?? 0;
      itemSuper          = data.itemSuper    ?? 0;
      itemDownProtect    = data.itemDownProtect ?? 0;
      starShard          = data.starShard ?? 0;
      itemEssence = Number(data.itemEssence || 0);
      itemMagicPaper = Number(data.itemMagicPaper || 0);
      itemEngraveNormal = Number(data.itemEngraveNormal || 0);
      itemEngraveAdvanced = Number(data.itemEngraveAdvanced || 0);
      couponUsedMap = data.couponUsed || {};
      // âœ… ëª…ì˜ˆì˜ì „ë‹¹(30ê°•) / ê¸€ë¡œë²Œ 30ê°• ì´ë²¤íŠ¸ ìƒíƒœ ë¡œë“œ
      hofDeadline = Number(data.hofDeadline || 0);
      hofAchievedAt = Number(data.hofAchievedAt || 0);
      hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
      hofProcessedAt = Number(data.hofProcessedAt || 0);

      lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
      aweUsedGlobal30EventId = Number(data.aweUsedGlobal30EventId || 0);

      reach30Count = Number(data.reach30Count || 0);

      itemScroll21    = Number(data.itemScroll21    ?? 0); 
      itemRateUp5     = Number(data.itemRateUp5     ?? 0);
      huntStamina        = data.huntStamina       ?? 20;
      lastStaminaUpdate  = data.lastStaminaUpdate ?? Date.now();

      // âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ê°’
      duelWin        = data.duelWin        ?? 0;
      duelLose       = data.duelLose       ?? 0;
      duelCountToday = data.duelCountToday ?? 0;
      lastDuelDate   = data.lastDuelDate   ?? "";
      duelTargetsToday = data.duelTargetsToday ?? {};
      bully10Count      = Number(data.bully10Count || 0);
      challenger10Count = Number(data.challenger10Count || 0);
      brawl500Count     = Number(data.brawl500Count || 0);
      warGodWin         = Boolean(data.warGodWin || false);
      itemHonorMedal = data.itemHonorMedal ?? 0;
        // â­ ê²°íˆ¬ í¬ì¸íŠ¸ ë¡œë“œ (ì—†ìœ¼ë©´ 0)
      duelPoint       = data.duelPoint ?? 0;
      duelPointWeekKey = data.duelPointWeekKey || "";
      duelLastWeekPoint = data.duelLastWeekPoint ?? 0;
      duelLastWeekRank  = data.duelLastWeekRank ?? 0;
      duelLastWeekRewardClaimed = data.duelLastWeekRewardClaimed ?? false;
      duelUpdated         = data.duelUpdated ?? 0;
      duelLastWeekUpdated = data.duelLastWeekUpdated ?? 0;
      
      // ğŸŸ¢ ì£¼ì°¨ ì •ë¦¬ (ì§€ë‚œì£¼ í¬ì¸íŠ¸ ìŠ¤ëƒ…ìƒ· + ì´ë²ˆ ì£¼ ì´ˆê¸°í™”)
      ensureDuelWeek();
      // ğŸ† ì§€ë‚œì£¼ ë³´ìƒ ì²´í¬ & ì§€ê¸‰
      checkWeeklyDuelReward();

// ğŸ›ï¸ ëª…ì˜ˆì˜ ì „ë‹¹ UI + ìë™ ì „ë‹¹í–‰ ìŠ¤ìœ• + ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ êµ¬ë… ì‹œì‘
loadHallOfFame();
startHonorHallTimers();
updateHonorHallButton();
subscribeGlobal30Events();
   }

    // ğŸŸ¢ ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ëŠ” ê±´ ì‹¤ì œë¡œ ì´ íƒ­ì´ ì ‘ì†ì„ ê°€ì ¸ê°€ëŠ” ê²ƒ â†’ ì„¸ì…˜ ì‹œì‘
    startSession();
    ensureBossRunsSubscription();  // âœ… ë¡œê·¸ì¸ ì§í›„ì—ë„ í† ë²Œ êµ¬ë…/ë³µêµ¬ ì‹œì‘

        // í™”ë©´ ì „í™˜
const loginScreen = document.getElementById("loginScreen");
const gameScreen  = document.getElementById("gameScreen");

if (loginScreen) loginScreen.style.display = "none";
if (gameScreen)  gameScreen.style.display  = "block";

// âœ… ë²„íŠ¼/íŒ¨ë„ë“¤(ì—†ì–´ë„ í¬ë˜ì‹œ X)
setDisplay("attendanceIconBtn",   "block");
setDisplay("logoutBtn",       "none");
setDisplay("couponBtn",       "none");
setDisplay("hamburgerBtn",    "block");

setDisplay("duelIconBtn",     "block");
setDisplay("guildIconBtn",    "block");
setDisplay("mapBtn",          "block");
setDisplay("userListIconBtn", "block");
setDisplay("bossBattleIconBtn", "block");
setDisplay("achievementIconBtn",  "block");

setDisplay("toastLog",        "block");
setDisplay("workbenchDock",   "block");
setDisplay("workbenchDockUI", "flex");
    
        // âœ… ì—¬ê¸°ì—ì„œ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì‹œì‘
    startAutoRefreshTimer();

        // ğŸŒ 25ê°• ì´ìƒ íŒŒê´´ ê¸€ë¡œë²Œ ì•Œë¦¼ êµ¬ë… ì‹œì‘
    subscribeGlobalDestroyEvents();
        
    // ğŸ” ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ìœ ì € ì €ì¥
    try {
      localStorage.setItem("swordGameLastUser", userId);
    } catch (e) {
      console.warn("localStorage set ì‹¤íŒ¨", e);
    }

    update();
    showTutorialIfFirstTime();
    loadHallOfFame();
startHonorHallTimers();
updateHonorHallButton();
    loadUpdateNotices();   // ğŸ”” ë¡œê·¸ì¸ í›„ ê³µì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    ensureDuelWeek();

    // ğŸ† ë¡œê·¸ì¸ ì§í›„ ë­í‚¹/ë‚´ ë­í‚¹ ê°±ì‹ 
    loadRanking();

// ğŸ·ï¸ ì¹­í˜¸ ìë™ ì§€ê¸‰(ë¡œê·¸ì¸ ë¡œë“œ ì§í›„)
const titleChanged = checkAndGrantTitles();
if(titleChanged) save();
  });
}

  function createAccount() {
  // 1) ì…ë ¥ê°’ ì½ê¸°
  const idInput = document.getElementById("loginId");
  const pwInput = document.getElementById("loginPw");

  if (!idInput || !pwInput) {
    alert("ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const newId = idInput.value.trim();
  const newPw = pwInput.value;

  if (!newId || !newPw) {
    alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    return;
  }

  // (ì„ íƒ) ì‹¤ìˆ˜ ë°©ì§€ í™•ì¸
  if (!confirm(`ì‹ ê·œ ê³„ì •ì„ ìƒì„±í• ê¹Œìš”?\nì•„ì´ë””: ${newId}\n\nâš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ìƒì„±ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`)) return;

  const newRef = db.ref("users/" + newId);

  // 2) ë®ì–´ì“°ê¸° ë°©ì§€: transactionìœ¼ë¡œ â€œë¹„ì–´ìˆì„ ë•Œë§Œ ìƒì„±â€
  newRef.transaction((cur) => {
    if (cur) return; // ì´ë¯¸ ìˆìœ¼ë©´ ì¤‘ë‹¨(ë®ì–´ì“°ê¸° ë°©ì§€)

    // âœ… ì—¬ê¸° newUserObjëŠ” "ë„ˆê°€ ê¸°ì¡´ì— ì“°ë˜ ì‹ ê·œìƒì„± set ê°ì²´" ê·¸ëŒ€ë¡œ ë„£ìœ¼ë©´ ë¨
    const newUserObj = {
      password: newPw,
      sword,
      weaponType: null,
      power,
      gold,
      updated: Date.now(),
      maxSwordLevel: 0,
      destroyCount: 0,
      attendanceCount: 0,
      lastAttendanceDate: "",
      attendanceStreak: 0,
      lastAttendanceDay: "",
      currentField: 0,
      huntCountToday: 0,
      plagueRatHuntCount: 0,
      dopamineTried: false,
      gamblerRunActive: false,
      gamblerRunNoScroll: true,
      fireworksDestroyed: { 21:false, 22:false, 23:false, 24:false, 25:false },
      reach30Count: 0,
      weapon30Counts: {},
      hofDeadline: 0,
      hofAchievedAt: 0,
      hofWeaponTypeAt30: "",
      hofProcessedAt: 0,
      lastHuntDate: "",
      itemScroll15: Number(itemScroll15),
      itemProtect: Number(itemProtect),
      itemSuper: Number(itemSuper),
      itemDownProtect: Number(itemDownProtect),
      starShard: Number(starShard),
      itemScroll21: 0,
      itemRateUp5: 0,
      huntStamina: 20,
      lastStaminaUpdate: Date.now(),
      duelWin: 0,
      duelLose: 0,
      duelCountToday: 0,
      lastDuelDate: "",
      duelTargetsToday: {},
      duelPoint: 0,
      duelPointWeekKey: getKstWeekKey(),
      duelLastWeekPoint: 0,
      duelLastWeekRank: 0,
      duelLastWeekRewardClaimed: false,
      titlesOwned: {},
      equippedTitle: "",
      // âš ï¸ ë„¤ê°€ ì“°ë˜ ê¸€ë¡œë²Œ30 ê¸°ë³¸ê°’ë„ ì—¬ê¸° í¬í•¨(ìˆìœ¼ë©´)
      // lastSeenGlobal30EventId: ...,
      // aweUsedGlobal30EventId: 0
    };

    return newUserObj;
  }, (err, committed, snap) => {
    if (err) {
      console.error(err);
      alert("ì‹ ê·œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      return;
    }
    if (!committed) {
      alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
      return;
    }

    // 3) ìƒì„± ì„±ê³µ â†’ ë°”ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬(ë¡œê·¸ì¸ ë£¨í‹´ ì¬ì‚¬ìš©)
const idInput2 = document.getElementById("loginId");
const pwInput2 = document.getElementById("loginPw");
if (idInput2) idInput2.value = newId;
if (pwInput2) pwInput2.value = newPw;

// âœ… ë¡œê·¸ì¸ í•¨ìˆ˜ê°€: ë°ì´í„° ë¡œë“œ + í™”ë©´ ì „í™˜ + ì•„ì´ì½˜ í‘œì‹œê¹Œì§€ ì „ë¶€ ì²˜ë¦¬
login();
return;

  });
}

function save() {
  if (!userRef) return;

  const updateData = {
    sword: Number(sword),
    weaponType: weaponType,
    power: Number(power),
    gold: Number(gold),
    maxSwordLevel: Number(maxSwordLevel),
    destroyCount: Number(destroyCount),
    attendanceCount: attendanceCount,
    lastAttendanceDate: lastAttendanceDate,
    attendanceStreak: Number(attendanceStreak),
    lastAttendanceDay: lastAttendanceDay,
    currentField: currentField,
    huntCountToday: huntCountToday,
    lastHuntDate: lastHuntDate,
    itemScroll15: Number(itemScroll15),
    itemProtect: Number(itemProtect),
    itemScroll21: Number(itemScroll21 ?? 0),
    itemRateUp5: Number(itemRateUp5 ?? 0),
    itemSuper: Number(itemSuper),
    itemDownProtect: Number(itemDownProtect),
    starShard: Number(starShard),
    itemEssence: Number(itemEssence || 0),
    itemMagicPaper: Number(itemMagicPaper || 0), 
    itemEngraveNormal: Number(itemEngraveNormal || 0),
    itemEngraveAdvanced: Number(itemEngraveAdvanced || 0),
    huntStamina: Number(huntStamina),
    lastStaminaUpdate: Number(lastStaminaUpdate),
    duelWin: Number(duelWin),
    duelLose: Number(duelLose),
    duelCountToday: Number(duelCountToday),
    lastDuelDate: lastDuelDate,
    duelTargetsToday: duelTargetsToday,
    itemHonorMedal: Number(itemHonorMedal),
    duelPoint: Number(duelPoint),
    duelPointWeekKey: duelPointWeekKey,
    duelLastWeekPoint: Number(duelLastWeekPoint),
    duelLastWeekRank: Number(duelLastWeekRank),
    duelLastWeekRewardClaimed: Boolean(duelLastWeekRewardClaimed),
    duelUpdated: Number(duelUpdated || 0),
    duelLastWeekUpdated: Number(duelLastWeekUpdated || 0),
    couponUsed: couponUsedMap,   // ğŸ†• ì‚¬ìš© ì™„ë£Œ ì¿ í° ê¸°ë¡
    // ğŸ·ï¸ ì¹­í˜¸ ì €ì¥
    titlesOwned: titlesOwned,
    equippedTitle: equippedTitle,
    plagueRatHuntCount: Number(plagueRatHuntCount || 0),
    bully10Count: Number(bully10Count || 0),
    challenger10Count: Number(challenger10Count || 0),
    brawl500Count: Number(brawl500Count || 0),
    warGodWin: Boolean(warGodWin || false),
    superSuccessCount: Number(superSuccessCount || 0),
    downStreak: Number(downStreak || 0),
    dopamineTried: Number(dopamineTried || 0),
    gamblerRunActive: gamblerRunActive,
    gamblerRunNoScroll: gamblerRunNoScroll,
    fireworksDestroyed: fireworksDestroyed,
    reach30Count: reach30Count,
    weapon30Counts: weapon30Counts,
    hofDeadline: Number(hofDeadline || 0),
    hofAchievedAt: Number(hofAchievedAt || 0),
    hofWeaponTypeAt30: hofWeaponTypeAt30 || "",
    hofProcessedAt: Number(hofProcessedAt || 0),
    lastSeenGlobal30EventId: Number(lastSeenGlobal30EventId || 0),
aweUsedGlobal30EventId: Number(aweUsedGlobal30EventId || 0),
     engravePresetIdx: Number(engravePresetIdx || 0),
     engravePresets: engravePresets,
     engraveLines: engraveLines // âœ… (êµ¬ë²„ì „/ì™¸ë¶€í‘œê¸° í˜¸í™˜ìš©) "í˜„ì¬ í”„ë¦¬ì…‹" 3ì¤„

  };

  // â­ ê°•í™” ìˆ˜ì¹˜ê°€ ë°”ë€Œì—ˆì„ ë•Œë§Œ updated ê°±ì‹ 
  if (sword !== lastSavedSwordForUpdated) {
    updateData.updated = Date.now();
    lastSavedSwordForUpdated = sword;
  }

  userRef.update(updateData);
}

/* ìƒ‰ìƒ */
function getSwordColor(l){
  if (l >= 30) return "rainbow";
  if (l === 29) return "sparkle-gold";
  if (l === 28) return "sparkle-silver";

  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) return colorMap[l] || "white";
  if (l >= 11) return "lime";
  return "white";
}

function coloredLevel(l){
  // ğŸŒˆ 30ê°•
  if (l >= 30) {
    return `<span class="rainbow">+${l}ê°•</span>`;
  }

  // âœ¨ 29 / 28 ë°˜ì§
  if (l === 29) {
    return `<span class="sparkle-gold">+${l}ê°•</span>`;
  }
  if (l === 28) {
    return `<span class="sparkle-silver">+${l}ê°•</span>`;
  }

  // ğŸ¨ 21~27 ê°œë³„ ìƒ‰ìƒ
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) {
    return `<span style="color:${colorMap[l]};font-weight:bold;">+${l}ê°•</span>`;
  }

  // ğŸ‘‰ 11~20ì€ ìƒ‰ ì—†ìŒ (ê¸°ë³¸ í°ìƒ‰)
  return `+${l}ê°•`;
}

  // âš”ï¸ ê°•í™” ë‹¨ê³„ë³„ ì»¬ëŸ¬ ì´ë¦„ (ë­í‚¹ í‘œì‹œìš©)
function getSwordColorName(level) {
  const colorNameMap = {
    21: "ë¹¨ê°•",
    22: "ë…¸ë‘",
    23: "ì´ˆë¡",
    24: "íŒŒë‘",
    25: "ë³´ë¼",
    26: "ê°ˆìƒ‰",
    27: "í•‘í¬",
    28: "ì‹¤ë²„",
    29: "ê³¨ë“œ",
    30: "ë¬´ì§€ê°œ"
  };
  return colorNameMap[level] || "";
}

// âš”ï¸ ê²€ ì´ë¦„ì— ìƒ‰ ì…íˆê¸° (ë­í‚¹ìš©)
function coloredWeaponName(level, baseName) {
  // 20ê°• ì´í•˜ëŠ” ìƒ‰ ì•ˆ ë„£ê³  ê·¸ëƒ¥ ì´ë¦„ë§Œ
  if (level <= 20) return baseName;

  // 30, 29, 28ê°•ì€ ì´ë¯¸ ë§Œë“  í´ë˜ìŠ¤ í™œìš©
  if (level >= 30) {
    return `<span class="rainbow">${baseName}</span>`;
  }
  if (level === 29) {
    return `<span class="sparkle-gold">${baseName}</span>`;
  }
  if (level === 28) {
    return `<span class="sparkle-silver">${baseName}</span>`;
  }

  // 21~27ê°•ì€ coloredLevelì—ì„œ ì“°ëŠ” ìƒ‰ì´ë‘ ë§ì¶”ê¸°
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  const cssColor = colorMap[level] || "#ffffff";
  return `<span style="color:${cssColor};font-weight:bold;">${baseName}</span>`;
}

    // âœ… ì „ì²´(1~10) ê¸°ì¤€: 80% ì´ìƒì´ ë˜ëŠ” "ê°€ì¥ ë†’ì€ ë‹¨ê³„" + ë°”ë¡œ ì§ì „ ë‹¨ê³„
function getGlobalRecommendPair(){
  // í˜„ì¬ íŒŒì¼ FIELD_DESCRIPTIONSê°€ 1~10ì„ ì“°ê³  ìˆìœ¼ë‹ˆ(=í•„ë“œID 1~10 ì¡´ì¬) ê·¸ëŒ€ë¡œ ê³ ì • ë°°ì—´ ì‚¬ìš©
  const all = [1,2,3,4,5,6,7,8,9,10];

  let best = null;
  all.forEach((fieldId) => {
    const chance = getHuntSuccessChance(sword, fieldId);
    if (chance >= 80) best = fieldId; // ë‚®â†’ë†’ ìˆœíšŒë¼ ë®ì–´ì“°ë©´ ìµœì¢…ì´ ìµœê³  ë‹¨ê³„
  });

  const prev = (best !== null) ? (best - 1) : null;
  return { best, prev };
}

// âœ… ì§€ë„ POI(ì‚¬ëƒ¥í„°) ì¶”ì²œ/ì ê¸ˆ ìƒíƒœ ê°±ì‹  (ì›”ë“œë§µ)
function updateWorldMapHuntPoiHints(){
  const list = [
    { btnId: "poiMushroomVillage", fieldId: 1 },
    { btnId: "poiSewer",          fieldId: 2 },
    { btnId: "poiOutlawWasteland",fieldId: 3 },
    { btnId: "poiSwampElfForest", fieldId: 4 },
    { btnId: "poiFrostQueenCave", fieldId: 5 },
    { btnId: "poiDeathWorld",     fieldId: 6 },
    { btnId: "poiBehemothPit",    fieldId: 7 },
  ];

  // âœ… ì „ì²´(1~10) ê¸°ì¤€ìœ¼ë¡œ best/prev í•œ ë²ˆë§Œ ê³„ì‚°
  const { best, prev } = getGlobalRecommendPair();

  list.forEach(({btnId, fieldId}) => {
    const el = document.getElementById(btnId);
    if(!el) return;

    const chance = getHuntSuccessChance(sword, fieldId);

    el.classList.remove("poi-hunt-reco", "poi-hunt-locked");

    // ì ê¸ˆ(0%)
    if (chance <= 0) {
      el.classList.add("poi-hunt-locked");
      return;
    }

    // âœ… ì¶”ì²œ: ì „ì²´ ìµœê³  80% í•„ë“œ(best) + ë°”ë¡œ ì§ì „(prev)ë§Œ
    // (ë‹¨, ì›”ë“œë§µì€ 1~7ë§Œ ìˆìœ¼ë‹ˆ best/prevê°€ 8~10ì´ë©´ ì—¬ê¸°ì„  ì•„ë¬´ê²ƒë„ ì¶”ì²œ ì•ˆ ëœ¨ëŠ” ê²Œ ì •ìƒ)
    if (best !== null && (fieldId === best || fieldId === prev)) {
      el.classList.add("poi-hunt-reco");
    }
  });
}

  // âœ… í•˜ëŠ˜ë§µ POI(ì‚¬ëƒ¥í„°) ì¶”ì²œ/ì ê¸ˆ ìƒíƒœ ê°±ì‹ 
function updateSkyMapHuntPoiHints(){
  const list = [
    { btnId: "poiArchangelCradle", fieldId: 8 },
    { btnId: "poiGodSanctum",      fieldId: 9 },
    { btnId: "poiDimensionalRift", fieldId: 10 },
  ];

  // âœ… 1) í˜„ì¬ ë‚´ ê°•í™”(sword) ê¸°ì¤€ "80% ì´ìƒì´ ë˜ëŠ” ê°€ì¥ ë†’ì€ ë‹¨ê³„" ì°¾ê¸°
  let bestRecoFieldId = null;
  list.forEach(({fieldId}) => {
    const chance = getHuntSuccessChance(sword, fieldId);
    if (chance >= 80) bestRecoFieldId = fieldId;
  });

  // âœ… "ë°”ë¡œ ì§ì „ ë‹¨ê³„"ëŠ” í•˜ëŠ˜ë§µ ë¦¬ìŠ¤íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì¡ê¸°(8â†’9â†’10)
  let prevRecoFieldId = null;
  if (bestRecoFieldId !== null){
    const idx = list.findIndex(x => x.fieldId === bestRecoFieldId);
    if (idx > 0) prevRecoFieldId = list[idx - 1].fieldId;
  }

  // âœ… 2) ê° POIì— í´ë˜ìŠ¤ ì ìš©
  list.forEach(({btnId, fieldId}) => {
    const el = document.getElementById(btnId);
    if(!el) return;

    const chance = getHuntSuccessChance(sword, fieldId);

    el.classList.remove("poi-hunt-reco", "poi-hunt-locked");

    // ì ê¸ˆ(0%)
    if (chance <= 0) {
      el.classList.add("poi-hunt-locked");
      return;
    }

    // ì¶”ì²œ: ìµœê³  80% ì‚¬ëƒ¥í„° + ë°”ë¡œ ì§ì „ ì‚¬ëƒ¥í„°ë§Œ
    if (bestRecoFieldId !== null && (fieldId === bestRecoFieldId || fieldId === prevRecoFieldId)) {
      el.classList.add("poi-hunt-reco");
    }
  });
}

  // =========================
// ğŸ—º ì–‘í”¼ì§€ ì§€ë„ ì˜¤ë²„ë ˆì´
// =========================
function openParchmentMap(){
  const ov = document.getElementById("parchmentMapOverlay");
  if(!ov) return;

  updateWorldMapHuntPoiHints();

    // âœ… ì§€ë„ ì˜¤í”ˆ ì‚¬ìš´ë“œ (ì–‘í”¼ì§€ ì§€ë„ ì „ìš©)
  // íŒŒì¼: sounds/ui_map_open.mp3
  try{
    // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´(ì¤‘ë³µ ì¬ìƒ ë°©ì§€)
    if (ov.style.display === "flex") return;

    if (!window.__SFX_PARCHMENT_MAP_OPEN) {
      window.__SFX_PARCHMENT_MAP_OPEN = new Audio("sounds/ui_map_open.mp3");
      window.__SFX_PARCHMENT_MAP_OPEN.preload = "auto";
    }

    // âœ… SFX(0~5) ì„¤ì • ë°˜ì˜
    window.__SFX_PARCHMENT_MAP_OPEN.volume = Math.min(
      1,
      0.9 * (typeof getSfxScale === "function" ? getSfxScale() : 1)
    );

    window.__SFX_PARCHMENT_MAP_OPEN.currentTime = 0;
    const p = window.__SFX_PARCHMENT_MAP_OPEN.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }catch(e){}
  
  ov.style.display = "flex";
    // ë’¤ ìŠ¤í¬ë¡¤ ë°©ì§€(ëª¨ë°”ì¼ í¬í•¨)
  document.body.style.overflow = "hidden";
}

function closeParchmentMap(){
  const ov = document.getElementById("parchmentMapOverlay");
  if(!ov) return;

  ov.style.display = "none";
  document.body.style.overflow = "";
}

// ESCë¡œ ë‹«ê¸°
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape"){
    const ov = document.getElementById("parchmentMapOverlay");
    if(ov && ov.style.display !== "none"){
      closeParchmentMap();
    }
  }
});

  // âœ… ì§€ë„ POI(ì‚¬ëƒ¥í„°) ì¶”ì²œ/ì ê¸ˆ ìƒíƒœ ê°±ì‹  (í•˜ëŠ˜ë§µ)
function updateSkyMapHuntPoiHints(){
  const list = [
    { btnId: "poiArchangelCradle", fieldId: 8 },
    { btnId: "poiGodSanctum",      fieldId: 9 },
    { btnId: "poiDimensionalRift", fieldId: 10 },
  ];

  const { best, prev } = getGlobalRecommendPair();

  list.forEach(({btnId, fieldId}) => {
    const el = document.getElementById(btnId);
    if(!el) return;

    const chance = getHuntSuccessChance(sword, fieldId);

    el.classList.remove("poi-hunt-reco", "poi-hunt-locked");

    if (chance <= 0) {
      el.classList.add("poi-hunt-locked");
      return;
    }

    if (best !== null && (fieldId === best || fieldId === prev)) {
      el.classList.add("poi-hunt-reco");
    }
  });
}

  function openSkyMap(e){
  if (e) e.stopPropagation(); // âœ… 1ë²ˆ ì§€ë„ ë°”ê¹¥í´ë¦­ ë‹«ê¸°ë‘ ì¶©ëŒ ë°©ì§€
  const sky = document.getElementById("parchmentSkyOverlay");
  if (!sky) return;

    // âœ… í•˜ëŠ˜ë§µ(2ë²ˆ ì§€ë„)ë„ ì§€ë„ í¼ì³ì§€ëŠ” ì‚¬ìš´ë“œ ì¬ìƒ
  try{ playMapOpenSfx(); }catch(e){}

  updateSkyMapHuntPoiHints();   // âœ… í•˜ëŠ˜ë§µ ì¶”ì²œ/ì ê¸ˆ ê°±ì‹ 
  sky.style.display = "flex";

  // âœ… ë’¤ ìŠ¤í¬ë¡¤ ë°©ì§€(ëª¨ë°”ì¼ í¬í•¨) - ì›”ë“œë§µê³¼ ë™ì¼
  document.body.style.overflow = "hidden";
}

function closeSkyMap(){
  const sky = document.getElementById("parchmentSkyOverlay");
  if (!sky) return;
  sky.style.display = "none";

  // âœ… ìŠ¤í¬ë¡¤ ì›ë³µ
  document.body.style.overflow = "";
}

/* âœ… ESC ì²˜ë¦¬: 2ë²ˆì´ ì—´ë ¤ìˆìœ¼ë©´ 2ë²ˆë¶€í„° ë‹«ê³ , ì•„ë‹ˆë©´ 1ë²ˆ ë‹«ê¸° */
document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;

  const sky = document.getElementById("parchmentSkyOverlay");
  if (sky && sky.style.display === "flex") {
    closeSkyMap();
    return;
  }

  const world = document.getElementById("parchmentMapOverlay");
  if (world && world.style.display === "flex") {
    closeParchmentMap(); // âœ… ê¸°ì¡´ 1ë²ˆ ì§€ë„ ë‹«ê¸° í•¨ìˆ˜ ìœ ì§€
  }
});

// ğŸ—º MAP í† ê¸€
function toggleMap() {
  const panel = document.getElementById("mapPanel");
  if (!panel) return;

  // âœ… ì§€ë„ ì˜¤í”ˆ ì‚¬ìš´ë“œ (mp3)
  // íŒŒì¼: sounds/ui_map_open.mp3
  if (panel.style.display === "none" || panel.style.display === "") {
    try{
      if (!window.__SFX_MAP_OPEN) {
        window.__SFX_MAP_OPEN = new Audio("sounds/ui_map_open.mp3");
        window.__SFX_MAP_OPEN.volume = 0.8;
        window.__SFX_MAP_OPEN.preload = "auto";
      }
      window.__SFX_MAP_OPEN.currentTime = 0;
      const p = window.__SFX_MAP_OPEN.play();
      if (p && typeof p.catch === "function") p.catch(()=>{});
    }catch(e){}
  }

  if (panel.style.display === "none" || panel.style.display === "") {
    renderMap();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

  // =====================
// ğŸ” í–„ë²„ê±° ë©”ë‰´
// =====================
function closeHamburgerMenu(){
  const menu = document.getElementById("hamburgerMenu");
  if (menu) menu.style.display = "none";
}

function toggleHamburgerMenu(ev){
  if (ev) ev.stopPropagation();

  const menu = document.getElementById("hamburgerMenu");
  if (!menu) return;

  const isOpen = (menu.style.display === "block");
  if (isOpen) {
    menu.style.display = "none";
  } else {
    menu.style.display = "block";
  }
}

// ë°”ê¹¥ í´ë¦­ ë‹«ê¸° + ESC ë‹«ê¸°
document.addEventListener("click", () => closeHamburgerMenu());
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeHamburgerMenu();
});

// ë©”ë‰´ ë‚´ë¶€ í´ë¦­ì€ ë²„ë¸” ë§‰ê¸°(ë°”ê¹¥ í´ë¦­ ë‹«í˜ ë°©ì§€)
document.addEventListener("DOMContentLoaded", () => {
  const menu = document.getElementById("hamburgerMenu");
  const btn  = document.getElementById("hamburgerBtn");
  if (menu) menu.addEventListener("click", (e) => e.stopPropagation());
  if (btn)  btn.addEventListener("click", (e) => e.stopPropagation());
});

  // =====================
// ğŸ”Š ì†Œë¦¬ì„¤ì • (BGM / SFX 0~5)
// =====================
function clampSoundLevel(v){
  v = Number(v);
  if (!Number.isFinite(v)) v = 3;
  return Math.max(0, Math.min(5, Math.floor(v)));
}

// 0~5 -> ìŠ¤ì¼€ì¼ (3ì´ ê¸°ë³¸)
function levelToScale(level){
  // 0: mute, 3: 1.0, 5: 1.35 ì •ë„ (ì·¨í–¥)
  const lv = clampSoundLevel(level);
  if (lv === 0) return 0;
  const table = [0, 0.45, 0.70, 1.00, 1.18, 1.35];
  return table[lv] ?? 1.0;
}

// ì €ì¥ê°’ (ê¸°ë³¸ 3)
function getBgmLevel(){ return clampSoundLevel(localStorage.getItem("bgmLevel")); }
function getSfxLevel(){ return clampSoundLevel(localStorage.getItem("sfxLevel")); }

function getBgmScale(){ return levelToScale(getBgmLevel()); }
function getSfxScale(){ return levelToScale(getSfxLevel()); }

// ì˜¤ë²„ë ˆì´ ì—´ê¸°/ë‹«ê¸°
function openSoundSetting(){
  const ov = document.getElementById("soundSettingOverlay");
  if (!ov) return;

  const bgmSel = document.getElementById("bgmLevelSelect");
  const sfxSel = document.getElementById("sfxLevelSelect");

  // ê¸°ë³¸ê°’ 3 ë³´ì¥
  if (localStorage.getItem("bgmLevel") == null) localStorage.setItem("bgmLevel", "3");
  if (localStorage.getItem("sfxLevel") == null) localStorage.setItem("sfxLevel", "3");

  if (bgmSel) bgmSel.value = String(getBgmLevel());
  if (sfxSel) sfxSel.value = String(getSfxLevel());

  ov.style.display = "flex";
}

function closeSoundSetting(){
  const ov = document.getElementById("soundSettingOverlay");
  if (ov) ov.style.display = "none";
}

// ì ìš©
function applySoundSettingFromUI(){
  const bgmSel = document.getElementById("bgmLevelSelect");
  const sfxSel = document.getElementById("sfxLevelSelect");

  const bgmLv = clampSoundLevel(bgmSel ? bgmSel.value : 3);
  const sfxLv = clampSoundLevel(sfxSel ? sfxSel.value : 3);

  localStorage.setItem("bgmLevel", String(bgmLv));
  localStorage.setItem("sfxLevel", String(sfxLv));

  // âœ… ì—¬ê¸°ì„œ ì‹¤ì œ ë³¼ë¥¨ ë°˜ì˜(ë„¤ BGM ë³€ìˆ˜ëª…ì— ë§ê²Œ í•œ ì¤„ë§Œ ìˆ˜ì •í•˜ë©´ ë¨)
  applyBgmVolumeNow();
  applyIconTapVolumeNow?.(); // (ì•„ì´ì½˜ íƒ­ WebAudio ì“°ëŠ” ê²½ìš°ê°€ ìˆìœ¼ë©´)
  closeSoundSetting();
}

  // âœ… ìµœì´ˆ 1íšŒ: ì†Œë¦¬ì„¤ì • ê¸°ë³¸ê°’ ë³´ì¥ + ì¦‰ì‹œ ë°˜ì˜
function loadSoundSettings(){
  try{
    // ê¸°ë³¸ê°’(3) ì—†ìœ¼ë©´ ì„¸íŒ…
    if (localStorage.getItem("bgmLevel") === null) localStorage.setItem("bgmLevel", "3");
    if (localStorage.getItem("sfxLevel") === null) localStorage.setItem("sfxLevel", "3");
  }catch(e){}

  // í˜„ì¬ ì˜¤ë””ì˜¤ì—ë„ ì¦‰ì‹œ ë°˜ì˜
  try{ applyBgmVolumeNow(); }catch(e){}
  try{ applyIconTapVolumeNow(); }catch(e){}
}

// âœ… ë„¤ BGM ì˜¤ë””ì˜¤ ê°ì²´ì— ì—°ê²°
function applyBgmVolumeNow(){
  try{
    if (typeof currentBgm !== "undefined" && currentBgm && typeof currentBgm.volume === "number") {
      const baseVol = 0.675; // BGM ê¸°ë³¸ ë³¼ë¥¨
      currentBgm.volume = Math.min(1.0, baseVol * getBgmScale());
    }
  }catch(e){}
}

  function applyIconTapVolumeNow(){
  try{
    if (window._tapGain) {
      _tapGain.gain.value = 0.85 * getSfxScale(); // ì•„ì´ì½˜ íƒ­ ê¸°ë³¸ 0.85 ìœ ì§€
    }
  }catch(e){}
}
  
  function openMapPanelNearParchmentBtn(ev){
  if (ev) ev.stopPropagation();

  const panel = document.getElementById("mapPanel");
  const btn   = document.getElementById("parchmentMapLegacyBtn");
  if(!panel || !btn) return;

  // 1) ì—´ê¸° (í† ê¸€ ëŠë‚Œ)
  const isOpen = (panel.style.display === "block");
  if (isOpen) {
    panel.style.display = "none";
    return;
  }

      // âœ… ì§€ë„ ì˜¤í”ˆ ì‚¬ìš´ë“œ (mp3)
  // íŒŒì¼: sounds/ui_map_open.mp3
  try{
    if (!window.__SFX_MAP_OPEN) {
      window.__SFX_MAP_OPEN = new Audio("sounds/ui_map_open.mp3");
      window.__SFX_MAP_OPEN.preload = "auto";
    }
    // âœ… SFX(0~5) ì„¤ì • ë°˜ì˜
    window.__SFX_MAP_OPEN.volume = Math.min(
      1,
      0.8 * (typeof getSfxScale === "function" ? getSfxScale() : 1)
    );

    window.__SFX_MAP_OPEN.currentTime = 0;
    const p = window.__SFX_MAP_OPEN.play();
    if (p && typeof p.catch === "function") p.catch(()=>{});
  }catch(e){}

  panel.style.display = "block";
  renderMap();

  // 2) ë²„íŠ¼ ê·¼ì²˜ë¡œ ìœ„ì¹˜ ì´ë™ (ì›”ë“œë§µ ìœ„ì— ë– ì•¼ í•¨)
  // mapPanelì´ ì›ë˜ fixed ê¸°ë°˜ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ fixed ì¢Œí‘œë¡œ ì¡ëŠ”ë‹¤.
  panel.style.position = "fixed";
  panel.style.right = "auto"; // âœ… right ê³ ì • í’€ê¸° (ì¤‘ìš”)

  const r = btn.getBoundingClientRect();

  // ë²„íŠ¼ì˜ "ì˜¤ë¥¸ìª½ ìœ„" ê·¼ì²˜ì— ë„ìš°ê³  ì‹¶ìœ¼ë©´ ì´ë ‡ê²Œ:
  let x = r.left;                 // ë²„íŠ¼ ì¢Œì¸¡ ê¸°ì¤€
  let y = r.top - 10;             // ë²„íŠ¼ë³´ë‹¤ ì‚´ì§ ìœ„

  // panel í¬ê¸° ì–»ì–´ì„œ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ ë³´ì •
  const pr = panel.getBoundingClientRect();
  if (x + pr.width > window.innerWidth - 8) x = window.innerWidth - pr.width - 8;
  if (y + pr.height > window.innerHeight - 8) y = window.innerHeight - pr.height - 8;
  if (x < 8) x = 8;
  if (y < 8) y = 8;

  panel.style.left = x + "px";
  panel.style.top  = y + "px";

  // ì›”ë“œë§µ ìœ„ì— ëœ¨ë„ë¡ z-index ë³´ì¥
  panel.style.zIndex = 2605;
}

// âœ… mapPanel: ë°”ê¹¥(íŒ¨ë„/ë²„íŠ¼ ì œì™¸) í´ë¦­í•˜ë©´ ë‹«ê¸°
function closeMapPanelIfOutside(e){
  const panel = document.getElementById("mapPanel");
  if (!panel) return;
  if (panel.style.display !== "block") return;

  const btn = document.getElementById("parchmentMapLegacyBtn");

  // íŒ¨ë„ ë‚´ë¶€ í´ë¦­ or 'ì‚¬ëƒ¥í„° ì„ íƒ' ë²„íŠ¼ í´ë¦­ì´ë©´ ë‹«ì§€ ì•ŠìŒ
  if (panel.contains(e.target)) return;
  if (btn && btn.contains(e.target)) return;

  panel.style.display = "none";
}

// PC í´ë¦­
document.addEventListener("mousedown", closeMapPanelIfOutside);
// ëª¨ë°”ì¼ í„°ì¹˜
document.addEventListener("touchstart", closeMapPanelIfOutside, { passive: true });

// ğŸ—º MAP ë‚´ìš© ë Œë”ë§
function renderMap() {
  const listEl = document.getElementById("mapList");
  if (!listEl) return;

  listEl.innerHTML = "";

  for (let i = 1; i <= 10; i++) {
    const field = HUNT_FIELDS[i];
    const success = getHuntSuccessChance(sword, i);

    const div = document.createElement("div");
    div.className = "map-field";
    div.innerHTML = `
      <b>LV${i} - ${field.name}</b><br>
      ì¶”ì²œ: +${field.recLevel}ê°• / í˜„ì¬ ì˜ˆìƒ ì„±ê³µë¥ : ${success}%
    `;
    div.onclick = function() {

      // ì´ë¯¸ ì´ë™ ì¤‘ì´ë©´ ë¬´ì‹œ
      if (isMoving) return;

      isMoving = true;

      // "ì‚¬ëƒ¥í„° ì´ë™ ì¤‘..." íŒì—… í‘œì‹œ
      showMovePopup();

      const delay = 1000 + Math.random() * 1000; // 1~2ì´ˆ ëœë¤

      setTimeout(() => {
        // ì‹¤ì œ ì‚¬ëƒ¥í„° ë³€ê²½
        currentField = i;

        applyFieldBackground();
        
        // UI ê°±ì‹  + ì €ì¥
        update();
        save();

        // ë§µ íŒ¨ë„ ë‹«ê¸° + ì´ë™ íŒì—… ë‹«ê¸°
        toggleMap();
        closeMovePopup();

        isMoving = false;
      }, delay);
    };


    // í˜„ì¬ ì„ íƒ ì‚¬ëƒ¥í„° í‘œì‹œ
    if (i === currentField) {
      div.style.borderLeft = "3px solid #6cf";
    }

    listEl.appendChild(div);
  }
}

  // âœ… í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ POI ì´ë™ (fieldId: 0)
function moveToFulgurantForgeFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    0,                // â† ë„ˆê°€ ë§Œë“  í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„ fieldId (ì§€ê¸ˆ ëŒ€í™” íë¦„ìƒ 0ìœ¼ë¡œ ì“°ëŠ” ì¤‘)
    "í¼ê·¸ë€íŠ¸ ëŒ€ì¥ê°„",
    "ì‚¬ëƒ¥ë¶ˆê°€, ê°•í™”ê°€ëŠ¥" // â† ì›í•˜ë©´ ìˆ«ì/ë¬¸êµ¬ ì¡°ì •
  );
}

  // ğŸ„ ì›”ë“œë§µ(ì–‘í”¼ì§€)ì—ì„œ: í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„ë¡œ ì´ë™
function moveToMushroomVillageFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    1,
    "í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„",
    "+0ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

  function moveToSewerFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    2,
    "ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½",
    "+3ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

  function moveToOutlawWastelandFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    3,
    "ë¬´ë²•ìë“¤ì˜ í™©ì•¼",
    "+6ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

  function moveToSwampElfForestFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    4,
    "ëŠªì—˜í”„ì˜ ìˆ²",
    "+9ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

    function moveToFrostQueenCaveFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    5,
    "ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´",
    "+12ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

  function moveToDeathWorldFromWorldMap(e){
  if (e) e.stopPropagation();

  // âœ… (ê°™ì€ ë°©ì‹) ì´ë™ í™•ì¸ì°½
  showWorldMapMoveConfirm(
    6,
    "ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„",
    "+15ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

  function moveToBehemothPitFromWorldMap(e){
  if (e) e.stopPropagation();

  showWorldMapMoveConfirm(
    7,
    "ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´",
    "+18ê°• ì´ìƒ ì¶”ì²œ ì‚¬ëƒ¥í„°"
  );
}

  // âœ… í•˜ëŠ˜ë§µ POI â†’ ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
function moveToArchangelCradleFromSkyMap(e){
  if (e) e.stopPropagation();
  showSkyMapMoveConfirm(8); // 8 = ëŒ€ì²œì‚¬ì˜ ìš”ëŒ
}

  function moveToGodSanctumFromSkyMap(e){
  if (e) e.stopPropagation();
  showSkyMapMoveConfirm(9); // 9 = ì‹ ì˜ ì²˜ì†Œ
}

function moveToDimensionalRiftFromSkyMap(e){
  if (e) e.stopPropagation();
  showSkyMapMoveConfirm(10); // 10 = ì°¨ì›ì˜ í‹ˆìƒˆ
}
  
// âœ… ì›”ë“œë§µ POI ê³µìš© ì´ë™ í•¨ìˆ˜ (ì½œë°± í™•ì¥ ë²„ì „)
function moveToFieldFromWorldMap(fieldId, onArrive){
  // ëŒ€ìƒ í•„ë“œê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨
  if (!HUNT_FIELDS || !HUNT_FIELDS[fieldId]) return false;

  // ì´ë¯¸ ì´ë™ ì¤‘ì´ë©´ ë¬´ì‹œ
  if (isMoving) return false;
  isMoving = true;

  // "ì‚¬ëƒ¥í„° ì´ë™ ì¤‘..." íŒì—… í‘œì‹œ (ê¸°ì¡´ í•¨ìˆ˜ ì¬ì‚¬ìš©)
  showMovePopup();

  const delay = 1000 + Math.random() * 1000; // 1~2ì´ˆ ëœë¤

  setTimeout(() => {
    // ì‹¤ì œ ì‚¬ëƒ¥í„° ë³€ê²½
    currentField = fieldId;

    applyFieldBackground();

    // UI ê°±ì‹  + ì €ì¥
    update();
    save();

    // âœ… (êµ¬ë²„ì „) ì‚¬ëƒ¥í„° ì„ íƒ íŒ¨ë„ì´ ë– ìˆìœ¼ë©´ ë‹«ê¸°
    const mapPanel = document.getElementById("mapPanel");
    if (mapPanel) mapPanel.style.display = "none";

    // âœ… ì–‘í”¼ì§€ ì›”ë“œë§µ ë‹«ê¸°
    closeParchmentMap();

    // ì´ë™ íŒì—… ë‹«ê¸°
    closeMovePopup();

    isMoving = false;

    // âœ… ë„ì°© í›„ í›„ì†ì²˜ë¦¬(ë³´ìŠ¤ì „/ê¸°íƒ€)
    if (typeof onArrive === "function") {
      try { onArrive(); } catch (e) { console.warn("onArrive error", e); }
    }
  }, delay);

  return true;
}

// âœ… ë³´ìŠ¤ID â†’ ì´ë™í•  ì‚¬ëƒ¥í„°(fieldId) ë§¤í•‘ (ì¶”í›„ ë³´ìŠ¤ ì¶”ê°€ë˜ë©´ ì—¬ê¸°ë§Œ ëŠ˜ë¦¬ë©´ ë¨)
const BOSS_FIELD_MAP = {
  "swamp_elf_queen": 4, // ì‹¤ë°”ë‚˜ ë¦´ë¦¬ì•„ë„¤ â†’ ëŠªì—˜í”„ì˜ ìˆ²
  "frost_queen": 5      // ì•„ë¥´ì…€ë¦¬ì•„ â†’ ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´(í•„ë“œID 5)
};
  
// âœ… ë³´ìŠ¤ì „ ì•„ì´ì½˜ â†’ "ì´ë™í•œë‹¤" ëˆŒë €ì„ ë•Œ
function startBossBattleMove(){
  closeNpcPopup();

  // ì´ë¯¸ ì´ë™ ì¤‘ì´ë©´ ë¬´ì‹œ (ì›”ë“œë§µ ì´ë™ê³¼ ë™ì¼)
  if (isMoving) return;
  isMoving = true;

  // âœ… "ì´ë™ì¤‘..." íŒì—… (ê¸°ì¡´ ì›”ë“œë§µ ì´ë™ íŒì—… ì¬ì‚¬ìš©)
  showMovePopup();

  // ì›”ë“œë§µ ì´ë™ê³¼ ë¹„ìŠ·í•œ í…œí¬ë¡œ (ì›í•˜ë©´ 900 ê³ ì •ë„ OK)
  const delay = 900;

  setTimeout(() => {
    // âœ… ì‹¤ì œ ì‚¬ëƒ¥í„° ì´ë™(ë°°ê²½ ë³€ê²½)
    const moved = moveToBossFieldByBossId(activeBossId);

    // ì´ë™ íŒì—… ë‹«ê¸°
    closeMovePopup();
    isMoving = false;

    // âœ… ì´ë™ ì™„ë£Œ â†’ ë³´ìŠ¤ì „ ì˜¤ë²„ë ˆì´
    openBossBattle();
  }, delay);
}

// ğŸ§± íŒ¨ë„ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (MAP / ì¸ë²¤í† ë¦¬ / ë¡œê·¸ ê³µí†µ)
function closeIfClickOutside(event, panelId, buttonId) {
  const panel = document.getElementById(panelId);
  const btn   = document.getElementById(buttonId);
  if (!panel) return;

  // ì•ˆ ì—´ë ¤ ìˆìœ¼ë©´ ë¬´ì‹œ
  if (panel.style.display === "none" || panel.style.display === "") return;

  const target = event.target;

  // íŒ¨ë„ ì•ˆì„ í´ë¦­í•œ ê²½ìš° â†’ ìœ ì§€
  if (panel.contains(target)) return;

  // í•´ë‹¹ íŒ¨ë„ì˜ í† ê¸€ ë²„íŠ¼ì„ í´ë¦­í•œ ê²½ìš° â†’ í† ê¸€ ë¡œì§ì— ë§¡ê¹€
  if (btn && btn.contains(target)) return;

  // ê·¸ ì™¸ ì˜ì—­ í´ë¦­ ì‹œ íŒ¨ë„ ë‹«ê¸°
  panel.style.display = "none";
}

// ğŸ“Œ ì „ì—­ í´ë¦­ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener("mousedown", function (e) {
  closeIfClickOutside(e, "mapPanel", "mapBtn");             // MAP
  closeIfClickOutside(e, "inventoryPanel", "inventoryBtn"); // ì¸ë²¤í† ë¦¬
  closeIfClickOutside(e, "logPanel", "logToggle");          // ë¡œê·¸
    // âœ… ê²°íˆ¬ ì§€ì •ë§¤ì¹­ íŒ¨ë„(duelPanel): ë°”ê¹¥ í´ë¦­ ë‹«ê¸° + ì§€ì •ë§¤ì¹­ ë²„íŠ¼ì€ ì˜ˆì™¸
  (function(){
    const panel = document.getElementById("duelPanel");
    if (!panel) return;
    if (panel.style.display === "none" || panel.style.display === "") return;

    const t = e.target;

    // íŒ¨ë„ ë‚´ë¶€ í´ë¦­ì€ ë¬´ì‹œ
    if (panel.contains(t)) return;

    // (ê¸°ì¡´ ì˜ˆì™¸) ê²°íˆ¬ì¥ ì•„ì´ì½˜ í´ë¦­ì€ ë¬´ì‹œ
    const duelIconBtn = document.getElementById("duelIconBtn");
    if (duelIconBtn && duelIconBtn.contains(t)) return;

    // âœ… ê²°íˆ¬ì¥ ì•ˆ â€œğŸ¯ ê²°íˆ¬í•˜ê¸°(ì§€ì •ë§¤ì¹­)â€ ë²„íŠ¼(= data-duel-target) í´ë¦­ì€ ë¬´ì‹œ
    if (t && typeof t.closest === "function" && t.closest("[data-duel-target]")) return;

    panel.style.display = "none";
  })();
});

  // âœ… ESC ëˆ„ë¥´ë©´ ê²°íˆ¬ ì§€ì •ë§¤ì¹­ íŒ¨ë„(duelPanel) ë‹«ê¸°
document.addEventListener("keydown", function(e){
  if (e.key === "Escape" || e.key === "Esc") {
    const panel = document.getElementById("duelPanel");
    if (panel && panel.style.display !== "none" && panel.style.display !== "") {
      panel.style.display = "none";
    }
  }
});

// ğŸ§· ìƒˆë¡œê³ ì¹¨ ì‹œ ìë™ ë¡œê·¸ì¸
function autoLoginFromStorage() {
    
      // âœ… ìë™ë¡œê·¸ì¸ ì‹œë„ ì‹œì‘ ì „, ì´ì „ ê³„ì • ì”ìƒ ë°©ì§€
  titlesOwned = {};
  equippedTitle = "";
  closeTitleOverlay();
weaponType   = null;
maxSwordLevel = 0;
destroyCount  = 0;

  let savedId = null;
  try {
    savedId = localStorage.getItem("swordGameLastUser");
  } catch (e) {
    console.warn("localStorage get ì‹¤íŒ¨", e);
  }

  if (!savedId) return;  // ì €ì¥ëœ ìœ ì € ì—†ìœ¼ë©´ íŒ¨ìŠ¤

  userId = savedId;
  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {
    if (!s.exists()) {
      // í˜¹ì‹œ DBì—ì„œ ì‚¬ë¼ì§„ ê³„ì •ì´ë©´ ê¸°ë¡ë„ ì§€ì›€
      try { localStorage.removeItem("swordGameLastUser"); } catch (e) {}
      return;
    }

    const data = s.val();

        // ğŸ” ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì† ì¤‘ì´ë©´: ìë™ë¡œê·¸ì¸ë„ íŒì—…ìœ¼ë¡œ ì²˜ë¦¬
// ğŸ” ìë™ë¡œê·¸ì¸ë„ ë™ì¼ ê·œì¹™ ì ìš©
if (data.sessionId) {
  const mySid = getLocalSessionId(userId);

  const isSameDeviceSession = (mySid && data.sessionId === mySid);
  const isDead = isSessionStale(data);

  if (!isSameDeviceSession && !isDead) {
    showAlreadyOnlinePopup(userId, data);
    return;
  }
}

    sword = data.sword ?? 0;
    gold  = data.gold  ?? 100;

    // âœ… ê°ì¸(3ì¤„) ë¡œë“œ
engraveLines = (Array.isArray(data.engraveLines) && data.engraveLines.length)
  ? [data.engraveLines[0] || "-", data.engraveLines[1] || "-", data.engraveLines[2] || "-"]
  : ["-","-","-"];

titlesOwned = (data.titlesOwned && typeof data.titlesOwned === "object") ? data.titlesOwned : {};
equippedTitle = (typeof data.equippedTitle === "string") ? data.equippedTitle : "";
    // ğŸ§¹ ê³¼ê±° ë²„ê·¸ ê°’ ì •ë¦¬: "${titleId}" ê°™ì€ ì“°ë ˆê¸° ê°’ì´ë©´ ì¥ì°© í•´ì œ
if (equippedTitle && equippedTitle.includes("${")) equippedTitle = "";

    plagueRatHuntCount = Number(data.plagueRatHuntCount || 0);
    gamblerRunActive = !!data.gamblerRunActive;
    gamblerRunNoScroll = (data.gamblerRunNoScroll !== false); // ê¸°ë³¸ true
    fireworksDestroyed = data.fireworksDestroyed || { 21:false, 22:false, 23:false, 24:false, 25:false };
    reach30Count = Number(data.reach30Count || 0);
    weapon30Counts = data.weapon30Counts || {};
    hofDeadline = Number(data.hofDeadline || 0);
    hofAchievedAt = Number(data.hofAchievedAt || 0);
    hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
    hofProcessedAt = Number(data.hofProcessedAt || 0);
    superSuccessCount = Number(data.superSuccessCount || 0);
    downStreak        = Number(data.downStreak || 0);
    dopamineTried     = Number(data.dopamineTried || 0);
    lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
    aweUsedGlobal30EventId  = Number(data.aweUsedGlobal30EventId || 0);

    // âœ… ê°ì¸(í”„ë¦¬ì…‹) ë¡œë“œ + êµ¬ë²„ì „(engraveLines) â†’ Preset1 ì´ê´€
engravePresetIdx = Number(data.engravePresetIdx ?? 0);

// Firebase RTDBëŠ” ë°°ì—´ì´ {0:...,1:...,2:...} í˜•íƒœë¡œ ë‚´ë ¤ì˜¬ ìˆ˜ ìˆìŒ
const toArr3 = (v) => {
  if (Array.isArray(v)) return v;
  if (v && typeof v === "object") return [v[0] ?? v["0"], v[1] ?? v["1"], v[2] ?? v["2"]];
  return null;
};

const normLines3 = (v) => {
  const a = toArr3(v);
  if (!a) return ["-","-","-"];
  return [a[0] || "-", a[1] || "-", a[2] || "-"];
};

// presets ìì²´ë„ ë°°ì—´/ê°ì²´ ëª¨ë‘ ì²˜ë¦¬
const rawPresets = toArr3(data.engravePresets);

if (rawPresets) {
  // ê° preset(0/1/2)ë„ ë°°ì—´/ê°ì²´ ëª¨ë‘ ì²˜ë¦¬
  const p0 = rawPresets[0] ?? rawPresets["0"];
  const p1 = rawPresets[1] ?? rawPresets["1"];
  const p2 = rawPresets[2] ?? rawPresets["2"];
  engravePresets = [normLines3(p0), normLines3(p1), normLines3(p2)];
} else {
  // êµ¬ë²„ì „ ì €ì¥ê°’(engraveLines)ë§Œ ìˆëŠ” ìœ ì €ëŠ” Preset1ë¡œ ì´ê´€
  const old = (Array.isArray(data.engraveLines) && data.engraveLines.length)
    ? [data.engraveLines[0] || "-", data.engraveLines[1] || "-", data.engraveLines[2] || "-"]
    : ["-","-","-"];
  engravePresets = [old, ["-","-","-"], ["-","-","-"]];
  engravePresetIdx = 0;
}

ensureEngravePresetShape();

    // ğŸ—¡ ë¬´ê¸° íƒ€ì… ë¡œë“œ (v3.8 ì´ì „ ê³„ì • í˜¸í™˜ í¬í•¨)
  if (data.weaponType !== undefined && data.weaponType !== null) {
    // v3.8 ì´í›„ ì €ì¥ëœ ê³„ì • â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    weaponType = data.weaponType;   // "sword" ë˜ëŠ” "spear"
  } else {
    // êµ¬ë²„ì „ ê³„ì • (weaponType í•„ë“œê°€ ì—†ë˜ ì‹œì ˆ)
    if (sword > 0) {
      // ì´ë¯¸ 1ê°• ì´ìƒ ë¬´ê¸°ë¥¼ ê°€ì§„ ìœ ì €ëŠ” 'ê²€' ë£¨íŠ¸ë¡œ íŒì •
      weaponType = "sword";
    } else {
      // 0ê°•ì´ë©´ ì•„ì§ ë¬´ê¸° ë¯¸ì • â†’ ë‹¤ìŒì— 1/15/21ê°• ì°ì„ ë•Œ ëœë¤ ë°°ì •
      weaponType = null;
    }
  }
    
    // â­ ìë™ë¡œê·¸ì¸ ì‹œì—ë„ ì´ˆê¸°í™”
    lastSavedSwordForUpdated = sword;

        // ìµœê³  ê°•í™” / íŒŒê´´ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    maxSwordLevel = data.maxSwordLevel ?? sword;
    destroyCount  = data.destroyCount  ?? 0;

    // ğŸŸ¢ ìë™ë¡œê·¸ì¸ ì‹œ ì „íˆ¬ë ¥ ë³´ì • í¬í•¨
power = Number(data.power ?? 0);

if (!power || power <= 20) {
  rollPowerForCurrentSword();
}

    attendanceCount    = data.attendanceCount    ?? 0;
    lastAttendanceDate = data.lastAttendanceDate ?? "";
    attendanceStreak   = data.attendanceStreak   ?? 0;   
    lastAttendanceDay  = data.lastAttendanceDay  ?? "";  
    currentField       = data.currentField       ?? 1;
    huntCountToday     = data.huntCountToday     ?? 0;
    lastHuntDate       = data.lastHuntDate       ?? "";
    itemScroll15       = data.itemScroll15 ?? 0;
    itemProtect        = data.itemProtect  ?? 0;
    itemSuper          = data.itemSuper    ?? 0;
    itemDownProtect    = data.itemDownProtect ?? 0;
    itemScroll21    = Number(data.itemScroll21    ?? 0); 
    itemRateUp5     = Number(data.itemRateUp5     ?? 0);
    huntStamina       = data.huntStamina       ?? 20;
    lastStaminaUpdate = data.lastStaminaUpdate ?? Date.now();
        // âš”ï¸ ê²°íˆ¬ ê´€ë ¨ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
    duelWin        = data.duelWin        ?? 0;
    duelLose       = data.duelLose       ?? 0;
    duelCountToday = data.duelCountToday ?? 0;
    lastDuelDate   = data.lastDuelDate   ?? "";
    duelTargetsToday = data.duelTargetsToday ?? {};
    bully10Count      = Number(data.bully10Count || 0);
    challenger10Count = Number(data.challenger10Count || 0);
    brawl500Count     = Number(data.brawl500Count || 0);
    warGodWin         = Boolean(data.warGodWin || false);
    itemHonorMedal = data.itemHonorMedal ?? 0;
    starShard = data.starShard ?? 0;
    itemEssence = Number(data.itemEssence || 0);
    itemMagicPaper = Number(data.itemMagicPaper || 0);
    itemEngraveNormal = Number(data.itemEngraveNormal || 0);
    itemEngraveAdvanced = Number(data.itemEngraveAdvanced || 0);
    couponUsedMap = data.couponUsed || {};
    // âœ… ëª…ì˜ˆì˜ì „ë‹¹(30ê°•) / ê¸€ë¡œë²Œ 30ê°• ì´ë²¤íŠ¸ ìƒíƒœ ë¡œë“œ
    hofDeadline = Number(data.hofDeadline || 0);
    hofAchievedAt = Number(data.hofAchievedAt || 0);
    hofWeaponTypeAt30 = data.hofWeaponTypeAt30 || "";
    hofProcessedAt = Number(data.hofProcessedAt || 0);

    lastSeenGlobal30EventId = Number(data.lastSeenGlobal30EventId || 0);
    aweUsedGlobal30EventId = Number(data.aweUsedGlobal30EventId || 0);

    reach30Count = Number(data.reach30Count || 0);

    duelPoint      = data.duelPoint      ?? 0;
    duelPointWeekKey = data.duelPointWeekKey || "";
    duelLastWeekPoint = data.duelLastWeekPoint ?? 0;
    duelLastWeekRank  = data.duelLastWeekRank ?? 0;
    duelLastWeekRewardClaimed = data.duelLastWeekRewardClaimed ?? false;
    duelUpdated         = data.duelUpdated ?? 0;
    duelLastWeekUpdated = data.duelLastWeekUpdated ?? 0;

    // ğŸŸ¢ ì£¼ì°¨ ì •ë¦¬ (ì§€ë‚œì£¼ í¬ì¸íŠ¸ ìŠ¤ëƒ…ìƒ· + ì´ë²ˆ ì£¼ ì´ˆê¸°í™”)
    ensureDuelWeek();
    // ğŸ† ì§€ë‚œì£¼ ë³´ìƒ ì²´í¬ & ì§€ê¸‰
    checkWeeklyDuelReward();

// í™”ë©´ ì „í™˜
const loginScreen = document.getElementById("loginScreen");
const gameScreen  = document.getElementById("gameScreen");

if (loginScreen) loginScreen.style.display = "none";
if (gameScreen)  gameScreen.style.display  = "block";

// âœ… ë²„íŠ¼/íŒ¨ë„ë“¤(ì—†ì–´ë„ í¬ë˜ì‹œ X)
setDisplay("attendanceIconBtn",   "block");
setDisplay("logoutBtn",       "none");
setDisplay("couponBtn",       "none");
setDisplay("hamburgerBtn",    "block");

setDisplay("duelIconBtn",     "block");
setDisplay("guildIconBtn",    "block");
setDisplay("mapBtn",          "block");
setDisplay("userListIconBtn", "block");
setDisplay("bossBattleIconBtn", "block");
setDisplay("achievementIconBtn",  "block");

setDisplay("toastLog",        "block");
setDisplay("workbenchDock",   "block");
setDisplay("workbenchDockUI", "flex");

        // âœ… ì—¬ê¸°ì—ì„œ ìë™ ìƒˆë¡œê³ ì¹¨ íƒ€ì´ë¨¸ ì‹œì‘
    startAutoRefreshTimer();

        // ğŸŒ 25ê°• ì´ìƒ íŒŒê´´ ê¸€ë¡œë²Œ ì•Œë¦¼ êµ¬ë… ì‹œì‘
    subscribeGlobalDestroyEvents();
    subscribeGlobal30Events();

    // ğŸ” ìë™ë¡œê·¸ì¸ìœ¼ë¡œ ë“¤ì–´ì˜¨ ê²½ìš°ì—ë„ ì´ íƒ­ì´ ì„¸ì…˜ì„ ê°€ì ¸ê°€ë„ë¡
    startSession();
    ensureBossRunsSubscription();  // âœ… ë¡œê·¸ì¸ ì§í›„ì—ë„ í† ë²Œ êµ¬ë…/ë³µêµ¬ ì‹œì‘

// ğŸ·ï¸ ì¹­í˜¸ ìë™ ì§€ê¸‰(ìë™ë¡œê·¸ì¸ ë¡œë“œ ì§í›„)
const titleChanged = checkAndGrantTitles();
if (titleChanged) save();
    
    update();
    updateAttendanceBadge();
startAttendanceResetTimer();
    showTutorialIfFirstTime();
    loadUpdateNotices();
    loadHallOfFame();
startHonorHallTimers();
updateHonorHallButton();
    ensureDuelWeek();
  });
}

// ğŸ§¾ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ì—´ê¸°
function openOtherUserProfilePopup(targetId) {
  const overlay = document.getElementById("otherProfileOverlay");
  if (!overlay) return;

  const nickEl        = document.getElementById("otherProfileNickname");
  const weaponTitleEl = document.getElementById("otherProfileWeaponTitle");
  const weaponDescEl  = document.getElementById("otherProfileWeaponDesc");
  const maxInfoEl     = document.getElementById("otherProfileMaxInfo");

  // âœ… ì „íˆ¬ë ¥ â†’ ê³µê²©ë ¥/ì£¼ë¬¸ë ¥ ë¼ë²¨ + ê°’
  const powerLabelEl  = document.getElementById("otherProfilePowerLabel"); // (ìƒˆë¡œ í•„ìš”)
  const powerEl       = document.getElementById("otherProfilePower");

  const goldEl        = document.getElementById("otherProfileGold");
  const imgEl         = document.getElementById("otherWeaponImage");

  // âœ… ê°ì¸ 3ì¤„(ìƒˆë¡œ í•„ìš”)
  const engr1El       = document.getElementById("otherProfileEngrave1");
  const engr2El       = document.getElementById("otherProfileEngrave2");
  const engr3El       = document.getElementById("otherProfileEngrave3");

  // ê¸°ë³¸ ì´ˆê¸°í™”
  if (nickEl)        nickEl.textContent        = targetId;
  if (weaponTitleEl) weaponTitleEl.textContent = "-";
  if (weaponDescEl)  weaponDescEl.textContent  = "-";
  if (maxInfoEl)     maxInfoEl.textContent     = "-";

  if (powerLabelEl)  powerLabelEl.textContent  = "ê³µê²©ë ¥";
  if (powerEl)       powerEl.textContent       = "0";

  if (goldEl)        goldEl.textContent        = "0";
  if (imgEl)         imgEl.src                 = "images/weapons/sword_real_temp.png";

  if (engr1El) engr1El.textContent = "1) -";
  if (engr2El) engr2El.textContent = "2) -";
  if (engr3El) engr3El.textContent = "3) -";

  // DBì—ì„œ í•´ë‹¹ ìœ ì € ì •ë³´ ì½ê¸°
  db.ref("users/" + targetId).once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const d = snap.val() || {};
    if (nickEl) nickEl.innerHTML = formatNicknameWithTitle(targetId, d.equippedTitle || "", d.reach30Count);

    const swordLevel      = Number(d.sword || 0);
    const weaponTypeOther = d.weaponType || "sword";
    const maxSword        = Number(d.maxSwordLevel ?? swordLevel);
    const destroyCnt      = Number(d.destroyCount || 0);

    // âœ… ì „íˆ¬ë ¥(power) ëŒ€ì‹  "ê³µê²©ë ¥/ì£¼ë¬¸ë ¥" í‘œì‹œìš© ê°’
    // - ë„¤ DBì— mainPower ê°™ì€ ê°’ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš©
    // - ì—†ìœ¼ë©´ ê¸°ì¡´ d.powerë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œ(ìµœì†Œí•œ ê¸°ì¡´ ê¸°ëŠ¥ì€ ìœ ì§€)
    const mainPowerVal = Number((d.mainPower != null) ? d.mainPower : (d.power || 0));

    const goldVal       = Number(d.gold || 0);

    // ë¬´ê¸° ì •ë³´
    const wInfo = getWeaponInfo(swordLevel, weaponTypeOther);

    if (weaponTitleEl && wInfo) {
      weaponTitleEl.textContent = `${wInfo.name} (+${swordLevel}ê°•)`;
    }
    if (weaponDescEl && wInfo) {
      weaponDescEl.textContent = wInfo.desc;
    }
    if (maxInfoEl) {
      maxInfoEl.innerHTML =
        `+${maxSword}ê°• ` +
        `<span style="font-size:12px; color:#bbbbbb;">(íŒŒê´´ ${destroyCnt}íšŒ)</span>`;
    }

    // âœ… ê³µê²©ë ¥/ì£¼ë¬¸ë ¥ ë¼ë²¨
    const isStaff = (String(weaponTypeOther).toLowerCase() === "staff");
    if (powerLabelEl) powerLabelEl.textContent = isStaff ? "ì£¼ë¬¸ë ¥" : "ê³µê²©ë ¥";

    // âœ… ê³µê²©ë ¥/ì£¼ë¬¸ë ¥ ê°’ í‘œì‹œ
    if (powerEl) powerEl.textContent = formatGold(mainPowerVal);

    // ê³¨ë“œ í‘œì‹œ(ìœ ì§€)
    if (goldEl) goldEl.textContent = formatGold(goldVal);

    // âœ… ê°ì¸ 3ì¤„ í‘œê¸° (ì—†ìœ¼ë©´ "-")
    // ê°ì¸ ì €ì¥ í‚¤ëŠ” d.engraveLines (ë°°ì—´) ê¸°ì¤€
    const lines = Array.isArray(d.engraveLines) ? d.engraveLines : [];
    if (engr1El) engr1El.textContent = lines[0] ? lines[0] : "-";
    if (engr2El) engr2El.textContent = lines[1] ? lines[1] : "-";
    if (engr3El) engr3El.textContent = lines[2] ? lines[2] : "-";

    if (imgEl && wInfo && wInfo.img) {
      imgEl.src = wInfo.img;
    }

    overlay.style.display = "flex";
  }).catch(err => {
    console.error("í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    alert("í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  });
}

// ğŸŒˆ ëª…ì˜ˆì˜ ì „ë‹¹ ì „ìš©: ë‹¬ì„± ë‹¹ì‹œ(+30) ë¬´ê¸° ì´ë¯¸ì§€ë¡œ í”„ë¡œí•„ ë³´ê¸°
function openHallOfFameProfilePopup(targetId, weaponTypeAt30, achievedAt) {
  const overlay        = document.getElementById("otherProfileOverlay");
  if (!overlay) return;

  const nickEl         = document.getElementById("otherProfileNickname");
  const weaponTitleEl  = document.getElementById("otherProfileWeaponTitle");
  const weaponDescEl   = document.getElementById("otherProfileWeaponDesc");
  const maxInfoEl      = document.getElementById("otherProfileMaxInfo");
  const powerEl        = document.getElementById("otherProfilePower");
  const goldEl         = document.getElementById("otherProfileGold");
  const weaponValueEl  = document.getElementById("otherProfileWeaponValue");
  const recordEl       = document.getElementById("otherProfileRecord");
  const imgEl          = document.getElementById("otherWeaponImage");

  // ê¸°ë³¸ ì´ˆê¸°í™”
  if (nickEl)        nickEl.textContent        = targetId;
  if (weaponTitleEl) weaponTitleEl.textContent = "-";
  if (weaponDescEl)  weaponDescEl.textContent  = "-";
  if (maxInfoEl)     maxInfoEl.textContent     = "-";
  if (powerEl)       powerEl.textContent       = "0";
  if (goldEl)        goldEl.textContent        = "0";
  if (weaponValueEl) weaponValueEl.textContent = "0";
  if (recordEl)      recordEl.textContent      = "ìŠ¹ 0 / íŒ¨ 0";
  if (imgEl)         imgEl.src                 = "images/weapons/sword_real_temp.png";

  db.ref("users/" + targetId).once("value").then(snap => {
    if (!snap.exists()) {
      alert("í•´ë‹¹ ìœ ì € ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const d = snap.val() || {};
    if (nickEl) nickEl.innerHTML = formatNicknameWithTitle(targetId, d.equippedTitle || "", d.reach30Count);

    // âœ… ì „ë‹¹ì€ ë¬´ì¡°ê±´ â€œë‹¬ì„± ë‹¹ì‹œ +30â€ë¡œ í‘œì‹œ
    const swordLevel = 30;
    const wt = weaponTypeAt30 || d.hofWeaponTypeAt30 || d.weaponType || "sword";
    const wInfo = getWeaponInfo(swordLevel, wt);

    const powerVal   = Number(d.power || 0);
    const goldVal    = Number(d.gold || 0);
    const duelW      = Number(d.duelWin || 0);
    const duelL      = Number(d.duelLose || 0);

    if (weaponTitleEl && wInfo) weaponTitleEl.textContent = `${wInfo.name} (+${swordLevel}ê°•)`;
    if (weaponDescEl && wInfo)  weaponDescEl.textContent  = wInfo.desc;

    // ì „ë‹¹ ê¸°ë¡ ì •ë³´ í‘œì‹œ(ë‹¬ì„± ì‹œê°)
    if (maxInfoEl) {
      const dt = achievedAt ? new Date(Number(achievedAt)).toLocaleString("ko-KR") : "-";
      maxInfoEl.innerHTML = `<span style="color:#ffd54f;">ëª…ì˜ˆì˜ ì „ë‹¹ ê¸°ë¡</span> <span style="font-size:12px; color:#bbbbbb;">(${dt})</span>`;
    }

    if (powerEl) powerEl.textContent = formatGold(powerVal);
    if (goldEl)  goldEl.textContent  = formatGold(goldVal);

    if (weaponValueEl) {
      const avgValue = getSellRewardAverage(swordLevel);
      weaponValueEl.textContent = formatGold(avgValue);
    }

    if (recordEl) recordEl.textContent = `ìŠ¹ ${duelW} / íŒ¨ ${duelL}`;

    if (imgEl && wInfo && wInfo.img) imgEl.src = wInfo.img;

    overlay.style.display = "flex";
  }).catch(err => {
    console.error("ì „ë‹¹ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
    alert("í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  });
}
  
// ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… ë‹«ê¸° (í†µí•©)
function closeOtherUserProfilePopup() {
  const overlay = document.getElementById("otherProfileOverlay");
  if (overlay) {
    overlay.style.display = "none";
  }
}

// ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… / ê³µì§€ ESC ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", function () {
  loadSoundSettings();
  loadUnseenTitles();
  updateAchievementBadge();
  const overlay  = document.getElementById("otherProfileOverlay");
  const closeBtn = document.getElementById("otherProfileCloseBtn");

  // 1) ì–´ë‘ìš´ ë°°ê²½ í´ë¦­ â†’ ì¹´ë“œ ë°”ê¹¥ í´ë¦­ì¼ ë•Œë§Œ ë‹«ê¸°
  if (overlay) {
    overlay.addEventListener("click", function (e) {
      if (!e.target.closest(".other-profile-card")) {
        closeOtherUserProfilePopup();
      }
    });
  }

  // 2) X ë²„íŠ¼ í´ë¦­ â†’ ë‹«ê¸°
  if (closeBtn) {
    closeBtn.addEventListener("click", function (e) {
      e.stopPropagation(); // ë°°ê²½ìœ¼ë¡œ í´ë¦­ ì „íŒŒ ë§‰ê¸°
      closeOtherUserProfilePopup();
    });
  }

  // 3) ESC í‚¤ â†’ í”„ë¡œí•„ / ê³µì§€ ëª¨ë‘ ì²˜ë¦¬
  document.addEventListener("keydown", function (e) {
    if (e.key !== "Escape") return;

        // (1) í”„ë¡œí•„ íŒì—… ë‹«ê¸°
    closeOtherUserProfilePopup();

    // (2) ê³µì§€ íŒì—… ë‹«ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const noticePopup   = document.getElementById("noticePopup");
    const noticeOverlay = document.getElementById("noticeOverlay");

    
    
    if (noticePopup && noticePopup.style.display !== "none") {
      if (typeof closeNoticePopup === "function") {
        closeNoticePopup();
      } else {
        noticePopup.style.display = "none";
        if (noticeOverlay) noticeOverlay.style.display = "none";
      }
    }

    // (3) ì¸ë²¤í† ë¦¬ ë‹«ê¸°
    if (typeof closeInventoryOverlay === "function") closeInventoryOverlay();

  });
});

  // ğŸ§· ë­í‚¹ ë‹‰ë„¤ì„ â†’ "í”„ë¡œí•„ ë³´ê¸°" ë©”ë‰´ â†’ í”„ë¡œí•„ íŒì—…
let lastRankProfileUserId = null;

(function initRankingProfileMenu() {
  const rankingEl = document.getElementById("ranking");
  const menuEl    = document.getElementById("rankProfileMenu");
  const viewBtn   = document.getElementById("rankProfileViewBtn");
  const overlay   = document.getElementById("otherProfileOverlay");
  const closeBtn  = document.getElementById("otherProfileCloseBtn");

  // 1) ë­í‚¹ ì˜ì—­ì—ì„œ ë‹‰ë„¤ì„ í´ë¦­ ì‹œ ì‘ì€ ë©”ë‰´ë¥¼ "í„°ì¹˜í•œ ìë¦¬"ì— í‘œì‹œ
  if (rankingEl && menuEl) {
    rankingEl.addEventListener("click", function(e) {
      const userSpan = e.target.closest(".rank-user");
      if (!userSpan) return;

      const uid = userSpan.dataset.userId;
      if (!uid) return;
      lastRankProfileUserId = uid;

      const x = e.pageX;
      const y = e.pageY;

      menuEl.style.left   = x + "px";
      menuEl.style.top    = y + "px";
      menuEl.style.display = "block";

      e.stopPropagation();
    });
  }

  // 2) "í”„ë¡œí•„ ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ íŒì—… ì—´ê¸°
  if (viewBtn && menuEl) {
    viewBtn.addEventListener("click", function(e) {
      playUiClick();
      e.stopPropagation();
      if (!lastRankProfileUserId) return;
      menuEl.style.display = "none";
      openOtherUserProfilePopup(lastRankProfileUserId);
    });
  }

  // 3) í™”ë©´ ë‹¤ë¥¸ ê³³ í´ë¦­í•˜ë©´ ì‘ì€ ë©”ë‰´ ë‹«ê¸°
  document.addEventListener("click", function(e) {
    if (!menuEl || menuEl.style.display !== "block") return;

    // ë©”ë‰´ ë‚´ë¶€ or ë‹‰ë„¤ì„ ë‹¤ì‹œ í´ë¦­ì´ë©´ ìœ ì§€
    if (e.target.closest("#rankProfileMenu")) return;
    if (e.target.closest(".rank-user")) return;

    menuEl.style.display = "none";
  });

  // 4) íŒì—… ë°”ê¹¥(ì–´ë‘ìš´ ë°°ê²½) í´ë¦­í•˜ë©´ ë‹«ê¸°
  if (overlay) {
    overlay.addEventListener("click", function(e) {
      if (e.target === overlay) {
        closeOtherUserProfilePopup();
      }
    });
  }

  // 5) ë‹«ê¸° ë²„íŠ¼
  if (closeBtn) {
    closeBtn.addEventListener("click", function(e) {
      e.stopPropagation();
      closeOtherUserProfilePopup();
    });
  }
})();
  
/* ë­í‚¹ */
function loadRanking() {

  const usersRef = db.ref("users");

  // ğŸ” TOP 10 (once)
  usersRef
    .orderByChild("sword")
    .limitToLast(10)
    .on("value", s => {
      const rankingEl = document.getElementById("ranking");
      if (!rankingEl) return;

      const arr = [];
      s.forEach(child => {
        const d = child.val() || {};
        arr.push({
          id: child.key,
          sword: Number(d.sword || 0),
          updated: Number(d.updated || 0),
          duelWin: Number(d.duelWin || 0),
          duelLose: Number(d.duelLose || 0),
          weaponType: d.weaponType || "sword",
          equippedTitle: d.equippedTitle || "",
          reach30Count: Number(d.reach30Count || 0)
        });
      });

      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

rankingEl.innerHTML = arr.map((u, i) => {
  const wInfo = getWeaponInfo(u.sword, u.weaponType || "sword");
  const weaponNameStyled = coloredWeaponName(u.sword, wInfo.name);

  return `
    <div class="ranking-row" style="font-weight:bold;">
      ${i+1}. <span class="rank-user" data-user-id="${u.id}">${formatNicknameWithTitle(u.id, u.equippedTitle, u.reach30Count)
}</span>
      | ${weaponNameStyled} ${coloredLevel(u.sword)}
      | ì „ì : ${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨
    </div>
  `;
}).join("");

    });

  // ğŸ‘‡ ë‚´ ë­í‚¹ + ê²°íˆ¬ ë§¤ì¹­ ìºì‹œ (on)
  usersRef
    .orderByChild("sword")
    .on("value", s => {
      const myRankEl = document.getElementById("myRank");
      if (!myRankEl) return;

      const arr = [];
      s.forEach(c => {
        const d = c.val() || {};
        arr.push({
          id: c.key,
          sword: Number(d.sword || 0),
          updated: Number(d.updated || 0),
          power: Number(d.power || 0),
          weaponType: d.weaponType || "sword",
          equippedTitle: d.equippedTitle || "",
          reach30Count: Number(d.reach30Count || 0)
        });
      });

      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

      // âš”ï¸ ê²°íˆ¬ìš© ìºì‹œ
      allUsersCache = arr.slice();
      refreshUserListOverlayIfOpen();

      if (!userId) {
        myRankEl.innerText = "";
        return;
      }

      const idx = arr.findIndex(u => u.id === userId);

      if (idx === -1) {
        myRankEl.innerText = "ë‚´ ë­í‚¹: ê¸°ë¡ ì—†ìŒ";
      } else {
        const myInfo = arr[idx];
        myRankEl.innerHTML = `
          ë‚´ ë­í‚¹: <b>${idx + 1}ìœ„</b>
          (${coloredLevel(myInfo.sword)}, ì „ì : ${duelWin}ìŠ¹ ${duelLose}íŒ¨)
        `;
      }
    });
}
  
// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ "YYYY-MM-DD" í˜•íƒœë¡œ ë°˜í™˜ (ì¶œì„ ì²´í¬ìš©)
function getTodayDateString() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

  // ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ë Œë”ë§
function renderUserList(list) {
  const body = document.getElementById("userListBody");
  const countEl = document.getElementById("userListCount");
  const searchInput = document.getElementById("userListSearch");
  if (!body || !countEl) return;

  if (!list || list.length === 0) {
    body.innerHTML = `
      <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
        ë“±ë¡ëœ ëª¨í—˜ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.
      </div>
    `;
    countEl.textContent = "ì´ 0ëª…";
    return;
  }

  const total = list.length;
  const keyword = (searchInput?.value || "").trim();

  if (!keyword) {
    countEl.textContent = `ì´ ${total}ëª… (ê°•í™” ìˆœ ì „ì²´)`;
  } else {
    countEl.textContent = `ì´ ${total}ëª… ì¤‘ ê²€ìƒ‰ ê²°ê³¼`;
  }

const rows = list.map((u, idx) => {
  const powerText = (u.power != null)
    ? Number(u.power).toLocaleString("ko-KR")
    : "-";

  return `
    <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #333; font-size:12px;">
      <div>
        <span style="font-weight:bold;">${idx + 1}ìœ„</span>

        <!-- ğŸ‘‡ í•˜ì–€ ê¸€ì, ë°‘ì¤„ ì—†ìŒ, í´ë¦­ ê°€ëŠ¥ -->
        <span
          class="userListName"
          onclick="openUserProfileFromUserList('${u.id}')"
          >
           ${formatNicknameWithTitle(u.id, u.equippedTitle, u.reach30Count)}
        </span>
      </div>

      <div style="text-align:right;">
        <div>+${u.sword}ê°•</div>
        <div style="font-size:11px; color:#ccc;">
          ì „íˆ¬ë ¥ ${powerText}
        </div>
      </div>
    </div>
  `;
});

  body.innerHTML = rows.join("");
}

  // ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ì—ì„œ í”„ë¡œí•„ ì¹´ë“œ ì—´ê¸°
function openUserProfileFromUserList(userId) {

  // 2) ê¸°ì¡´ì— ìˆë˜ í”„ë¡œí•„ íŒì—… í•¨ìˆ˜ í˜¸ì¶œ
  //    (ë­í‚¹ì—ì„œ ì“°ëŠ” ê·¸ í•¨ìˆ˜ ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©)
  if (typeof openOtherUserProfilePopup === "function") {
    openOtherUserProfilePopup(userId);
  } else {
    // í˜¹ì‹œë¼ë„ í•¨ìˆ˜ ëª» ì°¾ì„ ë•Œ ëŒ€ë¹„
    alert("í”„ë¡œí•„ íŒì—… í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  }
}

  // ğŸ” ì „ì²´ ìœ ì € ëª©ë¡ ê²€ìƒ‰ ì ìš©
function applyUserListSearch() {
  const searchInput = document.getElementById("userListSearch");
  if (!searchInput) return;

  const q = searchInput.value.trim().toLowerCase();
  let filtered = allUsersCache.slice();

  if (q) {
    filtered = filtered.filter(u =>
      String(u.id || "").toLowerCase().includes(q)
    );
  }

  renderUserList(filtered);
}

// ğŸ†• allUsersCache ê°±ì‹ ë  ë•Œ, ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ ìˆìœ¼ë©´ ìë™ ìƒˆë¡œê³ ì¹¨
function refreshUserListOverlayIfOpen() {
  const overlay = document.getElementById("userListOverlay");
  if (!overlay || overlay.style.display === "none") return;

  applyUserListSearch();  // ê²€ìƒ‰ì–´ ìœ ì§€í•œ ì±„ë¡œ ê°±ì‹ 
}

  // ğŸ‡°ğŸ‡· í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ ë‚ ì§œ/ì‹œê°„ ì–»ê¸°
function getKstNow() {
  const now = new Date();
  const utc = now.getTime() + now.getTimezoneOffset() * 60000;
  // KST = UTC+9
  return new Date(utc + 9 * 60 * 60000);
}

// ğŸ—“ í•œêµ­ ì‹œê°„ ê¸°ì¤€ "ì´ë²ˆ ì£¼ í‚¤" (ì›”ìš”ì¼ ë‚ ì§œ ê¸°ì¤€)
function getKstWeekKey() {
  const now = getKstNow();
  const day = now.getDay(); // 0=ì¼, 1=ì›” ... 6=í† 

  // ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ë‚ ì§œë¡œ ë§ì¶”ê¸°
  const diffToMonday = (day + 6) % 7; // ì›”=0, í™”=1 ... ì¼=6
  const monday = new Date(now.getTime() - diffToMonday * 24 * 60 * 60 * 1000);

  const y = monday.getFullYear();
  const m = String(monday.getMonth() + 1).padStart(2, "0");
  const d = String(monday.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;  // ì˜ˆ: "2026-01-05"
}

// ğŸ† ì§€ë‚œì£¼ ê²°íˆ¬ ë³´ìƒ ì²´í¬ & ì§€ê¸‰
function checkWeeklyDuelReward() {
  if (duelLastWeekRewardClaimed) return;

  // ğŸ†• ì´ë²ˆ ê¸°ì¤€ì—ì„œ "ì§„ì§œ ì§€ë‚œì£¼" ë²”ìœ„ ê³„ì‚°
  const range = getLastWeekRangeKst();
  const startTs = range.start;
  const endTs   = range.end;

  // âœ… ì´ë²ˆ ì£¼ í‚¤
  const thisWeekKey = getKstWeekKey();

  // âœ… (ë‚´ ê¸°ë¡ë„) ì£¼ì°¨ê°€ ì•ˆ ë„˜ì–´ê°„ ìƒíƒœë©´ duelPointê°€ 'ì§€ë‚œì£¼'ì¼ ìˆ˜ ìˆìŒ
  const myWeekKey = duelPointWeekKey || "";
  const myPoint =
    myWeekKey === thisWeekKey
      ? Number(duelLastWeekPoint || 0)
      : Number(duelPoint || 0);

  const myTime =
    myWeekKey === thisWeekKey
      ? Number(duelLastWeekUpdated || 0)
      : Number(duelUpdated || 0);

  // ì§€ë‚œì£¼ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì´ë²ˆ ì£¼ì—ëŠ” ë³´ìƒ ì²´í¬ ë‹¤ì‹œ ì•ˆ í•˜ê²Œ í”Œë˜ê·¸ë§Œ ì„¸ì›€
  if (myPoint <= 0 || !myTime || myTime < startTs || myTime >= endTs) {
    duelLastWeekRewardClaimed = true;
    save();
    return;
  }

  const usersRef = db.ref("users");
  usersRef
    .once("value")
    .then((snap) => {
      const arr = [];

      snap.forEach((child) => {
        const val = child.val() || {};
        const uid = child.key;

        const userWeekKey = val.duelPointWeekKey || "";

        const p =
          userWeekKey === thisWeekKey
            ? Number(val.duelLastWeekPoint || 0)
            : Number(val.duelPoint || 0);

        const t =
          userWeekKey === thisWeekKey
            ? Number(val.duelLastWeekUpdated || 0)
            : Number(val.duelUpdated || 0);

        // ğŸ” 1) í¬ì¸íŠ¸ 0 ì´í•˜ëŠ” ì œì™¸
        if (p <= 0) return;

        // ğŸ” 2) ì§€ë‚œì£¼ ê¸°ê°„ ë°–(ë„ˆë¬´ ì˜›ë‚  ê¸°ë¡)ì€ ì œì™¸
        if (!t || t < startTs || t >= endTs) return;

        arr.push({
          id: uid,
          point: p,
          updated: t
        });
      });

      if (arr.length === 0) {
        duelLastWeekRewardClaimed = true;
        save();
        return;
      }

      // ğŸ” í¬ì¸íŠ¸ ë‚´ë¦¼ì°¨ìˆœ / ë™ì ì´ë©´ ë¨¼ì € ë„ë‹¬(ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœ)
      arr.sort((a, b) => {
        if (b.point !== a.point) return b.point - a.point;
        const aTime = Number(a.updated || 0);
        const bTime = Number(b.updated || 0);
        return aTime - bTime;
      });

      const myIndex = arr.findIndex((u) => u.id === userId);
      if (myIndex === -1) {
        // í˜¹ì‹œë‚˜ ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ê·¸ëƒ¥ í”Œë˜ê·¸ë§Œ ë§‰ì•„ë‘”ë‹¤
        duelLastWeekRewardClaimed = true;
        save();
        return;
      }

      const myRank = myIndex + 1;
      duelLastWeekRank = myRank;

      // ì‹¤ì œ ë³´ìƒ ì§€ê¸‰
      const rewardText = grantWeeklyDuelReward(myRank);
      if (!rewardText) return;

      // ì¹´ë¥´ë‹ˆì•„ íŒì—…
      showNpcMessage(
        `
        <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">
          ì§€ë‚œì£¼ ë„¤ ê²°íˆ¬ì¥ ë­í‚¹ì€ <span style="color:#ffd54f;">${myRank}ìœ„</span>ì˜€ì–´.
        </div>
        <div style="font-size:13px; line-height:1.6;">
          ê·¸ ë…¸ë ¥ì— ëŒ€í•œ ë³´ìƒìœ¼ë¡œ,<br>
          <span style="color:#a5e1ff;">${rewardText}</span>ë¥¼ ì§€ê¸‰í•´ ë‘˜ê²Œ.
        </div>
        `,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
    })
    .catch((err) => {
      console.error("ì£¼ê°„ ê²°íˆ¬ ë³´ìƒ ê³„ì‚° ì‹¤íŒ¨:", err);
    });
}

// ğŸ† ì£¼ê°„ ê²°íˆ¬ ë³´ìƒ ì§€ê¸‰
function grantWeeklyDuelReward(myRank) {
  let rewardText = "";

  if (myRank === 1) {
    // 1ìœ„ - íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ 2ê°œ
    itemProtect += 2;
    rewardText = "íŒŒê´´ ë°©ì§€ ì£¼ë¬¸ì„œ 2ê°œ";
  } else if (myRank === 2 || myRank === 3) {
    // 2ìœ„, 3ìœ„ - íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ 1ê°œ
    itemProtect += 1;
    rewardText = "íŒŒê´´ ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œ";
  } else if (myRank >= 4 && myRank <= 6) {
    // 4~6ìœ„ - ê°•ë“±ë°©ì–´ 5ê°œ + 15ê°• ì£¼ë¬¸ì„œ 3ê°œ
    itemDownProtect += 5;
    itemScroll15 += 3;
    rewardText = "ê°•ë“± ë°©ì–´ ì£¼ë¬¸ì„œ 5ê°œ, 15ê°• ê°•í™” ì£¼ë¬¸ì„œ 3ê°œ";
  } else if (myRank >= 7 && myRank <= 10) {
    // 7~10ìœ„ - ê°•ë“±ë°©ì–´ 3ê°œ + 15ê°• ì£¼ë¬¸ì„œ 1ê°œ
    itemDownProtect += 3;
    itemScroll15 += 1;
    rewardText = "ê°•ë“± ë°©ì–´ ì£¼ë¬¸ì„œ 3ê°œ, 15ê°• ê°•í™” ì£¼ë¬¸ì„œ 1ê°œ";
  } else {
    // 10ìœ„ ì´í•˜(í¬ì¸íŠ¸ëŠ” ìˆëŠ” ì‚¬ëŒ) - ê°•ë“±ë°©ì–´ 1ê°œ
    itemDownProtect += 1;
    rewardText = "ê°•ë“± ë°©ì–´ ì£¼ë¬¸ì„œ 1ê°œ";
  }

  // âœ… ì´ë²ˆ ì£¼ ë³´ìƒ ìˆ˜ë ¹ í”Œë˜ê·¸ ì„¸ìš°ê³  ì €ì¥
  duelLastWeekRewardClaimed = true;
  save();

  return rewardText;
}

// â° ê²°íˆ¬ì¥ ì§‘ê³„ ì‹œê°„ ì—¬ë¶€ (ì›”ìš”ì¼ 00:00 ~ 00:10, KST ê¸°ì¤€)
function isDuelSettlementTimeKST() {
  const now = getKstNow();          // ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜í•œ KSTìš© ì‹œê°„ í•¨ìˆ˜
  const day = now.getDay();         // 0=ì¼, 1=ì›” ... 6=í† 

  // ì›”ìš”ì¼ì´ ì•„ë‹ˆë©´ ì§‘ê³„ ì‹œê°„ ì•„ë‹˜
  if (day !== 1) return false;

  const totalMinutes = now.getHours() * 60 + now.getMinutes();
  // 00:00 ~ 00:09 ë¥¼ ì§‘ê³„ ì‹œê°„ìœ¼ë¡œ ë³¸ë‹¤
  return totalMinutes >= 0 && totalMinutes < 10;
}

// ğŸŒ™ ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ ì •ë¦¬
function ensureDuelWeek() {
  const weekKey = getKstWeekKey();  // í•œêµ­ì‹œê°„ ê¸°ì¤€ ì£¼ í‚¤
  currentWeekKey = weekKey;

  // ì²˜ìŒ ì ‘ì†í•œ ê²½ìš°: ê·¸ëƒ¥ í˜„ì¬ ì£¼ì°¨ë¡œ ì„¸íŒ…
  if (!duelPointWeekKey) {
    duelPointWeekKey = weekKey;
    return;
  }

  // ì£¼ì°¨ê°€ ë°”ë€Œì—ˆìœ¼ë©´ ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ ë„˜ê¸°ê³  ì´ë²ˆ ì£¼ ì´ˆê¸°í™”
  if (duelPointWeekKey !== weekKey) {
    // ì§€ë‚œ ì£¼ í¬ì¸íŠ¸ + ê°±ì‹  ì‹œê° ë°±ì—…
    duelLastWeekPoint   = duelPoint;
    duelLastWeekUpdated = duelUpdated || 0;

    // ì´ë²ˆ ì£¼ ì´ˆê¸°í™”
    duelPoint   = 0;
    duelUpdated = 0;

    // ì´ë²ˆ ì£¼ë¡œ í‚¤ ê°±ì‹ 
    duelPointWeekKey = weekKey;

    // ìƒˆ ì£¼ ì‹œì‘ â†’ ì§€ë‚œì£¼ ë³´ìƒ ì•„ì§ ì•ˆ ë°›ìŒ
    duelLastWeekRewardClaimed = false;
  }
}

// ì–´ì œ ë‚ ì§œ "YYYY-MM-DD"
function getYesterdayDateString() {
  const d = new Date();
  d.setDate(d.getDate() - 1);
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// íƒ€ì„ìŠ¤íƒ¬í”„ â†’ "MM/DD hh:mm:ss"
function formatTime(ts) {
  const d = new Date(ts);

  const MM  = String(d.getMonth() + 1).padStart(2, "0"); // ì›”
  const DD  = String(d.getDate()).padStart(2, "0");      // ì¼
  const hh  = String(d.getHours()).padStart(2, "0");     // ì‹œ
  const mm  = String(d.getMinutes()).padStart(2, "0");   // ë¶„
  const ss  = String(d.getSeconds()).padStart(2, "0");   // ì´ˆ

  return `${MM}/${DD} ${hh}:${mm}:${ss}`;
}

// íŒŒê´´ ë¬µë… ëŒ“ê¸€ ëœë¤
function getRandomMournComment() {
  const lines = [
    "ì™€~! íƒœì´ˆë§ˆì„ì´ì•¼~!",
    "ì´ ë§›ì— ê°•í™”í•˜ì§€ ã…‹ã…‹",
    "ê¹¨ë—í•˜ë‹¤, 0ê°•â€¦",
    "ì € ê°•ì²  ëƒ„ìƒˆ ë§¡ì•„ë´â€¦ ìƒˆê±°ì•¼ ìƒˆê±°.",
    "ê°•í™”ëŠ” ì›ë˜ ì—¬ê¸°ì„œë¶€í„° ì‹œì‘ì´ì£ ?",
    "ì•„ë¦„ë‹¤ìš´ í­ë°œì´ì—ˆìŠµë‹ˆë‹¤.",
    "ë˜ ë§Œë‚˜ì, +0ê°• ì‹œì ˆâ€¦",
    "ì €ê²Œ ë°”ë¡œ í•˜ë“œ ë¦¬ì…‹ì´ë¼ëŠ” ê±°ì•¼.",
    "ìš©ê¸° ìˆëŠ” ìì˜ ê²°ë§ì´êµ°.",
    "ê´€ì§ ì—´ê³  ë‹¤ì‹œ ê³ ê³ ì”½~"
  ];
  const i = Math.floor(Math.random() * lines.length);
  return lines[i];
}

// íŠ¹ì • ë¡œê·¸ ë°‘ì— ëŒ“ê¸€ í•œ ì¤„ ì¶”ê°€ (ìƒë‹¨ ë¡œê·¸ + ì‹¤ì‹œê°„ í† ìŠ¤íŠ¸ ë‘˜ ë‹¤)
function appendMournCommentToLog(logId, commentData) {
  // 1) ìƒë‹¨ ë¡œê·¸ íŒ¨ë„
  const panelItem = document.getElementById("log-" + logId);
  if (panelItem) {
    const commentsBox = panelItem.querySelector(".log-comments");
    if (commentsBox) {
      const div = document.createElement("div");
      div.style.fontSize = "12px";
      div.style.color = "#ccc";
      div.innerHTML = `â†³ ${commentData.text} <span style="color:#888;">- ${commentData.userId}</span>`;
      commentsBox.appendChild(div);
    }
  }

  // 2) í•˜ë‹¨ ì‹¤ì‹œê°„ í† ìŠ¤íŠ¸
  const toastItem = document.getElementById("toast-" + logId);
  if (toastItem) {
    const toastBox = toastItem.querySelector(".toast-comments");
    if (toastBox) {
      const div = document.createElement("div");
      div.style.fontSize = "11px";
      div.style.color = "#bbb";
      div.innerHTML = `â†³ ${commentData.text} <span style="color:#888;">- ${commentData.userId}</span>`;
      toastBox.appendChild(div);
    }
  }
}


  // [ë¬µë…í•˜ê¸°] í´ë¦­ ì‹œ ì²˜ë¦¬ (ìœ ì €ë‹¹ 1íšŒ)
function handleMournClick(e) {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const logId = e.target.dataset.logId;
  if (!logId) return;

  const userMournRef = logRef.child(logId).child("mournedBy").child(userId);

  // ì´ë¯¸ ì´ ë¡œê·¸ì— ë¬µë…í–ˆëŠ”ì§€ ì²´í¬
  userMournRef.once("value").then(snap => {
    if (snap.exists()) {
      alert("ì´ë¯¸ ì´ íŒŒê´´ì— ë¬µë…í–ˆìŠµë‹ˆë‹¤.");
      return;
    }

    // ì´ ìœ ì €ê°€ ì‚¬ìš©í–ˆë‹¤ê³  ê¸°ë¡
    userMournRef.set(true);

    const comment = {
      userId: userId,
      text: getRandomMournComment(),
      time: Date.now()
    };

    // DBì— ëŒ“ê¸€ ë‚¨ê¸°ê¸°
    const commentsRef = logRef.child(logId).child("comments");
    const newRef = commentsRef.push(comment);
  });
}

  function getRandomAweComment() {
  const lines = [
    "ê·¸ ê²€ ëì—ì„œâ€¦ ë³„ì´ íƒœì–´ë‚¬ë‹¤. â˜…",
    "30ê°•ì€ ìš°ì—°ì´ ì•„ë‹ˆë¼, ì§‘ë…ì´ ì¦ëª…ëœ ìë¦¬ì˜€ë‹¤.",
    "í¼ê·¸ë€íŠ¸ì˜ ë¶ˆê½ƒì´ ì˜¤ëŠ˜, ì „ì„¤ì„ í•˜ë‚˜ ë” ë§Œë“¤ì—ˆë‹¤.",
    "ë‚˜ëŠ” ë³´ì•˜ë‹¤. ê°•í™”ì˜ ëì—ì„œ í”ë“¤ë¦¬ì§€ ì•Šì€ ì†ì„.",
    "ê·¸ ì´ë¦„ì„ ê¸°ì–µí•˜ë¼. ìš°ë¦¬ì˜ í•˜ëŠ˜ì— ìƒˆê²¨ì§„ ì²« ë¬¸ì¥ì´ë‹¤.",
    "ê²€ì´ ì•„ë‹ˆë¼, ì˜ì§€ê°€ ë¹›ë‚¬ë‹¤.",
    "ì˜¤ëŠ˜ì˜ ê¸°ë¡ì€ ë‚´ì¼ì˜ ê¸°ì¤€ì´ ëœë‹¤. ê²½ì™¸ë¥¼.",
    "ë³„ì€ ì•„ë¬´ì—ê²Œë‚˜ ë¶™ì§€ ì•ŠëŠ”ë‹¤. ì˜¤ì§ ë‹¬ì„±í•œ ìì—ê²Œë§Œ.",
    "ê²½ì™¸í•œë‹¤. ê·¸ë¦¬ê³  ë”°ë¼ê°€ê² ë‹¤. ì–¸ì  ê°€ ë‚˜ë„ ê·¸ ìë¦¬ì—.",
    "ì „ì„¤ì€ ì´ë ‡ê²Œ íƒœì–´ë‚œë‹¤â€¦ ì§€ê¸ˆ, ì—¬ê¸°ì„œ."
  ];
  return lines[Math.floor(Math.random() * lines.length)];
}

function handleAweClick(e) {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const logId = e.target.dataset.logId;
  const eventId = Number(e.target.dataset.eventId || 0);
  if (!logId || !eventId) return;

  // âœ… 1ì¸ 1íšŒ(ì´ë²¤íŠ¸ID ê¸°ì¤€) - ë¡œì»¬ ì„¸ì´ë¸Œ ê¸°ì¤€
  if (aweUsedGlobal30EventId === eventId) {
    alert("ì´ë¯¸ ì´ +30 ê¸°ë¡ì— ê²½ì™¸ë¥¼ ë°”ì³¤ìŠµë‹ˆë‹¤.");
    return;
  }

  // âœ… DB ê¸°ì¤€ 1ì¸ 1íšŒ(ë‹¤ë¥¸ ê¸°ê¸°/ë¸Œë¼ìš°ì € ëŒ€ë¹„)
  const userAweRef = logRef.child(logId).child("awedBy").child(userId);
  userAweRef.once("value").then(snap => {
    if (snap.exists()) {
      aweUsedGlobal30EventId = eventId;
      save();
      alert("ì´ë¯¸ ì´ +30 ê¸°ë¡ì— ê²½ì™¸ë¥¼ ë°”ì³¤ìŠµë‹ˆë‹¤.");
      return;
    }

    // ì‚¬ìš© ì²˜ë¦¬
    aweUsedGlobal30EventId = eventId;
    save();
    userAweRef.set(true);

    const comment = {
      userId: userId,
      text: getRandomAweComment(),
      time: Date.now()
    };

    // ê¸°ì¡´ ë¬µë… ëŒ“ê¸€ê³¼ ë™ì¼í•˜ê²Œ commentsì— ë‹¬ê¸°
    logRef.child(logId).child("comments").push(comment);
  });
}

/* ë¡œê·¸ */
function writeLog(message, isDestroy=false, extra=null){
  const payload = { message, isDestroy, time: Date.now() };
  if (extra && typeof extra === "object") Object.assign(payload, extra);
  logRef.push(payload);
}
logRef.limitToLast(50).on("child_added", s => {
  const d = s.val();
  const logId = s.key;          // ì´ ë¡œê·¸ì˜ ê³ ìœ  ID
  const ts = formatTime(d.time || Date.now());

  const toastListEl = document.getElementById("toastList");
if (!toastListEl) return;

  /* ğŸ‘‡ í•˜ë‹¨ í† ìŠ¤íŠ¸(5ê°œ ì œí•œ) */
  const toastEl = document.createElement("div");
  const toneClass =
  (d.tone === "boss_success") ? " toast-success" :
  (d.tone === "boss_fail") ? " toast-fail" :
  (d.tone === "boss_apply") ? " toast-boss-apply" : "";
  toastEl.className = "toast-item" + (d.isDestroy ? " toast-destroy" : "") + toneClass;
  toastEl.id = "toast-" + logId;   // ğŸ”´ ëŒ“ê¸€ ì—°ê²°ìš© ID

  // ë©”ì¸ í•œ ì¤„
  const toastMain = document.createElement("div");
  toastMain.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;

  // íŒŒê´´ ë¡œê·¸ë¼ë©´ [ë¬µë…í•˜ê¸°] ë²„íŠ¼ ì¶”ê°€
  if (d.isDestroy) {
    const btn = document.createElement("span");
    btn.textContent = " [ë¬µë…í•˜ê¸°]";
    btn.style.cursor = "pointer";
    btn.style.color = "#ffffff";  // í°ìƒ‰ ê°•ì¡°
    btn.dataset.logId = logId;
    btn.onclick = handleMournClick;
    toastMain.appendChild(btn);
  }

  // 30ê°• ë¡œê·¸ë¼ë©´ [ê²½ì™¸í•˜ê¸°] ë²„íŠ¼ ì¶”ê°€ (ë¬µë…í•˜ê¸°ì™€ ë™ì¼í•œ í˜•íƒœ)
if (d.isReach30) {
  const btn = document.createElement("span");
  btn.textContent = " [ê²½ì™¸í•˜ê¸°]";
  btn.style.cursor = "pointer";
  btn.style.color = "#ffffff";
  btn.dataset.logId = logId;
  btn.dataset.eventId = String(d.global30EventId || 0);
  btn.onclick = handleAweClick;
  toastMain.appendChild(btn);
}

  toastEl.appendChild(toastMain);

  // â¬‡ ëŒ“ê¸€ì´ ë‹¬ë¦´ ì˜ì—­
  const toastComments = document.createElement("div");
  toastComments.className = "toast-comments";
  toastComments.style.marginLeft = "18px";
  toastComments.style.marginTop  = "2px";
  toastEl.appendChild(toastComments);

  toastListEl.prepend(toastEl);
  while (toastListEl.children.length > 50) toastListEl.lastChild.remove();

  /* ğŸ‘‡ ìƒë‹¨ ë¡œê·¸ íŒ¨ë„ìš© í•­ëª© */
  const panelItem = document.createElement("div");
  panelItem.className = "toast-item" + (d.isDestroy ? " toast-destroy" : "") + toneClass;
  panelItem.id = "log-" + logId;   // ëŒ“ê¸€ ë¶™ì¼ ë•Œ ì°¾ê¸°ìš©

  const mainLine = document.createElement("div");
  mainLine.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;

  if (d.isDestroy) {
    const btn2 = document.createElement("span");
    btn2.textContent = " [ë¬µë…í•˜ê¸°]";
    btn2.style.cursor = "pointer";
    btn2.style.color = "#ffffff";
    btn2.dataset.logId = logId;
    btn2.onclick = handleMournClick;
    mainLine.appendChild(btn2);
  }

  if (d.isReach30) {
  const btn3 = document.createElement("span");
  btn3.textContent = " [ê²½ì™¸í•˜ê¸°]";
  btn3.style.cursor = "pointer";
  btn3.style.color = "#ffffff";
  btn3.dataset.logId = logId;
  btn3.dataset.eventId = String(d.global30EventId || 0);
  btn3.onclick = handleAweClick;
  mainLine.appendChild(btn3);
}

  panelItem.appendChild(mainLine);

  // ëŒ“ê¸€ ë°•ìŠ¤
  const commentsBox = document.createElement("div");
  commentsBox.className = "log-comments";
  commentsBox.style.marginLeft = "18px";
  commentsBox.style.marginTop  = "2px";
  panelItem.appendChild(commentsBox);

  // ì´í›„ì— ë‹¬ë¦¬ëŠ” ëŒ“ê¸€ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜
  logRef.child(logId).child("comments").on("child_added", snap => {
    const c = snap.val();
    appendMournCommentToLog(logId, c);
  });
});

  // ğŸŒ ì „ ì„œë²„ ë„ì „ ì•Œë¦¼ ë°°ë„ˆ
let worldBannerInited = false;

function showWorldBanner(message) {
  const banner = document.getElementById("worldBanner");
  if (!banner) return;

  banner.innerHTML = message;
  banner.style.display = "block";

  // 7ì´ˆ í›„ ìë™ ìˆ¨ê¹€
  setTimeout(() => {
    banner.style.display = "none";
  }, 7000);
}

// ğŸ”” 25ê°• ì´ìƒ íŒŒê´´ ê¸€ë¡œë²Œ ì´ë²¤íŠ¸ êµ¬ë…
function subscribeGlobalDestroyEvents() {
  if (!globalEventsRef) return;

  let initialized = false;

  globalEventsRef
    .orderByChild("createdAt")
    .limitToLast(1)          // ì œì¼ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ë§Œ
    .on("child_added", (snap) => {
      const v = snap.val() || {};

      // ì²˜ìŒ í•œ ë²ˆ ë“¤ì–´ì˜¬ ë•ŒëŠ” "ê¸°ì¡´ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸"ë¼ì„œ ê·¸ëƒ¥ ê¸°ì¤€ì ìœ¼ë¡œë§Œ ì‚¬ìš©
      if (!initialized) {
        initialized = true;
        return;
      }

      if (v.type !== "destroy25") return;

      const name  = v.userId || "ëˆ„êµ°ê°€";
      const level = v.level  || 0;

      const msg =
        `<span class="level">+${level}ê°•</span> ë„ì „ì— ëª¨ë“  ê²ƒì„ ê±¸ì—ˆë˜ ` +
        `<strong>${name}</strong>ë‹˜ì˜ ë¬´ê¸°ê°€ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤... ` +
        `<span style="color:#ffb74d;">ìœ„ëŒ€í•œ ë„ì „ì— ë¬µë…ì„.</span>`;

      showWorldBanner(msg);
    });
}

  // ê²€ìƒ‰ì°½ ë³€ê²½ ì‹œ í˜¸ì¶œ
function onDuelSearchChange(value) {
  renderDuelList(value);
}

  // âš”ï¸ ê²°íˆ¬ ëŒ€ìƒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function renderDuelList(keyword) {
  const listEl = document.getElementById("duelList");
  const helpEl = document.getElementById("duelHelpText");
  if (!listEl) return;

  keyword = (keyword || "").trim();

  // ìœ ì € ëª©ë¡ì´ ì•„ì§ ì•ˆ ì™”ìœ¼ë©´
  if (!allUsersCache || allUsersCache.length === 0) {
    listEl.innerHTML = `<div style="font-size:13px; color:#aaa;">ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>`;
    if (helpEl) helpEl.style.display = "none";
    return;
  }

  // ìê¸° ìì‹ ì€ ì œì™¸
  let base = allUsersCache.filter(u => u.id !== userId);

  let filtered;
if (!keyword) {
  // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ìƒìœ„ 5ëª…ë§Œ í‘œì‹œ
  filtered = base.slice(0, 5);
  if (helpEl) {
    helpEl.textContent = "ê²€ìƒ‰ì–´ê°€ ì—†ì„ ë•ŒëŠ” ìƒìœ„ 5ëª…ë§Œ í‘œì‹œë©ë‹ˆë‹¤.";
    helpEl.style.display = "block";
  }
} else {
  const lower = keyword.toLowerCase();
  filtered = base.filter(u => u.id.toLowerCase().includes(lower));
  if (helpEl) {
    helpEl.textContent = filtered.length === 0
      ? `"${keyword}" ì™€(ê³¼) ì¼ì¹˜í•˜ëŠ” ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.`
      : `"${keyword}" ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.`;
    helpEl.style.display = "block";
  }
}

  if (filtered.length === 0) {
    listEl.innerHTML = `<div style="font-size:13px; color:#aaa;">í‘œì‹œí•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  listEl.innerHTML = "";

  filtered.forEach(u => {
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.justifyContent = "space-between";
    row.style.padding = "4px 0";
    row.style.borderBottom = "1px solid #333";

    const left = document.createElement("div");
    left.innerHTML = `
      <div style="font-weight:bold;">${formatNicknameWithTitle(u.id, u.equippedTitle || "", u.reach30Count)}</div>

      <div style="font-size:12px; color:#ccc;">
        ${coloredLevel(u.sword)} / ì „íˆ¬ë ¥: ${formatGold(u.power || 0)}
      </div>
    `;

    const btn = document.createElement("span");
    btn.textContent = "ê²°íˆ¬ì‹ ì²­";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.style.color = "#ffffff";
    btn.dataset.targetId = u.id;
    
btn.onclick = function () {
  showDuelConfirmPopup(u.id); // â† isRandomMatch ì œê±°
};

    row.appendChild(left);
    row.appendChild(btn);
    listEl.appendChild(row);
  });
}

// ğŸ– ëª…ì˜ˆì˜ í›ˆì¥ ë³´ìƒ ê³„ì‚°
// mySword : ë‚´ ê°•í™” ìˆ˜ì¹˜
// enemySword : ìƒëŒ€ ê°•í™” ìˆ˜ì¹˜
// isRandomMatch : ëœë¤ë§¤ì¹­ì´ë©´ true
function getHonorMedalReward(mySword, enemySword, isRandomMatch) {
  const diff = enemySword - mySword;  // ìƒëŒ€ - ë‚˜ (ì–‘ìˆ˜ë©´ ìƒìœ„ ìƒëŒ€)

  let base = 0;

  // ğŸ‘‰ ë„ˆë‘ ê°™ì´ ì •ë¦¬í•œ ë³´ì • í…Œì´ë¸”
  // n+5 ì´ìƒ : 40
  // n+4     : 28
  // n+3     : 18
  // n+2     : 10
  // n+1     : 5
  // n       : 3
  // n-1     : 1
  // n-2 ì´í•˜: 0
  if (diff >= 5) {
    base = 40;
  } else if (diff === 4) {
    base = 28;
  } else if (diff === 3) {
    base = 18;
  } else if (diff === 2) {
    base = 10;
  } else if (diff === 1) {
    base = 5;
  } else if (diff === 0) {
    base = 3;
  } else if (diff === -1) {
    base = 1;
  } else {
    base = 0;
  }

  // ëœë¤ë§¤ì¹­ ë³´ë„ˆìŠ¤ +1
  if (isRandomMatch && base > 0) {
    base += 1;
  }

  return base;
}
  
  // ğŸ² ëœë¤ë§¤ì¹­
function handleRandomMatch() {
  if (!userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (!allUsersCache || allUsersCache.length === 0) {
    alert("ì•„ì§ ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    return;
  }

  const candidates = allUsersCache.filter(u => u.id !== userId);
  if (candidates.length === 0) {
    alert("ë§¤ì¹­ ê°€ëŠ¥í•œ ë‹¤ë¥¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

const idx = Math.floor(Math.random() * candidates.length);
const target = candidates[idx];

// âœ… ëœë¤ë§¤ì¹­ì€ í™•ì¸ì°½ ì—†ì´ ë°”ë¡œ ê²°íˆ¬
performDuel(target.id, true);

}

// âš”ï¸ ê²°íˆ¬ì¥ ì—´ê¸°
function openDuelArena() {

  
  // ì§‘ê³„ ì‹œê°„ ì ê¸ˆ
  if (isDuelSettlementTimeKST()) {
    showNpcMessage(
      `
      <div style="font-size:16px; font-weight:bold;">
        ì§€ê¸ˆì€ ê²°íˆ¬ì¥ ì§‘ê³„ ì¤‘ì´ì•¼.
      </div>
      <div style="margin-top:4px; font-size:13px;">
        ë§¤ì£¼ ì›”ìš”ì¼ 00:00 ~ 00:10 ì‚¬ì´ì—ëŠ”<br>
        ê²°íˆ¬ì¥ì— ì…ì¥í•  ìˆ˜ ì—†ì–´.
      </div>
      `,
      "images/npc/duel_carnia.png",
      true,
      "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
    );
    return;
  }

  // ì£¼ê°„ í¬ì¸íŠ¸ ì •ë¦¬
  if (typeof ensureDuelWeek === "function") {
    ensureDuelWeek();
  }

    // ì§€ë‚œì£¼ ë³´ìƒ ì²´í¬
  checkWeeklyDuelReward();
  
 // ê²°íˆ¬ì¥ ì—´ê¸° ë¡œì§
  const overlay = document.getElementById("duelArenaOverlay");
  if (!overlay) return;

  overlay.style.display = "block";

  updateDuelUI();        // ê²°íˆ¬ì¥ ì—´ë¦´ ë•Œ ë‚¨ì€ íšŸìˆ˜ í•œë²ˆ ê°±ì‹ 
  loadDuelArenaRanking();// ë­í‚¹ ë¡œë“œ
}

// âš”ï¸ ê²°íˆ¬ì¥ ë‹«ê¸°
function closeDuelArena() {
  // âœ… ì§€ì •ë§¤ì¹­ íŒ¨ë„ë„ ê°™ì´ ë‹«ê¸°
  const duelPanel = document.getElementById("duelPanel");
  if (duelPanel) duelPanel.style.display = "none";

  const overlay = document.getElementById("duelArenaOverlay");
  if (!overlay) return;
  overlay.style.display = "none";
}

  // ===============================
// ğŸ›ï¸ ëª¨í—˜ê°€ê¸¸ë“œ (ë³´ìŠ¤ì „) UI 
// ===============================

const LEON_LINES = [
  "ê¸¸ë“œë§ˆìŠ¤í„° ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œì´ë‹¤.\nì˜¤ëŠ˜ë„ ì‚´ì•„ ëŒì•„ì˜¬ ê°ì˜¤ëŠ” ë˜ì–´ ìˆë‚˜?",
  "í† ë²Œì€ ëª…ì˜ˆê°€ ì•„ë‹ˆë¼ 'ì±…ì„'ì´ë‹¤.\nâ€¦ê·¸ëŸ¬ë‹ˆê¹Œ, ëŒ€ì¶© ë¤ë¹„ì§€ ë§ˆë¼.",
  "ì¹´ë¥´ë‹ˆì•„ ë‹˜ì˜ íŒë‹¨ì€ ëŠ˜ ì •í™•í–ˆë‹¤.\në‚˜ë„â€¦ ì–¸ì  ê°„ ê·¸ ê²½ì§€ì— ë‹¿ì•„ì•¼ì§€.",
  "ì„¸ë ˆë‚˜â€¦ ì•„ë‹ˆ, ì—ë¸ë¦° ì–‘ì€â€¦\nì•„, ì•„ë‹ˆë‹¤. ì•„ë¬´ê²ƒë„ ì•„ë‹ˆë‹¤.",
  "ìš°ë¦¬ ë ˆì˜¨í•˜ë¥´íŠ¸ ê°€ë¬¸ì€ \n ê³¼ê±°, ì™•ì¡±ì´ë¼ê³  í•˜ë”êµ°.",
  "â€¦ë„ˆë¬´ ì˜¤ë˜ ë²„í‹°ë©´, ëª¨ë‘ê°€ ë‹¤ì¹œë‹¤.\nê²°ë‹¨ì€ ë¹ ë¥¼ìˆ˜ë¡ ì¢‹ë‹¤.",
  "ìš°ë¦¬ëŠ” ë ˆì˜¨í•˜ë¥´íŠ¸ ê°€ë¬¸ì€ \nê±´êµ­ì™•ê³¼ ë ˆì˜¤ë‚˜ë¥´íŠ¸ì˜ ì˜ì§€ë¥¼ ë”°ë¥¸ë‹¤."
  
];

function getHuntRemainTextForToday(){
  const today = getTodayDateString(); // ì´ë¯¸ update()ì—ì„œë„ ì“°ëŠ” í•¨ìˆ˜
  let used = 0;
  if (lastHuntDate === today) used = Number(huntCountToday || 0);
  const remain = Math.max(0, 20 - used);
  return `ì˜¤ëŠ˜ ë‚¨ì€ ì‚¬ëƒ¥íšŸìˆ˜: ${remain} / 20`;
}

function setLeonLine(){
  const el = document.getElementById("adventureGuildNpcLine");
  if (!el) return;
  const line = LEON_LINES[Math.floor(Math.random() * LEON_LINES.length)];
  el.textContent = line;
}

function isMobileLike(){
  // âœ… viewport ì„¤ì •/innerWidthê°€ ì• ë§¤í•´ë„, í„°ì¹˜ ê¸°ê¸°ë©´ ëª¨ë°”ì¼ë¡œ ê°„ì£¼
  return (navigator.maxTouchPoints && navigator.maxTouchPoints > 1) || /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function applyAdventureGuildPanelSizing(){
  const panel = document.getElementById("adventureGuildPanel");
  if (!panel) return;

  // ê¸°ë³¸ê°’(PC)ë¡œ ë˜ëŒë¦´ ê°’
  if (!isMobileLike()){
    panel.style.height = "82%";
    panel.style.maxHeight = "86vh";
    return;
  }

  // âœ… ëª¨ë°”ì¼ì—ì„œëŠ” ê²°íˆ¬ì¥ ëŠë‚Œìœ¼ë¡œ â€œì„¸ë¡œ ê¸¸ì´ ê³ ì •â€
  // ìˆ«ìëŠ” ì·¨í–¥ì¸ë°, ì¼ë‹¨ í™• ì¤„ì´ë ¤ë©´ ì´ ì •ë„ê°€ ì²´ê° í¼
  panel.style.height = "62vh";
  panel.style.maxHeight = "62vh";
}

  // âœ… ëª¨í—˜ê°€ê¸¸ë“œ ì‹ ê·œ ë³´ìŠ¤ì „ 'í™•ì¸ ì—¬ë¶€' (ë¡œì»¬ ì €ì¥)
const SEEN_BOSS_RUNS_KEY = "seenBossRuns_v1";

function loadSeenBossRuns(){
  try { return JSON.parse(localStorage.getItem(SEEN_BOSS_RUNS_KEY) || "{}") || {}; }
  catch(e){ return {}; }
}

function saveSeenBossRuns(map){
  try { localStorage.setItem(SEEN_BOSS_RUNS_KEY, JSON.stringify(map || {})); } catch(e){}
}

function setAdventureGuildAlertVisible(visible){
  const b = document.getElementById("adventureGuildAlertBadge");
  if (!b) return;
  b.style.display = visible ? "flex" : "none";
}

// âœ… í˜„ì¬ ì—´ë ¤ìˆëŠ”(ì°¸ì—¬ ê°€ëŠ¥í•œ) ë³´ìŠ¤ì „ ì¤‘ 'ë‚´ê°€ ì•„ì§ í™•ì¸ ì•ˆ í•œ ê²ƒ'ì´ ìˆìœ¼ë©´ ! í‘œì‹œ
function refreshAdventureGuildAlert(){
  const seen = loadSeenBossRuns();
  let hasNew = false;

  Object.entries(bossRunsActiveCache || {}).some(([bossId, run]) => {
    if (!run) return false;

    const st = String(run.status || "");
    // ëª¨í—˜ê°€ê¸¸ë“œ ë¦¬ìŠ¤íŠ¸ì— ëœ¨ëŠ” ìƒíƒœë§Œ ëŒ€ìƒìœ¼ë¡œ (í˜„ì¬ ë Œë”ê°€ active ê¸°ì¤€ì´ë©´ activeë§Œ ë³´ë©´ ë¨)
    if (st !== "active") return false;

    // ë‚´ê°€ ì´ë¯¸ ë©¤ë²„ì¸ í† ë²Œì€ ì‹ ê·œì•Œë¦¼ ëŒ€ìƒ ì œì™¸(ì›í•˜ë©´ í¬í•¨í•´ë„ ë¨)
    const isMember = !!(run.members && run.members[userId]);
    if (isMember) return false;

    const seenKey = `${bossId}:${Number(run.createdAt || 0)}`;
    if (!seen[seenKey]) { hasNew = true; return true; }
    return false;
  });

  setAdventureGuildAlertVisible(hasNew);
}

// âœ… ëª¨í—˜ê°€ê¸¸ë“œ ì˜¤ë²„ë ˆì´ë¥¼ "ë‹«ëŠ” ìˆœê°„" = í™•ì¸ ì™„ë£Œ ì²˜ë¦¬
function markAllBossRunsSeenNow(){
  const seen = loadSeenBossRuns();

  Object.entries(bossRunsActiveCache || {}).forEach(([bossId, run]) => {
    if (!run) return;
    const st = String(run.status || "");
    if (st !== "active") return;

    // ë‚´ê°€ ë©¤ë²„ì¸ ê±´ êµ³ì´ ì €ì¥ ì•ˆ í•´ë„ ë˜ì§€ë§Œ, ì €ì¥í•´ë„ ë¬¸ì œ ì—†ìŒ
    const seenKey = `${bossId}:${Number(run.createdAt || 0)}`;
    seen[seenKey] = true;
  });

  saveSeenBossRuns(seen);
  refreshAdventureGuildAlert();
}
  
function openAdventureGuild(){
  const ov = document.getElementById("adventureGuildOverlay");
  const huntEl = document.getElementById("adventureGuildHuntRemain");
  if (!ov) return;

  if (huntEl) huntEl.textContent = getHuntRemainTextForToday();
  setLeonLine();

    applyAdventureGuildPanelSizing(); // âœ… ëª¨ë°”ì¼ì—ì„œ ëª¨í—˜ê°€ê¸¸ë“œ íŒ¨ë„ ë†’ì´ ê³ ì •

  ov.style.display = "flex";
    ensureBossRunsSubscription();
  renderAdventureGuildBossRuns();
}

function closeAdventureGuild(){
  const ov = document.getElementById("adventureGuildOverlay");
  if (ov) ov.style.display = "none";

  // âœ… ì˜¤ë²„ë ˆì´ë¥¼ ë‹«ëŠ” ìˆœê°„ = í™•ì¸ ì™„ë£Œ ì²˜ë¦¬ â†’ ! ì œê±°
  markAllBossRunsSeenNow();
}

// âœ… ESCë¡œ ëª¨í—˜ê°€ê¸¸ë“œ ë‹«ê¸° (í•œ ë²ˆë§Œ ë°”ì¸ë”©)
document.addEventListener("keydown", (e) => {
  if (e.key !== "Escape") return;
  const ov = document.getElementById("adventureGuildOverlay");
  if (!ov) return;
  if (ov.style.display !== "none") {
    closeAdventureGuild();
  }
});

  window.addEventListener("resize", () => {
  const ov = document.getElementById("adventureGuildOverlay");
  if (ov && ov.style.display !== "none") applyAdventureGuildPanelSizing();
});
window.addEventListener("orientationchange", () => {
  const ov = document.getElementById("adventureGuildOverlay");
  if (ov && ov.style.display !== "none") applyAdventureGuildPanelSizing();
});

function openAdventureGuildHelp(){
  const msg =
`[ ëª¨í—˜ê°€ ê¸¸ë“œ : ë³´ìŠ¤ì „ ì•ˆë‚´ ]
<br><br>
[ ë³´ìŠ¤ì „ ì‹ ì²­í•˜ê¸° ]<br>
ë³´ìŠ¤ì „ ì‹ ì²­í•˜ê¸°ë¥¼ ì„ íƒí•˜ë©´, ìë„¤ê°€ 'í† ë²ŒëŒ€ ëŒ€ì¥'ì´ ë˜ì–´ ë³´ìŠ¤ì „ì„ ì‹œì‘í•  ìˆ˜ ìˆì§€.<br>
ì•½í•œ ìëŠ” ëŒ€ì¥ì´ ë  ìˆ˜ ì—†ìœ¼ë©°, ë§ì€ ì¬í™”ê°€ í•„ìš”í•˜ë‹ˆ ì£¼ì˜í•˜ê²Œ.
<br><br>
[ ì°¸ì—¬í•˜ê¸° ]<br>
ì°¸ì—¬í•˜ê¸°ë¥¼ ëˆ„ë¥´ë©´ ì´ë¯¸ ìƒì„±ëœ ë³´ìŠ¤ì „ì— 'í† ë²ŒëŒ€ì›'ìœ¼ë¡œ ì°¸ì—¬í•  ìˆ˜ ìˆì–´.<br>
ì°¸ì—¬ ì œí•œì€ ì—†ì§€ë§Œ, ë§ì€ ê¸°ì—¬ë¥¼ í• ìˆ˜ë¡ ë³´ìƒì´ ì»¤ì§€ë‹ˆ í•œ ë²ˆ ë„ì „í•´ ë³´ê²Œ.
<br><br>
[ ê°•í™”ë³„ ë³´ì • ]<br>
ë³´ìŠ¤ë§ˆë‹¤ ëŠ¥ë ¥ì¹˜ê°€ ë‹¤ë¥´ê³ , ë„ˆë¬´ ê°•í•œ ìëŠ” ë³´ìŠ¤ì— ë”°ë¼ ê°•í™”ë³„ ë³´ì •ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë„¤.<br>
ì´ ì ì„ ìœ ë…í•˜ê³ , ë™ë£Œë“¤ê³¼ í•¨ê»˜ ì „ëµì„ ì„¸ìš°ê²Œë‚˜.`;


  // ê²°íˆ¬ì¥ ë„ì›€ë§ì²˜ëŸ¼ NPC íŒì—… ë°©ì‹ ì‚¬ìš©
  showNpcMessage(
    msg,
    LEON_IMG.idle,
    true
  );
}

// âœ… (ë³´ìŠ¤ ì¶”ê°€ í™•ì¥ìš©) ë³´ìŠ¤ ì •ì˜ í…Œì´ë¸”

  var SILVANA_LINES = [
  "â€¦ëŠªì˜ ìˆ¨ê²°ì´ ë„¤ ë°œëª©ì„ ì¡ì„ ê²ƒì´ë‹¤.",
  "ì¸ê°„ì€ ëª¨ë‘ ê°™ì€ ëƒ„ìƒˆê°€ ë‚œë‹¤. ì©ì€ í”¼ì˜ ëƒ„ìƒˆ.",
  "í•œ ê±¸ìŒë§Œ ë”. â€¦ê·¸ ìˆœê°„ì´ ë„¤ ë§ˆì§€ë§‰ì´ ëœë‹¤.",
  "ìˆ²ì€ ë‚´ í¸ì´ë‹¤. ë„ˆí¬ì˜ ë¹„ëª…ì¡°ì°¨ ì‚¼ì¼œì£¼ì§€."
];
  
const BOSS_DEFS = [
  {
    id: "swamp_elf_queen",
    mapName: "ëŠªì—˜í”„ì˜ ìˆ²",
    bossTitle: "í•˜ì´ì—˜í”„í€¸",
    bossName: "ì‹¤ë°”ë‚˜ ë¦´ë¦¬ì•„ë„¤",
    desc: "",
    minSword: 24,
    applyCostGold: 10000000000,
    durationHours: 72,
    maxHp: 540000000000,            // 5400ì–µ
    bgImg: "images/bossmaps/swamp_elf_forest.png",
    imgIdle: "images/bosses/silvana_idle.png",
    imgDead: "images/bosses/silvana_down.png",
    lines: SILVANA_LINES,
    deadLine: SILVANA_DEAD_LINE,
    deadSubLine: SILVANA_DEAD_SUBLINE,
    failLine: SILVANA_FAIL_LINE,
    logSuccess: "ì”í˜¹í•œ ì‚¬ëƒ¥ê¾¼ì˜ ëª°ë½ì— í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ì´ í™˜í˜¸í•©ë‹ˆë‹¤!",
    logFail: "í¼ê·¸ë€íŠ¸ì˜ ëŒ€ì¥ê°„ì´ ì¢Œì ˆí•©ë‹ˆë‹¤â€¦"
  },

  {
    id: "frost_queen",
    mapName: "ì„œë¦¬ì—¬ì™•ì˜ ì–¼ìŒë™êµ´",
    bossTitle: "ì„œë¦¬ì—¬ì™•",
    bossName: "ì•„ë¥´ì…€ë¦¬ì•„",
    desc: "",
    minSword: 24,
    applyCostGold: 30000000000,      // 300ì–µ
    durationHours: 72,

    maxHp: 890000000000,            // 8900ì–µ

    bgImg: "images/bossmaps/ice_cave.png",  // âœ… ë„ˆê°€ í™•ì •í•œ ê²½ë¡œ

    // âœ… ë³´ìŠ¤ ìŠ¤í”„ë¼ì´íŠ¸(ì‹¤ë°”ë‚˜ êµ¬ì¡° ë™ì¼)
    imgIdle: "images/bosses/arshelia_idle.png",
    imgDead: "images/bosses/arshelia_down.png",
    // (2) ì„œë¦¬ì—¬ì™• ì•„ë¥´ì…€ë¦¬ì•„ ì˜¤ë¸Œì íŠ¸ ë‚´ë¶€, imgDead ì•„ë˜ì— ì¶”ê°€
    // âœ… ë³´ìŠ¤ ëŒ€ì‚¬/ë¡œê·¸(ì•„ë¥´ì…€ë¦¬ì•„ ì „ìš©)
    lines: [
      "ë‚˜ì˜ ë¶„ë…¸ëŠ” í•œì´ ë˜ì–´ ëª¨ë‘ë¥¼ ì–¼ë ¸ì§€.",
      "ìˆ¨ê²°ì¡°ì°¨ í—ˆë½í•˜ì§€ ì•Šê² ë‹¤.",
      "ì˜í˜¼ê¹Œì§€ ì–¼ì–´ë¶™ëŠ” í•œê¸°ë¥¼ ë³´ì•„ë¼.",
      "ë„ˆí¬ì˜ ì—´ì€ ì—¬ê¸°ì„œ ëë‚œë‹¤."
    ],
    deadLine: "â€¦ë‚˜ì˜ ì„œë¦¬ì–¹ì€ í•œë„, ì´ í•œê¸°ì²˜ëŸ¼â€¦ ëì´ ë‚¬ìœ¼ë©´â€¦",
    deadSubLine: "-ì•„ë¥´ì¹´ë¦¬ì•„ì¡± ë§ˆì§€ë§‰ ìˆ¨ê²° ì¢…ë£Œ-",
    failLine: "ë„ë§ì³ë¼. ë‹¤ìŒì—” ìˆ¨ì„ ê³³ì¡°ì°¨ ì—†ì„ ê²ƒì´ë‹¤.",

    // âœ… í† ë²Œ ê²°ê³¼ ë©”ì¸ë¡œê·¸ì— ë¶™ì¼ ë¬¸ì¥(ë³´ìŠ¤ë³„)
    logSuccess: "ì„œë¦¬ì—¬ì™•ì˜ ëƒ‰ê¸°ê°€ ë¶€ì„œì§€ë©° ë™êµ´ì— ë´„ì˜ ìˆ¨ê²°ì´ ìŠ¤ë©°ë“­ë‹ˆë‹¤!",
    logFail: "ëì—†ëŠ” ëƒ‰ê¸°ê°€ í† ë²ŒëŒ€ë¥¼ ì‚¼ì¼°ìŠµë‹ˆë‹¤â€¦ ë™êµ´ì€ ë‹¤ì‹œ ì¹¨ë¬µí•©ë‹ˆë‹¤."
  }
  ];

// âœ… ë ˆì˜¨í•˜ë¥´íŠ¸ 6ì¢…(íŒŒì¼ëª…ì€ ì—¬ê¸°ë§Œ ìˆ˜ì •í•˜ë©´ ë¨)
const LEON_IMG = {
  idle:   "images/npc/leonhardt_idle.png",    // ê¸°ë³¸
  focus:  "images/npc/leonhardt_focus.png",   // ì§‘ì¤‘
  apply:  "images/npc/leonhardt_apply.png",   // ë³´ìŠ¤ ì‹ ì²­ ì•ˆë‚´
  win:    "images/npc/leonhardt_win.png",     // ë³´ìŠ¤ ìŠ¹ë¦¬
  lose:   "images/npc/leonhardt_lose.png",    // ë³´ìŠ¤ ì‹¤íŒ¨
  reward: "images/npc/leonhardt_reward.png"   // ë³´ìƒ ìˆ˜ë ¹
};

function formatHMS(ms) {
  ms = Math.max(0, Number(ms || 0));
  const total = Math.floor(ms / 1000);
  const h = String(Math.floor(total / 3600)).padStart(2, "0");
  const m = String(Math.floor((total % 3600) / 60)).padStart(2, "0");
  const s = String(total % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

// âœ… ë³´ìŠ¤ì „/ë¡œê·¸ìš© ë‹‰ë„¤ì„ ì•ˆì „ getter (nickname ë³€ìˆ˜ê°€ ì—†ì„ ë•Œë„ ì•ˆì „)
function getNickSafe() {
  // ê¸°ì¡´ì— nickname ë³€ìˆ˜ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ userIdë¡œ ëŒ€ì²´
  try {
    if (typeof nickname !== "undefined" && nickname) return String(nickname);
  } catch (e) {}
  return String(userId || "???");
}
  
// ===============================
// ğŸ² ë³´ìŠ¤ì „: Firebase ActiveRun (v1)
// ===============================
const BOSS_RUNS_ACTIVE_REF = db.ref("bossRunsActive");
const BOSS_COOLDOWN_REF    = db.ref("bossCooldown");

// ë©”ëª¨ë¦¬ ìºì‹œ(ë Œë”ìš©)
let bossRunsActiveCache = {};   // { bossId: runObj }
let bossCooldownCache = {};     // { bossId: { nextAt: ms } }
var bossRunsUnsubscribed = true;

  // âœ… ê³„ì • ì „í™˜/ì¬ë¡œê·¸ì¸ ì‹œ ë³´ìŠ¤ì „ ë¦¬ìŠ¤ë„ˆë¥¼ ê°•ì œë¡œ ë‹¤ì‹œ ë¶™ì´ê¸° ìœ„í•œ ë¦¬ì…‹
function resetBossRunsSubscription(){
  try { BOSS_RUNS_ACTIVE_REF.off(); } catch(e){}
  try { BOSS_COOLDOWN_REF.off(); } catch(e){}

  bossRunsUnsubscribed = true;
  bossRunsActiveCache = {};
  bossCooldownCache = {};

  try{
    if (bossRunWatchdogTimer) {
      clearInterval(bossRunWatchdogTimer);
      bossRunWatchdogTimer = null;
    }
  }catch(e){}
}

let bossRunWatchdogTimer = null;

function updateBossBattleBtn(){
  if (activeBossId && bossRunsUnsubscribed !== false) {
  ensureBossRunsSubscription();
}
  const btn = document.getElementById("bossBattleBtn");
  if (!btn) return;

  const bossId = String(activeBossId || "");
  if (!bossId) { btn.style.display = "none"; return; }

    const run = (bossRunsActiveCache || {})[bossId];
  if (!run) { btn.style.display = "none"; return; }

  const st = String(run.status || "");
  const mem = run.members && run.members[userId];
  if (!mem) { btn.style.display = "none"; return; }

  // âœ… ì„±ê³µ(cleared)ì¸ë° ì´ë¯¸ ë³´ìƒ ìˆ˜ë ¹í–ˆìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¹€
  const alreadyClaimed = !!(run.claimed && run.claimed[userId]);

  // âœ… ì§„í–‰ì¤‘/ì‹¤íŒ¨/ì„±ê³µ(ë¯¸ìˆ˜ë ¹) ìƒíƒœì—ì„œëŠ” ë²„íŠ¼ ìœ ì§€
  if (st === "active" || st === "failed" || (st === "cleared" && !alreadyClaimed)) {
    btn.style.display = "inline-block";
  } else {
    btn.style.display = "none";
  }
}

  // âœ… (ìŠ¤í…3-3) ë³´ìŠ¤ì „ ì¢…ë£Œ 24ì‹œê°„ ì „ ì§€ì›ìš”ì²­(ë©”ì¸ ë¡œê·¸ 1íšŒ + ì „ìš© ë¡œê·¸ 1íšŒ)
function maybeWarnBossRun24h(bossId, run, mapName, bossTitle, bossName){
  const remainMs = Math.max(0, Number(run?.endsAt || 0) - Date.now());
  const warnMs = 24 * 60 * 60 * 1000;

  if (Number(run?.endsAt || 0) <= 0) return;
  if (String(run?.status || "") !== "active") return;
  if (remainMs <= 0 || remainMs > warnMs) return;
  if (run?.warn24hAnnounced) return;

  const runRefWarn = db.ref(`bossRunsActive/${bossId}`);
  runRefWarn.transaction((cur) => {
    if (!cur || String(cur.status || "") !== "active") return;
    const ends = Number(cur.endsAt || 0);
    if (!ends) return;

    const left = ends - Date.now();
    if (left <= 0 || left > warnMs) return;      // ì•„ì§ 24h êµ¬ê°„ ì•„ë‹ˆë©´ íŒ¨ìŠ¤
    if (cur.warn24hAnnounced) return;            // ì´ë¯¸ ê²½ê³ í–ˆìœ¼ë©´ íŒ¨ìŠ¤

    cur.warn24hAnnounced = true;
    cur.warn24hAnnouncedAt = Date.now();
    return cur;
  }, (err, committed) => {
    if (err || !committed) return;

    const leader = run?.leaderNick || "ëˆ„êµ°ê°€";
    const place = `${mapName} Â· ${bossTitle}${bossName ? " " + bossName : ""}`;

    // âœ… ë©”ì¸ ì‹¤ì‹œê°„ ë¡œê·¸(ë„ë°° ë°©ì§€: transactionìœ¼ë¡œ 1íšŒ ë³´ì¥)
    const msg = `${leader}ë‹˜ì˜ í† ë²ŒëŒ€(${place})ê°€ ìœ„í—˜ì— ì²˜í•´ìˆìŠµë‹ˆë‹¤. ì§€ì›ì´ í•„ìš”í•©ë‹ˆë‹¤! (ë‚¨ì€ì‹œê°„ 24ì‹œê°„)`;
    writeLog(msg, false);

    // âœ… ë³´ìŠ¤ì „ ì „ìš© ë¡œê·¸ë„ 1íšŒ(ìˆìœ¼ë©´)
    if (typeof writeBossBattleLog === "function") {
      writeBossBattleLog(bossId, "âš ï¸ í† ë²Œ ì¢…ë£Œê¹Œì§€ 24ì‹œê°„ ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì§€ì›ì´ í•„ìš”í•©ë‹ˆë‹¤!");
    }
  });
}

function startBossRunWatchdog(){
  if (bossRunWatchdogTimer) return;

  bossRunWatchdogTimer = setInterval(() => {
    const entries = Object.entries(bossRunsActiveCache || {})
      .filter(([_, run]) => run && String(run.status || "") === "active");

    entries.forEach(([bossId, run]) => {
      const def = BOSS_DEFS.find(b => b.id === bossId);
      const mapName   = def ? def.mapName   : (run.mapName || "ì•Œ ìˆ˜ ì—†ëŠ” ì§€ì—­");
      const bossTitle = def ? def.bossTitle : (run.bossTitle || "ë³´ìŠ¤");
      const bossName  = def ? def.bossName  : (run.bossName || "");

      maybeWarnBossRun24h(bossId, run, mapName, bossTitle, bossName);
            // âœ… (í•µì‹¬) ì œí•œì‹œê°„ ë§Œë£Œ ì‹œ: ì‹¤íŒ¨ë¡œ í™•ì • + ê²°ê³¼ë¡œê·¸/ì¿¨ë‹¤ìš´ë„ ë³´ì¥
      if (Number(run?.endsAt || 0) > 0 && Date.now() >= Number(run.endsAt || 0) && String(run.status || "") === "active") {
        const runRef = db.ref(`bossRunsActive/${bossId}`);
        runRef.transaction((cur) => {
          if (!cur || String(cur.status || "") !== "active") return;
          if (Date.now() < Number(cur.endsAt || 0)) return;
          cur.status = "failed";
          cur.failedAt = Date.now();
          return cur;
        });
      }

      // âœ… (ì¶”ê°€) ì¢…ë£Œ ìƒíƒœ(ì„±ê³µ/ì‹¤íŒ¨)ë©´: ì¿¨ë‹¤ìš´/ë©”ì¸ë¡œê·¸ 1íšŒ ë³´ì¥ (ë³´ìŠ¤ì „ í™”ë©´ ì•ˆ ì—´ì–´ë„ ë™ì‘)
      if (String(run.status || "") === "cleared" || String(run.status || "") === "failed") {
        const runRef2 = db.ref(`bossRunsActive/${bossId}`);

        // (1) ì¿¨ë‹¤ìš´ 24h 1íšŒ ê³ ì •
        runRef2.transaction((cur) => {
          if (!cur) return;
          const s = String(cur.status || "");
          if (s !== "cleared" && s !== "failed") return;
          if (cur.cooldownFixed) return;
          cur.cooldownFixed = true;
          cur.cooldownFixedAt = Date.now();
          return cur;
        }, (err, committed) => {
          if (err || !committed) return;
          const nextAt = Date.now() + 24 * 60 * 60 * 1000;
          db.ref(`bossCooldown/${bossId}`).set({ nextAt });
        });

        // (2) ê²°ê³¼ ë©”ì¸ë¡œê·¸ 1íšŒ ê³ ì •
        runRef2.transaction((cur) => {
          if (!cur) return;
          const s = String(cur.status || "");
          if (s !== "cleared" && s !== "failed") return;
          if (cur.resultAnnounced) return;
          cur.resultAnnounced = true;
          cur.resultAnnouncedAt = Date.now();
          return cur;
        }, (err, committed) => {
          if (err || !committed) return;

          const def2 = (typeof BOSS_DEFS !== "undefined")
            ? (BOSS_DEFS.find(b => b.id === bossId) || null)
            : null;

          const mapName2   = def2 ? def2.mapName   : (run.mapName || "ì–´ë”˜ê°€");
          const bossTitle2 = def2 ? def2.bossTitle : (run.bossTitle || "ë³´ìŠ¤");
          const bossName2  = def2 ? def2.bossName  : (run.bossName || "");
          const title2 = `${mapName2}ì˜ ì£¼ì¸ ${bossTitle2}${bossName2 ? " " + bossName2 : ""}`;
          const leader2 = run.leaderNick || "ëˆ„êµ°ê°€";

          const successText = def2?.logSuccess || "";
const failText    = def2?.logFail || "";
const st2 = String(run.status || ""); // âœ… ì—¬ê¸°ì„œ íŒì •
if (st2 === "cleared") {
  writeLog(
    `${leader2}ë‹˜ì˜ í† ë²ŒëŒ€ê°€ ${title2}ë¥¼ í† ë²Œí•˜ëŠ”ë° ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.${successText ? " " + successText : ""}`,
    false,
    { tone: "boss_success" }
  );
} else {
  writeLog(
    `${leader2}ë‹˜ì˜ í† ë²ŒëŒ€ê°€ ${title2} í† ë²Œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.${failText ? " " + failText : ""}`,
    false,
    { tone: "boss_fail" }
  );
}
        });
      }
    });
  }, 60 * 1000); // 1ë¶„ë§ˆë‹¤ ì²´í¬(ê°€ë³ê²Œ)
}
  
// âœ… ëª¨í—˜ê°€ê¸¸ë“œ ì¤‘ì•™ "í˜„ì¬ ì§„í–‰ì¤‘ì¸ ë³´ìŠ¤ì „" ë Œë”
function renderAdventureGuildBossRuns() {
  const listEl = document.getElementById("adventureGuildRaidList");
  if (!listEl) return;

  const entries = Object.entries(bossRunsActiveCache || {})
    .filter(([_, run]) => run && run.status === "active")
    // ìµœì‹ ìˆœ(ìƒì„±ì‹œê° desc)
    .sort((a, b) => Number(b[1].createdAt || 0) - Number(a[1].createdAt || 0));

  if (entries.length === 0) {
    listEl.innerHTML = `
      <div style="padding:10px; font-size:12px; color:#aaa; text-align:center;">
        í˜„ì¬ ì§„í–‰ì¤‘ì¸ ë³´ìŠ¤ì „ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    `;
    return;
  }

  let html = "";
  entries.forEach(([bossId, run]) => {
    const def = BOSS_DEFS.find(b => b.id === bossId);
    const mapName   = def ? def.mapName : (run.mapName || "ì•Œ ìˆ˜ ì—†ëŠ” ì§€ì—­");
    const bossTitle = def ? def.bossTitle : (run.bossTitle || "ë³´ìŠ¤");
    const bossName  = def ? def.bossName : (run.bossName || "");
    const leaderNick = run.leaderNick || "ì•Œ ìˆ˜ ì—†ìŒ";
    const seen = loadSeenBossRuns();
    const seenKey = `${bossId}:${Number(run.createdAt || 0)}`;
    const isNew = !seen[seenKey];
    const newMark = isNew ? `<span class="guild-alert-inline">!</span>` : ``;

    const remainMs = Math.max(0, Number(run.endsAt || 0) - Date.now());

    maybeWarnBossRun24h(bossId, run, mapName, bossTitle, bossName);
    
      // âœ… ì œí•œì‹œê°„ ë§Œë£Œ ì‹œ: ì‹¤íŒ¨ë¡œ í™•ì •(í•œ ë²ˆë§Œ)
if (Number(run.endsAt || 0) > 0 && Date.now() >= Number(run.endsAt || 0) && String(run.status || "") === "active") {
  const runRef = db.ref(`bossRunsActive/${bossId}`); // âœ… í˜„ì¬ ë Œë”ì¤‘ì¸ bossId ì‚¬ìš©
  runRef.transaction((cur) => {
    if (!cur || String(cur.status || "") !== "active") return;
    if (Date.now() < Number(cur.endsAt || 0)) return;

    cur.status = "failed";
    cur.failedAt = Date.now();
    return cur;
  });
}

    const remainTxt = formatHMS(remainMs);

    html += `
      <div style="border:1px solid #444; border-radius:10px; padding:10px; margin-bottom:8px; background:rgba(0,0,0,0.35);">
        <div style="font-weight:bold; margin-bottom:4px;">
  ${newMark}${mapName} Â· ${bossTitle} <span style="color:#ddd;">${bossName}</span>
</div>
        <div style="font-size:12px; color:#aaa; margin-bottom:8px;">
          ëŒ€ì¥: <b style="color:#ddd;">${leaderNick}</b> Â· ë‚¨ì€ì‹œê°„: <b style="color:#ffd54f;">${remainTxt}</b>
        </div>
        <button onclick="joinBossRunConfirm('${bossId}')" style="width:100%; padding:8px 10px; font-size:14px; border-radius:8px;">
          ğŸ‘¥ ì°¸ì—¬í•˜ê¸°
        </button>
      </div>
    `;
  });

  listEl.innerHTML = html;
}

// âœ… ëª¨í—˜ê°€ê¸¸ë“œ ì—´ë¦´ ë•Œ í•œë²ˆë§Œ êµ¬ë… ì‹œì‘
function ensureBossRunsSubscription() {
  if (bossRunsUnsubscribed === false) return;

  bossRunsUnsubscribed = false;
BOSS_RUNS_ACTIVE_REF.on("value", (snap) => {
  bossRunsActiveCache = snap.val() || {};
  startBossRunWatchdog();

 refreshAdventureGuildAlert(); // âœ… ì‹ ê·œ ë³´ìŠ¤ì „ ìˆìœ¼ë©´ ë©”ì¸ ë²„íŠ¼ì— ! í‘œì‹œ

  // âœ… (í•µì‹¬) ìƒˆë¡œê³ ì¹¨/ì¬ì ‘ì† ì‹œ: ë‚´ê°€ ì´ë¯¸ ì°¸ì—¬ì¤‘ì¸ í† ë²Œì´ ìˆìœ¼ë©´ activeBossId ë³µêµ¬
  const myUid = String(userId || "");
  const curId = String(activeBossId || "");

  // 1) í˜„ì¬ activeBossIdê°€ ìˆëŠ”ë°, ê·¸ í† ë²Œì´ ì—†ê±°ë‚˜/ì¢…ë£Œëê±°ë‚˜/ë‚´ ë©¤ë²„ ê¸°ë¡ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
  if (curId) {
    const curRun = (bossRunsActiveCache || {})[curId];
    const st = String(curRun && curRun.status ? curRun.status : "");
const isMember = !!(curRun && curRun.members && curRun.members[myUid]);

// âœ… ì„±ê³µì¸ë° ì´ë¯¸ ë³´ìƒ ìˆ˜ë ¹í•œ ìƒíƒœë©´ ë³µêµ¬ ëŒ€ìƒ ì•„ë‹˜
const alreadyClaimed = !!(curRun && curRun.claimed && curRun.claimed[myUid]);

const canKeep =
  isMember && (
    st === "active" ||
    st === "failed" ||
    (st === "cleared" && !alreadyClaimed)
  );

if (!canKeep) activeBossId = "";
    if (!isMember) activeBossId = "";
  }

  // 2) activeBossIdê°€ ë¹„ì–´ìˆìœ¼ë©´, ì „ì²´ activeRun ì¤‘ "ë‚´ê°€ ë©¤ë²„ì¸ run"ì„ ì°¾ì•„ ë³µêµ¬
  if (!activeBossId) {
    let found = "";
    Object.entries(bossRunsActiveCache || {}).some(([bid, run]) => {
  if (run && run.members && run.members[myUid]) {
    const st2 = String(run.status || "");
    const claimed2 = !!(run.claimed && run.claimed[myUid]);

    if (st2 === "active" || st2 === "failed" || (st2 === "cleared" && !claimed2)) {
      found = String(bid);
      return true;
    }
  }
  return false;
});

    if (found) {
      activeBossId = found;
      save(); // ë‹¤ìŒ ì ‘ì†ì—ë„ ìœ ì§€
    }
  }

  renderAdventureGuildBossRuns();
});
  
    BOSS_COOLDOWN_REF.on("value", (snap) => {
    bossCooldownCache = snap.val() || {};
    // ê¸¸ë“œê°€ ì—´ë ¤ìˆìœ¼ë©´ ì‹ ì²­ ë¦¬ìŠ¤íŠ¸ ì‹œê°„ì—ë„ ì˜í–¥ì„ ì£¼ë¯€ë¡œ ë Œë” ë°˜ì˜
    renderAdventureGuildBossRuns();
  });


  // ë‚¨ì€ì‹œê°„ ì¹´ìš´íŠ¸ë‹¤ìš´ UI ê°±ì‹ (1ì´ˆ)
  setInterval(() => {
    const ov = document.getElementById("adventureGuildOverlay");
    if (!ov || ov.style.display === "none") return;
    renderAdventureGuildBossRuns();
  }, 1000);
}

// âœ… ë³´ìŠ¤ ìŠ¤í”„ë¼ì´íŠ¸(ìƒíƒœë³„) - ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨
const BOSS_SPRITES = {
  swamp_elf_queen: {
    alive:  "images/bosses/silvana_idle.png",  // ì§„í–‰ì¤‘
    dead:   "images/bosses/silvana_down.png",  // í† ë²Œ ì„±ê³µ(ì‚¬ë§)
    failed: "images/bosses/silvana_idle.png"   // í† ë²Œ ì‹¤íŒ¨(ì›í•˜ë©´ ì „ìš© ì´ë¯¸ì§€ë¡œ êµì²´)
  },

  frost_queen: {
    alive:  "images/bosses/arshelia_idle.png",
    dead:   "images/bosses/arshelia_down.png",
    failed: "images/bosses/arshelia_idle.png"
  }
};

// âœ… ìƒíƒœì— ë§ëŠ” ë³´ìŠ¤ ì´ë¯¸ì§€ src ë°˜í™˜
function getBossSpriteSrc(bossId, status){
  const sp = (BOSS_SPRITES || {})[String(bossId || "")] || {};
  const st = String(status || "active");
  if (st === "cleared") return sp.dead || sp.alive || "";
  if (st === "failed")  return sp.failed || sp.alive || "";
  return sp.alive || "";
}
  
var SILVANA_DEAD_LINE = "â€¦ì•„ì•„ ë¯¸ë¥´ì—˜â€¦ ì´ë ‡ê²Œ ëª¨ë“ ê²ƒì´â€¦ ëë‚˜ëŠ”êµ¬ë‚˜ â€¦ ë¯¸ë¥´ì—˜â€¦";
var SILVANA_DEAD_SUBLINE = "ë§ˆì§€ë§‰ ì—˜í”„ì—¬ì™•, ë¦´ë¦¬ì•„ë„¤ ë¯¸ë¥´ì—˜ â€” ê¸°ë¡ ì¢…ë£Œ";
var SILVANA_FAIL_LINE = "ë„ë§ì³ë¼. ëŠªì€â€¦ ë„ˆí¬ì˜ ë¼ˆë¥¼ ê¸°ì–µí•œë‹¤.";

let bossBattleTickTimer = null;
  let bossBattleDeathFxShown = {};   // { bossId: true } - ì‚¬ë§/ì‹¤íŒ¨ ì—°ì¶œ 1íšŒë§Œ
let bossBattleLastStatus = {};      // { bossId: "active"|"cleared"|"failed" }
  let bossBattlePrevShieldHp = {};  // { bossId: number } ì´ì „ shieldHp ê¸°ì–µ(íŒŒê´´ ìˆœê°„ ê°ì§€ìš©)

  // ===============================
// âœ… ë³´ìŠ¤ì „ ì „ìš© ë¡œê·¸ (bossBattleLogs/{bossId})
// ===============================
let bossBattleLogsCache = [];
let bossBattleLogsUnsub = null;
let bossBattleLogsPath = "";

//  í† ë²Œ â€œíšŒì°¨â€ë³„ ë¡œê·¸ë°© ê²½ë¡œ ë§Œë“¤ê¸°
function getBossBattleLogPath(bossId){
  bossId = String(bossId || "");
  const run = (bossRunsActiveCache || {})[bossId];
  const logKey = run && run.logKey ? String(run.logKey) : "run_default";
  return `bossBattleLogs/${bossId}_${logKey}`;
}

  // =========================
// ğŸ‘¹ ë³´ìŠ¤ì „ ì•„ì´ì½˜ ! ì•Œë¦¼(ìƒˆ ì „íˆ¬ë¡œê·¸ ê¸°ì¤€)
// =========================
function getBossLogSeenKey(bossId){
  return "pug_bossLogSeenTs_" + String(bossId || "");
}

function getBossLogSeenTs(bossId){
  try{
    return Number(localStorage.getItem(getBossLogSeenKey(bossId)) || 0);
  }catch(e){
    return 0;
  }
}

function setBossLogSeenTs(bossId, ts){
  try{
    localStorage.setItem(getBossLogSeenKey(bossId), String(Number(ts||0)));
  }catch(e){}
}

function setBossBattleAlertVisible(on){
  const b = document.getElementById("bossBattleAlertBadge");
  if (!b) return;
  b.style.display = on ? "flex" : "none";
}

// í˜„ì¬ activeBossId ê¸°ì¤€ìœ¼ë¡œ ìµœì‹  ë¡œê·¸ ì‹œê°ì„ ë³´ê³  ! ê°±ì‹ 
function refreshBossBattleAlert(bossId){
  const id = String(bossId || activeBossId || "");
  if (!id) { setBossBattleAlertVisible(false); return; }

  const seenTs = getBossLogSeenTs(id);
  const arr = bossBattleLogsCache || [];
  const latestTs = arr.length ? Number(arr[arr.length - 1].t || 0) : 0;

  // ë³´ìŠ¤ì „ ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ìˆìœ¼ë©´ ì½ëŠ” ì¤‘ â†’ ! ë”
  const ov = document.getElementById("bossBattleOverlay");
  const isOpen = !!(ov && ov.style.display !== "none" && ov.style.display !== "");

  if (isOpen) {
    setBossBattleAlertVisible(false);
    return;
  }

  setBossBattleAlertVisible(latestTs > seenTs);
}

// ë³´ìŠ¤ì „ ì˜¤ë²„ë ˆì´ë¥¼ ì—´ê±°ë‚˜ ë‹«ì„ ë•Œ "ì½ìŒ ì²˜ë¦¬"
function markBossBattleLogsSeenNow(bossId){
  const id = String(bossId || activeBossId || "");
  if (!id) return;

  const arr = bossBattleLogsCache || [];
  const latestTs = arr.length ? Number(arr[arr.length - 1].t || 0) : 0;

  setBossLogSeenTs(id, latestTs);
  setBossBattleAlertVisible(false);
}
  
// ë¡œê·¸ êµ¬ë… ì‹œì‘(ë³´ìŠ¤ì „ ì—´ ë•Œ/ì°¸ì—¬ìƒíƒœ ë³µêµ¬ ë•Œ í˜¸ì¶œ)
function ensureBossBattleLogsSubscription(bossId) {
  bossId = String(bossId || "");
  if (!bossId) return;

  // âœ… (ë°©ë²•B) bossId + logKey ì¡°í•© ê²½ë¡œ
  const path = getBossBattleLogPath(bossId);

  // ê°™ì€ â€œë¡œê·¸ë°©(path)â€ì´ë©´ ì¬êµ¬ë… ì•ˆí•¨
  if (bossBattleLogsUnsub && bossBattleLogsPath === path) return;

  // ì´ì „ êµ¬ë… í•´ì œ
  if (bossBattleLogsUnsub) {
    try { bossBattleLogsUnsub(); } catch(e) {}
  }
  bossBattleLogsUnsub = null;

  bossBattleLogsPath = path;
  bossBattleLogsCache = [];

  const ref = db.ref(path).limitToLast(80);

  const onValue = (snap) => {
    const v = snap.val() || {};
    const arr = Object.keys(v).map(k => ({
  t: Number(v[k].t || 0),
  msg: String(v[k].msg || ""),
  tone: String(v[k].tone || "")
}));
    arr.sort((a,b) => a.t - b.t);
    bossBattleLogsCache = arr;
    renderBossBattleLogs();
    refreshBossBattleAlert(bossId);
  };

  ref.on("value", onValue);

  // âœ… off í•¨ìˆ˜ ì €ì¥
  bossBattleLogsUnsub = () => ref.off("value", onValue);
}

function renderBossBattleLogs() {
  const el = document.getElementById("bossBattleLogList");
  if (!el) return;

  const arr = bossBattleLogsCache || [];
  if (!arr.length) {
    el.innerHTML = `<div style="color:#aaa; font-size:12px;">ì§„í–‰ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  el.innerHTML = arr.map(x => {
    const t = x.t ? formatTime(x.t) : "";
    const esc = (s) => String(s || "")
  .replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;")
  .replace(/"/g, "&quot;")
  .replace(/'/g, "&#39;");

const msgHtml = esc(x.msg).replace(/\n/g, "<br>");
const tone = String(x.tone || "");

let safeMsg = msgHtml;
if (tone === "yellow") {
  safeMsg = `<span style="color:#ffd54f; font-weight:900;">${msgHtml}</span>`;
}
    return `
      <div style="margin-bottom:6px; font-size:12px; line-height:1.35;">
        <span style="color:#888;">[${t}]</span> ${safeMsg}
      </div>
    `;
  }).join("");

  // ìŠ¤í¬ë¡¤ í•­ìƒ ì•„ë˜ë¡œ
  el.scrollTop = el.scrollHeight;
}

function writeBossBattleLog(bossId, msg, opt) {
  bossId = String(bossId || "");
  if (!bossId) return;

  const text = String(msg || "").trim();
  if (!text) return;

  const tone = opt && opt.tone ? String(opt.tone) : "";

  db.ref(getBossBattleLogPath(bossId)).push({
    t: Date.now(),
    msg: text,
    tone
  });
}

function openBossBattle(){
  const bossId = String(activeBossId || "");
  const run = (bossRunsActiveCache || {})[bossId];
  if (!bossId || !run || !["active","cleared","failed"].includes(String(run.status || ""))) {
  showNpcMessage("ì°¸ì—¬ì¤‘ì¸ ë³´ìŠ¤ì „ì´ ì—†ìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
  return;
}

  // ë©¤ë²„ ì²´í¬
  if (!(run.members && run.members[userId])) {
    showNpcMessage("í† ë²ŒëŒ€ì— ì°¸ì—¬í•œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  const ov = document.getElementById("bossBattleOverlay");
  if (!ov) return;

  ov.style.display = "flex";
  markBossBattleLogsSeenNow(bossId);
  document.getElementById("bossBattleBossImg")?.classList.add("boss-breathe");
  document.getElementById("bossBattleBossShadow")?.classList.add("boss-breathe-shadow");
  ensureBossBattleLogsSubscription(bossId);
  renderBossBattle();

  if (bossBattleTickTimer) clearInterval(bossBattleTickTimer);
  bossBattleTickTimer = setInterval(() => {
    const ov2 = document.getElementById("bossBattleOverlay");
    if (!ov2 || ov2.style.display === "none") return;
    renderBossBattle();
  }, 1000);
}

  function onBossBattleIconClick(){
  // âœ… í˜„ì¬ í™œì„± ë³´ìŠ¤ëŸ° ê°€ì ¸ì˜¤ê¸°(íŒŒì¼ ê¸°ì¡´ ë°©ì‹)
  const bossId = String(activeBossId || "");
  const run = (bossRunsActiveCache || {})[bossId];

  // âœ… ì°¸ì—¬ì¤‘ì¸ ë³´ìŠ¤ì „ì´ ì—†ëŠ” ê²½ìš°: NPC ì—†ëŠ” íŒì—…
  if (!bossId || !run || !["active","cleared","failed"].includes(String(run.status || ""))) {
    showSimpleMessage("í˜„ì¬ ì°¸ì—¬ì¤‘ì¸ ë³´ìŠ¤ì „ì´ ì—†ìŠµë‹ˆë‹¤", "ë³´ìŠ¤ì „");
    return;
  }

  // âœ… ë³´ìŠ¤ì „ ì°¸ì—¬ì‹ ì²­(ë©¤ë²„) ì•ˆ í•œ ê²½ìš°: NPC ì—†ëŠ” íŒì—…
  if (!(run.members && run.members[userId])) {
    showSimpleMessage("í˜„ì¬ ì°¸ì—¬ì¤‘ì¸ ë³´ìŠ¤ì „ì´ ì—†ìŠµë‹ˆë‹¤", "ë³´ìŠ¤ì „");
    return;
  }

  // âœ… ì°¸ì—¬ì‹ ì²­í•œ ìœ ì €: ë ˆì˜¨í•˜ë¥´íŠ¸ NPC í™•ì¸ íŒì—…
  showConfirmPopup(
  "ë³´ìŠ¤ í† ë²Œë¡œ ì´ë™í•˜ê² ë‚˜?",
  "images/npc/leonhardt_apply.png",
  "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ",
  "ì´ë™í•œë‹¤",
  startBossBattleMove,
  "ì ì‹œë§Œ...",
  closeNpcPopup
);
}

  function showSimpleMessage(text, title){
  const html = `
    <div style="text-align:center; font-size:14px; line-height:1.6;">
      <div style="font-weight:900; margin-bottom:6px;">${title || ""}</div>
      <div style="color:#ddd;">${text || ""}</div>
    </div>
  `;
  // âœ… npcPopupì„ ê°ˆì•„ì—ì§€ ë§ê³  showNpcMessage ì‚¬ìš©
  showNpcMessage(html, null, true, "");
}

  function showConfirmPopup(msg, imgPath, npcName, okText, okFn, cancelText, cancelFn){
  const popup     = document.getElementById("npcPopup");
  const msgEl     = document.getElementById("npcPopupText");
  const imgEl     = document.getElementById("npcPopupImg");
  const okBtn     = document.getElementById("npcConfirmBtn");
  const cancelBtn = document.getElementById("npcCancelBtn");
  const nameEl    = document.getElementById("npcPopupName");

  if (!popup || !msgEl || !imgEl || !okBtn || !cancelBtn) return;

  // ë‚´ìš©
  msgEl.innerHTML = String(msg || "");

  // NPC ì´ë¦„
  if (nameEl) nameEl.textContent = String(npcName || "");

  // ì´ë¯¸ì§€
  if (imgPath) {
    imgEl.src = imgPath;
    imgEl.style.display = "block";
  } else {
    imgEl.style.display = "none";
  }

  // OK ë²„íŠ¼
  okBtn.style.display = "inline-block";
  okBtn.textContent = okText || "í™•ì¸";
  okBtn.onclick = (typeof okFn === "function") ? okFn : closeNpcPopup;

  // Cancel ë²„íŠ¼
  if (cancelText) {
    cancelBtn.style.display = "inline-block";
    cancelBtn.textContent = cancelText;
    cancelBtn.onclick = (typeof cancelFn === "function") ? cancelFn : closeNpcPopup;
  } else {
    cancelBtn.style.display = "none";
    cancelBtn.onclick = null;
  }

  popup.style.display = "flex";
}

// =========================
// âœ… ì£¼ë¬¸ì„œ í•©ì„± ìƒíƒœ
// =========================
let synTargetId = "";
let synPendingQty = 1;

// í•©ì„± ë ˆì‹œí”¼ ë©”íƒ€
function getSynMetaById(id){
  const map = {
    itemDownProtect: { name:"ê°•ë“±ë°©ì§€ì£¼ë¬¸ì„œ", img:"images/items/scroll_down_protect.png", paper:2,  essence:5,  gold:10000000,  give:"itemDownProtect" },
    itemProtect:     { name:"íŒŒê´´ë°©ì§€ì£¼ë¬¸ì„œ", img:"images/items/scroll_protect.png",      paper:20, essence:40, gold:1000000000, give:"itemProtect" },
    itemSuper:       { name:"ìŠˆí¼ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_super.png",        paper:30, essence:60, gold:3000000000, give:"itemSuper" },
    itemScroll15:    { name:"15ê°•ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_15.png",           paper:3,  essence:6,  gold:10000000,  give:"itemScroll15" },
    itemScroll21:    { name:"21ê°•ê°•í™”ì£¼ë¬¸ì„œ", img:"images/items/scroll_21.png",           paper:7,  essence:13, gold:300000000, give:"itemScroll21" },
    itemRateUp5:     { name:"ê°•í™”í™•ë¥ 5%ì£¼ë¬¸ì„œ", img:"images/items/scroll_rateup_5.png",   paper:10, essence:20, gold:2000000000, give:"itemRateUp5" }
  };
  return map[id] || null;
}

function getSynMaxCraftable(meta){
  const havePaper   = Number(itemMagicPaper || 0);
  const haveEssence = Number(itemEssence || 0);
  const haveGold    = Number(gold || 0);

  const maxByPaper   = meta.paper   > 0 ? Math.floor(havePaper / meta.paper) : 999999;
  const maxByEssence = meta.essence > 0 ? Math.floor(haveEssence / meta.essence) : 999999;
  const maxByGold    = meta.gold    > 0 ? Math.floor(haveGold / meta.gold) : 999999;

  return Math.max(0, Math.min(maxByPaper, maxByEssence, maxByGold));
}

// 1) í•©ì„± ì‹œì‘(ìˆ˜ëŸ‰ ì„ íƒ ë‹¨ê³„)
function openScrollSynthesizeConfirm(id){
  const meta = getSynMetaById(id);
  if (!meta) return;

  synTargetId = id;
  const max = getSynMaxCraftable(meta);
    // âœ… ê¸°ì¡´ ì„ íƒ ìˆ˜ëŸ‰ì„ ìœ ì§€í•˜ë˜, 1~max ë²”ìœ„ë¡œë§Œ ë³´ì •
  // (setSynQty()ê°€ ë‹¤ì‹œ í˜¸ì¶œí•´ë„ ë¦¬ì…‹ë˜ì§€ ì•Šê²Œ)
  if (max <= 0) {
    synPendingQty = 0;
  } else {
    const cur = Number(synPendingQty || 1);
    synPendingQty = Math.max(1, Math.min(cur, max));
  }

    // âœ… ìˆ˜ëŸ‰ ë³´ì •(0~MAX)
  const chosen = Math.max(0, Math.min(Number(synPendingQty || 1), max));
  synPendingQty = chosen;

  const needPaper   = meta.paper   * chosen;
  const needEssence = meta.essence * chosen;
  const needGold    = meta.gold    * chosen;

  // ë²„íŠ¼(êµ¬ë§¤/ë¶„í•´ì™€ ë™ì¼ ìŠ¤íƒ€ì¼)
  const qtyBtn = (n, label) => {
    const disabled = (n > max);
    const active = (synPendingQty === n);
    return `
      <button
        style="
          padding:8px 10px; border-radius:10px;
          border:1px solid ${active ? "rgba(255,215,64,0.65)" : "rgba(255,255,255,0.18)"};
          background:${active ? "rgba(255,215,64,0.18)" : "rgba(0,0,0,0.35)"};
          color:${disabled ? "rgba(255,255,255,0.25)" : "#fff"};
          cursor:${disabled ? "not-allowed" : "pointer"};
          min-width:56px;
        "
        ${disabled ? "disabled" : ""}
        onclick="setSynQty(${n});"
      >${label}</button>
    `;
  };

  const msg = `
    <div style="font-weight:900;font-size:18px;margin-bottom:8px;">ì£¼ë¬¸ì„œ í•©ì„±</div>
    <div style="color:#aaa;margin-bottom:10px;">${meta.name}</div>

    <div style="text-align:left; font-size:13px; color:#ddd; line-height:1.7; margin-bottom:10px;">
      í•„ìš” ì¬ë£Œ(1ê°œ ê¸°ì¤€)<br>
      - ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´: <b>${meta.paper}</b>ê°œ<br>
      - ë§ˆë ¥ì˜ì •ìˆ˜: <b>${meta.essence}</b>ê°œ<br>
      - ê³¨ë“œ: <b>${formatGold(meta.gold)}</b><br><br>

      í˜„ì¬ ë³´ìœ <br>
      - ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´: <b>${Number(itemMagicPaper||0)}</b>ê°œ<br>
      - ë§ˆë ¥ì˜ì •ìˆ˜: <b>${Number(itemEssence||0)}</b>ê°œ<br>
      - ê³¨ë“œ: <b>${formatGold(Number(gold||0))}</b><br>
    </div>

    <div style="color:#aaa; text-align:center; margin-bottom:10px;">
      ëª‡ ê°œ í•©ì„±í• ë˜? (ê°€ëŠ¥ ìµœëŒ€: ${max}ê°œ)
    </div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:10px;">
      ${qtyBtn(1,"1")}
      ${qtyBtn(5,"5")}
      ${qtyBtn(20,"20")}
      ${qtyBtn(max,"MAX")}
    </div>

    <div style="text-align:center; font-size:13px; color:#ddd; line-height:1.6;">
      ì„ íƒ ìˆ˜ëŸ‰: <b>${chosen}</b>ê°œ<br>
      ì´ ì†Œëª¨: 
      <span style="color:#ffd54f;">ì¢…ì´ ${needPaper}ê°œ</span>, 
      <span style="color:#ffd54f;">ì •ìˆ˜ ${needEssence}ê°œ</span>, 
      <span style="color:#ffd54f;">ê³¨ë“œ ${formatGold(needGold)}</span>
    </div>
  `;

  showConfirmPopup(
    msg,
    meta.img,                 // âœ… ê²°ê³¼ ì£¼ë¬¸ì„œ ì´ë¯¸ì§€(ê¸°ì¡´ ê²½ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
    "ì„¸ë ˆë‚˜ ì—ë¸ë¦°",           // âœ… NPC ì´ë¦„(ë¬¸ìì—´ë¡œ!)
    "í•©ì„±í™•ì •",
    () => confirmSynthesize(),
    "ì·¨ì†Œ",
    () => {
      synTargetId = "";
      synPendingQty = 1;
      closeNpcPopup();
    }
  );
}

// 2) ìˆ˜ëŸ‰ ì„¸íŒ…(0~MAXë¡œ í´ë¨í”„)
function setSynQty(qty){
  const meta = getSynMetaById(synTargetId);
  if (!meta) return;

  const max = getSynMaxCraftable(meta);
  synPendingQty = Math.max(0, Math.min(Number(qty||0), max));

  // ê°™ì€ íŒì—… ë‚´ìš©ì„ ê°±ì‹ (ê°„ë‹¨íˆ ë‹¤ì‹œ ì—´ê¸°)
  openScrollSynthesizeConfirm(synTargetId);
}

// 3) í•©ì„± ì‹¤í–‰(ì¬ë£Œ ì°¨ê° + ê²°ê³¼ ì§€ê¸‰)
function confirmSynthesize(){
  const meta = getSynMetaById(synTargetId);
  if (!meta) return;

  const qty = Number(synPendingQty || 0);
  if (qty <= 0){
    showNpcMessage("í•©ì„±í•  ìˆ˜ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.", null, true, "");
    return;
  }

  const needPaper   = meta.paper   * qty;
  const needEssence = meta.essence * qty;
  const needGold    = meta.gold    * qty;

  // âœ… ë¶€ì¡± ì²´í¬ëŠ” ë”œë ˆì´ ì „ì— ë¨¼ì €!
  if (Number(itemMagicPaper||0) < needPaper) {
    showNpcMessage("ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", null, true, "");
    return;
  }
  if (Number(itemEssence||0) < needEssence) {
    showNpcMessage("ë§ˆë ¥ì˜ì •ìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", null, true, "");
    return;
  }
  if (Number(gold||0) < needGold) {
    showNpcMessage("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", null, true, "");
    return;
  }

  runWithShortDelay("ì ê¹ë§Œ, ê¸ˆë°© ë§Œë“¤ì–´ì¤„ê²Œâ€¦", () => {

    // âœ… ì°¨ê°
    itemMagicPaper = Number(itemMagicPaper||0) - needPaper;
    itemEssence    = Number(itemEssence||0) - needEssence;
    gold           = Number(gold||0) - needGold;

    // âœ… ì§€ê¸‰(ë³€ìˆ˜ëª… ê·¸ëŒ€ë¡œ)
    if (meta.give === "itemDownProtect") itemDownProtect = Number(itemDownProtect||0) + qty;
    if (meta.give === "itemProtect")     itemProtect     = Number(itemProtect||0) + qty;
    if (meta.give === "itemSuper")       itemSuper       = Number(itemSuper||0) + qty;
    if (meta.give === "itemScroll15")    itemScroll15    = Number(itemScroll15||0) + qty;
    if (meta.give === "itemScroll21")    itemScroll21    = Number(itemScroll21||0) + qty;
    if (meta.give === "itemRateUp5")     itemRateUp5     = Number(itemRateUp5||0) + qty;

    save();
    update();
    renderInventory();
    renderScrollShopItems();

    // âœ… ë¶„í•´ì™€ ë™ì¼í•œ êµ¬ì¡°ë¡œ ê²°ê³¼ ë©”ì‹œì§€
    showNpcMessage(
      `í•©ì„± ì™„ë£Œ!<br><span style="color:#ffd54f;">${meta.name} ${qty}ê°œ</span> íšë“`,
      meta.img,
      true,
      ""
    );

    // ìƒíƒœ ì´ˆê¸°í™”
    synTargetId = "";
    synPendingQty = 1;
  });
}

function startBossBattleMove(){
  closeNpcPopup();

  const bossId = String(activeBossId || "");
  const targetFieldId = BOSS_FIELD_MAP[bossId];

  // ë§¤í•‘ì´ ì—†ìœ¼ë©´ ì´ë™ ì—†ì´ ë³´ìŠ¤ì „ë§Œ ì—´ì–´ì¤€ë‹¤(ì•ˆì „ì¥ì¹˜)
  if (!targetFieldId) {
    console.warn("ë³´ìŠ¤ í•„ë“œ ë§¤í•‘ ì—†ìŒ:", bossId);
    openBossBattle();
    return;
  }

  // âœ… ì´ë™/íŒì—…/isMoving/ë°°ê²½ì ìš©/ì €ì¥ = ì „ë¶€ moveToFieldFromWorldMapê°€ ë‹´ë‹¹
  moveToFieldFromWorldMap(targetFieldId, () => {
    // âœ… ë„ì°© í›„ ë³´ìŠ¤ì „ ì˜¤ë²„ë ˆì´ ì˜¤í”ˆë§Œ ë‹´ë‹¹
    openBossBattle();
  });
}

function closeBossBattle(){
  const ov = document.getElementById("bossBattleOverlay");
  if (ov) ov.style.display = "none";
  markBossBattleLogsSeenNow(activeBossId);
  document.getElementById("bossBattleBossImg")?.classList.remove("boss-breathe");
  document.getElementById("bossBattleBossShadow")?.classList.remove("boss-breathe-shadow");
  if (bossBattleTickTimer) { clearInterval(bossBattleTickTimer); bossBattleTickTimer = null; }
}

  function openBossBattleRewards(){
  const bossId = String(activeBossId || "");
  const run = (bossRunsActiveCache || {})[bossId];

  if (!bossId || !run) {
    showNpcMessage("í™•ì¸í•  ë³´ìŠ¤ì „ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ë³´ìƒ");
    return;
  }

  const def = (BOSS_DEFS || []).find(b => String(b.id) === bossId) || {};
  const bossTitle = String(def.bossTitle || run.bossTitle || "ë³´ìŠ¤");
  const bossName  = String(def.bossName  || run.bossName  || "");
  const bossFull  = bossName ? `${bossTitle} ${bossName}` : bossTitle;

  // âœ… â€œêµ¬ì²´ %ë³„â€ ë§ê³ , ëŒ€ì¶© ë¬´ì—‡ì´ ë‚˜ì˜¤ëŠ”ì§€ë§Œ í‘œì‹œ
  const rewardTypes = [
    "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",
    "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",
    "15ê°• ê°•í™” ì£¼ë¬¸ì„œ",
    "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",
    "ë§ˆë ¥ì˜ ì •ìˆ˜",
    "ëŒ€ì¥ ë³´ë„ˆìŠ¤: ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ"
  ];

  const msg =
    `<b>${bossFull} ë³´ìƒ</b><br><br>` +
    rewardTypes.map(x => `â€¢ ${x}`).join("<br>");

  showNpcMessage(msg, LEON_IMG.focus, true, "ë³´ìƒ");
}

  function openBossBattleStat(){
  // ë²„íŠ¼ íƒ­ ì‚¬ìš´ë“œ(ë„í¬ë‘ ë™ì¼)
  try { playUiDockTap(); } catch(e){}

  // âœ… ë³´ìŠ¤ì „ ì „ìš©: ë³´ìŠ¤ì •ë³´(ë³´ìŠ¤ ìŠ¤íƒ¯ + ë‚´ ë³´ì •/ìµœì¢… ìˆ˜ì¹˜) ì—´ê¸°
  openBossBattleHelp();
}
  
function openBossBattleHelp(){
  const bossId = String(activeBossId || "");
  const run = (bossRunsActiveCache || {})[bossId];

  if (!bossId || !run) {
    showNpcMessage("í™•ì¸í•  ë³´ìŠ¤ì „ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ë³´ìŠ¤ì •ë³´");
    return;
  }

  const def = (BOSS_DEFS || []).find(b => String(b.id) === bossId) || {};
  const bossTitle = String(def.bossTitle || run.bossTitle || "ë³´ìŠ¤");
  const bossName  = String(def.bossName  || run.bossName  || "");
  const bossFull  = bossName ? `${bossTitle} ${bossName}` : bossTitle;

  // ë³´ìŠ¤ ìŠ¤íƒ¯(0ì¸ í•­ëª©ì€ í‘œì‹œ ì•ˆ í•¨)
  const stats = (typeof getBossBattleStats === "function") ? (getBossBattleStats(bossId) || {}) : {};
  const hp    = Math.max(0, Number(run.hp || 0));
  const maxHp = Math.max(1, Number(run.maxHp || 1));

  const bossLines = [];
  bossLines.push(`â€¢ ì²´ë ¥: <b>${formatBossHpShort(hp)}</b> / ${formatBossHpShort(maxHp)}`);

  const evade = Number(stats.evade || 0);
  const physDef = Number(stats.physDef || 0);
  const magicRes = Number(stats.magicRes || 0);

  if (evade > 0)    bossLines.push(`â€¢ íšŒí”¼ìœ¨: <b>${Math.round(evade * 100)}%</b>`);
  if (physDef > 0)  bossLines.push(`â€¢ ë¬¼ë¦¬ ë°©ì–´ë ¥: <b>${Math.round(physDef * 100)}%</b>`);
  if (magicRes > 0) bossLines.push(`â€¢ ë§ˆë²• ì €í•­ë ¥: <b>${Math.round(magicRes * 100)}%</b>`);

  // (ì„ íƒ) í˜ì´ì¦ˆ/ìŠ¤í‚¬: BOSS_DEFSì— phasesê°€ ìˆìœ¼ë©´ë§Œ í‘œì‹œ
  if (def.phases && Array.isArray(def.phases) && def.phases.length) {
    const ptxt = def.phases.map(p => {
      const name = p && p.name ? String(p.name) : "í˜ì´ì¦ˆ";
      const skills = (p && Array.isArray(p.skills) && p.skills.length) ? `(${p.skills.join(", ")})` : "";
      return `${name}${skills}`;
    }).join("<br>");
    bossLines.push(`â€¢ í˜ì´ì¦ˆ/ìŠ¤í‚¬:<br><span style="color:#bbb; font-size:12px; line-height:1.4;">${ptxt}</span>`);
  }

  // ë‚´ ì •ë³´(ë³´ì •ëœ ê°’ / 0ì¸ í•­ëª©ì€ í‘œì‹œ ì•ˆ í•¨)
  const wp = (typeof getBossWeaponProfile === "function") ? (getBossWeaponProfile() || {}) : {};
  const t = String(wp.t || weaponType || "sword");
  const coef = Number(wp.coef || 1);
  const ignoreDef = Number(wp.ignoreDef || 0);
  const ignoreEvade = Number(wp.ignoreEvade || 0);
  const critRate = Number(wp.critRate || 0);
  const dmgLabel = String(wp.dmgLabel || (t === "staff" ? "ì£¼ë¬¸ë ¥" : "ê³µê²©ë ¥"));

  let wName = "ë¬´ê¸°";
  try {
    if (typeof getWeaponInfo === "function") {
      const info = getWeaponInfo(Number(sword || 0), String(weaponType || "sword"));
      if (info && info.name) wName = String(info.name);
    } else if (typeof weaponName !== "undefined" && weaponName) {
      wName = String(weaponName);
    }
  } catch(e) {}

  // â€œë³´ì •ëœ ê³µê²©ë ¥/ì£¼ë¬¸ë ¥â€ = (ì „íˆ¬ë ¥ * ê°•í™”ë³´ì •) * ë¬´ê¸°ê³„ìˆ˜ * (ë°©ì–´/ì €í•­ ë°˜ì˜)  â€» ëœë¤(85~100%) ì œì™¸
  const rawPower = Number(power || 0);
  const swordLv  = Number(sword || 0);
  const powerMul = (typeof getBossPowerMultiplier === "function") ? Number(getBossPowerMultiplier(bossId, swordLv) || 1) : 1;
  const adjPower = rawPower * powerMul;

  const effPhysDef = Math.max(0, physDef - ignoreDef); // ì°½ ê´€í†µ ë°˜ì˜
  const effMagicRes = Math.max(0, magicRes);

  let base = adjPower * coef;
  if (t === "staff") base = base * (1 - effMagicRes);
  else base = base * (1 - effPhysDef);
  base = Math.max(0, Math.floor(base));

  const myLines = [];
  myLines.push(`â€¢ ë¬´ê¸°: <b>${wName}</b> +${swordLv}ê°•`);
  myLines.push(`â€¢ ${dmgLabel}: <b>${formatBossHpShort(base)}</b>`);

  if (ignoreDef > 0)  myLines.push(`â€¢ ê´€í†µë ¥: <b>${Math.round(ignoreDef * 100)}%</b>`);
  if (ignoreEvade > 0) myLines.push(`â€¢ íšŒí”¼ ë¬´ì‹œ: <b>${Math.round(ignoreEvade * 100)}%</b>`);
  if (critRate > 0) {
    myLines.push(`â€¢ ì¹˜ëª…íƒ€ í™•ë¥ : <b>${Math.round(critRate * 100)}%</b>`);
myLines.push(`â€¢ ì¹˜ëª…íƒ€ ë°ë¯¸ì§€: <b>+${Math.round((0.20 + Number(critDmgBonus || 0)) * 100)}%</b>`);
  }

  const html = `
    <div style="text-align:left; font-size:13px; line-height:1.6;">
      <div style="font-weight:900; margin-bottom:6px;">[ë³´ìŠ¤ ì •ë³´] ${bossFull}</div>
      <div style="color:#ddd;">${bossLines.join("<br>")}</div>

      <div style="height:12px;"></div>

      <div style="font-weight:900; margin-bottom:6px;">[ë‚˜ì˜ ì •ë³´] ${getNickSafe()}</div>
      <div style="color:#ddd;">${myLines.join("<br>")}</div>
    </div>
  `;

  showNpcMessage(html, LEON_IMG.focus, true, "ëŠ¥ë ¥ì¹˜");
}

  function formatBossHpShort(v){
  v = Math.max(0, Number(v || 0));

  // 1ì–µ ì´ìƒì´ë©´ "ì–µ" ë‹¨ìœ„ë¡œ 2ìë¦¬ ì†Œìˆ˜
  if (v >= 100000000) {
    const n = v / 100000000;
    const fixed = n.toFixed(2);              // "3059.78"
    const parts = fixed.split(".");
    const intPart = Number(parts[0]).toLocaleString("ko-KR");
    return `${intPart}.${parts[1]}ì–µ`;
  }

  // ê·¸ ì•„ë˜ëŠ” ê¸°ì¡´ í¬ë§·(ë„ˆ ê²Œì„ í¬ë§· ìœ ì§€)
  return formatGold(v);
}

  // ğŸ”¢ ëŠ¥ë ¥ì¹˜ìš© ìˆ«ì í’€ í‘œê¸° (ì¡° / ì–µ / ë§Œ / 1ì˜ ìë¦¬)
function formatNumberFullKR(num) {
  num = Math.floor(Number(num) || 0);
  if (num <= 0) return "0";

  const parts = [];

  const jo  = Math.floor(num / 1_0000_0000_0000);
  if (jo > 0) {
    parts.push(`${jo}ì¡°`);
    num %= 1_0000_0000_0000;
  }

  const eok = Math.floor(num / 1_0000_0000);
  if (eok > 0) {
    parts.push(`${eok}ì–µ`);
    num %= 1_0000_0000;
  }

  const man = Math.floor(num / 1_0000);
  if (man > 0) {
    parts.push(`${man}ë§Œ`);
    num %= 1_0000;
  }

  if (num > 0 || parts.length === 0) {
    parts.push(`${num}`);
  }

  return parts.join(" ");
}

  function formatGoldFullKR(n){
  return formatNumberFullKR(n).replace(/\s+/g, "") + "ê³¨ë“œ";
}

// âœ… ë°ë¯¸ì§€ìš©: 16ì–µ4215ë§Œ5512 í˜•íƒœ (ì‰¼í‘œ ì—†ìŒ / ë§Œ, ì–µ ë‹¨ìœ„)
function formatDamageKoUnits(n){
  n = Math.floor(Number(n || 0));
  const sign = (n < 0) ? "-" : "";
  n = Math.abs(n);

  const eok = Math.floor(n / 100000000);        // ì–µ
  const man = Math.floor((n % 100000000) / 10000); // ë§Œ(4ìë¦¬)
  const rest = n % 10000;                       // ë‚˜ë¨¸ì§€(4ìë¦¬)

  let s = "";

  if (eok > 0) {
    s += eok + "ì–µ";
    s += String(man).padStart(4, "0") + "ë§Œ";
    s += String(rest).padStart(4, "0");
    return sign + s;
  }

  if (man > 0) {
    s += man + "ë§Œ";
    s += String(rest).padStart(4, "0");
    return sign + s;
  }

  return sign + String(rest);
}

  function maybeCastManaShield(bossId, run){
  if (bossId !== "frost_queen") return;
  if (!run || String(run.status || "") !== "active") return;

  const now = Date.now();
  const last = Number(run.lastManaShieldTryAt || 0);
  const shieldHp = Math.max(0, Number(run.shieldHp || 0));

  // ì‹¤ë“œê°€ ë‚¨ì•„ìˆìœ¼ë©´ "ì¬ì‹œì „í•´ë„ 300ì–µ ì´ìƒ ì˜¤ë¥´ì§€ ì•ŠìŒ" â†’ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
  if (shieldHp > 0) return;

  // 2ì‹œê°„ ì¿¨(7200000ms)
  if (last && (now - last) < 2 * 60 * 60 * 1000) return;

  const runRef = db.ref(`bossRunsActive/${bossId}`);
  runRef.transaction((cur) => {
    if (!cur || String(cur.status || "") !== "active") return;

    const now2 = Date.now();
    const last2 = Number(cur.lastManaShieldTryAt || 0);
    const shieldHp2 = Math.max(0, Number(cur.shieldHp || 0));
    const shieldMax2 = Math.max(0, Number(cur.shieldMax || 0));

    if (shieldHp2 > 0) return cur; // ì´ë¯¸ ëˆ„ê°€ ì˜¬ë ¤ë‘ 
    if (last2 && (now2 - last2) < 2 * 60 * 60 * 1000) return cur;

    cur.lastManaShieldTryAt = now2;

    // 30% í™•ë¥ 
    if (Math.random() < 0.30) {
      cur.shieldMax = 30000000000;
      cur.shieldHp = 30000000000; // ìµœëŒ€ 300ì–µ
      cur.manaShieldOnAt = now2;
    }
    return cur;
  }, (err, committed) => {
    // ì„±ê³µì ìœ¼ë¡œ ì‹¤ë“œê°€ ì¼œì§„ ê²½ìš°ì—ë§Œ ë¡œê·¸(ë…¸ë€ìƒ‰ì€ HTML ìŠ¤íƒ€ì¼ë¡œ ì²˜ë¦¬)
    const r = (bossRunsActiveCache || {})[bossId];
    if (!err && committed && r && Number(r.shieldHp || 0) > 0) {
      writeBossBattleLog(
  bossId,
  "ì„œë¦¬ì—¬ì™• ì•„ë¥´ì…€ë¦¬ì•„ê°€ ë§ˆë‚˜ì‹¤ë“œë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. ë§ˆë‚˜ì‹¤ë“œê°€ íŒŒê´´ë˜ê¸° ì „ê¹Œì§€ ê³µê²©ë ¥ì´ í†µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤",
  { tone: "yellow" }
);
    }
  });
}
  
function renderBossBattle(){
    
  const bossId = String(activeBossId || "");
  const run = (bossRunsActiveCache || {})[bossId];
  if (!run) return;

  maybeCastManaShield(bossId, run);

  const def = BOSS_DEFS.find(b => b.id === bossId);

  const mapName = def ? def.mapName : (run.mapName || "-");
  const bossTitle = def ? def.bossTitle : (run.bossTitle || "ë³´ìŠ¤");
  const bossName = def ? def.bossName : (run.bossName || "");

  const mapEl = document.getElementById("bossBattleMapName");
  const nameEl = document.getElementById("bossBattleBossName");
  if (mapEl) mapEl.textContent = mapName;
  if (nameEl) nameEl.textContent = `${bossTitle} - ${bossName}`;

  const remainMs = Math.max(0, Number(run.endsAt || 0) - Date.now());
  maybeWarnBossRun24h(bossId, run, mapName, bossTitle, bossName);
  const remainEl = document.getElementById("bossBattleRemain");
  if (remainEl) remainEl.textContent = formatHMS(remainMs);

    // âœ… ë°°ê²½/ë³´ìŠ¤ì´ë¯¸ì§€: ë³´ìŠ¤ë³„ë¡œ ëŸ°íƒ€ì„ ì„¸íŒ…
  const bgEl = document.getElementById("bossBattleBg");
  if (bgEl && def && def.bgImg) bgEl.src = def.bgImg;

  const bossImgEl = document.getElementById("bossBattleBossImg");
  if (bossImgEl) bossImgEl.src = getBossSpriteSrc(bossId, String(run.status || "active"));

  // âœ… ë³´ìŠ¤ì „ì—ì„œë„ ì‚¬ëƒ¥íšŸìˆ˜(=ë³´ìŠ¤ íƒ€ê²© íšŸìˆ˜) í‘œì‹œ
const huntRemainEl = document.getElementById("bossBattleHuntRemain");
const headHunt = document.getElementById("bossBattleHeaderHuntRemain");

// âœ… ìµœëŒ€ ì‚¬ëƒ¥íšŸìˆ˜(ìŠ¤íƒœí”„ 30ê°• íŒ¨ì‹œë¸Œ í¬í•¨)
const max = getHuntStaminaMax();

const today = getTodayDateString();
let used = 0;
if (lastHuntDate === today) used = Number(huntCountToday || 0);

// ì•ˆì „ì¥ì¹˜: usedê°€ maxë³´ë‹¤ ì»¤ì§€ì§€ ì•Šê²Œ
used = Math.max(0, Math.min(max, used));

const remain = Math.max(0, max - used);

if (huntRemainEl) huntRemainEl.textContent = `ì‚¬ëƒ¥íšŸìˆ˜: ${remain}/${max}`;
  const mySt = (typeof getPlayerFinalCombatStats === "function") ? (getPlayerFinalCombatStats() || {}) : {};
const minusMin = Number(mySt.huntRechargeMinusMin || 0);
const extra = (minusMin > 0) ? ` | ì¶©ì „ -${minusMin}ë¶„` : "";
if (headHunt) headHunt.textContent = `(ì‚¬ëƒ¥íšŸìˆ˜ ${remain} / ${max}${extra})`;

  // âœ… ìš°ì¸¡ í† ë²ŒëŒ€ ë¦¬ìŠ¤íŠ¸ ë Œë”(ëŒ€ì¥ ìµœìƒë‹¨ ê³ ì • + ìŠ¤í¬ë¡¤)
const partyEl = document.getElementById("bossBattlePartyList");
if (partyEl) {
  // 5ëª… ì •ë„ ë³´ì´ê²Œ ë†’ì´ ì œí•œ + ìŠ¤í¬ë¡¤
  partyEl.style.maxHeight = "210px";
  partyEl.style.overflowY = "auto";

  const members = run.members || {};
  const hpDealt = Math.max(0, Number(run.maxHp || 0) - Number(run.hp || 0));
const shieldMax = Math.max(0, Number(run.shieldMax || 0));
const shieldHp  = Math.max(0, Number(run.shieldHp || 0));
const shieldDealt = (shieldMax > 0) ? Math.max(0, shieldMax - shieldHp) : 0;

const totalDamage = Math.max(1, hpDealt + shieldDealt);

  // ë©¤ë²„ ë°°ì—´í™”
  let arr = Object.values(members).map(m => {
    const uid = String((m && m.uid) || "");
    const nick = String((m && m.nick) || "???");
    const dmg = Number((m && m.dmg) || 0);

    // âœ… ìƒˆë¡œ ì¶”ê°€í•œ í‘œê¸°ìš© ìŠ¤ëƒ…ìƒ·(ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ fallback)
    const titleId = String((m && m.titleId) || "");
    const wType = String((m && m.weaponType) || "sword");
    const wLv = Number((m && m.weaponLv) || 0);

    return { uid, nick, dmg, titleId, wType, wLv };
  });

  // ë”œ ìˆœ ì •ë ¬(ê¸°ë³¸)
  arr.sort((a, b) => b.dmg - a.dmg);

  // âœ… ëŒ€ì¥ì€ ë¬´ì¡°ê±´ ìµœìƒë‹¨ ê³ ì •
  const leaderUid = String(run.leaderUid || "");
  const leader = leaderUid ? arr.find(x => String(x.uid) === leaderUid) : null;
  const others = leaderUid ? arr.filter(x => String(x.uid) !== leaderUid) : arr;

  // í‘œì‹œ ìˆœì„œ: [ëŒ€ì¥] + ë‚˜ë¨¸ì§€(ë”œìˆœ)
  const view = [];
  if (leader) view.push({ ...leader, _isLeader: true });
  others.forEach(x => view.push({ ...x, _isLeader: false }));

  if (view.length === 0) {
    partyEl.innerHTML = `<div style="color:#777;">ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    // ë¬´ê¸°ë¶„ë¥˜ í•œê¸€ ë¼ë²¨
    const weaponKor = (t) => {
      if (t === "spear") return "ì°½";
      if (t === "axe") return "ë„ë¼";
      if (t === "bow") return "í™œ";
      if (t === "staff") return "ìŠ¤íƒœí”„";
      if (t === "dagger") return "ë‹¨ê²€";
      return "ê²€";
    };

    let html = "";
    view.forEach((m) => {
      const pct = Math.floor((m.dmg / totalDamage) * 1000) / 10; // 0.1% ë‹¨ìœ„
      const dmgTxt = formatBossHpShort(m.dmg || 0);

      const wTxt = `${weaponKor(m.wType)}+${Number(m.wLv || 0)}ê°•`;

      html += `
  <div style="display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px solid #222; align-items:center;">
    <!-- âœ… ì¢Œì¸¡: ë‹‰ë„¤ì„/ë¬´ê¸° (ì¢Œì¸¡ì •ë ¬ ê³ ì •) -->
    <div style="flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left;">
      ${m._isLeader ? `<span style="margin-right:4px;">ğŸ‘‘</span>` : ``}${m.nick}
      <span style="color:#aaa;">(${wTxt})</span>
    </div>

    <!-- âœ… ìš°ì¸¡: ë”œ/ê¸°ì—¬ë„ (ìš°ì¸¡ì •ë ¬ ê³ ì •) -->
    <div style="white-space:nowrap; display:flex; gap:10px; align-items:center; margin-left:auto; justify-content:flex-end; text-align:right;">
      <div style="color:#ddd; font-weight:900; text-align:right;">ë”œëŸ‰ ${dmgTxt}</div>
      <div style="color:#9fd3ff; font-weight:900; text-align:right;">ê¸°ì—¬ë„:${pct}%</div>
    </div>
  </div>
`;
    });

    partyEl.innerHTML = html;
  }
}

  ensureBossBattleLogsSubscription(bossId);
renderBossBattleLogs();
  
  // HP
  const hp = Math.max(0, Number(run.hp || 0));
  const maxHp = Math.max(1, Number(run.maxHp || 1));
  const ratio = Math.max(0, Math.min(1, hp / maxHp));

  const fillWrap = document.getElementById("bossHpFillWrap");
if (fillWrap) {
  const LEFT_PAD = 45; // âœ… ì™¼ìª½ ì¥ì‹ ë•Œë¬¸ì— ë¹„ì›Œë‘˜ px
  const r = Math.max(0, Math.min(1, Number(ratio) || 0));

  const totalW = (fillWrap.parentElement ? fillWrap.parentElement.clientWidth : 0);
  if (totalW > 0) {
    const usable = Math.max(0, totalW - LEFT_PAD);
    const w = LEFT_PAD + usable * r;              // âœ… 60px + (ë‚¨ì€êµ¬ê°„ * ë¹„ìœ¨)
    fillWrap.style.width = `${Math.round(w)}px`;  // âœ… pxë¡œ ì•ˆì „í•˜ê²Œ
  } else {
    // í˜¹ì‹œ í­ì„ ëª» êµ¬í•˜ëŠ” ìˆœê°„(ë“œë¬¼ê²Œ) ëŒ€ë¹„
    fillWrap.style.width = `${(r * 100).toFixed(3)}%`;
  }
}

  const hpText = document.getElementById("bossHpText");
const shieldText = document.getElementById("bossShieldText");

// âœ… ë§ˆë‚˜ì‹¤ë“œ ë°”(HP ìœ„ì— ë®ìŒ)
const shieldHp = Math.max(0, Number(run.shieldHp || 0));
const shieldMax = Math.max(0, Number(run.shieldMax || 0)); // ì•„ë¥´ì…€ë¦¬ì•„ë©´ 300ì–µ

const hasShieldBar = (shieldMax > 0 && shieldHp > 0);

// âœ… HP í…ìŠ¤íŠ¸ / ì‹¤ë“œ í…ìŠ¤íŠ¸ í† ê¸€
if (hpText) {
  // âœ… HPëŠ” í•­ìƒ í‘œì‹œ
  hpText.style.display = "flex";

  const hpStr = `${formatBossHpShort(hp)} / ${formatBossHpShort(maxHp)}`;

  if (hasShieldBar) {
    const shStr = `${formatBossHpShort(shieldHp)} / ${formatBossHpShort(shieldMax)}`;
    hpText.textContent = `${hpStr}(${shStr})`;   // âœ… ì˜ˆ: 544.4ì–µ/8900ì–µ(35.5ì–µ/300ì–µ)
  } else {
    hpText.textContent = hpStr;
  }
}

const shieldWrap = document.getElementById("bossShieldFillWrap");
if (shieldWrap) {
  if (hasShieldBar) {
    const sRatio = Math.max(0, Math.min(1, shieldHp / shieldMax));
    const LEFT_PAD = 45; // âœ… HPë‘ ë™ì¼ ê·œì¹™
const totalW = (shieldWrap.parentElement ? shieldWrap.parentElement.clientWidth : 0);

if (totalW > 0) {
  const usable = Math.max(0, totalW - LEFT_PAD);
  const w = LEFT_PAD + usable * sRatio;
  shieldWrap.style.width = `${Math.round(w)}px`;
} else {
  shieldWrap.style.width = `${(sRatio * 100).toFixed(3)}%`;
}

    shieldWrap.style.display = "block";
  } else {
    shieldWrap.style.width = "0%";
    shieldWrap.style.display = "none";
  }
}

  // âœ… ì‹¤ë“œê°€ ìˆìœ¼ë©´ HP ì±„ì›€ ë°”ë¥¼ ìˆ¨ê²¨ì„œ "ì‹¤ë“œê°€ HPë¥¼ ì™„ì „íˆ ë®ëŠ”" ì—°ì¶œ
if (fillWrap) {
  const hasShieldBar = (shieldMax > 0 && shieldHp > 0);
  fillWrap.style.opacity = hasShieldBar ? "0.65" : "1";
fillWrap.style.filter  = hasShieldBar ? "brightness(0.92)" : "";
}

  // âœ… ë³´ìŠ¤ ëŒ€ì‚¬(ì§„í–‰ì¤‘=ëœë¤ / ì¢…ë£Œ=ê³ ì •) - ë³´ìŠ¤ë³„ ì²˜ë¦¬
  const st = String(run.status || "");

  const lineMainEl = document.getElementById("bossBattleBossLineMain");
  const lineSubEl  = document.getElementById("bossBattleBossLineSub");

  const defTalk = (typeof BOSS_DEFS !== "undefined")
    ? (BOSS_DEFS.find(b => b.id === bossId) || null)
    : null;

  // ğŸ” fallback (ì‹¤ë°”ë‚˜ ìƒìˆ˜ ìœ ì§€)
  const lines       = defTalk?.lines       || (typeof SILVANA_LINES !== "undefined" ? SILVANA_LINES : []);
  const deadLine    = defTalk?.deadLine    || (typeof SILVANA_DEAD_LINE !== "undefined" ? SILVANA_DEAD_LINE : "");
  const deadSubLine = defTalk?.deadSubLine || (typeof SILVANA_DEAD_SUBLINE !== "undefined" ? SILVANA_DEAD_SUBLINE : "");
  const failLine    = defTalk?.failLine    || (typeof SILVANA_FAIL_LINE !== "undefined" ? SILVANA_FAIL_LINE : "");

  if (st === "cleared") {
    if (lineMainEl) lineMainEl.textContent = String(deadLine || "");
    if (lineSubEl)  lineSubEl.textContent  = String(deadSubLine || "");
  } else if (st === "failed") {
    if (lineMainEl) lineMainEl.textContent = String(failLine || "");
    if (lineSubEl)  lineSubEl.textContent  = "";
  } else {
    if (lineSubEl) lineSubEl.textContent = "";
    if (lineMainEl && (!lineMainEl.textContent || Math.random() < 0.12)) {
      if (lines.length > 0) {
        lineMainEl.textContent = lines[Math.floor(Math.random() * lines.length)];
      } else {
        lineMainEl.textContent = "";
      }
    }
  }

    // âœ… ê²°ê³¼ UI / ë³´ìƒ ë²„íŠ¼ í† ê¸€ + ë³´ìŠ¤ í´ë¦­ ê°€ëŠ¥ ì—¬ë¶€
  const banner = document.getElementById("bossBattleResultBanner");
  const bannerText = document.getElementById("bossBattleResultText");
  const rewardBtn = document.getElementById("bossBattleRewardBtn");
  const bossImg = document.getElementById("bossBattleBossImg");

  // âœ… ë§ˆë‚˜ì‹¤ë“œ ê¸€ë¡œìš°(í˜„ì¬ ìƒíƒœ ê¸°ì¤€ìœ¼ë¡œ í•­ìƒ ë°˜ì˜: ì´ë¯¸ ì¼œì§„ ìƒíƒœë„ ì¦‰ì‹œ ON)
const hasShield = (shieldMax > 0 && shieldHp > 0);
const prevShield = Number(bossBattlePrevShieldHp[bossId] || 0);

if (bossImg) {
  // ì‹¤ë“œê°€ ë‚¨ì•„ìˆìœ¼ë©´ ê¸€ë¡œìš° ìœ ì§€ / ì—†ìœ¼ë©´ ì œê±°
  bossImg.classList.toggle("boss-mana-shield", hasShield);

  // ì‹¤ë“œ íŒŒê´´ ìˆœê°„(ì´ì „>0 â†’ í˜„ì¬=0) 1íšŒ ë²ˆì©ì„
  if (prevShield > 0 && shieldHp === 0) {
    bossImg.classList.add("boss-mana-shield-break");
    setTimeout(() => bossImg.classList.remove("boss-mana-shield-break"), 650);
  }
}

bossBattlePrevShieldHp[bossId] = shieldHp;

  if (bossImg && getBossSpriteSrc(bossId, st)) bossImg.src = getBossSpriteSrc(bossId, st);

  // âœ… (ì¶”ê°€) ìƒíƒœ ë³€í™” ê°ì§€ â†’ ì‚¬ë§/ì‹¤íŒ¨ ìˆœê°„ ì—°ì¶œ 1íšŒ(ê¹œë¹¡ì„ ë°©ì§€)
const prevSt = bossBattleLastStatus[bossId];
if (prevSt !== st) {
  bossBattleLastStatus[bossId] = st;

  // âœ… ë‹¤ìŒ í† ë²Œ(ìƒˆ ëŸ°) ëŒ€ë¹„: activeë¡œ ëŒì•„ì˜¤ë©´ 1íšŒ ì—°ì¶œ í”Œë˜ê·¸ ë¦¬ì…‹
  if (st === "active") {
    bossBattleDeathFxShown[bossId] = false;
  }

  // âœ… ìƒíƒœê°€ ë°”ë€ŒëŠ” 'ìˆœê°„'ì—ë§Œ ì´ë¯¸ì§€ êµì²´(ê¹œë¹¡ì„ ë°©ì§€)
  if (bossImg) {
    const nextSrc = getBossSpriteSrc(bossId, st);
    if (nextSrc) bossImg.src = nextSrc;
  }

  // âœ… ì‚¬ë§/ì‹¤íŒ¨ ì§„ì… ìˆœê°„ 1íšŒë§Œ: ì•”ì „/í˜ì´ë“œ
  if ((st === "cleared" || st === "failed") && !bossBattleDeathFxShown[bossId]) {
    bossBattleDeathFxShown[bossId] = true;

    const fade = document.getElementById("bossBattleFadeOverlay");
    if (fade) {
      // ì§§ì€ ì•”ì „ â†’ ë³µêµ¬
      fade.style.opacity = "0";
      void fade.offsetHeight;       // ë¦¬í”Œë¡œìš° ê°•ì œ
      fade.style.opacity = "0.55";
      setTimeout(() => { fade.style.opacity = "0.20"; }, 420);
      setTimeout(() => { fade.style.opacity = "0"; }, 980);
    }
  }
}
  
  // âœ… (1) ë³´ìŠ¤ ì¿¨ë‹¤ìš´ 24h í™•ì • (í† ë²Œ ì¢…ë£Œ ìˆœê°„ 1íšŒë§Œ)
(function ensureCooldownOnce() {
  if (st !== "cleared" && st !== "failed") return;
  if (!bossId) return;

  const runRef = db.ref(`bossRunsActive/${bossId}`);
  runRef.transaction((cur) => {
    if (!cur) return;
    const s = String(cur.status || "");
    if (s !== "cleared" && s !== "failed") return;

    // ì´ë¯¸ ê¸°ë¡í–ˆìœ¼ë©´ íŒ¨ìŠ¤
    if (cur.cooldownFixed) return;

    cur.cooldownFixed = true;
    cur.cooldownFixedAt = Date.now();
    return cur;
  }, (err, committed) => {
    if (err || !committed) return;

    // âœ… ì¿¨ë‹¤ìš´ ê²½ë¡œ ê¸°ë¡(ë³´ìŠ¤ë³„ nextAt)
    const nextAt = Date.now() + 24 * 60 * 60 * 1000;
    db.ref(`bossCooldown/${bossId}`).set({ nextAt });
  });
})();

// âœ… (2) ë©”ì¸ ë¡œê·¸/ì „ìš© ë¡œê·¸ ê²°ê³¼ ë¬¸êµ¬ 1íšŒë§Œ ì¶œë ¥
(function announceResultOnce() {
  if (st !== "cleared" && st !== "failed") return;
  if (!bossId) return;

  const runRef = db.ref(`bossRunsActive/${bossId}`);
  runRef.transaction((cur) => {
    if (!cur) return;
    const s = String(cur.status || "");
    if (s !== "cleared" && s !== "failed") return;

    if (cur.resultAnnounced) return;
    cur.resultAnnounced = true;
    cur.resultAnnouncedAt = Date.now();
    return cur;
  }, (err, committed) => {
    if (err || !committed) return;

    const def = (typeof BOSS_DEFS !== "undefined")
      ? (BOSS_DEFS.find(b => b.id === bossId) || null)
      : null;

    const mapName   = def ? def.mapName   : (run.mapName || "ì–´ë”˜ê°€");
    const bossTitle = def ? def.bossTitle : (run.bossTitle || "ë³´ìŠ¤");
    const bossName  = def ? def.bossName  : (run.bossName || "");
    const title = `${mapName}ì˜ ì£¼ì¸ ${bossTitle}${bossName ? " " + bossName : ""}`;

    const leader = run.leaderNick || getNickSafe();

    const defLog = (typeof BOSS_DEFS !== "undefined")
  ? (BOSS_DEFS.find(b => b.id === bossId) || {})
  : {};

    const successText = def?.logSuccess || "";
    const failText    = def?.logFail || "";

    if (st === "cleared") {
      writeLog(
        `${leader}ë‹˜ì˜ í† ë²ŒëŒ€ê°€ ${title}ë¥¼ í† ë²Œí•˜ëŠ”ë° ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤.${successText ? " " + successText : ""}`,
        false
      );
      if (typeof writeBossBattleLog === "function") {
        writeBossBattleLog(bossId, "âœ… í† ë²Œ ì„±ê³µ! ë³´ìƒ ìˆ˜ë ¹ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      }
    } else {
      writeLog(
        `${leader}ë‹˜ì˜ í† ë²ŒëŒ€ê°€ ${title} í† ë²Œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.${failText ? " " + failText : ""}`,
        false
      );
      if (typeof writeBossBattleLog === "function") {
        writeBossBattleLog(bossId, "âŒ í† ë²Œ ì‹¤íŒ¨â€¦ í¬ê¸°(ì •ì‚°) ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      }
    }
  });
})();
  
  if (st === "active") {
    if (banner) banner.style.display = "none";
    if (rewardBtn) rewardBtn.style.display = "none";
    if (bossImg) {
      bossImg.style.pointerEvents = "auto";
      bossImg.style.filter = "";
      bossImg.style.opacity = "1";
    }
  } else {
    // cleared / failed
    if (banner) banner.style.display = "block";
    if (bannerText) {
      if (st === "cleared") {
        bannerText.textContent = "í† ë²Œ ì„±ê³µ";
        bannerText.style.color = "#ffd54f";
      } else {
        bannerText.textContent = "í† ë²Œ ì‹¤íŒ¨";
        bannerText.style.color = "#ff6b6b";
      }
    }
    if (rewardBtn) {
  rewardBtn.style.display = "inline-block";
  rewardBtn.innerHTML = (st === "cleared") ? "ğŸ ë³´ìƒìˆ˜ë ¹" : "ğŸšª í¬ê¸°í•˜ê¸°";
}

        // ê³µê²© ë§‰ê¸° (íšŒìƒ‰ ì—°ì¶œ ì œê±°)
    if (bossImg) {
      bossImg.style.pointerEvents = "none";
      bossImg.style.filter = "";
      bossImg.style.opacity = "1";
    }
  }
}
function consumeHuntPointForBoss(){
  // âœ… ë©”ì¸ ì‚¬ëƒ¥ì´ë‘ ë™ì¼í•œ ê¸°ì¤€(ìŠ¤íƒœë¯¸ë‚˜)ë¡œ í†µì¼
  recalcHuntStamina();

  if (huntStamina <= 0) return false;

  // 1íšŒ ì†Œëª¨
  huntStamina = Math.max(0, huntStamina - 1);

  // ì°¸ê³ ìš© ì¹´ìš´íŠ¸ë„ ë©”ì¸ê³¼ ë™ì¼í•˜ê²Œ ì¬ê³„ì‚°
  const max = getHuntStaminaMax();
huntCountToday = Math.max(0, max - huntStamina);

  save();
  update();
  return true;
}

// âœ… ìŠ¤í…2: ë³´ìŠ¤ì „ ì „íˆ¬ ë£°(ëœë¤/MISS/ì¹˜ëª…íƒ€/ë¬´ê¸°íŒ¨ì‹œë¸Œ/ê°•í™”ë³´ì •)
function getBossBattleStats(bossId){
  // í˜„ì¬ëŠ” í•˜ì´ì—˜í”„í€¸ 1ì¢… ê¸°ì¤€(ì¶”í›„ ë³´ìŠ¤ ì¶”ê°€ ì‹œ ì—¬ê¸° í™•ì¥)
  return {
    evade: 0.10,        // 10% íšŒí”¼
    physDef: 0.00,      // ë¬¼ë¦¬ ë°©ì–´ 0%
    magicRes: 0.00      // ë§ˆë²• ì €í•­ 0%
  };
}

function getBossPowerMultiplier(bossId, swordLv){
  // í•˜ì´ì—˜í”„í€¸ ê°•í™”ë³„ ì „íˆ¬ë ¥ ë³´ì •
  const table = {
    25: 0.70, // 30% ê°ì†Œ
    26: 0.50,
    27: 0.30,
    28: 0.20,
    29: 0.15,
    30: 0.10
  };
  if (!swordLv) return 1;
  if (table[swordLv] != null) return table[swordLv];
  return 1;
}

function getBossWeaponProfile(){
  // weaponTypeì€ ë„ˆ ì½”ë“œì—ì„œ ì´ë¯¸ ì“°ê³  ìˆëŠ” ì „ì—­ ê°’(ì˜ˆ: "sword","spear","axe","bow","staff")ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const t = String(weaponType || "sword");

  // ê¸°ë³¸ê°’(ê²€)
  let coef = 1.0;
  let critRate = 0.0;
  let critDmgBonus = 0.0; // ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ ì¶”ê°€(+0.05 = +5%)
  let ignoreDef = 0.0;
  let ignoreEvade = 0.0;
  let dmgLabel = "ê³µê²©ë ¥"; // í‘œì‹œìš©(ìŠ¤íƒœí”„ëŠ” ì£¼ë¬¸ë ¥)

  if (t === "staff") { coef = 1.0; dmgLabel = "ì£¼ë¬¸ë ¥"; }
  else if (t === "spear") { coef = 0.9; ignoreDef = 0.10; }
  else if (t === "axe") { coef = 0.9; critRate = 0.10; }
  else if (t === "bow") { coef = 0.9; ignoreEvade = 0.10; }
  else if (t === "dagger") { coef = 0.9; critRate = 0.05; critDmgBonus = 0.05; }

  return { t, coef, critRate, critDmgBonus, ignoreDef, ignoreEvade, dmgLabel };
}

// âœ… (ì‹ ê·œ) ë¬´ê¸° í•œê¸€ëª…(ëŠ¥ë ¥ì¹˜ UIìš©)
function weaponTypeKor(t){
  t = String(t || "");
  if (t === "sword") return "ê²€";
  if (t === "spear") return "ì°½";
  if (t === "axe") return "ë„ë¼";
  if (t === "bow") return "í™œ";
  if (t === "staff") return "ìŠ¤íƒœí”„";
  if (t === "dagger") return "ë‹¨ê²€";
  return t;
}

// âœ… (ì‹ ê·œ) íŒ¨ì‹œë¸Œ ë ˆë²¨(ë¬´ê¸°ë³„ 30ê°• ë‹¬ì„± íšŸìˆ˜ ê¸°ë°˜)
function getPassiveLevels(){
  const counts = (typeof weapon30Counts === "object" && weapon30Counts) ? weapon30Counts : {};
  const getLv = (wt) => {
    const n = Number(counts[wt] || 0);
    return Math.max(0, Math.min(5, n)); // 1íšŒ=LV1, 5íšŒ=MAX
  };

  return {
    sword:  getLv("sword"),
    spear:  getLv("spear"),
    axe:    getLv("axe"),
    bow:    getLv("bow"),
    staff:  getLv("staff"),
    dagger: getLv("dagger")
  };
}

// âœ… (ì‹ ê·œ) â€œë‚´ ìµœì¢… ì „íˆ¬ ìŠ¤íƒ¯(ì ˆëŒ€ìˆ˜ì¹˜)â€
// - ì—¬ê¸° ê°’ì´ ëŠ¥ë ¥ì¹˜ ì˜¤ë²„ë ˆì´ì— ê·¸ëŒ€ë¡œ ì°í˜
// - ë³´ìŠ¤ì „ì—ì„œëŠ” ì—¬ê¸° ê°’ì— ë³´ìŠ¤ ë³´ì •ë§Œ ê³±/ì ìš©
function getPlayerFinalCombatStats(){
  const wp = getBossWeaponProfile();     // í˜„ì¬ ë¬´ê¸° ê³ ìœ  íŠ¹ì„±(ê³„ìˆ˜/ê¸°ë³¸íŠ¹ì„±)
  const lv = getPassiveLevels();         // ì˜êµ¬ íŒ¨ì‹œë¸Œ ë ˆë²¨
  const rawPower = Number(power || 0);   // ë„¤ ê²Œì„ì˜ ê¸°ë³¸ ì „íˆ¬ë ¥(ì ˆëŒ€ ì„±ì¥ì¹˜)

    // âœ… ê°ì¸ ë³´ë„ˆìŠ¤(ì „íˆ¬ ìŠ¤íƒ¯ì—ë§Œ ë°˜ì˜: ê³µê²©/ì£¼ë¬¸/ì¹˜í™•/ì¹˜ë€/ê´€í†µ/íšŒí”¼ë¬´ì‹œ)
  let engrAtkPct = 0;
  let engrSpellPct = 0;
  let engrPen = 0;
  let engrIgnoreEv = 0;
  let engrCritRate = 0;
  let engrCritDmg = 0;
    // âœ… ê°ì¸ ë³´ë„ˆìŠ¤(ì‚¬ëƒ¥/ê°•í™”/ë³´ìŠ¤ì „ ë°˜ì˜ìš©)
  let engrHuntMaxPlus = 0;
  let engrHuntGoldPct = 0;
  let engrHuntDropPct = 0;
  let engrHuntRechargeMinusMin = 0;

  let engrUpgradeFailRefundPct = 0;
  let engrUpgradeChancePlus = 0;

  let engrBossShieldRemoveChance = 0; // 0.01 / 0.02 í˜•íƒœ(í™•ë¥ )
  let engrBossFirstHitBonusPct = 0;   // +500% ë“± â€œí¼ì„¼íŠ¸ ê°’â€
  let engrBossExecuteBonusPct = 0;    // +400% ë“±
  let engrBossRewardDropPct = 0;      // 15/20
  let engrBossShieldBreakDmgPct = 0;  // 30

  const _lines = Array.isArray(engraveLines) ? engraveLines : ["-","-","-"];
  for (const t of _lines) {
    const s = String(t || "");

    let m;
        if ((m = s.match(/^ê³µê²©ë ¥ \+(\d+)%$/))) engrAtkPct += Number(m[1]) / 100;
    else if ((m = s.match(/^ì£¼ë¬¸ë ¥ \+(\d+)%$/))) engrSpellPct += Number(m[1]) / 100;
    else if ((m = s.match(/^ì¹˜ëª…íƒ€ í™•ë¥  \+(\d+)%$/))) engrCritRate += Number(m[1]) / 100;
    else if ((m = s.match(/^ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ \+(\d+)%$/))) engrCritDmg += Number(m[1]) / 100;
    else if ((m = s.match(/^ê´€í†µë ¥ \+(\d+)%$/))) engrPen += Number(m[1]) / 100;
    else if ((m = s.match(/^íšŒí”¼ë¬´ì‹œ \+(\d+)%$/))) engrIgnoreEv += Number(m[1]) / 100;

    // âœ… ì‚¬ëƒ¥/ìì›
    else if ((m = s.match(/^ì‚¬ëƒ¥ ìµœëŒ€ íšŸìˆ˜ \+(\d+)$/))) engrHuntMaxPlus += Number(m[1]);
    else if ((m = s.match(/^ì‚¬ëƒ¥ ê³¨ë“œ íšë“ëŸ‰ \+(\d+)%$/))) engrHuntGoldPct += Number(m[1]);
    else if ((m = s.match(/^ì‚¬ëƒ¥ ì•„ì´í…œ ë“œëë¥  \+(\d+)%$/))) engrHuntDropPct += Number(m[1]);
    else if ((m = s.match(/^ì‚¬ëƒ¥ íšŸìˆ˜ ì¶©ì „ì‹œê°„ ê°ì†Œ \+(\d+)ë¶„$/))) engrHuntRechargeMinusMin += Number(m[1]);

    // âœ… ê°•í™”
    else if ((m = s.match(/^ê°•í™” ì‹¤íŒ¨ ì‹œ ê³¨ë“œ ì†Œëª¨ ê°ì†Œ \+(\d+)%$/))) engrUpgradeFailRefundPct += Number(m[1]);
    else if ((m = s.match(/^ê°•í™” ì„±ê³µí™•ë¥  \+(\d+)%$/))) engrUpgradeChancePlus += Number(m[1]);

    // âœ… ë³´ìŠ¤ì „ íŠ¹ìˆ˜
    else if ((m = s.match(/^ê³µê²©ì‹œ (\d+)% í™•ë¥ ë¡œ ë³´ìŠ¤ì‹¤ë“œ ëª¨ë‘ì œê±°$/))) engrBossShieldRemoveChance += Number(m[1]) / 100;
    else if ((m = s.match(/^ë³´ìŠ¤ ì²´ë ¥ì´ 100%ì¼ ë•Œ ì²«íƒ€ê²© ë°ë¯¸ì§€ \+(\d+)%$/))) engrBossFirstHitBonusPct += Number(m[1]);
    else if ((m = s.match(/^ë³´ìŠ¤ ì²´ë ¥ì´ 1% ì´í•˜ì¼ë•Œ ë°ë¯¸ì§€ \+(\d+)%$/))) engrBossExecuteBonusPct += Number(m[1]);
    else if ((m = s.match(/^ë³´ìŠ¤ì „ ë³´ìƒ ë“œëë¥  \+(\d+)%$/))) engrBossRewardDropPct += Number(m[1]);
    else if ((m = s.match(/^ë³´ìŠ¤ ë³´í˜¸ë§‰ íŒŒê´´ í”¼í•´ \+(\d+)%$/))) engrBossShieldBreakDmgPct += Number(m[1]);
  }

   const mainMul = 1 + (lv.sword * 0.10);

  // âœ… ë©”ì¸(ê³µê²©ë ¥/ì£¼ë¬¸ë ¥) ê°ì¸ % ì ìš©
  const engrMainPct = (wp.t === "staff") ? engrSpellPct : engrAtkPct;
  const mainPower = Math.floor(rawPower * wp.coef * mainMul * (1 + engrMainPct));

  // 2) ì„œë¸Œ ìŠ¤íƒ¯(0%ì—¬ë„ í‘œê¸° ëŒ€ìƒ)
  const penetration   = Number(wp.ignoreDef || 0)   + (lv.spear  * 0.10) + engrPen;
  const ignoreEvade   = Number(wp.ignoreEvade || 0) + (lv.bow    * 0.10) + engrIgnoreEv;
  const critRate      = Number(wp.critRate || 0)    + (lv.axe    * 0.10) + engrCritRate;
  const critDmgBonus  = Number(wp.critDmgBonus || 0)+ (lv.dagger * 0.10) + engrCritDmg;
  const huntMaxPlus   = (lv.staff * 2) + Math.max(0, engrHuntMaxPlus); // ìŠ¤íƒœí”„ íŒ¨ì‹œë¸Œ + ê°ì¸

  return {
    weaponType: wp.t,
    weaponTypeKor: weaponTypeKor(wp.t),
    dmgLabel: wp.dmgLabel,      // "ê³µê²©ë ¥" or "ì£¼ë¬¸ë ¥"
    mainPower,
    penetration,
    ignoreEvade,
    critRate,
    critDmgBonus,
    huntMaxPlus,
    huntGoldGainPct: engrHuntGoldPct,
    huntDropPct: engrHuntDropPct,
    huntRechargeMinusMin: engrHuntRechargeMinusMin,

    upgradeFailGoldRefundPct: engrUpgradeFailRefundPct,
    upgradeChancePlus: engrUpgradeChancePlus,

    bossShieldRemoveChance: engrBossShieldRemoveChance,
    bossFirstHitBonusPct: engrBossFirstHitBonusPct,
    bossExecuteBonusPct: engrBossExecuteBonusPct,
    bossRewardDropPct: engrBossRewardDropPct,
    bossShieldBreakDmgPct: engrBossShieldBreakDmgPct,

    passiveLv: lv
  };
}

function calcBossAttackResult(bossId){
  const stats = getBossBattleStats(bossId);

  // âœ… â€œë‚´ ìµœì¢…ìŠ¤íƒ¯(ì ˆëŒ€ìˆ˜ì¹˜)â€ ë¶ˆëŸ¬ì˜¤ê¸°
  const my = getPlayerFinalCombatStats();
  const wp = getBossWeaponProfile(); // label/dmgLabel ìš©ë„ë¡œ ìœ ì§€

  // âœ… ë³´ìŠ¤ ê°•í™” ë³´ì •(25~30)ì€ â€œë³´ìŠ¤ì—ì„œë§Œâ€ ì ìš©
  const swordLv = Number(sword || 0);
  const powerMul = getBossPowerMultiplier(bossId, swordLv);

  // âœ… ë³´ìŠ¤ì „ ê¸°ë³¸ ë°ë¯¸ì§€ = (ë‚´ ì ˆëŒ€ ë©”ì¸ìŠ¤íƒ¯) * (ë³´ìŠ¤ ë³´ì •)
  let dmg = Number(my.mainPower || 0) * powerMul;

  // âœ… ì„œë¦¬ì—¬ì™• ì „ìš©: ì£¼ë¬¸ë ¥ ë¬´ê¸°(ìŠ¤íƒœí”„) 10% ìƒìŠ¹
  if (bossId === "frost_queen" && my.weaponType === "staff") {
    dmg = dmg * 1.10;
  }

    // âœ… ê°ì¸: ë³´ìŠ¤ ì²´ë ¥ ì¡°ê±´ ë”œ ë³´ë„ˆìŠ¤(100% ì²«íƒ€ / 1% ì´í•˜ ë§‰íƒ€)
  try {
    const run = (bossRunsActiveCache || {})[bossId];
    const hpNow = Number(run && run.hp != null ? run.hp : 0);
    const hpMax = Number(run && run.maxHp != null ? run.maxHp : 0);

    if (hpMax > 0) {
      // 100%ì¼ ë•Œ ì²«íƒ€ê²© +500% â†’ (1 + 5.00) = 6ë°°
      if (hpNow >= hpMax) {
        const b = Number(my && my.bossFirstHitBonusPct ? my.bossFirstHitBonusPct : 0);
        if (b > 0) dmg = Math.floor(dmg * (1 + b / 100));
      }

      // 1% ì´í•˜ì¼ ë•Œ +400% â†’ (1 + 4.00) = 5ë°°
      const hpPct = (hpNow / hpMax) * 100;
      if (hpPct <= 1) {
        const b = Number(my && my.bossExecuteBonusPct ? my.bossExecuteBonusPct : 0);
        if (b > 0) dmg = Math.floor(dmg * (1 + b / 100));
      }
    }
  } catch (e) {}

  // 4) ë°©ì–´/ì €í•­
  const effPhysDef = Math.max(0, Number(stats.physDef || 0) - Number(my.penetration || 0));
  const effMagicRes = Math.max(0, Number(stats.magicRes || 0));

  if (my.weaponType === "staff") {
    dmg = dmg * (1 - effMagicRes);
  } else {
    dmg = dmg * (1 - effPhysDef);
  }

  // 5) ëœë¤ 85~100%
  const randMul = 0.85 + Math.random() * 0.15;
  dmg = Math.floor(dmg * randMul);

  // 6) íšŒí”¼(MISS)
  const effEvade = Math.max(0, Number(stats.evade || 0) - Number(my.ignoreEvade || 0));
  const isMiss = (Math.random() < effEvade);
  if (isMiss) {
    return { damage: 0, isMiss: true, isCrit: false, label: my.dmgLabel };
  }

  // 7) ì¹˜ëª…íƒ€
  const isCrit = (Math.random() < Number(my.critRate || 0));
  if (isCrit) {
    const cd = 0.20 + Number(my.critDmgBonus || 0); // ê¸°ë³¸ +20% + (ë¬´ê¸°/íŒ¨ì‹œë¸Œ)
    dmg = Math.floor(dmg * (1 + cd));
  }

  if (dmg < 0) dmg = 0;
  return { damage: dmg, isMiss: false, isCrit, label: my.dmgLabel };
}

// (ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš©: í˜¹ì‹œ ë‹¤ë¥¸ ê³³ì—ì„œ calcBossDamageBase()ë§Œ ë¶€ë¥´ëŠ” ê²½ìš° ëŒ€ë¹„)
function calcBossDamageBase(){
  const r = calcBossAttackResult(String(activeBossId || ""));
  return Number(r.damage || 0);
}

  // âœ… ë³´ìŠ¤ FX ë ˆì´ì–´ ì¢Œí‘œ ë³€í™˜(í´ë¦­ ì¢Œí‘œ â†’ ë³´ìŠ¤ ì´ë¯¸ì§€ ê¸°ì¤€ ì¢Œí‘œ)
function bossFxToLocalXY(clientX, clientY){
  const bossImg = document.getElementById("bossBattleBossImg");
  if (!bossImg) return null;
  const rect = bossImg.getBoundingClientRect();
  return {
    x: clientX - rect.left,
    y: clientY - rect.top
  };
}

// âœ… (ì‹ ê·œ) íƒ€ê²© ì´ë¯¸ì§€ ì´í™íŠ¸: ë³´ìŠ¤ í™”ë©´ ë‚´ë¶€(bossFxLayer)ì—ë§Œ ëœ¸
function spawnBossHitEffectAt(clientX, clientY, kind, isMagic){
  const layer = document.getElementById("bossFxLayer");
  if (!layer) return;

  const pos = bossFxToLocalXY(clientX, clientY);
  if (!pos) return;

  const idx = String(1 + Math.floor(Math.random() * 7)).padStart(2, "0");
  const src = isMagic
    ? `images/effects/boss_hit_mag_${idx}.png`
    : `images/effects/boss_hit_atk_${idx}.png`;

  const img = document.createElement("img");
  img.src = src;
  img.style.position = "absolute";
  img.style.left = pos.x + "px";
  img.style.top  = pos.y + "px";
  img.style.width = (kind === "crit") ? "88px" : "76px";
  img.style.height = img.style.width;
  img.style.transform = "translate(-50%, -50%) scale(0.85)";
  img.style.opacity = (kind === "miss") ? "0.55" : "0";
  img.style.pointerEvents = "none";
  img.style.zIndex = "20";
  img.style.filter = "drop-shadow(0 2px 6px rgba(0,0,0,0.85))";
  img.style.transition = "transform 520ms ease, opacity 520ms ease";

  layer.appendChild(img);

  requestAnimationFrame(() => {
    img.style.opacity = "1";
    img.style.transform = "translate(-50%, -50%) scale(1.15)";
  });

  setTimeout(() => {
    img.style.opacity = "0";
    img.style.transform = "translate(-50%, -50%) scale(1.00)";
  }, 240);

  setTimeout(() => img.remove(), 620);
}

// âœ… (ì‹ ê·œ) ë°ë¯¸ì§€/ë¯¸ìŠ¤ í…ìŠ¤íŠ¸: ë³´ìŠ¤ í™”ë©´ ë‚´ë¶€(bossFxLayer)ì—ë§Œ ëœ¸
function spawnBossDamageFloatAt(clientX, clientY, valueOrText, kind){
  const layer = document.getElementById("bossFxLayer");
  if (!layer) return;

  const pos = bossFxToLocalXY(clientX, clientY);
  if (!pos) return;

  const el = document.createElement("div");
  el.style.position = "absolute";
  el.style.left = pos.x + "px";
  el.style.top  = pos.y + "px";
  el.style.transform = "translate(-50%, -50%)";
  el.style.pointerEvents = "none";
  el.style.zIndex = "30";
  el.style.fontWeight = "900";
  el.style.whiteSpace = "nowrap";
  el.style.textShadow = "0 0 10px rgba(0,0,0,0.85)";
  el.style.opacity = "0";
  el.style.transition = "transform 900ms ease, opacity 900ms ease";

  if (kind === "miss") {
  el.textContent = "MISS";
  el.style.color = "#bdbdbd";
  el.style.fontSize = "18px";
  el.style.letterSpacing = "1px";
} else {
  const v = (typeof valueOrText === "number") ? formatDamageKoUnits(valueOrText) : String(valueOrText);

  // âœ… ì¹˜ëª…íƒ€ë©´ ëŠë‚Œí‘œ + ë” í¬ê²Œ + ë¹¨ê°„ìƒ‰ ê°•ì¡°
  if (kind === "crit") {
    el.textContent = v + "!";
    el.style.color = "#ff3b3b";
    el.style.fontSize = "24px";
  } else {
    el.textContent = v;
    el.style.color = "#ffd700";
    el.style.fontSize = "18px";
  }
}
     layer.appendChild(el);

  // âœ… ë– ì˜¤ë¥´ì§€ ì•Šê²Œ: ìœ„ì¹˜ ê³ ì • + 3ì´ˆ ìœ ì§€ + ì²œì²œíˆ í˜ì´ë“œì•„ì›ƒ
  const HOLD_MS = 1500;
  const FADE_MS = 3000;

  // 1) ë“±ì¥
  el.style.transform = "translate(-50%, 0) scale(0.95)";
el.style.transition = "opacity 180ms ease, transform 180ms ease";
requestAnimationFrame(() => {
  el.style.opacity = "1";
  el.style.transform = "translate(-50%, 0) scale(1)";
});

  // 2) 3ì´ˆ ìœ ì§€ í›„ ì„œì„œíˆ ì‚¬ë¼ì§
  setTimeout(() => {
    el.style.transition = `opacity ${FADE_MS}ms ease`;
    el.style.opacity = "0";
  }, HOLD_MS);

  // 3) ì œê±°
  setTimeout(() => el.remove(), HOLD_MS + FADE_MS + 80);
}

  // âœ… (ì¶”ê°€) ë³´ìŠ¤ ìì²´ í”ë“¤ë¦¼/ë²ˆì©/ìŠ¤íŒŒí¬(í´ë˜ìŠ¤ í† ê¸€)
function playBossHitFx(){
  const wrap = document.getElementById("bossBattleBossWrap");
  const img  = document.getElementById("bossBattleBossImg");
  if (!wrap || !img) return;

  // ê°™ì€ í´ë˜ìŠ¤ë¥¼ ì—°íƒ€í•´ë„ ë§¤ë²ˆ ì• ë‹ˆë©”ì´ì…˜ ì¬ìƒë˜ê²Œ ë¦¬ì…‹
  wrap.classList.remove("hit", "hit-spark");
  img.classList.remove("hit-flash");
  void wrap.offsetWidth; // reflow ê°•ì œ

  wrap.classList.add("hit", "hit-spark");
  img.classList.add("hit-flash");

  setTimeout(() => {
    wrap.classList.remove("hit", "hit-spark");
    img.classList.remove("hit-flash");
  }, 220);
}

function attackBossByClick(ev){
  const bossId = String(activeBossId || "");
  const run = (bossRunsActiveCache || {})[bossId];
  if (!bossId || !run || run.status !== "active") return;

  // ì‚¬ëƒ¥íšŸìˆ˜ ì†Œëª¨
  if (!consumeHuntPointForBoss()){
    showNpcMessage("ì˜¤ëŠ˜ ë‚¨ì€ ì‚¬ëƒ¥íšŸìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }
  
// âœ… ìŠ¤í…2 ë£°ë¡œ ê³µê²© ê²°ê³¼ ê³„ì‚°
const result = calcBossAttackResult(bossId);
const dmg = Number(result.damage || 0);

// âœ… (ì‹ ê·œ FX) ë³´ìŠ¤ í™”ë©´ ë‚´ë¶€ ì „ìš© ë ˆì´ì–´ì— ì´í™íŠ¸/ìˆ«ì ìƒì„±
const isMagic = (weaponType === "staff");
const kind = result.isMiss ? "miss" : (result.isCrit ? "crit" : "hit");

// âœ… (í‘œê¸°ìš© ë°ë¯¸ì§€) ì‹¤ë“œ ì¤‘ + ê³µê²©ë ¥ë¬´ê¸°ë©´ ìˆ«ìë„ 1ë¡œ ë³´ì´ê²Œ
let displayDmg = dmg;
{
  const isFrostQueen = (bossId === "frost_queen");
  const shieldHpNow  = Math.max(0, Number(run?.shieldHp || 0));
  const shieldMaxNow = Math.max(0, Number(run?.shieldMax || 0));
  const isStaff = (String(weaponType || "") === "staff");

  if (!result.isMiss && isFrostQueen && shieldMaxNow > 0 && shieldHpNow > 0 && !isStaff) {
    displayDmg = 1;
  }
}

playBossHitFx(); // âœ… ë³´ìŠ¤ í”ë“¤ë¦¼/ë²ˆì©/ìŠ¤íŒŒí¬

// íƒ€ê²© ì´ë¯¸ì§€
spawnBossHitEffectAt(ev.clientX, ev.clientY, kind, isMagic);

// íƒ€ê²© ìˆ«ì/ë¯¸ìŠ¤
if (result.isMiss) {
  spawnBossDamageFloatAt(ev.clientX, ev.clientY, "MISS", "miss");
} else {
  spawnBossDamageFloatAt(ev.clientX, ev.clientY, displayDmg, result.isCrit ? "crit" : "hit");
}

// âœ… MISSê°€ ì•„ë‹ ë•Œë§Œ ë³´ìŠ¤ í”¼ê²©(í”ë“¤ë¦¼/í”Œë˜ì‹œ) ì—°ì¶œ
if (!result.isMiss) playBossHitFx();

  // ì„œë²„ ë°˜ì˜(íŠ¸ëœì­ì…˜)
  if (dmg <= 0) return; // âœ… MISSë©´ ì‚¬ëƒ¥í¬ì¸íŠ¸ë§Œ ì†Œëª¨ë˜ê³  HP/ê¸°ì—¬ë„ëŠ” ì¦ê°€í•˜ì§€ ì•ŠìŒ
  const runRef = db.ref(`bossRunsActive/${bossId}`);
  runRef.transaction((cur) => {
    if (!cur || cur.status !== "active") return;

  // âœ… ì•„ë¥´ì…€ë¦¬ì•„ ë§ˆë‚˜ì‹¤ë“œ ë£°
let applied = dmg;

const isFrostQueen = (bossId === "frost_queen");

// âœ… ê°ì¸: ë³´ìŠ¤ì‹¤ë“œ ëª¨ë‘ì œê±° (1%/2%)
let shieldHp0 = Math.max(0, Number(cur.shieldHp || 0));
let shieldMax0 = Math.max(0, Number(cur.shieldMax || 0));

if (isFrostQueen && shieldMax0 > 0 && shieldHp0 > 0) {
  try {
    const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
    const p = Number(st && st.bossShieldRemoveChance ? st.bossShieldRemoveChance : 0);
    if (p > 0 && Math.random() < p) {
      cur.shieldHp = 0;
      cur.shieldMax = 0;
      shieldHp0 = 0;
      shieldMax0 = 0;
    }
  } catch (e) {}
}

if (isFrostQueen && shieldMax0 > 0 && shieldHp0 > 0) {
  const isMagic = (String(weaponType || "") === "staff");

  if (!isMagic) {
    // ê³µê²©ë ¥ ë¬´ê¸°: ë°ë¯¸ì§€ 1ë§Œ ë“¤ì–´ê°(ì‹¤ë“œì—ë„ ì˜í–¥ X, HPë„ ì˜í–¥ X)
    applied = 1;
    // ì‹¤ë“œê°€ ìˆëŠ” ë™ì•ˆì—” HPëŠ” ì ˆëŒ€ ì•ˆ ê¹ì´ê²Œ
  } else {
        // âœ… ê°ì¸: ë³´ìŠ¤ ë³´í˜¸ë§‰ íŒŒê´´ í”¼í•´ +30% (ì‹¤ë“œì— ë“¤ì–´ê°€ëŠ” ë°ë¯¸ì§€ ìì²´ë¥¼ ì¦ê°€)
    let shieldApplied = applied;
    try {
      const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
      const b = Number(st && st.bossShieldBreakDmgPct ? st.bossShieldBreakDmgPct : 0);
      if (b > 0) shieldApplied = Math.floor(applied * (1 + b / 100));
    } catch (e) {}

    const toShield = Math.min(shieldHp0, shieldApplied);
    cur.shieldHp = shieldHp0 - toShield;

    const left = shieldApplied - toShield;
    if (left > 0 && Number(cur.shieldHp || 0) <= 0) {
      cur.hp = Math.max(0, Number(cur.hp || 0) - left);
    }

    // âœ… ê¸°ì—¬ë„ë„ â€œê°•í™”ëœ ì‹¤ë“œ ë°ë¯¸ì§€ í¬í•¨â€
    applied = shieldApplied;
  }
} else {
  // ì¼ë°˜ ë³´ìŠ¤/ì‹¤ë“œ ì—†ìŒ: ê¸°ì¡´ëŒ€ë¡œ HP ê°ì†Œ
  cur.hp = Math.max(0, Number(cur.hp || 0) - applied);
}

// âœ… ê¸°ì—¬ë„ëŠ” â€œì‹¤ë“œì— ì¤€ ë°ë¯¸ì§€ í¬í•¨â€
// - ê³µê²©ë ¥ ë¬´ê¸°ë¼ë„ ì‹¤ë“œ ì¤‘ì—” applied=1ì´ë¯€ë¡œ ì•„ì£¼ ë¯¸ë¯¸í•˜ê²Œ í¬í•¨ë¨(ë„ˆ ìš”êµ¬ì‚¬í•­ê³¼ ì¼ì¹˜)
cur.members[userId].dmg = Number(cur.members[userId].dmg || 0) + applied;

    // (í† ë²Œ ì„±ê³µ ì²˜ë¦¬) - ë‹¤ìŒ ìŠ¤í…ì—ì„œ â€œìŠ¹ë¦¬ ì—°ì¶œ/ë³´ìƒ/ì¿¨íƒ€ì„â€ë¡œ í™•ì¥
    if (cur.hp <= 0) {
      cur.hp = 0;
      cur.status = "cleared";
      cur.clearedAt = Date.now();
    }

    return cur;
  });
}

// âœ… (ì‹ ê·œ) ë³´ìŠ¤ íƒ€ê²© FX íŒŒì¼ ê·œì¹™
// ë¬¼ë¦¬(ê²€/ì°½/í™œ/ë„ë¼): images/effects/hit_atk_01.png ~ hit_atk_07.png
// ë§ˆë²•(ìŠ¤íƒœí”„):        images/effects/hit_mag_01.png ~ hit_mag_07.png

function joinBossRunConfirm(bossId){
  const run = (bossRunsActiveCache || {})[bossId];
  if (!run || run.status !== "active") {
    showNpcMessage("ì´ë¯¸ ì¢…ë£Œëœ í† ë²Œì…ë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  // ì´ë¯¸ ë‹¤ë¥¸ ë³´ìŠ¤ì „ì— ê·€ì†ëœ ìƒíƒœ ë°©ì§€
  if (activeBossId && activeBossId !== bossId) {
    showNpcMessage("ì´ë¯¸ ë‹¤ë¥¸ í† ë²ŒëŒ€ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  // âœ… ì´ë¯¸ ì´ í† ë²ŒëŒ€ì— ì°¸ì—¬í–ˆëŠ”ì§€ "ì‹¤ë°ì´í„°(run.members)"ë¡œ ì²´í¬ (ìƒˆë¡œê³ ì¹¨ì—ë„ ì•ˆì „)
const alreadyMember = !!(run && run.status === "active" && run.members && run.members[userId]);

if (alreadyMember) {
  // ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ activeBossIdê°€ ë‚ ì•„ê°„ ì¼€ì´ìŠ¤ê¹Œì§€ ë³µêµ¬
  activeBossId = bossId;
  save();

  showNpcMessage("ì´ë¯¸ í•´ë‹¹ í† ë²ŒëŒ€ì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.\n(í† ë²Œ/ë³´ìƒì„ ì™„ë£Œí›„ ë‹¤ì‹œ ì‹œë„í•˜ì‹­ì‹œì˜¤)", LEON_IMG.idle, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
  return;
}

// âœ… ë‹¤ë¥¸ í† ë²ŒëŒ€ì— ì´ë¯¸ ê·€ì†ë˜ì–´ ìˆìœ¼ë©´ ì°¸ì—¬ ë¶ˆê°€(ì›í•˜ëŠ” ì •ì±…ì´ë©´ ìœ ì§€)
if (activeBossId && String(activeBossId) !== String(bossId)) {
  showNpcMessage("ì´ë¯¸ ë‹¤ë¥¸ í† ë²ŒëŒ€ì— ê·€ì†ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\ní˜„ì¬ í† ë²Œ ì¢…ë£Œ í›„ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
  return;
}

  const def = BOSS_DEFS.find(b => b.id === bossId);
  const bossLabel = def ? `${def.bossTitle} ${def.bossName}` : "í•´ë‹¹ ë³´ìŠ¤";

  const html = `
    <div style="font-size:14px; line-height:1.6;">
      <b>${bossLabel}</b> í† ë²Œì— ì •ë§ ì°¸ì—¬í•˜ê² ë‚˜?<br>
      <span style="color:#aaa;">â€» ì°¸ì—¬í•˜ë©´ í† ë²Œ ì¢…ë£Œ(ì„±ê³µ/ì‹¤íŒ¨)ê¹Œì§€ ì´íƒˆí•  ìˆ˜ ì—†ë‹¤.</span>
    </div>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button onclick="joinBossRun('${bossId}')" style="flex:1; padding:8px; font-size:14px; border-radius:8px;">âœ… ìˆ˜ë½</button>
      <button onclick="closeNpcPopup()" style="flex:1; padding:8px; font-size:14px; border-radius:8px;">âŒ ê±°ì ˆ</button>
    </div>
  `;

  showNpcMessage(html, LEON_IMG.focus, false, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
}
  
// âœ… ì°¸ì—¬í•˜ê¸°: ì°¸ì—¬ì ë“±ë¡(íŒŒí‹°ì¥ ë™ì˜ ì—†ì´)
function joinBossRun(bossId) {
   closeNpcPopup();
  const run = (bossRunsActiveCache || {})[bossId];
  if (!run || run.status !== "active") {
    showNpcMessage("ì´ë¯¸ ì¢…ë£Œëœ í† ë²Œì…ë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

    // âœ… ë‹¤ë¥¸ ë³´ìŠ¤ì— ì´ë¯¸ ì°¸ì—¬ì¤‘ì´ë©´ ì°¨ë‹¨
  const curId = String(activeBossId || "");
  if (curId && curId !== String(bossId)) {
    const curRun = (bossRunsActiveCache || {})[curId];
    const curName = curRun
      ? `${String(curRun.bossTitle || "").trim()} ${String(curRun.bossName || "").trim()}`.trim()
      : "ë‹¤ë¥¸ ë³´ìŠ¤";

    showNpcMessage(
      `
      <div style="font-size:13px; line-height:1.6;">
        ì´ë¯¸ ë‹¤ë¥¸ ë³´ìŠ¤ í† ë²ŒëŒ€ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤.<br>
        <b>${curName || "ë‹¤ë¥¸ ë³´ìŠ¤"}</b><br><br>
        í˜„ì¬ ì°¸ì—¬ì¤‘ì¸ ë³´ìŠ¤ì „ì„ <b>ì™„ë£Œ</b>í•˜ê±°ë‚˜ <b>í¬ê¸°</b>í•œ ë’¤ ë‹¤ì‹œ ì‹ ì²­í•´ì£¼ì„¸ìš”.
      </div>
      `,
      LEON_IMG.focus,
      true,
      "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ"
    );
    return;
  }

  // ì°¸ì—¬ ì¤‘ì¸ í† ë²Œì€ ì €ì¥(ë‹¤ìŒ ë‹¨ê³„ì—ì„œ 'ë³´ìŠ¤ì „ ë²„íŠ¼' ë„ìš°ëŠ” ì¡°ê±´ìœ¼ë¡œ ì‚¬ìš©)
  activeBossId = bossId;
  save();

  const memberRef = db.ref(`bossRunsActive/${bossId}/members/${userId}`);
 memberRef.transaction((cur) => {
  // âœ… ì´ë¯¸ ì°¸ì—¬ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì ˆëŒ€ ë®ì–´ì“°ì§€ ì•ŠìŒ (dmg ë¦¬ì…‹ ë°©ì§€)
  if (cur) return;

    return {
    uid: userId,
    nick: getNickSafe(),
    joinedAt: Date.now(),
    dmg: 0,

    // âœ… í‘œê¸°ìš© ìŠ¤ëƒ…ìƒ·(ìš°ì¸¡ í† ë²ŒëŒ€ ë¦¬ìŠ¤íŠ¸)
    titleId: String(equippedTitle || ""),     // ì—†ìœ¼ë©´ "" (í‘œê¸° ì•ˆ í•¨)
    weaponType: String(weaponType || "sword"),// "sword/spear/axe/bow/staff"
    weaponLv: Number(sword || 0)              // í˜„ì¬ êµ¬ì¡°ìƒ ê°•í™” ìˆ˜ì¹˜ëŠ” swordë¡œ í†µì¼
  };
});
 
  // âœ… ë³´ìŠ¤ì „ ì „ìš© ë¡œê·¸
writeBossBattleLog(bossId, `${getNickSafe()}ë‹˜ì´ í† ë²ŒëŒ€ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`);

  showNpcMessage(
    `
    <div style="font-size:14px; line-height:1.6;">
      í† ë²ŒëŒ€ì— ì°¸ì—¬ ì™„ë£Œ.<br>
      <span style="color:#aaa;">â€» ë©”ì¸í™”ë©´ì— ë³´ìŠ¤ì „ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
    </div>
    `,
    LEON_IMG.idle,
    true,
    "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ"
  );
}

// âœ… ì‹ ì²­í•˜ê¸°(í† ë²Œ ìƒì„±): gold ì°¨ê° â†’ activeRun ìƒì„±(ì¤‘ë³µì´ë©´ í™˜ë¶ˆ)
function createBossRun(bossId) {
  const def = BOSS_DEFS.find(b => b.id === bossId);
  if (!def) return;

  // âœ… ë‹¤ë¥¸ ë³´ìŠ¤ì— ì´ë¯¸ ì°¸ì—¬ì¤‘ì´ë©´ ì‹ ì²­(í† ë²Œ ìƒì„±) ë¶ˆê°€
  const curId = String(activeBossId || "");
  if (curId && curId !== String(bossId)) {
    const curRun = (bossRunsActiveCache || {})[curId];
    const curName = curRun
      ? `${String(curRun.bossTitle || "").trim()} ${String(curRun.bossName || "").trim()}`.trim()
      : "ë‹¤ë¥¸ ë³´ìŠ¤";

    showNpcMessage(
      `
      <div style="font-size:13px; line-height:1.6;">
        ì´ë¯¸ ë‹¤ë¥¸ ë³´ìŠ¤ í† ë²ŒëŒ€ì— ì°¸ì—¬ì¤‘ì…ë‹ˆë‹¤.<br>
        <b>${curName || "ë‹¤ë¥¸ ë³´ìŠ¤"}</b><br><br>
        í˜„ì¬ ë³´ìŠ¤ì „ì„ <b>ì™„ë£Œ</b>í•˜ê±°ë‚˜ <b>í¬ê¸°</b>í•œ ë’¤ ë‹¤ì‹œ ì‹ ì²­í•´ì£¼ì„¸ìš”.
      </div>
      `,
      LEON_IMG.focus,
      true,
      "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ"
    );
    return;
  }
  
  // 1) ì¡°ê±´ ì²´í¬
  if (Number(sword || 0) < def.minSword) {
    showNpcMessage(`ì¡°ê±´ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: +${def.minSword}ê°•)`, LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  const userGoldRef = db.ref(`users/${userId}/gold`);

  // 2) ë¨¼ì € ê³¨ë“œ ì°¨ê°(íŠ¸ëœì­ì…˜)
  userGoldRef.transaction((g) => {
    g = Number(g || 0);
    if (g < def.applyCostGold) return; // abort
    return g - def.applyCostGold;
  }, (err, committed) => {
    if (err) {
      console.error(err);
      showNpcMessage("ì„œë²„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
      return;
    }
    if (!committed) {
      showNpcMessage(`ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${formatGold(def.applyCostGold)} ê³¨ë“œ)`, LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
      return;
    }

    // 3) ActiveRun ìƒì„±(ì´ë¯¸ ìˆìœ¼ë©´ ì‹¤íŒ¨)
    const runRef = db.ref(`bossRunsActive/${bossId}`);
    const now = Date.now();
    const endsAt = now + def.durationHours * 60 * 60 * 1000;

    runRef.transaction((cur) => {
      if (cur && cur.status === "active") return; // abort
      return {
        bossId: def.id,
        mapName: def.mapName,
        bossTitle: def.bossTitle,
        bossName: def.bossName,
        desc: String(def.desc || ""),

        status: "active",
        logKey: "run_" + Date.now(),
        createdAt: now,
        endsAt: endsAt,

       // 1í˜ì´ì¦ˆ: ì²´ë ¥ë§Œ ê¹ê¸°
maxHp: Number(def.maxHp || 1),
hp: Number(def.maxHp || 1),

// âœ… (ì•„ë¥´ì…€ë¦¬ì•„ ì „ìš©) ë§ˆë‚˜ì‹¤ë“œ ì´ˆê¸°ê°’ (ì—†ìœ¼ë©´ 0)
shieldMax: (bossId === "frost_queen") ? 30000000000 : 0,
shieldHp:  (bossId === "frost_queen") ? 0 : 0,
lastManaShieldTryAt: 0,   // 2ì‹œê°„ ì£¼ê¸° ì²´í¬ìš©

        leaderUid: userId,
        leaderNick: getNickSafe(),

        members: {
  [userId]: {
    uid: userId,
    nick: getNickSafe(),
    joinedAt: now,
    dmg: 0,

    // âœ… í‘œê¸°ìš© ìŠ¤ëƒ…ìƒ·
    titleId: String(equippedTitle || ""),
    weaponType: String(weaponType || "sword"),
    weaponLv: Number(sword || 0)
  }
},

        lastAttackAt: 0
      };
    }, (err2, committed2) => {
      if (err2) {
        console.error(err2);
      }

      if (!committed2) {
        // 4) ì´ë¯¸ ì§„í–‰ì¤‘ì´ë©´ í™˜ë¶ˆ
        userGoldRef.transaction((g) => Number(g || 0) + def.applyCostGold);
        showNpcMessage(
          "ì´ë¯¸ ì§„í–‰ì¤‘ì¸ í† ë²Œì´ ìˆìŠµë‹ˆë‹¤.\n(ì†Œëª¨ëœ ê³¨ë“œëŠ” í™˜ë¶ˆ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.)",
          LEON_IMG.focus,
          true,
          "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ"
        );
        return;
      }

      // 5) ì„±ê³µ: ë³¸ì¸ ìë™ ì°¸ì—¬ ì²˜ë¦¬
      activeBossId = bossId;
      save();

      writeLog(`${userNick}ë‹˜ì´ ${bossName} í† ë²Œì„ ì‹œì‘í•˜ì˜€ìŠµë‹ˆë‹¤.`, false, { tone: "boss_apply" });
      writeBossBattleLog(bossId, `í† ë²ŒëŒ€ê°€ ê²°ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. (ëŒ€ì¥: ${getNickSafe()})`);

      showNpcMessage(
        `
        <div style="font-size:14px; line-height:1.6;">
          âœ… í† ë²Œì´ ì‹œì‘ëë‹¤.<br>
          ì¤‘ì•™ ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ë  ê±°ë‹¤.<br>
          <span style="color:#aaa;">ì´ì œ â€˜ë³´ìŠ¤ì „ ë²„íŠ¼â€™ê³¼ ì‹¤ì œ ì „íˆ¬ í™”ë©´ì„ ë¶™ì´ëŠ” ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ì.</span>
        </div>
        `,
        LEON_IMG.apply,
        true,
        "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ"
      );
    });
  });
}

// âœ… ë³´ìŠ¤ ì‹ ì²­ ë¦¬ìŠ¤íŠ¸ íŒì—…(í™•ì¥í˜•)
function openBossApplyList() {
  let html = `
    <div style="font-size:14px; font-weight:bold; margin-bottom:8px;">
      ğŸ—¡ï¸ í† ë²Œ ëŒ€ìƒ ëª©ë¡
    </div>
    <div style="font-size:12px; color:#aaa; margin-bottom:10px; line-height:1.4;">
         í† ë²Œ ì‹ ì²­ìëŠ” ìë™ìœ¼ë¡œ í† ë²ŒëŒ€ì— ì°¸ì—¬í•©ë‹ˆë‹¤.
    </div>
  `;

  BOSS_DEFS.forEach(def => {
    const run = (bossRunsActiveCache || {})[def.id];
    const isActive = !!(run && run.status === "active");

    const cd = (bossCooldownCache || {})[def.id];
    const nextAtRaw = cd ? cd.nextAt : 0;
let nextAt = 0;

if (typeof nextAtRaw === "number") nextAt = nextAtRaw;
else if (typeof nextAtRaw === "string") nextAt = Number(nextAtRaw);
else nextAt = 0;

if (!Number.isFinite(nextAt)) nextAt = 0;

const remainMs = Math.max(0, nextAt - Date.now());
const cooldownTxt = formatHMS(remainMs);
    const canApplyBySword = (Number(sword || 0) >= def.minSword);
    const canApplyByCooldown = (remainMs <= 0);
    const canApply = canApplyBySword && canApplyByCooldown && !isActive;
    
    // âœ… ìƒíƒœë³„ ë²„íŠ¼ í…ìŠ¤íŠ¸/ë¹„í™œì„± ê³„ì‚°
let btnText = "âœ… ì‹ ì²­í•˜ê¸°";
let disabled = false;

// (ì¡°ê±´: ê°•í™”)
if (!canApplyBySword) {
  btnText = `ğŸ”’ ì‹ ì²­ ë¶ˆê°€ (ì¡°ê±´: ${def.minSword}ê°• ì´ìƒ)`;
  disabled = true;
}
// (ì§„í–‰ì¤‘)
else if (isActive) {
  btnText = `â³ ì§„í–‰ì¤‘ì¸ í† ë²Œì´ ìˆìŠµë‹ˆë‹¤`;
  disabled = true;
}
// (ì¿¨íƒ€ì„)
else if (!canApplyByCooldown) {
  btnText = `â³ ì‹ ì²­ ëŒ€ê¸°ì¤‘`;
  disabled = true;
}
    
    html += `
      <div style="border:1px solid #444; border-radius:8px; padding:10px; margin-bottom:8px; background:rgba(0,0,0,0.35);">
        <div style="font-weight:bold; margin-bottom:4px;">
          ${def.mapName} Â· ${def.bossTitle} <span style="color:#ddd;">${def.bossName}</span>
        </div>
        
        <div style="font-size:12px; color:#aaa; margin-bottom:8px;">
          â³ ì‹ ì²­ ê°€ëŠ¥ê¹Œì§€: <b style="color:#ddd;">${cooldownTxt}</b>
          ${isActive ? `<span style="margin-left:8px; color:#ff6b6b; font-weight:bold;">(ì§„í–‰ì¤‘)</span>` : ""}
        </div>

        <button
  ${disabled ? "disabled" : ""}
  onclick="${disabled ? "" : `openBossApplyConfirm('${def.id}')`}"
  style="
    width:100%;
    padding:8px 10px;
    font-size:14px;
    border-radius:8px;
    ${disabled ? "opacity:0.4; cursor:not-allowed;" : ""}
  ">
  ${btnText}
</button>

      </div>
    `;
  });

  showNpcMessage(
    html,
    LEON_IMG.apply,
    true,
    "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸"
  );
}

  function openBossRewardOverlay(){
  const bossId = String(activeBossId || "");
  const run = bossId ? (bossRunsActiveCache || {})[bossId] : null;

  if (!bossId || !run) {
    showNpcMessage("ì§‘ê³„í•  í† ë²Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  const st = String(run.status || "");
  if (st === "active") {
    showNpcMessage("í† ë²Œì´ ì•„ì§ ì§„í–‰ ì¤‘ì´ë‹¤. ëë‚œ ë’¤ì— ì§‘ê³„ë¥¼ í™•ì¸í•´ë¼.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  // âœ… ê¸°ì—¬ë„ ê³„ì‚°
  const members = run.members || {};
  const arr = Object.keys(members).map(uid => ({
    uid,
    dmg: Number(members[uid] && members[uid].dmg ? members[uid].dmg : 0),
    nick: (members[uid] && members[uid].nick) ? members[uid].nick : uid,
    title: (members[uid] && members[uid].title) ? members[uid].title : ""
  }));

  const total = arr.reduce((s, a) => s + a.dmg, 0);
  arr.sort((a,b) => b.dmg - a.dmg);

  const myIndex = arr.findIndex(x => x.uid === userId);
  const myRank = (myIndex >= 0) ? (myIndex + 1) : 0;
  const myPct = (myIndex >= 0 && total > 0) ? (arr[myIndex].dmg / total * 100) : 0;

  // UI ì„¸íŒ…
  const overlay = document.getElementById("bossRewardOverlay");
  const listEl  = document.getElementById("bossRewardList");
  const sumEl   = document.getElementById("bossRewardSummary");
  const lineEl  = document.getElementById("bossRewardLeonLine");

  const claimBtn = document.getElementById("bossRewardClaimBtn");
  const giveUpBtn = document.getElementById("bossRewardGiveUpBtn");

  if (!overlay || !listEl || !sumEl || !lineEl || !claimBtn || !giveUpBtn) return;

  const def = (BOSS_DEFS || []).find(d => String(d.id) === bossId);

  const bossTitle = def ? def.bossTitle : "ë³´ìŠ¤";
  const resultTxt = (st === "cleared") ? "âœ… í† ë²Œ ì„±ê³µ" : "âŒ í† ë²Œ ì‹¤íŒ¨";

    const myContribHtml = (myRank > 0)
    ? `<div style="font-size:20px; font-weight:900; color:#ffd54f; letter-spacing:0.2px;">${myPct.toFixed(1)}% Â· ${myRank}ìœ„</div>`
    : `<div style="font-size:14px; color:#bbb;">ê¸°ë¡ ì—†ìŒ</div>`;

  sumEl.innerHTML = `
    <div style="font-weight:900; color:#fff; margin-bottom:4px;">${bossTitle} Â· ${resultTxt}</div>
    <div style="color:#aaa;">ì´ í”¼í•´ëŸ‰: <b style="color:#fff;">${formatGold(total)}</b></div>

    <div style="margin-top:8px; padding:10px; border:1px solid rgba(255,255,255,0.14); border-radius:14px; background:rgba(255,255,255,0.06);">
      <div style="font-size:12px; color:#aaa; margin-bottom:4px;">ë‚´ ê¸°ì—¬ë„</div>
      ${myContribHtml}
    </div>
  `;

  // ë¦¬ìŠ¤íŠ¸(ìƒìœ„ 20ë§Œ í‘œì‹œ â€” ìŠ¤í¬ë¡¤)
  listEl.innerHTML = "";
  const maxShow = Math.min(arr.length, 50);
  const topDmg = (arr[0] && arr[0].dmg) ? arr[0].dmg : 1; // âœ… 1ë“± ë”œëŸ‰ ê¸°ì¤€(LoL ê·¸ë˜í”„)

  for (let i=0; i<maxShow; i++){
    const m = arr[i];
    const pct = (total > 0) ? (m.dmg / total * 100) : 0;
    const isMe = (m.uid === userId);
    const row = document.createElement("div");
    const bossLeaderId = (run && run.leaderUid) ? run.leaderUid : "";
    const isLeader = (bossLeaderId && m.uid === bossLeaderId);
    row.style.display = "flex";
    row.style.alignItems = "center";
    row.style.gap = "10px";
    row.style.padding = "8px 8px";
    row.style.borderBottom = "1px solid rgba(255,255,255,0.08)";

    if (isMe) {
      row.style.background = "rgba(255,255,255,0.08)";
      row.style.borderRadius = "12px";
      row.style.margin = "4px 0";
      row.style.borderBottom = "none";
      row.style.fontWeight = "900";
    }

    // âœ… ì¢Œì¸¡: ë­í¬/ë‹‰ë„¤ì„
    const left = document.createElement("div");
    left.style.width = "170px";
    left.style.flex = "0 0 170px";
    left.style.fontSize = "13px";
    left.style.whiteSpace = "nowrap";
    left.style.overflow = "hidden";
    left.style.textOverflow = "ellipsis";
    const crown = isLeader ? `<span style="margin-right:4px;">ğŸ‘‘</span>` : "";
left.innerHTML = `${crown}<span style="color:#aaa;">${i+1}ìœ„</span> ${m.nick}`;

    // âœ… ê°€ìš´ë°: LoL ëŠë‚Œ ë”œëŸ‰ ê·¸ë˜í”„(1ë“± ê¸°ì¤€)
    const mid = document.createElement("div");
    mid.style.flex = "1";
    mid.style.minWidth = "140px";

    const track = document.createElement("div");
    track.style.height = "12px";
    track.style.borderRadius = "999px";
    track.style.background = "rgba(255,255,255,0.10)";
    track.style.border = "1px solid rgba(255,255,255,0.10)";
    track.style.overflow = "hidden";

    const fill = document.createElement("div");
    const ratio = Math.max(0, Math.min(1, topDmg > 0 ? (m.dmg / topDmg) : 0));
    fill.style.width = `${Math.max(2, Math.round(ratio * 100))}%`; // ìµœì†Œ 2% ë³´ì´ê²Œ
    fill.style.height = "100%";
    fill.style.borderRadius = "999px";
    fill.style.transition = "width 260ms ease";

    // âœ… ìƒ‰ì€ â€œë‚˜â€ë§Œ ë” ê°•ì¡°(LoLì²˜ëŸ¼ ëˆˆì— ë„ê²Œ)
    fill.style.background = isMe ? "rgba(255,213,79,0.90)" : "rgba(160,200,255,0.75)";
    fill.style.position = "relative";
    fill.style.zIndex = "1";

    // ğŸ… 1ë“± MVP ë±ƒì§€ (ë§‰ëŒ€ ë)
if (i === 0) {
  const mvp = document.createElement("div");
  mvp.textContent = "MVP";
  mvp.style.position = "absolute";
  mvp.style.right = "6px";
  mvp.style.top = "50%";
  mvp.style.transform = "translateY(-50%)";
  mvp.style.fontSize = "10px";
  mvp.style.fontWeight = "900";
  mvp.style.padding = "2px 6px";
  mvp.style.borderRadius = "999px";
  mvp.style.background = "rgba(255,213,79,0.95)";
  mvp.style.color = "#111";
  mvp.style.boxShadow = "0 0 10px rgba(255,213,79,0.35)";
  mvp.style.zIndex = "3";

  // trackì— absolute ì˜¬ë¦¬ë ¤ë©´ position í•„ìš”
  track.style.position = "relative";
  track.appendChild(mvp);
}
    
    track.appendChild(fill);
    mid.appendChild(track);

    // âœ… ìš°ì¸¡: % + ë”œëŸ‰ ìˆ«ì(ê¸°ì¡´ ìœ ì§€)
    const right = document.createElement("div");
    right.style.width = "140px";
    right.style.flex = "0 0 140px";
    right.style.textAlign = "right";
    right.style.fontSize = "12px";
    right.style.color = "#ddd";
    right.innerHTML = `<b>${pct.toFixed(1)}%</b><div style="color:#aaa; font-size:11px;">${formatGold(m.dmg)}</div>`;

    row.appendChild(left);
    row.appendChild(mid);
    row.appendChild(right);
    listEl.appendChild(row);
  }

    // ë ˆì˜¨ ë©˜íŠ¸ (1ë“±/í•˜ìœ„ê¶Œ íŠ¹ìˆ˜)
  if (st === "cleared") {
    const totalMembers = arr.length;
    const isTop = (myRank === 1);
    const isBottom = (myRank > 0 && myRank === totalMembers);

    if (myRank <= 0) {
      lineEl.innerHTML = `ì§‘ê³„ì— ë„¤ ê¸°ë¡ì´ ë³´ì´ì§€ ì•ŠëŠ”êµ°â€¦ í•˜ì§€ë§Œ í† ë²Œì€ ëë‚¬ë‹¤.`;
    } else if (isTop) {
      lineEl.innerHTML =
        `ì´ë²ˆ í† ë²Œì‘ì „ì—ì„œ <b style="color:#ffd54f;">ìœ„ëŒ€í•œ ì—…ì </b>ì„ ë‚¨ê²¼êµ°. `
        + `ë„¤ ê¸°ì—¬ë„ëŠ” <b style="color:#ffd54f; font-size:18px;">${myPct.toFixed(1)}%</b>, `
        + `<b style="color:#ffd54f; font-size:18px;">${myRank}ìœ„</b>ë‹¤. ë³´ìƒì„ ìˆ˜ë ¹í•˜ê² ë‚˜?`;
    } else if (isBottom) {
      lineEl.innerHTML =
        `ìë„¤ì˜ ê¸°ì—¬ê°€ <b style="color:#bbb;">í° í¸ì€ ì•„ë‹ˆì§€ë§Œ</b>, í•¨ê»˜ ëê¹Œì§€ ë²„í…¼ë‹¤. `
        + `ë„¤ ê¸°ì—¬ë„ëŠ” <b style="color:#ffd54f; font-size:18px;">${myPct.toFixed(1)}%</b>, `
        + `<b style="color:#ffd54f; font-size:18px;">${myRank}ìœ„</b>ë‹¤. ë³´ìƒì„ ìˆ˜ë ¹í•˜ê² ë‚˜?`;
    } else {
      lineEl.innerHTML =
        `ë„¤ ê¸°ì—¬ë„ëŠ” <b style="color:#ffd54f; font-size:18px;">${myPct.toFixed(1)}%</b>ë¡œ `
        + `<b style="color:#ffd54f; font-size:18px;">${myRank}ìœ„</b>ë‹¤. ë³´ìƒì„ ìˆ˜ë ¹í•˜ê² ë‚˜?`;
    }
  } else {
    lineEl.innerHTML = `ì™„ë²½í•œ ì „ëµ, ì „ìˆ ì˜ ì‹¤íŒ¨ë‹¤. ì ì„ ë„ˆë¬´ ê³¼ì†Œí‰ê°€í–ˆêµ°. í¬ê¸°í•˜ê³  ì¬ì •ë¹„í•˜ê² ë‚˜?`;
  }

  // ë²„íŠ¼ í† ê¸€
  const claimedMap = run.claimed || {};
  const already = !!claimedMap[userId];

  claimBtn.style.display = (st === "cleared" && !already) ? "inline-block" : "none";
  giveUpBtn.style.display = (st === "failed") ? "inline-block" : "none";

  overlay.style.display = "block";
}

function closeBossRewardOverlay(){
  const overlay = document.getElementById("bossRewardOverlay");
  if (overlay) overlay.style.display = "none";
}

// âœ… ë³´ìƒ í…Œì´ë¸”(ë³´ìŠ¤ë³„ ì ìš©)
function getBossRewardByPct(bossId, pct, isLeader){
  bossId = String(bossId || "");
  // pct: 0~100
  const reward = {
    itemProtect: 0,
    itemDownProtect: 0,
    itemScroll21: 0,
    itemScroll15: 0,
    itemEssence: 0,    // ğŸŸ£ ë§ˆë ¥ì˜ ì •ìˆ˜
    itemSuper: 0,       // ğŸŸ¡ ìŠˆí¼ê°•í™”ì£¼ë¬¸ì„œ(ëŒ€ì¥ ë³´ë„ˆìŠ¤ í¬í•¨ìš©)
    itemEngraveNormal: 0,
    itemEngraveAdvanced: 0
  };

  // =========================
  // 1) ì‹¤ë°”ë‚˜ ë¦´ë¦¬ì•„ë„¤(ê¸°ì¡´ í…Œì´ë¸” ìœ ì§€)
  // =========================
  if (bossId === "swamp_elf_queen") {

    if (pct >= 30) {
      reward.itemProtect += 2;
      reward.itemDownProtect += 5;
      reward.itemEssence += 50;
    } else if (pct >= 25) {
      reward.itemProtect += 1;
      reward.itemDownProtect += 3;
      reward.itemEssence += 30;
    } else if (pct >= 20) {
      reward.itemScroll21 += 2;
      reward.itemDownProtect += 5;
      reward.itemEssence += 20;
    } else if (pct >= 10) {
      reward.itemDownProtect += 5;
      reward.itemEssence += 10;
    } else if (pct >= 1) {
      reward.itemScroll15 += 1;
      reward.itemEssence += 5;
    } else {
      reward.itemEssence += 1;
    }

    // âœ… ì¶”ê°€: ì‹¤ë°”ë‚˜ ê°ì¸ ì£¼ë¬¸ì„œ ë³´ìƒ
if (pct >= 30) {
  reward.itemEngraveAdvanced += 3;
} else if (pct >= 25) {
  reward.itemEngraveAdvanced += 1;
} else if (pct >= 20) {
  reward.itemEngraveNormal += 3;
} else if (pct >= 10) {
  reward.itemEngraveNormal += 1;
}

  // =========================
  // 2) ì„œë¦¬ì—¬ì™• ì•„ë¥´ì…€ë¦¬ì•„(ì‹ ê·œ í…Œì´ë¸”)
  // =========================
  } else if (bossId === "frost_queen") {

    if (pct >= 30) {
      reward.itemProtect += 3;
      reward.itemEssence += 80;
    } else if (pct >= 25) {
      reward.itemProtect += 2;
      reward.itemEssence += 50;
    } else if (pct >= 20) {
      reward.itemProtect += 1;
      reward.itemEssence += 30;
    } else if (pct >= 10) {
      reward.itemScroll21 += 3;
      reward.itemEssence += 20;
    } else if (pct >= 1) {
      reward.itemScroll15 += 5;
      reward.itemDownProtect += 3;
      reward.itemEssence += 10;
    } else {
      reward.itemDownProtect += 2;
      reward.itemEssence += 5;
    }
    
    // âœ… ì¶”ê°€: ì„œë¦¬ì—¬ì™• ê°ì¸ ì£¼ë¬¸ì„œ ë³´ìƒ
if (pct >= 30) {
  reward.itemEngraveAdvanced += 4;
} else if (pct >= 25) {
  reward.itemEngraveAdvanced += 1;
  reward.itemEngraveNormal += 3;
} else if (pct >= 20) {
  reward.itemEngraveNormal += 5;
} else if (pct >= 10) {
  reward.itemEngraveNormal += 3;
}

  } else {
    // âœ… í˜¹ì‹œ ëª¨ë¥¼ ê¸°ë³¸ê°’(ì •ì˜ë˜ì§€ ì•Šì€ ë³´ìŠ¤)
    reward.itemEssence += 1;
  }

  // âœ… í† ë²ŒëŒ€ì¥ ë³´ë„ˆìŠ¤(ì•„ë¥´ì…€ë¦¬ì•„ ìš”êµ¬ì‚¬í•­: ìŠˆí¼ 1ê°œ + ì •ìˆ˜ 30ê°œ)
  if (isLeader) {
    reward.itemSuper += 1;
    reward.itemEssence += 30;
  }

  return reward;
}

function claimBossReward(){
  const bossId = String(activeBossId || "");
  if (!bossId) return;

  const runRef = db.ref(`bossRunsActive/${bossId}`);

  runRef.transaction((cur) => {
    if (!cur) return;
    const st = String(cur.status || "");
    if (st !== "cleared") return;                // ì„±ê³µì¼ ë•Œë§Œ ìˆ˜ë ¹
    if (!cur.members || !cur.members[userId]) return;

    if (!cur.claimed) cur.claimed = {};
    if (cur.claimed[userId]) return;             // ì¤‘ë³µ ìˆ˜ë ¹ ë°©ì§€

    cur.claimed[userId] = Date.now();
    return cur;
  }, (err, committed, snap) => {
    if (err || !committed) {
      showNpcMessage("ë³´ìƒ ìˆ˜ë ¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
      return;
    }

    const run = snap && snap.val ? snap.val() : null;
    if (!run) return;

    // âœ… ê¸°ì—¬ë„ ê³„ì‚°
    const members = run.members || {};
    const arr = Object.keys(members).map(uid => ({
      uid,
      dmg: Number(members[uid] && members[uid].dmg ? members[uid].dmg : 0)
    }));
    const total = arr.reduce((s,a) => s + a.dmg, 0);
    const me = arr.find(x => x.uid === userId);
    const pct = (me && total > 0) ? (me.dmg / total * 100) : 0;

    const isLeader = (String(run.leaderUid || "") === userId);
   const rw = getBossRewardByPct(bossId, pct, isLeader);
       // âœ… ê°ì¸: ë³´ìŠ¤ì „ ë³´ìƒ ë“œëë¥  +15/+20 â†’ ì¶”ê°€ ë“œë(í™•ë¥ í˜• ë³´ë„ˆìŠ¤)
   try {
     const st = (typeof getPlayerFinalCombatStats === "function") ? getPlayerFinalCombatStats() : null;
     const bonusPct = Number(st && st.bossRewardDropPct ? st.bossRewardDropPct : 0);

     if (bonusPct > 0) {
       const p = bonusPct / 100;

       // ì‘ì€ ì•„ì´í…œë¥˜: ê°œìˆ˜ë§Œí¼ â€œì¶”ê°€ 1ê°œâ€ í™•ë¥  ë¡¤
       const keys = ["itemProtect","itemDownProtect","itemScroll21","itemScroll15","itemSuper"];
       for (const k of keys) {
         const c = Number(rw[k] || 0);
         if (c > 0) {
           let extra = 0;
           for (let i=0; i<c; i++) if (Math.random() < p) extra++;
           rw[k] = c + extra;
         }
       }

       // ì •ìˆ˜(ëŒ€ëŸ‰): ë¹„ìœ¨ ë³´ë„ˆìŠ¤ ë°©ì‹(ê°€ë³ê²Œ)
       const ess = Number(rw.itemEssence || 0);
       if (ess > 0) {
         const add = ess * p;
         const addInt = Math.floor(add);
         const addFrac = add - addInt;
         rw.itemEssence = ess + addInt + (Math.random() < addFrac ? 1 : 0);
       }
     }
   } catch (e) {}

    // âœ… ë¡œì»¬ ë³´ìƒ ì§€ê¸‰(ì•„ì´í…œ ë³€ìˆ˜ ì¦ê°€)
    itemProtect = Number(itemProtect || 0) + (rw.itemProtect || 0);
    itemDownProtect = Number(itemDownProtect || 0) + (rw.itemDownProtect || 0);
    itemScroll21 = Number(itemScroll21 || 0) + (rw.itemScroll21 || 0);
    itemScroll15 = Number(itemScroll15 || 0) + (rw.itemScroll15 || 0);
    itemEssence = Number(itemEssence || 0) + (rw.itemEssence || 0);
    itemSuper = Number(itemSuper || 0) + (rw.itemSuper || 0);
    itemEngraveNormal = Number(itemEngraveNormal || 0) + (rw.itemEngraveNormal || 0);
    itemEngraveAdvanced = Number(itemEngraveAdvanced || 0) + (rw.itemEngraveAdvanced || 0);
    save(); // âœ… ë³´ìƒ(ì•„ì´í…œ) ì§€ê¸‰ ì €ì¥ í™•ì •

    // âœ… ë³´ìŠ¤ í† ë²Œ 1íšŒ ì„±ê³µ ì¹­í˜¸ ì§€ê¸‰ (1íšŒë§Œ)
    grantTitleOnceNoSave("boss_raider")

    // âœ… ë‚´ ê·€ì† í•´ì œ (ë³´ìƒ ìˆ˜ë ¹ ì „ì—” ê³„ì† ê·€ì†)
    activeBossId = "";
    save();
    update();

    closeBossRewardOverlay();
    closeBossBattle();

    // ìˆ˜ë ¹ ë©”ì‹œì§€
    const lines = [];
    if (rw.itemProtect) lines.push(`íŒŒê´´ë°©ì§€ ${rw.itemProtect}ê°œ`);
    if (rw.itemDownProtect) lines.push(`ê°•ë“±ë°©ì§€ ${rw.itemDownProtect}ê°œ`);
    if (rw.itemScroll21) lines.push(`21ê°• ì£¼ë¬¸ì„œ ${rw.itemScroll21}ê°œ`);
    if (rw.itemScroll15) lines.push(`15ê°• ì£¼ë¬¸ì„œ ${rw.itemScroll15}ê°œ`);
    if (rw.itemEssence) lines.push(`ë§ˆë ¥ì˜ ì •ìˆ˜ ${rw.itemEssence}ê°œ`);
    if (rw.itemSuper) lines.push(`ëŒ€ì¥ ë³´ë„ˆìŠ¤ ${rw.itemSuper}ê°œ`);
    if (rw.itemEngraveNormal)   lines.push(`ì¼ë°˜ê°ì¸ì˜ ì£¼ë¬¸ì„œ ${rw.itemEngraveNormal}ê°œ`);
    if (rw.itemEngraveAdvanced) lines.push(`ê³ ê¸‰ê°ì¸ì˜ ì£¼ë¬¸ì„œ ${rw.itemEngraveAdvanced}ê°œ`);

    showNpcMessage(
      `ë³´ìƒ ìˆ˜ë ¹ ì™„ë£Œ!<br><span style="color:#ffd54f;">${lines.join(", ") || "ì—†ìŒ"}</span>`,
      LEON_IMG.focus,
      true,
      "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ"
    );
  });
}

// ì‹¤íŒ¨ ì‹œ í¬ê¸°(ë³´ìƒ ì—†ìŒ) â€” ê·€ì†ë§Œ í•´ì œ
// ì‹¤íŒ¨ ì‹œ í¬ê¸°(ë³´ìƒ ì—†ìŒ) â€” ê·€ì† í•´ì œ(ì„œë²„ ë©¤ë²„ ê¸°ë¡ê¹Œì§€ ì œê±°)
function giveUpBossRun(){
  const bossId = String(activeBossId || "");
  const run = bossId ? (bossRunsActiveCache || {})[bossId] : null;

  if (!bossId || !run) return;

  if (String(run.status || "") !== "failed") {
    showNpcMessage("ì•„ì§ í¬ê¸°í•  ìƒí™©ì´ ì•„ë‹ˆë‹¤.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
    return;
  }

  const myNick = (run.members && run.members[userId] && run.members[userId].nick) ? run.members[userId].nick : String(userId || "???");

  // âœ… (ì¤‘ìš”) DBì—ì„œ ë©¤ë²„ ê¸°ë¡ ì œê±°í•´ì•¼ ìƒˆë¡œê³ ì¹¨ ì‹œ activeBossIdê°€ ë‹¤ì‹œ ë³µêµ¬ë˜ì§€ ì•ŠìŒ
  const updates = {};
  updates[`bossRunsActive/${bossId}/members/${userId}`] = null;

  // (ì„ íƒ) ëŒ€ì¥ì´ í¬ê¸°í•˜ëŠ” ì¼€ì´ìŠ¤ë©´ ëŒ€ì¥IDë„ ë¹„ì›Œë‘ê¸°(ì›í•˜ë©´ ìœ ì§€í•´ë„ ë¨)
  if (String(run.leaderId || "") === String(userId || "")) {
    updates[`bossRunsActive/${bossId}/leaderUid`] = "";
  }

  db.ref().update(updates).then(() => {
    // ì „íˆ¬ë¡œê·¸(ë³´ìŠ¤ì „ ì „ìš© ë¡œê·¸)ì— ë‚¨ê¸°ê¸°
    db.ref(`bossBattleLogs/${bossId}`).push({
      time: Date.now(),
      msg: `${myNick}ë‹˜ì´ í† ë²ŒëŒ€ì—ì„œ ì² ìˆ˜í–ˆìŠµë‹ˆë‹¤.`
    });

    // ë¡œì»¬ ìƒíƒœ ì •ë¦¬
    activeBossId = "";
    save();
    update();

    closeBossRewardOverlay();
    closeBossBattle();

    showNpcMessage("ì² ìˆ˜ ì™„ë£Œ. ë‹¤ìŒì—” ë” ë‹¨ë‹¨íˆ ì¤€ë¹„í•´ë¼.", LEON_IMG.focus, true, "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸ ë°œë Œ");
  }).catch((err) => {
    console.error(err);
    alert("í¬ê¸° ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
  });
}

// âœ… ì‹ ì²­ í™•ì¸(ë ˆì˜¨í•˜ë¥´íŠ¸ê°€ ì„¤ëª… â†’ ë„ì „/í¬ê¸°)
function openBossApplyConfirm(bossId) {
  const def = BOSS_DEFS.find(b => b.id === bossId);
  if (!def) return;

  const intro = `
    <div style="font-size:13px; line-height:1.5;">
      <b>${def.bossTitle} ${def.bossName}</b>.<br>
      ${def.desc}<br><br>
      ì •ë§ ë„ì „í•˜ê² ë‚˜?
    </div>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button onclick="openBossApplyFinal('${bossId}')" style="flex:1; padding:8px; font-size:14px; border-radius:8px;">
        âš”ï¸ ë„ì „í•œë‹¤
      </button>
      <button onclick="closeNpcPopup()" style="flex:1; padding:8px; font-size:14px; border-radius:8px;">
        âŒ í¬ê¸°í•œë‹¤
      </button>
    </div>
  `;

  showNpcMessage(
    intro,
    LEON_IMG.focus,
    false,
    "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸"
  );
}

// âœ… ìµœì¢… í™•ì¸(ê³¨ë“œ ì†Œëª¨/ì¡°ê±´ ì•ˆë‚´)
function openBossApplyFinal(bossId) {
  const def = BOSS_DEFS.find(b => b.id === bossId);
  if (!def) return;

  const html = `
    <div style="font-size:13px; line-height:1.6;">
      <b>${def.bossTitle} í† ë²Œ</b>ì„ ì‹ ì²­í•©ë‹ˆë‹¤.<br>
      Â· ì¡°ê±´: <b>+${def.minSword}ê°• ì´ìƒ</b><br>
      Â· ì†Œëª¨: <b>${formatGold(def.applyCostGold)} ê³¨ë“œ</b><br><br>
      ìˆ˜ë½í•˜ë©´ í† ë²Œì´ ì‹œì‘ë©ë‹ˆë‹¤.
    </div>
    <div style="margin-top:10px; display:flex; gap:8px;">
      <button onclick="closeNpcPopup(); createBossRun('${bossId}')" style="flex:1; padding:8px; font-size:14px; border-radius:8px;">
        âœ… ìˆ˜ë½
      </button>
      <button onclick="closeNpcPopup()" style="flex:1; padding:8px; font-size:14px; border-radius:8px;">
        âŒ ì·¨ì†Œ
      </button>
    </div>
  `;

  showNpcMessage(
    html,
    LEON_IMG.apply,
    false,
    "ê¸¸ë“œë§ˆìŠ¤í„° â€“ ë ˆì˜¨í•˜ë¥´íŠ¸"
  );
}

// ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì˜¤ë²„ë ˆì´ ì—´ê¸°
function openUserListOverlay() {
  const overlay = document.getElementById("userListOverlay");
  if (!overlay) return;

  // ìºì‹œì— ì•„ë¬´ê²ƒë„ ì—†ìœ¼ë©´ ë¡œë”© ë¬¸êµ¬ í‘œì‹œ
  if (!allUsersCache || allUsersCache.length === 0) {
    const body = document.getElementById("userListBody");
    const countEl = document.getElementById("userListCount");
    if (body) {
      body.innerHTML = `
        <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
          ìœ ì € ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </div>
      `;
    }
    if (countEl) {
      countEl.textContent = "ëª¨í—˜ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
    }
  } else {
    renderUserList(allUsersCache);
  }

  overlay.style.display = "block";
}

// ğŸ‘¥ ì „ì²´ ìœ ì € ëª©ë¡ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
function closeUserListOverlay() {
  const overlay = document.getElementById("userListOverlay");
  if (!overlay) return;
  overlay.style.display = "none";
}
  
  // âš”ï¸ ê²°íˆ¬ì¥ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° (duelPoint ê¸°ì¤€)
function loadDuelArenaRanking() {
  const listEl = document.getElementById("duelArenaRankList");
  const myEl   = document.getElementById("duelArenaMyRank");
  if (!listEl || !myEl) return;

  listEl.innerHTML = `
    <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
      ê²°íˆ¬ì¥ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
    </div>
  `;
  myEl.textContent = "";

  const usersRef = db.ref("users");
  const thisWeekKey = getKstWeekKey();   // ğŸ†• ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ê¸°ì¤€ ì£¼í‚¤

  // duelPoint ê¸°ì¤€ìœ¼ë¡œ ëª¨ë‘ ê°€ì ¸ì˜¨ ë’¤, ë©”ëª¨ë¦¬ì—ì„œ í•„í„° + ì •ë ¬
  usersRef
    .orderByChild("duelPoint")
    .once("value")
    .then((snap) => {
      const arr = [];

      snap.forEach((child) => {
        const u = child.val() || {};
        const uid = child.key;

        // ğŸ†• ì´ë²ˆ ì£¼ê°€ ì•„ë‹Œ ê³„ì •ì€ ë­í‚¹ì—ì„œ ì œì™¸
        const userWeekKey = u.duelPointWeekKey || "";
        if (userWeekKey !== thisWeekKey) return;

        const point = Number(u.duelPoint || 0);
        if (!point || point <= 0) return; // í¬ì¸íŠ¸ 0 ì´í•˜ë©´ ë­í‚¹ ì œì™¸

        arr.push({
          id: uid,
          duelPoint: point,
          sword: Number(u.sword || 0),
          duelWin: Number(u.duelWin || 0),
          duelLose: Number(u.duelLose || 0),
          updated: Number(u.duelUpdated || u.updated || 0),
          weaponType: u.weaponType || "sword"
        });
      });

      if (arr.length === 0) {
        listEl.innerHTML = `
          <div style="padding:8px 0; text-align:center; color:#999; font-size:12px;">
            ì•„ì§ ê²°íˆ¬ í¬ì¸íŠ¸ë¥¼ ê°€ì§„ ëª¨í—˜ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
            ê°€ì¥ ë¨¼ì € ê²°íˆ¬ì¥ì„ ì •ë³µí•´ ë³´ì„¸ìš”!
          </div>
        `;
        myEl.textContent = "";
        return;
      }

      // ğŸ”½ duelPoint ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ê°™ì€ í¬ì¸íŠ¸ë©´ updated ë¹ ë¥¸ ìˆœì„œë¡œ)
      arr.sort((a, b) => {
        if (b.duelPoint !== a.duelPoint) {
          return b.duelPoint - a.duelPoint;
        }
        return (a.updated || 0) - (b.updated || 0);
      });

      // ğŸ”Ÿ ìƒìœ„ 10ëª…ë§Œ í‘œì‹œ
      const top = arr.slice(0, 10);

      // ğŸ§¾ ë­í‚¹ HTML êµ¬ì„±
      const rows = top.map((u, idx) => {
        const rank = idx + 1;

          // ë¬´ê¸° ì´ë¦„ ì–»ê¸° (ì´ë¯¸ ìˆëŠ” getWeaponInfo ì¬ì‚¬ìš©)
  let weaponText = `+${u.sword}ê°•`;
  try {
    const info = getWeaponInfo(u.sword, u.weaponType || "sword");   // ğŸ†• type ë„˜ê²¨ì£¼ê¸°
    if (info && info.name) {
      weaponText = `${info.name} +${u.sword}ê°•`;
    }
  } catch (e) {
    // í•¨ìˆ˜ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë‚˜ë©´ ê·¸ëƒ¥ +ê°•ë§Œ í‘œì‹œ
  }

        const recordText = `${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨`;

        return `
          <div style="display:flex; justify-content:space-between; padding:3px 0; border-bottom:1px solid #333; font-size:12px;">
            <div>
              <span style="font-weight:bold;">${rank}ìœ„</span>
              &nbsp; ${u.id}
            </div>
            <div style="text-align:right;">
              <div>ê²°íˆ¬í¬ì¸íŠ¸ <span style="color:#ffd54f;">${u.duelPoint}</span></div>
              <div style="font-size:11px; color:#ccc;">${weaponText} Â· ${recordText}</div>
            </div>
          </div>
        `;
      });

      listEl.innerHTML = rows.join("");

      // ğŸ‘¤ ë‚´ ë­í‚¹ ì°¾ê¸°
      const myIndex = arr.findIndex(u => u.id === userId);

      if (myIndex === -1) {
        myEl.textContent = "ë‚´ ê²°íˆ¬ í¬ì¸íŠ¸: 0 (ë­í‚¹ ë¯¸ë“±ë¡)";
      } else {
        const myRank = myIndex + 1;
        const me = arr[myIndex];
        myEl.innerHTML = `
          ë‚´ ë­í‚¹: <span style="color:#ffd54f;">${myRank}ìœ„</span>
          Â· ê²°íˆ¬í¬ì¸íŠ¸ ${me.duelPoint}
          Â· ì „ì  ${me.duelWin}ìŠ¹ ${me.duelLose}íŒ¨
        `;
      }
    })
    .catch((err) => {
      console.error("ê²°íˆ¬ì¥ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", err);
      listEl.innerHTML = `
        <div style="padding:8px 0; text-align:center; color:#f88; font-size:12px;">
          ê²°íˆ¬ì¥ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>
          ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
        </div>
      `;
    });
}

// ğŸ¯ ê²°íˆ¬í•˜ê¸°(ì§€ì •ë§¤ì¹­) ë²„íŠ¼ â†’ ê²°íˆ¬ íŒ¨ë„ ì—´ê¸° + ìœ„ì¹˜ ì¡°ì •
function openDuelTargetPanel() {
  const panel = document.getElementById("duelPanel");
  if (!panel) return;

  // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
  if (panel.style.display === "block") {
    panel.style.display = "none";
    return;
  }

  // âœ… ê¸°ì¡´ í† ê¸€ ë¡œì§ì²˜ëŸ¼ ë¦¬ìŠ¤íŠ¸/ê²€ìƒ‰ ì„¸íŒ…
  renderDuelList("");
  panel.style.display = "block";
  const input = document.getElementById("duelSearchInput");
  if (input) {
    input.value = "";
input.focus({ preventScroll: true });
}

  // ğŸ¯ ê²°íˆ¬ì¥ ì•ˆì˜ "ê²°íˆ¬í•˜ê¸°(ì§€ì •ë§¤ì¹­)" ë²„íŠ¼ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³„ì‚°
  const btn = document.querySelector("#duelArenaPanel button[onclick='openDuelTargetPanel()']");
  if (!btn) return;

  const btnRect = btn.getBoundingClientRect();

  // íŒ¨ë„ ì‹¤ì œ í¬ê¸° ì¸¡ì • (í‘œì‹œëœ ìƒíƒœì—¬ì•¼ í•¨)
  const panelRect = panel.getBoundingClientRect();
  let panelWidth = panelRect.width || 260;
  let panelHeight = panelRect.height || 260;

  let left;
  let top;

  if (window.innerWidth <= 520) {
    // ğŸ“± ëª¨ë°”ì¼: í™”ë©´ ì•„ë˜ìª½ ì¤‘ì•™ ìª½ì— ìœ„ì¹˜
    left = (window.innerWidth - panelWidth) / 2;
    top = btnRect.bottom + 8;

    // ì•„ë˜ë¡œ ë„˜ì¹˜ë©´ ìœ„ë¡œ ì¡°ê¸ˆ ì˜¬ë¦¬ê¸°
    if (top + panelHeight > window.innerHeight - 10) {
      top = window.innerHeight - panelHeight - 10;
    }
  } else {
    // ğŸ–¥ PC: ë²„íŠ¼ ì˜¤ë¥¸ìª½ì— ë¶™ì´ê¸°
    left = btnRect.right + 8;
    top = btnRect.top;

    // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë„˜ì¹˜ë©´ ë²„íŠ¼ ì™¼ìª½ìœ¼ë¡œ
    if (left + panelWidth > window.innerWidth - 10) {
      left = btnRect.left - panelWidth - 8;
    }
    // ì•„ë˜ë¡œ ë„˜ì¹˜ë©´ í™”ë©´ ì•ˆìœ¼ë¡œ ì˜¬ë¦¬ê¸°
    if (top + panelHeight > window.innerHeight - 10) {
      top = window.innerHeight - panelHeight - 10;
    }
  }

  panel.style.position = "fixed";      // ì˜¤ë²„ë ˆì´ ìœ„ì— ê³ ì •
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;
  panel.style.zIndex = 1300;           // ê²°íˆ¬ì¥ ì˜¤ë²„ë ˆì´(1200)ë³´ë‹¤ ìœ„
}


// ğŸ² ëœë¤ë§¤ì¹­ ë²„íŠ¼ (ê²°íˆ¬ì¥ ì•ˆì—ì„œ)
function handleRandomMatchFromArena() {
  handleRandomMatch(); // ê¸°ì¡´ ëœë¤ë§¤ì¹­ ë¡œì§ ê·¸ëŒ€ë¡œ ì‚¬ìš©
}

// âš”ï¸ ê²°íˆ¬ì¥ ê·œì¹™ / ë³´ìƒ ì„¤ëª… íŒì—…
function openDuelHelpPopup() {
  const html = `
    <div style="font-size:16px; font-weight:bold; margin-bottom:6px;">
      ê²°íˆ¬ì¥ ê·œì¹™ & ë³´ìƒ ì•ˆë‚´
    </div>
    <div style="font-size:13px; line-height:1.5;">
      <div style="margin-bottom:6px;">
        Â· ê²°íˆ¬ì¥ì—ì„œ ìŠ¹ë¦¬í•˜ë©´ <span style="color:#ffcc66;">ê³¨ë“œ</span>ì™€<br>
          <span style="color:#66ccff;">ëª…ì˜ˆì˜ í›ˆì¥</span>, 
          <span style="color:#ff8888;">ê²°íˆ¬ í¬ì¸íŠ¸</span>ë¥¼ ì–»ìŠµë‹ˆë‹¤.
      </div>
      <div style="margin-bottom:6px;">
        Â· ê²°íˆ¬ í¬ì¸íŠ¸ëŠ” ì£¼ê°„ ëˆ„ì  ì ìˆ˜ë¡œ,<br>
          ë§¤ì£¼ <span style="color:#ffcc66;">ì›”ìš”ì¼ 00:00</span>ì— ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
      </div>
      <div style="margin-bottom:6px;">
        Â· ì£¼ê°„ ê²°íˆ¬ í¬ì¸íŠ¸ë¡œ <span style="color:#ffcc66;">ê²°íˆ¬ì¥ ë­í‚¹</span>ì´ ê²°ì •ë˜ë©°,<br>
          ìˆœìœ„ì— ë”°ë¼ ë§¤ì£¼ ë³´ìƒì´ ì§€ê¸‰ë©ë‹ˆë‹¤.
      </div>
      <div style="margin-bottom:6px;">
        Â· <span style="color:#ffcc66;">ëœë¤ ë§¤ì¹­</span>ìœ¼ë¡œ ì´ê¸°ë©´<br>
          ì¶”ê°€ë¡œ ëª…ì˜ˆì˜ í›ˆì¥ <span style="color:#ffcc66;">+1</span>ì„ ë” ë°›ìŠµë‹ˆë‹¤.
      </div>
      <div style="margin-top:8px; border-top:1px solid #444; padding-top:6px;">
        <div style="margin-bottom:4px;">[ì£¼ê°„ ë³´ìƒ]</div>
        <div>1ìœ„ : íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 2ê°œ</div>
        <div>2~3ìœ„ : íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ 1ê°œ</div>
        <div>4~6ìœ„ : ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ 5ê°œ, 15ê°• ì£¼ë¬¸ì„œ 3ê°œ</div>
        <div>7~10ìœ„ : ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ 3ê°œ, 15ê°• ì£¼ë¬¸ì„œ 1ê°œ</div>
        <div>10ìœ„ ë°– : ê°•ë“±ë°©ì–´ ì£¼ë¬¸ì„œ 1ê°œ</div>
      </div>
    </div>
  `;

  showNpcMessage(
    html,
    "images/npc/duel_carnia.png",
    true,
    "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
  );
}

// ğŸ•° ì§€ë‚œ ë­í‚¹ íŒì—…
function openDuelHistoryPopup() {
  const usersRef = db.ref("users");

  // ğŸ†• ì§€ë‚œì£¼ ê¸°ê°„ ë²”ìœ„ ê³„ì‚°
  const range = getLastWeekRangeKst();
  const startTs = range.start;
  const endTs   = range.end;

    // âœ… ì´ë²ˆ ì£¼ í‚¤ (ì§€ë‚œì£¼/ì´ë²ˆì£¼ íŒë³„ìš©)
  const thisWeekKey = getKstWeekKey();

  usersRef
    .once("value")
    .then((snap) => {
      const arr = [];

      snap.forEach((child) => {
        const val = child.val() || {};

        // âœ… ì´ ìœ ì €ê°€ ì–´ë–¤ ì£¼ì°¨ ë°ì´í„°ì¸ì§€
        const userWeekKey = val.duelPointWeekKey || "";

        // âœ… ì§€ë‚œì£¼ ì ìˆ˜/ì‹œê°„ ê²°ì •
        // - ì´ë¯¸ ì£¼ì°¨ê°€ ë„˜ì–´ê°„ ìœ ì €: duelLastWeekPoint ì‚¬ìš©
        // - ì•„ì§ ì£¼ì°¨ê°€ ì•ˆ ë„˜ì–´ê°„ ìœ ì €: duelPointê°€ ê³§ ì§€ë‚œì£¼ ì ìˆ˜
        const point =
          userWeekKey === thisWeekKey
            ? Number(val.duelLastWeekPoint || 0)
            : Number(val.duelPoint || 0);

        const t =
          userWeekKey === thisWeekKey
            ? Number(val.duelLastWeekUpdated || 0)
            : Number(val.duelUpdated || 0);

        if (point <= 0) return;

        // ğŸ§¹ ì§€ë‚œì£¼ ê¸°ê°„ ì•ˆì— ê¸°ë¡ëœ ê²ƒë§Œ ì‚¬ìš©
        if (!t || t < startTs || t >= endTs) return;

        arr.push({
          id: child.key,
          duelLastWeekPoint: point,
          sword: Number(val.sword || 0),
          duelWin: Number(val.duelWin || 0),
          duelLose: Number(val.duelLose || 0),
          updated: t,
          weaponType: val.weaponType || "sword",
          equippedTitle: val.equippedTitle || "",
          reach30Count: Number(val.reach30Count || 0)
        });
      });

      if (arr.length === 0) {
        showNpcMessage(
          `
          <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">
            ì§€ë‚œì£¼ ê²°íˆ¬ì¥ ë­í‚¹
          </div>
          <div style="font-size:13px;">
            ì§€ë‚œì£¼ì—ëŠ” ê²°íˆ¬ì¥ì— ê¸°ë¡ì´ ë‚¨ì€ ê²€ì‚¬ê°€ ì—†ì—ˆì–´.<br>
            ì´ë²ˆ ì£¼ì—” ë„¤ ì´ë¦„ì„ ì˜¬ë ¤ë³´ëŠ” ê±´ ì–´ë•Œ?
          </div>
          `,
          "images/npc/duel_carnia.png",
          true,
          "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
        );
        return;
      }

      // ğŸ” ì§€ë‚œì£¼ í¬ì¸íŠ¸ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ë™ì ì´ë©´ ë¨¼ì € ë„ë‹¬)
      arr.sort((a, b) => {
        if (b.duelLastWeekPoint !== a.duelLastWeekPoint) {
          return b.duelLastWeekPoint - a.duelLastWeekPoint;
        }
        const aTime = Number(a.updated || 0);
        const bTime = Number(b.updated || 0);
        return aTime - bTime;
      });

      // TOP 10ë§Œ ì¶œë ¥
      const top10 = arr.slice(0, 10);

      const rowsHtml = top10.map((u, i) => {
        const wInfo = getWeaponInfo(u.sword, u.weaponType);
        const weaponNameStyled = coloredWeaponName(u.sword, wInfo.name);

        return `
          <tr>
            <td style="padding:2px 4px; text-align:center;">${i + 1}</td>
            <td style="padding:2px 4px;">${formatNicknameWithTitle(u.id, u.equippedTitle || "", u.reach30Count)}</td>
            <td style="padding:2px 4px; text-align:right;">${u.duelLastWeekPoint}</td>
            <td style="padding:2px 4px;">${weaponNameStyled} ${coloredLevel(u.sword)}</td>
            <td style="padding:2px 4px; text-align:right;">
              ${u.duelWin}ìŠ¹ ${u.duelLose}íŒ¨
            </td>
          </tr>
        `;
      }).join("");

      // ë‚´ ì§€ë‚œì£¼ ë­í‚¹ ë¬¸êµ¬
      let myRankText = "ì§€ë‚œì£¼ ë„¤ ê²°íˆ¬ì¥ ê¸°ë¡ì€ ë‚¨ì•„ìˆì§€ ì•Šë„¤.";
      const myIndex = arr.findIndex((u) => u.id === userId);

      if (myIndex !== -1) {
        const myRank = myIndex + 1;
        const myPoint = arr[myIndex].duelLastWeekPoint;
        myRankText =
          `ì§€ë‚œì£¼ ë„¤ ë­í‚¹ì€ <span style="color:#ffd54f;">${myRank}ìœ„</span>, ` +
          `ê²°íˆ¬í¬ì¸íŠ¸ <span style="color:#a5e1ff;">${myPoint}</span>ì ì´ì—ˆì–´.`;
      }

      const html = `
        <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">
          ì§€ë‚œì£¼ ê²°íˆ¬ì¥ ë­í‚¹
        </div>
        <div style="font-size:12px; margin-bottom:6px; color:#ccc;">
          ë§¤ì£¼ ì›”ìš”ì¼ 00:00(KST) ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„ëœ ê¸°ë¡ì´ì•¼.
        </div>
        <table style="width:100%; border-collapse:collapse; font-size:12px;">
          <thead>
            <tr style="border-bottom:1px solid #444;">
              <th style="padding:2px 4px; text-align:center;">ìˆœìœ„</th>
              <th style="padding:2px 4px; text-align:left;">ê²€ì‚¬</th>
              <th style="padding:2px 4px; text-align:right;">í¬ì¸íŠ¸</th>
              <th style="padding:2px 4px; text-align:left;">ë¬´ê¸°</th>
              <th style="padding:2px 4px; text-align:right;">ì „ì </th>
            </tr>
          </thead>
          <tbody>
            ${rowsHtml}
          </tbody>
        </table>
        <div style="margin-top:8px; font-size:12px;">
          ${myRankText}
        </div>
      `;

      showNpcMessage(
        html,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
    })
    .catch((err) => {
      console.error("ì§€ë‚œì£¼ ê²°íˆ¬ì¥ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:", err);
      showNpcMessage(
        `
        <div style="font-size:14px;">
          ì§€ë‚œì£¼ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆì–´.<br>
          ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ ì¤˜.
        </div>
        `,
        "images/npc/duel_carnia.png",
        true,
        "ê²°íˆ¬ ì‹¬íŒê´€ â€“ ì¹´ë¥´ë‹ˆì•„ ë°œí¬ë¼ì´íŠ¸"
      );
    });
}
  
// âš”ï¸ ê²°íˆ¬ íŒ¨ë„ í† ê¸€
function toggleDuelPanel() {
  const panel = document.getElementById("duelPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderDuelList("");  // ê²€ìƒ‰ì–´ ì—†ì´ â†’ ë­í‚¹ ìˆœ
    panel.style.display = "block";

    const input = document.getElementById("duelSearchInput");
    if (input) {
      input.value = "";
      input.focus();
    }
  } else {
    panel.style.display = "none";
  }
}
  
/* ë¡œê·¸ í† ê¸€ */
function toggleLog(){
  const panel = document.getElementById("logPanel");
  if (!panel) return;

  const willOpen = (panel.style.display === "none" || panel.style.display === "");
  panel.style.display = willOpen ? "block" : "none";

  // âœ… í•˜ë‹¨ ë²„íŠ¼/ëª¨ë“œ ì‹±í¬
  setToastLogMode(willOpen ? "panel" : "five");
}

  // ğŸ”” í•˜ë‹¨ ë¡œê·¸(í† ìŠ¤íŠ¸) ì ‘ê¸°/í¼ì¹˜ê¸° ìƒíƒœ
let toastLogMode = "five"; // "one" | "five" | "panel"

function setToastLogMode(mode){
  toastLogMode = mode;

  const wrap = document.getElementById("toastLog");
  const foldBtn = document.getElementById("toastFoldBtn");
  const expBtn  = document.getElementById("toastExpandBtn");
  if (!wrap || !foldBtn || !expBtn) return;

  wrap.classList.remove("log-view-one","log-view-five","log-view-panel");
  if (mode === "one")  wrap.classList.add("log-view-one");
  if (mode === "five") wrap.classList.add("log-view-five");
  if (mode === "panel")wrap.classList.add("log-view-panel");

  // ë²„íŠ¼ ë…¸ì¶œ ê·œì¹™:
  // five : ì ‘ê¸°/í¼ì¹˜ê¸° ë‘˜ë‹¤
  // one  : í¼ì¹˜ê¸°ë§Œ
  // panel: ì ‘ê¸°ë§Œ
  if (mode === "one") {
    foldBtn.style.display = "none";
    expBtn.style.display  = "inline-block";
  } else if (mode === "five") {
    foldBtn.style.display = "inline-block";
    expBtn.style.display  = "inline-block";
  } else { // panel
    foldBtn.style.display = "inline-block";
    expBtn.style.display  = "none";
  }
}

function openLogPanelOnly(){
  const panel = document.getElementById("logPanel");
  if (!panel) return;
  panel.style.display = "block";
}

function closeLogPanelOnly(){
  const panel = document.getElementById("logPanel");
  if (!panel) return;
  panel.style.display = "none";
}

// âœ… í•˜ë‹¨ "ì ‘ê¸°" ë²„íŠ¼ ë™ì‘
function onToastFold(){
  if (toastLogMode === "panel"){
    setToastLogMode("five");
    return;
  }
  if (toastLogMode === "five"){
    setToastLogMode("one");
    return;
  }
  // one ìƒíƒœì—ì„œ "ì ‘ê¸°"ëŠ” ë” í•  ê²Œ ì—†ìœ¼ë‹ˆ ë¬´ì‹œ
}


// âœ… í•˜ë‹¨ "í¼ì¹˜ê¸°" ë²„íŠ¼ ë™ì‘
function onToastExpand(){
  if (toastLogMode === "one"){
    setToastLogMode("five");
    return;
  }
  if (toastLogMode === "five"){
    // âœ… ì´ì œ panelì€ 'ì‹¤ì‹œê°„ ë¡œê·¸ì°½(#toastLog) ìì²´'ë§Œ í™•ì¥í•œë‹¤ (ì˜›ë‚  #logPanel ì ˆëŒ€ ì•ˆì”€)
    setToastLogMode("panel");
    return;
  }
  // panel ìƒíƒœì—ì„œ "í¼ì¹˜ê¸°"ëŠ” ë” í•  ê²Œ ì—†ìœ¼ë‹ˆ ë¬´ì‹œ
}


// âœ… ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© (DOM ë¡œë“œ í›„ 1íšŒ)
(function bindToastLogButtons(){
  const foldBtn = document.getElementById("toastFoldBtn");
  const expBtn  = document.getElementById("toastExpandBtn");
  if (foldBtn) foldBtn.onclick = onToastFold;
  if (expBtn)  expBtn.onclick  = onToastExpand;

  // ì´ˆê¸° ìƒíƒœ: 5ì¤„
  setToastLogMode("five");
})();

// ğŸ’ ì¸ë²¤í† ë¦¬
function setInventoryDockActive(on){
  const btn = document.getElementById("inventoryDockBtn");
  if (!btn) return;
  btn.classList.toggle("active", !!on);
}

function openInventoryOverlay(){
  const ov = document.getElementById("inventoryOverlay");
  if (!ov) return;

  renderInventory();               // ê¸°ì¡´ ë Œë” ê·¸ëŒ€ë¡œ ì¬ì‚¬ìš©
  ov.style.display = "flex";        // âœ… ì¤‘ì•™ ì˜¤ë²„ë ˆì´ í‘œì‹œ
  setInventoryDockActive(true);     // âœ… ì•„ì´ì½˜ í™œì„±í™”
}

function closeInventoryOverlay(){
  const ov = document.getElementById("inventoryOverlay");
  if (!ov) return;

  ov.style.display = "none";
  setInventoryDockActive(false);    // âœ… ë‹«ì„ ë•Œ í™œì„± í•´ì œ(í•µì‹¬!)

  // ì•„ì´í…œ ìƒì„¸ì°½ì´ ì—´ë ¤ìˆìœ¼ë©´ ê°™ì´ ë‹«ê¸°(ì•ˆì „)
  if (typeof hideItemDetail === "function") hideItemDetail();
}

function toggleInventory(){
  const ov = document.getElementById("inventoryOverlay");
  if (!ov) return;

  const opened = (ov.style.display !== "none" && ov.style.display !== "");
  if (opened) closeInventoryOverlay();
  else openInventoryOverlay();
}


// ğŸ’ ì¸ë²¤í† ë¦¬ (ê²©ì + ì•„ì´ì½˜ + í´ë¦­ ìƒì„¸ íŒì—…)
function renderInventory() {
  const listEl = document.getElementById("inventoryList");
  if (!listEl) return;

  listEl.innerHTML = "";

  const items = [];

  if (itemScroll15 > 0) {
    items.push({
      id: "scroll15",
      name: "15ê°• ê°•í™” ì£¼ë¬¸ì„œ",
      count: itemScroll15,
      img: "images/items/scroll_15.png",
      desc: "í˜„ì¬ ë¬´ê¸°ë¥¼ 15ê°•ê¹Œì§€ í•œ ë²ˆì— ê°•í™”í•  ìˆ˜ ìˆëŠ” íŠ¹ìˆ˜ ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
    });
  }

  // 21ê°• ê°•í™” ì£¼ë¬¸ì„œ
  if (itemScroll21 > 0) {
    items.push({
      id: "scroll21",
      name: "21ê°• ê°•í™” ì£¼ë¬¸ì„œ",
      count: itemScroll21,
      img: "images/items/scroll_21.png",   // âœ… íŒŒì¼ëª… í†µì¼
      desc: "í•œ ë²ˆì— ë¬´ê¸°ë¥¼ 21ê°•ìœ¼ë¡œ ë§Œë“¤ì–´ ì£¼ëŠ” ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
    });
  }

  if (itemHonorMedal > 0) {
  items.push({
    key: "honorMedal",
    name: "ëª…ì˜ˆì˜ í›ˆì¥",
    count: itemHonorMedal,
    img: "images/items/medal_honor.png",
    desc: "ìŠ¹ë¦¬ì˜ ìˆœê°„ì—ë§Œ ìƒˆê²¨ì§€ëŠ” ì¡°ìš©í•œ ì¦í‘œ.\nì–¸ì  ê°€, ê°€ì¹˜ê°€ ë“œëŸ¬ë‚  ë‚ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤."
  });
}

  if (itemProtect > 0) {
    items.push({
      id: "protect",
      name: "íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ",
      count: itemProtect,
      img: "images/items/scroll_protect.png",
      desc: "ê°•í™” ì‹¤íŒ¨ ì‹œ ë¬´ê¸°ê°€ íŒŒê´´ë˜ëŠ” ê²ƒì„ 1íšŒ ë§‰ì•„ì¤ë‹ˆë‹¤."
    });
  }

  if (itemDownProtect > 0) {
    items.push({
      id: "downProtect",
      name: "ê°•ë“±ë°©ì§€ ì£¼ë¬¸ì„œ",
      count: itemDownProtect,
      img: "images/items/scroll_down_protect.png", // â­ í™•ì •
      desc: "ê°•í™” ì‹¤íŒ¨ ì‹œ ê°•í™” ë‹¨ê³„ê°€ ë‚´ë ¤ê°€ëŠ” ê²ƒì„ 1íšŒ ë§‰ì•„ì¤ë‹ˆë‹¤."
    });
  }

  if (itemSuper > 0) {
    items.push({
      id: "super",
      name: "ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ",
      count: itemSuper,
      img: "images/items/scroll_super.png",
      desc: "ê°•í™” ì„±ê³µ ì‹œ í•œ ë²ˆì— +2ê°•ì´ ë˜ëŠ” íŠ¹ë³„í•œ ì£¼ë¬¸ì„œì…ë‹ˆë‹¤."
    });
  }

if (starShard > 0) {
  items.push({
    id: "starShard",
    name: "ë¹›ë‚˜ì§€ ëª»í•œ ë³„ì˜ ì¡°ê°",
    count: starShard,
    img: "images/items/star_shard.png",
    desc: "ë¶€ì„œì§„ ì¹¼ë‚  ì†ì— ë‚¨ê²¨ì§„ í”ì ì…ë‹ˆë‹¤. ì¡°ê°ì´ ëª¨ì´ë©´, íŠ¹ìˆ˜í•œ ì•„ì´í…œê³¼ êµí™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
  });
}
  // ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ
  if (itemRateUp5 > 0) {
    items.push({
      id: "rateUp5",
      name: "ê°•í™” í™•ë¥  +5% ì£¼ë¬¸ì„œ",
      count: itemRateUp5,
      img: "images/items/scroll_rateup_5.png",  // âœ… íŒŒì¼ëª… í†µì¼
      desc: "ì´ë²ˆ ê°•í™” ì‹œ ì„±ê³µ í™•ë¥ ì´ 5%p ì¦ê°€í•©ë‹ˆë‹¤."
    });
  }
  if (Number(itemEssence || 0) > 0) {
  items.push({
    id: "essence",
    name: "ë§ˆë ¥ì˜ ì •ìˆ˜",
    count: Number(itemEssence || 0),
    img: "images/items/essence.png", // 
    desc: "ì‘ì¶•ëœ ë§ˆë ¥ì˜ ê²°ì •. ë¶ˆê¸¸í•œ ë§ˆë ¥ì„ ë¨¸ê¸ˆê³ ìˆë‹¤."
  });
}
    if (Number(itemMagicPaper || 0) > 0) {
    items.push({
      id: "magicPaper",
      name: "ë§ˆë ¥ì´ ê¹ƒë“  ì¢…ì´",
      count: Number(itemMagicPaper || 0),
      img: "images/items/magic_paper.png",
      desc: "ì£¼ë¬¸ì„œì œì‘ì— ì‚¬ìš©ë˜ëŠ” ì¢…ì´. ë§ˆë ¥ì´ ì€ì€í•˜ê²Œ ë‚¨ì•„ìˆë‹¤."
    });
  }

    if (Number(itemEngraveNormal || 0) > 0) {
    items.push({
      id: "engraveNormalScroll",
      name: "ì¼ë°˜ê°ì¸ì˜ ì£¼ë¬¸ì„œ",
      count: Number(itemEngraveNormal || 0),
      img: "images/items/engrave_normal.png",
      desc: "ê°ì¸ì„ ìƒˆë¡œ ìƒˆê¸¸ ë•Œ ì†Œëª¨ë˜ëŠ” ì£¼ë¬¸ì„œ. (ì¼ë°˜ê°ì¸ ì „ìš©)"
    });
  }

  if (Number(itemEngraveAdvanced || 0) > 0) {
    items.push({
      id: "engraveAdvancedScroll",
      name: "ê³ ê¸‰ê°ì¸ì˜ ì£¼ë¬¸ì„œ",
      count: Number(itemEngraveAdvanced || 0),
      img: "images/items/engrave_advanced.png",
      desc: "ê°ì¸ì„ ìƒˆë¡œ ìƒˆê¸¸ ë•Œ ì†Œëª¨ë˜ëŠ” ì£¼ë¬¸ì„œ. (ê³ ê¸‰ê°ì¸ ì „ìš©)"
    });
  }
  
  const title = document.createElement("p");
  title.textContent = "ë³´ìœ  ì•„ì´í…œ";
  title.style.margin = "0 0 4px 0";
  title.style.fontSize = "13px";
  title.style.color = "#ccc";
  listEl.appendChild(title);

  const countEl = document.getElementById("inventoryCountInfo");
  if (countEl) countEl.textContent = `${items.length}ì¢…`;

  if (items.length === 0) {
    const emptyMsg = document.createElement("p");
    emptyMsg.textContent = "ë³´ìœ  ì¤‘ì¸ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.";
    emptyMsg.style.fontSize = "12px";
    emptyMsg.style.color = "#888";
    emptyMsg.style.marginTop = "6px";
    listEl.appendChild(emptyMsg);
    return;
  }

  const grid = document.createElement("div");
  grid.className = "inventory-grid";

  items.forEach(item => {
    const slot = document.createElement("div");
    slot.className = "inventory-slot";

    const img = document.createElement("img");
    img.src = item.img;
    img.alt = item.name;
    img.title = item.name;

    slot.appendChild(img);

    if (item.count > 1) {
      const countBadge = document.createElement("div");
      countBadge.className = "inventory-count";
      countBadge.textContent = item.count;
      slot.appendChild(countBadge);
    }

    // ğŸ–± í´ë¦­ â†’ ìƒì„¸ íŒì—…
    slot.addEventListener("click", (e) => {
      showItemDetail(item, e.clientX, e.clientY);
    });

    grid.appendChild(slot);
  });

  listEl.appendChild(grid);
}

  // ğŸ’ ì•„ì´í…œ ìƒì„¸ í‘œì‹œ
function showItemDetail(item, clickX, clickY) {
  const overlay = document.getElementById("itemDetailOverlay");
  const box     = document.getElementById("itemDetailBox");
  const img     = document.getElementById("itemDetailImg");
  const nameEl  = document.getElementById("itemDetailName");
  const descEl  = document.getElementById("itemDetailDesc");
  if (!overlay || !box) return;

  img.src = item.img;
  img.alt = item.name;
  nameEl.textContent = item.name;
  descEl.textContent = item.desc || "";

  overlay.style.display = "block";

  // í´ë¦­ ìœ„ì¹˜ ê·¼ì²˜ì— í‘œì‹œ
  let left = clickX + 12;
  let top  = clickY + 12;

  const boxRect = box.getBoundingClientRect();
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  if (left + boxRect.width > vw - 10)
    left = clickX - boxRect.width - 12;

  if (top + boxRect.height > vh - 10)
    top = clickY - boxRect.height - 12;

  if (left < 10) left = 10;
  if (top < 10) top = 10;

  box.style.left = left + "px";
  box.style.top  = top  + "px";
}

function hideItemDetail() {
  const overlay = document.getElementById("itemDetailOverlay");
  if (overlay) overlay.style.display = "none";
}

// ğŸ’ ì•„ì´í…œ ìƒì„¸ ì˜¤ë²„ë ˆì´ ì´ë²¤íŠ¸ëŠ” DOMì´ ë‹¤ ë§Œë“¤ì–´ì§„ ë’¤ì— ë¶™ì´ê¸°
window.addEventListener("load", () => {
  const overlay = document.getElementById("itemDetailOverlay");
  const box     = document.getElementById("itemDetailBox");
  if (!overlay || !box) return;

  // ë°°ê²½(ì–´ë‘ìš´ ì˜ì—­) ì•„ë¬´ë°ë‚˜ ëˆ„ë¥´ë©´ ìƒì„¸ì°½ë§Œ ë‹«ê¸°
  overlay.addEventListener("mousedown", (e) => {
    hideItemDetail();
    e.stopPropagation(); // ğŸ‘ˆ ì¸ë²¤í† ë¦¬ ë°”ê¹¥ í´ë¦­ ì²˜ë¦¬ë¡œ ë„˜ì–´ê°€ì§€ ì•Šê²Œ ë§‰ê¸°
  });

  // ìƒì„¸ ë°•ìŠ¤ ì•ˆ í´ë¦­ì€ ìœ ì§€
  box.addEventListener("mousedown", (e) => {
    e.stopPropagation();
  });
});

// ESCë¡œ ë‹«ê¸° (ê·¸ëŒ€ë¡œ ìœ ì§€)
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") hideItemDetail();
});

  // ìƒì  Yes/No ë²„íŠ¼ ì´ˆê¸°í™”
function initScrollShopButtons() {
  const yesBtn = document.getElementById("scrollShopYesBtn");
  const noBtn  = document.getElementById("scrollShopNoBtn");

  if (yesBtn) yesBtn.onclick = onClickScrollShopYes;
  if (noBtn)  noBtn.onclick  = onClickScrollShopNo;
}

  loadRanking();
  autoLoginFromStorage();
    // â± ì‚¬ëƒ¥ íšŒë³µ íƒ€ì´ë¨¸ í‘œì‹œìš©
  setInterval(updateHuntUI, 1000);

    // ğŸ“œ ìŠ¤í¬ë¡¤ ìƒì  ë²„íŠ¼/ì´ë²¤íŠ¸ ì—°ê²°
  initScrollShopButtons();

// â›” ê°•í™”/ê²°íˆ¬ ì§„í–‰ ì¤‘ì—ëŠ” Enter / Space ì…ë ¥ ì°¨ë‹¨
document.addEventListener("keydown", (e) => {
  if (!isUpgrading && !isDueling) return;

  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    e.stopPropagation();
  }
});

  // ğŸ›  ìš´ì˜ììš© â€” ì „íˆ¬ë ¥ ì¬ê³„ì‚° + DB ë°˜ì˜
async function recalcUserPower(userIdToFix) {

  const ref = db.ref("users/" + userIdToFix);

  const snap = await ref.once("value");
  if (!snap.exists()) {
    console.warn("âŒ ìœ ì € ë°ì´í„° ì—†ìŒ:", userIdToFix);
    return;
  }

  const d = snap.val();

  // í•´ë‹¹ ìœ ì € ê¸°ì¤€ ìƒíƒœ ë¡œë“œ
  sword = Number(d.sword ?? 0);
  gold  = Number(d.gold  ?? 0);

  // ğŸ§® ì „íˆ¬ë ¥ ì¬ì‚°ì¶œ
  rollPowerForCurrentSword();

  // DB ë°˜ì˜
  await ref.update({
    power: Number(power)
  });

  console.log(`âœ… ì „íˆ¬ë ¥ ì¬ê³„ì‚° ì™„ë£Œ â†’ ${userIdToFix}:`, power);
}

  function openSystemPopup(title, html){
  const el = document.getElementById("systemPopup");
  if (!el) {
    alert(title + "\n\n" + html.replace(/<br>/g, "\n"));
    return;
  }

  el.querySelector(".title").innerHTML = title;
  el.querySelector(".content").innerHTML = html;
  el.style.display = "block";
}
  
// ğŸ”’ ë¯¸êµ¬í˜„ ë²„íŠ¼ ê³µìš© ì•ˆë‚´ (ê¸°ì¡´ ì‹œìŠ¤í…œ íŒì—… ìŠ¤íƒ€ì¼)
function showLockedFeaturePopup(){
  const html = `
    <div style="text-align:center; font-size:14px; line-height:1.6;">
      <div style="font-weight:900; margin-bottom:6px;">ë¯¸êµ¬í˜„ ê¸°ëŠ¥</div>
      <div style="color:#aaa;">
        ì•„ì§ ë´‰ì¸ëœ ê¸°ëŠ¥ì…ë‹ˆë‹¤.<br>
        ì¶”í›„ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.
      </div>
    </div>
  `;
  // âœ… npcPopup DOM êµ¬ì¡°ë¥¼ ì ˆëŒ€ íŒŒê´´í•˜ì§€ ì•Šê³ , ê¸°ì¡´ showNpcMessageë¥¼ ì‚¬ìš©
  showNpcMessage(html, null, true, "");
}

// âœ… ì¤‘ë³µ ì ‘ì† ê°ì§€ ì‹œ: NPC íŒì—… ë ˆì´ì•„ì›ƒìœ¼ë¡œ "ì ‘ì†ëŠê¸°" ì„ íƒ ì œê³µ
function showAlreadyOnlinePopup(userIdToKick, dataObj) {
  pendingLoginUserId = userIdToKick;
  pendingLoginData = dataObj || null;

  const html = `
    <div style="text-align:center; font-size:14px; line-height:1.7;">
      <div style="font-weight:900; font-size:16px; margin-bottom:8px;">
        ì´ë¯¸ ë‹¤ë¥¸ ê³³ì—ì„œ ì ‘ì†ì¤‘
      </div>

      <div style="color:#bbb; margin-bottom:10px;">
        í˜„ì¬ ê³„ì •ì´ ë‹¤ë¥¸ ê¸°ê¸°/íƒ­ì—ì„œ ì ‘ì†ì¤‘ì…ë‹ˆë‹¤.<br>
        ì´ê³³ì—ì„œ ì ‘ì†ì„ ê³„ì†í•˜ë ¤ë©´ ê¸°ì¡´ ì ‘ì†ì„ ëŠì–´ì•¼ í•©ë‹ˆë‹¤.
      </div>

      <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
        <button onclick="confirmForceDisconnectAndContinue()"
          style="padding:8px 14px; border-radius:10px; border:1px solid #444;
                 background:#2b2b2b; color:#fff; font-weight:900; cursor:pointer;">
          ì ‘ì†ëŠê¸°
        </button>

        <button onclick="closeNpcPopup()"
          style="padding:8px 14px; border-radius:10px; border:1px solid #333;
                 background:#141414; color:#bbb; font-weight:800; cursor:pointer;">
          ì·¨ì†Œ
        </button>
      </div>
    </div>
  `;

  // âœ… ê¸°ë³¸ í™•ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê³ (=false), HTML ë‚´ë¶€ ë²„íŠ¼ 2ê°œë¡œ ì²˜ë¦¬
  showNpcMessage(html, null, false, "");
}

// âœ… "ì ‘ì†ëŠê¸°" ëˆ„ë¥´ë©´: sessionId ë¹„ìš°ê³  â†’ ë°”ë¡œ startSession() â†’ ì´ì–´ì„œ ë¡œê·¸ì¸ ì§„í–‰
function confirmForceDisconnectAndContinue() {
  const uid = pendingLoginUserId;
  const data = pendingLoginData;

  if (!uid) {
    closeNpcPopup();
    return;
  }

  const ref = db.ref("users/" + uid);

// ê¸°ì¡´ ì„¸ì…˜/í•˜íŠ¸ë¹„íŠ¸ ì •ë¦¬ + ë‚´ ë¡œì»¬ ì„¸ì…˜ë„ ì´ˆê¸°í™”(ê°•ì œ íƒˆì·¨ ìƒí™©)
clearLocalSessionId(uid);

ref.update({ sessionId: "", sessionUpdatedAt: 0 }).then(() => {
  // 2) ì´ íƒ­ ê¸°ì¤€ ë¡œê·¸ì¸ ìƒíƒœ í™•ì •
  userId = uid;
  userRef = ref;

  // íŒì—… ë‹«ê¸°
  closeNpcPopup();

  // ì„¸ì…˜ ì‹œì‘ (ë„¤ ì½”ë“œì— ì´ë¯¸ ì¡´ì¬)
  startSession();

  // âœ… ê°•ì œíƒˆì·¨ë¡œ ë¡œê·¸ì¸ í™•ì • ì‹œ, ì´ ê¸°ê¸°ì˜ ìë™ë¡œê·¸ì¸ ê³„ì •ì„ ì§€ê¸ˆ uidë¡œ ê³ ì •
try {
  localStorage.setItem("swordGameLastUser", String(uid));
} catch (e) {}

  // âœ… ë°ì´í„° ì ìš©ì€ ê¸°ì¡´ ë¡œê·¸ì¸ ë£¨í‹´ì— ë§¡ê¸°ê³ 
  //    ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•: ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì •ìƒ ì§„ì…
  location.reload();

}).catch((e) => {
  console.error("âŒ forceDisconnect ì‹¤íŒ¨:", e);
  closeNpcPopup();
  showNpcMessage("ì ‘ì†ëŠê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", null, true, "");
});
}

// ëŠ¥ë ¥ì¹˜ ë²„íŠ¼ í´ë¦­ ì—°ê²°
const statDockBtn = document.getElementById("statDockBtn");
if (statDockBtn) {
  statDockBtn.addEventListener("click", () => {
  playUiDockTap();
  openStatOverlay();   // â† 1ë‹¨ê³„ ëŠ¥ë ¥ì¹˜ ì˜¤ë²„ë ˆì´
  });
}
  // ğŸ”’ ë£¬(ë¯¸êµ¬í˜„) ë²„íŠ¼ í´ë¦­ ì—°ê²°
const runeDockBtn = document.getElementById("runeDockBtn");
if (runeDockBtn) {
  runeDockBtn.addEventListener("click", () => {
    playUiDockTap();
    showLockedFeaturePopup();
  });
}

// ğŸ”’ ì‹ ìˆ˜(ë¯¸êµ¬í˜„) ë²„íŠ¼ í´ë¦­ ì—°ê²°
const beastDockBtn = document.getElementById("beastDockBtn");
if (beastDockBtn) {
  beastDockBtn.addEventListener("click", () => {
    playUiDockTap();
    showLockedFeaturePopup();
  });
}

  // ğŸ“œ ìŠ¤í¬ë¡¤ìƒì (êµ¬í˜„) ë²„íŠ¼ í´ë¦­ ì—°ê²°
const scrollShopDockBtn = document.getElementById("scrollShopDockBtn");
if (scrollShopDockBtn) {
  scrollShopDockBtn.addEventListener("click", () => {
    playUiDockTap();
    openScrollShop();
  });
}

  // ğŸ’ ì¸ë²¤í† ë¦¬(ì•„ì´ì½˜) ë²„íŠ¼ í´ë¦­ ì—°ê²°
const invBtn = document.getElementById("inventoryDockBtn");
if (invBtn) {
  invBtn.addEventListener("click", () => {
    playUiDockTap();
    toggleInventory();
  });
}

  function openStatOverlay(){
  const el = document.getElementById("statOverlay");
  if (!el) return;

  // -----------------------------
  // 1) íŒ¨ì‹œë¸Œ ë ˆë²¨ ê³„ì‚° (ë¬´ê¸°ë³„ 30ê°• ë‹¬ì„± íšŸìˆ˜ ê¸°ë°˜)
  // -----------------------------
  const counts = (typeof weapon30Counts === "object" && weapon30Counts) ? weapon30Counts : {};
  const getLv = (wt) => {
    const n = Number(counts[wt] || 0);
    return Math.max(0, Math.min(5, n)); // 1íšŒ=LV1, 5íšŒ=MAX
  };

  const lvSword  = getLv("sword");
  const lvSpear  = getLv("spear");
  const lvAxe    = getLv("axe");
  const lvBow    = getLv("bow");
  const lvStaff  = getLv("staff");
  const lvDagger = getLv("dagger");

  // âœ… 2) ì§„ì§œ ìµœì¢…ì¹˜(ì ˆëŒ€ìˆ˜ì¹˜) ê³„ì‚° ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
  const my = getPlayerFinalCombatStats();

      // âœ… ê°ì¸ 3ì¤„ í‘œê¸°
  const e1 = document.getElementById("engraveLine1");
  const e2 = document.getElementById("engraveLine2");
  const e3 = document.getElementById("engraveLine3");
  if (e1) e1.textContent = engraveLines?.[0] ?? "-";
  if (e2) e2.textContent = engraveLines?.[1] ?? "-";
  if (e3) e3.textContent = engraveLines?.[2] ?? "-";

      // âœ… Preset íƒ­ ë°”ì¸ë”©/í•˜ì´ë¼ì´íŠ¸
  const p1 = document.getElementById("engravePresetTab1");
  const p2 = document.getElementById("engravePresetTab2");
  const p3 = document.getElementById("engravePresetTab3");

  const paintPresetTabs = () => {
    const btns = [p1,p2,p3];
    btns.forEach((b, i) => {
      if (!b) return;
      const on = (i === Number(engravePresetIdx || 0));
      b.style.background = on ? "rgba(255, 213, 79, 0.18)" : "rgba(255,255,255,0.06)";
      b.style.borderColor = on ? "rgba(255, 213, 79, 0.45)" : "rgba(255,255,255,0.18)";
      b.style.color = on ? "#ffd54f" : "#eee";
    });
  };

  const applyPreset = (idx) => {
    engravePresetIdx = idx;
    ensureEngravePresetShape();
    save();            // âœ… ì„ íƒ í”„ë¦¬ì…‹ ì €ì¥
    openStatOverlay(); // âœ… í™”ë©´/ìŠ¤íƒ¯/ê°ì¸í‘œì‹œ ì¦‰ì‹œ ê°±ì‹ 
  };

  if (p1) p1.onclick = () => applyPreset(0);
  if (p2) p2.onclick = () => applyPreset(1);
  if (p3) p3.onclick = () => applyPreset(2);

  paintPresetTabs();

    // âœ… ê°ì¸ íš¨ê³¼ ìš”ì•½(ëŠ¥ë ¥ì¹˜ í‘œê¸°ìš©)
  const effEl = document.getElementById("engraveEffectList");
  if (effEl) {
    const eff = [];

    // ìì›/í–‰ë™
    if (Number(my.huntMaxPlus || 0) > 0) eff.push(`â€¢ ì‚¬ëƒ¥ ìµœëŒ€ íšŸìˆ˜ +${my.huntMaxPlus}`);
    if (Number(my.huntRechargeMinusMin || 0) > 0) eff.push(`â€¢ ì‚¬ëƒ¥ ì¶©ì „ì‹œê°„ -${my.huntRechargeMinusMin}ë¶„`);
    if (Number(my.huntDropPct || 0) > 0) eff.push(`â€¢ ì‚¬ëƒ¥ ì•„ì´í…œ ë“œëë¥  +${my.huntDropPct}%`);
    if (Number(my.huntGoldGainPct || 0) > 0) eff.push(`â€¢ ì‚¬ëƒ¥ ê³¨ë“œ íšë“ëŸ‰ +${my.huntGoldGainPct}%`);
    if (Number(my.upgradeFailGoldRefundPct || 0) > 0) eff.push(`â€¢ ê°•í™” ì‹¤íŒ¨ ê³¨ë“œ ì†Œëª¨ -${my.upgradeFailGoldRefundPct}%`);
    if (Number(my.upgradeChancePlus || 0) > 0) eff.push(`â€¢ ê°•í™” ì„±ê³µí™•ë¥  +${my.upgradeChancePlus}%`);

    // ë³´ìŠ¤ì „ ì „ìš© / íŠ¹ìˆ˜
    if (Number(my.bossRewardDropPct || 0) > 0) eff.push(`â€¢ ë³´ìŠ¤ì „ ë³´ìƒ ë“œëë¥  +${my.bossRewardDropPct}%`);
    if (Number(my.bossShieldBreakDmgPct || 0) > 0) eff.push(`â€¢ ë³´ìŠ¤ ë³´í˜¸ë§‰ íŒŒê´´ í”¼í•´ +${my.bossShieldBreakDmgPct}%`);
    if (Number(my.bossShieldRemoveChance || 0) > 0) eff.push(`â€¢ ê³µê²© ì‹œ ${Math.round(my.bossShieldRemoveChance * 100)}% í™•ë¥ ë¡œ ë³´ìŠ¤ì‹¤ë“œ ì œê±°`);
    if (Number(my.bossFirstHitBonusPct || 0) > 0) eff.push(`â€¢ ë³´ìŠ¤ ì²´ë ¥ 100% ì²«íƒ€ê²© ë°ë¯¸ì§€ +${my.bossFirstHitBonusPct}%`);
    if (Number(my.bossExecuteBonusPct || 0) > 0) eff.push(`â€¢ ë³´ìŠ¤ ì²´ë ¥ 1% ì´í•˜ ë°ë¯¸ì§€ +${my.bossExecuteBonusPct}%`);

    effEl.innerHTML = eff.length ? eff.join("<br>") : `<span style="color:#666;">(ì¶”ê°€ íš¨ê³¼ ì—†ìŒ)</span>`;
  }

  // (A) ë©”ì¸ ë¼ë²¨/ê°’
  const mainLabelEl = document.getElementById("statMainLabel"); // ìˆìœ¼ë©´ ì‚¬ìš©
  if (mainLabelEl) mainLabelEl.textContent = my.dmgLabel;

  const atkEl = document.getElementById("statAtk");
  if (atkEl) atkEl.textContent = formatNumberFullKR(my.mainPower);

  // (B) ë¬´ê¸° í‘œì‹œ(UX)
  const wLine = document.getElementById("statWeaponLine"); // ìˆìœ¼ë©´ ì‚¬ìš©
  if (wLine) wLine.textContent = `ë¬´ê¸°: ${my.weaponTypeKor}`;

  // (C) ì„œë¸ŒìŠ¤íƒ¯(0%ë„ í‘œê¸°)
  const penEl = document.getElementById("statPen");
  if (penEl) penEl.textContent = `${Math.round(my.penetration * 100)}%`;

  const igEvEl = document.getElementById("statIgnoreEvade") || document.getElementById("statIgnore");
  if (igEvEl) igEvEl.textContent = `${Math.round(my.ignoreEvade * 100)}%`;

  const crEl = document.getElementById("statCritRate") || document.getElementById("statCrit");
  if (crEl) crEl.textContent = `${Math.round(my.critRate * 100)}%`;

  const cdEl = document.getElementById("statCritDmg");
  if (cdEl) cdEl.textContent = `${Math.round(my.critDmgBonus * 100)}%`;

  const huntEl = document.getElementById("statHuntMaxPlus");
  if (huntEl) huntEl.textContent = `+${my.huntMaxPlus}`;

  // -----------------------------
  // 3) íŒ¨ì‹œë¸Œ ë¦¬ìŠ¤íŠ¸ ë Œë”
  // -----------------------------
  const listEl = document.getElementById("passiveSkillList");
  if (listEl) {
    const row = (icon, name, desc, lv, locked) => {
      const lvTxt = (lv >= 5) ? "MAX" : `LV${lv}`;
      return `
        <div class="passive-row ${locked ? "passive-locked" : ""}">
          <img class="passive-icon" src="${icon}" alt="">
          <div style="min-width:0;">
            <div class="passive-name">${name}</div>
            <div class="passive-desc">${desc}</div>
          </div>
          <div class="passive-lv">${locked ? "LOCK" : lvTxt}</div>
        </div>
      `;
    };

    const items = [];
    items.push(row(
      "images/skills/passive_knight_sword.png",
      "ê¸°ì‚¬ì˜ í˜¼",
      `ê³µê²©ë ¥/ì£¼ë¬¸ë ¥ +${lvSword * 10}%`,
      lvSword,
      lvSword <= 0
    ));
    items.push(row(
      "images/skills/passive_warrior_spear.png",
      "ì „ì‚¬ì˜ í˜¼",
      `ê´€í†µë ¥ +${lvSpear * 10}%`,
      lvSpear,
      lvSpear <= 0
    ));
    items.push(row(
      "images/skills/passive_viking_axe.png",
      "ë°”ì´í‚¹ì˜ í˜¼",
      `ì¹˜ëª…íƒ€í™•ë¥  +${lvAxe * 10}%`,
      lvAxe,
      lvAxe <= 0
    ));
    items.push(row(
      "images/skills/passive_hunter_bow.png",
      "ì‚¬ëƒ¥ê¾¼ì˜ í˜¼",
      `íšŒí”¼ë¬´ì‹œ +${lvBow * 10}%`,
      lvBow,
      lvBow <= 0
    ));
    items.push(row(
      "images/skills/passive_mage_staff.png",
      "ë§ˆë²•ì‚¬ì˜ í˜¼",
     `ì‚¬ëƒ¥íšŸìˆ˜ìµœëŒ€ì¹˜ +${my.huntMaxPlus}`,
      lvStaff,
      lvStaff <= 0
    ));
    items.push(row(
      "images/skills/passive_assassin_dagger.png",
      "ì–´ìŒ”ì‹ ì˜ í˜¼",
      `ì¹˜ëª…íƒ€ë°ë¯¸ì§€ +${lvDagger * 10}%`,
      lvDagger,
      lvDagger <= 0
    ));

    listEl.innerHTML = items.join("");
  }

  el.style.display = "block";

  document.getElementById("statDockBtn")?.classList.add("active");
}
  

  function closeStatOverlay(){
  const el = document.getElementById("statOverlay");
  if (!el) return;
  el.style.display = "none";
    document.getElementById("statDockBtn")?.classList.remove("active");
}

// âœ… ëŠ¥ë ¥ì¹˜ ì˜¤ë²„ë ˆì´: ë‹«ê¸°/ESC/í™”ë©´ë°–í„°ì¹˜ (DOM ë¡œë”© í›„ 1íšŒë§Œ ì—°ê²°)
window.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("statOverlay");
  const closeBtn = document.getElementById("statOverlayCloseBtn");

  if (closeBtn) closeBtn.addEventListener("click", closeStatOverlay);

  // ESC ë‹«ê¸°
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (!overlay) return;
    if (overlay.style.display === "block") closeStatOverlay();
  });

  // í™”ë©´ ë°– í„°ì¹˜ ë‹«ê¸° (ì˜¤ë²„ë ˆì´ ë°°ê²½ í´ë¦­ë§Œ)
  if (overlay) {
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeStatOverlay();
    });
  }

    // =========================
  // ğŸª¬ ê°ì¸ ì˜¤ë²„ë ˆì´ ì—´ê¸°/ë‹«ê¸°/íƒ­ ì—°ê²°
  // =========================
  const engraveOverlay = document.getElementById("engraveOverlay");
  const openEngraveBtn = document.getElementById("openEngraveOverlayBtn");
  const engraveCloseBtn = document.getElementById("engraveOverlayCloseBtn");

  const tabNormal = document.getElementById("engraveTabNormal");
  const tabAdvanced = document.getElementById("engraveTabAdvanced");
  const costText = document.getElementById("engraveCostText");

  const beforeWrap = document.getElementById("engraveBeforeWrap");
  const confirmBtn = document.getElementById("engraveConfirmBtn");
  const cancelBtn = document.getElementById("engraveCancelBtn");

   function setEngraveMode(mode){
    engraveMode = mode;

    // íƒ­ ìŠ¤íƒ€ì¼(ê°€ë³ê²Œ í™œì„±ë§Œ í‘œì‹œ)
    if (tabNormal) {
      tabNormal.style.background = (mode === "normal") ? "#ffd54f" : "rgba(255,255,255,0.08)";
      tabNormal.style.color = (mode === "normal") ? "#000" : "#eee";
    }
    if (tabAdvanced) {
      tabAdvanced.style.background = (mode === "advanced") ? "#ffd54f" : "rgba(255,255,255,0.08)";
      tabAdvanced.style.color = (mode === "advanced") ? "#000" : "#eee";
    }

    // ë¹„ìš© í‘œê¸°
    if (costText) {
  if (mode === "advanced") {
    costText.textContent = `ë¹„ìš©: ê³ ê¸‰ê°ì¸ì˜ ì£¼ë¬¸ì„œ 1ê°œ (ë³´ìœ : ${Number(itemEngraveAdvanced || 0)}ê°œ)`;
  } else {
    costText.textContent = `ë¹„ìš©: ì¼ë°˜ê°ì¸ì˜ ì£¼ë¬¸ì„œ 1ê°œ (ë³´ìœ : ${Number(itemEngraveNormal || 0)}ê°œ)`;
  }
}

    // ì „ ìƒíƒœ(ê³ ê¸‰ê°ì¸ì—ì„œë§Œ í‘œì‹œ)
    if (beforeWrap) beforeWrap.style.display = (mode === "advanced") ? "block" : "none";

    // ë²„íŠ¼(ì¼ë°˜ê°ì¸=í™•ì •ë§Œ, ê³ ê¸‰ê°ì¸=í™•ì •/ì·¨ì†Œ)
    if (cancelBtn) cancelBtn.style.display = (mode === "advanced") ? "block" : "none";
    if (confirmBtn) confirmBtn.textContent = "í™•ì •";
  }

    window.openEngraveOverlay = function(){
    if (!engraveOverlay) return;
    engraveOverlay.style.display = "block";

    // âœ… ì˜¤ë²„ë ˆì´ ì—´ ë•Œ: í˜„ì¬ í™•ì • ê°ì¸ 3ì¤„ì„ "í›„ ìƒíƒœ"ì— ë¨¼ì € í‘œì‹œ
    const cur = Array.isArray(engraveLines) ? engraveLines : ["-","-","-"];
    setBefore(cur);   // ê³ ê¸‰ê°ì¸ íƒ­ì—ì„œë§Œ ë³´ì´ì§€ë§Œ, ë°ì´í„°ëŠ” ë¯¸ë¦¬ ì„¸íŒ…
    setAfter(cur);

    lastRolledLines = null;
    setEngraveMode("normal");
  };

  window.closeEngraveOverlay = function(){
    if (!engraveOverlay) return;
    engraveOverlay.style.display = "none";
  };

  // ì—´ê¸° ë²„íŠ¼
  if (openEngraveBtn) {
    openEngraveBtn.addEventListener("click", () => {
      openEngraveOverlay();
    });
  }

  // X ë‹«ê¸°
  if (engraveCloseBtn) engraveCloseBtn.addEventListener("click", closeEngraveOverlay);

  // ë°°ê²½ í´ë¦­ ë‹«ê¸°
  if (engraveOverlay) {
    engraveOverlay.addEventListener("click", (e) => {
      if (e.target === engraveOverlay) closeEngraveOverlay();
    });
  }

  // íƒ­ í´ë¦­
  if (tabNormal) tabNormal.addEventListener("click", () => setEngraveMode("normal"));
  if (tabAdvanced) tabAdvanced.addEventListener("click", () => setEngraveMode("advanced"));

  // ESC ë‹«ê¸°(ëŠ¥ë ¥ì¹˜ overlay ESC ë¡œì§ê³¼ ê³µì¡´)
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (!engraveOverlay) return;
    if (engraveOverlay.style.display === "block") closeEngraveOverlay();
  });

    // âœ… 3ë‹¨ê³„: ê³ ê¸‰ê°ì¸ í™•ì •/ì·¨ì†Œ
  if (confirmBtn) confirmBtn.addEventListener("click", () => {
    // ì¼ë°˜ê°ì¸ì€ ë¦¬ë¡¤ ì¦‰ì‹œ í™•ì •ì´ë¼ ì—¬ê¸°ì„œ í•  ì¼ ì—†ìŒ
    if (engraveMode !== "advanced") {
      closeEngraveOverlay();
      return;
    }

    // ê³ ê¸‰ê°ì¸: ë§ˆì§€ë§‰ ë¦¬ë¡¤ ê²°ê³¼ë¥¼ í™•ì • ì ìš©
    if (!lastRolledLines) {
      pushSystemToast("ë¨¼ì € [ê°ì¸]ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ ìƒì„±í•´ì¤˜.");
      return;
    }

    setActiveEngraveLines([
  lastRolledLines[0] || "-",
  lastRolledLines[1] || "-",
  lastRolledLines[2] || "-"
]);
    lastRolledLines = null;

    save();
    update();

    // ëŠ¥ë ¥ì¹˜ ì˜¤ë²„ë ˆì´ê°€ ì—´ë ¤ìˆìœ¼ë©´ ì¦‰ì‹œ ê°±ì‹ 
    const statOverlay = document.getElementById("statOverlay");
    if (statOverlay && statOverlay.style.display === "block") {
      openStatOverlay();
    }

    closeEngraveOverlay();
  });

  if (cancelBtn) cancelBtn.addEventListener("click", () => {
    // ì¼ë°˜ê°ì¸ì€ ì·¨ì†Œ ë²„íŠ¼ì´ ì•ˆ ë³´ì´ì§€ë§Œ, ì•ˆì „ì¥ì¹˜
    if (engraveMode !== "advanced") {
      closeEngraveOverlay();
      return;
    }

    // ê³ ê¸‰ê°ì¸: ë¦¬ë¡¤ ê²°ê³¼ íê¸°(âš ï¸ ë¹„ìš©ì€ [ê°ì¸] ëˆ„ë¥¼ ë•Œ ì´ë¯¸ ì†Œëª¨ë˜ë¯€ë¡œ í™˜ë¶ˆ ì—†ìŒ)
    lastRolledLines = null;

    // í‘œì‹œë„ í˜„ì¬ í™•ì • ìƒíƒœë¡œ ë˜ëŒë¦¼
    const cur = Array.isArray(engraveLines) ? engraveLines : ["-","-","-"];
    setAfter(cur);

    closeEngraveOverlay();
  });

    // =========================
  // ğŸª¬ ê°ì¸(ë¦¬ë¡¤) 1ë‹¨ê³„: "í›„ ìƒíƒœ 3ì¤„" ëœë¤ ìƒì„±/í‘œì‹œ
  // =========================
  const rollBtn = document.getElementById("engraveRollBtn");

  const before1 = document.getElementById("engraveBefore1");
  const before2 = document.getElementById("engraveBefore2");
  const before3 = document.getElementById("engraveBefore3");

  const after1 = document.getElementById("engraveAfter1");
  const after2 = document.getElementById("engraveAfter2");
  const after3 = document.getElementById("engraveAfter3");

  // í˜„ì¬ ëª¨ë“œ/ë¦¬ë¡¤ ê²°ê³¼ ì„ì‹œ ë³´ê´€(2~3ë‹¨ê³„ì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
  let engraveMode = "normal";     // "normal" | "advanced"
  let lastRolledLines = null;     // ["...", "...", "..."]

  // âœ… ê°€ì¤‘ì¹˜ ëœë¤ 1ê°œ ë½‘ê¸°
  function pickWeighted(pool){
    let total = 0;
    for (const it of pool) total += Number(it.weight || 0);

    let r = Math.random() * total;
    for (const it of pool) {
      r -= Number(it.weight || 0);
      if (r <= 0) return it;
    }
    return pool[pool.length - 1];
  }

    // âœ… (ì¤‘ë³µ í—ˆìš©) 3ì¤„ ìƒì„± - ì¹´í…Œê³ ë¦¬/ì¢…ë¥˜/í‹°ì–´ í™•ë¥  ì„¤ê³„ ë°˜ì˜
  function rollEngraveLines(){

    // 1) ì¹´í…Œê³ ë¦¬ í™•ë¥  (20 / 45 / 20 / 10 / 5)
    const CATEGORIES = [
      { key:"ATK",   weight:20 }, // â‘  ê³µê²©
      { key:"RES",   weight:45 }, // â‘¢ ìì›/í–‰ë™
      { key:"SPEC",  weight:20 }, // â‘£ ìƒíƒœ/íŠ¹ìˆ˜
      { key:"BOSS",  weight:10 }, // â‘¤ ë³´ìŠ¤ì „ ì „ìš©
      { key:"META",  weight:5  }, // â‘¥ ì‹œìŠ¤í…œ/ë©”íƒ€
    ];

    // 2) ì¹´í…Œê³ ë¦¬ë³„ "ì¢…ë¥˜" ê°€ì¤‘ì¹˜
    // - ê³µê²© ê³„ì—´ì€ ë„¤ê°€ ì¤€ 10/10/18/18/22/22 ê·¸ëŒ€ë¡œ
    const TYPES = {
      ATK: [
        { key:"atkPct",   weight:10 },
        { key:"spellPct", weight:10 },
        { key:"critRate", weight:18 },
        { key:"critDmg",  weight:18 },
        { key:"pen",      weight:22 },
        { key:"ignoreEv", weight:22 },
      ],
      // ë‚˜ë¨¸ì§€ ì¹´í…Œê³ ë¦¬ëŠ” (ë„¤ê°€ ì¢…ë¥˜ ê°€ì¤‘ì¹˜ë¥¼ ë”°ë¡œ ì§€ì • ì•ˆ í–ˆìœ¼ë‹ˆ) ê· ë“± ë¶„ë°°ë¡œ ì‹œì‘
      RES: [
        { key:"huntMax",   weight:20 },
        { key:"failGold",  weight:20 },
        { key:"drop",      weight:20 },
        { key:"goldGain",  weight:20 },
        { key:"chargeCd",  weight:20 },
      ],
      SPEC: [
        { key:"stripShield", weight:40 },
        { key:"firstHit500", weight:30 },
        { key:"execute400",  weight:30 },
      ],
      BOSS: [
        { key:"bossDrop",    weight:55 },
        { key:"shieldBreak", weight:45 },
      ],
      META: [
        { key:"upgradeChance", weight:100 },
      ],
    };

    // 3) ìˆ˜ì¹˜ í‹°ì–´ í™•ë¥  (ê°€ì¤‘ì¹˜ë¡œ í‘œí˜„)
    // A) ê³µ/ì£¼: 6% 75 / 9% 20 / 12% 5
    const TIER = {
      atkPct: [
        { text:"ê³µê²©ë ¥ +6%",  weight:75 },
        { text:"ê³µê²©ë ¥ +9%",  weight:20 },
        { text:"ê³µê²©ë ¥ +12%", weight:5  },
      ],
      spellPct: [
        { text:"ì£¼ë¬¸ë ¥ +6%",  weight:75 },
        { text:"ì£¼ë¬¸ë ¥ +9%",  weight:20 },
        { text:"ì£¼ë¬¸ë ¥ +12%", weight:5  },
      ],

      // C) ë‚˜ë¨¸ì§€
      critRate: [
        { text:"ì¹˜ëª…íƒ€ í™•ë¥  +10%", weight:85 },
        { text:"ì¹˜ëª…íƒ€ í™•ë¥  +15%", weight:15 },
      ],
      critDmg: [
        { text:"ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ +15%", weight:80 },
        { text:"ì¹˜ëª…íƒ€ ë°ë¯¸ì§€ +25%", weight:20 },
      ],
      pen: [
        { text:"ê´€í†µë ¥ +10%", weight:80 },
        { text:"ê´€í†µë ¥ +15%", weight:20 },
      ],
      ignoreEv: [
        { text:"íšŒí”¼ë¬´ì‹œ +15%", weight:80 },
        { text:"íšŒí”¼ë¬´ì‹œ +20%", weight:20 },
      ],

      huntMax: [
        { text:"ì‚¬ëƒ¥ ìµœëŒ€ íšŸìˆ˜ +2", weight:85 },
        { text:"ì‚¬ëƒ¥ ìµœëŒ€ íšŸìˆ˜ +3", weight:15 },
      ],
      failGold: [
        { text:"ê°•í™” ì‹¤íŒ¨ ì‹œ ê³¨ë“œ ì†Œëª¨ ê°ì†Œ +30%", weight:80 },
        { text:"ê°•í™” ì‹¤íŒ¨ ì‹œ ê³¨ë“œ ì†Œëª¨ ê°ì†Œ +50%", weight:20 },
      ],
      drop: [
        { text:"ì‚¬ëƒ¥ ì•„ì´í…œ ë“œëë¥  +20%", weight:80 },
        { text:"ì‚¬ëƒ¥ ì•„ì´í…œ ë“œëë¥  +30%", weight:20 },
      ],
      goldGain: [
        { text:"ì‚¬ëƒ¥ ê³¨ë“œ íšë“ëŸ‰ +20%", weight:80 },
        { text:"ì‚¬ëƒ¥ ê³¨ë“œ íšë“ëŸ‰ +30%", weight:20 },
      ],
      chargeCd: [
        { text:"ì‚¬ëƒ¥ íšŸìˆ˜ ì¶©ì „ì‹œê°„ ê°ì†Œ +2ë¶„", weight:85 },
        { text:"ì‚¬ëƒ¥ íšŸìˆ˜ ì¶©ì „ì‹œê°„ ê°ì†Œ +3ë¶„", weight:15 },
      ],

      stripShield: [
        { text:"ê³µê²©ì‹œ 1% í™•ë¥ ë¡œ ë³´ìŠ¤ì‹¤ë“œ ëª¨ë‘ì œê±°", weight:90 },
        { text:"ê³µê²©ì‹œ 2% í™•ë¥ ë¡œ ë³´ìŠ¤ì‹¤ë“œ ëª¨ë‘ì œê±°", weight:10 },
      ],
      firstHit500: [
        { text:"ë³´ìŠ¤ ì²´ë ¥ì´ 100%ì¼ ë•Œ ì²«íƒ€ê²© ë°ë¯¸ì§€ +500%", weight:100 },
      ],
      execute400: [
        { text:"ë³´ìŠ¤ ì²´ë ¥ì´ 1% ì´í•˜ì¼ë•Œ ë°ë¯¸ì§€ +400%", weight:100 },
      ],

      bossDrop: [
        { text:"ë³´ìŠ¤ì „ ë³´ìƒ ë“œëë¥  +15%", weight:80 },
        { text:"ë³´ìŠ¤ì „ ë³´ìƒ ë“œëë¥  +20%", weight:20 },
      ],
      shieldBreak: [
        { text:"ë³´ìŠ¤ ë³´í˜¸ë§‰ íŒŒê´´ í”¼í•´ +30%", weight:100 },
      ],

      // B) ê°•í™” ì„±ê³µí™•ë¥ : +2% 97 / +3% 3
      upgradeChance: [
        { text:"ê°•í™” ì„±ê³µí™•ë¥  +2%", weight:97 },
        { text:"ê°•í™” ì„±ê³µí™•ë¥  +3%", weight:3  },
      ],
    };

    function rollOneLine(){
      const cat = pickWeighted(CATEGORIES).key;
      const type = pickWeighted(TYPES[cat]).key;
      return pickWeighted(TIER[type]).text;
    }

    return [rollOneLine(), rollOneLine(), rollOneLine()];
  }


  function setAfter(lines){
    if (!after1 || !after2 || !after3) return;
    after1.textContent = lines?.[0] ?? "-";
    after2.textContent = lines?.[1] ?? "-";
    after3.textContent = lines?.[2] ?? "-";
  }

  function setBefore(lines){
    if (!before1 || !before2 || !before3) return;
    before1.textContent = lines?.[0] ?? "-";
    before2.textContent = lines?.[1] ?? "-";
    before3.textContent = lines?.[2] ?? "-";
  }

  // ===== ê°ì¸ ì—°ì¶œ(1ì´ˆ ë‚´ì™¸) =====
let engraveAnimLock = false;

function setEngraveUiLocked(locked) {
  const overlay = document.getElementById("engraveOverlay");
  if (!overlay) return;

  const ids = [
    "engraveRollBtn",
    "engraveConfirmBtn",
    "engraveCancelBtn",
    "engraveTabNormal",
    "engraveTabAdvanced",
    "engraveOverlayCloseBtn"
  ];

  for (const id of ids) {
    const el = document.getElementById(id);
    if (!el) continue;
    if (locked) el.classList.add("btn-disabled");
    else el.classList.remove("btn-disabled");
  }
}

function playEngraveTextEffect(finalLines, onDone) {
  // finalLines: ["...", "...", "..."]
  const a1 = document.getElementById("engraveAfter1");
  const a2 = document.getElementById("engraveAfter2");
  const a3 = document.getElementById("engraveAfter3");
  if (!a1 || !a2 || !a3) { onDone?.(); return; }

  const els = [a1, a2, a3];

    // ğŸ”Š ê°ì¸ ë¦¬ë¡¤ ì „ìš© ì‚¬ìš´ë“œ: í´ë¦­(ì—°ì¶œ ì‹œì‘) í›„ 1ì´ˆ ë”œë ˆì´
  if (window.__engraveSfxTimer) clearTimeout(window.__engraveSfxTimer);
  window.__engraveSfxTimer = setTimeout(() => {
    try { playEngraveSound(); } catch(e) {}
  }, 1000);

  // 0) ì´ˆê¸°í™”
  for (const el of els) {
    el.classList.remove("is-rolling", "is-flash", "is-reveal");
  }

  // 1) í˜ì´ë“œì•„ì›ƒ + ë”ë¯¸ í…ìŠ¤íŠ¸
  const dummy = ["â€¦", "â€¦â€¦", "â€¦â€¦â€¦"];
  els.forEach((el, i) => {
    el.textContent = dummy[i];
    el.classList.add("is-rolling");
  });

  // 2) í”Œë˜ì‹œ
  setTimeout(() => {
    els.forEach((el) => {
      el.classList.remove("is-rolling");
      el.classList.add("is-flash");
    });
  }, 600);

  // 3) ê²°ê³¼ ë¦¬ë¹Œ
  setTimeout(() => {
    els.forEach((el, i) => {
      el.classList.remove("is-flash");
      el.textContent = finalLines[i] ?? "-";
      el.classList.add("is-reveal");
    });

    setTimeout(() => {
      els.forEach((el) => el.classList.remove("is-reveal"));
      onDone?.();
    }, 480);
  }, 820);
}

  // âœ… ê¸°ì¡´ setEngraveMode ë¡œì§ì´ ìˆì—ˆë‹¤ë©´ "ëª¨ë“œ ë³€ìˆ˜"ë§Œ ë™ê¸°í™”í•´ì£¼ê¸°
  // (ë„¤ íŒŒì¼ì— ì´ë¯¸ setEngraveModeê°€ ìˆìœ¼ë‹ˆ, ì•„ë˜ë§Œ ë§ëŒ€ëŠ” ë°©ì‹ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ê°)
  const _origSetEngraveMode = (typeof setEngraveMode === "function") ? setEngraveMode : null;

  function setEngraveModeSafe(mode){
    engraveMode = (mode === "advanced") ? "advanced" : "normal";

    // ê¸°ì¡´ UI í† ê¸€ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚´ë¦¬ê³ 
    if (_origSetEngraveMode) _origSetEngraveMode(mode);

    // advancedë©´ ì „ ìƒíƒœ ì˜ì—­ì„ ë³´ì´ê²Œ(HTMLì— ì´ë¯¸ ì¡´ì¬)
    if (beforeWrap) beforeWrap.style.display = (engraveMode === "advanced") ? "block" : "none";
  }

  // âœ… ê¸°ì¡´ íƒ­ í´ë¦­ì´ setEngraveMode("normal"/"advanced")ë¥¼ ë¶€ë¥´ë‹ˆê¹Œ, ê·¸ ë¶€ë¶„ì„ ì•ˆì „ ë˜í•‘
  // (ì•„ë˜ 2ì¤„ì€ "íƒ­ í´ë¦­ addEventListener" ì•„ë˜ì— ë‘ë©´ ì œì¼ í™•ì‹¤í•˜ì§€ë§Œ,
  //  ì§€ê¸ˆì€ ì—¬ê¸°ì„œ ì „ì—­ í•¨ìˆ˜ ì´ë¦„ì„ ë®ì§€ ì•Šê³  ì•ˆì „í•˜ê²Œ windowìª½ë§Œ êµì²´)
  window.setEngraveMode = setEngraveModeSafe;

  // âœ… ì—°ì¶œ ì¤‘ ì…ë ¥ ì ê¸ˆ
function setEngraveUiLocked(locked){
  const rollBtn = document.getElementById("engraveRollBtn");
  const confirmBtn = document.getElementById("engraveConfirmBtn");
  const cancelBtn  = document.getElementById("engraveCancelBtn");

  if (rollBtn) {
    rollBtn.disabled = locked;
    rollBtn.style.opacity = locked ? "0.55" : "1";
    rollBtn.style.cursor  = locked ? "not-allowed" : "pointer";
  }
  if (confirmBtn) {
    confirmBtn.disabled = locked;
    confirmBtn.style.opacity = locked ? "0.55" : "1";
    confirmBtn.style.cursor  = locked ? "not-allowed" : "pointer";
  }
  if (cancelBtn) {
    cancelBtn.disabled = locked;
    cancelBtn.style.opacity = locked ? "0.55" : "1";
    cancelBtn.style.cursor  = locked ? "not-allowed" : "pointer";
  }
}

// âœ… 1ì´ˆ ë‚´ì™¸ í…ìŠ¤íŠ¸ ì—°ì¶œ(â€œì‚¬ë¼ì¡Œë‹¤ê°€ ë¹›ë‚˜ë©° ê²°ê³¼ ë“±ì¥â€)
function playEngraveTextEffect(finalLines, onDone){
  const a1 = document.getElementById("engraveAfter1");
  const a2 = document.getElementById("engraveAfter2");
  const a3 = document.getElementById("engraveAfter3");
  const els = [a1, a2, a3].filter(Boolean);

  // 0) ì‹œì‘: íë¦¬ê²Œ + ì‚´ì§ ì‚¬ë¼ì§€ëŠ” ëŠë‚Œ
  els.forEach(el => {
    el.style.transition = "opacity 220ms ease, filter 220ms ease, transform 220ms ease";
    el.style.opacity = "0.0";
    el.style.filter = "brightness(2.0) drop-shadow(0 0 10px rgba(255,255,255,0.8))";
    el.style.transform = "translateY(-2px) scale(1.02)";
  });

  // 1) ì¤‘ê°„: ë¹ ë¥´ê²Œ ê¹œë¹¡ì´ë©° â€œëŒì•„ê°€ëŠ” ì¤‘â€ ëŠë‚Œ (ì§§ê²Œ)
  const flickerMs = 520;
  const start = Date.now();
  const timer = setInterval(() => {
    if (Date.now() - start > flickerMs) return;

    els.forEach(el => {
      el.textContent = "â€¦";
      el.style.opacity = (Math.random() * 0.6 + 0.2).toFixed(2);
      el.style.filter = "brightness(2.6) drop-shadow(0 0 14px rgba(255,255,255,0.95))";
    });
  }, 70);

  // 2) ì¢…ë£Œ: ê²°ê³¼ í™•ì • + ë°ê²Œ ë“±ì¥
  setTimeout(() => {
    clearInterval(timer);

    if (typeof setAfter === "function") setAfter(finalLines);

    els.forEach(el => {
      el.style.transition = "opacity 260ms ease, filter 260ms ease, transform 260ms ease";
      el.style.opacity = "1";
      el.style.filter = "brightness(1.4) drop-shadow(0 0 10px rgba(255,255,255,0.55))";
      el.style.transform = "translateY(0) scale(1)";
    });

    // 3) ì•„ì£¼ ì‚´ì§ ì”ê´‘ë§Œ ë‚¨ê¸°ê³  ì •ìƒí™”
    setTimeout(() => {
      els.forEach(el => {
        el.style.filter = "";
      });
      onDone && onDone();
    }, 260);
  }, 850); // ì „ì²´ ì—°ì¶œ 0.85~1.1ì´ˆ ì²´ê°
}


// âœ… ë¦¬ë¡¤ ë²„íŠ¼(ê°ì¸) í´ë¦­ ë¡œì§: â€œê²°ê³¼ë¥¼ ì¦‰ì‹œ setAfter()â€ í•˜ì§€ ë§ê³ , ì—°ì¶œ ëì—ì„œ ë„£ê¸°
if (rollBtn) {
  rollBtn.addEventListener("click", () => {
    if (engraveAnimLock) return;

    // ëª¨ë“œ ë³€ìˆ˜ëŠ” ë„¤ê°€ ì´ë¯¸ ì“°ê³  ìˆëŠ” engraveMode ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const mode = (engraveMode === "advanced") ? "advanced" : "normal";

   // âœ… ë¹„ìš©: ì£¼ë¬¸ì„œ 1ê°œ ì†Œëª¨ (ì¼ë°˜/ê³ ê¸‰ ê°ì¸ ë²„íŠ¼ ëˆ„ë¥´ëŠ” ì¦‰ì‹œ)
if (mode === "advanced") {
  if (Number(itemEngraveAdvanced || 0) < 1) {
    showNpcMessage("ê³ ê¸‰ ê°ì¸ì˜ ì£¼ë¬¸ì„œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", null, true, "");
    return;
  }
  itemEngraveAdvanced = Number(itemEngraveAdvanced || 0) - 1;
} else {
  if (Number(itemEngraveNormal || 0) < 1) {
    showNpcMessage("ì¼ë°˜ ê°ì¸ì˜ ì£¼ë¬¸ì„œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.", null, true, "");
    return;
  }
  itemEngraveNormal = Number(itemEngraveNormal || 0) - 1;
}

// ì†Œëª¨ëŠ” ì¦‰ì‹œ ì €ì¥/ê°±ì‹ 
if (typeof save === "function") save();
if (typeof update === "function") update();

// (ì„ íƒ) ë¹„ìš© í‘œê¸°ë„ ì¦‰ì‹œ ê°±ì‹ 
if (typeof setEngraveMode === "function") setEngraveMode(engraveMode);

    // ê³¨ë“œ ì°¨ê°ì€ ì¦‰ì‹œ ì €ì¥/ê°±ì‹  (ì—°ì¶œ ì¤‘ì´ë¼ë„ ëˆì€ ë¹ ì ¸ì•¼ í•¨)
    if (typeof save === "function") save();
    if (typeof update === "function") update();

    // âœ… ì´ë²ˆì— ë½‘íŒ 3ì¤„(ì•„ì§ í™”ë©´ setAfterëŠ” ì—°ì¶œ ëì—ì„œ!)
    const lines = (typeof rollEngraveLines === "function")
      ? rollEngraveLines()
      : ["-","-","-"];

    const finalLines = [lines[0] || "-", lines[1] || "-", lines[2] || "-"];

    // âœ¨ í…ìŠ¤íŠ¸ ì—°ì¶œ â†’ ëì—ì„œ ì ìš©
    playEngraveTextEffect(finalLines, () => {
      if (mode === "normal") {
        // âœ… ì¼ë°˜ê°ì¸: ì—°ì¶œ ëë‚˜ë©´ ì¦‰ì‹œ í™•ì • ë°˜ì˜
        setActiveEngraveLines(finalLines);
        lastRolledLines = null;

        if (typeof save === "function") save();
        if (typeof update === "function") update();

        const statOverlay = document.getElementById("statOverlay");
        if (statOverlay && statOverlay.style.display === "block" && typeof openStatOverlay === "function") {
          openStatOverlay();
        }
      } else {
        // âœ… ê³ ê¸‰ê°ì¸: ì—°ì¶œ ëë‚˜ë©´ ì„ì‹œë³´ê´€(í™•ì •/ì·¨ì†Œë¡œ ì²˜ë¦¬)
        lastRolledLines = finalLines;

        // (ê³ ê¸‰ê°ì¸ì€ í™•ì • ì‹œì— save/update í•˜ë‹ˆê¹Œ ì—¬ê¸°ì„œëŠ” ì €ì¥ ì•ˆ í•´ë„ ë¨)
        // ë‹¨, â€œí›„ ìƒíƒœ í‘œì‹œâ€ëŠ” ì´ë¯¸ playEngraveTextEffect ì•ˆì—ì„œ setAfterë¡œ ì²˜ë¦¬ë¨
      }

      // ğŸ”“ ì—°ì¶œ ì¢…ë£Œ: ì…ë ¥ í•´ì œ
      engraveAnimLock = false;
      setEngraveUiLocked(false);
    });
  });
}
  
});

  // ğŸ–±ï¸ ì „ì—­ ê³µí†µ ë²„íŠ¼ í´ë¦­ ì‚¬ìš´ë“œ ì²˜ë¦¬(ì¡ë‹¤í•œ ë²„íŠ¼ í†µì¼)
document.addEventListener("click", function(e){
  const target = e.target.closest("button, .poi, [role='button'], .clickable");
  if (!target) return;

  // âŒ ì˜ˆì™¸: ì „ìš© ì‚¬ìš´ë“œ ë²„íŠ¼
  if (target.dataset && target.dataset.nosfx === "1") return;

  // âŒ ì˜ˆì™¸: ì…ë ¥ ê³„ì—´
  if (target.tagName === "INPUT" || target.tagName === "TEXTAREA") return;

  playUiClickCommon();
});

    </script>

<!-- ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ (NPC ë²„ì „) -->
<div id="tutorialOverlay">
  <div class="tutorial-box" style="text-align:center;">
    <img src="images/npc/blacksmith_idle.png"
         alt="ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸"
         class="npc-popup-img">

   <p style="margin:6px 0 10px 0; font-weight:bold;">
  í—ˆí—ˆâ€¦ ì˜ ì™”êµ¬ë§Œ. ë‚˜ëŠ” ì´ ì™•êµ­ ìµœê³ ì˜ ëŒ€ì¥ì¥ì´, í¼ê·¸ë€íŠ¸ë¼ í•˜ì§€.
</p>

<p style="margin:4px 0; text-align:left; line-height:1.45;">
  â€¢ ìƒë‹¨ ì™¼ìª½ì˜ <b>[ì¶œì„]</b> ë²„íŠ¼ì€ ìŠì§€ ë§ê²Œ.<br>
    ë‹¨ë ¨ì—ëŠ” ìê¸ˆì´ í•„ìš”í•œ ë²•ì´ê±°ë“ .<br><br>

  â€¢ ìƒë‹¨ ì˜¤ë¥¸ìª½ <b>[MAP]</b>ì—ì„œëŠ”<br>
    ê·¸ëŒ€ê°€ ê²€ì„ ì‹œí—˜í•  ì‚¬ëƒ¥í„°ë¥¼ ê³ ë¥¼ ìˆ˜ ìˆë‹¤ë„¤.<br><br>

  â€¢ í™”ë©´ ì¤‘ì•™ì˜ <b>ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤</b> ë²„íŠ¼â€¦<br>
    ì´ê²ƒë“¤ì´ì•¼ë§ë¡œ ëª¨í—˜ê°€ì˜ ê¸¸ì„ ì¢Œìš°í•˜ëŠ” í•µì‹¬ì´ì§€.<br><br>

  â€¢ ì˜¤ë¥¸ìª½ ì•„ë˜ <b>ì¸ë²¤í† ë¦¬ / ë¡œê·¸</b>ëŠ”<br>
    ê·¸ëŒ€ê°€ ê±¸ì–´ì˜¨ ë°œìì·¨ë¥¼ ë‚¨ê²¨ ë‘ëŠ” ê³³ì´ë¼ë„¤.<br><br>

  â€¢ ê°€ëŠ¥í•˜ë‹¤ë©´ <b>ì „ì²´í™”ë©´</b>ìœ¼ë¡œ ì¦ê¸°ê²Œ.<br>
    ì„¸ê³„ë¥¼ ë„“ê²Œ ë³¼ìˆ˜ë¡, ê²€ë„ í¬ê²Œ ì„±ì¥í•˜ë‹ˆê¹Œ ë§ì´ì•¼.
</p>

    <button class="tutorial-close-btn" onclick="closeTutorial()">
      ì•Œê² ë„¤
    </button>
  </div>
</div>

<!-- ğŸ§” ëŒ€ì¥ì¥ì´ / ë¬´ê¸°ìƒì¸ ê³µìš© NPC íŒì—… -->
<div id="npcPopup">
  <div class="npc-popup-inner">

    <!-- ğŸ†• NPC ì´ë¦„í‘œ -->
    <div id="npcPopupName"
         style="font-weight:bold; font-size:15px; margin-bottom:6px;">
    </div>

    <img id="npcPopupImg"
         src="images/npc/blacksmith_idle.png"
         class="npc-popup-img">

    <div class="npc-popup-text" id="npcPopupText"></div>

    <div style="margin-top:10px;">
      <button class="npc-popup-btn" id="npcConfirmBtn">í™•ì¸</button>
      <button class="npc-popup-btn" id="npcCancelBtn" style="display:none;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

  <!-- âš”ï¸ ê²°íˆ¬ VS ì—°ì¶œ ì˜¤ë²„ë ˆì´ -->
<div id="duelBattleOverlay">
  <div class="duel-battle-inner">
    <div class="duel-battle-title">âš”ï¸ ê²°íˆ¬ ê°œì‹œ</div>

    <div class="duel-battle-row">
      <!-- ì™¼ìª½: ë‚˜ -->
      <div class="duel-side">
        <div class="duel-user-name" id="duelMyName"></div>
        <div class="duel-weapon-name" id="duelMyWeapon"></div>
        <div class="duel-weapon-img-box">
          <img id="duelMyWeaponImg" src="" alt="ë‚´ ë¬´ê¸°">
        </div>
        <div class="duel-power" id="duelMyPower"></div>
      </div>

      <div class="duel-vs-text">VS</div>

      <!-- ì˜¤ë¥¸ìª½: ìƒëŒ€ -->
      <div class="duel-side">
        <div class="duel-user-name" id="duelTargetName"></div>
        <div class="duel-weapon-name" id="duelTargetWeapon"></div>
        <div class="duel-weapon-img-box">
          <img id="duelTargetWeaponImg" src="" alt="ìƒëŒ€ ë¬´ê¸°">
        </div>
        <div class="duel-power" id="duelTargetPower"></div>
      </div>
    </div>

    <div class="duel-battle-sub">
      ì ì‹œ í›„ ì „íˆ¬ ê²°ê³¼ê°€ ê³µê°œë©ë‹ˆë‹¤...
    </div>
  </div>
</div>

<!-- ğŸ‘¤ ë‹¤ë¥¸ ìœ ì € í”„ë¡œí•„ íŒì—… (ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì—†ìŒ) -->
<div id="otherProfileOverlay">
  <div class="other-profile-card">
    <div class="other-profile-header">
      <div id="otherProfileNickname" class="profile-nickname">-</div>

      <!-- âœ… ìš°ì¸¡ ìƒë‹¨ X ë²„íŠ¼ í•˜ë‚˜ë§Œ -->
      <button
        id="otherProfileCloseBtn"
        class="other-profile-close-btn">
        &times;
      </button>
    </div>

    <div class="profile-card-inner">
      <div class="profile-weapon-box">
        <img id="otherWeaponImage"
             src="images/weapons/sword_real_temp.png"
             alt="ë¬´ê¸°">
      </div>

      <div class="profile-info-box">
        <div id="otherProfileWeaponTitle" class="profile-weapon-title">-</div>

        <hr class="profile-inner-divider">

        <div id="otherProfileWeaponDesc" class="profile-weapon-desc">-</div>

        <hr class="profile-inner-divider">

        <div class="profile-row">
          <span class="profile-label">ìµœëŒ€ ê°•í™”</span>
          <span class="profile-value" id="otherProfileMaxInfo">-</span>
        </div>

        <div class="profile-row">
          <span class="profile-label">ê³¨ë“œ</span>
          <span class="profile-value" id="otherProfileGold">0</span>
        </div>
        
<div class="profile-row">
  <span class="profile-label" id="otherProfilePowerLabel">ê³µê²©ë ¥</span>
<span class="profile-value" id="otherProfilePower">0</span>
</div>

<div class="profile-row" style="flex-direction:column; align-items:center; gap:6px;">
  <span style="color:#bbb;">ê°ì¸</span>
  <div id="otherProfileEngrave1" style="width:100%; text-align:center; color:#eaeaea;">-</div>
  <div id="otherProfileEngrave2" style="width:100%; text-align:center; color:#eaeaea;">-</div>
  <div id="otherProfileEngrave3" style="width:100%; text-align:center; color:#eaeaea;">-</div>
</div>

      </div>
    </div>
  </div>
</div>

<!-- ğŸ’ ì•„ì´í…œ ìƒì„¸ í‘œì‹œ ì˜¤ë²„ë ˆì´ -->
<div id="itemDetailOverlay">
  <div id="itemDetailBox">
    <img id="itemDetailImg" src="" alt="">
    <div id="itemDetailName"></div>
    <div id="itemDetailDesc"></div>
  </div>
</div>

  <!-- ğŸŒ ì „ ì„œë²„ ë„ì „ ì•Œë¦¼ ë°°ë„ˆ -->
  <div id="worldBanner"></div>
  
<div id="upgradeFlashOverlay"></div>

<!-- ğŸ·ï¸ ì—…ì (ì¹­í˜¸) ì˜¤ë²„ë ˆì´ -->
<div id="titleOverlay" class="titleOverlay"
     onclick="if(event.target===this) closeTitleOverlay();">
  <div class="titlePanel" onclick="event.stopPropagation();">

    <!-- í—¤ë” -->
    <div class="titleHeader">
      <div class="titleHeaderLeft">ì—…ì (ì¹­í˜¸)</div>

      <div class="titleHeaderRight">
        <button id="titleSortBtn" class="titleBtn">ìµœê·¼íšë“ìˆœ</button>
        <button class="titleBtn titleBtnClose" onclick="closeTitleOverlay()">âœ•</button>
      </div>
    </div>

    <!-- ì¥ì°©ì¤‘ -->
    <div class="titleEquippedRow">
      ì¥ì°©ì¤‘: <span id="equippedTitleText">(ì—†ìŒ)</span>
    </div>

    <!-- ê·¸ë¦¬ë“œ -->
    <div id="titleGrid" class="titleGrid"></div>

<!-- NPC/ëŒ€ì‚¬ -->
<div class="titleNpcWrap">
  <div class="titleNpcTalk">
    <div class="titleNpcName">ì„œê¸°ê´€ ë¦¬ë„¤ì•„</div>
    <div id="titleNpcText">ì¹­í˜¸ëŠ” ëª…ì˜ˆì´ì ê¸°ë¡ì´ì•¼! ì–´ë–¤ ê±¸ ë‹¬ì•„ë³¼ë˜?</div>
  </div>

  <img id="titleNpcImg"
       class="titleNpcImg"
       src="images/npc/linea_idle.png"
       alt="ë¦¬ë„¤ì•„"
       draggable="false">
</div>
    </div>

  </div>
</div>

  <!-- ğŸŒ™ +30 ê¸€ë¡œë²Œ ì—°ì¶œ ì˜¤ë²„ë ˆì´ -->
<div id="global30Overlay" style="display:none;">
  <div class="global30-backdrop"></div>
  <div class="global30-box">
    <div id="global30Title" class="global30-title"></div>
    <div id="global30Desc" class="global30-desc"></div>
    <button class="global30-btn" onclick="closeGlobal30Overlay()">í™•ì¸</button>
  </div>
</div>

  </div>

  <!-- ğŸ§® ëŠ¥ë ¥ì¹˜ ì˜¤ë²„ë ˆì´ (1ë‹¨ê³„) -->
<div id="statOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  z-index:3000;
">
  <div style="
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:860px;
    height:520px;
    position:relative;
    background:#0b0b0b;
    border:1px solid rgba(255,255,255,0.15);
    display:flex;
    color:#eee;
    font-family:inherit;
  ">
    <!-- ë‹«ê¸° ë²„íŠ¼ -->
<button id="statOverlayCloseBtn" style="
  position:absolute;
  top:8px;
  right:8px;
  width:26px;
  height:26px;
  border:0;
  border-radius:8px;
  background:rgba(255,255,255,0.08);
  color:rgba(255,255,255,0.88);
  font-size:16px;
  font-weight:900;
  cursor:pointer;

  display:flex;
  align-items:center;
  justify-content:center;
  line-height:1;
  padding:0;
">âœ•</button>

    <!-- 1ë‹¨ê³„ ëŠ¥ë ¥ì¹˜ ì˜ì—­ -->
    <div style="
      width:50%;
      padding:24px;
      border-right:1px solid rgba(255,255,255,0.1);
    ">
      <div style="font-size:18px;font-weight:900;margin-bottom:16px;">
        ëŠ¥ë ¥ì¹˜
      </div>

      <!-- ë¬´ê¸° í‘œì‹œ(UX) -->
<div id="statWeaponLine" style="font-size:13px;color:#aaa;margin-bottom:8px;">
  ë¬´ê¸°: -
</div>

<!-- ë©”ì¸ ìŠ¤íƒ¯(ê³µê²©ë ¥/ì£¼ë¬¸ë ¥) -->
<div style="font-size:21px;font-weight:900;margin-bottom:18px;">
  âš” <span id="statMainLabel">ê³µê²©ë ¥</span> <span id="statAtk">0</span>
</div>

      <div class="stat-line">ê´€í†µë ¥ <span id="statPen">0%</span></div>
      <div class="stat-line">íšŒí”¼ ë¬´ì‹œ <span id="statIgnore">0%</span></div>
      <div class="stat-line">ì¹˜ëª…íƒ€ í™•ë¥  <span id="statCrit">0%</span></div>
      <div class="stat-line">ì¹˜ëª…íƒ€ í”¼í•´ <span id="statCritDmg">0%</span></div>

      <!-- ======================
     ğŸª¬ ê°ì¸(í‘œì‹œìš©) + ê°ì¸í•˜ê¸° ë²„íŠ¼
     ====================== -->
<div style="margin-top:18px; padding-top:14px; border-top:1px solid rgba(255,255,255,0.08);">
  <div style="font-size:14px; font-weight:900; margin-bottom:8px;">ê°ì¸</div>

    <!-- âœ… Preset íƒ­ -->
  <div id="engravePresetTabs" style="display:flex; gap:6px; margin:6px 0 10px 0;">
    <button id="engravePresetTab1" style="flex:1; padding:6px 0; border-radius:8px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#eee; font-weight:900; cursor:pointer; font-size:12px;">Preset 1</button>
    <button id="engravePresetTab2" style="flex:1; padding:6px 0; border-radius:8px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#eee; font-weight:900; cursor:pointer; font-size:12px;">Preset 2</button>
    <button id="engravePresetTab3" style="flex:1; padding:6px 0; border-radius:8px; border:1px solid rgba(255,255,255,0.18); background:rgba(255,255,255,0.06); color:#eee; font-weight:900; cursor:pointer; font-size:12px;">Preset 3</button>
  </div>

  <!-- 3ì¤„ í‘œì‹œ(í˜„ì¬ëŠ” ìë¦¬ë§Œ) -->
  <div id="engraveLine1" style="font-size:13px; color:#cfcfcf; margin-bottom:4px;">-</div>
  <div id="engraveLine2" style="font-size:13px; color:#cfcfcf; margin-bottom:4px;">-</div>
  <div id="engraveLine3" style="font-size:13px; color:#cfcfcf;">-</div>
  <div id="engraveEffectList" style="margin-top:10px; font-size:12px; color:#9fd3ff; line-height:1.5;"></div>

  <button id="openEngraveOverlayBtn"
  style="margin-top:10px; width:100%; padding:5px 8px; border-radius:8px; border:0; cursor:pointer; font-weight:900; font-size:12px;">
  ê°ì¸í•˜ê¸°
</button>

  <div style="margin-top:8px; font-size:11px; color:#777; line-height:1.35;">
    -
  </div>
</div>
    </div>

    <!-- ìš°ì¸¡ (2ë‹¨ê³„ íŒ¨ì‹œë¸Œ ì˜ì—­) -->
<div style="width:50%; padding:24px;">
  <div style="font-size:18px;font-weight:900;margin-bottom:12px;">
    íŒ¨ì‹œë¸Œ ìŠ¤í‚¬
  </div>

  <!-- ë¦¬ìŠ¤íŠ¸ ë“¤ì–´ê°ˆ ìë¦¬ -->
  <div id="passiveSkillList"></div>

  <div style="margin-top:12px; font-size:12px; color:#777; line-height:1.4;">
    â€¢ íšë“ì¡°ê±´: ë¬´ê¸° +30 ë‹¬ì„± ì‹œ LV1
  </div>
</div>

  </div>
</div>

  <!-- ğŸª¬ ê°ì¸ ì˜¤ë²„ë ˆì´ -->
<div id="engraveOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.70);
  z-index:3500;
">
    <div style="
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    width:min(860px, calc(100% - 40px));
    height:min(560px, calc(100% - 60px));
    background:#0b0b0b;
    border:1px solid rgba(255,255,255,0.15);
    color:#eee;
    font-family:inherit;
    border-radius:12px;
    overflow:hidden;
  ">
        <!-- ìƒë‹¨ë°” -->
    <div style="display:flex; align-items:center; justify-content:space-between; padding:14px 14px; border-bottom:1px solid rgba(255,255,255,0.08);">
      <div style="font-size:18px; font-weight:900;">ê°ì¸</div>

      <button id="engraveOverlayCloseBtn" style="
        width:30px; height:30px;
        margin:0; padding:0;
        border:0; border-radius:10px;
        display:grid; place-items:center;
        background:rgba(255,255,255,0.08); color:rgba(255,255,255,0.88);
        font-size:16px; font-weight:900; cursor:pointer;
        line-height:30px;
      ">âœ•</button>
    </div>

    <!-- íƒ­ -->
    <div style="display:flex; gap:8px; padding:10px 14px; border-bottom:1px solid rgba(255,255,255,0.08); flex-wrap:nowrap;">
      <button id="engraveTabNormal" style="margin:0; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:900; white-space:nowrap;">
        ì¼ë°˜ê°ì¸
      </button>
      <button id="engraveTabAdvanced" style="margin:0; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; font-weight:900; white-space:nowrap;">
        ê³ ê¸‰ê°ì¸
      </button>

      <div style="flex:1;"></div>

    </div>

    <!-- ë³¸ë¬¸(2ì»¬ëŸ¼) -->
    <div style="display:flex; height:calc(100% - 120px);">
      <!-- ì¢Œ: ê²°ê³¼ -->
      <div style="width:58%; padding:16px; border-right:1px solid rgba(255,255,255,0.08);">
        <div style="font-size:14px; font-weight:900; margin-bottom:10px;">ê²°ê³¼</div>

        <!-- ê³ ê¸‰ê°ì¸ ì „ ìƒíƒœ -->
        <div id="engraveBeforeWrap" style="display:none; margin-bottom:14px;">
          <div style="font-size:12px; color:#aaa; margin-bottom:6px; font-weight:900;">ì „ ìƒíƒœ</div>
          <div style="padding:12px; border:1px solid rgba(255,255,255,0.10); border-radius:12px; background:rgba(255,255,255,0.03);">
            <div id="engraveBefore1" style="font-size:13px; margin-bottom:4px;">-</div>
            <div id="engraveBefore2" style="font-size:13px; margin-bottom:4px;">-</div>
            <div id="engraveBefore3" style="font-size:13px;">-</div>
          </div>
        </div>

        <!-- í›„ ìƒíƒœ(ì¼ë°˜/ê³ ê¸‰ ê³µí†µ í‘œì‹œ) -->
        <div>
          <div style="font-size:12px; color:#aaa; margin-bottom:6px; font-weight:900;">í›„ ìƒíƒœ</div>
          <div style="padding:12px; border:1px solid rgba(255,255,255,0.10); border-radius:12px; background:rgba(255,255,255,0.03);">
            <div id="engraveAfter1" class="engrave-line" style="font-size:13px; margin-bottom:4px;">-</div>
            <div id="engraveAfter2" class="engrave-line" style="font-size:13px; margin-bottom:4px;">-</div>
            <div id="engraveAfter3" class="engrave-line" style="font-size:13px;">-</div>
          </div>
        </div>

        <div style="margin-top:10px; font-size:11px; color:#777; line-height:1.4;">
          â€¢ ì¼ë°˜ê°ì¸: ë¦¬ë¡¤ ì¦‰ì‹œ â€œí›„ ìƒíƒœâ€ë¡œ í™•ì •<br>
          â€¢ ê³ ê¸‰ê°ì¸: ë¦¬ë¡¤ í›„ â€œí™•ì •/ì·¨ì†Œâ€ ì„ íƒ
        </div>
      </div>

      <!-- ìš°: ì¡°ì‘ -->
      <div style="width:42%; padding:16px; display:flex; flex-direction:column;">
        <div style="font-size:14px; font-weight:900; margin-bottom:10px;">ì¡°ì‘</div>

        <div id="engraveCostText" style=" margin:0 0 10px 0; font-size:14px; font-weight:900; color:#ffd54f; text-align:right; ">ë¹„ìš©: -</div>

        <button id="engraveRollBtn"
          style="margin:0 0 10px 0; padding:14px 12px; border-radius:12px; border:0; cursor:pointer; font-weight:900;
            font-size:16px; width:100%; ">
          ê°ì¸
        </button>

        <div style="flex:1; font-size:12px; color:#8a8a8a; line-height:1.5;">
          í´ë¦­ì‹œ ê°ì¸ì„ ì¬ì„¤ì •í•©ë‹ˆë‹¤.
        </div>

        <div style="display:flex; gap:10px;">
          <button id="engraveConfirmBtn"
            style="flex:1; margin:0; padding:6px 10px; border-radius:10px; border:0; cursor:pointer; font-weight:900; font-size:13px;">
            í™•ì •
          </button>

          <button id="engraveCancelBtn"
            style="flex:1; margin:0; padding:6px 10px; border-radius:10px; border:0; cursor:pointer; font-weight:900; font-size:13px;">
            ì·¨ì†Œ
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
