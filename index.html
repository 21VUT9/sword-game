<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ê²€ í‚¤ìš°ê¸°</title>


<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:Arial;
}
  
  /* ğŸ« ì¶œì„ ë²„íŠ¼ */
#attendanceBtn {
  position:fixed;
  top:10px;
  left:10px;
  z-index:1100;
  display:none;          /* ë¡œê·¸ì¸ í›„ JSë¡œ ë³´ì´ê²Œ */
  font-size:14px;
  padding:8px 16px;
}

/* ë²„íŠ¼ */
button {
  padding:15px 30px;
  font-size:18px;
  margin:10px;
}

/* ğŸŒˆ 30ê°• ë¬´ì§€ê°œ */
.rainbow {
  background:linear-gradient(90deg,red,orange,yellow,green,cyan,blue,violet);
  background-size:400% 400%;
  -webkit-background-clip:text;
  color:transparent;
  animation:rainbow 2s linear infinite;
  display:inline-block;
}
@keyframes rainbow {
  from {background-position:0%}
  to {background-position:100%}
}
  /* âœ¨ ì‹¤ë²„ / ê³¨ë“œ ë°˜ì§ì„ */
.sparkle-silver {
  color: #C0C0C0;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(192,192,192,0.8);
  animation: sparkle 1.5s infinite alternate;
}

.sparkle-gold {
  color: #FFD700;
  font-weight: bold;
  text-shadow: 0 0 8px rgba(255,215,0,0.9);
  animation: sparkle 1.2s infinite alternate;
}

/* âœ¨ ê³µí†µ ë°˜ì§ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes sparkle {
  from {
    opacity: 0.85;
    filter: brightness(1);
  }
  to {
    opacity: 1;
    filter: brightness(1.4);
  }
}


/* ğŸ”” í† ìŠ¤íŠ¸ */
#toastLog {
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:600px;
  background:rgba(0,0,0,0.75);
  border:1px solid #444;
  padding:8px;
  font-size:14px;
  z-index:1000;
}
.toast-item {
  padding:4px 0;
  border-bottom:1px solid #333;
}
.toast-destroy {
  color:red;
  font-weight:bold;
}

/* ë¡œê·¸ */
#logToggle {
  position:fixed;
  bottom:80px;
  right:10px;
  z-index:1001;
}
#logPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:90%;
  max-width:400px;
  height:60%;
  background:rgba(0,0,0,0.9);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1002;
  display:none;
}

/* ================= ìœ ì € í”„ë¡œí•„ ì¹´ë“œ ================ */

#userProfileArea {
  max-width: 320px;
  margin: 10px auto 20px auto;
  background: #181818;
  border-radius: 16px;
  box-shadow: 0 0 18px rgba(0,0,0,0.7);
  padding: 16px 12px 14px 12px;
}

.profile-card-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ì„¼í„° ë¬´ê¸° ì´ë¯¸ì§€ */
.profile-weapon-box {
  width: 160px;
  height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 8px;
}

/* ë‚˜ì¤‘ì— íˆ¬ëª… PNGë¡œ êµì²´í•˜ë©´ ë¨ */
#weaponImage {
  max-width: 100%;
  max-height: 100%;
  image-rendering: pixelated;  /* í”½ì…€ ëŠë‚Œ ì‚´ë¦¬ê¸° */
}

/* í•˜ë‹¨ ì •ë³´ ì˜ì—­ */
.profile-info-box {
  width: 100%;
  text-align: center;
  font-size: 14px;
}

.profile-nickname {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
}

.profile-row {
  margin: 2px 0;
}

.profile-label {
  color: #bbbbbb;
  margin-right: 4px;
}

.profile-value {
  font-weight: bold;
}

#profileGold,
#profileSword,
#profilePower,
#profileHuntCount {
  color: #fff;
}

  
  /* ğŸ—º MAP ë²„íŠ¼ */
#mapBtn {
  position:fixed;
  top:10px;
  right:10px;
  z-index:1100;
  font-size:14px;
  padding:8px 16px;
}

/* ğŸ—º MAP íŒ¨ë„ */
#mapPanel {
  position:fixed;
  top:60px;
  right:10px;
  width:260px;
  max-height:70%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1101;
  display:none;
  text-align:left;
  font-size:14px;
}
#mapPanel h3 {
  margin-top:0;
}
.map-field {
  padding:6px 4px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.map-field:hover {
  background:#222;
}

/* ì‚¬ëƒ¥ ì •ë³´ í…ìŠ¤íŠ¸ */
#huntInfo {
  font-size:14px;
  color:#ccc;
  margin-top:4px;
}

/* ğŸ§” NPC íŒì—… */
#npcPopup {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;              /* ê¸°ë³¸ ìˆ¨ê¹€ */
  align-items:center;
  justify-content:center;
  z-index:2000;
}

.npc-popup-inner {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.npc-popup-img {
  width:140px;
  height:auto;
  display:block;
  margin:0 auto 8px auto;
}

.npc-popup-text {
  font-size:16px;
  margin:8px 0 12px 0;
}

.npc-popup-btn {
  padding:8px 20px;
  font-size:14px;
  cursor:pointer;
}

/* ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ ì˜¤ë²„ë ˆì´ */
#tutorialOverlay {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  display:none;
  align-items:flex-start;   /* â¬…ï¸ ìœ„ìª½ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ */
  justify-content:center;   /* ê°€ë¡œëŠ” ì¤‘ì•™ ìœ ì§€ */
  z-index:1900;
  padding-top:60px;         /* â¬…ï¸ ìœ„ì—ì„œ ì•½ê°„ ë„ì›Œì£¼ê¸° */
}

.tutorial-box {
  background:#222;
  border:1px solid #555;
  border-radius:10px;
  padding:16px 20px;
  max-width:360px;
  width:90%;
  color:#fff;
  text-align:left;
  font-size:14px;
  box-shadow:0 0 15px rgba(0,0,0,0.8);
}

.tutorial-box h3 {
  margin-top:0;
  margin-bottom:8px;
  text-align:center;
}

.tutorial-box ul {
  padding-left:18px;
  margin:8px 0 12px 0;
}

.tutorial-close-btn {
  display:block;
  width:100%;
  padding:8px 0;
  margin-top:4px;
  text-align:center;
  cursor:pointer;
  border:none;
  border-radius:6px;
  background:#f0f0f0;
  color:#222;
  font-weight:bold;
}

/* ì„¹ì…˜ êµ¬ë¶„ì„  */
.section-divider {
  border: 0;
  height: 1px;
  background: #444;
  margin: 10px auto 16px auto;
  max-width: 360px;  /* í”„ë¡œí•„ ì¹´ë“œ í­ì´ë‘ ë¹„ìŠ·í•˜ê²Œ */
}

  
</style>
</head>

<body>

<!-- ğŸ” ë¡œê·¸ì¸ -->
<div id="loginScreen">
  <h2>ğŸ” ë¡œê·¸ì¸</h2>
  <input id="loginId" placeholder="ì•„ì´ë””"><br><br>
  <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸"><br><br>
  <button onclick="login()">ì ‘ì†</button>
</div>

<!-- ğŸ® ê²Œì„ -->
<div id="gameScreen" style="display:none;">
  <h1>âš”ï¸ ê²€ í‚¤ìš°ê¸°</h1>

<!-- ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì¹´ë“œ -->
<div id="userProfileArea">
  <div class="profile-card-inner">

    <!-- ì„¼í„° ë¬´ê¸° ì´ë¯¸ì§€ -->
    <div class="profile-weapon-box">
      <!-- ë‚˜ì¤‘ì— ì‹¤ì œ ë¬´ê¸° PNGë¡œ êµì²´ (ë°°ê²½ íˆ¬ëª… ê¶Œì¥) -->
      <img id="weaponImage"
           src="images/weapons/placeholder.png"
           alt="ë‚´ ë¬´ê¸°">
    </div>

    <!-- í•˜ë‹¨ ì •ë³´ -->
    <div class="profile-info-box">

      <div class="profile-nickname" id="profileNickname">-</div>

      <div class="profile-row">
        <span class="profile-label">í˜„ì¬ ê°•í™”</span>
        <span class="profile-value" id="profileSword">+0ê°•</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ê³µê²©ë ¥</span>
        <span class="profile-value" id="profilePower">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ê³¨ë“œ</span>
        <span class="profile-value" id="profileGold">0</span>
      </div>

      <div class="profile-row">
        <span class="profile-label">ì˜¤ëŠ˜ ì‚¬ëƒ¥</span>
        <span class="profile-value" id="profileHuntCount">0 / 10</span>
      </div>

    </div>
  </div>
</div>

  <hr class="section-divider">

  <!-- ê¸°ì¡´ ìƒíƒœ í‘œì‹œ -->
  <p id="status"></p>
<p id="upgradeInfo"
   style="font-size:14px; margin-top:4px; margin-bottom:8px; color:#ccc;">
</p>

<button onclick="upgrade()">ğŸ”¨ ê°•í™”</button>
<button id="huntBtn" onclick="hunt()">âš”ï¸ ì‚¬ëƒ¥</button>
<button onclick="sell()">ğŸ’° íŒë§¤</button>

<!-- ğŸ¯ ê°•í™” ì•„ì´í…œ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ -->
<div id="upgradeItems" style="margin-top:8px; font-size:13px;">
  <label style="margin-right:8px;">
    <input type="checkbox" id="useScroll15">
    15ê°• ê°•í™” ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
  <label style="margin-right:8px;">
    <input type="checkbox" id="useProtect">
    íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
  <label>
    <input type="checkbox" id="useSuper">
    ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ ì‚¬ìš©
  </label>
</div>


<p id="huntInfo"></p>

  <!-- ğŸ—º MAP -->
  <button id="mapBtn" onclick="toggleMap()">ğŸ—º MAP</button>
  <div id="mapPanel">
    <h3>ğŸ—º ì‚¬ëƒ¥í„° ì„ íƒ</h3>
    <div id="mapList"></div>
  </div>

  
  <hr>
  <h2>ğŸ† ë­í‚¹ TOP 10</h2>
  <div id="ranking">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="myRank" style="margin-top:8px; font-size:14px; color:#ccc;"></div>
</div>

<button id="attendanceBtn" onclick="checkAttendance()">ì¶œì„</button>

  
<!-- ğŸ”” ë¡œê·¸ -->
<div id="toastLog"><div id="toastList"></div></div>

<!-- ğŸ’ ì¸ë²¤í† ë¦¬ ë²„íŠ¼ (ë¡œê·¸ ë²„íŠ¼ ìœ„) -->
<button id="inventoryBtn" onclick="toggleInventory()" style="
  position:fixed;
  top:50px;
  right:10px;
  z-index:1100;
  display:none;
  font-size:14px;
  padding:8px 16px;
">
  ğŸ’ ì¸ë²¤í† ë¦¬
</button>




<button id="logToggle" onclick="toggleLog()" style="
  position:fixed;
  bottom:80px;
  right:10px;
  z-index:1001;
  display:none;
">
  ğŸ“œ ë¡œê·¸
</button>


<!-- ğŸ’ ì¸ë²¤í† ë¦¬ íŒ¨ë„ -->
<div id="inventoryPanel" style="
  position:fixed;
  right:10px;
  top:60px;
  width:260px;
  max-height:60%;
  background:rgba(0,0,0,0.95);
  border:1px solid #555;
  padding:10px;
  overflow-y:auto;
  z-index:1002;
  display:none;
  text-align:left;
  font-size:14px;
">


  <h3>ğŸ’ ì¸ë²¤í† ë¦¬</h3>
  <div id="inventoryList"></div>
  <button style="margin-top:8px; width:100%;" onclick="toggleInventory()">ë‹«ê¸°</button>
</div>

<div id="logPanel">
  <h3>ğŸ“¢ ê°•í™” ë¡œê·¸</h3>
  <div id="logPanelList"></div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyC-KjkMnJzN-fOBgg4P4sUo4U_VyhJTOn0",
  authDomain:"sword-game-1d1a1.firebaseapp.com",
  databaseURL:"https://sword-game-1d1a1-default-rtdb.firebaseio.com",
  projectId:"sword-game-1d1a1"
});
const db = firebase.database();
const logRef = db.ref("logs");

function getTutorialKeyForUser(id) {
  return `swordGameTutorialSeen_${id}`;
}
  
/* ìƒíƒœ */
let sword = 0, power = 10, gold = 100;
let userId="", userPassword="", userRef=null;
  let attendanceCount = 0;
let lastAttendanceDate = "";

// ğŸ†• ê°•í™” ì§„í–‰ ì¤‘ì¸ì§€ ì—¬ë¶€
let isUpgrading = false;

  // ğŸ—º ì‚¬ëƒ¥ ê´€ë ¨ ìƒíƒœ
let currentField = 1;          // 1~10 ì‚¬ëƒ¥í„°
let huntCountToday = 0;        // ì˜¤ëŠ˜ ì‚¬ëƒ¥ íšŸìˆ˜
let lastHuntDate = "";         // ë§ˆì§€ë§‰ ì‚¬ëƒ¥ ë‚ ì§œ (YYYY-MM-DD)


// ğŸ ì•„ì´í…œ ë³´ìœ  ìˆ˜ëŸ‰
let itemScroll15 = 0;   // 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
let itemProtect  = 0;   // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
let itemSuper    = 0;   // ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
  
// ì‚¬ëƒ¥í„° ì •ë³´ (ì¶”ì²œ ë ˆë²¨ / ì´ë¦„)
const HUNT_FIELDS = [
  null, // ì¸ë±ìŠ¤ 0 ë¹„ì›€ (1ë¶€í„° ì‹œì‘)
  { id:1, name:"í‰í™”ë¡œìš´ ë²„ì„¯ë§ˆì„",   recLevel:0  },
  { id:2, name:"ì—­ë³‘ì¥ê°€ ë“¤ë“ëŠ” ì‹œê¶ì°½", recLevel:3  },
  { id:3, name:"ë¬´ë²•ìë“¤ì˜ í™©ì•¼",     recLevel:6  },
  { id:4, name:"ëŠªì—˜í”„ì˜ ìˆ²",         recLevel:9  },
  { id:5, name:"ì„œë¦¬ì—¬ì™•ì˜ ë™êµ´",     recLevel:12 },
  { id:6, name:"ë§ë ¹ì™•ì˜ ì£½ìŒì„¸ê³„",   recLevel:15 },
  { id:7, name:"ë² íˆëª¨ìŠ¤ì˜ ë¶ˆêµ¬ë©ì´", recLevel:18 },
  { id:8, name:"ëŒ€ì²œì‚¬ì˜ ìš”ëŒ",       recLevel:21 },
  { id:9, name:"ì‹ ì˜ ì²˜ì†Œ",           recLevel:24 },
  { id:10,name:"ì°¨ì›ì˜ í‹ˆìƒˆ",         recLevel:27 }
];


/* UI */
function update(){

  /* ğŸ§¾ ìœ ì € í”„ë¡œí•„ ì˜ì—­ ê°±ì‹  */
  const nickEl   = document.getElementById("profileNickname");
  const swordEl  = document.getElementById("profileSword");
  const powerEl  = document.getElementById("profilePower");
  const goldEl   = document.getElementById("profileGold");
  const huntEl   = document.getElementById("profileHuntCount");

  if (nickEl) {
    nickEl.textContent  = userId || "-";
  }
  if (swordEl) {
    swordEl.textContent = `+${sword}ê°•`;
  }
  if (powerEl) {
    powerEl.textContent = formatGold(power);
  }
  if (goldEl) {
    goldEl.textContent  = formatGold(gold);
  }
  if (huntEl) {
    const today = getTodayDateString();
    if (lastHuntDate !== today) {
      // ë‚ ì§œ ë°”ë€Œë©´ 0/10 ìœ¼ë¡œ ë³´ì´ë„ë¡
      huntEl.textContent = `0 / 10`;
    } else {
      huntEl.textContent = `${huntCountToday} / 10`;
    }
  }

const statusEl = document.getElementById("status");
if (statusEl) statusEl.innerHTML = "";



  // ğŸ”¹ ê°•í™” ì„±ê³µ/ì‹¤íŒ¨ ì •ë³´
  const success = getUpgradeChance(sword);
  let failInfo = "";
  let failRemain = 100 - success; // ì‹¤íŒ¨ ì´ ë¹„ìœ¨

  // 16~19ê°•ì—ì„œ ì“¸ íŒŒê´´ ë¹„ìœ¨ (ì‹¤íŒ¨ ì¤‘ì—ì„œ ëª‡ %ë¥¼ íŒŒê´´ë¡œ)
  const midDestroyRatio = {
    16: 0.10, // ì‹¤íŒ¨ ì¤‘ 10% â†’ íŒŒê´´  â‰’ ì „ì²´ 6% ì •ë„
    17: 0.12, // ì‹¤íŒ¨ ì¤‘ 12% â†’ íŒŒê´´  â‰’ ì „ì²´ 8% ì •ë„
    18: 0.13, // ì‹¤íŒ¨ ì¤‘ 13% â†’ íŒŒê´´  â‰’ ì „ì²´ 9% ì •ë„
    19: 0.14  // ì‹¤íŒ¨ ì¤‘ 14% â†’ íŒŒê´´  â‰’ ì „ì²´ 10% ì •ë„
  };

  if (sword <= 10) {

    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b> (ìœ ì§€)
    `;

  } else if (sword >= 16 && sword <= 19) {
    // ğŸ§¨ 16~19ê°• êµ¬ê°„: ì•½í•œ íŒŒê´´ + ê°•ë“±

    const destroy = Math.round(failRemain * midDestroyRatio[sword]);
    const down    = failRemain - destroy;

    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;

  } else if (sword <= 20) {
    // 11~15, 20ê°• : ì˜ˆì „ì²˜ëŸ¼ ì‹¤íŒ¨ ì‹œ ìœ ì§€/ê°•ë“±

    const keep = Math.round(failRemain * 0.5);
    const down = failRemain - keep;

    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ìœ ì§€ <b>${keep}%</b> / ê°•ë“± <b>${down}%</b>
    `;

  } else {
    // 21ê°• ì´ìƒ: ê¸°ì¡´ì²˜ëŸ¼ ê°•ë“±/íŒŒê´´ (40/60 ë¹„ìœ¨)

    const down = Math.round(failRemain * 0.4);
    const destroy = failRemain - down;

    failInfo = `
      ì‹¤íŒ¨: <b>${failRemain}%</b>
      â€” ê°•ë“± <b>${down}%</b> /
      íŒŒê´´ <span style="color:red;font-weight:bold;">${destroy}%</span>
    `;
  }


  // ğŸ”¸ ê°•í™” ë¹„ìš© ê³„ì‚°
  const cost = getUpgradeCost(sword);

  // â­ 5ì˜ ë°°ìˆ˜ ë ˆë²¨ ì„¸ì´í”„ ì•ˆë‚´
  let safeNote = "";
  if (sword % 5 === 0 && sword !== 0) {
    safeNote = `<br><span style="color:#6cf;">
      â€» ì„¸ì´í”„ êµ¬ê°„: ì‹¤íŒ¨í•´ë„ ê°•ë“±/íŒŒê´´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    </span>`;
  }

  // ê°•í™” ì •ë³´ UI ì¶œë ¥
  document.getElementById("upgradeInfo").innerHTML = `
    ì„±ê³µ <b>${success}%</b> / ${failInfo}
    <br>í•„ìš” ê³¨ë“œ <b>${formatGold(cost)}</b>
    ${safeNote}
  `;

  // ğŸ¯ ì‚¬ëƒ¥ ì •ë³´ UI ì—…ë°ì´íŠ¸
  const field = HUNT_FIELDS[currentField];
  const huntSuccess = getHuntSuccessChance(sword, currentField);

  const today = getTodayDateString();
  if (lastHuntDate !== today) {
    // ë‚ ì§œ ë°”ë€Œë©´ ì¹´ìš´íŠ¸ ë¦¬ì…‹
    huntCountToday = 0;
    lastHuntDate = today;
  }

  const huntInfoEl = document.getElementById("huntInfo");
  const huntBtnEl  = document.getElementById("huntBtn");

  if (field && huntInfoEl && huntBtnEl) {
huntInfoEl.innerHTML = `
  <div style="font-size:18px; color:#FFA500; font-weight:bold;">
    ğŸ—º í˜„ì¬ ì‚¬ëƒ¥í„°: ${field.name}
  </div>

  <div style="margin-top:4px;">
    ì¶”ì²œ ë ˆë²¨: <b>+${field.recLevel}ê°•</b>
    &nbsp;/&nbsp;
    ë‚´ ë ˆë²¨: <b>+${sword}ê°•</b>
  </div>

  <div style="margin-top:6px; font-size:18px; color:#FFA500; font-weight:bold;">
    ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥ : ${huntSuccess}%
  </div>
`;

const remaining = 10 - huntCountToday;
huntBtnEl.textContent = `âš”ï¸ ì‚¬ëƒ¥ (${remaining}/10)`;


  }
}

function showNpcMessage(text, imgPath = "images/npc/blacksmith_idle.png", showButton = true) {
  const popup = document.getElementById("npcPopup");
  const msgEl = document.getElementById("npcPopupText");
  const imgEl = document.getElementById("npcPopupImg");
  const btnEl = document.querySelector(".npc-popup-btn");

  if (!popup || !msgEl || !imgEl) {
    alert(text);
    return;
  }

  msgEl.innerHTML = text;
  imgEl.src = imgPath;

  // ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ ì œì–´
  if (btnEl) {
    btnEl.style.display = showButton ? "inline-block" : "none";
  }

  popup.style.display = "flex";
}


function showTutorialIfFirstTime() {

  if (!userId) return;   // ë¡œê·¸ì¸ ì•ˆ ëìœ¼ë©´ ìˆ˜í–‰ ì•ˆ í•¨

  const key = getTutorialKeyForUser(userId);

  try {
    if (localStorage.getItem(key) === "1") return;
  } catch (e) {}

  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) {
    overlay.style.display = "flex";
  }
}


function closeTutorial() {
  const overlay = document.getElementById("tutorialOverlay");
  if (overlay) overlay.style.display = "none";

  if (!userId) return;

  const key = getTutorialKeyForUser(userId);

  try {
    localStorage.setItem(key, "1");
  } catch (e) {}
}
  
function closeNpcPopup() {
  const popup = document.getElementById("npcPopup");
  if (popup) popup.style.display = "none";
}


  // ìˆ«ì ê³¨ë“œë¥¼ "12ì–µ 8,765ë§Œ 4,252" í˜•íƒœë¡œ ë³€í™˜
function formatGold(value) {
  const n = Number(value) || 0;

  // 100ë§Œ ë¯¸ë§Œì€ ê·¸ëƒ¥ ìˆ«ì+ì½¤ë§ˆë¡œ
  if (n < 1_000_000) {
    return n.toLocaleString();
  }

  const EOK = 100_000_000; // ì–µ
  const MAN = 10_000;      // ë§Œ

  const eok = Math.floor(n / EOK);
  let rest = n % EOK;
  const man = Math.floor(rest / MAN);
  const won = rest % MAN;

  const parts = [];
  if (eok > 0) parts.push(`${eok.toLocaleString()}ì–µ`);
  if (man > 0) parts.push(`${man.toLocaleString()}ë§Œ`);
  if (won > 0) parts.push(won.toLocaleString());

  if (parts.length === 0) return "0";
  return parts.join(" ");
}

  
function getUpgradeCost(level) {

  const costTable = {
    0: 0,
    1: 20,
    2: 50,
    3: 100,
    4: 500,
    5: 1000,
    6: 3000,
    7: 5000,
    8: 10000,
    9: 30000,
    10: 50000,
    11: 100000,
    12: 300000,
    13: 500000,
    14: 1000000,
    15: 3000000,
    16: 5000000,
    17: 10000000,
    18: 30000000,
    19: 50000000,
    20: 100000000,
    21: 300000000,
    22: 500000000,
    23: 1000000000,
    24: 3000000000,
    25: 5000000000,
    26: 10000000000,
    27: 30000000000,
    28: 50000000000,
    29: 100000000000
  };

  return costTable[level] ?? 0;
}

// íŒë§¤ ì‹œ, ê·¸ ë ˆë²¨ì—ì„œ ë‹¤ìŒ ê°•í™”ë¥¼ ëª‡ ë²ˆ ì •ë„ ë„ì „ ê°€ëŠ¥í•˜ê²Œ í•´ì¤„ì§€ ê²°ì •
function getSellAttemptFactor(level) {
  // 30ê°•ì€ 29ê°• ê¸°ì¤€ìœ¼ë¡œ ë³¸ë‹¤ (ë¹„ìš©/í™•ë¥  í…Œì´ë¸”ì´ 29ê¹Œì§€ë¼ì„œ)
  const forChance = Math.min(level, 29);

  const chance = getUpgradeChance(forChance); // 0~100
  if (chance <= 0) return 2; // ì•ˆì „ ì¥ì¹˜

  const expectedTries = 100 / chance; // ì„±ê³µê¹Œì§€ í‰ê·  ì‹œë„ íšŸìˆ˜

  if (expectedTries <= 2.0) {
    return 2;   // ì„±ê³µë¥  ë†’ìŒ â†’ 2ë²ˆ ì •ë„ ë„ì „ê¶Œ
  } else if (expectedTries <= 3.5) {
    return 3;
  } else if (expectedTries <= 4.5) {
    return 4;
  } else if (expectedTries <= 7.0) {
    return 5;   // ì˜ˆ: 20%~25%ëŒ€ í™•ë¥ 
  } else {
    return 6;   // ì•„ì£¼ ë‚®ì€ í™•ë¥  â†’ 5~6ë²ˆ ë„ì „ê¶Œ
  }
}

// Lê°• ì¥ë¹„ íŒë§¤ ì‹œ ë°›ì„ ê³¨ë“œ ê³„ì‚°
// A = 0â†’Lê¹Œì§€ ì„±ê³µ ê°€ì • ì´ë¹„ìš©
// B = Lê°• ê°•í™”ë¹„ìš© Ã— (ê¸°ëŒ“ê°’ ê¸°ë°˜ ë„ì „ íšŸìˆ˜)
// ë³´ìƒ = (A + B) Ã— 1.15~1.20
function getSellReward(level) {
  if (level <= 0) return 0; // 0ê°•ì€ íŒ” ê²Œ ì—†ìŒ

  const totalCost = getTotalCostToLevel(level);   // A
  const costNow   = getUpgradeCost(Math.min(level, 29)); // Lê°• ì‹œë„ ë¹„ìš© (30ê°• ë³´í˜¸)

  const attemptFactor = getSellAttemptFactor(level); // ë„ì „ íšŸìˆ˜ ë³´ì •
  const B = costNow * attemptFactor;

  const base = totalCost + B;
  const mul  = randRange(1.15, 1.20); // 115% ~ 120%

  const reward = Math.floor(base * mul);
  return reward;
}

  
// 0ê°• â†’ levelê°• ê¹Œì§€, ëª¨ë‘ 1íŠ¸ ì„±ê³µí•œë‹¤ê³  ê°€ì •í•œ ì´ ê°•í™”ë¹„ìš©
function getTotalCostToLevel(level) {
  let sum = 0;
  for (let i = 0; i < level; i++) {
    sum += getUpgradeCost(i);
  }
  return sum;
}

// âš”ï¸ ê°•í™”ë¹„ìš© ê¸°ë°˜ ê³µê²©ë ¥ ê³„ì‚°
function getBaseAttack(level) {
  // 0ê°•ë„ ìµœì†Œ 10 ì´ìƒì€ ë‚˜ì˜¤ê²Œ
  const total = getTotalCostToLevel(level); // 0â†’levelê¹Œì§€ ì´ ê°•í™”ë¹„ìš©
  const atk = Math.floor(total / 1000) + 10;
  return atk;
}

// âš”ï¸ í˜„ì¬ ê°•í™” ë‹¨ê³„ ê¸°ì¤€ìœ¼ë¡œ ì‹¤ì œ ê³µê²©ë ¥ ëœë¤ ë¶€ì—¬ (Â±5% í¸ì°¨, ê³ ì •)
function rollPowerForCurrentSword() {
  const base = getBaseAttack(sword);
  power = Math.floor(randRange(base * 0.95, base * 1.05));
}

  
// min ~ max ì‚¬ì´ ëœë¤ ì‹¤ìˆ˜
function randRange(min, max) {
  return min + Math.random() * (max - min);
}

  
/* í™•ë¥  */
function getUpgradeChance(level) {
  // 0 -> 1 ì€ 100% ê³ ì •
  if (level === 0) return 100;

  let chance;

  if (level < 20) {
    // 1 ~ 19ê°• êµ¬ê°„ : ë ˆë²¨ 1 ì˜¤ë¥¼ ë•Œë§ˆë‹¤ -4%
    chance = 100 - (level * 4);
  } else {
    // 20ê°• ì´í›„ : -2%ì”© ê°ì†Œ
    const base20 = 100 - (20 * 4); // 20%
    const extra = level - 20;
    chance = base20 - (extra * 2);
  }

  // ğŸ’« ì „ì²´ êµ¬ê°„ ì†Œí­ ìƒí–¥ (+5%)
  chance += 5;

  // ìƒí•œ/í•˜í•œ ì •ë¦¬
  chance = Math.min(100, chance); // 100% ë„˜ì§€ ì•Šê²Œ
  chance = Math.max(5, chance);   // ì•ˆì „ í•˜í•œ (ì‹¤ì œë¡œëŠ” ê±°ì˜ 10% ì´ìƒì¼ ê²ƒ)

  return chance;
}



function checkAttendance() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const today = getTodayDateString();

  // ì´ë¯¸ ì˜¤ëŠ˜ ì¶œì„ í–ˆëŠ”ì§€ ì²´í¬
  if (lastAttendanceDate === today) {
    alert("ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤!");
    return;
  }

  // ì¶œì„ ì²˜ë¦¬
  lastAttendanceDate = today;
  attendanceCount = (attendanceCount || 0) + 1;

  const reward = 60000;
  gold += reward;

  alert(`ì¶œì„ ì™„ë£Œ! ê³¨ë“œ +${formatGold(reward)}`);

  // ì¶œì„ ë¡œê·¸ ë‚¨ê¸°ê¸°
  writeLog(`${userId}ë‹˜ì´ ì¶œì„í–ˆìŠµë‹ˆë‹¤. (${attendanceCount}íšŒì°¨)`);

  update();
  save();
}

  
/* ê°•í™” */
function upgrade() {
  if (sword >= 30) {
    alert("ìµœëŒ€ ê°•í™”");
    return;
  }

  // ì´ë¯¸ ê°•í™” ì¤‘ì´ë©´ ì¤‘ë³µ í´ë¦­ ë°©ì§€
  if (isUpgrading) return;

  // ğŸ”˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì½ê¸°
  const scroll15El = document.getElementById("useScroll15");
  const protectEl  = document.getElementById("useProtect");
  const superEl    = document.getElementById("useSuper");

  const wantScroll15 = !!(scroll15El && scroll15El.checked);
  const wantProtect  = !!(protectEl  && protectEl.checked);
  const wantSuper    = !!(superEl    && superEl.checked);

  // âš ï¸ ì•„ì´í…œ ì—†ëŠ” ìƒíƒœì—ì„œ ì²´í¬í•œ ê²½ìš° â†’ ê°•í™” ì§„í–‰ ê¸ˆì§€
  if (wantScroll15 && itemScroll15 <= 0) {
    showNpcMessage("15ê°• ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantProtect && itemProtect <= 0) {
    showNpcMessage("íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }
  if (wantSuper && itemSuper <= 0) {
    showNpcMessage("ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œê°€ í•„ìš”í•´.");
    return;
  }

  // ğŸ¯ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ ì „ìš© ì²˜ë¦¬ (ì¦‰ì‹œ ì²˜ë¦¬, ë”œë ˆì´ X)
  if (wantScroll15) {

    if (sword >= 15) {
      alert("15ê°• ì´ìƒì˜ ë¬´ê¸°ì—ëŠ” 15ê°• ê°•í™” ì£¼ë¬¸ì„œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    itemScroll15 -= 1;
    sword = 15;
    rollPowerForCurrentSword();

    if (scroll15El) scroll15El.checked = false; // í•œ ë²ˆ ì“°ê³  ì²´í¬ í•´ì œ

  writeLog(
  `${userId}ë‹˜ì´ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¬´ê¸°ê°€ ${coloredLevel(15)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
);

// í¼ê·¸ë€íŠ¸ ëŒ€ì‚¬ + ì„±ê³µ ì´ë¯¸ì§€
showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#C0C0C0;">
    15ê°• ê°•í™”!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì§€! 15ê°•, ë‹¨ìˆ¨ì— ì˜¬ë ¤ì£¼ì§€.
  </div>
  `,
  "images/npc/blacksmith_success.png"
);



    update();
    save();
    return;
  }

  // ğŸª™ ì¼ë°˜ ê°•í™” (íŒŒê´´ë°©ì§€ / ìŠˆí¼ê°•í™”ë§Œ ì˜í–¥)
  const cost = getUpgradeCost(sword);

  if (gold < cost) {
    showNpcMessage(
      "ìë„¤, ê³¨ë“œëŠ” ì¶©ë¶„í•œê²Œ ë§ë‚˜?",
      "images/npc/blacksmith_idle.png"
    );
    return;
  }

  // ì—¬ê¸°ì„œë¶€í„°ëŠ” ì‹¤ì œë¡œ ê°•í™” ì‹œë„ ì‹œì‘
  // ì¤‘ë³µ í´ë¦­ ë°©ì§€ í”Œë˜ê·¸ ON
  isUpgrading = true;

  // ê³¨ë“œ ì°¨ê° ë° ì•„ì´í…œ ì†Œë¹„ëŠ” ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì²˜ë¦¬
  gold -= cost;

  const chance = getUpgradeChance(sword);
  const before = sword;

  const useProtect = wantProtect && itemProtect > 0;
  const useSuper   = wantSuper   && itemSuper   > 0;

  if (useProtect) itemProtect -= 1;
  if (useSuper)   itemSuper   -= 1;

  // ğŸ•’ 1~2ì´ˆ ëœë¤ ë”œë ˆì´ ë™ì•ˆ "ê°•í™” ì¤‘..." íŒì—…
  const delayMs = 1000 + Math.random() * 1000; // 1000~2000ms

showNpcMessage(
  "ê°•í™” ì¤‘ì…ë‹ˆë‹¤...",
  "images/npc/blacksmith_upgrade.png",
  false   // â¬… ë²„íŠ¼ ìˆ¨ê¹€
);


  setTimeout(() => {
    // ì¤€ë¹„ íŒì—… ë‹«ê¸°
    closeNpcPopup();

    // ğŸ² ì„±ê³µ / ì‹¤íŒ¨ íŒì •
if (Math.random() < chance / 100) {
  // âœ… ì„±ê³µ
  let up = useSuper ? 2 : 1; // ìŠˆí¼ê°•í™”ë©´ +2

  while (up > 0 && sword < 30) {
    sword++;
    up--;
  }

  rollPowerForCurrentSword();

  // í¼ê·¸ë€íŠ¸ ì„±ê³µ ë©˜íŠ¸
  if (useSuper) {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFD700;">
    ìŠˆí¼ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ë‘ ë‹¨ê³„ë‚˜ ì˜¬ë¼ê°”ë‹¤ê³ !? ì „ì„¤ì´ ë³´ì´ëŠ”êµ°!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  } else {
    showNpcMessage(
  `
  <div style="font-size:18px; font-weight:bold; color:#FFFFFF;">
    ê°•í™”ì„±ê³µ!
  </div>
  <div style="margin-top:6px;">
    ì¢‹ì•„! ì œëŒ€ë¡œ ë¶™ì—ˆêµ¬ë§Œ!
  </div>
  `,
  "images/npc/blacksmith_success.png"
);

  }

  if (before >= 20) {
    writeLog(
      `${userId}ì´ ${coloredLevel(before)} ë„ì „ì— ì„±ê³µí•˜ì—¬ ${coloredLevel(sword)}ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`
    );
  }
  } else {
    // âŒ ì‹¤íŒ¨
    const isSafeLevel = (before % 5 === 0); // 5,10,15,20,25,30 ì„¸ì´í”„

    if (useProtect) {
      // íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ ì‚¬ìš© ì‹œ
      showNpcMessage(
        `
        <div style="font-size:18px; font-weight:bold; color:#FF5555;">
          ê°•í™”ì‹¤íŒ¨!
        </div>
        <div style="margin-top:6px;">
          ìœ„í—˜í–ˆë„¤â€¦ ì£¼ë¬¸ì„œ ë•ì— ë²„í…¼ë‹¤ë„¤.
        </div>
        `,
        "images/npc/blacksmith_fail.png"
      );
    } else {
      if (isSafeLevel) {
        // ì„¸ì´í”„ êµ¬ê°„ ì‹¤íŒ¨ â†’ ìœ ì§€
        showNpcMessage(
          `
          <div style="font-size:18px; font-weight:bold; color:#FF5555;">
            ê°•í™”ì‹¤íŒ¨!
          </div>
          <div style="margin-top:6px;">
            í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼. ëŒ€ì‹  ë‹¨ê³„ëŠ” ê·¸ëŒ€ë¡œë¼ë„¤.
          </div>
          `,
          "images/npc/blacksmith_fail.png"
        );
      } else {
        if (sword <= 10) {
          // ì €ë ˆë²¨ ì‹¤íŒ¨ â†’ ê·¸ëƒ¥ ìœ ì§€
          showNpcMessage(
            `
            <div style="font-size:18px; font-weight:bold; color:#FF5555;">
              ê°•í™”ì‹¤íŒ¨!
            </div>
            <div style="margin-top:6px;">
              í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
            </div>
            `,
            "images/npc/blacksmith_fail.png"
          );
        } else if (sword <= 20) {
          // 11~20êµ¬ê°„ : ì ˆë°˜ì€ ìœ ì§€, ì ˆë°˜ì€ ê°•ë“±
          if (Math.random() < 0.5) {
            // ì‹¤íŒ¨ (ìœ ì§€)
            showNpcMessage(
              `
              <div style="font-size:18px; font-weight:bold; color:#FF5555;">
                ê°•í™”ì‹¤íŒ¨!
              </div>
              <div style="margin-top:6px;">
                í â€¦ ì´ë²ˆì—” ë¶™ì§ˆ ì•Šì•˜êµ¬ë¨¼.
              </div>
              `,
              "images/npc/blacksmith_fail.png"
            );
          } else {
            // ê°•ë“±
            sword--;
            rollPowerForCurrentSword();
            showNpcMessage(
              `
              <div style="font-size:18px; font-weight:bold; color:#FFA500;">
                ê°•ë“± ë°œìƒ!
              </div>
              <div style="margin-top:6px;">
                ì—êµ¬, í•œ ë‹¨ê³„ ë‚´ë ¤ê°€ ë²„ë ¸ë„¤â€¦
              </div>
              `,
              "images/npc/blacksmith_fail.png"
            );
          }
        } else {
          // 21ê°• ì´ìƒ
          if (Math.random() < 0.4) {
            // ê°•ë“±
            sword--;
            rollPowerForCurrentSword();
            showNpcMessage(
              `
              <div style="font-size:18px; font-weight:bold; color:#FFA500;">
                ê°•ë“± ë°œìƒ!
              </div>
              <div style="margin-top:6px;">
                ì—êµ¬, í•œ ë‹¨ê³„ ë‚´ë ¤ê°€ ë²„ë ¸ë„¤â€¦
              </div>
              `,
              "images/npc/blacksmith_fail.png"
            );
          } else {
            // íŒŒê´´
            sword = 0;
            rollPowerForCurrentSword();
            writeLog(
              `${userId}ì´ ${coloredLevel(before)} ë„ì „ì— ì‹¤íŒ¨í•˜ì—¬ ` +
              `<span style="color:red;font-weight:bold;">íŒŒê´´</span> ë˜ì—ˆìŠµë‹ˆë‹¤!`,
              true
            );
            showNpcMessage(
              `
              <div style="font-size:18px; font-weight:bold; color:#FF3333;">
                ì¥ë¹„ íŒŒê´´!
              </div>
              <div style="margin-top:6px;">
                ë§™ì†Œì‚¬â€¦ ì‚°ì‚°ì´ ë¶€ì„œì ¸ ë²„ë ¸êµ°â€¦
              </div>
              `,
              "images/npc/blacksmith_destroy.png"
            );
          }
        }
      }
    }
  }


    // UI ê°±ì‹  + ì €ì¥ + í”Œë˜ê·¸ í•´ì œ
    update();
    save();
    isUpgrading = false;
  }, delayMs);
}

function sell() {
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  if (sword <= 0) {
    alert("íŒë§¤í•  ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  const before = sword;
  const reward = getSellReward(before);

  gold += reward;
  sword = 0;
  rollPowerForCurrentSword();

  alert(`+${before}ê°• ì¥ë¹„ë¥¼ íŒë§¤í•˜ì—¬ ${formatGold(reward)} ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`);

  // âœ… 20ê°• ì´ìƒì¼ ë•Œë§Œ ë¡œê·¸ ë‚¨ê¸°ê¸°
  if (before >= 20) {
    writeLog(
      `${userId}ë‹˜ì´ ${coloredLevel(before)} ì¥ë¹„ë¥¼ íŒë§¤í•˜ì—¬ ${formatGold(reward)} ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
    );
  }

  update();
  save();
}


  
/* ì‚¬ëƒ¥ */
function hunt(){
  if (!userRef || !userId) {
    alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
    return;
  }

  const today = getTodayDateString();

  // ë‚ ì§œ ë°”ë€Œë©´ ì¹´ìš´íŠ¸ ë¦¬ì…‹
  if (lastHuntDate !== today) {
    lastHuntDate = today;
    huntCountToday = 0;
  }

  if (huntCountToday >= 10) {
    alert("ì˜¤ëŠ˜ ì‚¬ëƒ¥ ê°€ëŠ¥ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. (í•˜ë£¨ 10íšŒ)");
    return;
  }

  const field = HUNT_FIELDS[currentField];
  if (!field) {
    alert("ì‚¬ëƒ¥í„°ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    return;
  }

  const successChance = getHuntSuccessChance(sword, currentField);

  if (successChance <= 0) {
    alert("ì´ ì‚¬ëƒ¥í„°ëŠ” ì§€ê¸ˆ ì¥ë¹„ë¡œëŠ” ë„ˆë¬´ ìœ„í—˜í•©ë‹ˆë‹¤! (ì„±ê³µë¥  0%)");
    return;
  }

// ì‹¤ì œ ê³µê²©ë ¥ì€ ë¯¸ë¦¬ êµ´ë ¤ë‘” power ì‚¬ìš© (Â±5% í¸ì°¨ ë°˜ì˜ëœ ê°’)
const atk = power; // ì§€ê¸ˆì€ ì‚¬ìš© X, ë‚˜ì¤‘ì— ì‚¬ëƒ¥ ë°ë¯¸ì§€/ì„±ê³µë¥ ì— ë°˜ì˜ ê°€ëŠ¥


  // ì„±ê³µ ì—¬ë¶€
  const r = Math.random() * 100;
  if (r < successChance) {
    // âœ… ì„±ê³µ
    const reward = getHuntReward(currentField);
    gold += reward;

    alert(`ì‚¬ëƒ¥ ì„±ê³µ! ğŸ’° ${formatGold(reward)} ê³¨ë“œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`);

    // ğŸ ì•„ì´í…œ ë“œë ì²˜ë¦¬
    // LV6 ì´ìƒ: 3% í™•ë¥ ë¡œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ
    if (currentField >= 6 && Math.random() < 0.03) {
      itemScroll15 += 1;
      writeLog(
        `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">15ê°• ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
      );
    }

    // LV7 ì´ìƒ: 2% í™•ë¥ ë¡œ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ
    if (currentField >= 7 && Math.random() < 0.02) {
      itemProtect += 1;
      writeLog(
        `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
      );
    }

    // LV8 ì´ìƒ: 1% í™•ë¥ ë¡œ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ
    if (currentField >= 8 && Math.random() < 0.01) {
      itemSuper += 1;
      writeLog(
        `${userId}ë‹˜ì´ ì‚¬ëƒ¥ì—ì„œ <span style="color:#6cf;">ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ</span>ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`
      );
    }

  } else {
    // âŒ ì‹¤íŒ¨
    alert("ì‚¬ëƒ¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤...");
  }


  huntCountToday++;
  update();
  save();
}


// ğŸ¯ ì‚¬ëƒ¥ ì„±ê³µ í™•ë¥  ê³„ì‚°
function getHuntSuccessChance(myLevel, fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;

  const rec = field.recLevel; // ì¶”ì²œ ê°•í™” ë ˆë²¨
  const diff = rec - myLevel;

  if (diff <= 0) return 100;     // ê¶Œì¥ ë ˆë²¨ ì´ìƒì´ë©´ 100%
  if (diff >= 5) return 0;       // ë„ˆë¬´ ì°¨ì´ë‚˜ë©´ 0%

  // 1~4 ì°¨ì´: 80 / 60 / 40 / 20 %
  return 100 - diff * 20;
}

  // ğŸ’° ì‚¬ëƒ¥ ì„±ê³µ ì‹œ ê³¨ë“œ ë³´ìƒ
function getHuntReward(fieldId) {
  const field = HUNT_FIELDS[fieldId];
  if (!field) return 0;
  
  // ğŸŒ± LV1 ì‚¬ëƒ¥í„°ëŠ” 0~20ê³¨ë“œ ëœë¤
  if (fieldId === 1) {
    return Math.floor(randRange(0, 21)); // 0 ì´ìƒ 21 ë¯¸ë§Œ â†’ 0~20
  }
  // ì„¤ëª…ì— ë”°ë¼: ì˜ˆ) 3LV â†’ 6ê°• ê°•í™”ë¹„ìš© ì‚¬ìš©
  const refLevel = field.recLevel;    // 0,3,6,...,27
  const baseCost = getUpgradeCost(refLevel); // í•´ë‹¹ ê°•ì˜ ê°•í™”ë¹„ìš©

  const mul = randRange(1.0, 1.5);   // 1.0 ~ 1.5 ë°°
  return Math.floor(baseCost * mul);
}

  
/* ë¡œê·¸ì¸ */
function login(){
  userId = loginId.value.trim();
  userPassword = loginPw.value;
  if (!userId || !userPassword) {
    alert("ì…ë ¥ í•„ìš”");
    return;
  }

  userRef = db.ref("users/" + userId);

  userRef.once("value").then(s => {

    // â­ ì‹ ê·œ ê³„ì • ìƒì„± ì‹œ
    if (!s.exists()) {

        // ì²˜ìŒ ê³„ì • ìƒì„± ì‹œ, í˜„ì¬ sword ê¸°ì¤€ìœ¼ë¡œ ê³µê²©ë ¥ í•œ ë²ˆ êµ´ë ¤ë‘ê¸°
  rollPowerForCurrentSword();
      
userRef.set({
  password: userPassword,
  sword,
  power,
  gold,
  updated: Date.now(),
  attendanceCount: 0,
  lastAttendanceDate: "",
  currentField: 1,
  huntCountToday: 0,
  lastHuntDate: "",
  itemScroll15: 0,
  itemProtect: 0,
  itemSuper: 0
});



    } 
    // â­ ê¸°ì¡´ ê³„ì • ë¡œê·¸ì¸ ì‹œ
    else {

      if (s.val().password !== userPassword) {
        alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        return;
      }

  const data = s.val();

  sword = data.sword ?? 0;
  gold  = data.gold  ?? 100;

  attendanceCount    = data.attendanceCount    ?? 0;
  lastAttendanceDate = data.lastAttendanceDate ?? "";
  currentField   = data.currentField   ?? 1;
  huntCountToday = data.huntCountToday ?? 0;
  lastHuntDate   = data.lastHuntDate   ?? "";
  itemScroll15 = data.itemScroll15 ?? 0;
  itemProtect  = data.itemProtect  ?? 0;
  itemSuper    = data.itemSuper    ?? 0;

  // âœ… ë¡œê·¸ì¸ ì‹œ í˜„ì¬ ê°•í™” ë‹¨ê³„ ê¸°ì¤€ìœ¼ë¡œ ê³µê²©ë ¥ ì¬ì„¤ì •
  rollPowerForCurrentSword();



    }

// í™”ë©´ ì „í™˜ + ì¶œì„ / ë¡œê·¸ / ì¸ë²¤í† ë¦¬ ë²„íŠ¼ í‘œì‹œ
loginScreen.style.display  = "none";
gameScreen.style.display   = "block";
document.getElementById("attendanceBtn").style.display = "block";
document.getElementById("inventoryBtn").style.display = "block";
document.getElementById("logToggle").style.display = "block";

update();
showTutorialIfFirstTime();
    
  });
}

function save() {
  if (!userRef) return;
  userRef.update({
  sword: Number(sword),
  power: Number(power),
  gold: Number(gold),
  updated: Date.now(),
  attendanceCount: attendanceCount,
  lastAttendanceDate: lastAttendanceDate,
  currentField: currentField,
  huntCountToday: huntCountToday,
  lastHuntDate: lastHuntDate,
  itemScroll15: Number(itemScroll15),
  itemProtect: Number(itemProtect),
  itemSuper: Number(itemSuper)
});


}


/* ìƒ‰ìƒ */
function getSwordColor(l){
  if (l >= 30) return "rainbow";
  if (l === 29) return "sparkle-gold";
  if (l === 28) return "sparkle-silver";

  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) return colorMap[l] || "white";
  if (l >= 11) return "lime";
  return "white";
}

function coloredLevel(l){
  // ğŸŒˆ 30ê°•
  if (l >= 30) {
    return `<span class="rainbow">+${l}ê°•</span>`;
  }

  // âœ¨ 29 / 28 ë°˜ì§
  if (l === 29) {
    return `<span class="sparkle-gold">+${l}ê°•</span>`;
  }
  if (l === 28) {
    return `<span class="sparkle-silver">+${l}ê°•</span>`;
  }

  // ğŸ¨ 21~27 ê°œë³„ ìƒ‰ìƒ
  const colorMap = {
    21: "red",
    22: "yellow",
    23: "lime",
    24: "cyan",
    25: "violet",
    26: "brown",
    27: "pink"
  };

  if (l >= 21) {
    return `<span style="color:${colorMap[l]};font-weight:bold;">+${l}ê°•</span>`;
  }

  // ğŸ‘‰ 11~20ì€ ìƒ‰ ì—†ìŒ (ê¸°ë³¸ í°ìƒ‰)
  return `+${l}ê°•`;
}

// ğŸ—º MAP í† ê¸€
function toggleMap() {
  const panel = document.getElementById("mapPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderMap();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

// ğŸ—º MAP ë‚´ìš© ë Œë”ë§
function renderMap() {
  const listEl = document.getElementById("mapList");
  if (!listEl) return;

  listEl.innerHTML = "";

  for (let i = 1; i <= 10; i++) {
    const field = HUNT_FIELDS[i];
    const success = getHuntSuccessChance(sword, i);

    const div = document.createElement("div");
    div.className = "map-field";
    div.innerHTML = `
      <b>LV${i} - ${field.name}</b><br>
      ì¶”ì²œ: +${field.recLevel}ê°• / í˜„ì¬ ì˜ˆìƒ ì„±ê³µë¥ : ${success}%
    `;
    div.onclick = function() {
      currentField = i;
      toggleMap(); // ì„ íƒ í›„ ë‹«ê¸°
      update();    // UI ê°±ì‹ 
      save();      // ì„ íƒ ì‚¬ëƒ¥í„° ì €ì¥
    };

    // í˜„ì¬ ì„ íƒ ì‚¬ëƒ¥í„° í‘œì‹œ
    if (i === currentField) {
      div.style.borderLeft = "3px solid #6cf";
    }

    listEl.appendChild(div);
  }
}


/* ë­í‚¹ */
function loadRanking(){
  const usersRef = db.ref("users");

  // ğŸ” TOP 10 í‘œì‹œ
  usersRef
    .orderByChild("sword")
    .limitToLast(10)
    .on("value", s=>{
      let arr=[];
      s.forEach(c=>{
        const d=c.val();
        arr.push({
          id: c.key,
          sword: Number(d.sword || 0),
          gold:  Number(d.gold  || 0),
          updated: Number(d.updated || 0)
        });
      });

      // sword -> updated ìˆœìœ¼ë¡œ ì •ë ¬
      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

ranking.innerHTML = arr.map((u,i)=>`
  <div style="font-weight:bold;">
    ${i+1}. ${u.id} | ${coloredLevel(u.sword)} | ğŸ’° ${formatGold(u.gold)}
  </div>
`).join("");

    });

  // ğŸ‘‡ ë‚´ ë­í‚¹ ê³„ì‚°
  usersRef
    .orderByChild("sword")
    .on("value", s=>{
      // ì•„ì§ ë¡œê·¸ì¸ ì•ˆ í–ˆìœ¼ë©´ í‘œì‹œ ì•ˆ í•¨
      if (!userId) {
        myRank.innerText = "";
        return;
      }

      let arr = [];
      s.forEach(c => {
        const d = c.val();
        arr.push({
          id: c.key,
          sword: Number(d.sword || 0),
          gold:  Number(d.gold  || 0),
          updated: Number(d.updated || 0)
        });
      });

      // ì „ì²´ ìœ ì €ë¥¼ ë™ì¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
      arr.sort((a, b) => {
        if (b.sword !== a.sword) return b.sword - a.sword;
        return a.updated - b.updated;
      });

      const idx = arr.findIndex(u => u.id === userId);

      if (idx === -1) {
        myRank.innerText = "ë‚´ ë­í‚¹: ê¸°ë¡ ì—†ìŒ";
      } else {
        const myInfo = arr[idx];
myRank.innerHTML = `
  ë‚´ ë­í‚¹: <b>${idx + 1}ìœ„</b> 
  (${coloredLevel(myInfo.sword)}, ğŸ’° ${formatGold(myInfo.gold)})
`;

      }
    });
}

// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ "YYYY-MM-DD" í˜•íƒœë¡œ ë°˜í™˜ (ì¶œì„ ì²´í¬ìš©)
function getTodayDateString() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

  
function formatTime(ts) {
  const d = new Date(ts);

  const MM  = String(d.getMonth() + 1).padStart(2, "0"); // ì›”
  const DD  = String(d.getDate()).padStart(2, "0");      // ì¼
  const hh  = String(d.getHours()).padStart(2, "0");     // ì‹œ
  const mm  = String(d.getMinutes()).padStart(2, "0");   // ë¶„
  const ss  = String(d.getSeconds()).padStart(2, "0");   // ì´ˆ

  return `${MM}/${DD} ${hh}:${mm}:${ss}`;
}



/* ë¡œê·¸ */
function writeLog(message,isDestroy=false){
  logRef.push({message,isDestroy,time:Date.now()});
}
logRef.limitToLast(50).on("child_added",s=>{
  const d=s.val();

  const ts = formatTime(d.time); // â± íƒ€ì„ìŠ¤íƒ¬í”„ ë³€í™˜

  const el=document.createElement("div");
  el.className="toast-item"+(d.isDestroy?" toast-destroy":"");

el.innerHTML = `<span style="color:#888;">[${ts}]</span> ${d.message}`;


  toastList.prepend(el);
  while(toastList.children.length>5) toastList.lastChild.remove();

  const p=el.cloneNode(true);
  logPanelList.prepend(p);
});

/* ë¡œê·¸ í† ê¸€ */
function toggleLog(){
  logPanel.style.display = logPanel.style.display==="none"?"block":"none";
}

// ğŸ’ ì¸ë²¤í† ë¦¬ í† ê¸€
function toggleInventory() {
  const panel = document.getElementById("inventoryPanel");
  if (!panel) return;

  if (panel.style.display === "none" || panel.style.display === "") {
    renderInventory();
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

// ğŸ’ ì¸ë²¤í† ë¦¬ ë‚´ìš© ë Œë”ë§
function renderInventory() {
  const listEl = document.getElementById("inventoryList");
  if (!listEl) return;

  listEl.innerHTML = `
    <p>ë³´ìœ  ì•„ì´í…œ í˜„í™©</p>
    <ul style="list-style:none; padding-left:0;">
      <li>ğŸ“œ 15ê°• ê°•í™” ì£¼ë¬¸ì„œ: <b>${itemScroll15}</b>ê°œ</li>
      <li>ğŸ›¡ íŒŒê´´ë°©ì§€ ì£¼ë¬¸ì„œ: <b>${itemProtect}</b>ê°œ</li>
      <li>âœ¨ ìŠˆí¼ê°•í™” ì£¼ë¬¸ì„œ: <b>${itemSuper}</b>ê°œ</li>
    </ul>
  `;
}

  loadRanking();
</script>

<!-- ğŸ“˜ ì²˜ìŒ ì ‘ì† íŠœí† ë¦¬ì–¼ (NPC ë²„ì „) -->
<div id="tutorialOverlay">
  <div class="tutorial-box" style="text-align:center;">
    <img src="images/npc/blacksmith_idle.png"
         alt="ëŒ€ì¥ì¥ì´ í¼ê·¸ë€íŠ¸"
         class="npc-popup-img">

   <p style="margin:6px 0 10px 0; font-weight:bold;">
  í—ˆí—ˆâ€¦ ì˜ ì™”êµ¬ë§Œ. ë‚˜ëŠ” ì´ ì™•êµ­ ìµœê³ ì˜ ëŒ€ì¥ì¥ì´, í¼ê·¸ë€íŠ¸ë¼ í•˜ì§€.
</p>

<p style="margin:4px 0; text-align:left; line-height:1.45;">
  â€¢ ìƒë‹¨ ì™¼ìª½ì˜ <b>[ì¶œì„]</b> ë²„íŠ¼ì€ ìŠì§€ ë§ê²Œ.<br>
    ë‹¨ë ¨ì—ëŠ” ìê¸ˆì´ í•„ìš”í•œ ë²•ì´ê±°ë“ .<br><br>

  â€¢ ìƒë‹¨ ì˜¤ë¥¸ìª½ <b>[MAP]</b>ì—ì„œëŠ”<br>
    ê·¸ëŒ€ê°€ ê²€ì„ ì‹œí—˜í•  ì‚¬ëƒ¥í„°ë¥¼ ê³ ë¥¼ ìˆ˜ ìˆë‹¤ë„¤.<br><br>

  â€¢ í™”ë©´ ì¤‘ì•™ì˜ <b>ê°•í™” / ì‚¬ëƒ¥ / íŒë§¤</b> ë²„íŠ¼â€¦<br>
    ì´ê²ƒë“¤ì´ì•¼ë§ë¡œ ëª¨í—˜ê°€ì˜ ê¸¸ì„ ì¢Œìš°í•˜ëŠ” í•µì‹¬ì´ì§€.<br><br>

  â€¢ ì˜¤ë¥¸ìª½ ì•„ë˜ <b>ì¸ë²¤í† ë¦¬ / ë¡œê·¸</b>ëŠ”<br>
    ê·¸ëŒ€ê°€ ê±¸ì–´ì˜¨ ë°œìì·¨ë¥¼ ë‚¨ê²¨ ë‘ëŠ” ê³³ì´ë¼ë„¤.<br><br>

  â€¢ ê°€ëŠ¥í•˜ë‹¤ë©´ <b>ì „ì²´í™”ë©´</b>ìœ¼ë¡œ ì¦ê¸°ê²Œ.<br>
    ì„¸ê³„ë¥¼ ë„“ê²Œ ë³¼ìˆ˜ë¡, ê²€ë„ í¬ê²Œ ì„±ì¥í•˜ë‹ˆê¹Œ ë§ì´ì•¼.
</p>


    <button class="tutorial-close-btn" onclick="closeTutorial()">
      ì•Œê² ë„¤
    </button>
  </div>
</div>

  
  <!-- ğŸ§” ëŒ€ì¥ì¥ì´ NPC íŒì—… -->
<div id="npcPopup">
  <div class="npc-popup-inner">
    <img id="npcPopupImg"
         src="images/npc/blacksmith_idle.png"
         alt="ëŒ€ì¥ì¥ì´"
         class="npc-popup-img">
    <div class="npc-popup-text" id="npcPopupText"></div>
    <button class="npc-popup-btn" onclick="closeNpcPopup()">í™•ì¸</button>
  </div>
</div>
  
</body>
</html>
